{"meta":{"title":"Hexo","subtitle":null,"description":null,"author":"Xuantang Cun","url":"https://wzes.github.io","root":"/"},"pages":[],"posts":[{"title":"Koa-ejs å…¥é—¨","slug":"JavaScript/koa-ejs","date":"2019-11-17T04:56:00.000Z","updated":"2019-11-17T13:00:00.951Z","comments":true,"path":"2019/11/17/JavaScript/koa-ejs/","link":"","permalink":"https://wzes.github.io/2019/11/17/JavaScript/koa-ejs/","excerpt":"","text":"å‰è¨€ åˆæ˜¯ä¸€å‘¨è¿‡å»äº†ï¼Œè¯¥ç»™è‡ªå·±å……å……ç”µäº†ï¼Œä½¿ç”¨äº† koa ä½œä¸ºæœåŠ¡ç«¯æ¸²æŸ“çš„æœåŠ¡å¼•æ“ï¼Œé‚£ä¹ˆä½¿ç”¨ koa-ejs ä½œä¸º HTML è¾“å‡ºä¹Ÿæ˜¯é¡ºå…¶è‡ªç„¶çš„äº‹äº† å¼€å§‹ å®‰è£… koaï¼Œkoa-ejs 1npm install koa koa-ejs index.js ç›®å½•ï¼Œåˆ›å»º koa å¯¹è±¡ï¼Œkoa-ejs è¿”å›ä¸€ä¸ª render å¯¹è±¡ï¼Œé€šè¿‡è¿™ä¸ªå¯¹è±¡ç»™ ctx å¯¹è±¡è¿›è¡Œ render èµ‹å€¼ï¼Œä¹‹åå°±å¯ä»¥åœ¨è·¯ç”±ä¸­ä½¿ç”¨ ctx.render 123456789101112131415161718192021222324const Koa = require(&apos;koa&apos;)const render = require(&apos;koa-ejs&apos;);const app = new Koa();render(app, &#123; // æ¨¡ç‰ˆæ ¹ç›®å½• root: path.join(__dirname, &apos;view&apos;), // æ ‡å‡†æ¨¡ç‰ˆåå­— layout: &apos;template&apos;, // æ¨¡ç‰ˆåç¼€ï¼Œé»˜è®¤æ˜¯ html viewExt: &apos;html&apos;, // æ˜¯å¦ä½¿ç”¨ç¼“å­˜ cache: false, // æ˜¯å¦å¼€å¯ debug debug: false,&#125;);app.use(async function (ctx) &#123; const users = [&#123; name: &apos;Dead Horse&apos; &#125;, &#123; name: &apos;Jack&apos; &#125;, &#123; name: &apos;Tom&apos; &#125;]; await ctx.render(&apos;content&apos;, &#123; users &#125;);&#125;); template.html æ–‡ä»¶ 123456789&lt;html&gt; &lt;head&gt; &lt;title&gt;koa ejs&lt;/title&gt; &lt;/head&gt; &lt;body&gt; &lt;h3&gt;koa ejs&lt;/h3&gt; &lt;%- body %&gt; &lt;/body&gt;&lt;/html&gt; content.html æ–‡ä»¶ 123&lt;div&gt; &lt;% include user.html %&gt;&lt;/div&gt; user.html 12345&lt;ul&gt; &lt;% users.forEach(function (user) &#123;%&gt; &lt;li&gt;&lt;%= user.name %&gt;&lt;/li&gt; &lt;% &#125;)%&gt;&lt;/ul&gt; è¾“å‡º 123Dead HorseJackTom æºç è§£æ å…¶å® koa-ejs çš„æºç å¾ˆç®€å•ï¼Œä¸»è¦æ˜¯å¼•ç”¨äº† ejs æ¡†æ¶ï¼Œç®€å•åšäº†å°è£…ï¼Œå°† render æŒ‚è½½åˆ° ctx ä¸Š å…¥å£ å½“å¼•å…¥çš„æ—¶å€™ï¼Œæ‰§è¡Œäº† render å°±ä¼šè¿›è¡Œåˆå§‹åŒ–ï¼Œå¹¶ä¸”å£°æ˜äº† render çš„å¼‚æ­¥æ–¹æ³•ï¼Œä¸»è¦æ˜¯è·å– template æ–‡ä»¶ï¼Œç„¶åä½¿ç”¨ ejs.compile å»æ„é€ å‡½æ•°ï¼Œè¯¥æ–¹æ³•ä¸»è¦çš„ä½œç”¨å°±æ˜¯æ›¿æ¢ ejs ä¸­çš„å˜é‡ï¼Œç”Ÿæˆ htmlã€‚å¦‚æœæœ‰ç¼“å­˜ï¼Œé‚£ä¹ˆåˆ™ä¸è¯»å–æ–‡ä»¶äº†ï¼Œç›´æ¥è¿›è¡Œæ›¿æ¢ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859exports = module.exports = function (app, settings) &#123; if (app.context.render) &#123; return; &#125; settings.root = path.resolve(process.cwd(), settings.root); /** * cache the generate package * @type &#123;Object&#125; */ const cache = Object.create(null); settings = Object.assign(&#123;&#125;, defaultSettings, settings); settings.viewExt = settings.viewExt ? &apos;.&apos; + settings.viewExt.replace(/^\\./, &apos;&apos;) : &apos;&apos;; async function render(view, options) &#123; view += settings.viewExt; const viewPath = path.join(settings.root, view); debug(`render: $&#123;viewPath&#125;`); // get from cache if (settings.cache &amp;&amp; cache[viewPath]) &#123; return cache[viewPath].call(options.scope, options); &#125; const tpl = await fs.readFile(viewPath, &apos;utf8&apos;); // override `ejs` node_module `resolveInclude` function ejs.resolveInclude = function(name, filename, isDir) &#123; if (!path.extname(name)) &#123; name += settings.viewExt; &#125; return parentResolveInclude(name, filename, isDir); &#125; const fn = ejs.compile(tpl, &#123; filename: viewPath, _with: settings._with, compileDebug: settings.debug &amp;&amp; settings.compileDebug, debug: settings.debug, delimiter: settings.delimiter, cache: settings.cache, async: settings.async &#125;); if (settings.cache) &#123; cache[viewPath] = fn; &#125; return fn.call(options.scope, options); &#125; app.context.render = async function (view, _context) &#123; // &#125;;&#125;; æœ€åå°†ä¸º app çš„ context æ–°å¢ render æ–¹æ³• 12345678910111213141516171819202122232425app.context.render = async function (view, _context) &#123; const ctx = this; const context = Object.assign(&#123;&#125;, ctx.state, _context); // è·å– html let html = await render(view, context); // å¦‚æœä½¿ç”¨äº† layoutï¼Œä¹Ÿå°±æ˜¯æœ‰äºŒçº§é¡µé¢ï¼Œå†ä¸€æ¬¡æ¸²æŸ“ const layout = context.layout === false ? false : (context.layout || settings.layout); if (layout) &#123; // if using layout context.body = html; html = await render(layout, context); &#125; // ç›´æ¥èµ‹å€¼ç»™ body const writeResp = context.writeResp === false ? false : (context.writeResp || settings.writeResp); if (writeResp) &#123; // normal operation ctx.type = &apos;html&apos;; ctx.body = html; &#125; else &#123; // only return the html return html; &#125;&#125;; ä¹‹åå°±å¯ä»¥ä½¿ç”¨ ctx.render 123await ctx.render(&apos;content&apos;, &#123; users&#125;); éå¸¸ç®€å•çš„æºç ï¼ŒåŒ…å«äº†ç¼“å­˜ç­‰é€»è¾‘ï¼ŒåŸºæœ¬æ»¡è¶³æˆ‘ä»¬çš„æ—¥å¸¸éœ€è¦ æ€è€ƒ ğŸ¤”å¥½å¥½å­¦ä¹ ","categories":[{"name":"JavaScript","slug":"JavaScript","permalink":"https://wzes.github.io/categories/JavaScript/"}],"tags":[{"name":"JavaScript","slug":"JavaScript","permalink":"https://wzes.github.io/tags/JavaScript/"},{"name":"Koa","slug":"Koa","permalink":"https://wzes.github.io/tags/Koa/"}]},{"title":"NextJS å…¥é—¨æŒ‡å—","slug":"JavaScript/NextJS","date":"2019-11-09T10:30:16.000Z","updated":"2019-11-10T07:50:48.873Z","comments":true,"path":"2019/11/09/JavaScript/NextJS/","link":"","permalink":"https://wzes.github.io/2019/11/09/JavaScript/NextJS/","excerpt":"","text":"å‰è¨€ æœ€è¿‘åœ¨ç ”ç©¶SSRæœåŠ¡ç«¯æ¸²æŸ“ï¼ŒNextJS ç®—æ˜¯æ¯”è¾ƒç»å…¸çš„æ¡†æ¶äº†ï¼Œæ‰€ä»¥äº†è§£äº†è§£å…¶ç”¨æ³•å¯¹SSRæˆ–è®¸èƒ½åŠ æ·±ç†è§£ã€‚å¦‚æœèƒ½äº†è§£å…¶å®ç°åŸç†ï¼Œé‚£å°±æ›´å¥½äº†ã€‚ æœåŠ¡ç«¯æ¸²æŸ“ ç®€å•ç†è§£å°±æ˜¯ï¼šä½ è®¿é—®ç½‘é¡µçš„æ—¶å€™ï¼Œä¼šä¸€æ¬¡æ€§æŠŠå®Œæ•´çš„HTMLè¿”å›ç»™ä½ ã€‚åŒºåˆ«äº Reactï¼ŒVue é¡¹ç›®ï¼ŒHTML æ–‡æ¡£åªæ˜¯ä¸€ä¸ªå£³å­ï¼Œéœ€è¦è¿è¡Œ js æ‰èƒ½å¾—åˆ°é¦–å±çš„ Domã€‚ ç®€ä»‹ Next.js æ˜¯ä¸€ä¸ªè½»é‡çº§çš„ React æœåŠ¡ç«¯æ¸²æŸ“åº”ç”¨æ¡†æ¶ã€‚ Get Started åˆå§‹åŒ–é¡¹ç›®ï¼Œå®‰è£… next 1npm install --save next react react-dom å°†ä¸‹é¢è„šæœ¬æ·»åŠ åˆ° package.json ä¸­: 1234567&#123; &quot;scripts&quot;: &#123; &quot;dev&quot;: &quot;next&quot;, &quot;build&quot;: &quot;next build&quot;, &quot;start&quot;: &quot;next start&quot; &#125;&#125; æ–°å»º ./pages/index.js åˆ°ä½ çš„é¡¹ç›®ä¸­: 1export default () =&gt; &lt;div&gt;Welcome to next.js!&lt;/div&gt; è¿è¡Œ npm run dev å‘½ä»¤å¹¶æ‰“å¼€ http://localhost:3000ã€‚ å¦‚æœä½ æƒ³ä½¿ç”¨å…¶ä»–ç«¯å£ï¼Œå¯è¿è¡Œ npm run dev -- -p &lt;è®¾ç½®ç«¯å£å·&gt;. å¦‚ä½•ä½¿ç”¨æœåŠ¡ç«¯æ¸²æŸ“ï¼Ÿ é»˜è®¤æ”¯æŒæœåŠ¡ç«¯æ¸²æŸ“ï¼Œè·å–ç½‘ç»œè¯·æ±‚å†™åœ¨ getInitialProps å†…éƒ¨ï¼Œå°±å¯ä»¥åœ¨ render ä¸­è·å–æ•°æ®ï¼Œç›´æ¥æ¸²æŸ“ã€‚ 12345678910111213141516import React from &apos;react&apos;export default class extends React.Component &#123; static async getInitialProps(&#123; req &#125;) &#123; const userAgent = req ? req.headers[&apos;user-agent&apos;] : navigator.userAgent return &#123; userAgent &#125; &#125; render() &#123; return ( &lt;div&gt; Hello World &#123;this.props.userAgent&#125; &lt;/div&gt; ) &#125;&#125; åŸç† åº”ç”¨å…¥å£ ä½¿ç”¨äº† node command lineï¼Œèƒ½è®©æˆ‘ä»¬ä»…ä»…å†™äº† page çš„ä»£ç ï¼Œå°±èƒ½è®©æ•´ä¸ªåº”ç”¨è·‘èµ·æ¥ã€‚ä»¥è‡³äºæˆ‘ä»¬éƒ½æ‰¾ä¸åˆ°å…¥å£ã€‚nextjs çœŸçš„æ˜¯å¾ˆå‰å®³ï½å°è£…çš„å¾ˆå¥½ å¯ä»¥çœ‹åˆ°ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨ yarn start çš„æ—¶å€™ï¼Œåº”ç”¨æ‰§è¡Œäº† next-start 123456789const commands: &#123; [command: string]: () =&gt; Promise&lt;cliCommand&gt; &#125; = &#123; build: async () =&gt; await import(&apos;../cli/next-build&apos;).then(i =&gt; i.nextBuild), start: async () =&gt; await import(&apos;../cli/next-start&apos;).then(i =&gt; i.nextStart), export: async () =&gt; await import(&apos;../cli/next-export&apos;).then(i =&gt; i.nextExport), dev: async () =&gt; await import(&apos;../cli/next-dev&apos;).then(i =&gt; i.nextDev), telemetry: async () =&gt; await import(&apos;../cli/next-telemetry&apos;).then(i =&gt; i.nextTelemetry),&#125; next-start å¼€å¯äº†ä¸€ä¸ªæœåŠ¡ 12345678910111213startServer(&#123; dir &#125;, port, args[&apos;--hostname&apos;]) .then(async app =&gt; &#123; // tslint:disable-next-line console.log( `&gt; Ready on http://$&#123;args[&apos;--hostname&apos;] || &apos;localhost&apos;&#125;:$&#123;port&#125;` ) await app.prepare() &#125;) .catch(err =&gt; &#123; // tslint:disable-next-line console.error(err) process.exit(1) &#125;) startServer çš„å®ç°ï¼Œè·å– next å®ä¾‹ï¼Œç„¶åä½¿ç”¨ http åˆ›å»ºæœåŠ¡ï¼Œä¸»è¦çš„è¯·æ±‚é€»è¾‘çš„ä»£ç éƒ½åœ¨ next çš„ getRequestHandler é‡Œé¢ 1234567891011121314151617export default async function start( serverOptions: any, port?: number, hostname?: string) &#123; const app = next(serverOptions) const srv = http.createServer(app.getRequestHandler()) await new Promise((resolve, reject) =&gt; &#123; // This code catches EADDRINUSE error if the port is already in use srv.on(&apos;error&apos;, reject) srv.on(&apos;listening&apos;, () =&gt; resolve()) srv.listen(port, hostname) &#125;) // It&apos;s up to caller to run `app.prepare()`, so it can notify that the server // is listening before starting any intensive operations. return app&#125; handleRequest å¤„ç†è¯·æ±‚ 123456789101112private handleRequest( req: IncomingMessage, res: ServerResponse, parsedUrl?: UrlWithParsedQuery): Promise&lt;void&gt; &#123; res.statusCode = 200 return this.run(req, res, parsedUrl).catch(err =&gt; &#123; this.logError(err) res.statusCode = 500 res.end(&apos;Internal Server Error&apos;) &#125;)&#125; run è·å– route å®ä¾‹å¹¶è¿›è¡Œå¤„ç† 12345678910111213141516171819202122protected async run( req: IncomingMessage, res: ServerResponse, parsedUrl: UrlWithParsedQuery) &#123; this.handleCompression(req, res) try &#123; const fn = this.router.match(req, res, parsedUrl) if (fn) &#123; await fn() return &#125; &#125; catch (err) &#123; if (err.code === &apos;DECODE_FAILED&apos;) &#123; res.statusCode = 400 return this.renderError(null, req, res, &apos;/_error&apos;, &#123;&#125;) &#125; throw err &#125; await this.render404(req, res, parsedUrl)&#125; router æ˜¯åœ¨é¡¹ç›®åˆå§‹åŒ–çš„æ—¶å€™è¿›è¡Œåˆ›å»ºçš„ï¼Œå…¶ä¸­ä¸€ä¸ªå°±æ˜¯æ ¹æ®ï¼Œé»˜è®¤éƒ½ä¼šæœ‰å¾ˆå¤šè·¯ç”±å¤„ç†å™¨ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071protected generateRoutes(): Route[] &#123; const publicRoutes = fs.existsSync(this.publicDir) ? this.generatePublicRoutes() : [] const staticFilesRoute = fs.existsSync(join(this.dir, &apos;static&apos;)) ? [ &#123; match: route(&apos;/static/:path*&apos;), fn: async (req, res, params, parsedUrl) =&gt; &#123; const p = join(this.dir, &apos;static&apos;, ...(params.path || [])) await this.serveStatic(req, res, p, parsedUrl) &#125;, &#125; as Route, ] : [] const routes: Route[] = [ &#123; match: route(&apos;/_next/static/:path*&apos;), fn: async (req, res, params, parsedUrl) =&gt; &#123; await this.serveStatic(req, res, p, parsedUrl) &#125;, &#125;, &#123; match: route(&apos;/_next/data/:path*&apos;), fn: async (req, res, params, _parsedUrl) =&gt; &#123; await this.render( req, res, pathname, &#123; _nextSprData: &apos;1&apos; &#125;, parsedUrl ) &#125;, &#125;, &#123; match: route(&apos;/_next/:path*&apos;), fn: async (req, res, _params, parsedUrl) =&gt; &#123; await this.render404(req, res, parsedUrl) &#125;, &#125;, ...publicRoutes, ...staticFilesRoute, &#123; match: route(&apos;/api/:path*&apos;), fn: async (req, res, params, parsedUrl) =&gt; &#123; const &#123; pathname &#125; = parsedUrl await this.handleApiRequest( req as NextApiRequest, res as NextApiResponse, pathname! ) &#125;, &#125;, ] if (this.nextConfig.useFileSystemPublicRoutes) &#123; this.dynamicRoutes = this.getDynamicRoutes() routes.push(&#123; match: route(&apos;/:path*&apos;), fn: async (req, res, _params, parsedUrl) =&gt; &#123; const &#123; pathname, query &#125; = parsedUrl if (!pathname) &#123; throw new Error(&apos;pathname is undefined&apos;) &#125; await this.render(req, res, pathname, query, parsedUrl) &#125;, &#125;) &#125; return routes&#125; é»˜è®¤é¡µé¢è·¯ç”±éƒ½æ˜¯èµ°åˆ°æœ€åï¼Œä¹Ÿå°±æ˜¯æ‰§è¡Œ renderï¼Œè·å–æ¸²æŸ“çš„ html 123456789101112131415161718192021222324252627282930public async render( req: IncomingMessage, res: ServerResponse, pathname: string, query: ParsedUrlQuery = &#123;&#125;, parsedUrl?: UrlWithParsedQuery): Promise&lt;void&gt; &#123; const url: any = req.url if (isInternalUrl(url)) &#123; return this.handleRequest(req, res, parsedUrl) &#125; if (isBlockedPage(pathname)) &#123; return this.render404(req, res, parsedUrl) &#125; const html = await this.renderToHTML(req, res, pathname, query, &#123; dataOnly: (this.renderOpts.ampBindInitData &amp;&amp; Boolean(query.dataOnly)) || (req.headers &amp;&amp; (req.headers.accept || &apos;&apos;).indexOf(&apos;application/amp.bind+json&apos;) !== -1), &#125;) // Request was ended by the user if (html === null) &#123; return &#125; return this.sendHTML(req, res, html)&#125; å…¶ä¸­ renderToHTML å®ç°äº†å…·ä½“é€»è¾‘ï¼Œé€šè¿‡ sendHTML è¿”å›é¡µé¢ HTML renderToHTML å®ç°ï¼Œé¦–å…ˆé€šè¿‡ findPageComponents è·å–è·¯ç”±å…·ä½“é¡µé¢ Compenentï¼Œç„¶åä½¿ç”¨renderToHTMLWithComponents è¿›è¡Œ React è½¬æ¢ä¸º HTML 1234567891011121314public renderToHTML( ... ): Promise&lt;string | null&gt; &#123; return this.findPageComponents(pathname, query) .then( result =&gt; &#123; return this.renderToHTMLWithComponents( .... result, &#123; ...this.renderOpts, amphtml, hasAmp, dataOnly &#125; ) &#125;, ) &#125; renderToHTMLï¼Œåœ¨ renderToHTMLWithComponents å†…éƒ¨æ‰§è¡Œ çœç•¥äº†å¾ˆå¤šä»£ç ï¼Œä¸ºäº†äº†è§£ä¸»è¦é€»è¾‘ã€‚ é¦–å…ˆä¼šæ‰§è¡Œ loadGetInitialPropsï¼Œä¹Ÿå°±æ˜¯ä¸šåŠ¡ä»£ç ä¸­çš„ props è·å–ï¼Œè¿è¡Œåœ¨æœåŠ¡ç«¯ã€‚ ç„¶åä½¿ç”¨ Document çš„ getInitialProps åˆ›å»º Documentï¼Œå¹¶æŠŠ component èµ‹å€¼ï¼Œè·å–æœ€ç»ˆçš„ html 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144export async function renderToHTML( req: IncomingMessage, res: ServerResponse, pathname: string, query: ParsedUrlQuery, renderOpts: RenderOpts): Promise&lt;string | null&gt; &#123; .... let props: any const AppContainer = (&#123; children &#125;: any) =&gt; ( &lt;RouterContext.Provider value=&#123;router&#125;&gt; &lt;DataManagerContext.Provider value=&#123;dataManager&#125;&gt; &lt;AmpStateContext.Provider value=&#123;ampState&#125;&gt; &lt;LoadableContext.Provider value=&#123;moduleName =&gt; reactLoadableModules.push(moduleName)&#125; &gt; &#123;children&#125; &lt;/LoadableContext.Provider&gt; &lt;/AmpStateContext.Provider&gt; &lt;/DataManagerContext.Provider&gt; &lt;/RouterContext.Provider&gt; ) try &#123; props = await loadGetInitialProps(App, &#123; AppTree: ctx.AppTree, Component, router, ctx, &#125;) ...... &#125; .... renderPage = ( options: ComponentsEnhancer = &#123;&#125; ): &#123; html: string; head: any &#125; =&gt; &#123; const renderError = renderPageError() if (renderError) return renderError const &#123; App: EnhancedApp, Component: EnhancedComponent, &#125; = enhanceComponents(options, App, Component) return render( renderElementToString, &lt;AppContainer&gt; &lt;EnhancedApp Component=&#123;EnhancedComponent&#125; router=&#123;router&#125; &#123;...props&#125; /&gt; &lt;/AppContainer&gt;, ampState ) &#125; const documentCtx = &#123; ...ctx, renderPage &#125; const docProps = await loadGetInitialProps(Document, documentCtx) // the response might be finished on the getInitialProps call if (isResSent(res) &amp;&amp; !isSpr) return null let dataManagerData = &apos;[]&apos; if (dataManager) &#123; dataManagerData = JSON.stringify([...dataManager.getData()]) &#125; if (!docProps || typeof docProps.html !== &apos;string&apos;) &#123; const message = `&quot;$&#123;getDisplayName( Document )&#125;.getInitialProps()&quot; should resolve to an object with a &quot;html&quot; prop set with a valid html string` throw new Error(message) &#125; if (docProps.dataOnly) &#123; return dataManagerData &#125; const dynamicImportIdsSet = new Set&lt;string&gt;() const dynamicImports: ManifestItem[] = [] for (const mod of reactLoadableModules) &#123; const manifestItem = reactLoadableManifest[mod] if (manifestItem) &#123; manifestItem.map(item =&gt; &#123; dynamicImports.push(item) dynamicImportIdsSet.add(item.id as string) &#125;) &#125; &#125; const dynamicImportsIds = [...dynamicImportIdsSet] const inAmpMode = isInAmpMode(ampState) const hybridAmp = ampState.hybrid // update renderOpts so export knows current state renderOpts.inAmpMode = inAmpMode renderOpts.hybridAmp = hybridAmp let html = renderDocument(Document, &#123; ...renderOpts, dangerousAsPath: router.asPath, dataManagerData, ampState, props, headTags: await headTags(documentCtx), bodyTags: await bodyTags(documentCtx), htmlProps: await htmlProps(documentCtx), docProps, pathname, ampPath, query, inAmpMode, hybridAmp, dynamicImportsIds, dynamicImports, files, devFiles, polyfillFiles, &#125;) if (inAmpMode &amp;&amp; html) &#123; // use replace to allow rendering directly to body in AMP mode html = html.replace( &apos;__NEXT_AMP_RENDER_TARGET__&apos;, `&lt;!-- __NEXT_DATA__ --&gt;$&#123;docProps.html&#125;` ) html = await optimizeAmp(html) if (renderOpts.ampValidator) &#123; await renderOpts.ampValidator(html, pathname) &#125; &#125; if (inAmpMode || hybridAmp) &#123; // fix &amp;amp being escaped for amphtml rel link html = html.replace(/&amp;amp;amp=1/g, &apos;&amp;amp=1&apos;) &#125; return html&#125; ä½¿ç”¨ renderElementToString æ¸²æŸ“è·å– html 12345678910111213141516function render( renderElementToString: (element: React.ReactElement&lt;any&gt;) =&gt; string, element: React.ReactElement&lt;any&gt;, ampMode: any): &#123; html: string; head: React.ReactElement[] &#125; &#123; let html let head try &#123; html = renderElementToString(element) &#125; finally &#123; head = Head.rewind() || defaultHead(isInAmpMode(ampMode)) &#125; return &#123; html, head &#125;&#125; åˆ°è¿™é‡ŒåŸºæœ¬å°±ç»“æŸäº† Nextjs è¿˜å¯ä»¥æœ‰å¾ˆå¤šè‡ªå®šçš„ä¸œè¥¿ï¼Œä¸ koaï¼Œexpress ç»“åˆï½ å‚è€ƒ https://nextjs.org/ åç»­ åšå¤§ç²¾æ·±å•Š","categories":[{"name":"JavaScript","slug":"JavaScript","permalink":"https://wzes.github.io/categories/JavaScript/"}],"tags":[{"name":"JavaScript","slug":"JavaScript","permalink":"https://wzes.github.io/tags/JavaScript/"}]},{"title":"Intersection Obersever API ä¸­æ–‡","slug":"JavaScript/IntersectionObserverAPI","date":"2019-10-26T07:30:16.000Z","updated":"2019-10-26T07:16:55.511Z","comments":true,"path":"2019/10/26/JavaScript/IntersectionObserverAPI/","link":"","permalink":"https://wzes.github.io/2019/10/26/JavaScript/IntersectionObserverAPI/","excerpt":"","text":"Intersection observer ç®€ä»‹ Intersection Observer API æä¾›äº†ä¸€ç§å¼‚æ­¥è§‚å¯Ÿç›®æ ‡å…ƒç´ ä¸ç¥–å…ˆå…ƒç´ æˆ–é¡¶çº§æ–‡æ¡£çš„è§†å£ç›¸äº¤çš„æ–¹æ³•ã€‚ åœ¨ä»¥å‰ï¼Œæ£€æµ‹ä¸€ä¸ªå…ƒç´ çš„å¯è§æ€§æˆ–ä¸¤ä¸ªå…ƒç´ ç›¸å¯¹äºå½¼æ­¤çš„ç›¸å¯¹å¯è§æ€§ä¸€ç›´æ˜¯ä¸€é¡¹è‰°å·¨çš„ä»»åŠ¡ï¼Œå…¶è§£å†³æ–¹æ¡ˆä¸å¯é ä¸”æ˜“äºå¯¼è‡´æµè§ˆå™¨å’Œç”¨æˆ·è®¿é—®çš„ç½‘é¡µå˜æ…¢ã€‚ éšç€ç½‘ç»œçš„æˆç†Ÿï¼Œå¯¹æ­¤ç±»åŠŸèƒ½çš„éœ€æ±‚ä¹Ÿåœ¨å¢é•¿ã€‚ å‡ºäºå¤šç§åŸå› éœ€è¦å…ƒç´ çš„å¯è§æ€§ä¿¡æ¯ï¼Œä¾‹å¦‚ï¼š æ»šåŠ¨é¡µé¢æ—¶å»¶è¿ŸåŠ è½½å›¾åƒæˆ–å…¶ä»–å†…å®¹ã€‚ å®ç°â€œæ— é™æ»šåŠ¨â€çš„ç½‘é¡µï¼Œåœ¨æ‚¨æ»šåŠ¨æ—¶ä¼šåŠ è½½å’Œå‘ˆç°è¶Šæ¥è¶Šå¤šçš„å†…å®¹ï¼Œä»è€Œä½¿ç”¨æˆ·ä¸å¿…ç¿»é˜…é¡µé¢ã€‚ ç»Ÿè®¡å¹¿å‘Šå¯è§åº¦ï¼Œä»¥è®¡ç®—å¹¿å‘Šæ”¶å…¥ã€‚ æ ¹æ®ç”¨æˆ·æ˜¯å¦ä¼šçœ‹åˆ°ç»“æœæ¥å†³å®šæ˜¯å¦æ‰§è¡Œä»»åŠ¡æˆ–åŠ¨ç”»å¤„ç†ã€‚ è¿‡å»å®ç°äº¤å‰æ£€æµ‹é€šå¸¸æ¶‰åŠåˆ°äº‹ä»¶å¤„ç†ç¨‹åºï¼Œå¹¶ä¸”å¾ªç¯è°ƒç”¨ Element.getBoundingClientRectï¼ˆï¼‰ä¹‹ç±»çš„æ–¹æ³•æ¥ä¸ºæ¯ä¸ªå—å½±å“çš„å…ƒç´ å»ºç«‹æ‰€éœ€çš„ä¿¡æ¯ã€‚ ç”±äºæ‰€æœ‰è¿™äº›ä»£ç éƒ½åœ¨ä¸»çº¿ç¨‹ä¸Šè¿è¡Œï¼Œå› æ­¤å³ä½¿åªæœ‰ä¸€ä¸ªï¼Œä¹Ÿå¯èƒ½ä¼šå¯¼è‡´æ€§èƒ½é—®é¢˜ã€‚ å½“ç½‘ç«™åŠ è½½äº†è¿™äº›æµ‹è¯•æ—¶ï¼Œäº‹æƒ…å¯èƒ½ä¼šå˜å¾—å¾ˆéš¾çœ‹ã€‚ è€ƒè™‘ä½¿ç”¨æ— é™æ»šåŠ¨çš„ç½‘é¡µã€‚å®ƒä½¿ç”¨ä¾›åº”å•†æä¾›çš„åº“æ¥ç®¡ç†åœ¨æ•´ä¸ªé¡µé¢ä¸­å®šæœŸæ”¾ç½®çš„å¹¿å‘Šï¼Œè¿™äº›å¹¿å‘Šå…·æœ‰åŠ¨ç”»å›¾å½¢ï¼Œä½¿ç”¨è‡ªå®šä¹‰åº“ç»˜åˆ¶é€šçŸ¥æ¡†ç­‰ç­‰ã€‚æ¯ä¸ªå…ƒç´ éƒ½æœ‰å…¶è‡ªå·±çš„ç›¸äº¤æ£€æµ‹ç¨‹åºï¼Œå®ƒä»¬å‡åœ¨ä¸»çº¿ç¨‹ä¸Šè¿è¡Œã€‚è¯¥ç½‘ç«™çš„ä½œè€…ç”šè‡³å¯èƒ½æ²¡æœ‰æ„è¯†åˆ°è¿™ç§æƒ…å†µçš„å‘ç”Ÿï¼Œå› ä¸ºä»–ä»¬å¯èƒ½å¯¹æ‰€ä½¿ç”¨çš„ä¸¤ä¸ªåº“çš„å†…éƒ¨è¿ä½œäº†è§£å¾—å¾ˆå°‘ã€‚å½“ç”¨æˆ·æ»šåŠ¨é¡µé¢æ—¶ï¼Œè¿™äº›ç›¸äº¤æ£€æµ‹ç¨‹åºåœ¨æ»šåŠ¨å¤„ç†ä»£ç æœŸé—´ä¸æ–­è§¦å‘ï¼Œä»è€Œå¯¼è‡´ç”¨æˆ·å¯¹æµè§ˆå™¨ï¼Œç½‘ç«™åŠå…¶è®¡ç®—æœºæ„Ÿåˆ°å´©æºƒã€‚ Intersection Observer API ä½¿ä»£ç å¯ä»¥æ³¨å†Œä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œè¯¥å›è°ƒå‡½æ•°å°†åœ¨ä»–ä»¬å¸Œæœ›ç›‘è§†çš„å…ƒç´ è¿›å…¥æˆ–é€€å‡ºå¦ä¸€ä¸ªå…ƒç´ ï¼ˆæˆ–è§†å£ï¼‰æ—¶ï¼Œæˆ–è€…å½“ä¸¤ä¸ªç›¸äº¤çš„é‡æ”¹å˜è¯·æ±‚çš„é‡æ—¶æ‰§è¡Œã€‚è¿™æ ·ï¼Œç«™ç‚¹ä¸å†éœ€è¦åœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œä»»ä½•æ“ä½œæ¥ç›‘è§†è¿™ç§å…ƒç´ äº¤é›†ï¼Œå¹¶ä¸”æµè§ˆå™¨å¯ä»¥è‡ªç”±åœ°ä¼˜åŒ–äº¤é›†çš„ç®¡ç†ã€‚ Intersection Observer APIä¸èƒ½å‘Šè¯‰æ‚¨çš„ä¸€ä»¶äº‹ï¼šé‡å çš„ç¡®åˆ‡åƒç´ æ•°æˆ–ç¡®åˆ‡åœ°è¯´æ˜¯é‡å åƒç´ ã€‚ä½†æ˜¯ï¼Œå®ƒæ¶µç›–äº†æ›´å¸¸è§çš„ç”¨ä¾‹ï¼šâ€œå¦‚æœå®ƒä»¬ç›¸äº¤Nï¼…å·¦å³ï¼Œæˆ‘éœ€è¦åšç‚¹ä»€ä¹ˆã€‚â€ Intersection observer æ¦‚å¿µå’Œä½¿ç”¨ Intersection Observer APIå…è®¸æ‚¨é…ç½®ä¸€ä¸ª callbackï¼Œåªè¦ä¸€ä¸ªå…ƒç´ ï¼ˆç§°ä¸ºç›®æ ‡ï¼‰ä¸è®¾å¤‡è§†å£æˆ–æŒ‡å®šå…ƒç´ ç›¸äº¤ï¼Œå°±ä¼šè°ƒç”¨è¯¥ callbackã€‚ å°±æ­¤APIè€Œè¨€ï¼Œè¿™ç§°ä¸ºæ ¹å…ƒç´ æˆ–æ ¹ã€‚ é€šå¸¸ï¼Œæ‚¨å°†éœ€è¦æ³¨æ„ä¸å…ƒç´ æœ€æ¥è¿‘çš„å¯æ»šåŠ¨ç¥–å…ˆç›¸å…³çš„ç›¸äº¤å˜åŒ–ï¼Œæˆ–è€…ï¼Œå¦‚æœå…ƒç´ ä¸æ˜¯å¯æ»šåŠ¨å…ƒç´ çš„åä»£ï¼Œåˆ™è¦è§‚å¯Ÿè§†å£ã€‚ è¦æ³¨æ„ç›¸å¯¹äºæ ¹å…ƒç´ çš„äº¤ç‚¹ï¼Œè¯·æŒ‡å®šnullã€‚ æ— è®ºæ‚¨æ˜¯ä½¿ç”¨è§†å£è¿˜æ˜¯å…¶ä»–å…ƒç´ ä½œä¸ºæ ¹ï¼ŒAPIéƒ½ä»¥ç›¸åŒçš„æ–¹å¼å·¥ä½œï¼Œåªè¦ç›®æ ‡å…ƒç´ çš„å¯è§æ€§å‘ç”Ÿå˜åŒ–ï¼Œä»¥ä¾¿ä¸æ ¹äº¤å‰è¶…è¿‡æ‰€éœ€çš„äº¤é›†é‡ï¼Œå°±æ‰§è¡Œæ‚¨æä¾›çš„å›è°ƒå‡½æ•°ã€‚ ç›®æ ‡å…ƒç´ ä¸å…¶æ ¹ä¹‹é—´çš„ç›¸äº¤åº¦ä¸ºç›¸äº¤æ¯”ã€‚ è¿™è¡¨ç¤ºç›®æ ‡å…ƒç´ çš„ç™¾åˆ†æ¯”ï¼Œè¯¥ç™¾åˆ†æ¯”å¯è§ä¸º0.0åˆ°1.0ä¹‹é—´çš„å€¼ã€‚ åˆ›å»ºä¸€ä¸ª intersection observer é€šè¿‡è°ƒç”¨äº¤é›†è§‚å¯Ÿå™¨çš„æ„é€ å‡½æ•°å¹¶å‘å…¶ä¼ é€’ä¸€ä¸ªå›è°ƒå‡½æ•°æ¥åˆ›å»ºäº¤é›†è§‚å¯Ÿè€…ï¼Œåªè¦åœ¨ä¸€ä¸ªæ–¹å‘æˆ–å¦ä¸€ä¸ªæ–¹å‘ä¸Šè¶…è¿‡é˜ˆå€¼ï¼Œè¯¥å›è°ƒå‡½æ•°ä¾¿ä¼šè¿è¡Œï¼š 1234567let options = &#123; root: document.querySelector(&apos;#scrollArea&apos;), rootMargin: &apos;0px&apos;, threshold: 1.0&#125;let observer = new IntersectionObserver(callback, options); é˜ˆå€¼1.0è¡¨ç¤ºåœ¨rooté€‰é¡¹æŒ‡å®šçš„å…ƒç´ ä¸­å¯è§ç›®æ ‡çš„100ï¼…æ—¶ï¼Œå°†è°ƒç”¨å›è°ƒã€‚ Intersection observer options å‚æ•° ä¼ é€’ç»™ IntersectionObserverï¼ˆï¼‰æ„é€ å‡½æ•°çš„ options å¯¹è±¡ä½¿æ‚¨å¯ä»¥æ§åˆ¶åœ¨å“ªäº›æƒ…å†µä¸‹è°ƒç”¨è§‚å¯Ÿè€…çš„å›è°ƒã€‚ å®ƒå…·æœ‰ä»¥ä¸‹å­—æ®µï¼š root ç”¨ä½œæ£€æŸ¥ç›®æ ‡å¯è§æ€§çš„è§†å£çš„å…ƒç´ ã€‚ å¿…é¡»æ˜¯ç›®æ ‡çš„ç¥–å…ˆã€‚ å¦‚æœæœªæŒ‡å®šæˆ–ä¸ºnullï¼Œåˆ™é»˜è®¤ä¸ºæµè§ˆå™¨è§†å£ã€‚ rootMargin å›´ç»•æ ¹çš„è¾¹è·ã€‚å¯ä»¥å…·æœ‰ç±»ä¼¼äºCSS marginå±æ€§çš„å€¼ï¼Œä¾‹å¦‚ &quot;10px 20px 30px 40px&quot;ï¼ˆï¼ˆä¸Šï¼Œå³ï¼Œä¸‹ï¼Œå·¦ï¼‰ã€‚è¿™äº›å€¼å¯ä»¥æ˜¯ç™¾åˆ†æ¯”ã€‚è¿™ç»„å€¼ç”¨äºåœ¨è®¡ç®—ç›¸äº¤ä¹‹å‰å¢å¤§æˆ–ç¼©å°æ ¹å…ƒç´ è¾¹ç•Œæ¡†çš„æ¯ä¸€ä¾§ã€‚é»˜è®¤ä¸ºå…¨é›¶ã€‚ threshold ä¸€ä¸ªæ•°å­—æˆ–ä¸€ä¸ªæ•°å­—æ•°ç»„ï¼ŒæŒ‡ç¤ºè§‚å¯Ÿè€…çš„å›è°ƒåº”åœ¨ç›®æ ‡å¯è§æ€§çš„ç™¾åˆ†æ¯”ä¸Šæ‰§è¡Œã€‚å¦‚æœåªæƒ³æ£€æµ‹å¯è§æ€§ä½•æ—¶è¶…è¿‡50ï¼…æ ‡è®°ï¼Œåˆ™å¯ä»¥ä½¿ç”¨0.5å€¼ã€‚å¦‚æœå¸Œæœ›æ¯æ¬¡å¯è§æ€§å†è¶…è¿‡25ï¼…æ—¶éƒ½è¿è¡Œå›è°ƒï¼Œåˆ™å¯ä»¥æŒ‡å®šæ•°ç»„[0ï¼Œ0.25ï¼Œ0.5ï¼Œ0.75ï¼Œ1]ã€‚é»˜è®¤å€¼ä¸º0ï¼ˆæ„å‘³ç€å³ä½¿å¯è§ä¸€ä¸ªåƒç´ ï¼Œå›è°ƒä¹Ÿå°†è¿è¡Œï¼‰ã€‚å€¼ä¸º1.0æ„å‘³ç€ç›´åˆ°æ¯ä¸ªåƒç´ éƒ½å¯è§ï¼Œæ‰è®¤ä¸ºé˜ˆå€¼å·²é€šè¿‡ã€‚ å®šä½è¦è§‚å¯Ÿçš„å…ƒç´  åˆ›å»ºè§‚å¯Ÿè€…åï¼Œéœ€è¦ç»™å®ƒä¸€ä¸ªç›®æ ‡å…ƒç´ ä»¥è¿›è¡Œè§‚å¯Ÿï¼š 12let target = document.querySelector(&apos;#listItem&apos;);observer.observe(target); æ¯å½“ç›®æ ‡è¾¾åˆ°ä¸ºæ‰€æŒ‡å®šçš„é˜ˆå€¼æ—¶IntersectionObserverï¼Œå°±ä¼šè°ƒç”¨å›è°ƒã€‚å›è°ƒæ¥æ”¶IntersectionObserverEntryå¯¹è±¡åˆ—è¡¨å’Œè§‚å¯Ÿè€…ï¼š 12345678910111213let callback = (entries, observer) =&gt; &#123; entries.forEach(entry =&gt; &#123; // Each entry describes an intersection change for one observed // target element: // entry.boundingClientRect // entry.intersectionRatio // entry.intersectionRect // entry.isIntersecting // entry.rootBounds // entry.target // entry.time &#125;);&#125;; è¯·æ³¨æ„ï¼Œæ‚¨çš„å›è°ƒæ˜¯åœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œçš„ã€‚å®ƒåº”å°½å¿«è¿è¡Œï¼›å¦‚æœéœ€è¦å®Œæˆä»»ä½•è€—æ—¶çš„æ“ä½œï¼Œè¯·ä½¿ç”¨Window.requestIdleCallback()ã€‚ å¦å¤–ï¼Œè¯·æ³¨æ„ï¼Œå¦‚æœæŒ‡å®šäº†è¯¥rooté€‰é¡¹ï¼Œåˆ™ç›®æ ‡å¿…é¡»æ˜¯æ ¹å…ƒç´ çš„åä»£ã€‚ å¦‚ä½•è®¡ç®—äº¤é›† Intersection Observer APIè€ƒè™‘çš„æ‰€æœ‰åŒºåŸŸéƒ½æ˜¯çŸ©å½¢ã€‚å½¢çŠ¶ä¸è§„åˆ™çš„å…ƒç´ è¢«è®¤ä¸ºå æ®äº†åŒ…å›´å…ƒç´ æ‰€æœ‰éƒ¨åˆ†çš„æœ€å°çŸ©å½¢ã€‚ç±»ä¼¼åœ°ï¼Œå¦‚æœå…ƒç´ çš„å¯è§éƒ¨åˆ†ä¸æ˜¯çŸ©å½¢ï¼Œåˆ™è¯¥å…ƒç´ çš„ç›¸äº¤çŸ©å½¢è¢«è§£é‡Šä¸ºåŒ…å«è¯¥å…ƒç´ æ‰€æœ‰å¯è§éƒ¨åˆ†çš„æœ€å°çŸ©å½¢ã€‚ äº†è§£ä¸€ç‚¹æœ‰å…³æä¾›çš„å„ç§å±æ€§å¦‚ä½•IntersectionObserverEntryæè¿°ç›¸äº¤çš„æ–¹æ³•å¾ˆæœ‰ç”¨ã€‚ äº¤ç‚¹æ ¹å’Œæ ¹è¾¹è· åœ¨è·Ÿè¸ªå…ƒç´ ä¸å®¹å™¨çš„äº¤é›†ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“è¯¥å®¹å™¨æ˜¯ä»€ä¹ˆã€‚è¯¥å®¹å™¨æ˜¯äº¤é›†æ ¹æˆ–æ ¹å…ƒç´ ã€‚è¿™å¯ä»¥æ˜¯æ–‡æ¡£ä¸­çš„ç‰¹å®šå…ƒç´ ï¼ˆæ˜¯è¦è§‚å¯Ÿçš„å…ƒç´ çš„ç¥–å…ˆï¼‰ï¼Œä¹Ÿnullå¯ä»¥æ˜¯æ–‡æ¡£çš„è§†å£ä½œä¸ºå®¹å™¨ã€‚ æ ¹çš„ç›¸äº¤çŸ©å½¢æ˜¯ç”¨äºæ‰€è¦æ£€æŸ¥çš„ç›®æ ‡æˆ–ç›®æ ‡çš„çŸ©å½¢ã€‚è¯¥çŸ©å½¢çš„ç¡®å®šå¦‚ä¸‹ï¼š å¦‚æœç›¸äº¤æ ¹æ˜¯éšå¼æ ¹ï¼ˆå³é¡¶çº§Documentï¼‰ï¼Œåˆ™æ ¹ç›¸äº¤çŸ©å½¢æ˜¯è§†å£çš„çŸ©å½¢ã€‚ å¦‚æœç›¸äº¤æ ¹å…·æœ‰æº¢å‡ºå‰ªè¾‘ï¼Œåˆ™æ ¹ç›¸äº¤çŸ©å½¢æ˜¯æ ¹å…ƒç´ çš„å†…å®¹åŒºåŸŸã€‚ å¦åˆ™ï¼Œæ ¹ç›¸äº¤çŸ©å½¢æ˜¯ç›¸äº¤æ ¹çš„è¾¹ç•Œå®¢æˆ·ç«¯çŸ©å½¢ï¼ˆé€šè¿‡è°ƒç”¨getBoundingClientRect()å®ƒè¿”å›ï¼‰ã€‚ åˆ›å»ºæ—¶ï¼Œå¯ä»¥é€šè¿‡è®¾ç½®æ ¹è¾¹ç¼˜æ¥è¿›ä¸€æ­¥è°ƒæ•´æ ¹ç›¸äº¤çŸ©å½¢ã€‚å®šä¹‰åç§»é‡ä¸­çš„å€¼æ·»åŠ åˆ°ç›¸äº¤æ ¹çš„è¾¹ç•Œæ¡†çš„æ¯ä¸€ä¾§ï¼Œä»¥åˆ›å»ºæœ€ç»ˆçš„ç›¸äº¤æ ¹è¾¹ç•Œï¼ˆåœ¨æ‰§è¡Œå›è°ƒæ—¶å…¬å¼€ï¼‰ã€‚rootMarginIntersectionObserverrootMarginIntersectionObserverEntry.rootBounds Thresholds é—¨æ§› Intersection Observer APIä½¿ç”¨é˜ˆå€¼ï¼Œè€Œä¸æ˜¯æŠ¥å‘Šå¯è§çš„ç›®æ ‡å…ƒç´ å¤šå°‘å¾®å°å˜åŒ–ã€‚åˆ›å»ºè§‚å¯Ÿè€…æ—¶ï¼Œå¯ä»¥æä¾›ä¸€ä¸ªæˆ–å¤šä¸ªæ•°å­—å€¼ï¼Œè¿™äº›æ•°å­—å€¼è¡¨ç¤ºå¯è§çš„ç›®æ ‡å…ƒç´ çš„ç™¾åˆ†æ¯”ã€‚ç„¶åï¼ŒAPIä»…æŠ¥å‘Šè¶…è¿‡è¿™äº›é˜ˆå€¼çš„å¯è§æ€§æ›´æ”¹ã€‚ ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨å¸Œæœ›æ¯æ¬¡ç›®æ ‡çš„å¯è§æ€§é€šè¿‡æ¯ä¸ª25ï¼…æ ‡è®°å‘åæˆ–å‘å‰ç§»åŠ¨æ—¶éƒ½å¾—åˆ°é€šçŸ¥ï¼Œåˆ™åœ¨åˆ›å»ºè§‚å¯Ÿè€…æ—¶ï¼Œå¯ä»¥å°†æ•°ç»„[0ï¼Œ0.25ï¼Œ0.5ï¼Œ0.75ï¼Œ1]æŒ‡å®šä¸ºé˜ˆå€¼åˆ—è¡¨ã€‚æ‚¨å¯ä»¥é€šè¿‡åœ¨å¯è§æ€§æ›´æ”¹æ—¶æ£€æŸ¥ä¼ é€’ç»™å›è°ƒå‡½æ•°çš„isIntersectingå±æ€§å€¼ï¼Œæ¥ç¡®å®šå¯è§æ€§çš„å˜åŒ–æ–¹å‘ï¼ˆå³ï¼Œå…ƒç´ å˜å¾—æ›´å¯è§è¿˜æ˜¯ä¸å¯è§ï¼‰IntersectionObserverEntryã€‚å¦‚æœisIntersectingä¸ºtrueï¼Œåˆ™ç›®æ ‡å…ƒç´ å·²å˜å¾—è‡³å°‘ä¸å·²é€šè¿‡çš„é˜ˆå€¼ä¸€æ ·å¯è§ã€‚å¦‚æœä¸ºfalseï¼Œåˆ™ç›®æ ‡ä¸å†åƒç»™å®šé˜ˆå€¼é‚£æ ·å¯è§ã€‚ è¦äº†è§£é˜ˆå€¼çš„å·¥ä½œåŸç†ï¼Œè¯·å°è¯•æ»šåŠ¨ä¸‹é¢çš„æ¡†ã€‚å…¶ä¸­çš„æ¯ä¸ªå½©è‰²æ¡†éƒ½ä¼šæ˜¾ç¤ºå…¶åœ¨å››ä¸ªè§’ä¸Šéƒ½å¯è§çš„ç™¾åˆ†æ¯”ï¼Œå› æ­¤æ‚¨å¯ä»¥åœ¨æ»šåŠ¨å®¹å™¨æ—¶çœ‹åˆ°è¿™äº›æ¯”ä¾‹éšæ—¶é—´çš„å˜åŒ–ã€‚æ¯ä¸ªæ¡†éƒ½æœ‰ä¸åŒçš„é˜ˆå€¼é›†ï¼š ç¬¬ä¸€ä¸ªæ¡†æœ‰ä¸€ä¸ªé’ˆå¯¹æ¯ä¸ªå¯è§åº¦ç™¾åˆ†æ¯”çš„é˜ˆå€¼ï¼›ä¹Ÿå°±æ˜¯è¯´ï¼ŒIntersectionObserver.thresholdsæ•°ç»„æ˜¯[0.00, 0.01, 0.02, ..., 0.99, 1.00]ã€‚ ç¬¬äºŒä¸ªæ¡†åªæœ‰ä¸€ä¸ªé˜ˆå€¼ï¼Œä¸º50ï¼…ã€‚ ç¬¬ä¸‰ä¸ªæ¡†çš„é˜ˆå€¼æ˜¯å¯è§æ€§çš„æ¯10ï¼…ï¼ˆ0ï¼…ï¼Œ10ï¼…ï¼Œ20ï¼…ç­‰ï¼‰ã€‚ æœ€åä¸€ä¸ªæ¡†çš„é˜ˆå€¼å„ä¸º25ï¼…ã€‚ è£å‰ªå’Œäº¤ç‚¹çŸ©å½¢ æµè§ˆå™¨æŒ‰ä»¥ä¸‹æ–¹å¼è®¡ç®—æœ€ç»ˆçš„ç›¸äº¤çŸ©å½¢ï¼šè¿™ä¸€åˆ‡éƒ½ä¸ºæ‚¨å®Œæˆï¼Œä½†æ˜¯äº†è§£è¿™äº›æ­¥éª¤æœ‰åŠ©äºæ›´å¥½åœ°å‡†ç¡®æŠŠæ¡ä½•æ—¶å‘ç”Ÿäº¤å‰ç‚¹ã€‚ é€šè¿‡è°ƒç”¨getBoundingClientRect()ç›®æ ‡ï¼Œå¯ä»¥è·å¾—ç›®æ ‡å…ƒç´ çš„è¾¹ç•ŒçŸ©å½¢ï¼ˆå³ï¼Œå®Œå…¨åŒ…å›´ç»„æˆè¯¥å…ƒç´ çš„æ¯ä¸ªç»„ä»¶çš„è¾¹ç•Œæ¡†çš„æœ€å°çŸ©å½¢ï¼‰ã€‚è¿™æ˜¯æœ€å¤§çš„ç›¸äº¤çŸ©å½¢ã€‚å…¶ä½™æ­¥éª¤å°†åˆ é™¤æ‰€æœ‰ä¸ç›¸äº¤çš„éƒ¨åˆ†ã€‚ ä»ç›®æ ‡çš„ç›´æ¥çˆ¶å—å¼€å§‹å¹¶å‘å¤–ç§»åŠ¨ï¼Œæ¯ä¸ªåŒ…å«å—çš„å‰ªè¾‘ï¼ˆå¦‚æœæœ‰ï¼‰éƒ½åº”ç”¨äºç›¸äº¤çŸ©å½¢ã€‚æ ¹æ®ä¸¤ä¸ªå—çš„äº¤é›†å’Œè¯¥overflowå±æ€§æŒ‡å®šçš„å‰ªåˆ‡æ¨¡å¼ï¼ˆå¦‚æœæœ‰ï¼‰æ¥ç¡®å®šå—çš„å‰ªåˆ‡ã€‚è®¾ç½®overflowä¸ºå…¶ä»–ä»»ä½•å€¼visibleéƒ½ä¼šå¯¼è‡´å‘ç”Ÿè£å‰ªã€‚ å¦‚æœå…¶ä¸­ä¸€ä¸ªåŒ…å«å…ƒç´ æ˜¯åµŒå¥—æµè§ˆä¸Šä¸‹æ–‡çš„æ ¹ï¼ˆä¾‹å¦‚åŒ…å«åœ¨ä¸­çš„æ–‡æ¡£ï¼‰[](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/iframe)ï¼Œåˆ™äº¤é›†çŸ©å½¢ä¼šè¢«è£å‰ªåˆ°åŒ…å«ä¸Šä¸‹æ–‡çš„è§†å£ï¼Œå¹¶ä¸”å‘ä¸Šé€’å½’é€šè¿‡å®¹å™¨ç»§ç»­è¿›è¡Œåˆ°å®¹å™¨çš„åŒ…å«å—ã€‚åˆ°è¾¾çš„æœ€é«˜å±‚ï¼Œå°†ç›¸äº¤çŸ©å½¢å‰ªåˆ‡åˆ°æ¡†æ¶çš„è§†å£ï¼Œç„¶åæ¡†æ¶çš„çˆ¶å…ƒç´ æ˜¯å‘ç›¸äº¤æ ¹é€’å½’çš„ä¸‹ä¸€ä¸ªå—ã€‚ å½“å‘ä¸Šé€’å½’åˆ°è¾¾ç›¸äº¤æ ¹æ—¶ï¼Œç”Ÿæˆçš„çŸ©å½¢å°†æ˜ å°„åˆ°ç›¸äº¤æ ¹çš„åæ ‡ç©ºé—´ã€‚ ç„¶åï¼Œé€šè¿‡ä¸æ ¹ç›¸äº¤çŸ©å½¢ç›¸äº¤æ¥æ›´æ–°ç”Ÿæˆçš„çŸ©å½¢ã€‚ æœ€åï¼Œå°†æ­¤çŸ©å½¢æ˜ å°„åˆ°ç›®æ ‡çš„åæ ‡ç©ºé—´documentã€‚ äº¤å‰å˜æ›´callbacks å½“åœ¨æ ¹å…ƒç´ ä¸­å¯è§çš„ç›®æ ‡å…ƒç´ çš„æ•°é‡è¶…è¿‡å¯è§æ€§é˜ˆå€¼ä¹‹ä¸€æ—¶ï¼Œå°†IntersectionObserveræ‰§è¡Œå¯¹è±¡çš„å›è°ƒã€‚å›è°ƒæ¥æ”¶æ‰€æœ‰IntersectionObserverEntryå¯¹è±¡çš„æ•°ç»„ä½œä¸ºè¾“å…¥ï¼Œæ¯ä¸ªè¶…è¿‡é˜ˆå€¼çš„å¯¹è±¡ä¸€ä¸ªï¼Œä»¥åŠå¯¹IntersectionObserverå¯¹è±¡æœ¬èº«çš„å¼•ç”¨ã€‚ é˜ˆå€¼åˆ—è¡¨ä¸­çš„æ¯ä¸ªæ¡ç›®éƒ½æ˜¯ä¸€ä¸ªIntersectionObserverEntryå¯¹è±¡ï¼Œå®ƒæè¿°ä¸€ä¸ªè¢«è¶…è¿‡çš„é˜ˆå€¼ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯ä¸ªæ¡ç›®éƒ½æè¿°äº†ç»™å®šå…ƒç´ ä¸­æœ‰å¤šå°‘ä¸æ ¹å…ƒç´ ç›¸äº¤ï¼Œè¯¥å…ƒç´ æ˜¯å¦è¢«è®¤ä¸ºç›¸äº¤ä»¥åŠè¿‡æ¸¡å‘ç”Ÿçš„æ–¹å‘ã€‚ ä¸‹é¢çš„ä»£ç æ®µæ˜¾ç¤ºäº†ä¸€ä¸ªå›è°ƒï¼Œè¯¥å›è°ƒä¿ç•™äº†å…ƒç´ ä»ä¸ç›¸äº¤æ ¹åˆ°ç›¸äº¤è‡³å°‘75ï¼…è¿‡æ¸¡çš„æ¬¡æ•°çš„è®¡æ•°ã€‚ 1234567891011intersectionCallback(entries) =&gt; &#123; entries.forEach(entry =&gt; &#123; if (entry.isIntersecting) &#123; let elem = entry.target; if (entry.intersectionRatio &gt;= 0.75) &#123; intersectionCounter++; &#125; &#125; &#125;);&#125; æ¥å£ IntersectionObserver Intersection Observer APIçš„ä¸»è¦æ¥å£ã€‚æä¾›ç”¨äºåˆ›å»ºå’Œç®¡ç†è§‚å¯Ÿè€…çš„æ–¹æ³•ï¼Œè¯¥è§‚å¯Ÿè€…å¯ä»¥ç›‘è§†ç›¸åŒäº¤é›†é…ç½®çš„ä»»æ„æ•°é‡çš„ç›®æ ‡å…ƒç´ ã€‚æ¯ä¸ªè§‚å¯Ÿè€…å¯ä»¥å¼‚æ­¥è§‚å¯Ÿä¸€ä¸ªæˆ–å¤šä¸ªç›®æ ‡å…ƒç´ å’Œå…±ç”¨ç¥–å…ˆå…ƒç´ ä¹‹é—´æˆ–ä¸å®ƒä»¬é¡¶å±‚çš„äº¤ç‚¹å˜åŒ–Documentçš„è§†å£ã€‚ç¥–å…ˆæˆ–è§†å£ç§°ä¸ºæ ¹ã€‚ IntersectionObserverEntry æè¿°åœ¨ç‰¹å®šè¿‡æ¸¡æ—¶åˆ»ç›®æ ‡å…ƒç´ åŠå…¶æ ¹å®¹å™¨ä¹‹é—´çš„äº¤é›†ã€‚åªèƒ½ä»¥ä¸¤ç§æ–¹å¼è·å¾—æ­¤ç±»å‹çš„å¯¹è±¡ï¼šä½œä¸ºIntersectionObserverå›è°ƒçš„è¾“å…¥ï¼Œæˆ–é€šè¿‡è°ƒç”¨IntersectionObserver.takeRecords()ã€‚ ä¸€ä¸ªç®€å•çš„ä¾‹å­ è¿™ä¸ªç®€å•çš„ç¤ºä¾‹ä½¿ç›®æ ‡å…ƒç´ åœ¨å˜å¾—æˆ–å¤šæˆ–å°‘å¯è§æ—¶æ›´æ”¹å…¶é¢œè‰²å’Œé€æ˜åº¦ã€‚åœ¨ä½¿ç”¨Intersection Observer APIçš„â€œè®¡æ—¶å…ƒç´ å¯è§æ€§â€ä¸­ï¼Œæ‚¨å¯ä»¥æ‰¾åˆ°ä¸€ä¸ªæ›´å¹¿æ³›çš„ç¤ºä¾‹ï¼Œè¯¥ç¤ºä¾‹æ˜¾ç¤ºå¦‚ä½•è®¡æ—¶ç”¨æˆ·å¯ä»¥çœ‹åˆ°ä¸€ç»„å…ƒç´ ï¼ˆä¾‹å¦‚å¹¿å‘Šï¼‰å¤šé•¿æ—¶é—´ï¼Œä»¥åŠå¦‚ä½•é€šè¿‡è®°å½•ç»Ÿè®¡ä¿¡æ¯æˆ–æ›´æ–°å…ƒç´ æ¥å¯¹è¯¥ä¿¡æ¯åšå‡ºååº”â€¦ HTML æ­¤ç¤ºä¾‹çš„HTMLéå¸¸ç®€çŸ­ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªä¸»è¦å…ƒç´ ï¼Œå³æˆ‘ä»¬å°†è¦å®šä½çš„æ¡†ï¼ˆå¸¦æœ‰creative ID &quot;box&quot;ï¼‰å’Œè¯¥æ¡†ä¸­çš„ä¸€äº›å†…å®¹ã€‚ 12345&lt;div id=&quot;box&quot;&gt; &lt;div class=&quot;vertical&quot;&gt; Welcome to &lt;strong&gt;The Box!&lt;/strong&gt; &lt;/div&gt;&lt;/div&gt; CSS å°±æœ¬ç¤ºä¾‹è€Œè¨€ï¼ŒCSSå¹¶ä¸æ˜¯ååˆ†é‡è¦ã€‚å®ƒå¯¹å…ƒç´ è¿›è¡Œäº†å¸ƒå±€ï¼Œå¹¶ç¡®å®šbackground-colorand borderå±æ€§å¯ä»¥å‚ä¸CSSè¿‡æ¸¡ï¼Œå½“å…ƒç´ æˆ–å¤šæˆ–å°‘è¢«é®ç›–æ—¶ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨å®ƒæ¥å½±å“å…ƒç´ çš„æ›´æ”¹ã€‚ 12345678910111213141516171819202122232425#box &#123; background-color: rgba(40, 40, 190, 255); border: 4px solid rgb(20, 20, 120); transition: background-color 1s, border 1s; width: 350px; height: 350px; display: flex; align-items: center; justify-content: center; padding: 20px;&#125;.vertical &#123; color: white; font: 32px &quot;Arial&quot;;&#125;.extra &#123; width: 350px; height: 350px; margin-top: 10px; border: 4px solid rgb(20, 20, 120); text-align: center; padding: 20px;&#125; JavaScript æœ€åï¼Œè®©æˆ‘ä»¬çœ‹ä¸€ä¸‹ä½¿ç”¨Intersection Observer APIè¿›è¡Œäº‹æƒ…çš„JavaScriptä»£ç ã€‚ é…ç½® é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å‡†å¤‡ä¸€äº›å˜é‡å¹¶å®‰è£…è§‚å¯Ÿå™¨ã€‚ 12345678910111213const numSteps = 20.0;let boxElement;let prevRatio = 0.0;let increasingColor = &quot;rgba(40, 40, 190, ratio)&quot;;let decreasingColor = &quot;rgba(190, 40, 40, ratio)&quot;;// Set things upwindow.addEventListener(&quot;load&quot;, (event) =&gt; &#123; boxElement = document.querySelector(&quot;#box&quot;); createObserver();&#125;, false); æˆ‘ä»¬åœ¨æ­¤å¤„è®¾ç½®çš„å¸¸é‡å’Œå˜é‡æ˜¯ï¼š numSteps ä¸€ä¸ªå¸¸æ•°ï¼ŒæŒ‡ç¤ºæˆ‘ä»¬å¸Œæœ›åœ¨0.0å’Œ1.0çš„å¯è§æ€§æ¯”ç‡ä¹‹é—´å…·æœ‰å¤šå°‘ä¸ªé˜ˆå€¼ã€‚ prevRatio æ­¤å˜é‡å°†ç”¨äºè®°å½•ä¸Šæ¬¡è¶…è¿‡é˜ˆå€¼æ—¶å¯è§æ€§æ¯”ç‡ã€‚è¿™å°†è®©æˆ‘ä»¬å¼„æ¸…æ¥šç›®æ ‡å…ƒç´ æ˜¯å¦å˜å¾—è¶Šæ¥è¶Šæ˜æ˜¾ã€‚ increasingColor å®šä¹‰å¯è§æ€§æ¯”ç‡å¢åŠ æ—¶å°†åº”ç”¨äºç›®æ ‡å…ƒç´ çš„é¢œè‰²çš„å­—ç¬¦ä¸²ã€‚è¯¥å­—ç¬¦ä¸²ä¸­çš„â€œæ¯”ç‡â€ä¸€è¯å°†æ›¿æ¢ä¸ºç›®æ ‡çš„å½“å‰å¯è§æ€§æ¯”ç‡ï¼Œå› æ­¤è¯¥å…ƒç´ ä¸ä»…ä¼šæ”¹å˜é¢œè‰²ï¼Œè€Œä¸”ä¼šå˜å¾—è¶Šæ¥è¶Šä¸é€æ˜ï¼Œå› ä¸ºå®ƒå˜å¾—è¶Šæ¥è¶Šæ¨¡ç³Šã€‚ decreasingColor åŒæ ·ï¼Œè¿™æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå®šä¹‰äº†å¯è§ç‡é™ä½æ—¶å°†åº”ç”¨çš„é¢œè‰²ã€‚ æˆ‘ä»¬å‘¼åWindow.addEventListener()å¼€å§‹æ”¶å¬loadäº‹ä»¶ã€‚ä¸€æ—¦é¡µé¢åŠ è½½å®Œæˆåï¼Œæˆ‘ä»¬å¾—åˆ°çš„å…ƒç´ çš„å¼•ç”¨ä¸ID &quot;box&quot;ä½¿ç”¨querySelector()ï¼Œç„¶åè°ƒç”¨createObserver()æˆ‘ä»¬å°†åœ¨ç¨ååˆ›å»ºæ¥å¤„ç†å»ºç­‘æ–¹æ³•å’Œå®‰è£…çš„äº¤å‰ç‚¹è§‚æµ‹ã€‚ åˆ›å»ºç›¸äº¤è§‚å¯Ÿå™¨ createObserver()ä¸€æ—¦é¡µé¢åŠ è½½å®Œæˆï¼Œä¾¿ä¼šè°ƒç”¨è¯¥æ–¹æ³•ä»¥å¤„ç†å®é™…åˆ›å»ºæ–°å¯¹è±¡IntersectionObserverå¹¶å¼€å§‹è§‚å¯Ÿç›®æ ‡å…ƒç´ çš„è¿‡ç¨‹ã€‚ 123456789101112function createObserver() &#123; let observer; let options = &#123; root: null, rootMargin: &quot;0px&quot;, threshold: buildThresholdList() &#125;; observer = new IntersectionObserver(handleIntersect, options); observer.observe(boxElement);&#125; é¦–å…ˆä»è®¾ç½®ä¸€ä¸ªoptionsåŒ…å«è§‚å¯Ÿè€…è®¾ç½®çš„å¯¹è±¡å¼€å§‹ã€‚æˆ‘ä»¬è¦ç•™æ„çš„ç›®æ ‡å…ƒç´ ç›¸å¯¹äºæ–‡æ¡£çš„è§†å£çš„å¯è§æ€§çš„å˜åŒ–ï¼Œæ‰€ä»¥rootæ˜¯nullã€‚æˆ‘ä»¬ä¸éœ€è¦è¾¹è·ï¼Œå› æ­¤è¾¹è·åç§»é‡rootMarginæŒ‡å®šä¸ºâ€œ 0pxâ€ã€‚è¿™ä½¿è§‚å¯Ÿè€…å¯ä»¥è§‚å¯Ÿç›®æ ‡å…ƒç´ çš„è¾¹ç•Œä¸è§†å£è¾¹ç•Œä¹‹é—´çš„äº¤é›†å¤„çš„å˜åŒ–ï¼Œè€Œæ— éœ€å¢åŠ ï¼ˆæˆ–å‡å»ï¼‰ä»»ä½•ç©ºé—´ã€‚ å¯è§åº¦é˜ˆå€¼åˆ—è¡¨thresholdç”±å‡½æ•°æ„é€ buildThresholdList()ã€‚åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œä»¥ç¼–ç¨‹æ–¹å¼æ„å»ºé˜ˆå€¼åˆ—è¡¨ï¼Œå› ä¸ºå­˜åœ¨è®¸å¤šé˜ˆå€¼åˆ—è¡¨ï¼Œå¹¶ä¸”è¯¥æ•°é‡æ—¨åœ¨è°ƒæ•´ã€‚ ä¸€æ—¦optionså‡†å¤‡å¥½äº†ï¼Œæˆ‘ä»¬åˆ›å»ºäº†æ–°çš„è§‚å¯Ÿå‘˜ï¼Œè°ƒç”¨IntersectionObserver()æ„é€ å‡½æ•°ï¼ŒæŒ‡å®šä¸€ä¸ªå‡½æ•°è¢«è°ƒç”¨æ—¶ï¼Œè·¯å£ç©¿è¶Šæˆ‘ä»¬çš„å…¶ä¸­ä¸€ä¸ªé˜ˆå€¼ï¼ŒhandleIntersect()å’Œæˆ‘ä»¬ä¸€ç»„é€‰é¡¹ã€‚ç„¶åobserve()ï¼Œæˆ‘ä»¬è°ƒç”¨è¿”å›çš„è§‚å¯Ÿè€…ï¼Œå°†æ‰€éœ€çš„ç›®æ ‡å…ƒç´ ä¼ é€’ç»™å®ƒã€‚ å¦‚æœæˆ‘ä»¬æ„¿æ„çš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©é€šè¿‡ç›‘è§†observer.observe()æ¯ä¸ªå…ƒç´ æ¥ç›‘è§†å¤šä¸ªå…ƒç´ æ˜¯å¦ç›¸å¯¹äºè§†å£ç›¸äº¤ã€‚ å»ºç«‹é˜ˆå€¼æ¯”ç‡æ•°ç»„ buildThresholdList()æ„å»ºé˜ˆå€¼åˆ—è¡¨çš„å‡½æ•°å¦‚ä¸‹æ‰€ç¤ºï¼š 123456789101112function buildThresholdList() &#123; let thresholds = []; let numSteps = 20; for (let i=1.0; i&lt;=numSteps; i++) &#123; let ratio = i/numSteps; thresholds.push(ratio); &#125; thresholds.push(0); return thresholds;&#125; è¿™å°†æ„å»ºé˜ˆå€¼æ•°ç»„-é€šè¿‡å°†å€¼ä»‹äº1å’Œä¹‹é—´çš„æ¯ä¸ªæ•´æ•°æ¨i/numStepså…¥thresholdsæ•°ç»„ï¼Œæ¯ä¸ªé˜ˆå€¼ä¹‹é—´çš„æ¯”ç‡ä¸º0.0å’Œ1.0 iä¹‹é—´numStepsã€‚å®ƒè¿˜æ¨0ä»¥åŒ…æ‹¬è¯¥å€¼ã€‚ç»™å®šé»˜è®¤å€¼numStepsï¼ˆ20ï¼‰ï¼Œç»“æœæ˜¯ä»¥ä¸‹é˜ˆå€¼åˆ—è¡¨ï¼š ï¼ƒ Ratio ï¼ƒ Ratio 1ä¸ª 0.05 11 0.55 2 0.1 12 0.6 3 0.15 13 0.65 4 0.2 14 0.7 5 0.25 15 0.75 6 0.3 16 0.8 7 0.35 17 0.85 8 0.4 18 0.9 9 0.45 19 0.95 10 0.5 20 1.0 å½“ç„¶ï¼Œæˆ‘ä»¬å¯ä»¥å°†é˜ˆå€¼æ•°ç»„ç¡¬ç¼–ç åˆ°æˆ‘ä»¬çš„ä»£ç ä¸­ï¼Œè€Œè¿™é€šå¸¸æ˜¯æ‚¨æœ€ç»ˆè¦åšçš„ã€‚ä½†æ˜¯ï¼Œæ­¤ç¤ºä¾‹ä¸ºæ·»åŠ é…ç½®æ§ä»¶ä»¥è°ƒæ•´ç²’åº¦æä¾›äº†ç©ºé—´ã€‚ å¤„ç†äº¤é›†å˜æ›´ å½“æµè§ˆå™¨æ£€æµ‹åˆ°ç›®æ ‡å…ƒç´ ï¼ˆåœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ä¸ºIDçš„å…ƒç´ &quot;box&quot;ï¼‰å·²ç»è¢«å…¬å¼€æˆ–æ¨¡ç³Šï¼Œä»¥è‡´å…¶å¯è§æ€§æ¯”ç‡è¶…è¿‡åˆ—è¡¨ä¸­çš„é˜ˆå€¼ä¹‹ä¸€æ—¶ï¼Œå®ƒå°†è°ƒç”¨å¤„ç†ç¨‹åºå‡½æ•°handleIntersect()ï¼š 1234567891011function handleIntersect(entries, observer) &#123; entries.forEach((entry) =&gt; &#123; if (entry.intersectionRatio &gt; prevRatio) &#123; entry.target.style.backgroundColor = increasingColor.replace(\"ratio\", entry.intersectionRatio); &#125; else &#123; entry.target.style.backgroundColor = decreasingColor.replace(\"ratio\", entry.intersectionRatio); &#125; prevRatio = entry.intersectionRatio; &#125;);&#125; å¯¹äºIntersectionObserverEntryåˆ—è¡¨ä¸­çš„æ¯ä¸ªentriesæ¡ç›®ï¼Œæˆ‘ä»¬æŸ¥çœ‹æ¡ç›®intersectionRatioæ˜¯å¦åœ¨ä¸Šå‡ï¼›å¦‚æœæ˜¯ï¼Œæˆ‘ä»¬å°†ç›®æ ‡çš„è®¾ç½®background-colorä¸ºä¸­çš„å­—ç¬¦ä¸²increasingColorï¼ˆè¯·è®°ä½ï¼Œå®ƒæ˜¯&quot;rgba(40, 40, 190, ratio)&quot;ï¼‰ï¼Œå°†å•è¯â€œ ratioâ€æ›¿æ¢ä¸ºæ¡ç›®çš„intersectionRatioã€‚ç»“æœï¼šä¸ä»…é¢œè‰²æ”¹å˜äº†ï¼Œç›®æ ‡å…ƒç´ çš„é€æ˜åº¦ä¹Ÿæ”¹å˜äº†ï¼›å½“äº¤å‰æ¯”ä¾‹é™ä½æ—¶ï¼ŒèƒŒæ™¯è‰²çš„Alphaå€¼éšä¹‹é™ä½ï¼Œä»è€Œä½¿å…ƒç´ æ›´é€æ˜ã€‚ åŒæ ·ï¼Œå¦‚æœintersectionRatioä¸‹é™ï¼Œåˆ™ä½¿ç”¨å­—ç¬¦ä¸²ï¼ŒdecreasingColorå¹¶intersectionRatioåœ¨è®¾ç½®ç›®æ ‡å…ƒç´ çš„ä¹‹å‰å°†å…¶ä¸­çš„â€œæ¯”ç‡â€ä¸€è¯æ›¿æ¢ä¸ºbackground-colorã€‚ æœ€åï¼Œä¸ºäº†è·Ÿè¸ªäº¤å‰æ¯”ç‡æ˜¯ä¸Šå‡è¿˜æ˜¯ä¸‹é™ï¼Œæˆ‘ä»¬è®°ä½å˜é‡ä¸­çš„å½“å‰æ¯”ç‡prevRatioã€‚ æµè§ˆå™¨å…¼å®¹æ€§ Update compatibility data on GitHub Desktop Mobile Chrome Edge Firefox Internet Explorer Opera Safari Android webview Chrome for Android Firefox for Android Opera for Android Safari on iOS Samsung Internet IntersectionObserverExperimental Full support51 Full support15 Full support55Open No supportNo Full supportYes Full support12.1 Full support51 Full support51 ? ? Full support12.2 Full support5.0 IntersectionObserver() constructorExperimental Full support51 Full support15 Full support55Open No supportNo ? Full support12.1 Full support51 Full support51 ? ? Full support12.2 Full support5.0 disconnectExperimental Full support51 Full support15NotesOpen Full support55Open No supportNo Full supportYes ? Full support51 Full support51 ? ? ? Full support5.0 observeExperimental Full support51 Full support15 Full support55Open No supportNo Full supportYes Full support12.1 Full support51 Full support51 ? ? Full support12.2 Full support5.0 rootExperimental Full support51 Full support15 Full support55Open No supportNo Full supportYes Full support12.1 Full support51 Full support51 ? ? Full support12.2 Full support5.0 rootMarginExperimental Full support51 Full support15 Full support55Open No supportNo Full supportYes Full support12.1NotesOpen Full support51 Full support51 ? ? Full support12.2NotesOpen Full support5.0 takeRecordsExperimental Full support51 Full support15NotesOpen Full support55Open No supportNo Full supportYes ? Full support51 Full support51 ? ? ? Full support5.0 thresholdsExperimental Full support51 Full support15 Full support55Open No supportNo Full supportYes Full support12.1 Full support51 Full support51 ? ? Full support12.2 Full support5.0 unobserveExperimental Full support51 Full support15NotesOpen Full support55Open No supportNo Full supportYes Full support12.1 Full support51 Full support51 ? ? Full support12.2 Full support5.0","categories":[{"name":"JavaScript","slug":"JavaScript","permalink":"https://wzes.github.io/categories/JavaScript/"}],"tags":[{"name":"JavaScript","slug":"JavaScript","permalink":"https://wzes.github.io/tags/JavaScript/"}]},{"title":"iScroll æºç å­¦ä¹ ","slug":"JavaScript/iScroll","date":"2019-10-23T10:30:16.000Z","updated":"2019-10-24T06:15:03.500Z","comments":true,"path":"2019/10/23/JavaScript/iScroll/","link":"","permalink":"https://wzes.github.io/2019/10/23/JavaScript/iScroll/","excerpt":"","text":"å‰è¨€ å¼ºå¤§çš„ iScroll å•Šï¼ŒåŠŸèƒ½çš„ç¡®å¤šï¼Œä½†æˆ‘åªæƒ³çœ‹çœ‹ä½ çš„ flinger æ»‘åŠ¨å¤„ç†çš„ç²¾é«“ï¼æ„Ÿè§‰ iscroll çš„æ»‘åŠ¨å¤„ç†çš„è¿˜å¯ä»¥å§ï¼Œè™½ç„¶æ¯”ä¸ä¸Šç³»ç»Ÿçš„ scrollï¼Œä½†ä¹Ÿä¸è‡³äºå¾ˆéš¾å—ï¼Œå­¦ä¼šäº†è¿™æ‹›ï¼Œå¯ä»¥å‡ºå»å¹å¹ç‰›ï¼ˆæ‹›æ‘‡æ’éª—ï¼‰äº†ã€‚ é¡»çŸ¥ é€šå¸¸å¦‚æœæˆ‘ä»¬ç»™å®¹å™¨è®¾ç½®ä¸€ä¸ªé«˜åº¦ï¼Œå¦‚æœå­èŠ‚ç‚¹çš„é«˜åº¦è¶…å‡ºäº†çˆ¶å®¹å™¨çš„é«˜åº¦ï¼Œé‚£ä¹ˆå†…å®¹å°±å¯ä»¥è¿›è¡Œæ»šåŠ¨ï¼ŒåŸå› åœ¨äº overflow å±æ€§é»˜è®¤ä¸º autoï¼Œå½“ç„¶æœ€å¥½å°†çˆ¶å®¹å™¨è®¾ç½®ä¸º overflow: scrollï¼Œå­å†…å®¹å°±å¯ä»¥è¿›è¡Œæ»šåŠ¨ã€‚è¿˜å¯ä»¥å•ç‹¬è®¾ç½® X æˆ– Y è½´çš„æ»šåŠ¨ï¼Œoverflow-x:scroll æˆ– overflow-y:scrollï¼Œå¦‚æœä¸æƒ³è®©å†…å®¹æ»šåŠ¨ï¼Œåˆ™è®¾ç½® overflow: hidden æ˜¯ä»€ä¹ˆ iScroll æ˜¯ä¸€ç§é«˜æ€§èƒ½ï¼Œå ç”¨ç©ºé—´å°ï¼Œæ— ä¾èµ–çš„å¤šå¹³å° javascript æ»šåŠ¨å™¨ã€‚ å®ƒé€‚ç”¨äºå°å¼æœºï¼Œç§»åŠ¨ç”µè§†å’Œæ™ºèƒ½ç”µè§†ã€‚å®ƒå·²é’ˆå¯¹æ€§èƒ½å’Œå°ºå¯¸è¿›è¡Œäº†ä¼˜åŒ–ï¼Œä»¥åœ¨ç°ä»£å’Œæ—§è®¾å¤‡ä¸Šæä¾›æœ€å¹³æ»‘çš„ç»“æœã€‚ iScrollä¸ä»…å¯ä»¥æ»šåŠ¨ã€‚å®ƒå¯ä»¥å¤„ç†éœ€è¦é€šè¿‡ç”¨æˆ·äº¤äº’ç§»åŠ¨çš„ä»»ä½•å…ƒç´ ã€‚å®ƒä¸ºæ‚¨çš„é¡¹ç›®æ·»åŠ äº†æ»šåŠ¨ï¼Œç¼©æ”¾ï¼Œå¹³ç§»ï¼Œæ— é™æ»šåŠ¨ï¼Œè§†å·®æ»šåŠ¨ï¼Œè½®æ’­ï¼Œå¹¶ä¸”ä»…ä»¥4kbçš„é€Ÿåº¦åšåˆ°äº†è¿™ä¸€ç‚¹ã€‚ç»™å®ƒæ‰«å¸šï¼Œå®ƒä¹Ÿä¼šæ‰“æ‰«ä½ çš„åŠå…¬å®¤ã€‚ å³ä½¿åœ¨æœ¬æœºæ»šåŠ¨è¶³ä»¥èƒœä»»çš„å¹³å°ä¸Šï¼ŒiScrollä¹Ÿä¼šæ·»åŠ åŸæœ¬æ— æ³•å®ç°çš„åŠŸèƒ½ã€‚ç‰¹åˆ«ï¼š å³ä½¿åœ¨åŠ¨é‡æœŸé—´ï¼Œä¹Ÿå¯ä»¥å¯¹æ»šåŠ¨ä½ç½®è¿›è¡Œç²¾ç»†æ§åˆ¶ã€‚æ‚¨å§‹ç»ˆå¯ä»¥è·å–å¹¶è®¾ç½®æ»šåŠ¨æ¡çš„xï¼Œyåæ ‡ã€‚ å¯ä»¥ä½¿ç”¨ç”¨æˆ·å®šä¹‰çš„ç¼“åŠ¨åŠŸèƒ½ï¼ˆå¼¹è·³ï¼Œå¼¹æ€§ï¼Œåé€€â€¦ï¼‰è‡ªå®šä¹‰åŠ¨ç”»ã€‚ æ‚¨å¯ä»¥è½»æ¾åœ°æŒ‚é’©åˆ°å¤§é‡è‡ªå®šä¹‰äº‹ä»¶ï¼ˆonBeforeScrollStartï¼ŒonScrollStartï¼ŒonScrollï¼ŒonScrollEndï¼Œflickç­‰ï¼‰ã€‚ å¼€ç®±å³ç”¨çš„å¤šå¹³å°æ”¯æŒã€‚ä»è¾ƒæ—§çš„Androidè®¾å¤‡åˆ°æœ€æ–°çš„iPhoneï¼Œä»Chromeåˆ°Internet Explorerã€‚ Get started å‡è®¾æˆ‘ä»¬çš„å…ƒç´ é•¿è¿™ä¸ªæ ·å­ 1234567&lt;div id=&quot;wrapper&quot;&gt; &lt;ul&gt; &lt;li&gt;...&lt;/li&gt; &lt;li&gt;...&lt;/li&gt; ... &lt;/ul&gt;&lt;/div&gt; é‚£æˆ‘ä»¬åªéœ€è¦åœ¨è„šæœ¬ä¸­ä½¿ç”¨ new IScroll å³å¯ 1myScroll = new IScroll(&apos;#wrapper&apos;); å½“ç„¶ï¼Œä»–è¿˜æœ‰å¾ˆå¤šå±æ€§ï¼ˆåªå¯æ„ä¼šï¼‰ 12345678910111213141516171819this.options = &#123; disablePointer : !utils.hasPointer, disableTouch : utils.hasPointer || !utils.hasTouch, disableMouse : utils.hasPointer || utils.hasTouch, startX: 0, // å¼€å§‹æ»šåŠ¨çš„å€¼ startY: 0, scrollY: true, directionLockThreshold: 5, momentum: true, // å¯¹å…¶ Native çš„ flinger(æ‰‹æŒ‡æ”¾å¼€åè¿˜ä¼šç»§ç»­æ»šåŠ¨ä¸€æ®µè·ç¦») bounce: true, // æ»šåŠ¨å›å¼¹ bounceTime: 600, bounceEasing: &apos;&apos;, preventDefault: true, preventDefaultException: &#123; tagName: /^(INPUT|TEXTAREA|BUTTON|SELECT)$/ &#125;, HWCompositing: true, useTransition: true, useTransform: true, bindToWrapper: typeof window.onmousedown === &quot;undefined&quot;&#125; åŸç†æ¦‚æ‹¬ iScroll å½“ç„¶æ²¡æœ‰ä½¿ç”¨ç³»ç»Ÿçš„ scrollï¼ŒåŸå› æœ‰å¾ˆå¤šç‚¹ï¼Œä¸Šé¢ä¹Ÿæåˆ°è¿‡ã€‚ iScroll ä½¿ç”¨äº† transform: translate(px, px)æ¥å®ç°æ»šåŠ¨ï¼Œå®Œå…¨æ˜¯é€šè¿‡è‡ªå·±è®¡ç®—æ¥å®ç°çš„ï¼Œå½“ç„¶ï¼Œå¦‚æœç³»ç»Ÿæ”¯æŒ transationï¼Œé‚£ä¹ˆ iScroll çš„æ¾æ‰‹åæ»šåŠ¨å°†å€ŸåŠ© transitionTimingFunctionï¼Œå¦åˆ™å°±è‡ªå®šä¹‰åŠ¨ç”»ï¼Œå®Œæˆå¹³æ»‘æ»šåŠ¨ã€‚ æºç è§£æ å…¥å£ IScroll æ˜¯ä¸€ä¸ªæ–¹æ³•ï¼Œè°ƒç”¨äº†ä»¥åä¼šåˆ›å»ºå±æ€§ï¼Œè¿›è¡Œåˆå§‹åŒ–ï¼Œå…¶ä¸­ this.x å’Œ this.y åˆ†åˆ«è®°å½•äº†x è½´ ä¸ y è½´çš„æ»šåŠ¨è·ç¦»ã€‚ 1234567891011121314151617181920function IScroll (el, options) &#123; this.wrapper = typeof el == &apos;string&apos; ? document.querySelector(el) : el; this.scroller = this.wrapper.children[0]; this.scrollerStyle = this.scroller.style; // cache style for better performance // æ­¤å¤„çœç•¥äº† this.options çš„èµ‹å€¼ // Some defaults this.x = 0; this.y = 0; this.directionX = 0; this.directionY = 0; this._events = &#123;&#125;; this._init(); this.refresh(); this.scrollTo(this.options.startX, this.options.startY); this.enable();&#125; åˆå§‹åŒ–äº‹ä»¶ åœ¨ this._init(); ä¸­åˆå§‹åŒ–äº†äº‹ä»¶ç›‘å¬ï¼Œåœ¨æ‰‹æœºç«¯ä¸»è¦æ˜¯ touch å¼€å¤´çš„äº‹ä»¶ï¼ŒPC ç«¯ä¸»è¦æ˜¯ mouse äº‹ä»¶ï¼Œpointer æ˜¯æŒ‡é’ˆäº‹ä»¶ï¼Œæ­¤å¤–ï¼Œè¿˜ä¼šç›‘å¬ transitionend äº‹ä»¶ï¼Œç”¨äºæ»šåŠ¨ç»“æŸäº‹ä»¶çš„ç›‘å¬ã€‚ 12345678910111213141516171819202122232425262728293031323334353637_initEvents: function (remove) &#123; var eventType = remove ? utils.removeEvent : utils.addEvent, target = this.options.bindToWrapper ? this.wrapper : window; eventType(window, &apos;orientationchange&apos;, this); eventType(window, &apos;resize&apos;, this); if ( this.options.click ) &#123; eventType(this.wrapper, &apos;click&apos;, this, true); &#125; if ( !this.options.disableMouse ) &#123; eventType(this.wrapper, &apos;mousedown&apos;, this); eventType(target, &apos;mousemove&apos;, this); eventType(target, &apos;mousecancel&apos;, this); eventType(target, &apos;mouseup&apos;, this); &#125; if ( utils.hasPointer &amp;&amp; !this.options.disablePointer ) &#123; eventType(this.wrapper, utils.prefixPointerEvent(&apos;pointerdown&apos;), this); eventType(target, utils.prefixPointerEvent(&apos;pointermove&apos;), this); eventType(target, utils.prefixPointerEvent(&apos;pointercancel&apos;), this); eventType(target, utils.prefixPointerEvent(&apos;pointerup&apos;), this); &#125; if ( utils.hasTouch &amp;&amp; !this.options.disableTouch ) &#123; eventType(this.wrapper, &apos;touchstart&apos;, this); eventType(target, &apos;touchmove&apos;, this); eventType(target, &apos;touchcancel&apos;, this); eventType(target, &apos;touchend&apos;, this); &#125; eventType(this.scroller, &apos;transitionend&apos;, this); eventType(this.scroller, &apos;webkitTransitionEnd&apos;, this); eventType(this.scroller, &apos;oTransitionEnd&apos;, this); eventType(this.scroller, &apos;MSTransitionEnd&apos;, this); &#125;, åˆå§‹åŒ–å˜é‡ è®¡ç®—å®¹å™¨é«˜åº¦ã€å®½åº¦ï¼Œæ»šåŠ¨å†…å®¹é«˜åº¦ã€å®½åº¦ï¼Œæœ€å¤§æ»šåŠ¨è·ç¦»ï¼ˆXè½´ï¼ŒYè½´ï¼‰ç­‰ç­‰ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253 refresh: function () &#123; utils.getRect(this.wrapper); // Force reflow this.wrapperWidth = this.wrapper.clientWidth; this.wrapperHeight = this.wrapper.clientHeight; var rect = utils.getRect(this.scroller);/* REPLACE START: refresh */ this.scrollerWidth = rect.width; this.scrollerHeight = rect.height; this.maxScrollX = this.wrapperWidth - this.scrollerWidth; this.maxScrollY = this.wrapperHeight - this.scrollerHeight;/* REPLACE END: refresh */ this.hasHorizontalScroll = this.options.scrollX &amp;&amp; this.maxScrollX &lt; 0; this.hasVerticalScroll = this.options.scrollY &amp;&amp; this.maxScrollY &lt; 0; if ( !this.hasHorizontalScroll ) &#123; this.maxScrollX = 0; this.scrollerWidth = this.wrapperWidth; &#125; if ( !this.hasVerticalScroll ) &#123; this.maxScrollY = 0; this.scrollerHeight = this.wrapperHeight; &#125; this.endTime = 0; this.directionX = 0; this.directionY = 0; if(utils.hasPointer &amp;&amp; !this.options.disablePointer) &#123; // The wrapper should have `touchAction` property for using pointerEvent. this.wrapper.style[utils.style.touchAction] = utils.getTouchAction(this.options.eventPassthrough, true); // case. not support &apos;pinch-zoom&apos; // https://github.com/cubiq/iscroll/issues/1118#issuecomment-270057583 if (!this.wrapper.style[utils.style.touchAction]) &#123; this.wrapper.style[utils.style.touchAction] = utils.getTouchAction(this.options.eventPassthrough, false); &#125; &#125; this.wrapperOffset = utils.offset(this.wrapper); this._execEvent(&apos;refresh&apos;); this.resetPosition();// INSERT POINT: _refresh &#125;, æ»šåŠ¨å‡½æ•° ç»™å®šä¸€ä¸ª xï¼Œyï¼Œæ»šåŠ¨æ—¶é—´ timeï¼Œæ»šåŠ¨æ•ˆæœ easingï¼› å¦‚æœ time ä¸º 0ï¼Œåˆ™ä¸ºç¬æ—¶æ»šåŠ¨ï¼Œä½¿ç”¨ _translate æ”¹å˜ä½ç½®ï¼Œå¦‚æœç¯å¢ƒæ”¯æŒ transition , é‚£ä¹ˆå°†ä½¿ç”¨ transition å±æ€§å®ç°åŠ¨ç”»ã€‚ å¦‚æœæµè§ˆå™¨ä¸æ”¯æŒ transitionï¼Œtime åˆä¸ä¸º 0ï¼Œé‚£ä¹ˆåˆ™è‡ªå®šä¹‰åŠ¨ç”»å®ç°æ»šåŠ¨ 123456789101112131415scrollTo: function (x, y, time, easing) &#123; easing = easing || utils.ease.circular; this.isInTransition = this.options.useTransition &amp;&amp; time &gt; 0; var transitionType = this.options.useTransition &amp;&amp; easing.style; if ( !time || transitionType ) &#123; if(transitionType) &#123; this._transitionTimingFunction(easing.style); this._transitionTime(time); &#125; this._translate(x, y); &#125; else &#123; this._animate(x, y, time, easing.fn); &#125;&#125;, ç§»åŠ¨å®ç° å¦‚æœå…ƒç´ æ”¯æŒ transform ç»™å…ƒç´ èµ‹å€¼ transform å±æ€§å³å¯ï¼Œå¦åˆ™ä½¿ç”¨ left å±æ€§ã€‚ç„¶åå°† x , y è®¾ç½®ä¸ºç›®æ ‡ä½ç½®ï¼Œæ—¢ç›®å‰æ»šåŠ¨ä½ç½®ï¼Œé€šå¸¸éƒ½æ˜¯ä¸ºè´Ÿå€¼ã€‚ 12345678910111213141516171819202122 _translate: function (x, y) &#123; if ( this.options.useTransform ) &#123;/* REPLACE START: _translate */ this.scrollerStyle[utils.style.transform] = &apos;translate(&apos; + x + &apos;px,&apos; + y + &apos;px)&apos; + this.translateZ;/* REPLACE END: _translate */ &#125; else &#123; x = Math.round(x); y = Math.round(y); this.scrollerStyle.left = x + &apos;px&apos;; this.scrollerStyle.top = y + &apos;px&apos;; &#125; this.x = x; this.y = y;// INSERT POINT: _translate &#125;, è§¦æ‘¸äº‹ä»¶å¤„ç† Core ä¾¿äºåˆ†æï¼Œæˆ‘åªè€ƒè™‘yæ–¹å‘çš„æ»‘åŠ¨ï¼Œxæ–¹å‘åŒç†ï¼ˆä¼šåˆ é™¤æ‰ x æ–¹å‘çš„ä»£ç ï¼‰ startï¼ˆmovestartï¼Œmousedownâ€¦ï¼‰ å…¶ä¸­æ¯”è¾ƒé‡è¦çš„æ˜¯ startYï¼ŒstartTimeï¼Œè®°å½•ä¸‹ç›®å‰æ»šåŠ¨ä½ç½®ï¼Œæ»šåŠ¨æ—¶åˆ» pointY åˆ™æ˜¯ç‚¹å‡»ä½ç½® 1234567891011121314151617181920212223242526272829_start: function (e) &#123; var point = e.touches ? e.touches[0] : e, pos; this.initiated = utils.eventType[e.type]; this.moved = false; this.distY = 0; this.directionY = 0; this.directionLocked = 0; this.startTime = utils.getTime(); if ( this.options.useTransition &amp;&amp; this.isInTransition ) &#123; this._transitionTime(); this.isInTransition = false; pos = this.getComputedPosition(); this._translate(Math.round(pos.x), Math.round(pos.y)); this._execEvent(&apos;scrollEnd&apos;); &#125; else if ( !this.options.useTransition &amp;&amp; this.isAnimating ) &#123; this.isAnimating = false; this._execEvent(&apos;scrollEnd&apos;); &#125; this.startY = this.y; this.absStartY = this.y; this.pointY = point.pageY; this._execEvent(&apos;beforeScrollStart&apos;);&#125;, move é€šå¸¸ï¼Œæ‰‹æŒ‡ä¸æ¾å¼€ï¼Œå±å¹•æ»šåŠ¨æ˜¯è·Ÿéšæ‰‹æŒ‡ç§»åŠ¨çš„ï¼Œæ‰‹æŒ‡æ€ä¹ˆç§»åŠ¨ï¼Œå±å¹•å°±æ€ä¹ˆç§»åŠ¨ã€‚ é¦–å…ˆä¼šåˆ¤æ–­è¯¥æ¬¡æ»‘åŠ¨æ˜¯å¦æœ‰æ•ˆï¼Œç„¶åé”å®šæ»‘åŠ¨æ–¹å‘ï¼Œæœ€åè®¡ç®— newYï¼Œéœ€è¦æ»‘åŠ¨çš„ä½ç½® newY = this.y + deltaY æ˜¯é€šè¿‡ delta æ¥è®¡ç®—çš„ã€‚ç„¶åä½¿ç”¨ translate å‡½æ•°ç§»åŠ¨è¿›è¡Œç¬æ—¶ç§»åŠ¨ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172 _move: function (e) &#123; var point = e.touches ? e.touches[0] : e, deltaY = point.pageY - this.pointY, timestamp = utils.getTime(), newY, absDistY; this.pointY = point.pageY; this.distY += deltaY; absDistY = Math.abs(this.distY); // We need to move at least 10 pixels for the scrolling to initiate if ( timestamp - this.endTime &gt; 300 &amp;&amp; (absDistX &lt; 10 &amp;&amp; absDistY &lt; 10) ) &#123; return; &#125; // If you are scrolling in one direction lock the other if ( !this.directionLocked &amp;&amp; !this.options.freeScroll ) &#123; if ( absDistX &gt; absDistY + this.options.directionLockThreshold ) &#123; this.directionLocked = &apos;h&apos;; // lock horizontally &#125; else if ( absDistY &gt;= absDistX + this.options.directionLockThreshold ) &#123; this.directionLocked = &apos;v&apos;; // lock vertically &#125; else &#123; this.directionLocked = &apos;n&apos;; // no lock &#125; &#125; if ( this.directionLocked == &apos;h&apos; ) &#123; if ( this.options.eventPassthrough == &apos;vertical&apos; ) &#123; e.preventDefault(); &#125; else if ( this.options.eventPassthrough == &apos;horizontal&apos; ) &#123; this.initiated = false; return; &#125; deltaY = 0; &#125; else if ( this.directionLocked == &apos;v&apos; ) &#123; if ( this.options.eventPassthrough == &apos;horizontal&apos; ) &#123; e.preventDefault(); &#125; else if ( this.options.eventPassthrough == &apos;vertical&apos; ) &#123; this.initiated = false; return; &#125; deltaX = 0; &#125; deltaY = this.hasVerticalScroll ? deltaY : 0; newY = this.y + deltaY; // Slow down if outside of the boundaries if ( newY &gt; 0 || newY &lt; this.maxScrollY ) &#123; newY = this.options.bounce ? this.y + deltaY / 3 : newY &gt; 0 ? 0 : this.maxScrollY; &#125; this.directionY = deltaY &gt; 0 ? -1 : deltaY &lt; 0 ? 1 : 0; if ( !this.moved ) &#123; this._execEvent(&apos;scrollStart&apos;); &#125; this.moved = true; this._translate(newX, newY);/* REPLACE START: _move */ if ( timestamp - this.startTime &gt; 300 ) &#123; this.startTime = timestamp; this.startX = this.x; this.startY = this.y; &#125;/* REPLACE END: _move */ &#125;, å…¶ä¸­ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„æ˜¯ï¼Œå¦‚æœè¿™æ¬¡ move çš„æ—¶åˆ»ä¸ä¸Šä¸€æ¬¡ï¼ˆstartï¼‰çš„æ—¶é—´è¶…è¿‡ 300 msï¼Œä¼šè¿›è¡Œé‡ç½®ï¼ˆå¤ªå¦™äº†ï¼ï¼ï¼‰è¿™ä¸æ¥ä¸‹æ¥çš„ end æœ‰ç€éå¸¸é‡è¦çš„æ„ä¹‰ 1234if ( timestamp - this.startTime &gt; 300 ) &#123; this.startTime = timestamp; this.startY = this.y;&#125; end åœ¨ end ä¸­å°†è¿›è¡ŒåŠ¨é‡æ»šåŠ¨ï¼ˆæ¾å¼€åè¿˜èƒ½è¿›è¡Œæ»šåŠ¨ï¼‰ åŠ¨é‡æ»šåŠ¨æœ€é‡è¦çš„æ˜¯è®¡ç®—ä¸¤ä¸ªå€¼ï¼Œæ¾å¼€åæ»šåŠ¨çš„ æ—¶é—´ å’Œ è·ç¦»ï¼Œä¹Ÿæ˜¯ iscroll æœ€æ ¸å¿ƒçš„éƒ¨åˆ†ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061 _end: function (e) &#123; var point = e.changedTouches ? e.changedTouches[0] : e, momentumY, duration = utils.getTime() - this.startTime, newY = Math.round(this.y), distanceY = Math.abs(newY - this.startY), time = 0, easing = &apos;&apos;; this.isInTransition = 0; this.initiated = 0; this.endTime = utils.getTime(); // reset if we are outside of the boundaries if ( this.resetPosition(this.options.bounceTime) ) &#123; return; &#125; this.scrollTo(newX, newY); // ensures that the last position is rounded // we scrolled less than 10 pixels if ( !this.moved ) &#123; if ( this.options.tap ) &#123; utils.tap(e, this.options.tap); &#125; if ( this.options.click ) &#123; utils.click(e); &#125; this._execEvent(&apos;scrollCancel&apos;); return; &#125; if ( this._events.flick &amp;&amp; duration &lt; 200 &amp;&amp; distanceX &lt; 100 &amp;&amp; distanceY &lt; 100 ) &#123; this._execEvent(&apos;flick&apos;); return; &#125; // start momentum animation if needed if ( this.options.momentum &amp;&amp; duration &lt; 300 ) &#123; momentumY = this.hasVerticalScroll ? utils.momentum(this.y, this.startY, duration, this.maxScrollY, this.options.bounce ? this.wrapperHeight : 0, this.options.deceleration) : &#123; destination: newY, duration: 0 &#125;; newY = momentumY.destination; time = Math.max(momentumX.duration, momentumY.duration); this.isInTransition = 1; &#125;// INSERT POINT: _end if ( newX != this.x || newY != this.y ) &#123; // change easing function when scroller goes out of the boundaries if ( newX &gt; 0 || newX &lt; this.maxScrollX || newY &gt; 0 || newY &lt; this.maxScrollY ) &#123; easing = utils.ease.quadratic; &#125; this.scrollTo(newX, newY, time, easing); return; &#125; this._execEvent(&apos;scrollEnd&apos;); &#125;, è®¡ç®—ä½¿ç”¨äº† util.momentum è¾“å…¥ï¼Œç°åœ¨çš„æ»šåŠ¨ä½ç½® yï¼Œä¸Šä¸€æ¬¡å¼€å§‹çš„ startYï¼ˆè¯¥ä½ç½®ä¼šåœ¨ move ä¸­é‡ç½®ï¼‰ï¼Œtimeï¼ˆè·ç¦»ä¸Šä¸€æ¬¡ start çš„æ—¶é—´ï¼‰ï¼ŒlowerMargin æœ€å¤§çš„æ»šåŠ¨è·ç¦»ï¼ŒwrapperSize å®¹å™¨çš„å°ºå¯¸ï¼Œdeceleration æ’å€¼å™¨ è¯ä¸å¤šè¯´ï¼Œè‡ªå·±æ¬£èµå§ã€‚è¿”å›æ»šåŠ¨æ—¶é—´å’Œç›®æ ‡æ»šåŠ¨ä½ç½® 1234567891011121314151617181920212223242526momentum = function (current, start, time, lowerMargin, wrapperSize, deceleration) &#123; var distance = current - start, speed = Math.abs(distance) / time, destination, duration; deceleration = deceleration === undefined ? 0.0006 : deceleration; destination = current + ( speed * speed ) / ( 2 * deceleration ) * ( distance &lt; 0 ? -1 : 1 ); duration = speed / deceleration; if ( destination &lt; lowerMargin ) &#123; destination = wrapperSize ? lowerMargin - ( wrapperSize / 2.5 * ( speed / 8 ) ) : lowerMargin; distance = Math.abs(destination - current); duration = distance / speed; &#125; else if ( destination &gt; 0 ) &#123; destination = wrapperSize ? wrapperSize / 2.5 * ( speed / 8 ) : 0; distance = Math.abs(current) + destination; duration = distance / speed; &#125; return &#123; destination: Math.round(destination), duration: duration &#125;;&#125;; ç„¶åå°±æ˜¯ä½¿ç”¨ scrollTo å‡½æ•°è¿›è¡ŒåŠ¨é‡æ»šåŠ¨äº†ã€‚this.isInTransition æ ‡å¿—æ­£åœ¨è¿›è¡ŒåŠ¨é‡æ»šåŠ¨ï¼Œå¦‚æœæœŸé—´å­˜åœ¨ touchdown äº‹ä»¶ï¼Œåˆ™ä¼šç«‹åˆ»åœæ­¢æ»šåŠ¨ã€‚ 1234567891011if ( this.options.useTransition &amp;&amp; this.isInTransition ) &#123; this._transitionTime(); this.isInTransition = false; pos = this.getComputedPosition(); this._translate(Math.round(pos.x), Math.round(pos.y)); this._execEvent(&apos;scrollEnd&apos;); &#125; else if ( !this.options.useTransition &amp;&amp; this.isAnimating ) &#123; this.isAnimating = false; this._execEvent(&apos;scrollEnd&apos;); &#125;&#125; è‡³æ­¤ï¼Œæ ¸å¿ƒåŠŸèƒ½å·®ä¸å¤šäº† ä½† iscroll è¿˜æœ‰å…¶ä»–å¾ˆå¤šåŠŸèƒ½ï¼Œæ¯”å¦‚ è½®æ’­å›¾ æ”¾å¤§ç¼©å° â€¦ æœ€å å…¶å®å§ï¼ŒiScroll ä¹Ÿä¹Ÿå°±é‚£ä¹ˆå›äº‹ã€‚","categories":[{"name":"JavaScript","slug":"JavaScript","permalink":"https://wzes.github.io/categories/JavaScript/"}],"tags":[{"name":"JavaScript","slug":"JavaScript","permalink":"https://wzes.github.io/tags/JavaScript/"}]},{"title":"Gulp å…¥é—¨æŒ‡å—","slug":"JavaScript/Gulp","date":"2019-10-20T07:30:16.000Z","updated":"2019-10-20T09:58:06.150Z","comments":true,"path":"2019/10/20/JavaScript/Gulp/","link":"","permalink":"https://wzes.github.io/2019/10/20/JavaScript/Gulp/","excerpt":"","text":"å‰è¨€ æ˜å¤©å°±è¦æ™‹å‡ç­”è¾©äº†ï¼Œä»Šå¤©å†™ç¯‡å…¥é—¨ Wiki å‹å‹æƒŠå§ï¼Œæ­£å¥½æœ€è¿‘æƒ³å­¦æ„å»ºå·¥å…·ä¹‹ç±»çš„ä¸œè¥¿ï¼ŒGulp å¥½åƒå°±å¾ˆåˆé€‚ Glup æ˜¯ä»€ä¹ˆï¼Ÿ Gulp æœ‰ç‹¼åè™å’½çš„æ„æ€ã€‚ å®˜æ–¹ã€https://gulpjs.com/docsã€‘è§£é‡Š gulp æ˜¯ä¸€ä¸ªå·¥å…·åŒ…ï¼Œç”¨äºåœ¨å¼€å‘å·¥ä½œæµç¨‹ä¸­è‡ªåŠ¨åŒ–ç¹çæˆ–è€—æ—¶çš„ä»»åŠ¡ï¼Œå› æ­¤æ‚¨å¯ä»¥é¿å…æ··ä¹±å¹¶æ„å»ºä¸€äº›ä¸œè¥¿ã€‚ ç›´ç™½æ¥è¯´ï¼Œå°±æ˜¯ä¸€ä¸ªæ„å»ºå·¥å…·ã€‚å¸¸ç”¨æ¥åˆ¶ä½œå¼€å‘è„šæ‰‹æ¶ï¼Œç”Ÿäº§æ¨¡ç‰ˆï½ Get Started Node ç¯å¢ƒ é¦–å…ˆï¼Œæ£€æŸ¥ nodeã€npm å’Œ npx æ˜¯å¦æ­£ç¡®å®‰è£… å…¨å±€å®‰è£… 1npm install gulp-cli -g åˆ›å»ºé¡¹ç›®ç›®å½•å¹¶è¿›å…¥ 1mkdir gulp-project &amp; cd gulp-project åœ¨é¡¹ç›®ç›®å½•ä¸‹åˆ›å»º package.json æ–‡ä»¶ 1npm init å®‰è£… gulpï¼Œä½œä¸ºå¼€å‘æ—¶ä¾èµ–é¡¹ 1npm install --save-dev gulp åˆ›å»º gulpfile æ–‡ä»¶ åˆ©ç”¨ä»»ä½•æ–‡æœ¬ç¼–è¾‘å™¨åœ¨é¡¹ç›®å¤§çš„æ ¹ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªåä¸º gulpfile.js çš„æ–‡ä»¶ï¼Œå¹¶åœ¨æ–‡ä»¶ä¸­è¾“å…¥ä»¥ä¸‹å†…å®¹ï¼š 123456function defaultTask(cb) &#123; // place code for your default task here cb();&#125;exports.default = defaultTask æµ‹è¯• åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹æ‰§è¡Œ gulp å‘½ä»¤ï¼š 1gulp è¾“å‡º 123[17:16:32] Using gulpfile ~/WebProjects/gulp-project/gulpfile.js[17:16:32] Starting &apos;default&apos;...[17:16:32] Finished &apos;default&apos; after 1.37 ms é«˜çº§ç”¨æ³• æ–‡ä»¶ç›‘æ§å’Œå¤„ç† ä½¿ç”¨ watchï¼Œç›‘å¬æ–‡ä»¶å˜åŒ–ï¼Œå°† src ç›®å½•çš„ js æ–‡ä»¶å¤åˆ¶åˆ° output ç›®å½•ä¸‹ã€‚ 1234567891011const &#123; src, dest, watch &#125; = require(&apos;gulp&apos;);const gulp = require(&apos;gulp&apos;)function streamTask() &#123; return src(&apos;src/**/*.js&apos;) .pipe(dest(&apos;output&apos;));&#125;// åˆ›å»ºä¸€ä¸ªä»»åŠ¡gulp.task(&apos;watch&apos;, function () &#123; watch(&apos;src/*.js&apos;, streamTask);&#125;) ä¼¼ä¹éå¸¸æ–¹ä¾¿ï¼Œå°è£…äº† chokidar å†™åœ¨æœ€å å¯ä»¥é›†æˆ rollupï¼Œwebpack ç­‰ node apiï¼Œåšä¸€ä¸ª hotreload å‚è€ƒ https://www.gulpjs.com.cn/docs/getting-started/quick-start/","categories":[{"name":"JavaScript","slug":"JavaScript","permalink":"https://wzes.github.io/categories/JavaScript/"}],"tags":[{"name":"JavaScript","slug":"JavaScript","permalink":"https://wzes.github.io/tags/JavaScript/"}]},{"title":"JavaScript Event preventDefaultå’ŒstopPropagation","slug":"JavaScript/JavaScript Event","date":"2019-09-30T07:30:16.000Z","updated":"2019-09-30T07:52:23.506Z","comments":true,"path":"2019/09/30/JavaScript/JavaScript Event/","link":"","permalink":"https://wzes.github.io/2019/09/30/JavaScript/JavaScript Event/","excerpt":"","text":"å‰è¨€ å¯¹äºJSçš„äº‹ä»¶ä¼ é€’è¿˜æ˜¯æ¯”è¾ƒé™Œç”Ÿï¼Œæ‰€ä»¥æ‰“ç®—å¥½å¥½ç†ä¸€ç†preventDefaultå’ŒstopPropagationçš„ç”¨æ³•ï¼Œå½»åº•å‘Šåˆ«æ¨¡ç³Šï¼Œæå‡è‡ªå·±çš„å‰ç«¯æ®µä½ï¼ æ —å­ åœ¨ä»¥ä¸‹ç¤ºä¾‹ä¸­ï¼Œå•å‡»Webæµè§ˆå™¨ä¸­çš„è¶…é“¾æ¥å°†è§¦å‘äº‹ä»¶çš„æµç¨‹ï¼ˆæ‰§è¡Œäº‹ä»¶ç›‘å¬å™¨ï¼‰å’Œäº‹ä»¶ç›®æ ‡çš„é»˜è®¤æ“ä½œï¼ˆæ‰“å¼€æ–°é€‰é¡¹å¡ï¼‰ã€‚ HTMLï¼š 123&lt;div id=&quot;a&quot;&gt; &lt;a id=&quot;b&quot; href=&quot;http://www.google.com/&quot; target=&quot;_blank&quot;&gt;Google&lt;/a&gt;&lt;/div&gt; JavaScript: 123456789101112131415161718var el = document.getElementById(&quot;c&quot;);function capturingOnClick1(ev) &#123; el.innerHTML += &quot;DIV event capture&lt;br&gt;&quot;;&#125;function capturingOnClick2(ev) &#123; el.innerHTML += &quot;A event capture&lt;br&gt;&quot;;&#125;function bubblingOnClick1(ev) &#123; el.innerHTML += &quot;DIV event bubbling&lt;br&gt;&quot;;&#125;function bubblingOnClick2(ev) &#123; el.innerHTML += &quot;A event bubbling&lt;br&gt;&quot;;&#125;// The 3rd parameter useCapture makes the event listener capturing (false by default)document.getElementById(&quot;a&quot;).addEventListener(&quot;click&quot;, capturingOnClick1, true);document.getElementById(&quot;b&quot;).addEventListener(&quot;click&quot;, capturingOnClick2, true);document.getElementById(&quot;a&quot;).addEventListener(&quot;click&quot;, bubblingOnClick1, false);document.getElementById(&quot;b&quot;).addEventListener(&quot;click&quot;, bubblingOnClick2, false); è¾“å‡º event captureA event captureA event bubblingDIV event bubbling1234DIV event captureA event captureA event bubblingDIV event bubbling å‘capturingOnClick1å‡½æ•°æ·»åŠ stopPropagation() 1234function capturingOnClick1(ev) &#123; el.innerHTML += &quot;DIV event capture&lt;br&gt;&quot;; ev.stopPropagation();&#125; ç»“æœåªè¾“å‡º 1DIV event capture äº‹ä»¶ä¾¦å¬å™¨é˜»æ­¢äº†äº‹ä»¶çš„è¿›ä¸€æ­¥å‘ä¸‹å’Œå‘ä¸Šä¼ æ’­ã€‚ä½†æ˜¯ï¼Œè¿™å¹¶æ²¡æœ‰é˜»æ­¢é»˜è®¤æ“ä½œï¼ˆæ‰“å¼€æ–°æ ‡ç­¾é¡µï¼‰ã€‚ å‘capturingOnClick2å‡½æ•°æ·»åŠ stopPropagation() 1234function capturingOnClick2(ev) &#123; el.innerHTML += &quot;A event capture&lt;br&gt;&quot;; ev.stopPropagation();&#125; æˆ–è€… 1234function bubblingOnClick2(ev) &#123; el.innerHTML += &quot;A event bubbling&lt;br&gt;&quot;; ev.stopPropagation();&#125; ç»“æœ 123DIV event captureA event captureA event bubbling è¿™æ˜¯å› ä¸ºä¸¤ä¸ªäº‹ä»¶ä¾¦å¬å™¨éƒ½æ³¨å†Œåœ¨åŒä¸€äº‹ä»¶ç›®æ ‡ä¸Šã€‚äº‹ä»¶ä¾¦å¬å™¨é˜»æ­¢äº†äº‹ä»¶çš„è¿›ä¸€æ­¥å‘ä¸Šä¼ æ’­ã€‚ä½†æ˜¯ï¼Œå®ƒä»¬å¹¶æ²¡æœ‰é˜»æ­¢é»˜è®¤æ“ä½œï¼ˆæ‰“å¼€æ–°æ ‡ç­¾é¡µï¼‰ã€‚ å°†preventDefault()æ·»åŠ åˆ°ä»»ä½•å‡½æ•°ä¸­ 1234function capturingOnClick1(ev) &#123; el.innerHTML += &quot;DIV event capture&lt;br&gt;&quot;; ev.preventDefault();&#125; ç»“æœç…§å¸¸è¾“å‡º 1234DIV event captureA event captureA event bubblingDIV event bubbling ä½†å®ƒé˜»æ­¢æ‰“å¼€æ–°æ ‡ç­¾é¡µ åŸç†è§£æ äº‹ä»¶é¡ºåº åŸºæœ¬é—®é¢˜å¾ˆç®€å•ï¼Œå‡è®¾å…ƒç´ å†…éƒ¨æœ‰ä¸€ä¸ªå…ƒç´ ï¼Œå¦‚ä¸‹ï¼š 1234567-----------------------------------| element1 || ------------------------- || |element2 | || ------------------------- || |----------------------------------- ä¸¤è€…éƒ½æœ‰ä¸€ä¸ªonClickäº‹ä»¶å¤„ç†ç¨‹åºã€‚å¦‚æœç”¨æˆ·å•å‡»element2ï¼Œä»–å°†åœ¨element1å’Œelement2ä¸­éƒ½å¼•èµ·clickäº‹ä»¶ã€‚ä½†æ˜¯å“ªä¸ªäº‹ä»¶é¦–å…ˆè§¦å‘ï¼Ÿåº”è¯¥å…ˆæ‰§è¡Œå“ªä¸ªäº‹ä»¶å¤„ç†ç¨‹åºï¼Ÿæ¢å¥è¯è¯´ï¼Œäº‹ä»¶é¡ºåºæ˜¯ä»€ä¹ˆï¼Ÿ ä¸¤ç§äº‹ä»¶æ¨¡å‹ åœ¨è¿‡å»ï¼ŒNetscapeå’ŒMicrosoftå¾—å‡ºäº†ä¸åŒçš„ç»“è®ºã€‚ Netscapeè¯´ï¼Œelement1ä¸Šçš„äº‹ä»¶é¦–å…ˆå‘ç”Ÿã€‚è¿™ç§°ä¸ºäº‹ä»¶æ•è·***(capturing)***ã€‚ MicrosoftåšæŒè®¤ä¸ºelement2ä¸Šçš„äº‹ä»¶ä¼˜å…ˆã€‚è¿™ç§°ä¸ºäº‹ä»¶å†’æ³¡**(bubbling)**ã€‚ è¿™ä¸¤ä¸ªäº‹ä»¶é¡ºåºå®Œå…¨ç›¸åã€‚ Explorerä»…æ”¯æŒäº‹ä»¶å†’æ³¡ã€‚ Mozillaï¼ŒOpera 7å’ŒKonqueroréƒ½æ”¯æŒã€‚æ—§ç‰ˆOperaå’ŒiCabéƒ½ä¸æ”¯æŒã€‚ äº‹ä»¶æ•è·ï¼ˆcapturingï¼‰ ä½¿ç”¨äº‹ä»¶æ•è·æ—¶ 12345678 | |---------------| |-----------------| element1 | | || -----------| |----------- || |element2 \\ / | || ------------------------- || Event CAPTURING |----------------------------------- element1çš„äº‹ä»¶å¤„ç†ç¨‹åºé¦–å…ˆè§¦å‘ï¼Œelement2çš„äº‹ä»¶å¤„ç†ç¨‹åºæœ€åè§¦å‘ã€‚ äº‹ä»¶å†’æ³¡ï¼ˆbubblingï¼‰ ä½¿ç”¨äº‹ä»¶å†’æ³¡æ—¶ 12345678 / \\---------------| |-----------------| element1 | | || -----------| |----------- || |element2 | | | || ------------------------- || Event BUBBLING |----------------------------------- element2çš„äº‹ä»¶å¤„ç†ç¨‹åºé¦–å…ˆè§¦å‘ï¼Œelement1çš„äº‹ä»¶å¤„ç†ç¨‹åºæœ€åè§¦å‘ã€‚ W3C äº‹ä»¶æ¨¡å‹ W3Céå¸¸æ˜æ™ºåœ°å†³å®šåœ¨è¿™åœºæ–—äº‰ä¸­å¤„äºä¸­é—´ä½ç½®ã€‚ W3Cäº‹ä»¶æ¨¡å‹ä¸­å‘ç”Ÿçš„ä»»ä½•äº‹ä»¶éƒ½é¦–å…ˆè¢«æ•è·ï¼Œç›´åˆ°åˆ°è¾¾ç›®æ ‡å…ƒç´ ï¼Œç„¶åå†æ¬¡å†’æ³¡ã€‚ 12345678 | | / \\-----------------| |--| |-----------------| element1 | | | | || -------------| |--| |----------- || |element2 \\ / | | | || -------------------------------- || W3C event model |------------------------------------------` Webå¼€å‘äººå‘˜å¯ä»¥é€‰æ‹©æ˜¯åœ¨æ•è·é˜¶æ®µè¿˜æ˜¯å†’æ³¡é˜¶æ®µä¸­æ³¨å†Œäº‹ä»¶å¤„ç†ç¨‹åºã€‚è¿™æ˜¯é€šè¿‡â€œé«˜çº§æ¨¡å‹â€é¡µé¢ä¸Šè¯´æ˜çš„addEventListener()æ–¹æ³•å®Œæˆçš„ã€‚å¦‚æœæœ€åä¸€ä¸ªå‚æ•°ä¸ºtrueï¼Œåˆ™ä¸ºæ•è·é˜¶æ®µè®¾ç½®äº‹ä»¶å¤„ç†ç¨‹åºï¼Œå¦‚æœä¸ºfalseï¼Œåˆ™ä¸ºå†’æ³¡é˜¶æ®µè®¾ç½®äº‹ä»¶å¤„ç†ç¨‹åºã€‚ å‡è®¾ 12element1.addEventListener(&apos;click&apos;,doSomething2,true)element2.addEventListener(&apos;click&apos;,doSomething,false) å¦‚æœç”¨æˆ·å•å‡»element2ï¼Œåˆ™ä¼šå‘ç”Ÿä»¥ä¸‹æƒ…å†µï¼š å•å‡»äº‹ä»¶åœ¨æ•è·é˜¶æ®µå¼€å§‹ã€‚è¯¥äº‹ä»¶æŸ¥æ‰¾element2çš„ä»»ä½•ç¥–å…ˆå…ƒç´ æ˜¯å¦å…·æœ‰ç”¨äºæ•è·é˜¶æ®µçš„onclickäº‹ä»¶å¤„ç†ç¨‹åºã€‚ è¯¥äº‹ä»¶åœ¨element1ä¸Šæ‰¾åˆ°ä¸€ä¸ªã€‚doSomething2()è¢«æ‰§è¡Œã€‚ äº‹ä»¶å‘ä¸‹ä¼ æ’­åˆ°ç›®æ ‡æœ¬èº«ï¼Œæ‰¾ä¸åˆ°ç”¨äºæ•è·é˜¶æ®µçš„äº‹ä»¶å¤„ç†ç¨‹åºã€‚è¯¥äº‹ä»¶è¿›å…¥å…¶å†’æ³¡é˜¶æ®µå¹¶æ‰§è¡ŒdoSomething()ï¼Œè¯¥äº‹ä»¶å·²åœ¨å†’æ³¡é˜¶æ®µæ³¨å†Œåˆ°element2ã€‚ äº‹ä»¶å†æ¬¡å‘ä¸Šä¼ æ’­ï¼Œå¹¶æ£€æŸ¥ç›®æ ‡çš„ä»»ä½•ç¥–å…ˆå…ƒç´ æ˜¯å¦å…·æœ‰ç”¨äºå†’æ³¡é˜¶æ®µçš„äº‹ä»¶å¤„ç†ç¨‹åºã€‚äº‹å®å¹¶éå¦‚æ­¤ï¼Œå› æ­¤ä»€ä¹ˆä¹Ÿæ²¡æœ‰å‘ç”Ÿã€‚ ç›¸å 12element1.addEventListener(&apos;click&apos;,doSomething2,false)element2.addEventListener(&apos;click&apos;,doSomething,false) ç°åœ¨ï¼Œå¦‚æœç”¨æˆ·å•å‡»element2ï¼Œåˆ™ä¼šå‘ç”Ÿä»¥ä¸‹æƒ…å†µï¼š å•å‡»äº‹ä»¶åœ¨æ•è·é˜¶æ®µå¼€å§‹ã€‚è¯¥äº‹ä»¶å°†æŸ¥æ‰¾element2çš„ä»»ä½•ç¥–å…ˆå…ƒç´ æ˜¯å¦å…·æœ‰ç”¨äºæ•è·é˜¶æ®µçš„onclickäº‹ä»¶å¤„ç†ç¨‹åºï¼Œè€Œæ‰¾ä¸åˆ°ä»»ä½•äº‹ä»¶å¤„ç†ç¨‹åºã€‚ äº‹ä»¶å‘ä¸‹ä¼ æ’­åˆ°ç›®æ ‡æœ¬èº«ã€‚è¯¥äº‹ä»¶è¿›å…¥å…¶å†’æ³¡é˜¶æ®µå¹¶æ‰§è¡ŒdoSomething()ï¼Œè¯¥äº‹ä»¶å·²åœ¨å†’æ³¡é˜¶æ®µæ³¨å†Œåˆ°element2ã€‚ äº‹ä»¶å†æ¬¡å‘ä¸Šä¼ æ’­ï¼Œå¹¶æ£€æŸ¥ç›®æ ‡çš„ä»»ä½•ç¥–å…ˆå…ƒç´ æ˜¯å¦å…·æœ‰ç”¨äºå†’æ³¡é˜¶æ®µçš„äº‹ä»¶å¤„ç†ç¨‹åºã€‚ è¯¥äº‹ä»¶åœ¨element1ä¸Šæ‰¾åˆ°ä¸€ä¸ªã€‚ç°åœ¨æ‰§è¡ŒdoSomething2()ã€‚ ä¸ä¼ ç»Ÿæ¨¡å‹çš„å…¼å®¹æ€§ åœ¨æ”¯æŒW3C DOMçš„æµè§ˆå™¨ä¸­ï¼Œä¼ ç»Ÿçš„äº‹ä»¶æ³¨å†Œ 1element1.onclick = doSomething2; è¢«è§†ä¸ºå†’æ³¡é˜¶æ®µçš„æ³¨å†Œã€‚ ä½¿ç”¨äº‹ä»¶å†’æ³¡ å¾ˆå°‘æœ‰Webå¼€å‘äººå‘˜è‡ªè§‰ä½¿ç”¨äº‹ä»¶æ•è·æˆ–å†’æ³¡ã€‚åœ¨å½“ä»Šçš„ç½‘é¡µä¸­ï¼Œæ ¹æœ¬æ²¡æœ‰å¿…è¦è®©å†’æ³¡äº‹ä»¶ç”±å¤šä¸ªä¸åŒçš„äº‹ä»¶å¤„ç†ç¨‹åºå¤„ç†ã€‚ç”¨æˆ·å¯èƒ½ä¼šå› å•å‡»é¼ æ ‡åå‘ç”Ÿçš„å‡ ä»¶äº‹è€Œæ„Ÿåˆ°å›°æƒ‘ï¼Œå¹¶ä¸”é€šå¸¸æ‚¨å¸Œæœ›å°†äº‹ä»¶å¤„ç†è„šæœ¬åˆ†å¼€ã€‚å½“ç”¨æˆ·å•å‡»æŸä¸ªå…ƒç´ æ—¶ï¼Œä¼šå‘ç”ŸæŸäº›äº‹æƒ…ï¼Œè€Œå½“ç”¨æˆ·å•å‡»å¦ä¸€ä¸ªå…ƒç´ æ—¶ï¼Œä¼šå‘ç”Ÿå…¶ä»–äº‹æƒ…ã€‚ å½“ç„¶ï¼Œè¿™ç§æƒ…å†µå°†æ¥å¯èƒ½ä¼šæ”¹å˜ï¼Œå› æ­¤æœ€å¥½å¯ä»¥ä½¿ç”¨å‘å‰å…¼å®¹çš„æ¨¡å‹ã€‚ä½†æ˜¯ï¼Œä»Šå¤©äº‹ä»¶æ•è·å’Œå†’æ³¡çš„ä¸»è¦å®é™…ç”¨é€”æ˜¯é»˜è®¤åŠŸèƒ½çš„æ³¨å†Œã€‚ æ€»æ˜¯ä¼šå‘ç”Ÿ æ‚¨é¦–å…ˆéœ€è¦äº†è§£çš„æ˜¯ï¼Œäº‹ä»¶æ•è·æˆ–å†’æ³¡æ€»æ˜¯ä¼šå‘ç”Ÿã€‚å¦‚æœæ‚¨ä¸ºæ•´ä¸ªdocumentå®šä¹‰å¸¸è§„çš„onclickäº‹ä»¶å¤„ç†ç¨‹åº 12document.onclick = doSomething;if (document.captureEvents) document.captureEvents(Event.CLICK); documentä¸­ä»»ä½•å…ƒç´ ä¸Šçš„ä»»ä½•clickäº‹ä»¶æœ€ç»ˆéƒ½ä¼šå†’æ³¡åˆ°documentä¸­ï¼Œä»è€Œè§¦å‘æ­¤å¸¸è§„äº‹ä»¶å¤„ç†ç¨‹åºã€‚ä»…å½“ä»¥å‰çš„äº‹ä»¶å¤„ç†è„šæœ¬æ˜ç¡®å‘½ä»¤äº‹ä»¶åœæ­¢å†’æ³¡æ—¶ï¼Œå®ƒæ‰ä¸ä¼šå†’æ³¡åˆ° documentã€‚ ä½¿ç”¨ å› ä¸ºä»»ä½•äº‹ä»¶æœ€ç»ˆéƒ½å‡ºç°åœ¨ document ä¸Šï¼Œæ‰€ä»¥é»˜è®¤äº‹ä»¶å¤„ç†ç¨‹åºæˆä¸ºå¯èƒ½ã€‚å‡è®¾æ‚¨æœ‰æ­¤é¡µé¢ï¼š 1234567891011------------------------------------| document || --------------- ------------ || | element1 | | element2 | || --------------- ------------ || |------------------------------------element1.onclick = doSomething;element2.onclick = doSomething;document.onclick = defaultFunction; ç°åœ¨ï¼Œå¦‚æœç”¨æˆ·å•å‡»element1æˆ–2ï¼Œåˆ™å°†æ‰§è¡ŒdoSomething()ã€‚å¦‚æœéœ€è¦ï¼Œå¯ä»¥åœ¨æ­¤å¤„åœæ­¢äº‹ä»¶ä¼ æ’­ã€‚å¦‚æœæ‚¨ä¸è¿™æ ·åšï¼Œåˆ™äº‹ä»¶ä¼šä¸Šå‡åˆ°defaultFunction()ã€‚å¦‚æœç”¨æˆ·å•å‡»å…¶ä»–ä»»ä½•åœ°æ–¹ï¼Œè¿˜å°†æ‰§è¡ŒdefaultFunction()ã€‚æœ‰æ—¶è¿™å¯èƒ½å¾ˆæœ‰ç”¨ã€‚ åœ¨æ‹–æ”¾è„šæœ¬ä¸­ï¼Œå¿…é¡»è®¾ç½®documentèŒƒå›´çš„äº‹ä»¶å¤„ç†ç¨‹åºã€‚é€šå¸¸ï¼Œä¸Šå±‚çš„mousedownäº‹ä»¶ä¼šé€‰æ‹©è¯¥å±‚å¹¶ä½¿ä¹‹å“åº”mousemoveäº‹ä»¶ã€‚å°½ç®¡é€šå¸¸åœ¨å±‚ä¸Šæ³¨å†Œmousedownä»¥é¿å…æµè§ˆå™¨é”™è¯¯ï¼Œä½†æ˜¯å…¶ä»–ä¸¤ä¸ªäº‹ä»¶å¤„ç†ç¨‹åºéƒ½å¿…é¡»åœ¨documentèŒƒå›´å†…ã€‚ è®°ä½æµè§ˆå™¨å­¦çš„ç¬¬ä¸€å®šå¾‹ï¼šä»»ä½•äº‹æƒ…éƒ½æœ‰å¯èƒ½å‘ç”Ÿï¼Œå¹¶ä¸”é€šå¸¸åœ¨æ‚¨æœ€æ²¡æœ‰å‡†å¤‡çš„æƒ…å†µä¸‹æ‰ä¼šå‘ç”Ÿã€‚å› æ­¤ï¼Œç”¨æˆ·å¯èƒ½ä¼šéå¸¸ç–¯ç‹‚åœ°ç§»åŠ¨é¼ æ ‡ï¼Œè€Œè„šæœ¬æ— æ³•è·Ÿä¸Šï¼Œä»¥è‡³äºé¼ æ ‡ä¸å†ä½äºå›¾å±‚ä¸Šã€‚ å¦‚æœonmousemoveäº‹ä»¶å¤„ç†ç¨‹åºå·²æ³¨å†Œåˆ°å›¾å±‚ï¼Œåˆ™è¯¥å›¾å±‚ä¸å†å¯¹é¼ æ ‡ç§»åŠ¨åšå‡ºååº”ï¼Œä»è€Œå¼•èµ·æ··ä¹±ã€‚ å¦‚æœonmouseupäº‹ä»¶å¤„ç†ç¨‹åºå·²åœ¨å›¾å±‚ä¸Šæ³¨å†Œï¼Œåˆ™ä¸ä¼šæ•è·æ­¤äº‹ä»¶ï¼Œå› æ­¤å³ä½¿ç”¨æˆ·è®¤ä¸ºä»–æ”¾ä¸‹äº†è¯¥å›¾å±‚ï¼Œè¯¥å›¾å±‚ä¹Ÿä¼šç»§ç»­å¯¹é¼ æ ‡ç§»åŠ¨åšå‡ºååº”ã€‚è¿™å¼•èµ·äº†æ›´å¤šçš„æ··ä¹±ã€‚ å› æ­¤ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œäº‹ä»¶å†’æ³¡éå¸¸æœ‰ç”¨ï¼Œå› ä¸ºåœ¨æ–‡æ¡£çº§åˆ«æ³¨å†Œäº‹ä»¶å¤„ç†ç¨‹åºå¯ç¡®ä¿å§‹ç»ˆæ‰§è¡Œå®ƒä»¬ã€‚ ç¦ç”¨ ä½†æ˜¯é€šå¸¸æ‚¨æƒ³å…³é—­æ‰€æœ‰æ•è·å’Œå†’æ³¡åŠŸèƒ½ï¼Œä»¥é˜²æ­¢åŠŸèƒ½ç›¸äº’å¹²æ‰°ã€‚æ­¤å¤–ï¼Œå¦‚æœæ‚¨çš„æ–‡æ¡£ç»“æ„éå¸¸å¤æ‚ï¼ˆå¾ˆå¤šåµŒå¥—è¡¨ç­‰ï¼‰ï¼Œåˆ™å¯ä»¥é€šè¿‡å…³é—­å†’æ³¡æ¥èŠ‚çœç³»ç»Ÿèµ„æºã€‚æµè§ˆå™¨å¿…é¡»éå†äº‹ä»¶ç›®æ ‡çš„æ¯ä¸ªç¥–å…ˆå…ƒç´ ï¼Œä»¥æŸ¥çœ‹å…¶æ˜¯å¦å…·æœ‰äº‹ä»¶å¤„ç†ç¨‹åºã€‚å³ä½¿æœªæ‰¾åˆ°ï¼Œæœç´¢ä»ç„¶éœ€è¦æ—¶é—´ã€‚ åœ¨Microsoftæ¨¡å‹ä¸­ï¼Œæ‚¨å¿…é¡»å°†äº‹ä»¶çš„cancelBubbleå±æ€§è®¾ç½®ä¸ºtrueã€‚ 1window.event.cancelBubble = true åœ¨W3Cæ¨¡å‹ä¸­ï¼Œæ‚¨å¿…é¡»è°ƒç”¨äº‹ä»¶çš„*stopPropagation()*æ–¹æ³•ã€‚ 1e.stopPropagation() è¿™å°†åœæ­¢äº‹ä»¶åœ¨å†’æ³¡é˜¶æ®µçš„æ‰€æœ‰ä¼ æ’­ã€‚è¦è·å¾—å®Œæ•´çš„è·¨æµè§ˆå™¨ä½“éªŒï¼Œè¯·æ‰§è¡Œ 123456function doSomething(e)&#123; if (!e) var e = window.event; e.cancelBubble = true; if (e.stopPropagation) e.stopPropagation();&#125; åœ¨ä¸æ”¯æŒè¯¥åŠŸèƒ½çš„æµè§ˆå™¨ä¸­è®¾ç½®cancelBubbleå±æ€§ä¸ä¼šæœ‰ä»»ä½•é—®é¢˜ã€‚æµè§ˆå™¨è€¸è€¸è‚©å¹¶åˆ›å»ºå±æ€§ã€‚å½“ç„¶ï¼Œå®ƒå®é™…ä¸Šå¹¶ä¸èƒ½æ¶ˆé™¤å†’æ³¡ï¼Œä½†æ˜¯ä½œä¸šæœ¬èº«æ˜¯å®‰å…¨çš„ã€‚ å½“å‰ç›®æ ‡ å¦‚æˆ‘ä»¬å‰é¢æ‰€è§ï¼Œäº‹ä»¶å…·æœ‰ä¸€ä¸ªtargetæˆ–srcElementï¼Œå…¶ä¸­åŒ…å«å¯¹è¯¥äº‹ä»¶å‘ç”Ÿæ‰€åœ¨å…ƒç´ çš„å¼•ç”¨ã€‚åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ï¼Œè¿™æ˜¯element2ï¼Œå› ä¸ºç”¨æˆ·å•å‡»äº†å®ƒã€‚ éå¸¸é‡è¦çš„ä¸€ç‚¹æ˜¯è¦ç†è§£ï¼Œåœ¨æ•è·å’Œå†’æ³¡é˜¶æ®µï¼ˆå¦‚æœæœ‰ï¼‰ï¼Œè¯¥ç›®æ ‡ä¸ä¼šæ”¹å˜ï¼šå®ƒå§‹ç»ˆæ˜¯å¯¹element2çš„å¼•ç”¨ã€‚ ä½†æ˜¯ï¼Œå‡è®¾æˆ‘ä»¬æ³¨å†Œäº†ä»¥ä¸‹äº‹ä»¶å¤„ç†ç¨‹åºï¼š 12element1.onclick = doSomething;element2.onclick = doSomething; å¦‚æœç”¨æˆ·å•å‡»element2ï¼Œåˆ™doSomething()å°†æ‰§è¡Œä¸¤æ¬¡ã€‚ä½†æ˜¯ï¼Œæ‚¨å¦‚ä½•çŸ¥é“å½“å‰æ­£åœ¨å¤„ç†è¯¥äº‹ä»¶çš„HTMLå…ƒç´ ï¼Ÿ target / srcElementä¸æä¾›ä»»ä½•çº¿ç´¢ï¼Œå®ƒä»¬å§‹ç»ˆå¼•ç”¨element2ï¼Œå› ä¸ºå®ƒæ˜¯äº‹ä»¶çš„åŸå§‹æ¥æºã€‚ ä¸ºäº†è§£å†³æ­¤é—®é¢˜ï¼ŒW3Cæ·»åŠ äº†currentTargetå±æ€§ã€‚å®ƒåŒ…å«å¯¹äº‹ä»¶å½“å‰æ­£åœ¨å¤„ç†çš„HTMLå…ƒç´ çš„å¼•ç”¨ï¼šæ­£æ˜¯æˆ‘ä»¬æ‰€éœ€è¦çš„ã€‚ä¸å¹¸çš„æ˜¯ï¼ŒMicrosoftæ¨¡å‹ä¸åŒ…å«ç±»ä¼¼çš„å±æ€§ã€‚ æ‚¨ä¹Ÿå¯ä»¥ä½¿ç”¨thiså…³é”®å­—ã€‚åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œå®ƒå¼•ç”¨å¤„ç†äº‹ä»¶çš„HTMLå…ƒç´ ï¼Œå°±åƒcurrentTargetä¸€æ ·ã€‚ Microsoftæ¨¡å¼çš„é—®é¢˜ ä½†æ˜¯ï¼Œå½“æ‚¨ä½¿ç”¨Microsoftäº‹ä»¶æ³¨å†Œæ¨¡å‹æ—¶ï¼Œæ­¤å…³é”®å­—å¹¶ä¸å¼•ç”¨HTMLå…ƒç´ ã€‚åŠ ä¸ŠMicrosoftæ¨¡å‹ä¸­ç¼ºå°‘ç±»ä¼¼äºcurrentTargetçš„å±æ€§ï¼Œè¿™æ„å‘³ç€å¦‚æœæ‚¨è¿™æ ·åš 12element1.attachEvent(&apos;onclick&apos;,doSomething)element2.attachEvent(&apos;onclick&apos;,doSomething) æ‚¨ä¸çŸ¥é“å½“å‰å“ªä¸ªHTMLå…ƒç´ å¤„ç†è¯¥äº‹ä»¶ã€‚è¿™æ˜¯Microsoftäº‹ä»¶æ³¨å†Œæ¨¡å‹ä¸­æœ€ä¸¥é‡çš„é—®é¢˜ï¼Œå¯¹æˆ‘æ¥è¯´ï¼Œè¿™æ˜¯ä¸€ä¸ªä»ä¸ä½¿ç”¨å®ƒçš„ç†ç”±ï¼Œå³ä½¿åœ¨ä»…IE / Winçš„åº”ç”¨ç¨‹åºä¸­ä¹Ÿæ˜¯å¦‚æ­¤ã€‚ æˆ‘å¸Œæœ›å¾®è½¯èƒ½å°½å¿«æ·»åŠ ç±»ä¼¼äºcurrentTargetçš„å±æ€§ï¼Œç”šè‡³å¯ä»¥éµå¾ªè¯¥æ ‡å‡†ï¼Ÿ Webå¼€å‘äººå‘˜éœ€è¦æ­¤ä¿¡æ¯ã€‚ å‚è€ƒ Event Order","categories":[{"name":"JavaScript","slug":"JavaScript","permalink":"https://wzes.github.io/categories/JavaScript/"}],"tags":[{"name":"JavaScript","slug":"JavaScript","permalink":"https://wzes.github.io/tags/JavaScript/"}]},{"title":"Browser Window æ‰«ç›²","slug":"JavaScript/BrowserWindow","date":"2019-09-22T10:56:00.000Z","updated":"2019-09-21T14:18:05.202Z","comments":true,"path":"2019/09/22/JavaScript/BrowserWindow/","link":"","permalink":"https://wzes.github.io/2019/09/22/JavaScript/BrowserWindow/","excerpt":"","text":"å‰è¨€ ä½œä¸ºä¸€ä¸ª Node å¼€å‘å·¥ç¨‹å¸ˆï¼Œä¼¼ä¹å¯¹äº Window å¹¶ä¸éœ€è¦å…³å¿ƒï¼Œä½†ä½œä¸ºä¸€ä¸ªå‰ç«¯å·¥ç¨‹å¸ˆï¼ŒWindow æ˜¯ä¸ªå•¥å­ä¸œä¸œï¼Œè¿˜æ˜¯éœ€è¦èŠ±æ—¶é—´ç†ä¸€ç†çš„ã€‚æœ¬æœŸçœ‹ç‚¹ï¼Œæ·±å…¥äº†è§£ Window çš„ API ï½ Window æ‰€æœ‰çš„æµè§ˆå™¨éƒ½æœ‰ Window å¯¹è±¡ï¼Œæ¯ä¸ªçª—å£éƒ½ä¼šå…·æœ‰ä¸€ä¸ª Windowï¼Œé€šå¸¸åœ¨æµè§ˆå™¨å¼€å‘è€…æ¨¡å¼ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ window æ‹¿åˆ°è¿™ä¸ªå¯¹è±¡ã€‚ 1window window å…·æœ‰å¾ˆå¤šå±æ€§å’Œæ–¹æ³•ï¼Œå¸¸è§çš„æœ‰ navigator å¯¼èˆªå™¨ screen æ˜¾ç¤ºå™¨ history å†å²å¯¹è±¡ location ä½ç½®å¯¹è±¡ document æ–‡æ¡£å¯¹è±¡ æ–¹æ³• open close setTimeout setInterval â€¦ åœ¨æµè§ˆå™¨ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨è¿™äº›å¯¹è±¡å’Œæ–¹æ³•ï¼Œå®Œæ•´çš„ç”¨æ³•æ˜¯ window.xxï¼Œä½†æˆ‘ä»¬å¯ä»¥çœç•¥ windowï¼Œç›´æ¥ä½¿ç”¨ xx å³å¯ï¼Œå¯¹äºæ–°æ‰‹æ¥è¯´å¯èƒ½è§‰å¾—å¾ˆå¥‡æ€ªã€‚ å¤ä¹ ä¸€ä¸‹æ–¹æ³•è°ƒç”¨ï¼Œ Javascript çš„æ–¹æ³•æ‰§è¡Œæœ€ç»ˆéƒ½ä¼šæ˜¯ä»¥ xx.call(this, argsâ€¦) çš„å½¢å¼ï¼Œè¿™é‡Œçš„ this å°±æ˜¯æ–¹æ³•çš„ä¸Šä¸‹æ–‡ï¼Œé€šå¸¸æ˜¯è°ƒç”¨çš„å¯¹è±¡ åœ¨æµè§ˆå™¨é‡Œï¼Œå¦‚æœæˆ‘ä»¬ç›´æ¥ä½¿ç”¨ä¸€ä¸ªå±æ€§æˆ–è€…æ–¹æ³•ï¼Œé‚£ä¹ˆæ‰§è¡Œè¿™ä¸ªæ–¹æ³•çš„ä¸Šä¸‹æ–‡é€šå¸¸éƒ½æ˜¯ window å¯¹è±¡ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨è¿™äº›å¯¹è±¡å’Œæ–¹æ³•ï¼Œå› ä¸ºä¸Šä¸‹æ–‡ç¯å¢ƒå°±æ˜¯ windowï¼Œæœ€åå–çš„éƒ½æ˜¯ window çš„å±æ€§å’Œæ–¹æ³•ã€‚ æ”¾ä¸€å¼ æ¯”è¾ƒå®Œæ•´çš„å›¾ï½ document document æ˜¯æˆ‘ä»¬çš„æ–‡æ¡£å¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¼€å‘è€…æ¨¡å¼ç›´æ¥æ‰“å° documentï¼Œdocument æ‰“å°å‡ºæ¥ï¼ˆtoStringï¼‰å°±æ˜¯æˆ‘ä»¬çš„ htmlï¼Œå®é™…ä¸Š document å¯¹è±¡ä¹Ÿå…·æœ‰å¾ˆå¤šæ–¹æ³•å’Œå±æ€§ã€‚ createElement åˆ›å»ºå…ƒç´  12const div = document.createElement(&apos;div&apos;)div.appendChild() getElementById è·å–å…ƒç´  12const div = document.getElementById(&apos;id&apos;)div.appendChild() åˆ©ç”¨è¿™äº›æ–¹æ³•åˆ›å»ºå…ƒç´ ï¼Œç„¶åå°†å…ƒç´ æŒ‚è½½åˆ°å·²æœ‰çš„ dom (app)ä¸Šï¼ŒReactï¼ŒVue æ¡†æ¶æœ€æ ¸å¿ƒçš„åŸç†ä¸è¿‡å¦‚æ­¤ cookie cookie å¯¹è±¡æ˜¯ document çš„å±æ€§ï¼Œå½“è®¿é—®åŒæºçš„ç½‘ç«™æ˜¯ï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬å§ cookie å¯¹è±¡ä¼ è¿‡å»ï¼Œcookie å¯¹è±¡é€šå¸¸åŒ…å«äº†ç”¨æˆ·ä¿¡æ¯ï¼ŒæœåŠ¡ç«¯å¯ä»¥é€šè¿‡ cookie åˆ¤æ–­ç”¨æˆ·çš„çŠ¶æ€ï¼Œcookie é»˜è®¤æ˜¯æŒä¹…åŒ–ä¿å­˜çš„ location location å¯¹è±¡å³ window çš„ location å¯¹è±¡ 12document.location == window.location// true URL è¿”å›å½“å‰çš„ url open ä¸ window çš„ open ä¸åŒï¼Œ document çš„ open æ˜¯æ“ä½œ document å¯¹è±¡ï¼Œæ‰“å¼€ä¸€ä¸ª document çš„è¾“å…¥æµï¼Œopen å°†ä¼šæ¸…ç©ºå½“å‰çš„æ–‡æ¡£ close å…³é—­æ–‡æ¡£æµ 12345document.open(); document.write(&quot;&lt;p&gt;Hello world!&lt;/p&gt;&quot;);document.write(&quot;&lt;p&gt;I am a fish&lt;/p&gt;&quot;);document.write(&quot;&lt;p&gt;The number is 42&lt;/p&gt;&quot;); document.close(); æ€»ç»“ window å¯¹è±¡åšå¤§ç²¾æ·±ï½","categories":[{"name":"JavaScript","slug":"JavaScript","permalink":"https://wzes.github.io/categories/JavaScript/"}],"tags":[{"name":"JavaScript","slug":"JavaScript","permalink":"https://wzes.github.io/tags/JavaScript/"}]},{"title":"koa-bodyparser æºç è§£æ","slug":"JavaScript/koa-bodyparser","date":"2019-09-08T10:56:00.000Z","updated":"2019-09-08T15:31:51.951Z","comments":true,"path":"2019/09/08/JavaScript/koa-bodyparser/","link":"","permalink":"https://wzes.github.io/2019/09/08/JavaScript/koa-bodyparser/","excerpt":"","text":"å‰è¨€ å‰é¢æˆ‘ä»¬å·²ç»æŠŠã€è£¸é…ã€‘ Koa å­¦ä¹ äº†ä¸€ä¸‹ï¼Œå­¦å®Œäº†ä»¥åå¥½åƒå¹¶æ²¡æœ‰ä»€ä¹ˆå¥½ç”¨çš„ä¸œè¥¿ï¼Œç„¶è€Œè¿™ç©æ„å°±åƒä¸€ä¸ªå·¨å¤§çš„å¹³å°ï¼Œå®¹æ˜“é›†æˆå„ç§å°æ’ä»¶ï¼Œæ¥è¾¾åˆ°å„ç§å„æ ·çš„åŠŸèƒ½ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å­¦ä¹ ä¸€ä¸ª koa-bodyparser è¿™æ­ŒçŸ­å°ç²¾æ‚çš„åº“ï¼ HelloWorld å½“æˆ‘çš„ hello world å¦‚æ­¤ç®€å•çš„æ—¶å€™ï¼Œæˆ‘æƒ³å‘ä¸€ä¸ª POST è¯·æ±‚ï¼Œé‚£ä¹ˆæˆ‘æ€ä¹ˆæ‹¿åˆ° POST è¯·æ±‚çš„å‚æ•°å‘¢ï¼Œæˆ‘ä»¬ ctx.request.body æ˜¯ç©ºçš„ï¼ŒKoa åŸå£°çš„æ¡†æ¶å¹¶æ²¡æœ‰å¸®æˆ‘ä»¬è§£æ POST çš„è¯·æ±‚æ•°æ®ã€‚æ‰€ä»¥æˆ‘ä»¬å°±éœ€è¦åŠ å…¥ koa-bodyparser ä¸­é—´ä»¶ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ ctx.request.body æ‹¿åˆ°æ•°æ®äº†ã€‚ 1234567const Koa = require(&apos;koa&apos;);const app = new Koa();app.use(async ctx =&gt; &#123; // ctx.body = ctx.query.param; console.log( ctx.request.body)&#125;);app.listen(3000); é¦–å…ˆå®‰è£…è¿™ä¸ªåº“ï¼š 1npm install koa-bodyparser --save ç„¶åå†ä»£ç ä¸­åŠ å…¥è¿™ä¸ªä¸­é—´ä»¶ï¼š 12345678910111213const Koa = require(&apos;koa&apos;);const bodyParser = require(&apos;koa-bodyparser&apos;)const app = new Koa();app.use(bodyParser());app.use(async ctx =&gt; &#123; ctx.body = ctx.request.body.param; console.log(ctx.request.body)&#125;);app.listen(3000); è¿™æ—¶å€™ ctx.request.body ä¾¿æ˜¯ä¸€ä¸ªè§£æå¥½çš„å¯¹è±¡äº†ï¼Œç›´æ¥å–å¯¹è±¡çš„å±æ€§å°±å¯ä»¥äº† é¢˜å¤–è¯ åŸå£°çš„ NodeJS é€šè¿‡ createServer ä¹Ÿæ˜¯æ²¡æœ‰åŠæ³•ç›´æ¥å–åˆ° post çš„å‚æ•°çš„ï¼Œè¿˜æ˜¯éœ€è¦åšä¸€äº›è¯»å–æ•°æ®çš„æ“ä½œæ‰å¯ä»¥ æºç è§£æ bodyParser ä½œä¸ºä¸€ä¸ªä¸­é—´ä»¶ï¼Œéœ€è¦è¿”å›ä¸€ä¸ª async å‡½æ•°ï¼Œåœ¨è¿™ä¸ªå‡½æ•°çš„æœ€åè°ƒç”¨ next()ï¼Œå…³é”®éƒ¨åˆ†æ˜¯ parseBody å‡½æ•°ï¼Œå°† request è¿›è¡Œè§£æï¼Œå¹¶å°†ç»“æœè¿”å›èµ‹å€¼ç»™ ctx.request.body 12345678910111213141516return async function bodyParser(ctx, next) &#123; if (ctx.request.body !== undefined) return await next(); if (ctx.disableBodyParser) return await next(); try &#123; const res = await parseBody(ctx); ctx.request.body = &apos;parsed&apos; in res ? res.parsed : &#123;&#125;; if (ctx.request.rawBody === undefined) ctx.request.rawBody = res.raw; &#125; catch (err) &#123; if (onerror) &#123; onerror(err, ctx); &#125; else &#123; throw err; &#125; &#125; await next(); &#125;; parseBody ctx.request.is å¯ä»¥æ£€æŸ¥ request ã€Content-Typeã€‘ è¯·æ±‚çš„ç±»å‹æ˜¯å¦æ˜¯å½“ä¸­çš„ä¸€ä¸ªï¼Œä¸€èˆ¬æƒ…å†µä¸‹ä»¥ form å±…å¤šï¼Œå³ application/x-www-form-urlencoded 123456789101112async function parseBody(ctx) &#123; if (enableJson &amp;&amp; ((detectJSON &amp;&amp; detectJSON(ctx)) || ctx.request.is(jsonTypes))) &#123; return await parse.json(ctx, jsonOpts); &#125; if (enableForm &amp;&amp; ctx.request.is(formTypes)) &#123; return await parse.form(ctx, formOpts); &#125; if (enableText &amp;&amp; ctx.request.is(textTypes)) &#123; return await parse.text(ctx, textOpts) || &apos;&apos;; &#125; return &#123;&#125;; &#125; parse.form ä¸»è¦æ˜¯ raw(inflate(req), opts) æ–¹æ³•ï¼Œå°†è¯·æ±‚çš„å‚æ•°è½¬åŒ–ä¸ºä¸€ä¸ª string 1234567891011121314151617181920212223242526module.exports = async function(req, opts) &#123; req = req.req || req; opts = utils.clone(opts); const queryString = opts.queryString || &#123;&#125;; // keep compatibility with qs@4 if (queryString.allowDots === undefined) queryString.allowDots = true; // defaults const len = req.headers[&apos;content-length&apos;]; const encoding = req.headers[&apos;content-encoding&apos;] || &apos;identity&apos;; if (len &amp;&amp; encoding === &apos;identity&apos;) opts.length = ~~len; opts.encoding = opts.encoding || &apos;utf8&apos;; opts.limit = opts.limit || &apos;56kb&apos;; opts.qs = opts.qs || qs; const str = await raw(inflate(req), opts); try &#123; const parsed = opts.qs.parse(str, queryString); return opts.returnRawBody ? &#123; parsed, raw: str &#125; : parsed; &#125; catch (err) &#123; err.status = 400; err.body = str; throw err; &#125;&#125;; raw è¯»å– body æ•°æ®ï¼Œ 123456789function getRawBody (stream, options, callback) &#123; return new Promise(function executor (resolve, reject) &#123; readStream(stream, encoding, length, limit, function onRead (err, buf) &#123; if (err) return reject(err) resolve(buf) &#125;) &#125;)&#125; é€‰å–äº† onData å‡½æ•°ï¼Œå¯ä»¥æ¥å—æµæ•°æ®ï¼Œä»¥å­—ç¬¦ä¸²å½¢å¼ï¼Œç»“æŸåç›´æ¥è¿”å› å­—ç¬¦ä¸²å³å¯ï¼Œæ•°æ®ä¸º bufferï¼Œä½¿ç”¨ buffer.toString() å°±å¯ä»¥è½¬åŒ–ä¸ºå­—ç¬¦ä¸²ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445function readStream (stream, encoding, length, limit, callback) &#123; // attach listeners stream.on(&apos;aborted&apos;, onAborted) stream.on(&apos;close&apos;, cleanup) stream.on(&apos;data&apos;, onData) stream.on(&apos;end&apos;, onEnd) stream.on(&apos;error&apos;, onEnd) function onData (chunk) &#123; if (complete) return received += chunk.length if (limit !== null &amp;&amp; received &gt; limit) &#123; done(createError(413, &apos;request entity too large&apos;, &#123; limit: limit, received: received, type: &apos;entity.too.large&apos; &#125;)) &#125; else if (decoder) &#123; buffer += decoder.write(chunk) &#125; else &#123; buffer.push(chunk) &#125; &#125; function onEnd (err) &#123; if (complete) return if (err) return done(err) if (length !== null &amp;&amp; received !== length) &#123; done(createError(400, &apos;request size did not match content length&apos;, &#123; expected: length, length: length, received: received, type: &apos;request.size.invalid&apos; &#125;)) &#125; else &#123; var string = decoder ? buffer + (decoder.end() || &apos;&apos;) : Buffer.concat(buffer) done(null, string) &#125; &#125;&#125; åœ¨ onEnd ä¸­è¿”å›å­—ç¬¦ä¸² å†™åœ¨æœ€å koa-bodyparser ä¸ä»…åšäº† post çš„è½¬åŒ–ï¼Œè¿˜æœ‰ä¸€äº›å¯é€‰çš„å‚æ•°ï¼Œæ¯”å¦‚è¯´ä¼ è¾“ç±»å‹ï¼Œå¤§å°é™åˆ¶ï¼Œè¿™äº›éƒ½æ˜¯å¯ä»¥é€šè¿‡å‚æ•°è¿›è¡Œé…ç½®çš„ã€‚æºç åšå¤§ç²¾æ·±å•Šï¼","categories":[{"name":"JavaScript","slug":"JavaScript","permalink":"https://wzes.github.io/categories/JavaScript/"}],"tags":[{"name":"JavaScript","slug":"JavaScript","permalink":"https://wzes.github.io/tags/JavaScript/"},{"name":"Node","slug":"Node","permalink":"https://wzes.github.io/tags/Node/"},{"name":"Koa","slug":"Koa","permalink":"https://wzes.github.io/tags/Koa/"}]},{"title":"JavaScript Array çš„ 1 ä¸ªå±æ€§ï¼Œ35 ä¸ªæ–¹æ³•","slug":"JavaScript/JavaScript Array","date":"2019-09-01T07:30:16.000Z","updated":"2019-09-07T04:15:12.383Z","comments":true,"path":"2019/09/01/JavaScript/JavaScript Array/","link":"","permalink":"https://wzes.github.io/2019/09/01/JavaScript/JavaScript Array/","excerpt":"","text":"å‰è¨€ è¿™å‘¨å‘¢ï¼Œå½»åº•å­¦ä¹ ä¸€ä¸‹ Array çš„æ‰€æœ‰æ–¹æ³•ã€‚å­¦ä¹ åœ°å€ MDNï¼Œé‡Œé¢è¿˜æœ‰å„ä¸ªå‡½æ•°å®ç°çš„æºç ï¼æ•°ç»„ä½œä¸º JavaScript çš„ä¸€ç§ç‰¹æ®Šçš„å¯¹è±¡ç±»å‹ï¼Œä¸ Numberï¼ŒBooleanï¼ŒNullï¼ŒStringï¼ŒUndefinedï¼ŒSymbol ä¸ƒå¤§æ•°æ®ç±»å‹æœ‰æ‰€ä¸ä¸€æ ·ã€‚äº†è§£ Array çš„æ‰€æœ‰æ–¹æ³•ï¼Œèƒ½å¸®åŠ©æˆ‘ä»¬æœ€å¿«æ‰¾åˆ°é€‚åˆè‡ªå·±çš„å‡½æ•°ã€‚ Create an Array åˆ›å»ºä¸€ä¸ªæ•°ç»„å¾ˆç®€å•ï¼Œç›´æ¥èµ‹å€¼ï¼Œæˆ–è€…ä½¿ç”¨ [] åˆ›å»ºç©ºæ•°ç»„ 12var fruits = [&apos;Apple&apos;, &apos;Banana&apos;];console.log(fruits.length); // 2 Properties Array.length 123456var clothing = [&apos;shoes&apos;, &apos;shirts&apos;, &apos;socks&apos;, &apos;sweaters&apos;];console.log(clothing.length);// expected output: 4var array = new Array(2) Methods é¦–å…ˆçœ‹ä¸€ä¸‹ Array çš„ä¸‰ä¸ªé™æ€æ–¹æ³• #####1. Array.from() Array.from() æ–¹æ³•ä»ç±»ä¼¼æ•°ç»„æˆ–å¯è¿­ä»£çš„å¯¹è±¡åˆ›å»ºä¸€ä¸ªæ–°çš„ï¼Œæµ…æ‹·è´çš„ Array å®ä¾‹ï¼Œæˆ–è€…ä» {length: 3} å¯¹è±¡ä¸­åˆ›å»ºå›ºå®šé•¿åº¦çš„ undefined æ•°ç»„ Array.from(arrayLike[, mapFn[, thisArg]]) 12345678console.log(Array.from(&apos;foo&apos;));// expected output: Array [&quot;f&quot;, &quot;o&quot;, &quot;o&quot;]console.log(Array.from([1, 2, 3], x =&gt; x + x));// expected output: Array [2, 4, 6]console.log(Array.from(&#123;length: 3&#125;));// expected output: Array [undefined, undefined, undefined] 2. Array.isArray() Array.isArray() æ–¹æ³•ç¡®å®šä¼ é€’çš„å€¼æ˜¯å¦ä¸º Arrayï¼Œç”±äº typeof Array = â€˜objectâ€™ ï¼Œæ‰€ä»¥åˆ¤æ–­æ˜¯å¦æ˜¯ä¸€ä¸ªæ•°ç»„ä½¿ç”¨ isArray æ‰å¯ä»¥ Array.isArray(value) 1234Array.isArray([1, 2, 3]); // trueArray.isArray(&#123;foo: 123&#125;); // falseArray.isArray(&apos;foobar&apos;); // falseArray.isArray(undefined); // false 3. Array.of() Array.of() æ–¹æ³•ä»å¯å˜æ•°é‡çš„å‚æ•°åˆ›å»ºä¸€ä¸ªæ–°çš„Arrayå®ä¾‹ï¼Œæ— è®ºå‚æ•°çš„æ•°é‡æˆ–ç±»å‹å¦‚ä½• æ³¨æ„å®ƒä¸æ„é€ å‡½æ•°çš„ä¸åŒä¹‹å¤„ Array.of(element0[, element1[, â€¦[, elementN]]]) 12345Array.of(7); // [7] Array.of(1, 2, 3); // [1, 2, 3]Array(7); // array of 7 empty slotsArray(1, 2, 3); // [1, 2, 3] æ¥ä¸‹æ¥çœ‹ Array çš„å¯¹è±¡æ–¹æ³• 4. Array.prototype.concat() concat() æ–¹æ³•ç”¨äºåˆå¹¶ä¸¤ä¸ªæˆ–å¤šä¸ªæ•°ç»„ã€‚ æ­¤æ–¹æ³•ä¸ä¼šæ›´æ”¹ç°æœ‰æ•°ç»„ï¼Œè€Œæ˜¯è¿”å›ä¸€ä¸ªæ–°æ•°ç»„ var new_array = old_array.concat([value1[, value2[, â€¦[, valueN]]]]) 12345var array1 = [&apos;a&apos;, &apos;b&apos;, &apos;c&apos;];var array2 = [&apos;d&apos;, &apos;e&apos;, &apos;f&apos;];console.log(array1.concat(array2));// expected output: Array [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;, &quot;d&quot;, &quot;e&quot;, &quot;f&quot;] 5. Array.prototype.copyWithin() copyWithin() æ–¹æ³•æµ…æå°†æ•°ç»„çš„ä¸€éƒ¨åˆ†å¤åˆ¶åˆ°åŒä¸€æ•°ç»„ä¸­çš„å¦ä¸€ä¸ªä½ç½®ï¼Œå¹¶è¿”å›å®ƒè€Œä¸ä¿®æ”¹å…¶é•¿åº¦ arr.copyWithin(target[, start[, end]]) 123456789var array1 = [&apos;a&apos;, &apos;b&apos;, &apos;c&apos;, &apos;d&apos;, &apos;e&apos;];// copy to index 0 the element at index 3console.log(array1.copyWithin(0, 3, 4));// expected output: Array [&quot;d&quot;, &quot;b&quot;, &quot;c&quot;, &quot;d&quot;, &quot;e&quot;]// copy to index 1 all elements from index 3 to the endconsole.log(array1.copyWithin(1, 3));// expected output: Array [&quot;d&quot;, &quot;d&quot;, &quot;e&quot;, &quot;d&quot;, &quot;e&quot;] 6. Array.prototype.entries() entries() æ–¹æ³•è¿”å›ä¸€ä¸ªæ–°çš„Array Iteratorå¯¹è±¡ï¼Œè¯¥å¯¹è±¡åŒ…å«æ•°ç»„ä¸­æ¯ä¸ªç´¢å¼•çš„é”®/å€¼å¯¹ã€‚ array.entries() 1234567891011121314151617181920var array1 = [&apos;a&apos;, &apos;b&apos;, &apos;c&apos;];var iterator1 = array1.entries();console.log(iterator1.next().value);// expected output: Array [0, &quot;a&quot;]console.log(iterator1.next().value);// expected output: Array [1, &quot;b&quot;]// ä½¿ç”¨ for of éå†var a = [&apos;a&apos;, &apos;b&apos;, &apos;c&apos;];var iterator = a.entries();for (let e of iterator) &#123; console.log(e);&#125;// [0, &apos;a&apos;]// [1, &apos;b&apos;]// [2, &apos;c&apos;] 7. Array.prototype.every() every() æ–¹æ³•æµ‹è¯•æ•°ç»„ä¸­çš„æ‰€æœ‰å…ƒç´ æ˜¯å¦éƒ½é€šè¿‡äº†ç”±æä¾›çš„å‡½æ•°å®ç°çš„æµ‹è¯•ã€‚ å®ƒè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ arr.every(callback(element[, index[, array]])[, thisArg]) 12345678function isBelowThreshold(currentValue) &#123; return currentValue &lt; 40;&#125;var array1 = [1, 30, 39, 29, 10, 13];console.log(array1.every(isBelowThreshold));// expected output: true 8. Array.prototype.fill() fill() æ–¹æ³•ä½¿ç”¨é™æ€å€¼ä»å¼€å§‹ç´¢å¼•ï¼ˆé»˜è®¤ä¸ºé›¶ï¼‰åˆ°ç»“æŸç´¢å¼•ï¼ˆé»˜è®¤æ•°ç»„é•¿åº¦ï¼‰å¡«å……ï¼ˆä¿®æ”¹ï¼‰æ•°ç»„çš„æ‰€æœ‰å…ƒç´ ã€‚ å®ƒè¿”å›ä¿®æ”¹åçš„æ•°ç»„ï¼ŒåŸæ•°ç»„ä¼šæ”¹å˜ï½ arr.fill(value[, start[, end]]) 123456789101112 var array1 = [1, 2, 3, 4];// fill with 0 from position 2 until position 4console.log(array1.fill(0, 2, 4));// expected output: [1, 2, 0, 0]// fill with 5 from position 1console.log(array1.fill(5, 1));// expected output: [1, 5, 5, 5]console.log(array1.fill(6));// expected output: [6, 6, 6, 6] 9. Array.prototype.filter() filter() æ–¹æ³•åˆ›å»ºä¸€ä¸ªæ–°æ•°ç»„ï¼Œå…¶ä¸­åŒ…å«æ‰€æœ‰ä¼ é€’ç”±æä¾›çš„å‡½æ•°å®ç°çš„æµ‹è¯•çš„å…ƒç´  var newArray = arr.filter(callback(element[, index[, array]])[, thisArg]) 123456var words = [&apos;spray&apos;, &apos;limit&apos;, &apos;elite&apos;, &apos;exuberant&apos;, &apos;destruction&apos;, &apos;present&apos;];const result = words.filter(word =&gt; word.length &gt; 6);console.log(result);// expected output: Array [&quot;exuberant&quot;, &quot;destruction&quot;, &quot;present&quot;] 10. Array.prototype.find() find() æ–¹æ³•è¿”å›æ•°ç»„ä¸­ç¬¬ä¸€ä¸ªæ»¡è¶³æä¾›çš„æµ‹è¯•å‡½æ•°çš„å…ƒç´ çš„å€¼ã€‚ å¦åˆ™è¿”å›undefined arr.find(callback(element[, index[, array]])[, thisArg]) 12345678var array1 = [5, 12, 8, 130, 44];var found = array1.find(function(element) &#123; return element &gt; 10;&#125;);console.log(found);// expected output: 12 11. Array.prototype.findIndex() findIndex() æ–¹æ³•è¿”å›æ•°ç»„ä¸­ç¬¬ä¸€ä¸ªæ»¡è¶³æä¾›çš„æµ‹è¯•å‡½æ•°çš„å…ƒç´ çš„ç´¢å¼•ã€‚ å¦åˆ™ï¼Œå®ƒè¿”å›-1ï¼Œè¡¨ç¤ºæ²¡æœ‰å…ƒç´ é€šè¿‡æµ‹è¯• arr.findIndex(callback(element[, index[, array]])[, thisArg]) 1234567var array1 = [5, 12, 8, 130, 44];function isLargeNumber(element) &#123; return element &gt; 13;&#125;console.log(array1.findIndex(isLargeNumber)); 12. Array.prototype.flat() flat() æ–¹æ³•åˆ›å»ºä¸€ä¸ªæ–°æ•°ç»„ï¼Œæ‰€æœ‰å­æ•°ç»„å…ƒç´ ä»¥é€’å½’æ–¹å¼è¿æ¥åˆ°æŒ‡å®šçš„æ·±åº¦ã€‚ var newArray = arr.flat([depth]); 123456789101112131415var arr1 = [1, 2, [3, 4]];arr1.flat(); // [1, 2, 3, 4]var arr2 = [1, 2, [3, 4, [5, 6]]];arr2.flat();// [1, 2, 3, 4, [5, 6]]var arr3 = [1, 2, [3, 4, [5, 6]]];arr3.flat(2);// [1, 2, 3, 4, 5, 6]var arr4 = [1, 2, [3, 4, [5, 6, [7, 8, [9, 10]]]]];arr4.flat(Infinity);// [1, 2, 3, 4, 5, 6, 7, 8, 9, 10] 13. Array.prototype.flatMap() flatMap() æ–¹æ³•é¦–å…ˆä½¿ç”¨æ˜ å°„å‡½æ•°æ˜ å°„æ¯ä¸ªå…ƒç´ ï¼Œç„¶åå°†ç»“æœå±•å¹³ä¸ºæ–°æ•°ç»„ã€‚ å®ƒä¸mapï¼ˆï¼‰åè·Ÿæ·±åº¦ä¸º1çš„flatï¼ˆï¼‰ç›¸åŒï¼Œä½†flatMapï¼ˆï¼‰é€šå¸¸éå¸¸æœ‰ç”¨ï¼Œå› ä¸ºå°†ä¸¤è€…åˆå¹¶åˆ°ä¸€ä¸ªæ–¹æ³•ä¸­æ•ˆç‡ç¨é«˜ var new_array = arr.flatMap(function callback(currentValue[, index[, array]]) { // return element for new_array }[, thisArg]) 1234567let arr1 = [&quot;it&apos;s Sunny in&quot;, &quot;&quot;, &quot;California&quot;];arr1.map(x =&gt; x.split(&quot; &quot;));// [[&quot;it&apos;s&quot;,&quot;Sunny&quot;,&quot;in&quot;],[&quot;&quot;],[&quot;California&quot;]]arr1.flatMap(x =&gt; x.split(&quot; &quot;));// [&quot;it&apos;s&quot;,&quot;Sunny&quot;,&quot;in&quot;, &quot;&quot;, &quot;California&quot;] 14. Array.prototype.forEach() forEach() æ–¹æ³•ä¸ºæ¯ä¸ªæ•°ç»„å…ƒç´ æ‰§è¡Œä¸€æ¬¡æä¾›çš„å‡½æ•° arr.forEach(callback(currentValue [, index [, array]])[, thisArg]); 123456789var array1 = [&apos;a&apos;, &apos;b&apos;, &apos;c&apos;];array1.forEach(function(element) &#123; console.log(element);&#125;);// expected output: &quot;a&quot;// expected output: &quot;b&quot;// expected output: &quot;c&quot; 15. Array.prototype.includes() includes() æ–¹æ³•ç¡®å®šæ•°ç»„æ˜¯å¦åœ¨å…¶æ¡ç›®ä¸­åŒ…å«æŸä¸ªå€¼ï¼Œå¹¶åœ¨é€‚å½“æ—¶è¿”å›trueæˆ–false arr.includes(valueToFind[, fromIndex]) 123456789101112var array1 = [1, 2, 3];console.log(array1.includes(2));// expected output: truevar pets = [&apos;cat&apos;, &apos;dog&apos;, &apos;bat&apos;];console.log(pets.includes(&apos;cat&apos;));// expected output: trueconsole.log(pets.includes(&apos;at&apos;));// expected output: false 16. Array.prototype.indexOf() indexOf() æ–¹æ³•è¿”å›å¯åœ¨æ•°ç»„ä¸­æ‰¾åˆ°ç»™å®šå…ƒç´ çš„ç¬¬ä¸€ä¸ªç´¢å¼•ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è¿”å›-1 arr.indexOf(searchElement[, fromIndex]) 1234567891011var beasts = [&apos;ant&apos;, &apos;bison&apos;, &apos;camel&apos;, &apos;duck&apos;, &apos;bison&apos;];console.log(beasts.indexOf(&apos;bison&apos;));// expected output: 1// start from index 2console.log(beasts.indexOf(&apos;bison&apos;, 2));// expected output: 4console.log(beasts.indexOf(&apos;giraffe&apos;));// expected output: -1 17. Array.prototype.join() join() æ–¹æ³•é€šè¿‡è¿æ¥æ•°ç»„ï¼ˆæˆ–ç±»æ•°ç»„å¯¹è±¡ï¼‰ä¸­çš„æ‰€æœ‰å…ƒç´ ï¼ˆç”¨é€—å·æˆ–æŒ‡å®šçš„åˆ†éš”ç¬¦å­—ç¬¦ä¸²åˆ†éš”ï¼‰æ¥åˆ›å»ºå¹¶è¿”å›ä¸€ä¸ªæ–°å­—ç¬¦ä¸²ã€‚ å¦‚æœæ•°ç»„åªæœ‰ä¸€ä¸ªé¡¹ç›®ï¼Œé‚£ä¹ˆå°†è¿”å›è¯¥é¡¹ç›®è€Œä¸ä½¿ç”¨åˆ†éš”ç¬¦ arr.join([separator]) 12345678910ar elements = [&apos;Fire&apos;, &apos;Air&apos;, &apos;Water&apos;];console.log(elements.join());// expected output: &quot;Fire,Air,Water&quot;console.log(elements.join(&apos;&apos;));// expected output: &quot;FireAirWater&quot;console.log(elements.join(&apos;-&apos;));// expected output: &quot;Fire-Air-Water&quot; 18. Array.prototype.keys() keys() æ–¹æ³•è¿”å›ä¸€ä¸ªæ–°çš„Array Iteratorå¯¹è±¡ï¼Œè¯¥å¯¹è±¡åŒ…å«æ•°ç»„ä¸­æ¯ä¸ªç´¢å¼•çš„é”® 123456var array1 = [&apos;a&apos;, &apos;b&apos;, &apos;c&apos;];var iterator = array1.keys(); for (let key of iterator) &#123; console.log(key); // expected output: 0 1 2&#125; 19. Array.prototype.lastIndexOf() lastIndexOf() æ–¹æ³•è¿”å›å¯åœ¨æ•°ç»„ä¸­æ‰¾åˆ°ç»™å®šå…ƒç´ çš„æœ€åä¸€ä¸ªç´¢å¼•ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è¿”å›-1ã€‚ ä»fromIndexå¼€å§‹å‘åæœç´¢æ•°ç»„ arr.lastIndexOf(searchElement[, fromIndex]) 1234567var animals = [&apos;Dodo&apos;, &apos;Tiger&apos;, &apos;Penguin&apos;, &apos;Dodo&apos;];console.log(animals.lastIndexOf(&apos;Dodo&apos;));// expected output: 3console.log(animals.lastIndexOf(&apos;Penguin&apos;, 1));// expected output: -1 20. Array.prototype.map() map() æ–¹æ³•åˆ›å»ºä¸€ä¸ªæ–°æ•°ç»„ï¼Œå…¶ç»“æœæ˜¯åœ¨è°ƒç”¨æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ ä¸Šè°ƒç”¨æä¾›çš„å‡½æ•° var new_array = arr.map(function callback(currentValue[, index[, array]]) { // Return element for new_array }[, thisArg]) 1234567var array1 = [1, 4, 9, 16];// pass a function to mapconst map1 = array1.map(x =&gt; x * 2);console.log(map1);// expected output: Array [2, 8, 18, 32] 21. Array.prototype.pop() pop() æ–¹æ³•ä»æ•°ç»„ä¸­åˆ é™¤æœ€åä¸€ä¸ªå…ƒç´ å¹¶è¿”å›è¯¥å…ƒç´ ã€‚ æ­¤æ–¹æ³•æ›´æ”¹æ•°ç»„çš„é•¿åº¦ã€‚ arr.pop() 123456789101112var plants = [&apos;broccoli&apos;, &apos;cauliflower&apos;, &apos;cabbage&apos;, &apos;kale&apos;, &apos;tomato&apos;];console.log(plants.pop());// expected output: &quot;tomato&quot;console.log(plants);// expected output: Array [&quot;broccoli&quot;, &quot;cauliflower&quot;, &quot;cabbage&quot;, &quot;kale&quot;]plants.pop();console.log(plants);// expected output: Array [&quot;broccoli&quot;, &quot;cauliflower&quot;, &quot;cabbage&quot;] 22. Array.prototype.push() push() æ–¹æ³•å°†ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´ æ·»åŠ åˆ°æ•°ç»„çš„æœ«å°¾ï¼Œå¹¶è¿”å›æ•°ç»„çš„æ–°é•¿åº¦ arr.push(element1[, â€¦[, elementN]]) 123456789101112var animals = [&apos;pigs&apos;, &apos;goats&apos;, &apos;sheep&apos;];console.log(animals.push(&apos;cows&apos;));// expected output: 4console.log(animals);// expected output: Array [&quot;pigs&quot;, &quot;goats&quot;, &quot;sheep&quot;, &quot;cows&quot;]animals.push(&apos;chickens&apos;);console.log(animals);// expected output: Array [&quot;pigs&quot;, &quot;goats&quot;, &quot;sheep&quot;, &quot;cows&quot;, &quot;chickens&quot;] 23. Array.prototype.reduce() reduce() æ–¹æ³•åœ¨æ•°ç»„çš„æ¯ä¸ªå…ƒç´ ä¸Šæ‰§è¡Œreducerå‡½æ•°ï¼ˆæ‚¨æä¾›ï¼‰ï¼Œä»è€Œäº§ç”Ÿå•ä¸ªè¾“å‡ºå€¼ arr.reduce(callback(accumulator, currentValue[, index[, array]])[, initialValue]) 12345678910const array1 = [1, 2, 3, 4];const reducer = (accumulator, currentValue) =&gt; accumulator + currentValue;// 1 + 2 + 3 + 4console.log(array1.reduce(reducer));// expected output: 10// 5 + 1 + 2 + 3 + 4console.log(array1.reduce(reducer, 5));// expected output: 15 24. Array.prototype.reduceRight() reduceRight() æ–¹æ³•å¯¹ç´¯åŠ å™¨å’Œæ•°ç»„çš„æ¯ä¸ªå€¼ï¼ˆä»å³åˆ°å·¦ï¼‰åº”ç”¨å‡½æ•°ä»¥å°†å…¶å‡å°‘ä¸ºå•ä¸ªå€¼ arr.reduceRight(callback(accumulator, currentValue[, index[, array]])[, initialValue]) 123456const array1 = [[0, 1], [2, 3], [4, 5]].reduceRight( (accumulator, currentValue) =&gt; accumulator.concat(currentValue));console.log(array1);// expected output: Array [4, 5, 2, 3, 0, 1] 25. Array.prototype.reverse() reverse() æ–¹æ³•å°†æ•°ç»„åè½¬åˆ°ä½ã€‚ ç¬¬ä¸€ä¸ªæ•°ç»„å…ƒç´ æˆä¸ºæœ€åä¸€ä¸ªï¼Œæœ€åä¸€ä¸ªæ•°ç»„å…ƒç´ æˆä¸ºç¬¬ä¸€ä¸ª a.reverse() 123456789101112var array1 = [&apos;one&apos;, &apos;two&apos;, &apos;three&apos;];console.log(&apos;array1: &apos;, array1);// expected output: Array [&apos;one&apos;, &apos;two&apos;, &apos;three&apos;]var reversed = array1.reverse(); console.log(&apos;reversed: &apos;, reversed);// expected output: Array [&apos;three&apos;, &apos;two&apos;, &apos;one&apos;]/* Careful: reverse is destructive. It also changesthe original array */ console.log(&apos;array1: &apos;, array1);// expected output: Array [&apos;three&apos;, &apos;two&apos;, &apos;one&apos;] 26. Array.prototype.shift() shift() æ–¹æ³•ä»æ•°ç»„ä¸­åˆ é™¤ç¬¬ä¸€ä¸ªå…ƒç´ å¹¶è¿”å›å·²åˆ é™¤çš„å…ƒç´ ã€‚ æ­¤æ–¹æ³•æ›´æ”¹æ•°ç»„çš„é•¿åº¦ arr.shift() 123456789var array1 = [1, 2, 3];var firstElement = array1.shift();console.log(array1);// expected output: Array [2, 3]console.log(firstElement);// expected output: 1 27. Array.prototype.slice() slice() æ–¹æ³•å°†æ•°ç»„çš„ä¸€éƒ¨åˆ†çš„æµ…è¡¨å‰¯æœ¬è¿”å›åˆ°ä»å¤´åˆ°å°¾é€‰æ‹©çš„æ–°æ•°ç»„å¯¹è±¡ï¼ˆä¸åŒ…æ‹¬ç»“å°¾ï¼‰ï¼Œå…¶ä¸­beginå’Œendè¡¨ç¤ºè¯¥æ•°ç»„ä¸­é¡¹çš„ç´¢å¼•ã€‚ åŸå§‹æ•°ç»„ä¸ä¼šè¢«ä¿®æ”¹ arr.slice([begin[, end]]) 12345678910var animals = [&apos;ant&apos;, &apos;bison&apos;, &apos;camel&apos;, &apos;duck&apos;, &apos;elephant&apos;];console.log(animals.slice(2));// expected output: Array [&quot;camel&quot;, &quot;duck&quot;, &quot;elephant&quot;]console.log(animals.slice(2, 4));// expected output: Array [&quot;camel&quot;, &quot;duck&quot;]console.log(animals.slice(1, 5));// expected output: Array [&quot;bison&quot;, &quot;camel&quot;, &quot;duck&quot;, &quot;elephant&quot;] 28. # Array.prototype.some() some() æ–¹æ³•æµ‹è¯•æ•°ç»„ä¸­æ˜¯å¦è‡³å°‘æœ‰ä¸€ä¸ªå…ƒç´ é€šè¿‡äº†ç”±æä¾›çš„å‡½æ•°å®ç°çš„æµ‹è¯•ã€‚ å®ƒè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ arr.some(callback(element[, index[, array]])[, thisArg]) 123456789var array = [1, 2, 3, 4, 5];var even = function(element) &#123; // checks whether an element is even return element % 2 === 0;&#125;;console.log(array.some(even));// expected output: true 29. Array.prototype.sort() sort() æ–¹æ³•å¯¹æ•°ç»„ä¸­çš„å…ƒç´ è¿›è¡Œæ’åºå¹¶è¿”å›å·²æ’åºçš„æ•°ç»„ã€‚ é»˜è®¤æ’åºé¡ºåºæ˜¯åœ¨å°†å…ƒç´ è½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼Œç„¶åæ¯”è¾ƒå®ƒä»¬çš„UTF-16ä»£ç å•å…ƒå€¼åºåˆ—æ—¶æ„å»ºçš„ã€‚ ç”±äºå–å†³äºå®ç°ï¼Œå› æ­¤æ— æ³•ä¿è¯æ’åºçš„æ—¶é—´å’Œç©ºé—´å¤æ‚æ€§ã€‚ arr.sort([compareFunction]) 123456789var months = [&apos;March&apos;, &apos;Jan&apos;, &apos;Feb&apos;, &apos;Dec&apos;];months.sort();console.log(months);// expected output: Array [&quot;Dec&quot;, &quot;Feb&quot;, &quot;Jan&quot;, &quot;March&quot;]var array1 = [1, 30, 4, 21, 100000];array1.sort();console.log(array1);// expected output: Array [1, 100000, 21, 30, 4] 30. Array.prototype.splice() splice() æ–¹æ³•é€šè¿‡åˆ é™¤æˆ–æ›¿æ¢ç°æœ‰å…ƒç´ å’Œ/æˆ–åœ¨é€‚å½“ä½ç½®æ·»åŠ æ–°å…ƒç´ æ¥æ›´æ”¹æ•°ç»„çš„å†…å®¹ var arrDeletedItems = array.splice(start[, deleteCount[, item1[, item2[, â€¦]]]]) 12345678910var months = [&apos;Jan&apos;, &apos;March&apos;, &apos;April&apos;, &apos;June&apos;];months.splice(1, 0, &apos;Feb&apos;);// inserts at index 1console.log(months);// expected output: Array [&apos;Jan&apos;, &apos;Feb&apos;, &apos;March&apos;, &apos;April&apos;, &apos;June&apos;]months.splice(4, 1, &apos;May&apos;);// replaces 1 element at index 4console.log(months);// expected output: Array [&apos;Jan&apos;, &apos;Feb&apos;, &apos;March&apos;, &apos;April&apos;, &apos;May&apos;] 31. Array.prototype.unshift() unshift() æ–¹æ³•å°†ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´ æ·»åŠ åˆ°æ•°ç»„çš„å¼€å¤´å¹¶è¿”å›æ•°ç»„çš„æ–°é•¿åº¦ arr.unshift(element1[, â€¦[, elementN]]) 1234567var array1 = [1, 2, 3];console.log(array1.unshift(4, 5));// expected output: 5console.log(array1);// expected output: Array [4, 5, 1, 2, 3] 32. Array.prototype.values() values() æ–¹æ³•è¿”å›ä¸€ä¸ªæ–°çš„Array Iteratorå¯¹è±¡ï¼Œè¯¥å¯¹è±¡åŒ…å«æ•°ç»„ä¸­æ¯ä¸ªç´¢å¼•çš„å€¼ arr.values() 123456const array1 = [&apos;a&apos;, &apos;b&apos;, &apos;c&apos;];const iterator = array1.values();for (const value of iterator) &#123; console.log(value); // expected output: &quot;a&quot; &quot;b&quot; &quot;c&quot;&#125; 33. Array.prototype.toLocaleString() toLocaleString() æ–¹æ³•è¿”å›è¡¨ç¤ºæ•°ç»„å…ƒç´ çš„å­—ç¬¦ä¸²ã€‚ ä½¿ç”¨toLocaleStringæ–¹æ³•å°†å…ƒç´ è½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼Œå¹¶ä¸”è¿™äº›å­—ç¬¦ä¸²ç”±ç‰¹å®šäºè¯­è¨€ç¯å¢ƒçš„å­—ç¬¦ä¸²ï¼ˆä¾‹å¦‚é€—å·â€œï¼Œâ€ï¼‰åˆ†éš” arr.toLocaleString([locales[, options]]); 123456var array1 = [1, &apos;a&apos;, new Date(&apos;21 Dec 1997 14:12:00 UTC&apos;)];var localeString = array1.toLocaleString(&apos;en&apos;, &#123;timeZone: &quot;UTC&quot;&#125;);console.log(localeString);// expected output: &quot;1,a,12/21/1997, 2:12:00 PM&quot;,// This assumes &quot;en&quot; locale and UTC timezone - your results may vary 34. Array.prototype.toString() toString() æ–¹æ³•è¿”å›è¡¨ç¤ºæŒ‡å®šæ•°ç»„åŠå…¶å…ƒç´ çš„å­—ç¬¦ä¸² arr.toString() 1234var array1 = [1, 2, &apos;a&apos;, &apos;1a&apos;];console.log(array1.toString());// expected output: &quot;1,2,a,1a&quot; 35. Array.prototype@@iterator @@iterator å±æ€§çš„åˆå§‹å€¼ä¸valuesï¼ˆï¼‰å±æ€§çš„åˆå§‹å€¼æ˜¯ç›¸åŒçš„å‡½æ•°å¯¹è±¡ã€‚ arrSymbol.iterator 12345678var arr = [&apos;a&apos;, &apos;b&apos;, &apos;c&apos;, &apos;d&apos;, &apos;e&apos;];var eArr = arr[Symbol.iterator]();// your browser must support for..of loop// and let-scoped variables in for loops// const and var could also be usedfor (let letter of eArr) &#123; console.log(letter);&#125;","categories":[{"name":"JavaScript","slug":"JavaScript","permalink":"https://wzes.github.io/categories/JavaScript/"}],"tags":[{"name":"JavaScript","slug":"JavaScript","permalink":"https://wzes.github.io/tags/JavaScript/"},{"name":"Array","slug":"Array","permalink":"https://wzes.github.io/tags/Array/"}]},{"title":"React Redux v0.2.1 æºç å­¦ä¹ ","slug":"JavaScript/Redux V0.2.1","date":"2019-08-25T11:30:16.000Z","updated":"2019-09-02T12:16:07.731Z","comments":true,"path":"2019/08/25/JavaScript/Redux V0.2.1/","link":"","permalink":"https://wzes.github.io/2019/08/25/JavaScript/Redux V0.2.1/","excerpt":"","text":"å‰è¨€ è¿™å‘¨çªç„¶æƒ³å­¦ä¹ ä¸€ä¸‹çŠ¶æ€ç®¡ç†çš„å†™æ³•ã€‚çœ‹çœ‹ä¸šç•Œæ˜¯æ€ä¹ˆå®ç°çš„ï¼Œä¹‹å‰ä½¿ç”¨è¿‡ reduxï¼Œé‚£å°±å…ˆä» redux ä¸‹æ‰‹å§ï¼Œä½†æ˜¯ï¼Œä¸€ä¸Šæ¥å°±çœ‹æœ€æ–°ç‰ˆæœ¬çš„ä»£ç ï¼Œä¸å¤ªé€‚åˆæ–°æ‰‹å­¦ä¹ ï¼Œä¸€æ–¹é¢æœ€æ–°ç‰ˆæœ¬å·²ç»å‘å±•nå¤šå¹´äº†ï¼ŒåŠŸèƒ½å·²ç»éå¸¸å®Œå–„ï¼ˆä»£ç å¤šéš¾æ‡‚ï¼‰ï¼Œå¦ä¸€æ–¹é¢ç›´æ¥çœ‹æœ€æ–°çš„ä¸äº†è§£è¿™ä¸ªå·¥å…·æ˜¯æ€ä¹ˆè®¾è®¡å‡ºæ¥çš„ã€‚äºæ˜¯å°±æ‰“ç®—å­¦ä¹ æœ€æ—©çš„å‘å¸ƒç‰ˆæœ¬ v0.2.1 å…ˆæ¥è¯´ä¸‹æˆ‘è®¤è¯†çš„ä¸€èˆ¬çš„çŠ¶æ€ç®¡ç†çš„åŸºæœ¬è·¯å­ï¼š å…¨å±€åªå­˜åœ¨ å”¯ä¸€stateï¼Œè€Œå‰ç«¯ä¸ç›´æ¥æ”¹å˜ stateï¼Œè€Œæ˜¯é€šè¿‡ action å»æ”¹å˜ state HelloWorld ä¸€ä¸ªè®¡æ•°å™¨çš„æ —å­ï¼Œç›®å½•ç»“æ„å¦‚ä¸‹ï¼š 123456789101112counterâ”œâ”€â”€ App.jsâ”œâ”€â”€ Counter.jsâ”œâ”€â”€ actionsâ”‚ â”œâ”€â”€ CounterActions.jsâ”‚ â””â”€â”€ index.jsâ”œâ”€â”€ constantsâ”‚ â””â”€â”€ ActionTypes.jsâ”œâ”€â”€ dispatcher.jsâ””â”€â”€ stores â”œâ”€â”€ CounterStore.js â””â”€â”€ index.js actions å‡½æ•°ï¼Œè¿”å›ä¸€ä¸ªå¸¦ type çš„å¯¹è±¡ï¼Œæˆ–è€…è¿”å›ä¸€ä¸ªå‡½æ•° 123456789101112131415161718192021222324import &#123; INCREMENT_COUNTER, DECREMENT_COUNTER&#125; from &apos;../constants/ActionTypes&apos;;export function increment() &#123; return &#123; type: INCREMENT_COUNTER &#125;;&#125;export function incrementAsync() &#123; return dispatch =&gt; &#123; setTimeout(() =&gt; &#123; dispatch(increment()); &#125;, 1000); &#125;;&#125;export function decrement() &#123; return &#123; type: DECREMENT_COUNTER &#125;;&#125; store è¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œå‚æ•° state å’Œ actionï¼Œå½“ state ä¸ºç©ºæ—¶è¿”å›åˆå§‹å€¼ï¼Œè¡¨ç¤ºåˆå§‹åŒ–ã€‚æ ¹æ® action çš„ type å€¼ï¼Œè¿›è¡Œç›¸åº”çš„åšæ³•ï¼Œè¿”å›ä¸€ä¸ªæ–°çš„ stateã€‚ 1234567891011121314151617181920212223242526272829import &#123; INCREMENT_COUNTER, DECREMENT_COUNTER&#125; from &apos;../constants/ActionTypes&apos;;const initialState = &#123; counter: 0 &#125;;function incremenent(&#123; counter &#125;) &#123; return &#123; counter: counter + 1 &#125;;&#125;function decremenent(&#123; counter &#125;) &#123; return &#123; counter: counter - 1 &#125;;&#125;export default function CounterStore(state, action) &#123; if (!state) &#123; return initialState; &#125; switch (action.type) &#123; case INCREMENT_COUNTER: return incremenent(state, action); case DECREMENT_COUNTER: return decremenent(state, action); default: return state; &#125;&#125; å…¥å£ App.js ä½ ä¼šå‘ç° @provides(dispatcher) è¿™ä¸ªå¥‡æ€ªçš„ä¸œè¥¿ï¼Œåœ¨ React é‡Œé¢è¿˜ç»å¸¸å‡ºç°ï¼Œè£…é¥°å™¨ã€‚ 12345678910111213import React, &#123; Component &#125; from &apos;react&apos;;import Counter from &apos;./Counter&apos;;import &#123; provides &#125; from &apos;redux&apos;;import dispatcher from &apos;./dispatcher&apos;;@provides(dispatcher)export default class App extends Component &#123; render() &#123; return ( &lt;Counter /&gt; ); &#125;&#125; Couter.jsï¼ŒåŒæ ·ï¼Œä¹Ÿå‡ºç° performsï¼ˆæ–¹æ³•ï¼‰ï¼Œobservesï¼ˆè§‚å¯Ÿè€…ï¼‰ç­‰å…³é”®å­—ã€‚ä½¿ç”¨ state ç›´æ¥ä½¿ç”¨ this.props è§£æ„èµ‹å€¼å³å¯ã€‚ 12345678910111213141516171819import React from &apos;react&apos;;import &#123; performs, observes &#125; from &apos;redux&apos;;@performs(&apos;increment&apos;, &apos;decrement&apos;)@observes(&apos;CounterStore&apos;)export default class Counter &#123; render() &#123; const &#123; increment, decrement &#125; = this.props; return ( &lt;p&gt; Clicked: &#123;this.props.counter&#125; times &#123;&apos; &apos;&#125; &lt;button onClick=&#123;() =&gt; increment()&#125;&gt;+&lt;/button&gt; &#123;&apos; &apos;&#125; &lt;button onClick=&#123;() =&gt; decrement()&#125;&gt;-&lt;/button&gt; &lt;/p&gt; ); &#125;&#125; è¿™äº›å…³é”®å­—æ˜¯æ—©èµ· Redux çŠ¶æ€ç®¡ç†çš„å…³é”®ï¼Œç°åœ¨çš„ç‰ˆæœ¬åº”è¯¥å·²ç»ä¸ä½¿ç”¨è¿™ç§æ–¹å¼äº†ã€‚ è§£æ dispatcher é€šè¿‡ provides å°† dispatcher æ³¨å…¥åˆ° App ä¸­ï¼Œå…¶ä¸­ï¼Œdispatcher æ˜¯é€šè¿‡ createDispatcher åˆ›å»ºï¼Œå¹¶è°ƒç”¨äº† dispatcher.receive(stores, actions) è¿›è¡Œç»‘å®šã€‚ 123456789101112131415import * as stores from &apos;./stores/index&apos;;import * as actions from &apos;./actions/index&apos;;import &#123; createDispatcher &#125; from &apos;redux&apos;;const dispatcher = module.hot &amp;&amp; module.hot.data &amp;&amp; module.hot.data.dispatcher || createDispatcher();dispatcher.receive(stores, actions);module.hot.dispose(data =&gt; &#123; data.dispatcher = dispatcher;&#125;);export default dispatcher; receive æ–¹æ³•ï¼ŒactionCreator å°† action è¿›è¡Œå°è£…ï¼Œ 123456789101112131415161718// Provide a way to receive new stores and actions function receive(nextStores, nextActionCreators) &#123; stores = nextStores; actionCreators = mapValues(nextActionCreators, wrapActionCreator); // Merge the observers observers = mapValues(stores, (store, key) =&gt; observers[key] || [] ); // Dispatch to initialize stores if (currentTransaction) &#123; updateState(committedState); currentTransaction.forEach(dispatch); &#125; else &#123; dispatch(BOOTSTRAP_STORE); &#125; &#125; action è¿›è¡Œè½¬åŒ–è¿”å›ä¸€ä¸ª dispatchAction å‡½æ•°ï¼Œå¦‚æœ action ä¸ºå‡½æ•°ï¼Œåˆ™å…ˆæ‰§è¡Œå‡½æ•°ï¼ŒæŠŠ dispatchInTransaction ä½œä¸ºå‚æ•°ä¼ å…¥ï¼Œè¿™æ ·å¯ä»¥åœ¨ action å†…éƒ¨ä½¿ç”¨è¯¥å‡½æ•°äº†ï¼Œå¦åˆ™ä½¿ç”¨ dispatchInTransaction å‡½æ•°è°ƒç”¨ã€‚ 12345678910111213// Bind action creator to the dispatcher function wrapActionCreator(actionCreator) &#123; return function dispatchAction(...args) &#123; const action = actionCreator(...args); if (typeof action === &apos;function&apos;) &#123; // Async action creator action(dispatchInTransaction); &#125; else &#123; // Sync action creator dispatchInTransaction(action); &#125; &#125;; &#125; dispatchInTransaction ï¼Œæ‰§è¡Œ dispatch ï¼Œè®¡ç®— nextStateï¼Œæ‰§è¡Œ updateState æ›´æ–°ã€‚ 1234567891011121314151617 // Dispatch in the context of current transaction function dispatchInTransaction(action) &#123; if (currentTransaction) &#123; currentTransaction.push(action); &#125; dispatch(action); &#125;// Reassign the current state on each dispatch function dispatch(action) &#123; if (typeof action.type !== &apos;string&apos;) &#123; throw new Error(&apos;Action type must be a string.&apos;); &#125; const nextState = computeNextState(currentState, action); updateState(nextState); &#125; è·å– storeï¼Œä¹Ÿå°±æ˜¯ CounterStoreï¼ŒæŠŠå‚æ•°ä¼ å…¥ï¼Œè·å–æ–°çš„ state 123456// To compute the next state, combine the next states of every storefunction computeNextState(state, action) &#123; return mapValues(stores, (store, key) =&gt; store(state[key], action) );&#125; updateState å®ç°ï¼Œè®¡ç®—å˜åŒ–çš„ changedKeysï¼Œæ‰§è¡Œ emitChange è¿›è¡Œæ›´æ–°ã€‚ 123456789101112// Update state and emit change if neededfunction updateState(nextState) &#123; // Swap the state const previousState = currentState; currentState = nextState; // Notify the observers const changedKeys = Object.keys(currentState).filter(key =&gt; currentState[key] !== previousState[key] ); emitChange(changedKeys);&#125; emitChangeï¼Œè·å–éœ€è¦é€šçŸ¥çš„ observersï¼Œè°ƒç”¨é€šçŸ¥å‡½æ•°ã€‚ 12345678910111213141516171819// Notify observers about the changed stores function emitChange(changedKeys) &#123; if (!changedKeys.length) &#123; return; &#125; // Gather the affected observers const notifyObservers = []; changedKeys.forEach(key =&gt; &#123; observers[key].forEach(o =&gt; &#123; if (notifyObservers.indexOf(o) === -1) &#123; notifyObservers.push(o); &#125; &#125;); &#125;); // Emit change notifyObservers.forEach(o =&gt; o()); &#125; è¿™é‡Œå¯èƒ½æœ‰ç‚¹ç–‘é—®ï¼Œobersevers æ˜¯ä»€ä¹ˆï¼Œä»å“ªæ¥ï¼Ÿå¾€ä¸‹çœ‹ï½ observes.js å°† ç»„ä»¶è¿›è¡Œè£…é¥°ï¼Œæ„é€ å‡½æ•°ä¸­æœ‰ä¸€ä¸ª this.unobserve = this.context.observeStores(storeKeys, this.handleChange); context å°±æ˜¯ dispatcherï¼Œ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647import React, &#123; Component, PropTypes &#125; from &apos;react&apos;;import pick from &apos;lodash/object/pick&apos;;import identity from &apos;lodash/utility/identity&apos;;const contextTypes = &#123; observeStores: PropTypes.func.isRequired&#125;;export default function connect(...storeKeys) &#123; let mapState = identity; // Last argument may be a custom mapState function const lastIndex = storeKeys.length - 1; if (typeof storeKeys[lastIndex] === &apos;function&apos;) &#123; [mapState] = storeKeys.splice(lastIndex, 1); &#125; return function (DecoratedComponent) &#123; const wrappedDisplayName = DecoratedComponent.displayName || DecoratedComponent.name || &apos;Component&apos;; return class extends Component &#123; static displayName = `ReduxObserves($&#123;wrappedDisplayName&#125;)`; static contextTypes = contextTypes; constructor(props, context) &#123; super(props, context); this.handleChange = this.handleChange.bind(this); this.unobserve = this.context.observeStores(storeKeys, this.handleChange); &#125; .... componentWillUnmount() &#123; this.unobserve(); &#125; render() &#123; return ( &lt;DecoratedComponent &#123;...this.props&#125; &#123;...this.state&#125; /&gt; ); &#125; &#125;; &#125;;&#125; dispatcher observeStores æ–¹æ³•ï¼Œå°†éœ€è¦ç›‘å¬çš„ç»„ä»¶ä¼ å…¥ï¼Œä»¥åŠ onChange å‡½æ•°ï¼Œä½œä¸ºå›è°ƒä½¿ç”¨ã€‚æœ€åè¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œç§»é™¤ç›‘å¬ï¼Œè¿™ä¸ªä¹Ÿå¤ªå¦™äº†å§ã€‚ 1234567891011121314151617181920212223// Provide subscription and unsubscription function observeStores(observedKeys, onChange) &#123; // Emit the state update function handleChange() &#123; onChange(currentState); &#125; // Synchronously emit the initial value handleChange(); // Register the observer for each relevant key observedKeys.forEach(key =&gt; observers[key].push(handleChange) ); // Let it unregister when the time comes return () =&gt; &#123; observedKeys.forEach(key =&gt; &#123; const index = observers[key].indexOf(handleChange); observers[key].splice(index, 1); &#125;); &#125;; &#125; å½“è®¡ç®—å¥½ nextState åï¼Œå°±ä¼šè°ƒç”¨ observe çš„ onChange æ–¹æ³•ï¼Œ onChange æ–¹æ³•ä¹Ÿå°±æ˜¯ è£…é¥°å™¨é‡Œé¢çš„æ–¹æ³•ã€‚æœ€åè°ƒç”¨è‡ªèº«çš„ updateStateï¼Œä½¿ç”¨ setState è¿›è¡Œç»„ä»¶æ›´æ–°ã€‚è€Œè¿™äº› state ä½œä¸º props ä¼ å…¥äº†æˆ‘ä»¬è‡ªå·±çš„ç»„ä»¶ï¼Œä¹Ÿå°±å¯ä»¥é€šè¿‡ this.props æ‹¿åˆ°ã€‚å®Œç¾ï½ï½ï½ 1234567891011121314151617181920212223handleChange(stateFromStores) &#123; this.currentStateFromStores = pick(stateFromStores, storeKeys); this.updateState(stateFromStores, this.props);&#125;componentWillReceiveProps(nextProps) &#123; this.updateState(this.currentStateFromStores, nextProps);&#125;updateState(stateFromStores, props) &#123; if (storeKeys.length === 1) &#123; // Just give it the particular store state for convenience stateFromStores = stateFromStores[storeKeys[0]]; &#125; const state = mapState(stateFromStores, props); if (this.state) &#123; this.setState(state); &#125; else &#123; this.state = state; &#125;&#125; performs ç»„ä»¶ action ç»‘å®šåˆ°ç»„ä»¶ï¼Œå¯ä»¥é€šè¿‡ this.props ï¼Œé€šè¿‡ this.context.getActions() æ‹¿åˆ° actions 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152import React, &#123; Component, PropTypes &#125; from &apos;react&apos;;import pick from &apos;lodash/object/pick&apos;;import identity from &apos;lodash/utility/identity&apos;;const contextTypes = &#123; getActions: PropTypes.func.isRequired&#125;;export default function performs(...actionKeys) &#123; let mapActions = identity; // Last argument may be a custom mapState function const lastIndex = actionKeys.length - 1; if (typeof actionKeys[lastIndex] === &apos;function&apos;) &#123; [mapActions] = actionKeys.splice(lastIndex, 1); &#125; return function (DecoratedComponent) &#123; const wrappedDisplayName = DecoratedComponent.displayName || DecoratedComponent.name || &apos;Component&apos;; return class extends Component &#123; static displayName = `ReduxPerforms($&#123;wrappedDisplayName&#125;)`; static contextTypes = contextTypes; constructor(props, context) &#123; super(props, context); this.updateActions(props); &#125; componentWillReceiveProps(nextProps) &#123; this.updateActions(nextProps); &#125; updateActions(props) &#123; this.actions = mapActions( pick(this.context.getActions(), actionKeys), props ); &#125; render() &#123; return ( &lt;DecoratedComponent &#123;...this.props&#125; &#123;...this.actions&#125; /&gt; ); &#125; &#125;; &#125;;&#125; åˆ°è¿™é‡Œå°±å·®ä¸å¤šäº†ï½ é¢å¤–æ”¶è· Lodash pick 12345var object = &#123; &apos;user&apos;: &apos;fred&apos;, &apos;age&apos;: 40 &#125;;_.pick(object, &apos;user&apos;);// =&gt; &#123; &apos;user&apos;: &apos;fred&apos; &#125;_.pick(object, _.isString);// =&gt; &#123; &apos;user&apos;: &apos;fred&apos; &#125; identity 123function identity(value) &#123; return value;&#125; mapValues 1234_.mapValues(&#123; &apos;a&apos;: 1, &apos;b&apos;: 2 &#125;, function(n) &#123; return n * 3;&#125;);// =&gt; &#123; &apos;a&apos;: 3, &apos;b&apos;: 6 &#125; æœ€å éº»é›€è™½å°ï¼Œå´èƒ½çœ‹é€ç²¾é«“ï½","categories":[{"name":"JavaScript","slug":"JavaScript","permalink":"https://wzes.github.io/categories/JavaScript/"}],"tags":[{"name":"JavaScript","slug":"JavaScript","permalink":"https://wzes.github.io/tags/JavaScript/"},{"name":"React","slug":"React","permalink":"https://wzes.github.io/tags/React/"},{"name":"Redux","slug":"Redux","permalink":"https://wzes.github.io/tags/Redux/"}]},{"title":"Node KoaJs æºç è§£æ","slug":"JavaScript/KoaJs","date":"2019-08-18T10:56:00.000Z","updated":"2019-09-02T12:15:48.563Z","comments":true,"path":"2019/08/18/JavaScript/KoaJs/","link":"","permalink":"https://wzes.github.io/2019/08/18/JavaScript/KoaJs/","excerpt":"","text":"å‰è¨€ åˆæ˜¯ä¸€å‘¨è¿‡å»äº†ï¼Œå¸¸è§„å­¦ä¹ ä¸èƒ½æ–­ï¼ä½†æ˜¯é€‰æ‹©ä»€ä¹ˆä¸»é¢˜å‘¢ï¼Ÿä¸€æ—¶é—´ä¸çŸ¥é“é€‰ä»€ä¹ˆå¥½ï¼Œäºæ˜¯åˆæƒ³èµ·ç®€å•çš„ koajs éå¸¸æ„‰å¿«çš„å°±é€‰æ‹©ä»–äº† https://koajs.com/ï¼Œäº†è§£ä¸€ä¸‹ï¼Ÿ ä»–æ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿å‘¢ï¼Ÿ Koa æ˜¯ä¸€ä¸ªæ–°çš„ web æ¡†æ¶ï¼Œç”± Express å¹•åçš„åŸç­äººé©¬æ‰“é€ ï¼Œ è‡´åŠ›äºæˆä¸º web åº”ç”¨å’Œ API å¼€å‘é¢†åŸŸä¸­çš„ä¸€ä¸ªæ›´å°ã€æ›´å¯Œæœ‰è¡¨ç°åŠ›ã€æ›´å¥å£®çš„åŸºçŸ³ã€‚ é€šè¿‡åˆ©ç”¨ async å‡½æ•°ï¼ŒKoa å¸®ä½ ä¸¢å¼ƒå›è°ƒå‡½æ•°ï¼Œå¹¶æœ‰åŠ›åœ°å¢å¼ºé”™è¯¯å¤„ç†ã€‚ Koa å¹¶æ²¡æœ‰æ†ç»‘ä»»ä½•ä¸­é—´ä»¶ï¼Œ è€Œæ˜¯æä¾›äº†ä¸€å¥—ä¼˜é›…çš„æ–¹æ³•ï¼Œå¸®åŠ©æ‚¨å¿«é€Ÿè€Œæ„‰å¿«åœ°ç¼–å†™æœåŠ¡ç«¯åº”ç”¨ç¨‹åºã€‚ hello world é¦–å…ˆæ–°å»ºä¸€ä¸ª node é¡¹ç›®ï¼Œå…¶å®å¾ˆç®€å•ï¼Œåªéœ€è¦ä¸€ä¸ª package.json æ–‡ä»¶ï¼Œ 12345678910111213141516&#123; &quot;name&quot;: &quot;koa-hello&quot;, &quot;version&quot;: &quot;1.0.0&quot;, &quot;description&quot;: &quot;&quot;, &quot;main&quot;: &quot;index.js&quot;, &quot;scripts&quot;: &#123; &quot;test&quot;: &quot;echo \\&quot;Error: no test specified\\&quot; &amp;&amp; exit 1&quot;, &quot;start&quot;: &quot;node src/index.js&quot; &#125;, &quot;keywords&quot;: [], &quot;author&quot;: &quot;&quot;, &quot;license&quot;: &quot;ISC&quot;, &quot;dependencies&quot;: &#123; &quot;koa&quot;: &quot;^2.7.0&quot; &#125;&#125; ç„¶åæ‰§è¡Œ 1npm i koa ä»£ç  index.js æ–‡ä»¶ï¼Œæ–°å»ºä¸€ä¸ª koa å®ä¾‹ï¼Œä½¿ç”¨ app.use å†™ä¸€ä¸ª async æ–¹æ³•ï¼Œè®¾ç½® ctx.body çš„å€¼å°±å¯ä»¥äº†ã€‚æœ€åä½¿ç”¨ app.listen å¯åŠ¨ã€‚ 12345678const Koa = require(&apos;koa&apos;);const app = new Koa();app.use(async ctx =&gt; &#123; ctx.body = &apos;Hello World&apos;;&#125;);app.listen(3000); è¿™æ ·çš„è¯ï¼Œä¸€ä¸ª web æœåŠ¡å™¨å°±æ­å»ºå¥½äº†ï¼Œè®¿é—® http://localhost:3000/ å°±ä¼šå¾—åˆ° hello world è¿”å›ç»“æœäº†ã€‚ä½ å¯ä»¥å°è¯•æ›´æ”¹å­—æ®µä»è€Œå¾—åˆ°ä¸åŒçš„è¿”å›ç»“æœã€‚ æºç è§£æ koa çš„æºç åªæœ‰å››ä¸ªæ–‡ä»¶ï¼Œä¸åŒ…å«å…¶ä»–å¼•ç”¨çš„è¯ 12345678910 .â”œâ”€â”€ History.mdâ”œâ”€â”€ LICENSEâ”œâ”€â”€ Readme.mdâ”œâ”€â”€ libâ”‚ â”œâ”€â”€ application.jsâ”‚ â”œâ”€â”€ context.jsâ”‚ â”œâ”€â”€ request.jsâ”‚ â””â”€â”€ response.jsâ””â”€â”€ package.json ä¸»å…¥å£å¯ä»¥åœ¨ package.json çš„ main ä¸­å¾—åˆ°ï¼Œæ˜¯ application.jsï¼Œæš‚æ—¶å…ˆçŸ¥é“ middleware æ˜¯ä¸­é—´æ¥ï¼Œé€šå¸¸ä¸€ä¸ªè¯·æ±‚è¿‡æ¥å°±ä¼šä¾æ¬¡æ‰§è¡Œä¸­é—´ä»¶çš„æ–¹æ³•ã€‚ æ„é€ å‡½æ•° 12345678910111213141516171819202122module.exports = class Application extends Emitter &#123; /** * Initialize a new `Application`. * * @api public */ constructor() &#123; super(); this.proxy = false; this.middleware = []; this.subdomainOffset = 2; this.env = process.env.NODE_ENV || &apos;development&apos;; this.context = Object.create(context); this.request = Object.create(request); this.response = Object.create(response); if (util.inspect.custom) &#123; this[util.inspect.custom] = this.inspect; &#125; &#125;&#125; app.use å…¶å®å°±æ˜¯æ·»åŠ ä¸€ä¸ªä¸­é—´ä»¶ï¼Œæˆ‘ä»¬é€šå¸¸ä½¿ç”¨ async çš„å‡½æ•°ï¼Œgenerator è¢«æŠ›å¼ƒäº†ï¼ 123456789101112use(fn) &#123; if (typeof fn !== &apos;function&apos;) throw new TypeError(&apos;middleware must be a function!&apos;); if (isGeneratorFunction(fn)) &#123; deprecate(&apos;Support for generators will be removed in v3. &apos; + &apos;See the documentation for examples of how to convert old middleware &apos; + &apos;https://github.com/koajs/koa/blob/master/docs/migration.md&apos;); fn = convert(fn); &#125; debug(&apos;use %s&apos;, fn._name || fn.name || &apos;-&apos;); this.middleware.push(fn); return this;&#125; app.listen åˆ›å»ºä¸€ä¸ªæœåŠ¡å™¨ï¼Œç›‘å¬ 3000 ç«¯å£ï¼Œhttp.createServer æ˜¯ node çš„æœåŠ¡å™¨ã€‚ 12345listen(...args) &#123; debug(&apos;listen&apos;); const server = http.createServer(this.callback()); return server.listen(...args);&#125; callback æ˜¯æä¾›ä¸€ä¸ªå‡½æ•°ï¼Œæ‰€æœ‰è¯·æ±‚éƒ½ä¼šèµ°åˆ°è¿™ä¸ªå‡½æ•°é‡Œé¢è¿›è¡Œå¤„ç†ã€‚æ¯æ¬¡è¯·æ±‚è¿‡æ¥éƒ½ä¼šè°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ¯æ¬¡è¯·æ±‚éƒ½ä¼šåˆ›å»ºä¸€ä¸ª ctx çš„å¯¹è±¡ã€‚ compose çš„ä½œç”¨å°±æ˜¯å°†æ‰€æœ‰çš„ä¸­é—´ä»¶æ•´åˆæˆä¸€ä¸ªå‡½æ•°ï¼Œä½¿ç”¨ next å‡½æ•°ç»§ç»­è°ƒç”¨ä¸‹ä¸€ä¸ªå‡½æ•°ã€‚ 123456789101112callback() &#123; const fn = compose(this.middleware); if (!this.listenerCount(&apos;error&apos;)) this.on(&apos;error&apos;, this.onerror); const handleRequest = (req, res) =&gt; &#123; const ctx = this.createContext(req, res); return this.handleRequest(ctx, fn); &#125;; return handleRequest;&#125; åˆå§‹åŒ– ctx å¯¹è±¡ï¼Œè¿™é‡Œ this.request å°†ä¼šæŠŠåŸç”Ÿçš„ request å‚æ•°è¿›è¡Œè§£æï¼Œæ–¹ä¾¿æˆ‘ä»¬è¿›è¡Œç›¸å…³å‚æ•°è·å–ã€‚ 1234567891011121314151617181920/** * Initialize a new context. * * @api private */createContext(req, res) &#123; const context = Object.create(this.context); const request = context.request = Object.create(this.request); const response = context.response = Object.create(this.response); context.app = request.app = response.app = this; context.req = request.req = response.req = req; context.res = request.res = response.res = res; request.ctx = response.ctx = context; request.response = response; response.request = request; context.originalUrl = request.originalUrl = req.url; context.state = &#123;&#125;; return context;&#125; æ¯”å¦‚æˆ‘ä»¬ä¹‹åå°±å¯ä»¥ä½¿ç”¨ ** ctx.query.key ** æ¥è·å– http://localhost:3000?key=valueï¼Œä¸ºä»€ä¹ˆå¯ä»¥ä½¿ç”¨ ctx.query åˆå¯ä»¥è·å–å‚æ•°å‘¢ï¼Œè¿™ä¸ªè¦é  Object.create çš„æœ¬äº‹äº†ï¼Œå®ƒç›¸å½“äºåˆ›é€ äº†ä¸€ä¸ªå¯¹è±¡ï¼Œç»§æ‰¿äº†åŸæ¥çš„å¯¹è±¡ï¼Œè€Œ this.request æœ‰ query çš„å‚æ•°ï¼Œè€Œæœ€ä¸ºé‡è¦çš„æ˜¯ this.context = Object.create(context); context å§”æ‰˜ï¼ˆä½¿ç”¨äº† Delegatorï¼‰äº†è¿™äº› request çš„ç›¸å…³å±æ€§å’Œæ–¹æ³•ã€‚ã€ç¬¬ä¸€æ¬¡ä½“ä¼šåˆ° js å§”æ‰˜ï¼Œä»¥å‰çŸ¥è¯†å¬è¯´ä¸çŸ¥é“æ˜¯å•¥ã€‘ 12345678910/** * Request delegation. */delegate(proto, &apos;request&apos;) .access(&apos;method&apos;) .access(&apos;query&apos;) .access(&apos;path&apos;) .access(&apos;url&apos;) ....... // çœç•¥ handleRequest è¯·æ±‚å¤„ç†ï¼ŒfnMiddleware å°±æ˜¯æ‰€æœ‰çš„ä¸­é—´ä»¶ï¼Œ 12345678handleRequest(ctx, fnMiddleware) &#123; const res = ctx.res; res.statusCode = 404; const onerror = err =&gt; ctx.onerror(err); const handleResponse = () =&gt; respond(ctx); onFinished(res, onerror); return fnMiddleware(ctx).then(handleResponse).catch(onerror);&#125; è°ƒç”¨å®Œä¸­é—´ä»¶ä»¥åï¼Œå°±æ‰§è¡Œ handleResponse å°†æ•°æ®è¿”å›ï¼Œè¿”å›æ•°æ®ä¹Ÿå°±æ˜¯å°† ctx.body æ‹¿å‡ºæ¥ï¼Œä½¿ç”¨ response.end è¿”å›æ•°æ®ï¼Œè¿”å›æ—¶ï¼Œä¼šå¯¹æ•°æ®è¿›è¡Œå¤„ç†ï¼Œåœ¨æœ€åé¢å¯ä»¥ä½“ä¼šåˆ°ï½ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354/** * Response helper. */function respond(ctx) &#123; // allow bypassing koa if (false === ctx.respond) return; if (!ctx.writable) return; const res = ctx.res; let body = ctx.body; const code = ctx.status; // ignore body if (statuses.empty[code]) &#123; // strip headers ctx.body = null; return res.end(); &#125; if (&apos;HEAD&apos; == ctx.method) &#123; if (!res.headersSent &amp;&amp; isJSON(body)) &#123; ctx.length = Buffer.byteLength(JSON.stringify(body)); &#125; return res.end(); &#125; // status body if (null == body) &#123; if (ctx.req.httpVersionMajor &gt;= 2) &#123; body = String(code); &#125; else &#123; body = ctx.message || String(code); &#125; if (!res.headersSent) &#123; ctx.type = &apos;text&apos;; ctx.length = Buffer.byteLength(body); &#125; return res.end(body); &#125; // responses if (Buffer.isBuffer(body)) return res.end(body); if (&apos;string&apos; == typeof body) return res.end(body); if (body instanceof Stream) return body.pipe(res); // body: json body = JSON.stringify(body); if (!res.headersSent) &#123; ctx.length = Buffer.byteLength(body); &#125; res.end(body);&#125; åˆ°è¿™é‡Œï¼ŒåŸºæœ¬çš„è¯·æ±‚å·²ç»æ¸…æ¥šäº†ï½ï½ End å†æ¥çœ‹ä¸€çœ¼æœ€ç®€å•çš„ http server ä»£ç ï¼Œå¯¹æ¯”ä¸€ä¸‹ï¼Œæ¯” koa ä»£ç çš„ hello world ç›¸æ¯”å¹¶æ²¡æœ‰å¤šå¤æ‚ 123456var http = require(&apos;http&apos;);http.createServer(function (req, res) &#123; res.writeHead(200, &#123;&apos;Content-Type&apos;: &apos;text/plain&apos;&#125;); res.write(&apos;Hello World!&apos;); res.end();&#125;).listen(8080); ä½†æ˜¯ï¼Œè·å–å‚æ•°ï¼Œä½¿ç”¨è·¯ç”±ç­‰ç­‰æ’ä»¶ï¼Œkoa ç”Ÿæ€åšäº†å¾ˆå¤šï¼Œéå¸¸æ–¹ä¾¿ï¼Œå¿«æ¥ä½“éªŒå§ï¼","categories":[{"name":"JavaScript","slug":"JavaScript","permalink":"https://wzes.github.io/categories/JavaScript/"}],"tags":[{"name":"JavaScript","slug":"JavaScript","permalink":"https://wzes.github.io/tags/JavaScript/"},{"name":"Node","slug":"Node","permalink":"https://wzes.github.io/tags/Node/"},{"name":"Koa","slug":"Koa","permalink":"https://wzes.github.io/tags/Koa/"}]},{"title":"Android ä¸€ä¸ªæ»‘åŠ¨ç»„ä»¶çš„åŸç†æµ…æ","slug":"Android/ä¸€ä¸ªæ»‘åŠ¨ç»„ä»¶çš„åŸç†æµ…æ","date":"2019-08-11T06:47:16.000Z","updated":"2019-09-02T12:19:37.016Z","comments":true,"path":"2019/08/11/Android/ä¸€ä¸ªæ»‘åŠ¨ç»„ä»¶çš„åŸç†æµ…æ/","link":"","permalink":"https://wzes.github.io/2019/08/11/Android/ä¸€ä¸ªæ»‘åŠ¨ç»„ä»¶çš„åŸç†æµ…æ/","excerpt":"","text":"å‰è¨€ ä¸€ä¸ªå¥½çš„æ»‘åŠ¨ä¸æ­¢èƒ½å¤Ÿå“åº”æ‰‹æŒ‡çš„ç§»åŠ¨ï¼Œè€Œä¸”è¿˜èƒ½å“åº” Flingï¼ˆæŠ›ï¼‰ äº‹ä»¶ï¼Œå“åº”æ‰‹æŒ‡çš„ç§»åŠ¨æ¯”è¾ƒç®€å•ï¼Œæ‰‹æŒ‡ç§»åŠ¨å¤šå°‘è·ç¦»ï¼Œå¸ƒå±€å°±ç§»åŠ¨å¤šå°‘è·ç¦»ï¼›å½“å¿«é€Ÿæ»‘åŠ¨æ—¶ï¼Œæ‰‹æŒ‡ç¦»å¼€åï¼Œä¸èƒ½é©¬ä¸Šåœæ­¢æ»‘åŠ¨ï¼Œè€Œæ˜¯åº”è¯¥è®¡ç®—æ‰‹æŒ‡çš„ç§»åŠ¨é€Ÿåº¦ï¼Œäº§ç”Ÿä¸€ä¸ªã€æŠ›ã€‘ï¼ˆFling ï¼‰çš„åŠ¨ä½œï¼Œè®©å†…å®¹ç»§ç»­æ»šåŠ¨ä¸€æ®µè·ç¦»ã€‚è¿™æ‰æ˜¯å¥½çš„æ»‘åŠ¨ç»„ä»¶ã€‚é‚£ä¹ˆå…¶ä¸­å…·ä½“çš„è®¾è®¡ç©¶ç«Ÿæ˜¯å¦‚ä½•å‘¢ï¼Œä»Šå¤©å°±æ¥åˆ†æä¸€æ³¢ï¼Œå€Ÿé‰´ Android OverScroller çš„å®ç°ã€‚ Demo 12345678if (mOverScroller.computeScrollOffset()) &#123; // è·å– scrollY int y = mOverScroller.getCurrY(); // æ­¤å¤„çœç•¥ä¸€å †æ§åˆ¶æ»šåŠ¨çš„ä»£ç  ..... // æ›´æ–° postInvalidate();&#125; è§£æ æ€»ä½“é€»è¾‘å…ˆæ¢³ç†ä¸‹ï¼Œé¦–å…ˆå†…å®¹è·Ÿéšæ‰‹æŒ‡ç§»åŠ¨è€Œã€ç§»åŠ¨ã€‘ï¼Œæ‰‹æŒ‡ç¦»å¼€æ—¶äº§ç”Ÿä¸€ä¸ª ã€é€Ÿåº¦ã€‘ï¼Œæ ¹æ®è¿™ä¸ªé€Ÿåº¦è®¡ç®—ä¸€ä¸ªï¼Œæ­¤æ¬¡æ»‘åŠ¨çš„ã€æ€»æ—¶é—´ã€‘å’Œã€æ€»è·ç¦»ã€‘ï¼Œä¹‹åå¯ä»¥è®¡ç®—æ¯ä¸€ä¸ªã€æ—¶åˆ»ã€‘å¯¹åº”çš„ã€ä½ç½®ã€‘ã€‚é‚£å…¶ä¸­æ—¶åˆ»ä¸è·ç¦»çš„å¯¹åº”å…³ç³»æ˜¯å¦‚ä½•å‘¢ï¼Ÿçœ‹äº†ä¸€ä¸‹ Android çš„æºç ï¼Œè®¡ç®—å…³ç³»ä¹‹å¤æ‚ï¼Œæƒ¨ç»äººå¯°ï¼Œæ¬²ç ”åˆæ­¢ï¼ä½†è¿™ä¸é‡è¦ï¼Œé‡è¦çš„æ˜¯æŒæ¡å…¨å±€ã€‚ ä¸€èµ·æ¥æ¬£èµä¸€ä¸‹ä»£ç å§ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051/* * Update the current position and velocity for current time. Returns * true if update has been done and false if animation duration has been * reached. */ boolean update() &#123; final long time = AnimationUtils.currentAnimationTimeMillis(); final long currentTime = time - mStartTime; if (currentTime == 0) &#123; // Skip work but report that we&apos;re still going if we have a nonzero duration. return mDuration &gt; 0; &#125; if (currentTime &gt; mDuration) &#123; return false; &#125; double distance = 0.0; switch (mState) &#123; case SPLINE: &#123; final float t = (float) currentTime / mSplineDuration; final int index = (int) (NB_SAMPLES * t); float distanceCoef = 1.f; float velocityCoef = 0.f; if (index &lt; NB_SAMPLES) &#123; final float t_inf = (float) index / NB_SAMPLES; final float t_sup = (float) (index + 1) / NB_SAMPLES; final float d_inf = SPLINE_POSITION[index]; final float d_sup = SPLINE_POSITION[index + 1]; velocityCoef = (d_sup - d_inf) / (t_sup - t_inf); distanceCoef = d_inf + (t - t_inf) * velocityCoef; &#125; distance = distanceCoef * mSplineDistance; mCurrVelocity = velocityCoef * mSplineDistance / mSplineDuration * 1000.0f; break; &#125; case BALLISTIC: &#123; final float t = currentTime / 1000.0f; mCurrVelocity = mVelocity + mDeceleration * t; distance = mVelocity * t + mDeceleration * t * t / 2.0f; break; &#125; ..... &#125; mCurrentPosition = mStart + (int) Math.round(distance); return true; &#125; mCurrentPosition å°±æ˜¯æŸä¸ªæ—¶åˆ»å¯¹åº”çš„ä½ç½®ï¼Œæœ‰è¶£çš„æ˜¯ BALLISTIC æ¨¡å¼ï¼Œè¿˜è®°å¾—é«˜ä¸­ç‰©ç†çš„é‡åŠ›åŠ é€Ÿåº¦æ—¶é—´ä¸è·ç¦»çš„å…¬å¼å—ï¼Ÿæ˜¯ä¸æ˜¯ä¼¼æ›¾ç›¸è¯†ï¼Ÿè¿™ç®—æ¯”è¾ƒç®€å•çš„å…¬å¼ï¼Œä½†æˆ‘ä»¬ä»Šå¤©ä½†ä¸»è§’æ˜¯ SPLINE æ¨¡å¼ï¼ŒScrollView ä½†æ»‘åŠ¨æ­£æ˜¯ä½¿ç”¨äº†è¿™ä¸ªæ¨¡å¼è¿›è¡Œæ»‘åŠ¨ï¼Œä½“éªŒéå¸¸å¥½ï¼ï¼ï¼ï¼å…¬å¼æœ‰ç‚¹å¤æ‚ï¼Œå°±ä¸æ´—æ´—ç ”ç©¶äº†ï¼Œå–œæ¬¢çš„åŒå­¦è‡ªè¡Œç ”ç©¶å§ æ€»ç»“ ç®€å•ä¸€ä¸ªæ»šåŠ¨ï¼Œè•´è—çš„é“ç†ç”Ÿä¸å¯æµ‹ï¼Œä¸€ä¸å°å¿ƒå°±å‡ºç°äº†ç‰©ç†çŸ¥è¯†ç‚¹â€¦å­¦ä¹ è¿˜æ˜¯æŒºæœ‰ç”¨çš„å§","categories":[{"name":"Android","slug":"Android","permalink":"https://wzes.github.io/categories/Android/"}],"tags":[{"name":"Android","slug":"Android","permalink":"https://wzes.github.io/tags/Android/"}]},{"title":"JavaScript Babel-Loader è‡ªå®šä¹‰å…¥é—¨","slug":"JavaScript/Babel Loader","date":"2019-08-04T05:42:00.000Z","updated":"2019-09-02T12:14:06.673Z","comments":true,"path":"2019/08/04/JavaScript/Babel Loader/","link":"","permalink":"https://wzes.github.io/2019/08/04/JavaScript/Babel Loader/","excerpt":"","text":"å‰è¨€ çªç„¶è§‰å¾— babel-loader https://github.com/babel/babel-loader å¾ˆå¥½ç©ï¼Œæ¯”è¾ƒè´´è¿‘ASTï¼Œç„¶è€Œç¼–è¯‘åŸç†ä¸€ç›´æ˜¯å™©æ¢¦ï¼Œæ²¡å­¦æ‡‚ï¼Œå¥½åœ¨è¿™ä¸œè¥¿ä¸éœ€è¦ä»€ä¹ˆç¼–è¯‘åŸç†çš„çŸ¥è¯†ã€‚ä½†è¿˜æ˜¯æ¶‰åŠåˆ°è¯­æ³•è§£æç­‰æ“ä½œï¼Œæ‰€ä»¥æ‹¿è¿‡æ¥å­¦ä¸€å­¦è¿˜æ˜¯æŒºå¥½çš„ã€‚ ä»€ä¹ˆæ˜¯ Babel Babel æ˜¯ä¸€ä¸ªå·¥å…·é“¾ï¼Œä¸»è¦ç”¨äºå°† ECMAScript 2015+ ä»£ç è½¬æ¢ä¸ºå½“å‰å’Œæ—§ç‰ˆæµè§ˆå™¨æˆ–ç¯å¢ƒä¸­çš„å‘åå…¼å®¹ç‰ˆæœ¬çš„ JavaScriptã€‚ ä»¥ä¸‹æ˜¯ Babel å¯ä»¥ä¸ºæ‚¨åšçš„ä¸»è¦äº‹æƒ…ï¼š è½¬æ¢è¯­æ³• ç›®æ ‡ç¯å¢ƒä¸­ç¼ºå°‘PolyfillåŠŸèƒ½ï¼ˆé€šè¿‡@ babel / polyfillï¼‰æºä»£ç è½¬æ¢ï¼ˆcodemodsï¼‰ æ›´å¤š 1234567// Babel Input: ES2015 arrow function[1, 2, 3].map((n) =&gt; n + 1);// Babel Output: ES5 equivalent[1, 2, 3].map(function(n) &#123; return n + 1;&#125;); ä»£ç è½¬åŒ–å°±æ¶‰åŠåˆ°äº†è¯­æ³•è§£æï¼Œè¿™ä¾¿æ˜¯æˆ‘ä»¬çš„é‡ç‚¹ è‡ªå®šä¹‰ é¦–å…ˆæ–°å»ºä¸€ä¸ªé¡¹ç›® webpack é¡¹ç›® babel-demo ç›®å½•ç»“æ„å¦‚ä¸‹ 1234567891011.â”œâ”€â”€ README.mdâ”œâ”€â”€ babel-plugin-transform-classâ”‚ â””â”€â”€ index.jsâ”œâ”€â”€ distâ”‚ â””â”€â”€ bundle.jsâ”œâ”€â”€ package-lock.jsonâ”œâ”€â”€ package.jsonâ”œâ”€â”€ srcâ”‚ â””â”€â”€ index.jsâ””â”€â”€ webpack.config.js æ–°å»º package.json å¹¶ä½¿ç”¨ npm install å®‰è£…æ‰€éœ€æ’ä»¶ 1npm install -D babel-loader @babel/core @babel/preset-env webpack package.json 123456789101112&#123; &quot;scripts&quot;: &#123; &quot;start&quot;: &quot;webpack&quot; &#125;, &quot;dependencies&quot;: &#123;&#125;, &quot;devDependencies&quot;: &#123; &quot;@babel/core&quot;: &quot;^7.5.5&quot;, &quot;@babel/preset-env&quot;: &quot;^7.5.5&quot;, &quot;babel-loader&quot;: &quot;^8.0.6&quot;, &quot;webpack&quot;: &quot;^4.39.1&quot; &#125;&#125; æ–°å»º webpack æ–‡ä»¶ 1234567891011121314151617181920212223var path = require(&apos;path&apos;);module.exports = &#123; entry: &apos;./src/index.js&apos;, mode: &apos;development&apos;, output: &#123; path: path.join(__dirname, &apos;dist&apos;), filename: &apos;bundle.js&apos; &#125;, module: &#123; rules: [ &#123; test: /\\.js$/, loader: &apos;babel-loader&apos;, options: &#123; plugins: [ &quot;transform-class&quot; ] &#125; &#125; ] &#125;&#125; module é‡Œé¢çš„ rule ä¾¿æ˜¯é…ç½®æˆ‘ä»¬è‡ªå®šä¹‰çš„ babel æ’ä»¶ï¼Œtransform-class æ˜¯æ’ä»¶åã€‚ æ‰‹å†™æ’ä»¶ ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„æ’ä»¶ babel-plugin-transform-class/index.js 1234567891011// A plugin is just a functionmodule.exports = function (&#123; types: t &#125;) &#123; return &#123; visitor: &#123; Identifier(path) &#123; let name = path.node.name; // reverse the name: JavaScript -&gt; tpircSavaJ path.node.name = name.split(&apos;&apos;).reverse().join(&apos;&apos;); &#125; &#125; &#125;;&#125; å°† babel-plugin-transform-class æ–‡ä»¶å¤¹ç§»åŠ¨åˆ° node-modules ç›®å½•ä¸‹å³å¯ã€‚å½“è¿è¡Œ webpack çš„æ—¶å€™ï¼Œä¾¿ä¼šè¿è¡Œè¿™ä¸ªæ’ä»¶ï¼Œè¿™ä¸ªæ’ä»¶ä¼šæŠŠ node çš„ name åšåè½¬ã€‚ æˆ‘ä»¬çš„ demo 1234function babel() &#123; let javascript = &apos;hello babel&apos;; console.log(javascript);&#125; æ‰“åŒ…å 1eval(&quot;function lebab() &#123;\\n let tpircsavaj = &apos;hello babel&apos;;\\n elosnoc.gol(tpircsavaj);\\n&#125;\\n\\n//# sourceURL=webpack:///./src/index.js?&quot;); æˆ‘ä»¬çœ‹åˆ°å˜é‡åéƒ½åè½¬äº†ã€‚ æˆ‘ä»¬è¿˜å¯ä»¥å®ç°æ›´å¤šÂ·Â·Â·Â·Â·æ›´å¤šå±æ€§ï¼Œæ–¹æ³•åœ¨è¿™é‡Œ https://babeljs.io/docs/en/next/babel-types.html å‚è€ƒ AST https://astexplorer.net/","categories":[{"name":"JavaScript","slug":"JavaScript","permalink":"https://wzes.github.io/categories/JavaScript/"}],"tags":[{"name":"JavaScript","slug":"JavaScript","permalink":"https://wzes.github.io/tags/JavaScript/"},{"name":"Babel","slug":"Babel","permalink":"https://wzes.github.io/tags/Babel/"},{"name":"Node","slug":"Node","permalink":"https://wzes.github.io/tags/Node/"}]},{"title":"React Lazyload æºç è§£æ","slug":"JavaScript/React Lazyload","date":"2019-07-28T03:59:00.000Z","updated":"2019-09-02T12:17:04.380Z","comments":true,"path":"2019/07/28/JavaScript/React Lazyload/","link":"","permalink":"https://wzes.github.io/2019/07/28/JavaScript/React Lazyload/","excerpt":"","text":"å‰è¨€ æ—©åœ¨å¤šå¹´å‰ï¼Œlazyload å·²ç»å‡ºç°äº†ï¼Œæ‡’åŠ è½½åœ¨å‰ç«¯é‡Œè¾¹åŒæ ·å…·æœ‰ååˆ†é‡è¦çš„æ„ä¹‰ã€‚react-lazyload çš„ä½œç”¨æ˜¯å½“ç»„ä»¶æœªå‡ºç°åœ¨å±å¹•å†…æ—¶ï¼Œä¸å»æŒ‚è½½è¯¥ç»„ä»¶ï¼Œè€Œæ˜¯ä½¿ç”¨ placeholder å»æ¸²æŸ“ï¼Œè®©æ»šåŠ¨ä½¿å†…å®¹å‡ºç°åï¼Œç»„ä»¶ä¼šè¢«æŒ‚è½½ã€‚å°±æ˜¯è¿™ä¹ˆç®€å•ï¼ä¾‹å¦‚ï¼Œä¸€ä¸ªå¤æ‚çš„ç»„ä»¶ï¼ˆéé¦–å±å†…å®¹ï¼‰ï¼Œä½¿ç”¨äº†æ‡’åŠ è½½åï¼Œæ¸²æŸ“é¦–å±å°±ä¼šèŠ‚çœå¾ˆå¤šèµ„æºï¼Œä»è€Œå‡å°‘é¦–å±æ¸²æŸ“æ—¶é—´ã€‚ Demo æºç åœ°å€ react-lazyload Demoåœ°å€ Demo HelloWorld å°†éœ€è¦æ‡’åŠ è½½çš„ç»„ä»¶ä½¿ç”¨ LazyLoad åŒ…è£¹å³å¯ï¼Œæœ€å¥½ä½¿ç”¨ height è¿›è¡Œç«™ä½ï¼Œå¦åˆ™è¯¥ç»„ä»¶ä½ç½®å°†ä¼šä¸º 0 1234567&lt;LazyLoad height=&#123;200&#125;&gt; &lt;img src=&quot;tiger.jpg&quot; /&gt; /* Lazy loading images is supported out of box, no extra config needed, set `height` for better experience */ &lt;/LazyLoad&gt; è§£æ ä»æºç è§’åº¦åˆ†æï½ ä¸€è§ˆæ ¸å¿ƒ æœ¬å°èŠ‚æ‘˜å–äº†æœ€æ ¸å¿ƒçš„ä»£ç ï¼Œç›®çš„åœ¨äºå¯¹ LazyLoad ç»„ä»¶æœ‰ä¸ªæœ€æ ¸å¿ƒçš„è®¤è¯†ï¼Œå®ƒçš„æ ¸å¿ƒå°±æ˜¯ç›‘å¬æ»šåŠ¨äº‹ä»¶ï¼Œæ£€æŸ¥ç»„ä»¶æ˜¯å¦åœ¨å±å¹•å†…ï¼Œå¦‚æœåœ¨çš„è¯å°±æ˜¾ç¤ºï¼Œä¸åœ¨çš„è¯å°±ä¸æ˜¾ç¤ºï½ 12345678910111213class LazyLoad extends Component &#123; componentDidMount() &#123; on(scrollport, &apos;scroll&apos;, finalLazyLoadHandler, passiveEvent); &#125; render() &#123; return this.visible ? this.props.children : this.props.placeholder ? this.props.placeholder : &lt;div style=&#123;&#123; height: this.props.height &#125;&#125; className=&quot;lazyload-placeholder&quot; ref=&#123;this.setRef&#125; /&gt;; &#125;&#125; LazyLoad çš„å±æ€§ï¼Œé€è¿‡å±æ€§ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“å®ƒå¤§æ¦‚æœ‰äº›ä»€ä¹ˆåŠŸèƒ½ã€‚ 12345678910111213141516171819202122232425LazyLoad.propTypes = &#123; once: PropTypes.bool, height: PropTypes.oneOfType([PropTypes.number, PropTypes.string]), offset: PropTypes.oneOfType([PropTypes.number, PropTypes.arrayOf(PropTypes.number)]), overflow: PropTypes.bool, // ä¸æ˜¯ window æ»šåŠ¨ï¼Œè€Œä½¿ç”¨äº† overflow: scroll resize: PropTypes.bool, // æ˜¯å¦ç›‘å¬ resize scroll: PropTypes.bool, // æ˜¯å¦ç›‘å¬æ»šåŠ¨ children: PropTypes.node, throttle: PropTypes.oneOfType([PropTypes.number, PropTypes.bool]), debounce: PropTypes.oneOfType([PropTypes.number, PropTypes.bool]), placeholder: PropTypes.node, scrollContainer: PropTypes.oneOfType([PropTypes.string, PropTypes.object]), unmountIfInvisible: PropTypes.bool, preventLoading: PropTypes.bool&#125;;// é»˜è®¤å€¼LazyLoad.defaultProps = &#123; once: false, offset: 0, overflow: false, resize: false, scroll: true, unmountIfInvisible: false, preventLoading: false,&#125;; å®Œæ•´çš„ componentDidMountï¼Œscrollport æ˜¯æ»šåŠ¨è¯•å›¾ï¼Œé»˜è®¤æ˜¯ windowï¼Œå¦‚æœ props ä¼ å…¥äº† scrollContainerï¼Œé‚£ä¹ˆæ»šåŠ¨è¯•å›¾å°†æ˜¯è‡ªå®šä¹‰çš„ã€‚needResetFinalLazyLoadHandler æ˜¯æ§åˆ¶æ˜¯å¦é‡ç½®æ»šåŠ¨ç›‘å¬ã€‚debounce å’Œ throttle åˆ†åˆ«æ˜¯ç”¨æ¥æ§åˆ¶æ»šåŠ¨äº‹ä»¶çš„ç›‘å¬è§¦å‘é¢‘ç‡ï¼Œé»˜è®¤éƒ½æ˜¯ undefineï¼ŒneedResetFinalLazyLoadHandler åˆå§‹å€¼ä¸º falseã€‚finalLazyLoadHandler åˆå§‹å€¼ä¹Ÿä¸º undefineï¼Œè€Œ overflow ä¹Ÿä¸º falseï¼Œscroll ä¸º trueï¼Œlisteners æ˜¯éœ€è¦æ‡’åŠ è½½çš„ç»„ä»¶é›†åˆï¼Œåˆå§‹å¤§å°è‚¯å®šä¸º0ï¼ŒcomponentDidMount æœ€åæ‰ä¼šè¿›è¡Œæ·»åŠ ï¼Œå› æ­¤æœ€ç»ˆä¼šèµ°åˆ° **on(scrollport, â€˜scrollâ€™, finalLazyLoadHandler, passiveEvent)ï¼Œäº‹ä»¶åªéœ€è¦ä¸€æ¬¡ç»‘å®šå³å¯ã€‚ ** 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061componentDidMount() &#123; // It&apos;s unlikely to change delay type on the fly, this is mainly // designed for tests let scrollport = window; const &#123; scrollContainer, &#125; = this.props; if (scrollContainer) &#123; if (isString(scrollContainer)) &#123; scrollport = scrollport.document.querySelector(scrollContainer); &#125; &#125; const needResetFinalLazyLoadHandler = (this.props.debounce !== undefined &amp;&amp; delayType === &apos;throttle&apos;) || (delayType === &apos;debounce&apos; &amp;&amp; this.props.debounce === undefined); if (needResetFinalLazyLoadHandler) &#123; off(scrollport, &apos;scroll&apos;, finalLazyLoadHandler, passiveEvent); off(window, &apos;resize&apos;, finalLazyLoadHandler, passiveEvent); finalLazyLoadHandler = null; &#125; if (!finalLazyLoadHandler) &#123; if (this.props.debounce !== undefined) &#123; finalLazyLoadHandler = debounce(lazyLoadHandler, typeof this.props.debounce === &apos;number&apos; ? this.props.debounce : 300); delayType = &apos;debounce&apos;; &#125; else if (this.props.throttle !== undefined) &#123; finalLazyLoadHandler = throttle(lazyLoadHandler, typeof this.props.throttle === &apos;number&apos; ? this.props.throttle : 300); delayType = &apos;throttle&apos;; &#125; else &#123; finalLazyLoadHandler = lazyLoadHandler; &#125; &#125; if (this.props.overflow) &#123; const parent = scrollParent(this.ref); if (parent &amp;&amp; typeof parent.getAttribute === &apos;function&apos;) &#123; const listenerCount = 1 + (+parent.getAttribute(LISTEN_FLAG)); if (listenerCount === 1) &#123; parent.addEventListener(&apos;scroll&apos;, finalLazyLoadHandler, passiveEvent); &#125; parent.setAttribute(LISTEN_FLAG, listenerCount); &#125; &#125; else if (listeners.length === 0 || needResetFinalLazyLoadHandler) &#123; const &#123; scroll, resize &#125; = this.props; if (scroll) &#123; on(scrollport, &apos;scroll&apos;, finalLazyLoadHandler, passiveEvent); &#125; if (resize) &#123; on(window, &apos;resize&apos;, finalLazyLoadHandler, passiveEvent); &#125; &#125; listeners.push(this); checkVisible(this); &#125; é€šå¸¸ finalLazyLoadHandler å°±æ˜¯ lazyLoadHandlerï¼Œä¸ä¼šå¯¹æ»šåŠ¨äº‹ä»¶è¿›è¡Œ debounce æˆ– throttleï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¸ºäº†æ€§èƒ½ï¼Œä¼šä½¿ç”¨ throttle è¿›è¡Œå¤„ç†ã€‚å‡½æ•°ä¼šå¯¹æ¯ä¸€ä¸ªæ‡’åŠ è½½ç»„ä»¶è¿›è¡Œ checkVisibleï¼Œä¹‹åä¼šç§»é™¤ once component 12345678const lazyLoadHandler = () =&gt; &#123; for (let i = 0; i &lt; listeners.length; ++i) &#123; const listener = listeners[i]; checkVisible(listener); &#125; // Remove `once` component in listeners purgePending();&#125;; checkVisibleï¼Œæ£€æŸ¥ç»„ä»¶æ˜¯å¦å‡ºç°åœ¨ viewport ä¸­ï¼Œå¦‚æœå‡ºç°äº†å°±å§ visible è®¾ç½®ä¸º trueï¼Œå½“ç„¶å¦‚æœè®¾ç½®äº† unmountIfInvisible = trueï¼Œé‚£ä¹ˆä¸å¯è§æ—¶ç»„ä»¶å°†è¢«ç§»é™¤ï¼Œå¦‚æœä¹‹å‰å·²ç»æ¸²æŸ“äº†ï¼Œéœ€è¦é¿å…å†æ¬¡æ¸²æŸ“ã€‚ 12345678910111213141516171819202122232425262728293031const checkVisible = function checkVisible(component) &#123; const node = component.ref; if (!(node instanceof HTMLElement)) &#123; return; &#125; const parent = scrollParent(node); const isOverflow = component.props.overflow &amp;&amp; parent !== node.ownerDocument &amp;&amp; parent !== document &amp;&amp; parent !== document.documentElement; const visible = isOverflow ? checkOverflowVisible(component, parent) : checkNormalVisible(component); if (visible) &#123; // Avoid extra render if previously is visible if (!component.visible &amp;&amp; !component.preventLoading) &#123; if (component.props.once) &#123; pending.push(component); &#125; component.visible = true; component.forceUpdate(); &#125; &#125; else if (!(component.props.once &amp;&amp; component.visible)) &#123; component.visible = false; if (component.props.unmountIfInvisible) &#123; component.forceUpdate(); &#125; &#125;&#125;; checkNormalVisible æ£€æŸ¥ç»„ä»¶æ˜¯å¦ visible çš„å‡½æ•°ï¼Œåˆ¤æ–­ç»„ä»¶çš„getgetBoundingClientRect çš„ top - offsetï¼ˆç›¸å¯¹äºå±å¹•é¡¶éƒ¨çš„è·ç¦»ï¼‰ ä¸ window çš„ height ä¹‹é—´çš„å…³ç³» 12345678910111213141516171819202122232425const checkNormalVisible = function checkNormalVisible(component) &#123; const node = component.ref; // If this element is hidden by css rules somehow, it&apos;s definitely invisible if (!(node.offsetWidth || node.offsetHeight || node.getClientRects().length)) return false; let top; let elementHeight; try &#123; // è¿™ä¸ªè¯­æ³• node ä¹Ÿæ˜¯æ”¯æŒçš„ (&#123; top, height: elementHeight &#125; = node.getBoundingClientRect()); &#125; catch (e) &#123; (&#123; top, height: elementHeight &#125; = defaultBoundingClientRect); &#125; const windowInnerHeight = window.innerHeight || document.documentElement.clientHeight; const offsets = Array.isArray(component.props.offset) ? component.props.offset : [component.props.offset, component.props.offset]; // Be compatible with previous API return (top - offsets[0] &lt;= windowInnerHeight) &amp;&amp; (top + elementHeight + offsets[1] &gt;= 0);&#125;; 12(top - offsets[0] &lt;= windowInnerHeight) &amp;&amp; (top + elementHeight + offsets[1] &gt;= 0); ä¸€å¼ å›¾è§£æï¼ åˆ°è¿™é‡Œè§£æçš„å·®ä¸å¤šäº† æ¬£èµä¸€ä¸‹ throttle 12345678910111213141516171819202122export default function throttle(fn, threshhold, scope) &#123; threshhold || (threshhold = 250); var last, deferTimer; return function () &#123; var context = scope || this; var now = +new Date, args = arguments; if (last &amp;&amp; now &lt; last + threshhold) &#123; // hold on to it clearTimeout(deferTimer); deferTimer = setTimeout(function () &#123; last = now; fn.apply(context, args); &#125;, threshhold); &#125; else &#123; last = now; fn.apply(context, args); &#125; &#125;;&#125; å†æ¬£èµä¸€ä¸‹ debounce 12345678910111213141516171819202122232425262728293031323334353637383940414243export default function debounce(func, wait, immediate) &#123; let timeout; let args; let context; let timestamp; let result; const later = function later() &#123; const last = +(new Date()) - timestamp; if (last &lt; wait &amp;&amp; last &gt;= 0) &#123; timeout = setTimeout(later, wait - last); &#125; else &#123; timeout = null; if (!immediate) &#123; result = func.apply(context, args); if (!timeout) &#123; context = null; args = null; &#125; &#125; &#125; &#125;; return function debounced() &#123; context = this; args = arguments; timestamp = +(new Date()); const callNow = immediate &amp;&amp; !timeout; if (!timeout) &#123; timeout = setTimeout(later, wait); &#125; if (callNow) &#123; result = func.apply(context, args); context = null; args = null; &#125; return result; &#125;;&#125; è·å– scrollParent 12345678910111213141516171819202122232425262728293031323334export default (node) =&gt; &#123; if (!(node instanceof HTMLElement)) &#123; return document.documentElement; &#125; const excludeStaticParent = node.style.position === &apos;absolute&apos;; const overflowRegex = /(scroll|auto)/; let parent = node; while (parent) &#123; if (!parent.parentNode) &#123; return node.ownerDocument || document.documentElement; &#125; const style = window.getComputedStyle(parent); const position = style.position; const overflow = style.overflow; const overflowX = style[&apos;overflow-x&apos;]; const overflowY = style[&apos;overflow-y&apos;]; if (position === &apos;static&apos; &amp;&amp; excludeStaticParent) &#123; parent = parent.parentNode; continue; &#125; if (overflowRegex.test(overflow) &amp;&amp; overflowRegex.test(overflowX) &amp;&amp; overflowRegex.test(overflowY)) &#123; return parent; &#125; parent = parent.parentNode; &#125; return node.ownerDocument || node.documentElement || document.documentElement;&#125;; æ€»ç»“æ€è€ƒ æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒLazyload å¹¶ä¸èƒ½å®ç°ç±»ä¼¼å®¢æˆ·ç«¯çš„å›¾ç‰‡æ‡’åŠ è½½ï¼ŒLazyload åŠ è½½å›¾ç‰‡ä¹Ÿä¼šå‡ºç°ç™½å±æ—¶é—´ï¼Œè§£å†³åŠæ³•æ˜¯ä½¿ç”¨ image.onloadï¼Œå½“å›¾ç‰‡èµ„æºè¯·æ±‚å…³é—­åï¼Œå†æ˜¾ç¤ºå›¾ç‰‡ï¼Œå°±å¯ä»¥åšåˆ°ç±»ä¼¼å®¢æˆ·ç«¯çš„æ•ˆæœã€‚","categories":[{"name":"JavaScript","slug":"JavaScript","permalink":"https://wzes.github.io/categories/JavaScript/"}],"tags":[{"name":"JavaScript","slug":"JavaScript","permalink":"https://wzes.github.io/tags/JavaScript/"},{"name":"React","slug":"React","permalink":"https://wzes.github.io/tags/React/"},{"name":"Lazyload","slug":"Lazyload","permalink":"https://wzes.github.io/tags/Lazyload/"}]},{"title":"JavaScript Swipe-js-ios æºç è§£æ","slug":"JavaScript/Swipe-js-ios","date":"2019-07-20T06:38:00.000Z","updated":"2019-09-02T12:16:32.909Z","comments":true,"path":"2019/07/20/JavaScript/Swipe-js-ios/","link":"","permalink":"https://wzes.github.io/2019/07/20/JavaScript/Swipe-js-ios/","excerpt":"","text":"å‰è¨€ Swipeï¼Œå¸¸ç”¨æ¥åšè½®æ’­å›¾ï¼Œéœ€è¦ç¿»é¡µçš„åœºæ™¯ï¼Œæœ€ç»å…¸çš„å¼€æºåº“ swipe-js-iso ï¼Œä¸è¿‡æ›´æ¨èä½¿ç”¨ React ç»„ä»¶ react-swipeï¼Œå®ƒå°è£…äº† swipe-js-ios ç»„ä»¶ï¼Œè€Œ swipe-js-ios ç»„ä»¶åˆ™å°è£…äº† Swipe HelloWord å¦‚æœå•ç‹¬ä½¿ç”¨çš„åŒ–ï¼Œåˆ›å»ºä¸€ä¸ª swipeï¼Œdom å¿…é¡»æ˜¯ä¸‰å±‚ç»“æ„ï¼Œæœ€é‡Œé¢ä¸€å±‚æ˜¯æ”¾ slide çš„ã€‚ 1234567&lt;div id=&quot;slider&quot; class=&quot;swipe&quot;&gt; &lt;div class=&quot;swipe-wrap&quot;&gt; &lt;div&gt;&lt;/div&gt; &lt;div&gt;&lt;/div&gt; &lt;div&gt;&lt;/div&gt; &lt;/div&gt;&lt;/div&gt; CSS å­å…ƒç´  float: left; container çš„å®½åº¦ä¸ºè‡ªå®šä¹‰ï¼Œswipe-wrap çš„å®½åº¦ä¸ºå­é¡µé¢æ•° * container çš„ widthï¼Œæ¯ä¸€ä¸ª slide çš„å®½åº¦ä¸º container çš„ width 1234567891011121314.swipe &#123; overflow: hidden; visibility: hidden; position: relative;&#125;.swipe-wrap &#123; overflow: hidden; position: relative;&#125;.swipe-wrap &gt; div &#123; float: left; width: 100%; position: relative;&#125; load ä»¥åï¼Œåˆ›å»º Swipe å³å¯ 1const mySwipe = Swipe(document.getElementById(&apos;slider&apos;)); æºç è§£æ swipe-js-ios ä½¿ç”¨ç«‹å³å‡½æ•°å¯¼å‡ºäº†ä¸€ä¸ª Swipe æ¨¡å—ï¼Œä½¿ç”¨ typeof module !== â€˜undefinedâ€™ &amp;&amp; module.exports å…¼å®¹ Node å’Œ æµè§ˆå™¨ç¯å¢ƒï¼Œå¦‚æœæ˜¯ Node ç¯å¢ƒï¼Œå°†ä¼šæœ‰ module.export é‚£ä¹ˆåˆ™ä½¿ç”¨ module.export å¯¼å‡ºï¼Œå¦åˆ™ä½¿ç”¨ root.Swipe å…¨å±€å˜é‡å¯¼å‡º 123456789101112(function(root, factory) &#123; if (typeof module !== &apos;undefined&apos; &amp;&amp; module.exports) &#123; module.exports = factory(); &#125; else &#123; root.Swipe = factory(); &#125;&#125;)(this, function() &#123; &apos;use strict&apos;; return function Swipe(container, options) &#123; .... &#125;;&#125;); æ£€æŸ¥æµè§ˆå™¨çš„ç¯å¢ƒï¼Œç®—æ˜¯ä¸€ç§è§„èŒƒå§ï¼Œé£åˆ«æ£€æŸ¥è§¦æ‘¸äº‹ä»¶å’Œ transition çš„æ”¯æŒ âš ï¸åœ¨æµè§ˆå™¨ï¼Œæ‰‹æœºæ¨¡å¼ä¸‹ï¼Œè§¦æ‘¸äº‹ä»¶æ˜¯å­˜åœ¨çš„ï¼Œè€Œæ™®é€šæµè§ˆå™¨ä¸‹æ˜¯ä¸å­˜åœ¨çš„ï¼Œæ‰€ä»¥è¯¥ç»„ä»¶ä¸èƒ½åœ¨æ™®é€šæµè§ˆå™¨ä¸­ä½¿ç”¨ã€‚ 123456789101112131415161718var browser = &#123; addEventListener: !!window.addEventListener, touch: &apos;ontouchstart&apos; in window || (window.DocumentTouch &amp;&amp; document instanceof window.DocumentTouch), transitions: (function(temp) &#123; var props = [ &apos;transitionProperty&apos;, &apos;WebkitTransition&apos;, &apos;MozTransition&apos;, &apos;OTransition&apos;, &apos;msTransition&apos; ]; for (var i in props) if (temp.style[props[i]] !== undefined) return true; return false; &#125;)(document.createElement(&apos;swipe&apos;)) &#125;; åˆ›å»ºæ—¶ä¼šè°ƒç”¨ setupï¼Œç»§è€Œæ·»åŠ äº‹ä»¶ï¼Œtouch è§¦æ‘¸äº‹ä»¶ã€transitionend ç§»åŠ¨äº‹ä»¶ï¼Œresize é‡æ–°å¸ƒå±€äº‹ä»¶ 1234567891011121314151617181920212223242526272829// trigger setupsetup();// start auto slideshow if applicableif (delay) begin();// add event listenersif (browser.addEventListener) &#123; // set touchstart event on element if (browser.touch) &#123; element.addEventListener(&apos;touchstart&apos;, events, false); element.addEventListener(&apos;touchforcechange&apos;, function() &#123;&#125;, false); &#125; if (browser.transitions) &#123; element.addEventListener(&apos;webkitTransitionEnd&apos;, events, false); element.addEventListener(&apos;msTransitionEnd&apos;, events, false); element.addEventListener(&apos;oTransitionEnd&apos;, events, false); element.addEventListener(&apos;otransitionend&apos;, events, false); element.addEventListener(&apos;transitionend&apos;, events, false); &#125; // set resize event on window window.addEventListener(&apos;resize&apos;, events, false);&#125; else &#123; window.onresize = function() &#123; setup(); &#125;; // to play nice with old IE&#125; setup å‡½æ•°çš„å®ç°ï¼Œslides å°±æ˜¯å®¹å™¨é‡Œé¢çš„é¡µé¢ï¼Œcontinuous æ˜¯å¦è‡ªåŠ¨è½®æ’­ï¼ŒslidePos è®°å½•äº†æ¯ä¸€ä¸ªé¡µé¢çš„ä½ç½®ï¼Œwidth æ˜¯æ¯ä¸€ä¸ªé¡µé¢çš„å®½åº¦ï¼Œæ­¤å¤„éœ€è¦å‰ªæ‰widthOfSiblingSlidePreview çš„å¤§å°ï¼Œå¯ä»¥é¢„è§ˆå‰åé¡µã€‚element çš„å®½åº¦æ˜¯ **é¡µæ•° * width ** 1234567891011121314151617181920function setup() &#123; // cache slides slides = element.children; length = slides.length; // set continuous to false if only one slide continuous = slides.length &lt; 2 ? false : options.continuous; // create an array to store current positions of each slide slidePos = new Array(slides.length); // determine width of each slide width = Math.round( container.getBoundingClientRect().width || container.offsetWidth ) - widthOfSiblingSlidePreview * 2; element.style.width = slides.length * width + &apos;px&apos;; &#125; åˆå§‹åŒ–æ—¶ï¼Œéœ€è¦æ›´æ–°é¡µé¢çš„ä½ç½® 123456789101112var pos = slides.length;while (pos--) &#123; var slide = slides[pos]; slide.style.width = width + &apos;px&apos;; slide.setAttribute(&apos;data-index&apos;, pos); if (browser.transitions) &#123; slide.style.left = pos * -width + widthOfSiblingSlidePreview + &apos;px&apos;; move(pos, index &gt; pos ? -width : index &lt; pos ? width : 0, 0); &#125;&#125; å¦‚æœæ”¯æŒè½®æ’­çš„åŒ–ï¼Œéœ€è¦æŠŠå·¦è¾¹å’Œå³è¾¹ä¹Ÿå¡«å……ï¼Œç„¶åæŠŠ container.style.visibility è®¾ç½®ä¸º visibleï¼Œå¦‚æœä¸æ”¯æŒ transition çš„è¯ï¼Œåªéœ€è¦è®¾ç½® element.style.left å³å¯ 12345678910// reposition elements before and after index if (continuous &amp;&amp; browser.transitions) &#123; move(circle(index - 1), -width, 0); move(circle(index + 1), width, 0); &#125; if (!browser.transitions) element.style.left = index * -width + widthOfSiblingSlidePreview + &apos;px&apos;; container.style.visibility = &apos;visible&apos;; move çš„å®ç°ï¼Œtranslateï¼Œæ›´æ–° slidePos çš„ä½ç½® 1234function move(index, dist, speed) &#123; translate(index, dist, speed); slidePos[index] = dist;&#125; translate ä¸‰ä¸ªå‚æ•°ï¼Œindexï¼šéœ€è¦ç§»åŠ¨çš„é¡µï¼Œdistï¼šç§»åŠ¨çš„ä½ç½®ï¼Œspeedï¼šç§»åŠ¨é€Ÿåº¦ï¼Œç§»åŠ¨åªéœ€è¦ç»™ é¡µé¢è®¾ç½® style çš„ transform å°±OKäº†ï¼Œä¹‹åå°±ä¼šä»¥åŠ¨ç”»ç§»åŠ¨è¿‡å»äº† 12345678910111213function translate(index, dist, speed) &#123; var slide = slides[index]; var style = slide &amp;&amp; slide.style; if (!style) return; style.webkitTransitionDuration = style.MozTransitionDuration = style.msTransitionDuration = style.OTransitionDuration = style.transitionDuration = speed + &apos;ms&apos;; style.webkitTransform = &apos;translate(&apos; + dist + &apos;px,0)&apos; + &apos;translateZ(0)&apos;; style.msTransform = style.MozTransform = style.OTransform = &apos;translateX(&apos; + dist + &apos;px)&apos;; &#125; prev å¯¹å¤–æä¾›æ¥å£ï¼Œæ‰‹åŠ¨ç¿»é¡µä½¿ç”¨ 1234function prev() &#123; if (continuous) slide(index - 1); else if (index) slide(index - 1);&#125; slide ç§»åŠ¨å‡½æ•°ï¼ŒæŒ‡å®šç§»åŠ¨çš„é¡µ index å’Œé€Ÿåº¦ 12345678910111213141516171819202122232425262728293031323334353637383940414243function slide(to, slideSpeed) &#123; // do nothing if already on requested slide if (index == to) return; if (browser.transitions) &#123; var direction = Math.abs(index - to) / (index - to); // 1: backward, -1: forward // get the actual position of the slide if (continuous) &#123; var natural_direction = direction; direction = -slidePos[circle(to)] / width; // if going forward but to &lt; index, use to = slides.length + to // if going backward but to &gt; index, use to = -slides.length + to if (direction !== natural_direction) to = -direction * slides.length + to; &#125; var diff = Math.abs(index - to) - 1; // move all the slides between index and to in the right direction while (diff--) move( circle((to &gt; index ? to : index) - diff - 1), width * direction, 0 ); to = circle(to); move(index, width * direction, slideSpeed || speed); move(to, 0, slideSpeed || speed); if (continuous) move(circle(to - direction), -(width * direction), 0); // we need to get the next in place &#125; else &#123; to = circle(to); animate(index * -width, to * -width, slideSpeed || speed); //no fallback for a circular continuous if the browser does not accept transitions &#125; index = to; offloadFn(options.callback &amp;&amp; options.callback(index, slides[index])); &#125; å¦‚æœæµè§ˆå™¨ä¸æ”¯æŒ transitionï¼Œé‚£ä¹ˆåˆ™ä½¿ç”¨ setInterval å®ç°æ¸è¿›ç§»åŠ¨ï¼Œ animation æ˜¯å¯¹æ•´ä¸ªé¡µé¢è¿›è¡Œç§»åŠ¨ï¼Œè€Œ move æ˜¯ç§»åŠ¨æ¯ä¸€ä¸ªå­é¡µé¢ 123456789101112131415161718192021222324252627282930function animate(from, to, speed) &#123; // if not an animation, just reposition if (!speed) &#123; element.style.left = to + &apos;px&apos;; return; &#125; var start = +new Date(); var timer = setInterval(function() &#123; var timeElap = +new Date() - start; if (timeElap &gt; speed) &#123; element.style.left = to + &apos;px&apos;; if (delay) begin(); options.transitionEnd &amp;&amp; options.transitionEnd.call(event, index, slides[index]); clearInterval(timer); return; &#125; element.style.left = (to - from) * (Math.floor((timeElap / speed) * 100) / 100) + from + &apos;px&apos;; &#125;, 4); &#125; æ¥ä¸‹æ¥ç ”ç©¶ä¸€ä¸‹è§¦æ‘¸äº‹ä»¶çš„å¤„ç†ï¼Œé¦–å…ˆæ˜¯ startï¼Œstart äº‹ä»¶ä¼šè®°å½•èµ·å§‹è§¦æ‘¸ä½ç½®ä»¥åŠæ—¶é—´ï¼Œå¹¶ä¸”æ·»åŠ  touchmove å’Œ touchend äº‹ä»¶ï¼Œå¦‚æœæ²¡æœ‰ start äº‹ä»¶ï¼Œè§¦æ‘¸äº‹ä»¶æ˜¯ä¸å­˜åœ¨çš„ï¼Œ end çš„æ—¶å€™ä¼šè¢«ç§»é™¤ã€‚ 1234567891011121314151617181920212223start: function(event) &#123; var touches = event.touches[0]; // measure start values start = &#123; // get initial touch coords x: touches.pageX, y: touches.pageY, // store time to determine touch duration time: +new Date() &#125;; // used for testing first move event isScrolling = undefined; // reset delta and end measurements delta = &#123;&#125;; // attach touchmove and touchend listeners element.addEventListener(&apos;touchmove&apos;, this, false); element.addEventListener(&apos;touchend&apos;, this, false); &#125;, move äº‹ä»¶ï¼Œdelta å°†æ‰‹æŒ‡ç§»åŠ¨è·ç¦»è®°ä¸‹ï¼Œæœ€åè§†åŒ translate ç§»åŠ¨ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162move: function(event) &#123; // ensure swiping with one touch and not pinching if (event.touches.length &gt; 1 || (event.scale &amp;&amp; event.scale !== 1)) return; if (options.disableScroll) return; var touches = event.touches[0]; // measure change in x and y delta = &#123; x: touches.pageX - start.x, y: touches.pageY - start.y &#125;; // determine if scrolling test has run - one time test if (typeof isScrolling == &apos;undefined&apos;) &#123; isScrolling = !!( isScrolling || Math.abs(delta.x) &lt; Math.abs(delta.y) ); &#125; // if user is not trying to scroll vertically if (!isScrolling) &#123; // prevent native scrolling event.preventDefault(); // stop slideshow stop(); // increase resistance if first or last slide if (continuous) &#123; // we don&apos;t add resistance at the end translate( circle(index - 1), delta.x + slidePos[circle(index - 1)], 0 ); translate(index, delta.x + slidePos[index], 0); translate( circle(index + 1), delta.x + slidePos[circle(index + 1)], 0 ); &#125; else &#123; delta.x = delta.x / ((!index &amp;&amp; delta.x &gt; 0) || // if first slide and sliding left (index == slides.length - 1 &amp;&amp; // or if last slide and sliding right delta.x &lt; 0) // and if sliding at all ? Math.abs(delta.x) / width + 1 // determine resistance level : 1); // no resistance if false // translate 1:1 translate(index - 1, delta.x + slidePos[index - 1], 0); translate(index, delta.x + slidePos[index], 0); translate(index + 1, delta.x + slidePos[index + 1], 0); &#125; options.swiping &amp;&amp; options.swiping(-delta.x / width); &#125; &#125;, end äº‹ä»¶ï¼Œä¸»è¦åˆ¤æ–­æœ¬æ¬¡è§¦æ‘¸æ»‘åŠ¨æ˜¯å¦æœ‰æ•ˆï¼Œå¹¶æŒç»­æ¥ä¸‹æ¥çš„æ“ä½œï¼Œæœ€åå°†ä¼š remove æ‰ç›‘å¬äº‹ä»¶ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778end: function(event) &#123; // measure duration var duration = +new Date() - start.time; // determine if slide attempt triggers next/prev slide var isValidSlide = (Number(duration) &lt; 250 &amp;&amp; // if slide duration is less than 250ms Math.abs(delta.x) &gt; 20) || // and if slide amt is greater than 20px Math.abs(delta.x) &gt; width / 2; // or if slide amt is greater than half the width // determine if slide attempt is past start and end var isPastBounds = (!index &amp;&amp; delta.x &gt; 0) || // if first slide and slide amt is greater than 0 (index == slides.length - 1 &amp;&amp; delta.x &lt; 0); // or if last slide and slide amt is less than 0 if (continuous) isPastBounds = false; // determine direction of swipe (true:right, false:left) var direction = delta.x &lt; 0; // if not scrolling vertically if (!isScrolling) &#123; if (isValidSlide &amp;&amp; !isPastBounds) &#123; if (direction) &#123; if (continuous) &#123; // we need to get the next in this direction in place move(circle(index - 1), -width, 0); move(circle(index + 2), width, 0); &#125; else &#123; move(index - 1, -width, 0); &#125; move(index, slidePos[index] - width, speed); move( circle(index + 1), slidePos[circle(index + 1)] - width, speed ); index = circle(index + 1); &#125; else &#123; if (continuous) &#123; // we need to get the next in this direction in place move(circle(index + 1), width, 0); move(circle(index - 2), -width, 0); &#125; else &#123; move(index + 1, width, 0); &#125; move(index, slidePos[index] + width, speed); move( circle(index - 1), slidePos[circle(index - 1)] + width, speed ); index = circle(index - 1); &#125; options.callback &amp;&amp; options.callback(index, slides[index]); &#125; else &#123; if (continuous) &#123; move(circle(index - 1), -width, speed); move(index, 0, speed); move(circle(index + 1), width, speed); &#125; else &#123; move(index - 1, -width, speed); move(index, 0, speed); move(index + 1, width, speed); &#125; &#125; &#125; // kill touchmove and touchend event listeners until touchstart called again element.removeEventListener(&apos;touchmove&apos;, events, false); element.removeEventListener(&apos;touchend&apos;, events, false); element.removeEventListener(&apos;touchforcechange&apos;, function() &#123;&#125;, false); &#125;, æ€»ç»“ æ€»çš„æ¥è¯´ï¼Œswipe-js-ios å……åˆ†åˆ©ç”¨äº† transitionï¼Œæ¥å®ç°ç§»åŠ¨åŠ¨ç”»ï¼Œææ¸…æ¥šè§¦æ‘¸äº‹ä»¶å°±æ¯”è¾ƒå®¹æ˜“èƒ½å†™å‡ºæ¥å¯æ»‘åŠ¨çš„ swipe","categories":[{"name":"JavaScript","slug":"JavaScript","permalink":"https://wzes.github.io/categories/JavaScript/"}],"tags":[{"name":"JavaScript","slug":"JavaScript","permalink":"https://wzes.github.io/tags/JavaScript/"},{"name":"HTML","slug":"HTML","permalink":"https://wzes.github.io/tags/HTML/"},{"name":"DOM","slug":"DOM","permalink":"https://wzes.github.io/tags/DOM/"}]},{"title":"JavaScript Webpack æºç è§£æ","slug":"JavaScript/Webpack","date":"2019-07-13T11:59:16.000Z","updated":"2019-09-02T12:17:16.955Z","comments":true,"path":"2019/07/13/JavaScript/Webpack/","link":"","permalink":"https://wzes.github.io/2019/07/13/JavaScript/Webpack/","excerpt":"","text":"å‰è¨€ ç®—æ˜¯ä¸€ä¸ªh5å¼€å‘äº†ï¼Œè™½ç„¶æ²¡å†™è¿‡ä»€ä¹ˆå®Œæ•´çš„å‰ç«¯é¡µé¢ï¼Œä½†æ¥è§¦å‰ç«¯ä¹Ÿæœ‰æ®µæ—¶é—´äº†ï¼Œå¯¹äºä¸€ä¸ªåˆæ ¼çš„å‰ç«¯å¼€å‘è€…è€Œè¨€ï¼Œææ‡‚ webpack æ‰“åŒ…åŸç†è¿˜æ˜¯æ¯”è¾ƒé‡è¦çš„ hello world ä½¿ç”¨ commonjs è§„èŒƒï¼Œlib.js åªå¯¼å‡ºä¸€ä¸ªæ–¹æ³• 1234// lib.jsmodule.exports = function () &#123; return &quot;hello webpack!&quot;&#125; index.js ä½¿ç”¨ require å¼•å…¥ï¼Œä»£ç å¾ˆç®€å•ï¼Œè¾“å…¥æ–¹æ³•è¿”å›å€¼ 123456// index.jsconst func = require(&quot;./lib&quot;)const result = func()// print helloconsole.log(result) ç›®å½•ç»“æ„ 12345678910.â”œâ”€â”€ distâ”‚ â””â”€â”€ main.jsâ”œâ”€â”€ package-lock.jsonâ”œâ”€â”€ package.jsonâ”œâ”€â”€ node_modulesâ”œâ”€â”€ srcâ”‚ â”œâ”€â”€ index.jsâ”‚ â””â”€â”€ lib.jsâ””â”€â”€ webpack.config.js webpack.config.js ä¸ºäº†æ–¹ä¾¿çœ‹ç”Ÿæˆçš„æºç ï¼Œæˆ‘ä»¬å°† mode è®¾ç½®ä¸º developmentï¼Œ 1234567891011var path = require(&apos;path&apos;);module.exports = &#123; context: path.resolve(__dirname, &apos;./&apos;), mode: &apos;development&apos;, entry: &apos;./src/index.js&apos;, output: &#123; path: path.resolve(__dirname, &apos;dist&apos;), filename: &apos;main.js&apos; &#125;&#125;; package.json 123456789101112131415161718&#123; &quot;name&quot;: &quot;webpack-demo&quot;, &quot;version&quot;: &quot;1.0.0&quot;, &quot;description&quot;: &quot;&quot;, &quot;private&quot;: true, &quot;scripts&quot;: &#123; &quot;test&quot;: &quot;echo \\&quot;Error: no test specified\\&quot; &amp;&amp; exit 1&quot;, &quot;build&quot;: &quot;webpack&quot; &#125;, &quot;keywords&quot;: [], &quot;author&quot;: &quot;&quot;, &quot;license&quot;: &quot;ISC&quot;, &quot;devDependencies&quot;: &#123; &quot;webpack&quot;: &quot;^4.35.2&quot;, &quot;webpack-cli&quot;: &quot;^3.3.5&quot; &#125;, &quot;dependencies&quot;: &#123;&#125;&#125; ç¼–è¯‘è¿è¡Œ 12npm run buildnode dist/main.js è¾“å‡º 12$ node dist/main.js hello webpack! èµ·æº æµè§ˆå™¨ï¼Œnode å¹¶ä¸æ”¯æŒæ¨¡å—åŒ–ï¼Œæˆ‘ä»¬åœ¨é¡¹ç›®ä¸­ä½¿ç”¨çš„ requireã€export å°†ä¼šç»è¿‡ webpack åï¼Œè¿™äº› js å°±ä¼šè¢«æ‰“åŒ…æ•´åˆæˆä¸€ä¸ª js æ–‡ä»¶ï¼Œåªéœ€è¦è¿è¡Œ js æ–‡ä»¶ï¼Œæ•´ä¸ªæ¨¡å—å°†ä¼šè¿è¡Œèµ·æ¥äº†ã€‚ main.js è§£æ æ•´ä¸ªæ–‡ä»¶åªæœ‰ 111 è¡Œï¼Œè¿™æ˜¯æœªç»è¿‡å‹ç¼©çš„ç‰ˆæœ¬ï¼Œç”Ÿäº§ç¯å¢ƒä¸‹çš„è¾“å‡ºæ–‡ä»¶æ¯”è¿™è¿˜è¦ç²¾ç®€ï¼Œåªéœ€è¦åœ¨ webpack.config.js ä¸­å°† mode å€¼ç­‰äº production å³å¯æ”¹å˜æ‰“åŒ…ç¯å¢ƒ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111/******/ (function(modules) &#123; // webpackBootstrap/******/ // The module cache/******/ var installedModules = &#123;&#125;;/******//******/ // The require function/******/ function __webpack_require__(moduleId) &#123;/******//******/ // Check if module is in cache/******/ if(installedModules[moduleId]) &#123;/******/ return installedModules[moduleId].exports;/******/ &#125;/******/ // Create a new module (and put it into the cache)/******/ var module = installedModules[moduleId] = &#123;/******/ i: moduleId,/******/ l: false,/******/ exports: &#123;&#125;/******/ &#125;;/******//******/ // Execute the module function/******/ modules[moduleId].call(module.exports, module, module.exports, __webpack_require__);/******//******/ // Flag the module as loaded/******/ module.l = true;/******//******/ // Return the exports of the module/******/ return module.exports;/******/ &#125;/******//******//******/ // expose the modules object (__webpack_modules__)/******/ __webpack_require__.m = modules;/******//******/ // expose the module cache/******/ __webpack_require__.c = installedModules;/******//******/ // define getter function for harmony exports/******/ __webpack_require__.d = function(exports, name, getter) &#123;/******/ if(!__webpack_require__.o(exports, name)) &#123;/******/ Object.defineProperty(exports, name, &#123; enumerable: true, get: getter &#125;);/******/ &#125;/******/ &#125;;/******//******/ // define __esModule on exports/******/ __webpack_require__.r = function(exports) &#123;/******/ if(typeof Symbol !== &apos;undefined&apos; &amp;&amp; Symbol.toStringTag) &#123;/******/ Object.defineProperty(exports, Symbol.toStringTag, &#123; value: &apos;Module&apos; &#125;);/******/ &#125;/******/ Object.defineProperty(exports, &apos;__esModule&apos;, &#123; value: true &#125;);/******/ &#125;;/******//******/ // create a fake namespace object/******/ // mode &amp; 1: value is a module id, require it/******/ // mode &amp; 2: merge all properties of value into the ns/******/ // mode &amp; 4: return value when already ns object/******/ // mode &amp; 8|1: behave like require/******/ __webpack_require__.t = function(value, mode) &#123;/******/ if(mode &amp; 1) value = __webpack_require__(value);/******/ if(mode &amp; 8) return value;/******/ if((mode &amp; 4) &amp;&amp; typeof value === &apos;object&apos; &amp;&amp; value &amp;&amp; value.__esModule) return value;/******/ var ns = Object.create(null);/******/ __webpack_require__.r(ns);/******/ Object.defineProperty(ns, &apos;default&apos;, &#123; enumerable: true, value: value &#125;);/******/ if(mode &amp; 2 &amp;&amp; typeof value != &apos;string&apos;) for(var key in value) __webpack_require__.d(ns, key, function(key) &#123; return value[key]; &#125;.bind(null, key));/******/ return ns;/******/ &#125;;/******//******/ // getDefaultExport function for compatibility with non-harmony modules/******/ __webpack_require__.n = function(module) &#123;/******/ var getter = module &amp;&amp; module.__esModule ?/******/ function getDefault() &#123; return module[&apos;default&apos;]; &#125; :/******/ function getModuleExports() &#123; return module; &#125;;/******/ __webpack_require__.d(getter, &apos;a&apos;, getter);/******/ return getter;/******/ &#125;;/******//******/ // Object.prototype.hasOwnProperty.call/******/ __webpack_require__.o = function(object, property) &#123; return Object.prototype.hasOwnProperty.call(object, property); &#125;;/******//******/ // __webpack_public_path__/******/ __webpack_require__.p = &quot;&quot;;/******//******//******/ // Load entry module and return exports/******/ return __webpack_require__(__webpack_require__.s = &quot;./src/index.js&quot;);/******/ &#125;)/************************************************************************//******/ (&#123;/***/ &quot;./src/index.js&quot;:/*!**********************!*\\ !*** ./src/index.js ***! \\**********************//*! no static exports found *//***/ (function(module, exports, __webpack_require__) &#123;eval(&quot;// index.js\\nconst func = __webpack_require__(/*! ./lib */ \\&quot;./src/lib.js\\&quot;)\\n\\nconst result = func()\\n// print hello\\nconsole.log(result)\\n\\n//# sourceURL=webpack:///./src/index.js?&quot;);/***/ &#125;),/***/ &quot;./src/lib.js&quot;:/*!********************!*\\ !*** ./src/lib.js ***! \\********************//*! no static exports found *//***/ (function(module, exports) &#123;eval(&quot;module.exports = function () &#123;\\n return \\&quot;hello webpack!\\&quot;\\n&#125;\\n\\n//# sourceURL=webpack:///./src/lib.js?&quot;);/***/ &#125;)/******/ &#125;); æˆ‘ä»¬å…ˆå°†æ­¤æ–‡ä»¶çš„ä¸»è¦éƒ¨åˆ†æ‹¿å‡ºæ¥çœ‹ 123456789101112131415161718192021222324252627282930313233/******/(function (modules) &#123; var installedModules = &#123;&#125; function __webpack_require__ (moduleId) &#123; if (installedModules[moduleId]) &#123; return installedModules[moduleId].exports &#125; var module = installedModules[moduleId] = &#123; i: moduleId, l: false, exports: &#123;&#125; &#125; modules[moduleId].call(module.exports, module, module.exports, __webpack_require__) module.l = true return module.exports &#125; return __webpack_require__(__webpack_require__.s = &apos;./src/index.js&apos;)&#125;)(&#123; &apos;./src/index.js&apos;: (function (module, exports, __webpack_require__) &#123; eval( &apos;// index.js\\nconst func = __webpack_require__(/*! ./lib */ &quot;./src/lib.js&quot;)\\n\\nconst result = func()\\n// print hello\\nconsole.log(result)\\n\\n//# sourceURL=webpack:///./src/index.js?&apos;) &#125;), &apos;./src/lib.js&apos;: (function (module, exports) &#123; eval( &apos;module.exports = function () &#123;\\n return &quot;hello webpack!&quot;\\n&#125;\\n\\n//# sourceURL=webpack:///./src/lib.js?&apos;) &#125;)&#125;) è¿™æ˜¯ä¸€ä¸ªç«‹å³æ‰§è¡Œå‡½æ•°ï¼Œé¦–å…ˆç”³æ˜äº† installedModules å¯¹è±¡ï¼Œè¿™æ˜¯å·²å®‰è£…çš„æ¨¡å—é›†åˆï¼Œä¹‹åå®šä¹‰äº†ä¸€ä¸ªå‡½æ•° webpack_require ï¼Œæ­¤å‡½æ•°ç”¨æ¥è·å–æ¨¡å—çš„å¼•ç”¨ï¼Œæœ€å return äº†æ­¤å‡½æ•°ï¼Œå‚æ•°ä¸ºå…¥å£ï¼ŒmoduleId = â€˜./src/index.jsâ€™ modules å³ä¸º 123456789101112&#123; &apos;./src/index.js&apos;: (function (module, exports, __webpack_require__) &#123; eval( &apos;// index.js\\nconst func = __webpack_require__(/*! ./lib */ &quot;./src/lib.js&quot;)\\n\\nconst result = func()\\n// print hello\\nconsole.log(result)\\n\\n//# sourceURL=webpack:///./src/index.js?&apos;) &#125;), &apos;./src/lib.js&apos;: (function (module, exports) &#123; eval( &apos;module.exports = function () &#123;\\n return &quot;hello webpack!&quot;\\n&#125;\\n\\n//# sourceURL=webpack:///./src/lib.js?&apos;) &#125;)&#125; 1modules[moduleId].call(module.exports, module, module.exports, __webpack_require__) module å³æ¨¡å—ï¼Œmodules[moduleId] å³ä¸º 1234(function (module, exports, __webpack_require__) &#123; eval( &apos;// index.js\\nconst func = __webpack_require__(/*! ./lib */ &quot;./src/lib.js&quot;)\\n\\nconst result = func()\\n// print hello\\nconsole.log(result)\\n\\n//# sourceURL=webpack:///./src/index.js?&apos;) &#125;) module.exports ä¸º this ä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œè¯¥å‡½æ•°æ‰§è¡Œä¸­ï¼Œç¬¬ä¸€è¡Œå³è°ƒç”¨ 1const func = __webpack_require__(&quot;./src/lib.js&quot;) webpack_require(&quot;./src/lib.js&quot;) å³è°ƒç”¨äº†æ­¤å‡½æ•° 1234(function (module, exports) &#123; eval( &apos;module.exports = function () &#123;\\n return &quot;hello webpack!&quot;\\n&#125;\\n\\n//# sourceURL=webpack:///./src/lib.js?&apos;) &#125;) æœ€åè¿”å› module.exports å³ lib é‡Œé¢çš„å¯¼å‡ºå‡½æ•°ã€‚å†å¾€åæ‰§è¡Œä¾¿æ˜¯ 123const result = func()// print helloconsole.log(result) æ­¤åˆ»åŸºæœ¬å·²ç»å°†å…³ç³»ç†é¡ºäº†ï¼Œæ­¤åå¦‚æœåœ¨è°ƒç”¨æ¨¡å—ï¼Œåˆ™ä¸–ç•Œä» installedModules ä¸­ç›´æ¥è¿”å›ã€‚ æ€»ç»“ æ­¤æ–‡åªæ˜¯åˆ†æäº†ç®€å•çš„æ¨¡å—å¼•ç”¨ï¼Œéœ€è¦ä»”ç»†åˆ†ææ‰èƒ½èä¼šè´¯é€šã€‚","categories":[{"name":"JavaScript","slug":"JavaScript","permalink":"https://wzes.github.io/categories/JavaScript/"}],"tags":[{"name":"JavaScript","slug":"JavaScript","permalink":"https://wzes.github.io/tags/JavaScript/"},{"name":"Webpack","slug":"Webpack","permalink":"https://wzes.github.io/tags/Webpack/"}]},{"title":"Android PageTransformer æºç è§£æ","slug":"Android/PageTransformer","date":"2019-07-05T12:35:00.000Z","updated":"2019-09-02T12:19:17.763Z","comments":true,"path":"2019/07/05/Android/PageTransformer/","link":"","permalink":"https://wzes.github.io/2019/07/05/Android/PageTransformer/","excerpt":"","text":"å‰è¨€ ä½œä¸ºä¸€ä¸ªå¾ˆä¹…æ²¡å†™è¿‡ Android ä¸šåŠ¡çš„äººï¼Œå¿ƒé‡Œæœ‰ç‚¹æ…Œäº†ï¼Œäºæ˜¯æ‹¿èµ· Android Studioï¼Œè¿˜æ˜¯æ‰¾ç‚¹ä¸œè¥¿å­¦ä¹ ä¸€ä¸‹ï¼Œå¹¶ä¸”è®°å½•ä¸€ä¸‹ã€‚ä¸€ç›´è§‰å¾— ViewPager æ˜¯ä¸ªå¥½ä¸œè¥¿ï¼Œå¶ç„¶é—´çœ‹åˆ°ä¸€äº›å¾ˆå¥½çš„æ¡ˆä¾‹ï¼Œå¾ˆé…·ç‚«çš„ç¿»é¡µæ•ˆæœã€‚ç›´åˆ°äº†è§£äº†è¿™ä¸ªä¸œè¥¿çš„å®ç°åŸæ¥æ²¡æœ‰æƒ³è±¡ä¸­çš„é‚£ä¹ˆå¤æ‚ï¼Œä½†å¦‚æœæ²¡æœ‰æ·±åˆ»ç†è§£ï¼Œè¿˜æ˜¯å¾ˆéš¾å†™å‡ºé…·ç‚«çš„æ•ˆæœçš„ã€‚äºæ˜¯ï¼Œ ViewPager Transformer çš„å­¦ä¹ å°±æä¸Šäº†æ—¥ç¨‹ã€‚ Hello World é¦–å…ˆæˆ‘ä»¬æ¥å®ç°ä¸€ä¸ªåœºæ™¯ï¼Œå¾ˆç®€å•ï¼Œåªéœ€è¦ä¸€ä¸ª ViewPagerï¼Œç„¶åç»™ä»–è®¾ç½®å‡ é¡µç”¨æ¥å±•ç°æ•ˆæœå°±è¡Œäº† Layout æ–‡ä»¶ åªéœ€è¦æ”¾å…¥ä¸€ä¸ª ViewPager 123456789101112131415&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;&lt;androidx.constraintlayout.widget.ConstraintLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot; xmlns:tools=&quot;http://schemas.android.com/tools&quot; xmlns:app=&quot;http://schemas.android.com/apk/res-auto&quot; android:layout_width=&quot;match_parent&quot; android:layout_height=&quot;match_parent&quot; tools:context=&quot;.MainActivity&quot;&gt; &lt;androidx.viewpager.widget.ViewPager android:layout_width=&quot;match_parent&quot; android:layout_height=&quot;match_parent&quot; android:id=&quot;@+id/view_pager&quot;&gt; &lt;/androidx.viewpager.widget.ViewPager&gt;&lt;/androidx.constraintlayout.widget.ConstraintLayout&gt; ä¹‹åï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª PageAdapterï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ FragmentPagerAdapterï¼ŒgetItem è¿”å›ä¸€ä¸ª Fragment å°±å¥½äº† 12345678910111213141516171819202122232425262728293031class PageAdapter(fm: FragmentManager) : FragmentPagerAdapter(fm) &#123; override fun getItem(position: Int): Fragment &#123; return PageFragment(&quot;Fragment $position&quot;, position) &#125; override fun getCount(): Int &#123; return 4 &#125; @SuppressLint(&quot;ValidFragment&quot;) class PageFragment(private var content: String, private var position: Int) : Fragment() &#123; private val colors = Arrays.asList(Color.GRAY, Color.RED, Color.BLUE, Color.YELLOW)!! override fun onActivityCreated(savedInstanceState: Bundle?) &#123; super.onActivityCreated(savedInstanceState) text_view.text = content &#125; override fun onCreateView( inflater: LayoutInflater, container: ViewGroup?, savedInstanceState: Bundle? ): View? &#123; val view = inflater.inflate(R.layout.tab_item, container, false) view.setBackgroundColor(colors[position % colors.size]) view.tag = &quot;$position&quot; return view &#125; &#125;&#125; åœ¨æˆ‘ä»¬çš„ Activity ä¸­ï¼Œè®¾ç½® view_pagerï¼Œè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±äºæˆ‘ä»¬ä½¿ç”¨äº† FragmentPagerAdapterï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨å±•ç¤ºæ˜¯å¦‚æœéœ€è¦å±•ç¤ºå¤šé¡µçš„è¯ï¼Œå¿…é¡»è®¾ç½®ä¸º offscreenPageLimit ä¸€ä¸ªæ¯”è¾ƒå¤§çš„å€¼ï¼Œä»¥ä¾¿ ViewPager èƒ½å¤Ÿæ¸²æŸ“è¶³å¤Ÿå¤šçš„é¡µé¢æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ã€‚ æœ€åä¸º ViewPager è®¾ç½®ä¸€ä¸ª PageTransformer 12345678910111213class MainActivity : AppCompatActivity() &#123; override fun onCreate(savedInstanceState: Bundle?) &#123; super.onCreate(savedInstanceState) setContentView(R.layout.activity_main) view_pager.adapter = PageAdapter(supportFragmentManager) view_pager.offscreenPageLimit = 4 view_pager.setPageTransformer(true, ViewPagerTransformer(TransformType.DEPTH)) &#125;&#125; ä¸€ä¸ªæ¯”è¾ƒç®€å•çš„ PageTransformer çš„å®ç°å¦‚ä¸‹ 12345class ViewPagerTransformer : ViewPager.PageTransformer &#123; override fun transformPage(page: View, position: Float) &#123; page.rotationY = position * -30f &#125;&#125; æ•ˆæœå¦‚ä¸‹ï¼Œç¿»é¡µæ—¶ä¼šæ ¹æ®ä½ç½®ä¿®æ”¹é¡µé¢çš„æ˜¾ç¤ºï¼Œé¡µé¢å°†ä¼šç»• Y è½´è¿›è¡Œæ—‹è½¬ä¸€å®šçš„è§’åº¦ï¼Œæ•ˆæœå¾ˆèµå§ï¼ï¼ï¼åªç”¨äº†ä¸€ç‚¹ä»£ç  ViewPager.PageTransformer å®šä¹‰ PageTransfomer æ¥å£åªæœ‰ä¸€ä¸ªæ–¹æ³•ï¼Œè¯¥æ–¹æ³•æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯ pageï¼ŒæŒ‡çš„æ˜¯ ViewPage çš„ä¸€ä¸ªå†…å®¹é¡µ 1234567891011public interface PageTransformer &#123; /** * Apply a property transformation to the given page. * * @param page Apply the transformation to this page * @param position Position of page relative to the current front-and-center * position of the pager. 0 is front and center. 1 is one full * page position to the right, and -1 is one page position to the left. */ void transformPage(@NonNull View page, float position);&#125; position æŒ‡çš„æ˜¯è¯¥å†…å®¹é¡µçš„ä½ç½®åç§»ï¼Œè¯¥åç§»æ˜¯ç›¸å¯¹çš„ï¼Œå…·ä½“è¡¨ç¤ºè¯·çœ‹ä¸€å¼ å›¾ï¼Œé¡µé¢é™æ­¢æ—¶ï¼Œä»¥å±å¹•å·¦è¾¹ç•Œä¸º 0ï¼Œå±å¹•å†…çš„é¡µé¢ position ä¸º0ï¼Œå·¦è¾¹ä¸º-1ï¼Œä¾æ¬¡é€’å‡ï¼Œå³ä¾§ä¸º1ï¼Œä¾æ¬¡é€’å¢ã€‚å½“å±å¹•æ»‘åŠ¨æ—¶ï¼Œpage2åªå‡ºç°ä¸€åŠï¼Œæ­¤æ—¶ï¼Œpage2 çš„ position ä¸º-0.5ï¼Œpage3 ä¸º0.5ï¼Œä¾æ¬¡ç±»æ¨å¯å¾—å‡ºå…¶ä»–page å›è°ƒçš„ position å€¼ å®è·µ 1ã€æ·¡å…¥æ·¡å‡º æ•ˆæœ é¡µé¢éšç€ä½ç½®æ”¹å˜é€æ˜åº¦ï¼Œalpha = 0 æ˜¯é€æ˜ï¼Œalpha = 1 æ˜¯ä¸é€æ˜ 1234567if (position &lt;= -1.0f || position &gt;= 1.0f) &#123; page.alpha = 0.0f&#125; else if (position == 0.0f) &#123; page.alpha = 1.0f&#125; else &#123; page.alpha = 1.0f - Math.abs(position)&#125; 2ã€ç¼©æ”¾å˜å¤§æ•ˆæœ åŒæ—¶æ”¹å˜ä½ç§»ä¸é€æ˜åº¦ 123456789if (position &gt; 0 &amp;&amp; position &lt; 1) &#123; page.alpha = 1 - position page.scaleXY = 0.85f + (1 - 0.85f) * (1 - Math.abs(position)) page.translationX = page.width * -position&#125; else &#123; page.alpha = 1f page.scaleXY = 1f page.translationX = 0f&#125; æ›´å¤šæ•ˆæœ ç­‰ä½ å»å‘ç° æºç è§£æ å…¶å®è¿™ä¸ªåŸç†å¾ˆç®€å•ï¼Œåœ¨æ¯ä¸€æ¬¡æ»šåŠ¨çš„æ—¶å€™ï¼Œåœ¨ ViewPager å†…éƒ¨ï¼Œè®¡ç®—å‡º æ¯ä¸€ä¸ªview çš„ position ï¼Œå¹¶ä¸”è°ƒç”¨è¿™ä¸ªæ¥å£çš„æ–¹æ³•å°±å¯ä»¥å®ç°äº† æºç å¦‚ä¸‹ 12345678910111213141516protected void onPageScrolled(int position, float offset, int offsetPixels) &#123; // çœç•¥....... if (mPageTransformer != null) &#123; final int scrollX = getScrollX(); final int childCount = getChildCount(); for (int i = 0; i &lt; childCount; i++) &#123; final View child = getChildAt(i); final LayoutParams lp = (LayoutParams) child.getLayoutParams(); if (lp.isDecor) continue; final float transformPos = (float) (child.getLeft() - scrollX) / getClientWidth(); mPageTransformer.transformPage(child, transformPos); &#125; &#125; // .... &#125; é¦–å…ˆåˆ¤æ–­ mPageTransformer æ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨çš„è¯å°±å¯ä»¥è°ƒç”¨äº†ï¼Œè·å– scrollXï¼Œæ ¹æ® childCount å¯¹æ¯ä¸€ä¸ª view æ‰§è¡Œ mPageTransformer.transformPage æ–¹æ³• transformPos æ˜¯ç”± (float) (child.getLeft() - scrollX) / getClientWidth() è®¡ç®—å¾—å‡ºã€‚æ­¤å¤„ä½¿ç”¨ getLeft - scrollX è®¡ç®—éªŒè¯äº†æˆ‘ä»¬å¯¹æƒ³æ³•ã€‚ demo æ€»ç»“ çœ‹ä¼¼å¤æ‚çš„åŠŸèƒ½ï¼Œå…¶å®æ²¡é‚£ä¹ˆå¤æ‚ï¼Œé™ä¸‹å¿ƒæ¥ç ”ç©¶ï¼ŒåŸæ¥è¿™ä¹ˆç®€å•","categories":[{"name":"Android","slug":"Android","permalink":"https://wzes.github.io/categories/Android/"}],"tags":[{"name":"Android","slug":"Android","permalink":"https://wzes.github.io/tags/Android/"},{"name":"ViewPager","slug":"ViewPager","permalink":"https://wzes.github.io/tags/ViewPager/"}]},{"title":"Android TabLayout æºç è§£æ","slug":"Android/TabLayout","date":"2019-02-21T07:36:00.000Z","updated":"2019-09-02T12:19:29.232Z","comments":true,"path":"2019/02/21/Android/TabLayout/","link":"","permalink":"https://wzes.github.io/2019/02/21/Android/TabLayout/","excerpt":"","text":"å‰è¨€ å¾ˆä¹…å¾ˆä¹…æ²¡å†™è¿‡æºç è§£æäº†ï¼Œä¸æ˜¯è‡ªå·±æ²¡æœ‰çœ‹äº†ï¼Œåªæ˜¯æ²¡æœ‰è®°å½•äº†ï¼Œå´å‘ç°ä¸è®°å½•çš„è¯ï¼Œä¼¼æ‡‚éæ‡‚ï¼Œæ—¶é—´ä¹…äº†å°±å¿˜å¾—å·®ä¸å¤šäº†ï¼Œç”¨åˆ°äº†è¿˜æ˜¯å¾—å†å­¦ä¸€éï¼Œå¿ä½æç¬”ä¸€ç¯‡ TabLayout æºç å­¦ä¹ ã€‚ Hello World ä¾èµ– æ·»åŠ  support design åŒ… 1implementation &apos;com.android.support:design:27.1.1&apos; xml æ·»åŠ ä¸€ä¸ª TabLayout å°±å¯ä»¥äº† 123456789101112&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;&lt;android.support.constraint.ConstraintLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot; xmlns:tools=&quot;http://schemas.android.com/tools&quot; android:layout_width=&quot;match_parent&quot; android:layout_height=&quot;match_parent&quot; tools:context=&quot;.TabLayoutActivity&quot;&gt; &lt;android.support.design.widget.TabLayout android:id=&quot;@+id/tab_layout&quot; android:layout_width=&quot;match_parent&quot; android:layout_height=&quot;wrap_content&quot;/&gt;&lt;/android.support.constraint.ConstraintLayout&gt; MainActivity.java 1234567891011121314151617181920import android.support.design.widget.TabLayout;import android.support.v7.app.AppCompatActivity;import android.os.Bundle;public class TabLayoutActivity extends AppCompatActivity &#123; @Override protected void onCreate(Bundle savedInstanceState) &#123; super.onCreate(savedInstanceState); setContentView(R.layout.activity_tab_layout); TabLayout mTabLayout = findViewById(R.id.tab_layout); // æ·»åŠ  tab item mTabLayout.addTab(mTabLayout.newTab().setText(&quot;TAB1&quot;)); mTabLayout.addTab(mTabLayout.newTab().setText(&quot;TAB2&quot;)); mTabLayout.addTab(mTabLayout.newTab().setText(&quot;TAB3&quot;)); mTabLayout.addTab(mTabLayout.newTab().setText(&quot;TAB4&quot;)); &#125;&#125; æ•ˆæœ æºç å­¦ä¹  å…¶å®ï¼Œå®ç°è¿™æ ·ä¸€ä¸ªå¸ƒå±€å¹¶ä¸éš¾ï¼Œè®©æˆ‘ä»¬æ¥çœ‹çœ‹é‡Œé¢æ‰€æœ‰çš„å†…å®¹ å‰ä¸–ä»Šç”Ÿ ç»§æ‰¿è‡ª HorizontalScrollView å› ä¸ºä»–æ”¯æŒæ»šåŠ¨ 1public class TabLayout extends HorizontalScrollView TabLayout æ”¯æŒä¸¤ç§æ¨¡å¼ï¼Œä¸€ç§æ˜¯å›ºå®šçš„ï¼Œä¸€ç§æ˜¯å¯æ»šåŠ¨çš„ï¼ˆtab å¤ªå¤šï¼Œä¸€å±æ˜¾ç¤ºä¸ä¸‹ï¼Œå¯ä½¿ç”¨è¿™ç§æ¨¡å¼ï¼Œå¦åˆ™é»˜è®¤ä¸ºå¹³åˆ†ï¼‰ 123456789101112131415161718192021222324252627/** * Scrollable tabs display a subset of tabs at any given moment, and can contain longer tab * labels and a larger number of tabs. They are best used for browsing contexts in touch * interfaces when users donâ€™t need to directly compare the tab labels. * * @see #setTabMode(int) * @see #getTabMode() */public static final int MODE_SCROLLABLE = 0;/** * Fixed tabs display all tabs concurrently and are best used with content that benefits from * quick pivots between tabs. The maximum number of tabs is limited by the viewâ€™s width. * Fixed tabs have equal width, based on the widest tab label. * * @see #setTabMode(int) * @see #getTabMode() */public static final int MODE_FIXED = 1;/** * @hide */@RestrictTo(LIBRARY_GROUP)@IntDef(value = &#123;MODE_SCROLLABLE, MODE_FIXED&#125;)@Retention(RetentionPolicy.SOURCE)public @interface Mode &#123;&#125; Tab çš„ä½ç½®æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯å±…ä¸­ï¼Œä¸€ç§æ˜¯å¹³åˆ† 123456789101112131415161718192021222324/** * Gravity used to fill the &#123;@link TabLayout&#125; as much as possible. This option only takes effect * when used with &#123;@link #MODE_FIXED&#125;. * * @see #setTabGravity(int) * @see #getTabGravity() */public static final int GRAVITY_FILL = 0;/** * Gravity used to lay out the tabs in the center of the &#123;@link TabLayout&#125;. * * @see #setTabGravity(int) * @see #getTabGravity() */public static final int GRAVITY_CENTER = 1;/** * @hide */@RestrictTo(LIBRARY_GROUP)@IntDef(flag = true, value = &#123;GRAVITY_FILL, GRAVITY_CENTER&#125;)@Retention(RetentionPolicy.SOURCE)public @interface TabGravity &#123;&#125; å±…ä¸­æ¨¡å¼ åˆ›å»º Tab ä½¿ç”¨ä»£ç åˆ›å»º Tab 123456789public Tab newTab() &#123; Tab tab = sTabPool.acquire(); if (tab == null) &#123; tab = new Tab(); &#125; tab.mParent = this; tab.mView = createTabView(tab); return tab;&#125; Tab è¿˜ä½¿ç”¨äº† Poolï¼Œè¿˜æ˜¯æŒºç»†å¿ƒçš„ 1private static final Pools.Pool&lt;Tab&gt; sTabPool = new Pools.SynchronizedPool&lt;&gt;(16); å¯æ»‘åŠ¨çš„æŒ‡ç¤ºæ¡å½¢å›¾ è‡ªå®šä¹‰ ViewGroup 1private class SlidingTabStrip extends LinearLayout onMeasure å¦‚æœè®¾ç½®äº† MODE_FIXED å’Œ GRAVITY_CENTER åˆ™éœ€è¦é‡æ–°æµ‹é‡ï¼Œç›®çš„å°±æ˜¯è®©å±…ä¸­ï¼Œæ¯ä¸ª ITEM çš„å®½åº¦éƒ½æ˜¯ä¸€æ ·çš„ï¼Œè€Œä¸”ç­‰äºæœ€å¤§çš„ä¸€ä¸ªï¼Œå¦‚æœä¸€å±æ”¾å¾—ä¸‹åˆ™éœ€è¦é‡æ–°è®¾ç½®æ¯ä¸ª ITEM çš„å¤§å°ï¼Œå¹¶ä¸”é‡æ–°æµ‹é‡ã€‚å¦‚æœå‘ä¸ä¸‹ï¼Œé‚£ä¹ˆä¾§è®¾ç½®GRAVITY_FILL 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556@Override protected void onMeasure(final int widthMeasureSpec, final int heightMeasureSpec) &#123; super.onMeasure(widthMeasureSpec, heightMeasureSpec); if (MeasureSpec.getMode(widthMeasureSpec) != MeasureSpec.EXACTLY) &#123; // HorizontalScrollView will first measure use with UNSPECIFIED, and then with // EXACTLY. Ignore the first call since anything we do will be overwritten anyway return; &#125; // é‡æ–°æµ‹é‡ if (mMode == MODE_FIXED &amp;&amp; mTabGravity == GRAVITY_CENTER) &#123; final int count = getChildCount(); // First we&apos;ll find the widest tab int largestTabWidth = 0; for (int i = 0, z = count; i &lt; z; i++) &#123; View child = getChildAt(i); if (child.getVisibility() == VISIBLE) &#123; largestTabWidth = Math.max(largestTabWidth, child.getMeasuredWidth()); &#125; &#125; if (largestTabWidth &lt;= 0) &#123; // If we don&apos;t have a largest child yet, skip until the next measure pass return; &#125; // é—´éš” final int gutter = dpToPx(FIXED_WRAP_GUTTER_MIN); boolean remeasure = false; // ä¸€å±æ”¾å¾—ä¸‹ if (largestTabWidth * count &lt;= getMeasuredWidth() - gutter * 2) &#123; // If the tabs fit within our width minus gutters, we will set all tabs to have // the same width for (int i = 0; i &lt; count; i++) &#123; final LinearLayout.LayoutParams lp = (LayoutParams) getChildAt(i).getLayoutParams(); if (lp.width != largestTabWidth || lp.weight != 0) &#123; lp.width = largestTabWidth; lp.weight = 0; remeasure = true; &#125; &#125; &#125; else &#123; // If the tabs will wrap to be larger than the width minus gutters, we need // to switch to GRAVITY_FILL mTabGravity = GRAVITY_FILL; updateTabViews(false); remeasure = true; &#125; if (remeasure) &#123; // Now re-measure after our changes super.onMeasure(widthMeasureSpec, heightMeasureSpec); &#125; &#125; &#125; å¦‚ä½•å®ç°åŠ¨ç”»ï¼Ÿ é€šè¿‡ç§»åŠ¨ IndicatorView onLayout mIndicatorAnimator æ˜¯åŠ¨ç”»è¾…åŠ©ç±»ï¼Œåœ¨ onLayout ä¸­ï¼Œéç©ºè€Œä¸”æ­£åœ¨è¿è¡Œåˆ™çœ‹å–æ¶ˆï¼Œç„¶åè°ƒç”¨ animateIndicatorToPositionï¼ŒåŠ¨ç”»è°ƒç”¨ï¼Œå¦åˆ™ç›´æ¥è®¾ç½®ä½ç½®ï¼Œä¸æ”¯æŒåŠ¨ç”» 12345678910111213141516@Override protected void onLayout(boolean changed, int l, int t, int r, int b) &#123; super.onLayout(changed, l, t, r, b); if (mIndicatorAnimator != null &amp;&amp; mIndicatorAnimator.isRunning()) &#123; // If we&apos;re currently running an animation, lets cancel it and start a // new animation with the remaining duration mIndicatorAnimator.cancel(); final long duration = mIndicatorAnimator.getDuration(); animateIndicatorToPosition(mSelectedPosition, Math.round((1f - mIndicatorAnimator.getAnimatedFraction()) * duration)); &#125; else &#123; // If we&apos;ve been layed out, update the indicator position updateIndicatorPosition(); &#125; &#125; updateIndicatorPosition é¦–å…ˆè·å–é€‰ä¸­çš„ Viewï¼Œç„¶åçœ‹ mSelectionOffset æ˜¯å¦å¤§äºé›¶ï¼Œè¯´æ˜å‘ç”Ÿæ»šåŠ¨ï¼Œåˆ™éœ€è¦é‡æ–°è®¡ç®—æ–°ä½ç½® 12345678910111213141516171819202122232425262728293031private void updateIndicatorPosition() &#123; final View selectedTitle = getChildAt(mSelectedPosition); int left, right; if (selectedTitle != null &amp;&amp; selectedTitle.getWidth() &gt; 0) &#123; left = selectedTitle.getLeft(); right = selectedTitle.getRight(); if (mSelectionOffset &gt; 0f &amp;&amp; mSelectedPosition &lt; getChildCount() - 1) &#123; // Draw the selection partway between the tabs View nextTitle = getChildAt(mSelectedPosition + 1); left = (int) (mSelectionOffset * nextTitle.getLeft() + (1.0f - mSelectionOffset) * left); right = (int) (mSelectionOffset * nextTitle.getRight() + (1.0f - mSelectionOffset) * right); &#125; &#125; else &#123; left = right = -1; &#125; setIndicatorPosition(left, right); &#125; // mIndicatorLeft å’Œ mIndicatorRight æ§åˆ¶äº†çº¿çš„èµ·å§‹ä½ç½®void setIndicatorPosition(int left, int right) &#123; if (left != mIndicatorLeft || right != mIndicatorRight) &#123; // If the indicator&apos;s left/right has changed, invalidate mIndicatorLeft = left; mIndicatorRight = right; ViewCompat.postInvalidateOnAnimation(this); &#125; &#125; ç§»åŠ¨åŠ¨ç”»ï¼Œç§»åŠ¨é—´éš”å¤§çš„è¯ï¼Œå¹¶ä¸ä¼šä»å½“å‰ä½ç½®ç›´æ¥ç§»åŠ¨ï¼Œè€Œæ˜¯è·³è·ƒä¸€æ®µè·ç¦»å†ç§»åŠ¨ï¼Œé€šè¿‡ startLeft å’Œ startRight æ§åˆ¶ï¼Œå¹¶ä¸”ä½¿ç”¨ ValueAnimator æ¥å®ç°åŠ¨ç”» è¿™ä¸ªä¸é”™ï¼ŒåŒæ„äº† fraction 0-1 ï¼Œé€šè¿‡å‡½æ•°è®¡ç®—è¿›åº¦ 123setIndicatorPosition( AnimationUtils.lerp(startLeft, targetLeft, fraction), AnimationUtils.lerp(startRight, targetRight, fraction)); 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768void animateIndicatorToPosition(final int position, int duration) &#123; if (mIndicatorAnimator != null &amp;&amp; mIndicatorAnimator.isRunning()) &#123; mIndicatorAnimator.cancel(); &#125; final boolean isRtl = ViewCompat.getLayoutDirection(this) == ViewCompat.LAYOUT_DIRECTION_RTL; final View targetView = getChildAt(position); if (targetView == null) &#123; // If we don&apos;t have a view, just update the position now and return updateIndicatorPosition(); return; &#125; final int targetLeft = targetView.getLeft(); final int targetRight = targetView.getRight(); final int startLeft; final int startRight; if (Math.abs(position - mSelectedPosition) &lt;= 1) &#123; // If the views are adjacent, we&apos;ll animate from edge-to-edge startLeft = mIndicatorLeft; startRight = mIndicatorRight; &#125; else &#123; // Else, we&apos;ll just grow from the nearest edge final int offset = dpToPx(MOTION_NON_ADJACENT_OFFSET); if (position &lt; mSelectedPosition) &#123; // We&apos;re going end-to-start if (isRtl) &#123; startLeft = startRight = targetLeft - offset; &#125; else &#123; startLeft = startRight = targetRight + offset; &#125; &#125; else &#123; // We&apos;re going start-to-end if (isRtl) &#123; startLeft = startRight = targetRight + offset; &#125; else &#123; startLeft = startRight = targetLeft - offset; &#125; &#125; &#125; // å¼€å§‹ç§»åŠ¨ä½ç½® if (startLeft != targetLeft || startRight != targetRight) &#123; ValueAnimator animator = mIndicatorAnimator = new ValueAnimator(); animator.setInterpolator(AnimationUtils.FAST_OUT_SLOW_IN_INTERPOLATOR); animator.setDuration(duration); animator.setFloatValues(0, 1); animator.addUpdateListener(new ValueAnimator.AnimatorUpdateListener() &#123; @Override public void onAnimationUpdate(ValueAnimator animator) &#123; final float fraction = animator.getAnimatedFraction(); setIndicatorPosition( AnimationUtils.lerp(startLeft, targetLeft, fraction), AnimationUtils.lerp(startRight, targetRight, fraction)); &#125; &#125;); animator.addListener(new AnimatorListenerAdapter() &#123; @Override public void onAnimationEnd(Animator animator) &#123; mSelectedPosition = position; mSelectionOffset = 0f; &#125; &#125;); animator.start(); &#125; &#125; onDraw å¾ˆç®€å• 12345678910@Override public void draw(Canvas canvas) &#123; super.draw(canvas); // Thick colored underline below the current selection if (mIndicatorLeft &gt;= 0 &amp;&amp; mIndicatorRight &gt; mIndicatorLeft) &#123; canvas.drawRect(mIndicatorLeft, getHeight() - mSelectedIndicatorHeight, mIndicatorRight, getHeight(), mSelectedIndicatorPaint); &#125; &#125; TabView æ¥ä¸‹æ¥å†çœ‹çœ‹ä¸Šé¢çš„å†…å®¹ 1234567891011class TabView extends LinearLayout &#123; private Tab mTab; private TextView mTextView; private ImageView mIconView; private View mCustomView; private TextView mCustomTextView; private ImageView mCustomIconView; private int mDefaultMaxLines = 2; &#125; å¦‚ä½•å®ç°ç›‘å¬çš„ï¼Œå¯¹æ¯ä¸ª TabView è®¾ç½®ç‚¹å‡»äº‹ä»¶ï¼Œé‡å†™äº† performClickï¼Œå…¶ä¸­è°ƒç”¨ mTab.selectï¼ŒmTab æ‹¥æœ‰ TabLayout çš„å¼•ç”¨ï¼Œ 1234567891011121314151617181920212223@Override public boolean performClick() &#123; final boolean handled = super.performClick(); if (mTab != null) &#123; if (!handled) &#123; playSoundEffect(SoundEffectConstants.CLICK); &#125; mTab.select(); return true; &#125; else &#123; return handled; &#125; &#125; /** * Select this tab. Only valid if the tab has been added to the action bar. */ public void select() &#123; if (mParent == null) &#123; throw new IllegalArgumentException(&quot;Tab not attached to a TabLayout&quot;); &#125; mParent.selectTab(this); &#125; tabLayout å›è°ƒäº‹ä»¶ï¼Œ 1234567891011121314151617181920212223242526272829303132333435void selectTab(Tab tab) &#123; selectTab(tab, true); &#125; void selectTab(final Tab tab, boolean updateIndicator) &#123; final Tab currentTab = mSelectedTab; if (currentTab == tab) &#123; if (currentTab != null) &#123; dispatchTabReselected(tab); animateToTab(tab.getPosition()); &#125; &#125; else &#123; final int newPosition = tab != null ? tab.getPosition() : Tab.INVALID_POSITION; if (updateIndicator) &#123; if ((currentTab == null || currentTab.getPosition() == Tab.INVALID_POSITION &amp;&amp; newPosition != Tab.INVALID_POSITION) &#123; // If we don&apos;t currently have a tab, just draw the indicator setScrollPosition(newPosition, 0f, true); &#125; else &#123; animateToTab(newPosition); &#125; if (newPosition != Tab.INVALID_POSITION) &#123; setSelectedTabView(newPosition); &#125; &#125; if (currentTab != null) &#123; dispatchTabUnselected(currentTab); &#125; mSelectedTab = tab; if (tab != null) &#123; dispatchTabSelected(tab); &#125; &#125; &#125; ç§»åŠ¨ Tabï¼ŒåŠ¨ç”» 1234567891011121314151617181920212223242526private void animateToTab(int newPosition) &#123; if (newPosition == Tab.INVALID_POSITION) &#123; return; &#125; if (getWindowToken() == null || !ViewCompat.isLaidOut(this) || mTabStrip.childrenNeedLayout()) &#123; // If we don&apos;t have a window token, or we haven&apos;t been laid out yet just dra // position now setScrollPosition(newPosition, 0f, true); return; &#125; final int startScrollX = getScrollX(); final int targetScrollX = calculateScrollXForTab(newPosition, 0); if (startScrollX != targetScrollX) &#123; ensureScrollAnimator(); mScrollAnimator.setIntValues(startScrollX, targetScrollX); mScrollAnimator.start(); &#125; // Now animate the indicator mTabStrip.animateIndicatorToPosition(newPosition, ANIMATION_DURATION); &#125; è®¡ç®—ç§»åŠ¨çš„è·ç¦»ï¼Œè®©é€‰ä¸­çš„ tab ä½äºä¸­é—´ä½ç½®ï¼Œç”±äº Android ScrollView é»˜è®¤ä¸ä¼šæ»šåŠ¨è¶…å‡ºè¾¹ç•Œï¼Œæ‰€ä»¥å¦‚æœåˆ°è¾¾è¾¹ç•Œä¹Ÿä¸ä¼šç»§ç»­æ»šåŠ¨äº† 1234567891011121314151617181920private int calculateScrollXForTab(int position, float positionOffset) &#123; if (mMode == MODE_SCROLLABLE) &#123; final View selectedChild = mTabStrip.getChildAt(position); final View nextChild = position + 1 &lt; mTabStrip.getChildCount() ? mTabStrip.getChildAt(position + 1) : null; final int selectedWidth = selectedChild != null ? selectedChild.getWidth() : 0; final int nextWidth = nextChild != null ? nextChild.getWidth() : 0; // base scroll amount: places center of tab in center of parent int scrollBase = selectedChild.getLeft() + (selectedWidth / 2) - (getWidth() / 2); // offset amount: fraction of the distance between centers of tabs int scrollOffset = (int) ((selectedWidth + nextWidth) * 0.5f * positionOffset); return (ViewCompat.getLayoutDirection(this) == ViewCompat.LAYOUT_DIRECTION_LTR) ? scrollBase + scrollOffset : scrollBase - scrollOffset; &#125; return 0; &#125; ViewPager å…¶å®å¾ˆç®€å•ï¼Œå°±æ˜¯ç»™ ViewPager æ·»åŠ ä¸€ä¸ª OnPageChangeListener å°±è¡Œäº†ï¼Œä»£ç ä¹Ÿå¾ˆç®€å•ï¼Œåœ¨ onPageScrolled ä¸­æ”¹å˜ æŒ‡ç¤ºæ¡ çš„ä½ç½®ï¼Œåœ¨ onPageSelected ä¸­æ”¹å˜ é€‰ä¸­çŠ¶æ€ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051public static class TabLayoutOnPageChangeListener implements ViewPager.OnPageChangeListener &#123; private final WeakReference&lt;TabLayout&gt; mTabLayoutRef; private int mPreviousScrollState; private int mScrollState; public TabLayoutOnPageChangeListener(TabLayout tabLayout) &#123; mTabLayoutRef = new WeakReference&lt;&gt;(tabLayout); &#125; @Override public void onPageScrollStateChanged(final int state) &#123; mPreviousScrollState = mScrollState; mScrollState = state; &#125; @Override public void onPageScrolled(final int position, final float positionOffset, final int positionOffsetPixels) &#123; final TabLayout tabLayout = mTabLayoutRef.get(); if (tabLayout != null) &#123; // Only update the text selection if we&apos;re not settling, or we are settling after // being dragged final boolean updateText = mScrollState != SCROLL_STATE_SETTLING || mPreviousScrollState == SCROLL_STATE_DRAGGING; // Update the indicator if we&apos;re not settling after being idle. This is caused // from a setCurrentItem() call and will be handled by an animation from // onPageSelected() instead. final boolean updateIndicator = !(mScrollState == SCROLL_STATE_SETTLING &amp;&amp; mPreviousScrollState == SCROLL_STATE_IDLE); tabLayout.setScrollPosition(position, positionOffset, updateText, updateIndicator); &#125; &#125; @Override public void onPageSelected(final int position) &#123; final TabLayout tabLayout = mTabLayoutRef.get(); if (tabLayout != null &amp;&amp; tabLayout.getSelectedTabPosition() != position &amp;&amp; position &lt; tabLayout.getTabCount()) &#123; // Select the tab, only updating the indicator if we&apos;re not being dragged/settled // (since onPageScrolled will handle that). final boolean updateIndicator = mScrollState == SCROLL_STATE_IDLE || (mScrollState == SCROLL_STATE_SETTLING &amp;&amp; mPreviousScrollState == SCROLL_STATE_IDLE); tabLayout.selectTab(tabLayout.getTabAt(position), updateIndicator); &#125; &#125; void reset() &#123; mPreviousScrollState = mScrollState = SCROLL_STATE_IDLE; &#125;&#125; å°ç»“ åŸºæœ¬ä¸Šçœ‹å®Œäº†ï¼Œä½†å¯¹äºä¸€äº›ç»†èŠ‚ï¼Œæ»šåŠ¨è¾¹ç•Œé—®é¢˜è¿˜æ²¡æœ‰æ·±åˆ»çš„ç†è§£ï¼ŒåªçŸ¥é“å¤§æ¦‚çš„é€»è¾‘","categories":[{"name":"Android","slug":"Android","permalink":"https://wzes.github.io/categories/Android/"}],"tags":[{"name":"Android","slug":"Android","permalink":"https://wzes.github.io/tags/Android/"},{"name":"TabLayout","slug":"TabLayout","permalink":"https://wzes.github.io/tags/TabLayout/"}]},{"title":"Android Recycview åˆ†å‰²çº¿","slug":"Android/Android Recycview Devider","date":"2018-10-12T12:35:00.000Z","updated":"2019-09-02T12:17:39.545Z","comments":true,"path":"2018/10/12/Android/Android Recycview Devider/","link":"","permalink":"https://wzes.github.io/2018/10/12/Android/Android Recycview Devider/","excerpt":"","text":"æœ€è¿‘æœ‰ä¸€ä¸ªéœ€æ±‚éœ€è¦åšåˆ†å‰²çº¿ï¼Œç½‘ä¸Šæœ‰ä¸€äº›å¤§è‡´çš„åšæ³•ï¼Œä½†æ„Ÿè§‰éƒ½ä¸æ˜¯é‚£ä¹ˆé€šä¿—æ˜“æ‡‚ï¼Œç„¶åè‡ªå·±æƒ³äº†æƒ³ï¼Œå¹²è„†è‡ªå·±å¼„å§ï¼Œåé¢å‘ç°äº†ä¸€ä¸ªæ¯”è¾ƒå¥½çš„ï¼Œéå¸¸ç®€æ´ï¼Œåˆ†äº«ç»™å¤§å®¶ æ•ˆæœ ä»£ç  123456789101112131415161718192021222324252627class GridSpanDecoration extends RecyclerView.ItemDecoration &#123; private Paint mPaint; GridSpanDecoration(int color) &#123; mPaint = new Paint(); mPaint.setColor(color); mPaint.setStyle(Paint.Style.STROKE); &#125; @Override public void getItemOffsets(Rect outRect, View view, RecyclerView parent, RecyclerView.State state) &#123; super.getItemOffsets(outRect, view, parent, state); &#125; @Override public void onDraw(Canvas c, RecyclerView parent, RecyclerView.State state) &#123; drawVertical(c, parent); &#125; private void drawVertical(Canvas c, RecyclerView parent) &#123; final int childCount = parent.getChildCount(); for (int i = 0; i &lt; childCount; i++) &#123; final View child = parent.getChildAt(i); c.drawRect(child.getLeft(), child.getTop(), child.getRight(), child.getBottom(), mPaint); &#125; &#125;&#125; åŸç†å°±æ˜¯ç»™æ¯ä¸ªå­viewç”»ä¸€ä¸ªè¾¹æ¡†å°±è¡Œäº†ï¼æ˜¯ä¸æ˜¯å¾ˆç®€å•","categories":[{"name":"Android","slug":"Android","permalink":"https://wzes.github.io/categories/Android/"}],"tags":[{"name":"Android","slug":"Android","permalink":"https://wzes.github.io/tags/Android/"}]},{"title":"Effective Java3 ä»‹ç»ï¼ˆç¿»è¯‘ï¼‰","slug":"Book Notes/Effective Java3 ä»‹ç»","date":"2018-09-30T14:18:00.000Z","updated":"2019-09-02T12:22:04.691Z","comments":true,"path":"2018/09/30/Book Notes/Effective Java3 ä»‹ç»/","link":"","permalink":"https://wzes.github.io/2018/09/30/Book Notes/Effective Java3 ä»‹ç»/","excerpt":"","text":"Introduction æœ¬ä¹¦æ—¨åœ¨å¸®åŠ©æ‚¨æœ‰æ•ˆåœ°ä½¿ç”¨ Java ç¼–ç¨‹è¯­è¨€åŠå…¶åŸºç¡€åº“ï¼šjava.langï¼Œjava.util å’Œ java.ioï¼Œä»¥åŠ java.util.concurrent å’Œ java.util.functionç­‰å­åŒ…ã€‚ ä¹Ÿä¼šæ¶‰åŠåˆ°å…¶ä»–çš„ç±»åº“ã€‚ æœ¬ä¹¦ä¸€å…±ä¹åå°èŠ‚ï¼Œæ¯ä¸ªå°èŠ‚è®²è¿°äº†ä¸€æ¡è§„åˆ™ã€‚ è¿™äº›è§„åˆ™å®è·µé€šå¸¸ä¼šä½¿é‚£äº›æœ€ä¼˜ç§€å’Œæœ€å¯Œæœ‰ç»éªŒçš„ç¨‹åºå‘˜ä»ä¸­å—ç›Šã€‚ æ‰€æœ‰çš„å†…å®¹åˆ†ä¸º11ç« ï¼Œæ¯ç« éƒ½æ¶‰åŠè½¯ä»¶è®¾è®¡çš„ä¸€ä¸ªå¹¿æ³›æ–¹é¢ã€‚ æœ¬ä¹¦ä¸æ‰“ç®—ä»å¤´åˆ°å°¾é˜…è¯»ï¼šæ¯ä¸ªå°èŠ‚éƒ½æˆ–å¤šæˆ–å°‘åœ°ç‹¬ç«‹å­˜åœ¨ã€‚ è¿™äº›å°èŠ‚æœ‰å¾ˆå¤šäº¤å‰å¼•ç”¨ï¼Œå› æ­¤æ‚¨å¯ä»¥é€šè¿‡æœ¬ä¹¦è½»æ¾ç»˜åˆ¶è‡ªå·±çš„è¯¾ç¨‹ã€‚ è‡ªæœ¬ä¹¦ä¸Šä¸€ç‰ˆå‡ºç‰ˆä»¥æ¥ï¼Œè¯¥å¹³å°å¢åŠ äº†è®¸å¤šæ–°åŠŸèƒ½ã€‚ æœ¬ä¹¦ä¸­çš„å¤§å¤šæ•°é¡¹ç›®éƒ½ä»¥æŸç§æ–¹å¼ä½¿ç”¨è¿™äº›åŠŸèƒ½ã€‚ æ­¤è¡¨æ˜¾ç¤ºäº†ä¸»è¦åŠŸèƒ½çš„ä¸»è¦è¦†ç›–èŒƒå›´: å¤§å¤šæ•°é¡¹ç›®éƒ½ç”¨ç¨‹åºç¤ºä¾‹è¯´æ˜ã€‚ æœ¬ä¹¦çš„ä¸€ä¸ªå…³é”®ç‰¹æ€§æ˜¯å®ƒåŒ…å«è¯´æ˜è®¸å¤šè®¾è®¡æ¨¡å¼å’Œä¹ è¯­çš„ä»£ç ç¤ºä¾‹ã€‚ åœ¨é€‚å½“çš„æƒ…å†µä¸‹ï¼Œå®ƒä»¬ä¸è¯¥é¢†åŸŸçš„æ ‡å‡†å‚è€ƒå·¥ä½œ[Gamma95]ç›¸äº’å‚ç…§ã€‚ è®¸å¤šå°èŠ‚åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªç¨‹åºç¤ºä¾‹ï¼Œè¯´æ˜äº†è¦é¿å…çš„ä¸€äº›å®è·µã€‚ è¿™æ ·çš„ä¾‹å­ï¼Œæœ‰æ—¶è¢«ç§°ä¸ºåæ¨¡å¼ï¼Œæ¸…æ¥šåœ°æ ‡æœ‰è¯„è®ºï¼Œä¾‹å¦‚ //never do thisï¼ åœ¨æ¯ç§æƒ…å†µä¸‹ï¼Œè¯¥é¡¹ç›®éƒ½è§£é‡Šäº†ä¸ºä»€ä¹ˆç¤ºä¾‹ä¸å¥½å¹¶æå‡ºäº†å¦ä¸€ç§æ–¹æ³•ã€‚ æœ¬ä¹¦ä¸é€‚åˆåˆå­¦è€…ï¼šå®ƒå‡è®¾æ‚¨å·²ç»ç†Ÿæ‚‰Javaã€‚ å¦‚æœä¸æ˜¯ï¼Œè¯·è€ƒè™‘è®¸å¤šä¼˜ç§€çš„å…¥é—¨çº§ä¹¦ç±ä¹‹ä¸€ï¼Œä¾‹å¦‚Peter Sestoftçš„Java Precisely [Sestoft16]ã€‚ è™½ç„¶Effective Javaæ—¨åœ¨è®©ä»»ä½•å…·æœ‰è¯¥è¯­è¨€å·¥ä½œçŸ¥è¯†çš„äººéƒ½å¯ä»¥é˜…è¯»ï¼Œä½†å®ƒåº”è¯¥ä¸ºé«˜çº§ç¨‹åºå‘˜æä¾›æ€è€ƒçš„ç©ºé—´ã€‚ æœ¬ä¹¦ä¸­çš„å¤§å¤šæ•°è§„åˆ™éƒ½æºäºä¸€äº›åŸºæœ¬åŸåˆ™ã€‚ æ¸…æ™°å’Œç®€æ´è‡³å…³é‡è¦ã€‚ ç»„ä»¶çš„ç”¨æˆ·ä¸åº”è¯¥å¯¹å…¶è¡Œä¸ºæ„Ÿåˆ°æƒŠè®¶ã€‚ ç»„ä»¶åº”å°½å¯èƒ½å°ï¼Œä½†ä¸èƒ½å°ã€‚ ï¼ˆæ­£å¦‚æœ¬ä¹¦ä¸­æ‰€ä½¿ç”¨çš„ï¼Œæœ¯è¯­ç»„ä»¶æ˜¯æŒ‡ä»»ä½•å¯é‡ç”¨çš„è½¯ä»¶å…ƒç´ ï¼Œä»å•ä¸ªæ–¹æ³•åˆ°ç”±å¤šä¸ªåŒ…ç»„æˆçš„å¤æ‚æ¡†æ¶ã€‚ï¼‰ä»£ç åº”è¯¥è¢«é‡ç”¨è€Œä¸æ˜¯è¢«å¤åˆ¶ã€‚ ç»„ä»¶ä¹‹é—´çš„ä¾èµ–å…³ç³»åº”ä¿æŒæœ€å°ã€‚ é”™è¯¯åº”è¯¥åœ¨å‘ç”Ÿåå°½å¿«æ£€æµ‹åˆ°ï¼Œç†æƒ³æƒ…å†µæ˜¯åœ¨ç¼–è¯‘æ—¶ã€‚ è™½ç„¶æœ¬ä¹¦ä¸­çš„è§„åˆ™å¹¶é100ï¼…é€‚ç”¨ï¼Œä½†åœ¨ç»å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå®ƒä»¬éƒ½æ˜¯æœ€ä½³ç¼–ç¨‹å®è·µçš„ç‰¹å¾ã€‚ä½ ä¸åº”è¯¥ç›²ç›®åœ°éµå®ˆè¿™äº›è§„åˆ™ï¼Œè€Œåªæ˜¯å¶å°”å¹¶ä¸”æœ‰å……åˆ†çš„ç†ç”±è¿åè¿™äº›è§„åˆ™ã€‚åƒå¤§å¤šæ•°å…¶ä»–å­¦ç§‘ä¸€æ ·ï¼Œå­¦ä¹ ç¼–ç¨‹è‰ºæœ¯åŒ…æ‹¬é¦–å…ˆå­¦ä¹ è§„åˆ™ï¼Œç„¶åå­¦ä¹ ä½•æ—¶æ‰“ç ´è§„åˆ™ã€‚ åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæœ¬ä¹¦ä¸æ¶‰åŠæ€§èƒ½ã€‚å®ƒæ˜¯å…³äºç¼–å†™æ¸…æ™°ï¼Œæ­£ç¡®ï¼Œå¯ç”¨ï¼Œå¥å£®ï¼Œçµæ´»å’Œå¯ç»´æŠ¤çš„ç¨‹åºã€‚å¦‚æœä½ èƒ½åšåˆ°è¿™ä¸€ç‚¹ï¼Œé‚£ä¹ˆè·å¾—æ‰€éœ€çš„æ€§èƒ½é€šå¸¸æ˜¯ä¸€ä»¶ç›¸å¯¹ç®€å•çš„äº‹æƒ…ï¼ˆç¬¬67æ¡ï¼‰ã€‚æœ‰äº›é¡¹ç›®ç¡®å®è®¨è®ºäº†æ€§èƒ½é—®é¢˜ï¼Œå…¶ä¸­ä¸€äº›é¡¹ç›®æä¾›äº†æ€§èƒ½æ•°æ®ã€‚ä½¿ç”¨çŸ­è¯­â€œåœ¨æˆ‘çš„æœºå™¨ä¸Šâ€å¼•å…¥çš„è¿™äº›æ•°å­—åº”è¯¥è¢«è®¤ä¸ºæ˜¯æœ€è¿‘çš„ã€‚ å€¼å¾—ä¸€æçš„æ˜¯ï¼Œæˆ‘çš„æœºå™¨æ˜¯è€æ—§çš„è‡ªåˆ¶3.5GHzå››æ ¸è‹±ç‰¹å°”é…·ç¿i7-4770Kï¼Œé…å¤‡16åƒå…†ä½DDR3-1866 CL9å†…å­˜ï¼Œè¿è¡ŒAzulçš„Zulu 9.0.0.15ç‰ˆæœ¬çš„OpenJDKï¼Œåœ¨Microsoft Windows 7 Professional SP1ï¼ˆ64-ä½ï¼‰ã€‚ åœ¨è®¨è®ºJavaç¼–ç¨‹è¯­è¨€åŠå…¶åº“çš„åŠŸèƒ½æ—¶ï¼Œæœ‰æ—¶éœ€è¦å‚è€ƒç‰¹å®šç‰ˆæœ¬ã€‚ ä¸ºæ–¹ä¾¿èµ·è§ï¼Œæœ¬ä¹¦ä½¿ç”¨æ˜µç§°è€Œä¸æ˜¯æ­£å¼ç‰ˆæœ¬åç§°ã€‚ æ­¤è¡¨æ˜¾ç¤ºç‰ˆæœ¬åç§°å’Œæ˜µç§°ä¹‹é—´çš„æ˜ å°„ï¼š è¿™äº›ä¾‹å­ç›¸å½“å®Œæ•´ï¼Œä½†æœ‰åˆ©äºå®Œæ•´æ€§çš„å¯è¯»æ€§ã€‚ä»–ä»¬å¯ä»¥è‡ªç”±åœ°ä½¿ç”¨java.utilå’Œjava.ioåŒ…ä¸­çš„ç±»ã€‚ä¸ºäº†ç¼–è¯‘ç¤ºä¾‹ï¼Œæ‚¨å¯èƒ½å¿…é¡»æ·»åŠ ä¸€ä¸ªæˆ–å¤šä¸ªå¯¼å…¥å£°æ˜æˆ–å…¶ä»–æ­¤ç±»æ ·æ¿ã€‚è¯¥ä¹¦çš„ç½‘ç«™http://joshbloch.com/effectivejavaåŒ…å«æ¯ä¸ªç¤ºä¾‹çš„æ‰©å±•ç‰ˆæœ¬ï¼Œæ‚¨å¯ä»¥ç¼–è¯‘å’Œè¿è¡Œå®ƒã€‚ åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæœ¬ä¹¦ä½¿ç”¨äº†Javaè¯­è¨€è§„èŒƒJava SE 8 Edition [JLS]ä¸­å®šä¹‰çš„æŠ€æœ¯æœ¯è¯­ã€‚ä¸€äº›æœ¯è¯­å€¼å¾—ç‰¹åˆ«æåŠã€‚è¯¥è¯­è¨€æ”¯æŒå››ç§ç±»å‹ï¼šæ¥å£ï¼ˆåŒ…æ‹¬æ³¨é‡Šï¼‰ï¼Œç±»ï¼ˆåŒ…æ‹¬æšä¸¾ï¼‰ï¼Œæ•°ç»„å’ŒåŸºå…ƒã€‚å‰ä¸‰ä¸ªè¢«ç§°ä¸ºå‚è€ƒç±»å‹ã€‚ç±»å®ä¾‹å’Œæ•°ç»„æ˜¯å¯¹è±¡;åŸå§‹å€¼ä¸æ˜¯ã€‚ç±»çš„æˆå‘˜ç”±å…¶å­—æ®µï¼Œæ–¹æ³•ï¼Œæˆå‘˜ç±»å’Œæˆå‘˜æ¥å£ç»„æˆã€‚æ–¹æ³•çš„ç­¾åç”±å…¶åç§°å’Œå½¢å¼å‚æ•°çš„ç±»å‹ç»„æˆ;ç­¾åä¸åŒ…æ‹¬æ–¹æ³•çš„è¿”å›ç±»å‹ã€‚ æœ¬ä¹¦ä½¿ç”¨çš„å‡ ä¸ªæœ¯è¯­ä¸Javaè¯­è¨€è§„èŒƒä¸åŒã€‚ä¸Javaè¯­è¨€è§„èŒƒä¸åŒï¼Œæœ¬ä¹¦ä½¿ç”¨ç»§æ‰¿ inheritance ä½œä¸ºå­ç±» subclassing çš„åŒä¹‰è¯ã€‚æœ¬ä¹¦ä¸æ˜¯å¯¹æ¥å£ä½¿ç”¨æœ¯è¯­ç»§æ‰¿ï¼Œè€Œæ˜¯ç®€å•åœ°å£°æ˜ä¸€ä¸ªç±»å®ç°ä¸€ä¸ªæ¥å£æˆ–ä¸€ä¸ªæ¥å£æ‰©å±•å¦ä¸€ä¸ªæ¥å£ã€‚è¦æè¿°åœ¨æœªæŒ‡å®šæ—¶åº”ç”¨çš„è®¿é—®çº§åˆ«ï¼Œæœ¬ä¹¦ä½¿ç”¨ä¼ ç»Ÿçš„package-privateè€Œä¸æ˜¯æŠ€æœ¯ä¸Šæ­£ç¡®çš„åŒ…è®¿é—®[JLSï¼Œ6.6.1]ã€‚ æœ¬ä¹¦ä½¿ç”¨äº†ä¸€äº›æœªåœ¨Javaè¯­è¨€è§„èŒƒä¸­å®šä¹‰çš„æŠ€æœ¯æœ¯è¯­ã€‚æœ¯è¯­â€œå¯¼å‡ºAPIâ€æˆ–ç®€ç§°â€œAPIâ€æ˜¯æŒ‡ç¨‹åºå‘˜è®¿é—®ç±»ï¼Œæ¥å£æˆ–åŒ…æ—¶æ‰€ä½¿ç”¨çš„ç±»ï¼Œæ¥å£ï¼Œæ„é€ å‡½æ•°ï¼Œæˆå‘˜å’Œåºåˆ—åŒ–å½¢å¼ã€‚ ï¼ˆAPIæ˜¯åº”ç”¨ç¨‹åºç¼–ç¨‹æ¥å£çš„ç¼©å†™ï¼Œä¼˜å…ˆäºå…¶ä»–ä¼˜é€‰çš„æœ¯è¯­æ¥å£ï¼Œä»¥é¿å…ä¸è¯¥åç§°çš„è¯­è¨€ç»“æ„æ··æ·†ã€‚ï¼‰ç¼–å†™ä½¿ç”¨APIâ€‹â€‹çš„ç¨‹åºçš„ç¨‹åºå‘˜è¢«ç§°ä¸ºä½œä¸ºAPIçš„ç”¨æˆ·ã€‚å…¶å®ç°ä½¿ç”¨APIâ€‹â€‹çš„ç±»æ˜¯APIçš„å®¢æˆ·ç«¯ã€‚ ç±»ï¼Œæ¥å£ï¼Œæ„é€ å‡½æ•°ï¼Œæˆå‘˜å’Œåºåˆ—åŒ–è¡¨å•è¢«ç»Ÿç§°ä¸ºAPIå…ƒç´ ã€‚å¯¼å‡ºçš„APIåŒ…å«å¯åœ¨å®šä¹‰APIçš„åŒ…ä¹‹å¤–è®¿é—®çš„APIå…ƒç´ ã€‚è¿™äº›æ˜¯ä»»ä½•å®¢æˆ·ç«¯éƒ½å¯ä»¥ä½¿ç”¨çš„APIå…ƒç´ ï¼Œå¹¶ä¸”APIçš„ä½œè€…æ‰¿è¯ºæ”¯æŒã€‚å¹¶éå·§åˆçš„æ˜¯ï¼Œå®ƒä»¬ä¹Ÿæ˜¯Javadocå®ç”¨ç¨‹åºä»¥å…¶é»˜è®¤æ“ä½œæ¨¡å¼ç”Ÿæˆæ–‡æ¡£çš„å…ƒç´ ã€‚ç®€è€Œè¨€ä¹‹ï¼ŒåŒ…çš„å¯¼å‡ºAPIç”±åŒ…ä¸­æ¯ä¸ªå…¬å…±ç±»æˆ–æ¥å£çš„å…¬å…±æˆå‘˜å’Œå—ä¿æŠ¤æˆå‘˜ä»¥åŠæ„é€ å‡½æ•°ç»„æˆã€‚ åœ¨Java 9ä¸­ï¼Œæ¨¡å—ç³»ç»Ÿè¢«æ·»åŠ åˆ°å¹³å°ä¸­ã€‚å¦‚æœåº“ä½¿ç”¨æ¨¡å—ç³»ç»Ÿï¼Œåˆ™å…¶å¯¼å‡ºçš„APIæ˜¯åº“çš„æ¨¡å—å£°æ˜å¯¼å‡ºçš„æ‰€æœ‰åŒ…çš„å¯¼å‡ºAPIçš„å¹¶é›†ã€‚","categories":[{"name":"Java","slug":"Java","permalink":"https://wzes.github.io/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://wzes.github.io/tags/Java/"}]},{"title":"Java8 Unsafe è§£å¼€ä½ ç¥ç§˜çš„é¢çº±","slug":"Java/Java8 Unsafe è§£å¼€ä½ ç¥ç§˜çš„é¢çº±","date":"2018-09-16T16:05:00.000Z","updated":"2019-09-02T12:21:22.388Z","comments":true,"path":"2018/09/17/Java/Java8 Unsafe è§£å¼€ä½ ç¥ç§˜çš„é¢çº±/","link":"","permalink":"https://wzes.github.io/2018/09/17/Java/Java8 Unsafe è§£å¼€ä½ ç¥ç§˜çš„é¢çº±/","excerpt":"","text":"å‰è¨€ Unsafe ç±»ä¸€ç›´æ˜¯ä¸ªå¾ˆç¥ç§˜çš„è§’è‰²ï¼Œæˆ‘ä»¬æ™®é€šå¼€å‘è€…å‡ ä¹ä¸ä¼šç¢°åˆ°ï¼Œé¡¶å¤šä¹Ÿæ˜¯ä½¿ç”¨äº†å¹¶å‘åŒ…ä¹‹ç±»çš„ç³»ç»Ÿç±»åº“ï¼Œé—´æ¥ä½¿ç”¨åˆ°äº†è€Œå·²ã€‚é‚£å®ƒåˆ°åº•æ˜¯ç”¨æ¥åšä»€ä¹ˆçš„å‘¢ï¼Ÿå®ƒæä¾›äº†æˆ‘ä»¬ç›´æ¥æ“ä½œå†…å­˜çš„æ¥å£ã€‚Java æœ¬èº«ä½œä¸ºä¸€ä¸ªå†…å­˜è‡ªåŠ¨ç®¡ç†çš„å·¥å…·ï¼Œå†…å­˜çš„å¼€è¾Ÿé‡Šæ”¾ç”±è™šæ‹Ÿæœºä»£ä¸ºç®¡ç†ï¼Œç„¶è€Œï¼ŒHotSpot çš„è®¾è®¡è€…ç•™ä¸‹äº† Unsafe çš„ç±»ï¼Œç”¨äºæ‰©å±•ï¼Œå®ƒå¯ä»¥ç›´æ¥å¼€è¾Ÿå†…å­˜ï¼Œé‡Šæ”¾å†…å­˜ï¼Œè¯»å–ä»»æ„åœ°å€çš„å†…å­˜ï¼Œè€Œä¸å— Java å †å†…å­˜çš„é™åˆ¶ã€‚å°½ç®¡å¦‚æ­¤ï¼Œå®ƒå¹¶ä¸èƒ½ä¸ºæˆ‘ä»¬æ‰€ç”¨ï¼ŒåŠ è½½è¿™ä¸ªç±»åªèƒ½ç”±ç³»ç»Ÿçš„ç±»åŠ è½½å™¨æ‰§è¡Œï¼Œä½†æˆ‘ä»¬å¯ä»¥é€šè¿‡åå°„è·å–åˆ°å®ƒçš„å®ä¾‹å¯¹è±¡ï¼ŒJava åå°„çš„ç¡®å¾ˆç‰›å•Šã€‚ å¦‚ä½•è·å–å®ä¾‹å¯¹è±¡ ç¬¬ä¸€ä¸ªé—®é¢˜ï¼šä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦é€šè¿‡ Field è·å–ï¼Œä¸èƒ½ä½¿ç”¨ newInstance è·å–å‘¢ï¼Ÿ é€šè¿‡ newInstance çš„æ–¹æ³•è·å–å®åŠ›éœ€è¦æ„é€ å‡½æ•°æ˜¯ public çš„ï¼Œå¦åˆ™ä¼šæŠ›å¼‚å¸¸ï¼ŒåŠæ—¶ getUnsafe æ˜¯é™æ€å‡½æ•°ï¼Œæˆ‘ä»¬ä¹Ÿä¸èƒ½é€šè¿‡è¿™ä¸ªå»è·å–ï¼Œå› ä¸ºè¿™æ—¶å€™ç±»åŠ è½½ä¸æ˜¯ç³»ç»Ÿçš„ï¼Œä¼šæŠ›å¼‚å¸¸ 123456789101112private Unsafe() &#123;&#125;@CallerSensitivepublic static Unsafe getUnsafe() &#123; Class var0 = Reflection.getCallerClass(); if (!VM.isSystemDomainLoader(var0.getClassLoader())) &#123; throw new SecurityException(&quot;Unsafe&quot;); &#125; else &#123; return theUnsafe; &#125;&#125; 1Unsafe unsafe = Unsafe.class.newInstance(); ç”±äº Unsafe æ˜¯å•ä¾‹ï¼Œå½“ç±»åŠ è½½æ—¶ï¼ŒtheUnsafe å®ä¾‹ä¼šè¢«åŠ è½½ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡åå°„è·å–è¿™ä¸ªå®ä¾‹ 123456static &#123; registerNatives(); Reflection.registerMethodsToFilter(Unsafe.class, new String[]&#123;&quot;getUnsafe&quot;&#125;); // é‡ç‚¹ theUnsafe = new Unsafe();&#125; é€šè¿‡ Field è·å– 12345public static void main(String[] args) throws NoSuchFieldException, IllegalAccessException, InstantiationException &#123; Field theUnsafe = Unsafe.class.getDeclaredField(&quot;theUnsafe&quot;); theUnsafe.setAccessible(true); Unsafe unsafe = (Unsafe) theUnsafe.get(null);&#125; è·å–åˆ°è¿™å®ä¾‹ï¼Œå°±å¯ä»¥å¹²å¾ˆå¤šäº‹æƒ…äº†â€¦ å…ˆæ¥çœ‹çœ‹ API å›¾ å¤ªå¤šäº†ï¼Œçœ¼ç›éƒ½çœ‹çäº† å½’ä¸ªç±»å§ ç›´æ¥æ“ä½œå†…å­˜ï¼Œå°†æŸä¸ªå¯¹è±¡çš„å€¼æ›´æ”¹ï¼Œè¯»å–ï¼Œæ¯”å¦‚å°† String çš„ value æ›´æ”¹ï¼Œæ˜¯ä¸æ˜¯å¾ˆç¥å¥‡ï¼Œè¿™ä¸ªæ˜¯ç”¨åå°„ä¹Ÿå¯ä»¥æ›´æ”¹å“¦ï¼ä¸‹æ¬¡é¢è¯•çš„æ—¶å€™å¯ä»¥è€ƒè€ƒåˆ«äºº String çš„ value æ€ä¹ˆæ‰èƒ½æ”¹çš„æ‰ï¼Œçœ‹ä»–ä¼šå‡ ç§ã€‚ 123456789101112String str = &quot;Hello Unsafe&quot;;Field value = str.getClass().getDeclaredField(&quot;value&quot;);unsafe.putObject(str, unsafe.objectFieldOffset(value), new char[]&#123;&apos;M&apos;, &apos;a&apos;, &apos;j&apos;, &apos;i&apos;, &apos;c&apos;&#125;);]System.out.println(str);// output: Majic// throw exceptionString str = &quot;Hello Unsafe&quot;;Field value = str.getClass().getDeclaredField(&quot;value&quot;);value.setAccessible(true);value.set(str, new char[] &#123;&apos;f&apos;, &apos;i&apos;, &apos;n&apos;, &apos;a&apos;, &apos;l&apos;&#125;); CompareAndSwap è‘—åçš„ CAS ä¸ºäº†ä¿è¯å¹¶å‘å®‰å…¨ï¼Œ CAS æ¶‰åŠåˆ°çš„å˜é‡åº”è¯¥ä½¿ç”¨ volatile ä¿®é¥°ï¼Œä¿è¯è¯»åˆ°çš„å€¼æœ€æ–° allocateInstance æ–°å»ºä¸€ä¸ªæ²¡æœ‰åˆå§‹åŒ–çš„å®ä¾‹ï¼Œå„ä¸ªå€¼éƒ½æ˜¯é»˜è®¤å€¼ compareAndSwapLong ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ objectï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯å˜é‡å†…å­˜åç§»å€¼ï¼Œå¯ä»¥ç”¨ unsafe ç±»è·å–å®é™…åç§»å€¼ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ æœŸæœ›å€¼ï¼Œç¬¬å››ä¸ªä¸‰å”ç›®æ ‡å€¼ï¼Œå¤§è‡´çš„è¯­ä¹‰å°±æ˜¯ï¼šå¦‚æœå†…å­˜ä¸­æ˜¯æœŸæœ›å€¼ï¼Œæˆ‘å°±æ›´æ–°ä¸ºç›®æ ‡å€¼ï¼Œå¦åˆ™ä¸æ›´æ–° 12345678910111213141516171819202122232425public static void main(String[] args) throws NoSuchFieldException, IllegalAccessException, InstantiationException &#123; Field theUnsafe = Unsafe.class.getDeclaredField(&quot;theUnsafe&quot;); theUnsafe.setAccessible(true); Unsafe unsafe = (Unsafe) theUnsafe.get(null); InnerClass o = (InnerClass)unsafe.allocateInstance(InnerClass.class); o.print(); // print 100 Field a = o.getClass().getDeclaredField(&quot;value&quot;); unsafe.putLong(o, unsafe.objectFieldOffset(a), 10000); o.print(); // print 10000 unsafe.compareAndSwapLong(o, unsafe.objectFieldOffset(a), 10000, 1111); o.print(); // print 1111 unsafe.compareAndSwapLong(o, unsafe.objectFieldOffset(a), 1000, 10000); o.print(); // print 1111&#125; static class InnerClass &#123; // ä¿è¯å†…å­˜å¯è§æ€§ private volatile long value; InnerClass() &#123; value = 100L; &#125; void print() &#123; System.err.println(&quot;value==&gt;&quot; + value); &#125;&#125; çº¿ç¨‹æŒ‚èµ·ï¼Œå–æ¶ˆ ä½¿ç”¨ unsafe.unpark å¯ä»¥å–æ¶ˆ Thread.sleep() åè€… park çš„çº¿ç¨‹ ä½¿ç”¨ unsafe.park(false, 1000000000) å¯ä»¥æŒ‚èµ·å½“å‰çº¿ç¨‹ï¼Œç¬¬ä¸€ä¸ªå‚æ•°è¡¨ç¤ºæ˜¯isAbsoluteï¼Œæ˜¯å¦æ˜¯ç»å¯¹æ—¶é—´ï¼Œåä¸€ä¸ªå‚æ•°ä¸ºæ—¶é—´ï¼Œflase è¡¨ç¤ºç›¸å¯¹æ—¶é—´ï¼Œ0è¡¨ç¤ºä¸€ç›´æŒ‚èµ·ï¼Œå•ä½ä¸ºçº³ç§’ï¼›true è¡¨ç¤ºç»å¯¹æ—¶é—´ï¼Œå•ä½ä¸ºæ¯«ç§’ï¼ŒSystem.currentThreadMillis æ­é…ä½¿ç”¨ 1234567891011121314151617181920212223242526272829303132public static void main(String[] args) throws NoSuchFieldException, IllegalAccessException, InstantiationException, InterruptedException &#123; Field theUnsafe = Unsafe.class.getDeclaredField(&quot;theUnsafe&quot;); theUnsafe.setAccessible(true); Unsafe unsafe = (Unsafe) theUnsafe.get(null); InnerThread innerThread = new InnerThread(unsafe); innerThread.run(); Thread.sleep(20); // å–æ¶ˆæŒ‚èµ· unsafe.unpark(innerThread);&#125;static class InnerThread extends Thread &#123; Unsafe unsafe; InnerThread(Unsafe unsafe) &#123; this.unsafe = unsafe; &#125; @Override public void run() &#123; System.out.println(&quot;start&quot;); try &#123; Thread.sleep(1000L); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; //unsafe.park(false, 1000000000L); System.out.println(&quot;end&quot;); &#125;&#125; å°ç»“ ä»¥ååˆå¯ä»¥å¹ä¸€æ³¢äº†ï¼Œä¸€ç®­åŒé›•ï¼Œåå°„ï¼ŒUnsafe","categories":[{"name":"Java","slug":"Java","permalink":"https://wzes.github.io/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://wzes.github.io/tags/Java/"}]},{"title":"Java8 ArrayList & LinkedList è¦ç‚¹","slug":"Java/Java8 ArrayList&LinkedList è¦ç‚¹","date":"2018-09-13T11:03:00.000Z","updated":"2019-09-02T12:20:44.088Z","comments":true,"path":"2018/09/13/Java/Java8 ArrayList&LinkedList è¦ç‚¹/","link":"","permalink":"https://wzes.github.io/2018/09/13/Java/Java8 ArrayList&LinkedList è¦ç‚¹/","excerpt":"","text":"å‰è¨€ ä¸ºä»€ä¹ˆä¼šæƒ³å†™è¿™ä¸œè¥¿å‘¢ï¼Ÿè¿™æ˜¯æˆ‘ä»¬éƒ½éå¸¸å¸¸ç”¨çš„æ•°æ®ç»“æ„ï¼Œç„¶è€Œå¹³æ—¶é™¤äº†æ·»åŠ ï¼Œéå†æ“ä½œï¼Œå¾ˆå°‘ä½¿ç”¨å…¶ä»–åŠŸèƒ½ï¼Œå³ä½¿æ˜¯è¿™æ ·ï¼Œæˆ‘ä»¬ä¹Ÿå­˜åœ¨ä¸‡èˆ¬ç†ç”±ææ¸…æ¥šä»–ä»¬çš„ APIï¼Œè¿™å¯¹äºæˆ‘ä»¬åœ¨ç¼–ç¨‹æ—¶å¦‚ä½•é€‰æ‹©äºŒè€…å…·æœ‰è‰¯å¥½çš„æŒ‡å¯¼æ„ä¹‰ã€‚æ‰€ä»¥ï¼Œæˆ‘è§‰å¾—å¥½å¥½çœ‹çœ‹è¿™äºŒè€…çš„åŒºåˆ«ï¼Œä¹‹å‰ä¸€ç›´ä»¥ä¸ºåªæ˜¯ ArrayList å’Œ LinkedList åªæ˜¯æ•°ç»„å’Œé“¾è¡¨çš„åŒºåˆ«ï¼Œæˆ‘å·²ç»å¤§é”™ç‰¹é”™äº†ï¼Œ Java8 çš„å®ç°è¿œè¿œä¸æ­¢äºæ­¤ï¼ŒLinkedList è¿˜æœ‰åŒç«¯é˜Ÿåˆ—çš„åŠŸèƒ½ï¼Œä¹‹å‰ä¸€ç›´æ²¡æ³¨æ„åˆ°ï¼Œæœ€è¿‘å‘ç° ArrayDequeï¼Œå´æ²¡æœ‰çœ‹åˆ° LinkedDequeï¼Œæç„¶æƒ³èµ· LinkedList å®ç°äº† Deque æ¥å£ï¼Œè¿™æ‰æç„¶å¤§æ‚Ÿï½ï½ ArrayList &amp; LinkedList ä»–ä»¬çš„åŒºåˆ«ä»å®ç°çš„æ¥å£ä¸Šä¹Ÿå¯ä»¥çœ‹å‡ºæ¥ï¼Œ LinkedList å¤šå®ç°äº†ä¸€ä¸ªæ¥å£ï¼Œä¸‹æ¬¡é¢è¯•å®˜å†é—®åˆ°ï¼Œæˆ‘ä»¬å¯ä»¥è°ˆè°ˆè¿™ä¸ªé—®é¢˜ï¼Œé¢è¯•å®˜ä¼šå¦çœ¼ç›¸çœ‹çš„ï¼Œé¢è¯•å®˜å°±å–œæ¬¢æ·±å…¥ç ”ç©¶çš„ 12public class ArrayList&lt;E&gt; extends AbstractList&lt;E&gt; implements List&lt;E&gt;, RandomAccess, Cloneable, java.io.Serializable 123public class LinkedList&lt;E&gt; extends AbstractSequentialList&lt;E&gt; implements List&lt;E&gt;, Deque&lt;E&gt;, Cloneable, java.io.Serializable ArrayList åŸç† åˆå§‹å¤§å°ä¸º 10ï¼Œtransient Object[] elementData ç”¨æ¥å­˜å‚¨å…ƒç´  1234567891011121314151617181920212223242526272829/** * Default initial capacity. */private static final int DEFAULT_CAPACITY = 10;/** * Shared empty array instance used for empty instances. */private static final Object[] EMPTY_ELEMENTDATA = &#123;&#125;;private static final Object[] DEFAULTCAPACITY_EMPTY_ELEMENTDATA = &#123;&#125;; transient Object[] elementData; // non-private to simplify nested class accessprivate int size;public ArrayList(int initialCapacity) &#123; if (initialCapacity &gt; 0) &#123; this.elementData = new Object[initialCapacity]; &#125; else if (initialCapacity == 0) &#123; this.elementData = EMPTY_ELEMENTDATA; &#125; else &#123; throw new IllegalArgumentException(&quot;Illegal Capacity: &quot;+ initialCapacity); &#125;&#125;public ArrayList() &#123; this.elementData = DEFAULTCAPACITY_EMPTY_ELEMENTDATA;&#125; add æ–¹æ³•ï¼Œé¦–å…ˆæ£€æŸ¥å®¹é‡ï¼Œæ£€æŸ¥çš„æ—¶å€™é¦–å…ˆåœ¨æ˜¯å¦æ˜¯ç©ºçš„ï¼Œè·å–ä¸€ä¸ªæœ€å°å®¹é‡ï¼Œæ‰å»æ‰§è¡Œæ‰©å®¹ï¼Œä¸º elementData èµ‹å€¼ 123456789101112131415161718192021public boolean add(E e) &#123; ensureCapacityInternal(size + 1); // Increments modCount!! elementData[size++] = e; return true;&#125;private void ensureCapacityInternal(int minCapacity) &#123; if (elementData == DEFAULTCAPACITY_EMPTY_ELEMENTDATA) &#123; minCapacity = Math.max(DEFAULT_CAPACITY, minCapacity); &#125; ensureExplicitCapacity(minCapacity);&#125;private void ensureExplicitCapacity(int minCapacity) &#123; modCount++; // overflow-conscious code if (minCapacity - elementData.length &gt; 0) grow(minCapacity);&#125; æ‰©å®¹ç­–ç•¥ï¼Œæ¯æ¬¡å¢é•¿ 1/2 1234567891011private void grow(int minCapacity) &#123; // overflow-conscious code int oldCapacity = elementData.length; int newCapacity = oldCapacity + (oldCapacity &gt;&gt; 1); if (newCapacity - minCapacity &lt; 0) newCapacity = minCapacity; if (newCapacity - MAX_ARRAY_SIZE &gt; 0) newCapacity = hugeCapacity(minCapacity); // minCapacity is usually close to size, so this is a win: elementData = Arrays.copyOf(elementData, newCapacity);&#125; å¦‚æœä½ æƒ³åœ¨æ•°ç»„ä¸­ç¡®å®šæŸä¸€ä¸ªå…ƒç´ çš„è¯ï¼Œé‚£ä¹ˆéœ€è¦éå†ï¼Œæœ‰ä¸¤ç§éå†æ–¹å¼ï¼Œå¯æ ¹æ®åœºæ™¯è‡ªè¡Œé€‰æ‹© 12345678910111213141516171819202122232425public int indexOf(Object o) &#123; if (o == null) &#123; for (int i = 0; i &lt; size; i++) if (elementData[i]==null) return i; &#125; else &#123; for (int i = 0; i &lt; size; i++) if (o.equals(elementData[i])) return i; &#125; return -1;&#125;public int lastIndexOf(Object o) &#123; if (o == null) &#123; for (int i = size-1; i &gt;= 0; i--) if (elementData[i]==null) return i; &#125; else &#123; for (int i = size-1; i &gt;= 0; i--) if (o.equals(elementData[i])) return i; &#125; return -1;&#125; toArray é€šå¸¸éœ€è¦è¿›è¡Œç±»å‹å¼ºè½¬ 123public Object[] toArray() &#123; return Arrays.copyOf(elementData, size);&#125; è·å–æŸä¸ªç´¢å¼•çš„å…ƒç´ ï¼Œæˆ‘ä»¬çœ‹åˆ°ä¹Ÿæ˜¯å¼ºè½¬ç±»å‹ 12345678910111213141516E elementData(int index) &#123; return (E) elementData[index];&#125;/** * Returns the element at the specified position in this list. * * @param index index of the element to return * @return the element at the specified position in this list * @throws IndexOutOfBoundsException &#123;@inheritDoc&#125; */public E get(int index) &#123; rangeCheck(index); return elementData(index);&#125; è¿˜æœ‰ set æ–¹æ³•ï¼Œè¦†ç›–ä¹‹å‰çš„å€¼ï¼Œè¿”å›æ—§å€¼ 1234567public E set(int index, E element) &#123; rangeCheck(index); E oldValue = elementData(index); elementData[index] = element; return oldValue;&#125; æ’å…¥ï¼Œéœ€è¦ç§»åŠ¨ä¹‹åçš„æ‰€æœ‰å…ƒç´  123456789public void add(int index, E element) &#123; rangeCheckForAdd(index); ensureCapacityInternal(size + 1); // Increments modCount!! System.arraycopy(elementData, index, elementData, index + 1, size - index); elementData[index] = element; size++;&#125; åˆ é™¤æŸä¸ªç´¢å¼•çš„å…ƒç´ ï¼ŒåŒæ ·éœ€è¦ç§»åŠ¨å…ƒç´  1234567891011121314public E remove(int index) &#123; rangeCheck(index); modCount++; E oldValue = elementData(index); int numMoved = size - index - 1; if (numMoved &gt; 0) System.arraycopy(elementData, index+1, elementData, index, numMoved); elementData[--size] = null; // clear to let GC do its work return oldValue;&#125; åˆ é™¤æŸä¸ª objectï¼Œçœ‹åˆ°äº† fastRemoveï¼Œåªä¸è¿‡æ˜¯å»é™¤äº†è¾¹ç•ŒéªŒè¯ 12345678910111213141516public boolean remove(Object o) &#123; if (o == null) &#123; for (int index = 0; index &lt; size; index++) if (elementData[index] == null) &#123; fastRemove(index); return true; &#125; &#125; else &#123; for (int index = 0; index &lt; size; index++) if (o.equals(elementData[index])) &#123; fastRemove(index); return true; &#125; &#125; return false;&#125; LinkedList ç”±äºæ˜¯é“¾è¡¨ï¼Œå¾ˆå¤šé¦–å°¾èŠ‚ç‚¹çš„æ’å…¥åˆ é™¤æ“ä½œï¼Œæ–¹ä¾¿äº†å¾ˆå¤š å±æ€§ å¾ˆç®€å•çš„ä¸‰ä¸ªå±æ€§ 123456789101112131415transient int size = 0;/** * Pointer to first node. * Invariant: (first == null &amp;&amp; last == null) || * (first.prev == null &amp;&amp; first.item != null) */transient Node&lt;E&gt; first;/** * Pointer to last node. * Invariant: (first == null &amp;&amp; last == null) || * (last.next == null &amp;&amp; last.item != null) */transient Node&lt;E&gt; last; node é™æ€å†…éƒ¨ç±»ï¼Œæ ¹æ® Effective Java çš„æè¿°ï¼Œè¿™ç§è®¾è®¡æ˜¯æ¯”è¾ƒå¥½çš„ã€‚ 1234567891011private static class Node&lt;E&gt; &#123; E item; Node&lt;E&gt; next; Node&lt;E&gt; prev; Node(Node&lt;E&gt; prev, E element, Node&lt;E&gt; next) &#123; this.item = element; this.next = next; this.prev = prev; &#125;&#125; æˆ‘ä»¬ç®€å•çœ‹ä¸€äº›æ–¹æ³•å³å¯ï¼Œç”±äºå®ç°äº† Dequeï¼Œå¤§éƒ¨åˆ†æ“ä½œéå¸¸ç›¸ä¼¼ add åœ¨å°¾éƒ¨æ·»åŠ å…ƒç´ ï¼Œæ— éœ€è¾¹ç•Œæ£€æŸ¥ 12345678910111213141516public boolean add(E e) &#123; linkLast(e); return true;&#125;void linkLast(E e) &#123; final Node&lt;E&gt; l = last; final Node&lt;E&gt; newNode = new Node&lt;&gt;(l, e, null); last = newNode; if (l == null) first = newNode; else l.next = newNode; size++; modCount++;&#125; è·å–å…ƒç´ ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ä¸ºäº†åŠ å¿«é€Ÿåº¦ï¼Œä¼šåˆ¤æ–­æ›´æ¥è¿‘åè¾¹è¿˜æ˜¯å‰è¾¹ï¼Œè¿™æ ·èƒ½çœä¸€èˆ¬æ—¶é—´ 12345678910111213141516171819public E get(int index) &#123; checkElementIndex(index); return node(index).item;&#125;Node&lt;E&gt; node(int index) &#123; // assert isElementIndex(index); if (index &lt; (size &gt;&gt; 1)) &#123; Node&lt;E&gt; x = first; for (int i = 0; i &lt; index; i++) x = x.next; return x; &#125; else &#123; Node&lt;E&gt; x = last; for (int i = size - 1; i &gt; index; i--) x = x.prev; return x; &#125;&#125; è€Œ indexOf(Object o) å°±æ²¡è¿™ä¸ªå¹¸è¿äº†ï¼Œå¿…é¡»è€è€å®å®ä»å¤´å¼€å§‹ 1234567891011121314151617public int indexOf(Object o) &#123; int index = 0; if (o == null) &#123; for (Node&lt;E&gt; x = first; x != null; x = x.next) &#123; if (x.item == null) return index; index++; &#125; &#125; else &#123; for (Node&lt;E&gt; x = first; x != null; x = x.next) &#123; if (o.equals(x.item)) return index; index++; &#125; &#125; return -1;&#125; ä¸€äº›å…³äºé˜Ÿåˆ—çš„æ“ä½œï¼Œæ³¨æ„æ–¹æ³•çš„è¿”å›å€¼ï¼Œå¦‚æœå‡ºç°ä¸ºç©ºæ˜¯å¦ä¼šæŠ›å‡ºå¼‚å¸¸å‘¢ï¼Œåƒ element pop remove ä¼šæŠ›å¼‚å¸¸ï¼Œè€Œ peekï¼Œpoll åˆ™ä¸ä¼šï¼Œè¿™äº›éƒ½è¦æ³¨æ„ï¼Œå¦åˆ™ä¸€ä¸å°å¿ƒå°±ä¼šå¼•å‘æƒ¨æ¡ˆï¼ï¼ï¼ 12345678910111213141516171819202122232425262728293031323334353637public E peek() &#123; final Node&lt;E&gt; f = first; return (f == null) ? null : f.item;&#125;/** * Retrieves, but does not remove, the head (first element) of this list. * * @return the head of this list * @throws NoSuchElementException if this list is empty * @since 1.5 */public E element() &#123; return getFirst();&#125;public E getFirst() &#123; final Node&lt;E&gt; f = first; if (f == null) throw new NoSuchElementException(); return f.item;&#125;/** * Retrieves and removes the head (first element) of this list. * * @return the head of this list, or &#123;@code null&#125; if this list is empty * @since 1.5 */public E poll() &#123; final Node&lt;E&gt; f = first; return (f == null) ? null : unlinkFirst(f);&#125;public E pop() &#123; return removeFirst();&#125; å…¶å®ƒçš„ä¾¿ä¸è´´ä»£ç äº†ï¼Œéƒ½å¾ˆå¥½ç†è§£äº† å°ç»“ æ€»çš„æ¥è¯´ï¼Œå¯¹è¿™ä¸¤ä¸ªä¸œè¥¿çš„ç”¨æ³•æ›´åŠ æ¸…æ™°äº†ï¼Œæ¥é¾™å»è„‰æ‘¸å¾—æ›´å‡†ç¡®äº†ï½","categories":[{"name":"Java","slug":"Java","permalink":"https://wzes.github.io/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://wzes.github.io/tags/Java/"}]},{"title":"Java8 ArrayDeque æºç è§£æ","slug":"Java/Java8 ArrayDeque æºç è§£æ","date":"2018-09-12T15:36:00.000Z","updated":"2019-09-02T12:20:38.220Z","comments":true,"path":"2018/09/12/Java/Java8 ArrayDeque æºç è§£æ/","link":"","permalink":"https://wzes.github.io/2018/09/12/Java/Java8 ArrayDeque æºç è§£æ/","excerpt":"","text":"å‰è¨€ ä»Šå¤©æˆ‘ä»¬æ¥çœ‹çœ‹ ArrayDequeï¼Œå¯ä»¥è¯´ï¼Œä¹‹å‰ä½¿ç”¨çš„é˜Ÿåˆ—çš„åœºæ™¯ä¸å¤šï¼Œæ‰€ä»¥ä¹Ÿæ²¡æœ‰æ·±å…¥ç ”ç©¶é˜Ÿåˆ—ï¼Œä½†æœ€è¿‘åœ¨åš LeetCode çš„æ—¶å€™ï¼Œå¾ˆå¤šæ—¶å€™ä½¿ç”¨é˜Ÿåˆ—ä¼šæœ‰æƒ³ä¸åˆ°çš„åŠŸæ•ˆï¼Œæ¯”å¦‚æˆ‘ä»¬åœ¨å†™ BFS å¹¿åº¦ä¼˜å…ˆéå†çš„æ—¶å€™ï¼Œæˆ–è€…åœ¨å†™ äºŒå‰æ ‘çš„å±‚æ¬¡éå†ï¼Œéé€’å½’å‰åºï¼Œä¸­åºï¼Œååºéå†ï¼Œéƒ½ä¼šç”¨åˆ°è¿™ä¸ªç»“æ„ï¼Œå¦‚æœè¿˜ä¸ä¼šçš„åŒå­¦ï¼Œèµ¶ç´§å»å¤ä¹ ä¸€æ³¢å§ï¼Œéå¸¸æ€»è¦ï¼Œä¹Ÿèƒ½ä¸ºä½ çš„ç¬”é¢è¯•åŠ ä¸å°‘åˆ†ï¼Œå¾ˆå¤šæ—¶å€™å½“é¢è¯•å®˜é—®é“æˆ‘åˆ†æè¿‡çš„æºç æ—¶ï¼Œå¿ƒé‡Œé‚£ä¸ªå«é…¸çˆ½å•Šï¼Œä»¤é¢è¯•å®˜åˆ®ç›®ç›¸çœ‹ã€‚é—²è¯ä¸å¤šè¯´äº†ï¼Œè®©æˆ‘ä»¬æ·±å…¥äº†è§£ä¸€ä¸‹æˆ‘ä»¬çš„ä¸»è§’ å‰ä¸–ä»Šç”Ÿ å®ç°äº† Deque æ¥å£ï¼ŒDeque ç»§æ‰¿äº† Queue 1234public class ArrayDeque&lt;E&gt; extends AbstractCollection&lt;E&gt; implements Deque&lt;E&gt;, Cloneable, Serializable &#123;&#125;public interface Deque&lt;E&gt; extends Queue&lt;E&gt; &#123;&#125; Queue åœ¨äº†è§£ ArrayDeque ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ Queue æœ‰äº›ä»€ä¹ˆä¸œè¥¿ï¼Œè°ˆåˆ°é˜Ÿåˆ—ï¼Œæˆ‘ä»¬ä¼šæƒ³åˆ°å…ˆè¿›å…ˆå‡ºç­‰ç‰¹æ€§ï¼Œæˆ‘æŠŠæ¥å£è´´å‡ºæ¥ç»™å¤§å®¶çœ‹ä¸€ä¸‹ï¼Œå¦‚æœä½ è¿˜ä¸ç†Ÿæ‚‰è¿™å‡ ä¸ªæ–¹æ³•çš„åŒºåˆ«ï¼Œæ˜¯è¯¥åçœä¸€ä¸‹äº†ï¼ï¼ï¼ä¸€å®šè¦ç†Ÿè®°ï¼Œè¿™æ˜¯åŸºæœ¬åŠŸ 1234567891011boolean add(E e);boolean offer(E e);E remove();E poll();E element();E peek(); Deque ç”±äºæ˜¯åŒç«¯é˜Ÿåˆ—ï¼Œå¤šäº†å¾ˆå¤šæ¥å£ï¼Œä¸€å¼ å›¾çœŸç›¸ï¼Œä½ å¯èƒ½ä¼šè¯´ï¼Œè®°ä½è¿™äº›æ‰€æœ‰çš„å¤ªéš¾äº†ï¼Œå¤ªå¤šäº†ï¼Œä½†æ€»ç»“èµ·æ¥ï¼Œä¹Ÿå¹¶ä¸å¤šï¼Œåœ¨ä¹‹å‰çš„Queueçš„æ¥å£çš„åŸºç¡€ä¸Šï¼ŒåŠ äº† Firstï¼ŒLast çš„æ¥å£ï¼Œæ˜¯ä¸æ˜¯ä¸€ä¸‹å­å˜å°‘äº† ArrayDeque ç»ˆäºåˆ°äº†æˆ‘ä»¬çš„ä¸»è§’äº†ï¼Œç„¶è€Œä½ å¯èƒ½ä¼šæƒ³ï¼Œæ˜¯ä¸æ˜¯ä¹Ÿæœ‰LinkedDequeï¼Œå½“åˆæˆ‘ä¹Ÿè¿™æ ·æƒ³è¿‡ï¼Œç„¶è€Œæˆ‘å¹¶æ²¡æœ‰åœ¨ jdk é‡Œæ‰¾åˆ°è¿™ä¸ªæ•°æ®ç»“æ„ï¼Œä½†æ˜¯ LinkedList å´å®ç°äº† Deque ä¹Ÿå°±æ˜¯è¯´å®ƒå–ä»£äº†è‡ªå·±LinkedDequeï¼Œä¹Ÿå°±æ²¡æœ‰å¿…è¦å¤šæ­¤ä¸€ä¸¾äº† å±æ€§ æ—¢ç„¶æ˜¯ Arrayï¼Œé‚£ä¹ˆé‡Œé¢åŠ¿å¿…ç”¨æ•°ç»„å­˜å‚¨ï¼Œè®°ä½ï¼Œä½¿ç”¨ Object[] elements,è€Œä¸æ˜¯T[] elements,èªæ˜çš„ä½ èƒ½å¦æƒ³åˆ°è¿™æ ·åšçš„ç›®çš„å‘¢ï¼Ÿå“ˆå“ˆã€‚ç„¶åæ˜¯ä¸€ä¸ªheadï¼Œtail çš„æŒ‡é’ˆã€‚ 1234567891011121314transient Object[] elements; // non-private to simplify nested class access /** * The index of the element at the head of the deque (which is the * element that would be removed by remove() or pop()); or an * arbitrary number equal to tail if the deque is empty. */ transient int head; /** * The index at which the next element would be added to the tail * of the deque (via addLast(E), add(E), or push(E)). */ transient int tail; æ„é€ å‡½æ•° é»˜è®¤å¼€è¾Ÿäº† 16 çš„æ•°ç»„ï¼Œä¸€èˆ¬éƒ½æ˜¯è¿™æ ·ï¼Œé¢„å…ˆå¼€è¾Ÿç©ºé—´ï¼Œä¸å¤Ÿäº†å†æ‰©å®¹ã€‚å¦‚æœè‡ªå·±æŒ‡å®šäº†å¤§å°ï¼Œé‚£ä¹ˆå°†è°ƒç”¨ allocateElementså‡½æ•°ï¼Œè·å–ä¸€ä¸ª 2 çš„å¹‚æ¬¡æ–¹çš„å¤§å°çš„å®¹é‡ï¼Œå¦‚æœä½ çŸ¥é“ Hashmapçš„åˆå§‹åŒ–ï¼Œé‚£ä¹ˆè¿™ä¸ªåˆå§‹åŒ–ä½ ä¸€å®šä¸é™Œç”Ÿï¼è‡³äºæ€ä¹ˆåšåˆ°ï¼Œä½ å¯ä»¥è‡ªå·±å®è·µä¸€ä¸‹ï¼Œè¿™æ ·ä¼šç†è§£çš„æ›´åŠ é€å½»ï¼ 12345678910111213141516171819202122232425262728293031323334public ArrayDeque() &#123; elements = new Object[16];&#125;public ArrayDeque(int numElements) &#123; allocateElements(numElements);&#125; public ArrayDeque(Collection&lt;? extends E&gt; c) &#123; allocateElements(c.size()); addAll(c);&#125;private void allocateElements(int numElements) &#123; elements = new Object[calculateSize(numElements)];&#125;private static int calculateSize(int numElements) &#123; int initialCapacity = MIN_INITIAL_CAPACITY; // Find the best power of two to hold elements. // Tests &quot;&lt;=&quot; because arrays aren&apos;t kept full. if (numElements &gt;= initialCapacity) &#123; initialCapacity = numElements; initialCapacity |= (initialCapacity &gt;&gt;&gt; 1); initialCapacity |= (initialCapacity &gt;&gt;&gt; 2); initialCapacity |= (initialCapacity &gt;&gt;&gt; 4); initialCapacity |= (initialCapacity &gt;&gt;&gt; 8); initialCapacity |= (initialCapacity &gt;&gt;&gt; 16); initialCapacity++; if (initialCapacity &lt; 0) // Too many elements, must back off initialCapacity &gt;&gt;&gt;= 1;// Good luck allocating 2 ^ 30 elements &#125; return initialCapacity;&#125; æ™®é€šçš„æ–¹æ³• add ä½¿ç”¨ addLast åœ¨æœ«å°¾è¿½åŠ å…ƒç´  1234public boolean add(E e) &#123; addLast(e); return true;&#125; addLastï¼Œç›´æ¥ç»™æ•°ç»„çš„æœ«å°¾å…ƒç´ èµ‹å€¼ï¼Œä¹‹åä¾¿æ˜¯ç§»åŠ¨tail æŒ‡é’ˆï¼Œè¿™é‡Œçš„æ‰©å®¹å®ç°çš„å¾ˆæœ‰æ„æ€ï¼Œè¿™ä¹Ÿå¯¹åº”äº†ä¸ºä»€ä¹ˆå®¹é‡è¦ä¸º 2çš„å¹‚æ¬¡æ–¹ï¼Œå½“æ•°ç»„å¤§å°åˆšå¥½ä¸º 2 çš„å¹‚æ¬¡æ–¹æ—¶ï¼Œ(tail = (tail + 1) &amp; (elements.length - 1) ä¸ºé›¶ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœheadä¹Ÿä¸º0ï¼Œé‚£ä¹ˆå°±éœ€è¦æ‰©å®¹äº† 1234567public void addLast(E e) &#123; if (e == null) throw new NullPointerException(); elements[tail] = e; if ( (tail = (tail + 1) &amp; (elements.length - 1)) == head) doubleCapacity();&#125; doubleCapacity å‡½æ•°ï¼Œæ–°æ•°ç»„çš„å¤§å°ä¸ºä¸¤å€ï¼Œä½¿ç”¨ System.arraycopy å‡½æ•°å¤åˆ¶ï¼Œæ•ˆç‡æé«˜ã€‚å› ä¸º head ä¸ä¸€å®šä¸ºé›¶ï¼Œæ‰€ä»¥åœ¨æ‰©å®¹çš„æ—¶å€™ï¼Œéœ€è¦æ¢å¤head = 0ï¼›è¿™é‡Œæˆ‘ä»¬åº”è¯¥æ¨æµ‹å‡ºæ•´ä¸ªæ•°ç»„éƒ½æ˜¯å­˜å‚¨æ•°æ®ï¼Œä¸ºäº†æ–¹ä¾¿åˆ é™¤æ•°ç»„è€Œä¸ç§»åŠ¨å…ƒç´ ï¼Œä¾¿ä½¿ç”¨äº†æŒ‡é’ˆè®°å½•çŠ¶æ€ï¼Œè¿™ä¸€å®ç°å¿…é¡»è¦å¥½å¥½ç¢ç£¨ï¼Œä¸‹æ¬¡é¢è¯•åˆ«äººçš„æ—¶å€™å¯ä»¥é—®ä¸€ä¸‹åˆ«äººï¼Œå“ˆå“ˆï¼Œæœ‰ç‚¹å°å 123456789101112131415private void doubleCapacity() &#123; assert head == tail; int p = head; int n = elements.length; int r = n - p; // number of elements to the right of p int newCapacity = n &lt;&lt; 1; if (newCapacity &lt; 0) throw new IllegalStateException(&quot;Sorry, deque too big&quot;); Object[] a = new Object[newCapacity]; System.arraycopy(elements, p, a, 0, r); System.arraycopy(elements, 0, a, r, p); elements = a; head = 0; tail = n;&#125; pollFirst è·å–å…ƒç´ ï¼Œå½“ç„¶æ˜¯ä» head ä½ç½®è·å–å…ƒç´ ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œhead å¦‚æœåˆ°äº†æ•°ç»„æœ«å°¾ï¼Œé‚£ä¹ˆåˆä¼šé€šè¿‡ (h + 1) &amp; (elements.length - 1) å˜ä¸º 0 äº† 1234567891011public E pollFirst() &#123; int h = head; @SuppressWarnings(&quot;unchecked&quot;) E result = (E) elements[h]; // Element is null if deque empty if (result == null) return null; elements[h] = null; // Must null out slot head = (h + 1) &amp; (elements.length - 1); return result;&#125; pollLast è·å–é˜Ÿå°¾å…ƒç´ ï¼Œå¦‚æœé˜Ÿå°¾å…ƒç´ æ­¤æ—¶ä¸º 0ï¼Œé‚£ä¹ˆå°†å›åˆ°äº† æ•°ç»„æœ«å°¾ï¼Œåˆ«é—®æˆ‘æ€ä¹ˆçŸ¥é“ï¼Œè€å¸ˆå«ä½ å¥½å¥½å­¦äºŒè¿›åˆ¶ï¼ 12345678910public E pollLast() &#123; int t = (tail - 1) &amp; (elements.length - 1); @SuppressWarnings(&quot;unchecked&quot;) E result = (E) elements[t]; if (result == null) return null; elements[t] = null; tail = t; return result;&#125; å…¶ä»–çš„ä¸æ¶‰åŠåˆ°åˆ é™¤ï¼Œæ·»åŠ åˆ°æ“ä½œå°±æ˜¾å¾—å°¤ä¸ºç®€å•äº†ï¼Œç›´æ¥è·å–ï¼Œå°±ä¸å¿…å¤šè¯´äº† 123456789101112131415161718public E getFirst() &#123; @SuppressWarnings(&quot;unchecked&quot;) E result = (E) elements[head]; if (result == null) throw new NoSuchElementException(); return result;&#125;/** * @throws NoSuchElementException &#123;@inheritDoc&#125; */public E getLast() &#123; @SuppressWarnings(&quot;unchecked&quot;) E result = (E) elements[(tail - 1) &amp; (elements.length - 1)]; if (result == null) throw new NoSuchElementException(); return result;&#125; pop æ ¹æ®å…ˆè¿›å…ˆå‡ºï¼Œpop åº”è¯¥ç§»é™¤é˜Ÿé¦–çš„å…ƒç´ ï¼Œæ³¨æ„ï¼Œè¿™é‡Œä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œå¦‚æœé˜Ÿé¦–ä¸ºç©ºçš„è¯ 12345 * @throws NoSuchElementException &#123;@inheritDoc&#125; */public E pop() &#123; return removeFirst();&#125; å°ç»“ ArrayDeque çœ‹èµ·æ¥ä¸å¤§ï¼Œä½†ä¹Ÿæœ‰ä¸å°‘ä¸œè¥¿ï¼ŒçŸ¥é“å¤§æ¦‚å®¹æ˜“ï¼Œå¼„æ‡‚æ¯ä¸€ä¸ªç»†èŠ‚å¾ˆéš¾ï¼Œå¦‚æœä½ åšåˆ°äº†ï¼ŒæˆåŠŸä¾¿æ˜¯ä½ çš„~","categories":[{"name":"Java","slug":"Java","permalink":"https://wzes.github.io/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://wzes.github.io/tags/Java/"}]},{"title":"Android IntentService æºç è§£æ","slug":"Android/IntentService","date":"2018-09-06T15:04:00.000Z","updated":"2019-09-02T12:18:51.162Z","comments":true,"path":"2018/09/06/Android/IntentService/","link":"","permalink":"https://wzes.github.io/2018/09/06/Android/IntentService/","excerpt":"","text":"å‰è¨€ é¡¾åæ€ä¹‰ï¼Œæ˜¯ä¸€ä¸ª Serviceï¼Œå…ˆè¯´å’Œæ™®é€šçš„ Service çš„åŒºåˆ«å§ï¼Œæ™®é€šçš„ Service é€šå¸¸è¿è¡Œåœ¨ä¸»çº¿ç¨‹ï¼Œè€Œ IntentService çš„å¤„ç†é€»è¾‘åœ¨å­çº¿ç¨‹é‡Œï¼Œå¦å¤– Service éœ€è¦è‡ªå·±å» destroyï¼Œè€Œ IntentService åœ¨å¤„ç†å®Œè‡ªå·±çš„é€»è¾‘æ—¶ä¼šè‡ªåŠ¨ç»“æŸï¼Œé‚£ä»–æ˜¯æ€ä¹ˆå®ç°çº¿ç¨‹åˆ‡æ¢ï¼Œä¸»è¦è¿˜æ˜¯ Handler æœºåˆ¶ï¼Œå†…éƒ¨æœ‰ä¸€ä¸ª HandleThreadï¼Œå…³äºè¿™ä¸ªï¼Œå¯ä»¥æŸ¥çœ‹ [HandlerThread æºç è§£æ] (https://www.jianshu.com/p/5ff83236c8e2) å‰ä¸–ä»Šç”Ÿ 1public abstract class IntentService extends Service &#123;&#125; ç»§æ‰¿è‡ª Serviceï¼Œæ‹¥æœ‰ Service çš„ç‰¹æ€§ï¼Œä¸ç†Ÿæ‚‰ Service çš„åŒå­¦å¯ä»¥è‡ªè¡Œç™¾åº¦ï¼Œé¢è¯•å¿…é—®çš„ï¼Œç„¶è€Œæ„Ÿè§‰æˆ‘è¿˜æ˜¯ä¸æƒ³æ·±å…¥äº†è§£ï¼Œä»¥åå†è¯´å§ è®°ä½ 12onCreate -&gt; onStartCommand -&gt; onDestroyonCreate -&gt; onBind -&gt; onUnbind è‡ªå·±å†™ä¸€ä¸ª IntentService 1public class MyIntentService extends IntentService &#123;&#125; æºç è§£æ å¾ˆç†Ÿæ‚‰çš„ Looper å’Œ ServiceHandler 12345678910111213141516private volatile Looper mServiceLooper;private volatile ServiceHandler mServiceHandler;private String mName;private boolean mRedelivery;private final class ServiceHandler extends Handler &#123; public ServiceHandler(Looper looper) &#123; super(looper); &#125; @Override public void handleMessage(Message msg) &#123; onHandleIntent((Intent)msg.obj); stopSelf(msg.arg1); &#125;&#125; çœ‹ä¸€ä¸‹ onCreateï¼Œåˆå§‹åŒ–äº†ä¸€ä¸ª HandlerThreadï¼Œç„¶åå†æŠŠä»–çš„ Looper æ‹¿å‡ºæ¥ï¼Œç„¶åæŠ›å¼ƒäº†å®ƒï¼Œè¿™ä¸ª Looper æ˜¯å­çº¿ç¨‹çš„ Looperï¼Œå› æ­¤äº‹ä»¶å¤„ç†ä¹Ÿå‘ç”Ÿåœ¨å­çº¿ç¨‹ã€‚åˆ©ç”¨è¿™ä¸ª Looper æ–°å»ºäº†ä¸€ä¸ª Handler 12345678910111213@Override public void onCreate() &#123; // TODO: It would be nice to have an option to hold a partial wakelock // during processing, and to have a static startService(Context, Intent) // method that would launch the service &amp; hand off a wakelock. super.onCreate(); HandlerThread thread = new HandlerThread(&quot;IntentService[&quot; + mName + &quot;]&quot;); thread.start(); mServiceLooper = thread.getLooper(); mServiceHandler = new ServiceHandler(mServiceLooper); &#125; å¯åŠ¨ä»¥åè°ƒç”¨ onStartï¼Œå‘é€ä¸€ä¸ªæ¶ˆæ¯ï¼ŒonHandleIntent((Intent)msg.obj) é‡Œé¢è¿›è¡Œå¤„ç†ï¼Œæˆ‘ä»¬è¦é‡å†™è¿™ä¸ªæ–¹æ³•ï¼Œé€šå¸¸è¿™ä¸ªåœ¨å­çº¿ç¨‹ä¸­è¿è¡Œ 12345678910111213 @Override public int onStartCommand(@Nullable Intent intent, int flags, int startId) &#123; onStart(intent, startId); return mRedelivery ? START_REDELIVER_INTENT : START_NOT_STICKY; &#125;@Override public void onStart(@Nullable Intent intent, int startId) &#123; Message msg = mServiceHandler.obtainMessage(); msg.arg1 = startId; msg.obj = intent; mServiceHandler.sendMessage(msg); &#125; å¤„ç†å®Œå³å…³é—­ï¼Œä¸éœ€è¦æ‰‹åŠ¨å…³é—­ 12345678910111213141516171819public final void stopSelf() &#123; stopSelf(-1);&#125;/** * Old version of &#123;@link #stopSelfResult&#125; that doesn&apos;t return a result. * * @see #stopSelfResult */public final void stopSelf(int startId) &#123; if (mActivityManager == null) &#123; return; &#125; try &#123; mActivityManager.stopServiceToken( new ComponentName(this, mClassName), mToken, startId); &#125; catch (RemoteException ex) &#123; &#125;&#125; åœ¨æˆ‘ä»¬è‡ªå·±çš„ IntentService é‡Œé¢ï¼Œå†™å¤„ç†çš„é€»è¾‘ï¼Œç”±äºæ˜¯åœ¨å­çº¿ç¨‹ä¸­ï¼Œæ‰€ä»¥å¯ä»¥å¤„ç†è€—æ—¶çš„é€»è¾‘ï¼Œä¸å¿…æ‹…å¿ƒ ANRï¼Œæ™®é€š Service ç”±äºåœ¨ä¸»çº¿ç¨‹è¿è¡Œï¼Œæ‰€ä»¥ä¸èƒ½ç›´æ¥å¤„ç†è€—æ—¶é€»è¾‘ 123456789101112131415@Overrideprotected void onHandleIntent(Intent intent) &#123; if (intent != null) &#123; final String action = intent.getAction(); if (ACTION_FOO.equals(action)) &#123; final String param1 = intent.getStringExtra(EXTRA_PARAM1); final String param2 = intenonHt.getStringExtra(EXTRA_PARAM2); handleActionFoo(param1, param2); &#125; else if (ACTION_BAZ.equals(action)) &#123; final String param1 = intent.getStringExtra(EXTRA_PARAM1); final String param2 = intent.getStringExtra(EXTRA_PARAM2); handleActionBaz(param1, param2); &#125; &#125;&#125; å°ç»“ éå¸¸ç®€å•çš„ IntentServiceï¼Œä½¿ç”¨çš„æ—¶å€™æ³¨æ„ä¸æ™®é€š Service çš„åŒºåˆ«å³å¯ï¼Œé‡Œé¢ä½¿ç”¨äº† HandlerThread è·å– Looper å¯¹è±¡ï¼Œå¤„ç†å®Œä¼šè‡ªåŠ¨å…³é—­ï¼Œå³è°ƒç”¨ onDestroyï¼Œå†æ¬¡å¯åŠ¨åˆé‡æ–°èµ° Service çš„ç”Ÿå‘½å‘¨æœŸï¼Œä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœå¤šæ¬¡ startServiceï¼Œé‚£ä¹ˆ onHandleIntent æ˜¯æ€ä¹ˆæ ·çš„å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ä¸€æ¬¡æ‰§è¡Œï¼Œå› ä¸º Looper äº‹ä»¶å¤„ç†æ˜¯é˜»å¡çš„","categories":[{"name":"Android","slug":"Android","permalink":"https://wzes.github.io/categories/Android/"}],"tags":[{"name":"Android","slug":"Android","permalink":"https://wzes.github.io/tags/Android/"}]},{"title":"BloomFilter&Hyperloglog å»é‡&ç»Ÿè®¡","slug":"Backend/BloomFilter&Hyperloglog å»é‡&ç»Ÿè®¡","date":"2018-09-06T04:53:00.000Z","updated":"2019-09-02T12:20:13.771Z","comments":true,"path":"2018/09/06/Backend/BloomFilter&Hyperloglog å»é‡&ç»Ÿè®¡/","link":"","permalink":"https://wzes.github.io/2018/09/06/Backend/BloomFilter&Hyperloglog å»é‡&ç»Ÿè®¡/","excerpt":"","text":"å»é‡å°ç»“ æœ€è¿‘åœ¨åšçˆ¬è™«çš„æ—¶å€™ï¼Œé‡åˆ°äº†å»é‡çš„é—®é¢˜ï¼Œå…³äºå»é‡ï¼Œæœ‰å¾ˆå¤šåœ°æ–¹å¯ä»¥åšï¼Œæ¯”å¦‚ å†…å­˜çº§åˆ«ï¼Œåˆ©ç”¨ hashmapï¼Œå‡†ç¡®ï¼Œæ€§èƒ½å¥½ä½†æ˜¯å†…å­˜æœ‰é™ æ•°æ®åº“ï¼Œåˆ©ç”¨å”¯ä¸€é”®ï¼Œå‡†ç¡®ï¼Œå­˜å‚¨é‡å¤§ä½†æ˜¯æ€§èƒ½å·® å†…å­˜çº§åˆ« BloomFilterï¼Œåˆ©ç”¨ bitmapï¼Œæ€§èƒ½å¥½ï¼Œå­˜å‚¨é‡æ¯” hashmap å¤§å¾—å¤šï¼Œä½†æ˜¯æœ‰è¯¯å·® å®é™…ä½¿ç”¨çš„æ—¶å€™è¦æ ¹æ®åœºæ™¯å» tradeoffï¼Œæ²¡æœ‰æœ€å¥½çš„åŠæ³•ï¼Œåªæœ‰æœ€åˆé€‚çš„åŠæ³• åŸºæ•°ç»Ÿè®¡ åŒæ ·ï¼Œå½“æˆ‘ä»¬éœ€è¦ç»Ÿè®¡ä¸ªæ•°æ—¶ï¼Œä¹Ÿæœ‰å¾ˆå¤šåŠæ³•ï¼Œæ¯”å¦‚ å†…å­˜çº§åˆ« hashsetï¼Œå‡†ç¡®ï¼Œä½†æ˜¯å­˜å‚¨é‡è·Ÿæ•°æ®é‡æˆæ­£æ¯”ï¼ŒåŸå§‹æ•°æ®è¿˜å­˜åœ¨ æ•°æ®åº“ä¹Ÿå¯ä»¥åšï¼Œå‡†ç¡®ä½†æ€§èƒ½è¾ƒå·® å†…å­˜çº§åˆ«ï¼ŒHyperloglogï¼Œåªéœ€å°‘é‡å†…å­˜å³å¯ï¼Œä½†è¯¯å·®è¾ƒå¤§ å¦‚æœæˆ‘ä»¬å•å•åªæ˜¯æŠ€æœ¯ç»Ÿè®¡ï¼Œå¯¹å‡†ç¡®ç‡è¦æ±‚å¹¶ä¸é«˜ï¼Œå¯ä»¥é‡‡å– Hyperloglogï¼Œåªä¸è¿‡æ²¡æœ‰è®°å½•åŸå§‹æ•°æ®ï¼Œä½†è¿™æ°å¥½ä¸ºèŠ‚çœå†…å­˜åŸ‹ä¸‹äº†ä¼ç¬” BloomFilter åŸç† æœ‰ k ä¸ª hash å‡½æ•°ï¼Œå¯¹æ¯ä¸€ä¸ª key è¿›è¡Œ hash å‡½æ•°è®¡ç®—å¤§å°ï¼Œå°† m ä½ 0 å­—ç¬¦ä¸²åœ¨å¯¹åº”çš„å–ä½™èµ‹å€¼ä¸º 1 å³å¯ æ£€æŸ¥æ˜¯å¦å­˜åœ¨ï¼šè®¡ç®— key å¯¹åº”çš„ k ä¸ª hashå€¼åœ¨å­—ç¬¦ä¸²ä¸­çš„ä½æ˜¯å¦å…¨ä¸º 1ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™æœ‰å¯èƒ½å­˜åœ¨ï¼Œå¦åˆ™è‚¯å®šä¸å­˜åœ¨ ä¾‹å­ï¼Œ key = bloom hashcode = [1, 2, 3] 1011100000000000000000 æ¥ä¸‹æ¥ key = filter ç»è¿‡åŒæ ·çš„ hash è®¡ç®— hashcode = [2,4,6] ç»è¿‡è®¡ç®—ä¸å­˜åœ¨ï¼Œåˆ™æ”¾å…¥ 1011101000000000000000 å®é™…åº”ç”¨ä¸­å¦‚ä½•é€‰æ‹© mï¼Œkï¼Œf çš„å¤§å°ï¼Œæœ‰ä¸€ä¸ªæ•°æ®å…¬å¼æ¨å¯¼ï¼Œå¤§å®¶å¯ä»¥è‡ªè¡Œ Google HyperLogLog åŸç† ä½¿ç”¨æ¦‚ç‡çš„åŸç† è¿™ç¯‡æ–‡ç« è¿˜ä¸é”™ https://blog.csdn.net/firenet1/article/details/77247649 æ€»ç»“ä¸€ä¸‹ï¼Œå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬ä¸¢ç¡¬å¸çš„åœºæ™¯ï¼Œç¬¬ä¸€æ¬¡å‡ºç°æ­£é¢ï¼Œä¹‹å‰éƒ½æ˜¯åé¢çš„æ¦‚ç‡ä¸å®éªŒæ¬¡æ•°æœ‰ä¸€ä¸ªå…³ç³» n = 2^kï¼Œé‚£ä¹ˆæˆ‘ä»¬å°† key æ˜ å°„æˆ äºŒè¿›åˆ¶hashcodeï¼Œ0001010, è¯¥è¿‡ç¨‹å®Œå…¨éšæœºï¼Œé‚£ä¹ˆ n å°±ç­‰äº 2^4ï¼Œä¹Ÿå°±æ˜¯è¯´è¯•éªŒæ¬¡æ•°è¾¾åˆ° 8ï¼Œä½†è¯¯å·®è¾ƒå¤§ï¼Œæ‰€ä»¥æˆ‘ä»¬é‡‡ç”¨å¤šä¸ªæ˜ å°„å–å¹³å‡ï¼Œè¿™æ ·è¯¯å·®å°±ä¼šå˜å° ä½†æ˜¯è¿™æ ·çš„è¯¯å·®å¾ˆå¤§ å¤§å®¶å¯ä»¥çœ‹çœ‹ stream-lib é‡Œè¾¹çš„å®ç°ï¼Œå¾ˆç»å…¸ æ¬¢è¿è®¨è®ºï½","categories":[{"name":"Java","slug":"Java","permalink":"https://wzes.github.io/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://wzes.github.io/tags/Java/"}]},{"title":"Geohash&Haversine é™„è¿‘åŠŸèƒ½","slug":"Backend/Geohash&Haversine é™„è¿‘åŠŸèƒ½","date":"2018-09-06T01:13:00.000Z","updated":"2019-09-02T12:20:19.747Z","comments":true,"path":"2018/09/06/Backend/Geohash&Haversine é™„è¿‘åŠŸèƒ½/","link":"","permalink":"https://wzes.github.io/2018/09/06/Backend/Geohash&Haversine é™„è¿‘åŠŸèƒ½/","excerpt":"","text":"å‰è¨€ æœ€è¿‘å¶ç„¶é—´çœ‹åˆ°äº† Geohash ç®—æ³•ï¼Œæ‰æƒ³èµ·æ¥ä¹‹å‰è‡ªå·±åšè¿‡çš„é™„è¿‘çš„åŠŸèƒ½ç®€ç›´ä¸å ªä¸€å‡»ï¼Œç«Ÿç„¶æ˜¯è®¡ç®—æ‰€æœ‰ä¸ç›®æ ‡ç‚¹çš„è·ç¦»ï¼Œå†æ’åºã€‚æƒ³å¿…æœ‰ç»éªŒçš„äººæ—©å°±ç¬‘å‡ºå£°äº†å§ï¼ŒæŒ‰ç…§ä»¥å‰çš„æ°´å¹³ï¼Œå¦‚æœä¸è¿™æ ·åšï¼Œé‚£ä¹Ÿå¾—æ‰¾å‡ºæ¯”è¾ƒç›¸è¿‘çš„ï¼Œå…ˆä¸è®¡ç®—çƒé¢è·ç¦»ï¼Œç„¶åå¾—åˆ°ä¸€ä¸ªå°ä¸€ç‚¹çš„é›†åˆï¼Œå†è®¡ç®—è·ç¦»ï¼Œè¿™æ ·è®¡ç®—é‡å¤§å¤§å‡å°ï¼Œç„¶è€Œè¿˜æ˜¯è¦æ‰«ææ‰€æœ‰ç‚¹ï¼Œé‚£æœ‰æ²¡æœ‰åŠæ³•ä¸æ‰«ææ•´å¼ è¡¨å°±èƒ½å¾—åˆ°é™„è¿‘ç‚¹çš„ä¿¡æ¯ï¼Œæƒ³åˆ°è¿™ï¼Œæˆ‘ä»¬è€Œå·²ç»™æ‰€æœ‰ç‚¹é¢„å…ˆåšä¸€ä¸ªæ ‡ç­¾ï¼Œæˆ‘ä»¬æ¯ä¸€æ¬¡æƒ³æ‰¾é™„è¿‘çš„ç‚¹å°±å»æ¯”è¾ƒè¿™äº›æ ‡ç­¾ï¼Œå¦‚æœæˆ‘ä»¬èƒ½å¤Ÿä¿è¯ï¼Œè·ç¦»ç›¸è¿‘çš„ç‚¹åœ¨ä¸€ä¸ªæ ‡ç­¾å†…ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥åªå–è¯¥æ ‡ç­¾çš„ç‚¹ï¼Œç„¶åå†åšè·ç¦»è®¡ç®—ï¼Œè¿™æ ·å°±ä¸ç”¨æ‰«ææ•´å¼ è¡¨äº†ï¼Œé—®é¢˜åˆ°è¿™ï¼ŒåŸºæœ¬å·²ç»æµ®å‡ºæ°´é¢ï¼Œæ¥ä¸‹æ¥å°±æ˜¯æœ€æ ¸å¿ƒçš„é—®é¢˜ï¼Œå¦‚ä½•å°†ç‚¹çš„ä¿¡æ¯æ˜ å°„æˆæ ‡ç­¾ï¼Œè¿™ä¾¿æ˜¯ Geohash https://en.wikipedia.org/wiki/Geohash wiki ä¸Šæœ‰æ‰€è§£é‡Šï¼Œä½†ä¸æ˜¯é‚£ä¹ˆæ˜“æ‡‚ï¼Œå¯ä»¥çœ‹çœ‹è¿™ä½ä»å…„çš„åšå®¢ï¼ŒGeoHashæ ¸å¿ƒåŸç†è§£æ è®²è§£æ¸…æ™°æ˜“æ‡‚ ç›¸ä¼¼åº¦ Geohash å°†ç»çº¬åº¦æ˜ å°„æˆä¸€æ®µå­—ç¬¦ä¸²ï¼Œè¶Šæ˜¯ç›¸è¿‘çš„ç‚¹ï¼Œå‰ç¼€åŒ¹é…å°±è¶Šé•¿ï¼Œæ¯ä¸€ä½éƒ½ä¼šæœ‰ä¸€ä¸ªç²¾åº¦é—®é¢˜ï¼ŒåŒ¹é…çš„è¶Šé•¿è·ç¦»å°±è¶Šè¿‘ï¼Œå½“ç„¶ä¹Ÿå­˜åœ¨è¯¯å·® åˆ©ç”¨è¿™ä¸ªæ¥åšé™„è¿‘çš„ç‚¹é€‰å–å†åˆé€‚ä¸è¿‡äº†ã€‚ Haversine è®¡ç®—çƒé¢è·ç¦» ä¼ ç»Ÿçš„è®¡ç®—çƒé¢è·ç¦»å…¬å¼è®¡ç®—é‡å¤§ï¼Œå½“æˆ‘ä»¬æ²¡æœ‰è¦æ±‚å¾ˆé«˜çš„ç²¾åº¦çš„æ—¶å€™ï¼Œå¯ä»¥é€‚å½“é€šè¿‡åˆ«çš„æ›´ç®€å•çš„è®¡ç®—å…¬å¼å¾—åˆ°è¿‘ä¼¼çš„ç»“æœï¼Œè¿™ä¾¿æ˜¯ Haversine å‘æŒ¥çš„ä½œç”¨","categories":[{"name":"Java","slug":"Java","permalink":"https://wzes.github.io/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://wzes.github.io/tags/Java/"}]},{"title":"Android Rxjava æºç è§£æ","slug":"Android/Android Rxjava","date":"2018-09-04T16:15:16.000Z","updated":"2019-09-02T12:17:44.173Z","comments":true,"path":"2018/09/05/Android/Android Rxjava/","link":"","permalink":"https://wzes.github.io/2018/09/05/Android/Android Rxjava/","excerpt":"","text":"å‰è¨€ RxJava è¿™ä¸ªåå­—ï¼Œæƒ³å¿…åšè¿‡ Android çš„äººéƒ½æœ‰æ‰€äº†è§£ï¼Œç®€å•çš„ä½¿ç”¨å‡ ä¹ä¸æˆé—®é¢˜ï¼Œä½†é‡Œé¢çš„çŸ¥è¯†ç‚¹å´ä¸€å‘ä»¤äººæœ›è€Œç”Ÿç•ï¼Œæ¥ä¸‹æ¥å‡ æ—¥æˆ‘ä¾¿æƒ³æ…¢æ…¢è§£å¼€è¿™å±‚é¢çº± å…ˆæ¥å›å½’ä¸€ä¸‹ç®€å•çš„ä¾‹å­ æ²¡æœ‰çº¿ç¨‹åˆ‡æ¢çš„æœ€ç®€å•çš„ç‰ˆæœ¬ï¼Œåˆå­¦è€…ä¸€å®šå¾ˆå›°æƒ‘ï¼Œè¿™æ®µä»£ç æ˜¯æ€ä¹ˆè¿è¡Œèµ·æ¥çš„ï¼Œè¿™æ®µä»£ç ä¸­æœ€å…·æ ¸å¿ƒçš„æ˜¯ Observableï¼ŒObservable æœ‰ä¸€ä¸ªæ–¹æ³•æ˜¯ subcribeï¼Œå½“è°ƒç”¨è¿™ä¸ªæ–¹æ³•æ—¶ä¾¿è°ƒç”¨äº† ObservableOnSubscribe.subscibe æ–¹æ³•ï¼Œé‡Œé¢è°ƒç”¨äº† e.onNext()ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨äº† Obersver çš„ onNext æ–¹æ³•ï¼Œæ•´ä¸ªçš„æµç¨‹ä¾¿æ˜¯è¿™æ ·ï¼Œå›´ç»•è¿™ä¸ªæµç¨‹ï¼Œä¾¿è¡ç”Ÿå‡ºäº†çº¿ç¨‹åˆ‡æ¢ï¼Œå„ç§ç±»å‹çš„ä»»åŠ¡ï¼ŒèƒŒå‹ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ 1234567891011121314151617181920212223242526Observable.create(new ObservableOnSubscribe&lt;String&gt;() &#123; @Override public void subscribe(@NonNull ObservableEmitter&lt;String&gt; e) throws Exception &#123; e.onNext(&quot;hello&quot;); e.onNext(&quot;world&quot;); e.onComplete(); &#125;&#125;).subscribe(new Observer&lt;String&gt;() &#123; @Override public void onSubscribe(Disposable d) &#123; &#125; @Override public void onNext(String o) &#123; System.out.println(o.toString()); &#125; @Override public void onError(Throwable e) &#123; &#125; @Override public void onComplete() &#123; &#125;&#125;); map ä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œä¸¾ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œå®é™…çš„Rajava ä¸ä¹‹ç±»ä¼¼ æ˜ å°„ï¼Œå°†ä¸€ä¸ª Observable è½¬åŒ–æˆå¦ä¸€ä¸ª Observable çš„è¿‡ç¨‹ï¼Œä¸»è¦æ˜¯ onNext çš„è°ƒç”¨é“¾çš„å…³ç³»ï¼Œå®é™…æƒ³èµ·æ¥è¿˜æ˜¯æŒºå¤æ‚çš„ï¼Œä¸€ä¸ªé€’å½’çš„ç»“æ„ï¼Œæ¯ä¸€ä¸ª map æ“ä½œéƒ½ä¼šå°è£…ä¸€ä¸ª Observable è€Œä»–çš„å‚æ•°æ˜¯ MapSubscribe çš„å‘å°„å™¨ï¼Œé‡Œé¢åœ¨è°ƒç”¨ onNext æ—¶ç©¿è¿›å»çš„å‚æ•°æ˜¯ transformer.call çš„ç»“æœï¼Œè¿™å°±è¯´æ˜äº†å¦‚æœæœ‰ map å­˜åœ¨ï¼Œé¦–å…ˆä¼šé€’å½’åˆ°å¼€å§‹ï¼Œç„¶åè°ƒç”¨ç¦»ä¹‹æœ€è¿‘çš„ mapSubcriber çš„ call å‡½æ•°ï¼Œè·å–ç»“æœï¼Œå¹¶è°ƒç”¨ä¸‹ä¸€ä¸ªå‘å°„å™¨çš„onNextå‡½æ•°ï¼ŒçŸ¥é“è°ƒç”¨æœ€é¡¶å±‚çš„Subcriberçš„å›è°ƒå‡½æ•°ï¼Œè¯¥è¿‡ç¨‹è¿˜æ˜¯å¾ˆæœ‰æ„æ€çš„ 12345678910111213141516171819202122232425262728293031323334353637383940Observable.create(new Observable.OnSubscribe&lt;Integer&gt;() &#123; @Override public void call(Subscriber&lt;? super Integer&gt; subscriber) &#123; subscriber.onNext(10); &#125; &#125;).map(new Observable.Transformer&lt;Integer, String&gt;() &#123; @Override public String call(Integer from) &#123; return String.valueOf(from); &#125; &#125;).map(new Observable.Transformer&lt;String, String&gt;() &#123; @Override public String call(String from) &#123; return String.valueOf(from + 10); &#125; &#125;).map(new Observable.Transformer&lt;String, String&gt;() &#123; @Override public String call(String from) &#123; return String.valueOf(from + 10); &#125; &#125;).subscribeOn(Schedulers.io()).subscribe(new Subscriber&lt;String&gt;() &#123; @Override public void onStart() &#123; System.out.println(&quot;onStart called&quot;+ &quot; &quot; + Thread.currentThread()); &#125; @Override public void onCompleted() &#123; System.out.println(&quot;onComplete called&quot;+ &quot; &quot; + Thread.currentThread()); &#125; @Override public void onNext(String object) &#123; System.out.println(object + &quot; &quot; + Thread.currentThread()); &#125; @Override public void onError(Throwable t) &#123; &#125; &#125;);","categories":[{"name":"Android","slug":"Android","permalink":"https://wzes.github.io/categories/Android/"},{"name":"Java","slug":"Android/Java","permalink":"https://wzes.github.io/categories/Android/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://wzes.github.io/tags/Java/"},{"name":"Android","slug":"Android","permalink":"https://wzes.github.io/tags/Android/"}]},{"title":"Effective Java2 è¯»ä¹¦ç¬”è®°78æ¡","slug":"Book Notes/Effective-Java-2-è¯»ä¹¦ç¬”è®°-78æ¡","date":"2018-08-30T14:18:00.000Z","updated":"2019-09-02T12:21:59.163Z","comments":true,"path":"2018/08/30/Book Notes/Effective-Java-2-è¯»ä¹¦ç¬”è®°-78æ¡/","link":"","permalink":"https://wzes.github.io/2018/08/30/Book Notes/Effective-Java-2-è¯»ä¹¦ç¬”è®°-78æ¡/","excerpt":"","text":"ç¬¬ä¸€æ¡ è€ƒè™‘ä½¿ç”¨é™æ€å·¥å‚æ–¹æ³•ä»£æ›¿æ„é€ å™¨ ä¼˜åŠ¿ æœ‰åç§° ä¸å¿…æ¯æ¬¡è°ƒç”¨çš„æ—¶å€™éƒ½åˆ›å»ºä¸€ä¸ªå¯¹è±¡ è¿”å›åŸè¿”å›ç±»å‹çš„æ‰€æœ‰å­ç±»å‹çš„å¯¹è±¡ åœ¨åˆ›å»ºå‚æ•°å®ä¾‹åŒ–çš„æ—¶å€™ï¼Œä»–ä»¬ä½¿ä»£ç å˜å¾—æ›´ç®€æ´ ç¼ºç‚¹ ç±»å¦‚æœä¸å«æœ‰å…±æœ‰çš„æˆ–è€…å—ä¿æŠ¤çš„ç±»æ„é€ å™¨ï¼Œå°±ä¸èƒ½è¢«å­ç±»åŒ– ä»–ä»¬ä¸å…¶ä»–çš„é™æ€æ–¹æ³•æ²¡ä»€ä¹ˆåŒºåˆ« ç¬¬äºŒæ¡ é‡åˆ°å¤šä¸ªæ„é€ å™¨æ—¶è¦è€ƒè™‘ç”¨æ„å»ºå™¨ æ„é€ å™¨å‚æ•°å¤šï¼Œä¸ªæ•°å¤šï¼Œåˆ™ä¼˜å…ˆä½¿ç”¨ Builder æ¨¡å¼ï¼Œæ„å»ºå™¨æ¯”JavaBeansæ›´åŠ å®‰å…¨ 123public interface Builder&lt;T&gt; &#123; public T build();&#125; ç¬¬ä¸‰æ¡ ç”¨ç§æœ‰æ„é€ å™¨ç«é¹¤æšä¸¾ç±»å‹å¼ºåŒ–singletonå±æ€§ å•å…ƒç´ çš„æšä¸¾ç±»å‹å·²ç»æˆä¸ºå®ç°Singletonçš„æœ€ä½³æ–¹æ³• 1234public enum Elvis &#123; INSTANCE; public void leaveTheBuilding() &#123;&#125;&#125; ç¬¬å››æ¡ é€šè¿‡ç§æœ‰æ„é€ å™¨å¼ºåŒ–ä¸å¯å®ä¾‹åŒ–çš„èƒ½åŠ› è¶…ç±»ä¹Ÿä¸èƒ½è¢«å®ä¾‹åŒ– 12345public class UtilityClass &#123; private UtilityClass() &#123; throw new AssertionError(); &#125;&#125; ç¬¬äº”æ¡ é¿å…åˆ›å»ºä¸å¿…è¦çš„å¯¹è±¡ é¿å…é‡å¤åˆ›å»ºç›¸åŒçš„å¯¹è±¡ ä¼˜å…ˆä½¿ç”¨åŸºæœ¬ç±»å‹è€Œä¸æ˜¯è£…ç®±åŸºæœ¬ç±»å‹ ä¸è¦ç›²ç›®è§‰å¾—åˆ›å»ºå¯¹è±¡ä»£ä»·ååˆ†æ˜‚è´µï¼Œä½¿ç”¨å¯¹è±¡æ± çš„ç‰¹ä¾‹ï¼šæ•°æ®åº“è¿æ¥æ± ï¼Œå¦åˆ™æ²¡å¿…è¦åˆ›å»ºå¯¹è±¡æ± ï¼Œä¼šå½±å“GC ç¬¬å…­æ¡ æ¶ˆé™¤è¿‡æœŸçš„å¯¹è±¡å¼•ç”¨ å¸¸è§çš„åœºæ™¯åœ¨ä¸ArrayListï¼Œåˆ é™¤å¯¹è±¡åéœ€è¦æŠŠè¯¥ç´¢å¼•ä½ç½®ç½®ç©ºã€‚ ç›‘å¬å™¨ï¼Œå…¶ä»–å›è°ƒ å¯ä½¿ç”¨ WeakHashMap å°†é”®ä¿æŒä¸ºå¼±å¼•ç”¨ ç¬¬ä¸ƒæ¡ é¿å…ä½¿ç”¨ç»ˆç»“æ–¹æ³• ç»ˆç»“æ–¹æ³•é€šå¸¸æ˜¯ä¸å¯é¢„æµ‹çš„ï¼Œä¹Ÿæ˜¯å¾ˆå±é™©çš„å—ï¼Œä¸€èˆ¬æƒ…å†µä¸‹æ˜¯ä¸å¿…è¦çš„ã€‚ä½¿ç”¨ç»ˆç»“æ–¹æ³•æ˜¯å¾ˆå±é™©çš„ã€‚ ç»ˆç»“æ–¹æ³•çº¿ç¨‹çš„ä¼˜å…ˆçº§æ¯”åº”ç”¨ç¨‹åºçº¿ç¨‹çš„ä¼˜å…ˆçº§ä½å¾ˆå¤š 1234// ä¸ä¿è¯ finalize æ‰§è¡ŒSystem.gc System.runFinaliaation// ä¿è¯æ‰§è¡ŒSystem.runFinalizersOnExit Runtime.runFinalizersOnExit ç¬¬å…«æ¡ è¦†ç›– equals æ—¶è¯·éµå®ˆé€šç”¨çº¦å®š ç±»æ˜¯ç§æœ‰çš„æˆ–æ˜¯åŒ…çº§ç§æœ‰çš„ï¼Œå¯ä»¥ç¡®å®šå®ƒçš„ equals æ–¹æ³•æ°¸è¿œä¸ä¼šè¢«è°ƒç”¨ã€‚ é˜²æ­¢æ–¹æ³•è¢«è°ƒç”¨çš„æ–¹æ³• 1234@Ovveridepublic boolean equals(Object o) &#123; throw new AssertionError();&#125; equals æ–¹æ³•å®ç°äº†ç­‰ä»·å…³ç³» è‡ªåæ€§ å¯¹ç§°æ€§ ä¼ é€’æ€§ ä¸€è‡´æ€§ ä¸€èˆ¬åšæ³• 123456789101112@Overridepublic boolean equals(Object o) &#123; if (o == this) &#123; return true; &#125; if (!(o instanceOf MyClass)) &#123; return false; &#125; MyClass class = (MyClass) o; // æ¯”è¾ƒå„ä¸ªåŸŸå€¼ ......&#125; ç¬¬ä¹æ¡ è¦†ç›– equals æ—¶æ€»è¦è¦†ç›– hashCode Object è§„èŒƒï¼ˆJavaSE6ï¼‰ åŒä¸€ä¸ªå¯¹è±¡å¤šæ¬¡è°ƒç”¨å¿…é¡»ä¸€è‡´ï¼ŒåŒä¸€ä¸ªç¨‹åºå¤šæ¬¡æ‰§è¡Œå¯ä»¥ä¸ä¸€è‡´ equals ç›¸ç­‰ï¼ŒhashCode å¿…ç„¶è¦ç›¸ç­‰ hashCode ç›¸åŒï¼Œequals ä¸ä¸€å®šç›¸åŒ ä¸€ä¸ªå¥½çš„æ•£åˆ—å‡½æ•°é€šå¸¸å€¾å‘äºâ€œä¸ºä¸åŒçš„å¯¹è±¡äº§ç”Ÿä¸ç›¸ç­‰çš„æ•£åˆ—ç â€ å¦‚ä½•è®¡ç®—ï¼š æŠŠæŸä¸ªéé›¶å¸¸ç†Ÿå€¼ï¼Œæ¯”å¦‚è¯´17ï¼Œä¿å­˜åˆ°ä¸€ä¸ªåä¸º result çš„ int ç±»å‹çš„å˜é‡ä¸­ã€‚ å¯¹äºå¯¹è±¡ä¸­æ¯ä¸ªå…³é”®åŸŸ f ï¼ˆæŒ‡ equals æ–¹æ³•ä¸­æ¶‰åŠåˆ°çš„æ¯ä¸ªåŸŸï¼‰ï¼Œå®Œæˆä»¥ä¸‹æ­¥éª¤ï¼š a. ä¸ºè¯¥åŸŸè®¡ç®— int ç±»å‹çš„æ•£åˆ—ç  c ï¼š å¦‚æœè¯¥åŸŸæ˜¯ boolean ç±»å‹ï¼Œåˆ™è®¡ç®— ï¼ˆf ? 1 : 0ï¼‰ å¦‚æœè¯¥åŸŸæ˜¯ byte ï¼Œcharï¼Œshortï¼Œintï¼Œåˆ™è®¡ç®— ï¼ˆintï¼‰f å¦‚æœè¯¥åŸŸæ˜¯ longï¼Œåˆ™è®¡ç®—ï¼ˆintï¼‰ï¼ˆf ^ ï¼ˆf &gt;&gt; 32ï¼‰ï¼‰ å¦‚æœè¯¥åŸŸæ˜¯ floatï¼Œåˆ™è®¡ç®— Float.floatToIntBits(f); å¦‚æœè¯¥åŸŸæ˜¯ doubleï¼Œåˆ™è®¡ç®— Double.doubleToLongBits(f), ç„¶åæŒ‰ç…§æ­¥éª¤ a.3ï¼Œè®¡ç®— long çš„æ•£åˆ—å€¼ å¦‚æœè¯¥åŸŸæ˜¯ä¸€ä¸ªå¯¹è±¡å¼•ç”¨ï¼Œå¹¶ä¸”è¯¥ç±»çš„ equals æ–¹æ³•é€šè¿‡é€’å½’çš„è°ƒç”¨ equals çš„æ–¹å¼æ¥æ¯”è¾ƒè¿™ä¸ªåŸŸï¼Œåˆ™åŒæ ·ä¸ºè¿™ä¸ªåŸŸé€’å½’çš„è°ƒç”¨ hashCodeã€‚å¦‚æœè¿™ä¸ªåŸŸä¸º nullï¼Œ åˆ™ä¸º 0 å¦‚æœè¯¥åŸŸæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œåˆ™éœ€è¦æŠŠæ¯ä¸€ä¸ªå…ƒç´ å½“ä½œå•ç‹¬çš„åŸŸæ¥å¤„ç†ã€‚ b. æŒ‰ç…§ä¸‹é¢çš„å…¬å¼ï¼ŒæŠŠæ­¥éª¤2.a ä¸­è®¡ç®—å¾—åˆ°çš„æ•£åˆ—ç  c åˆå¹¶åˆ° result ä¸­ï¼š result = 31 * result + cï¼› 3. è¿”å› result 4. check ç¬¬åæ¡ å§‹ç»ˆè¦è¦†ç›– toString å»ºè®®æ‰€æœ‰çš„å­ç±»éƒ½åº”è¯¥è¦†ç›–è¿™ä¸ªæ–¹æ³• ç¬¬åä¸€æ¡ è°¨æ…çš„è¦†ç›– clone åˆ›å»ºå’Œè¿”å›è¯¥å¯¹è±¡çš„ä¸€ä¸ªæ‹·è´ï¼Œä¸å¿…è°ƒç”¨æ„é€ å™¨åˆ›å»ºå¯¹è±¡ JavaSE6 çš„çº¦å®šå†…å®¹ï¼š x.clone() != x ä¸º true x.clone().getClass() == x.getClass() ä¸º true x.clone().equals(x) ä¸º true ä¸€èˆ¬å†™æ³•ï¼Œé€šè¿‡é€’å½’ super.clone() åˆ›å»ºå¯¹è±¡ï¼Œå†å°†åŸŸé€ä¸ªå¤åˆ¶å³å¯ ç¬¬åäºŒæ¡ è€ƒè™‘å®ç° Comparable æ¥å£ å®ç°äº† Comparable æ¥å£ï¼Œå°±è¡¨æ˜å®ƒçš„å®ä¾‹å…·æœ‰å†…åœ¨çš„æ’åºå…³ç³»ã€‚ å½“ç„¶ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å¤–åœ¨æ’åº Comparator ç¬¬åä¸‰æ¡ ä½¿ç±»å’Œæˆå‘˜çš„å¯è®¿é—®æ€§æœ€å°åŒ– è®¾è®¡è‰¯å¥½çš„æ¨¡å—ä¼šéšè—æ‰€æœ‰çš„å®ç°ç»†èŠ‚ï¼ŒæŠŠå®ƒçš„APIä¸å®ƒçš„å®ç°æ¸…æ™°çš„éš”ç¦»å¼€æ¥ã€‚ å°½å¯èƒ½åœ°ä½¿æ¯ä¸ªç±»æˆ–æˆå‘˜ä¸è¢«å¤–ç•Œè®¿é—® æœ‰å››ç§è®¿é—®æ€§ï¼š ç§æœ‰çš„ï¼ˆprivateï¼‰ åŒ…çº§ç§æœ‰çš„ï¼ˆdefaultï¼‰ å—ä¿æŠ¤çš„ï¼ˆprotectedï¼‰ å…±æœ‰çš„ï¼ˆpublicï¼‰ å®ä¾‹åŸŸä¸èƒ½æ˜¯å…±æœ‰çš„ ç¬¬åå››æ¡ åœ¨å…±æœ‰ç±»ä¸­ä½¿ç”¨è®¿é—®æ–¹æ³•è€Œéå…±æœ‰åŸŸ æœ‰æ—¶å€™ï¼Œå¯èƒ½ä¼šç¼–å†™ä¸€äº›é€€åŒ–ç±»ï¼Œæ²¡æœ‰ä»€ä¹ˆä½œç”¨ï¼Œåªæ˜¯ç”¨æ¥é›†ä¸­å®ä¾‹åŸŸ Javaå¹³å°ç±»åº“ä¸­æœ‰ä¸€äº›è¿åäº†ï¼Œä½†åº”è¯¥è­¦æƒ• å…±æœ‰ç±»æ°¸è¿œä¸åº”è¯¥æš´éœ²å¯å˜çš„åŸŸ ç¬¬åäº”æ¡ ä½¿å¯å˜æ€§æœ€å°åŒ– ä¸å¯å˜ç±»åªæ˜¯å…¶å®ä¾‹ä¸èƒ½è¢«ä¿®æ”¹çš„ç±»ã€‚æ¯ä¸ªå®ä¾‹ä¸­åŒ…å«çš„æ‰€æœ‰ä¿¡æ¯éƒ½å¿…é¡»åœ¨åˆ›å»ºè¯¥å®ä¾‹çš„æ—¶å€™å°±æä¾›ï¼Œå¹¶åœ¨å¯¹è±¡çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸå†…å›ºå®šä¸å˜ï¼ŒJava å¹³å°ç±»åº“ä¸­åŒ…å«äº†è®¸å¤šä¸å¯å˜ç±»ï¼Œæ¯”å¦‚ Stringï¼ŒåŸºæœ¬ç±»å‹åŒ…è£…ç±»ï¼ŒBigDecimal å’Œ BigIntegerã€‚å­˜åœ¨ä¸å¯å˜çš„ç±»æœ‰å¾ˆå¤šç†ç”±ï¼šä¸å¯å˜çš„ç±»æ¯”å¯å˜çš„ç±»æ›´åŠ å®¹æ˜“è®¾è®¡ï¼Œå®ç°å’Œä½¿ç”¨ã€‚ åŸåˆ™ ä¸è¦æä¾›ä»»ä½•ä¼šä¿®æ”¹å¯¹è±¡çŠ¶æ€çš„æ–¹æ³• ä¿è¯ç±»ä¸ä¼šè¢«æ‰©å±• ä½¿æ‰€æœ‰çš„åŸŸéƒ½æ˜¯ final çš„ ä½¿æ‰€æœ‰çš„åŸŸéƒ½æ˜¯ç§æœ‰çš„ ç¡®ä¿å¯¹äºä»»ä½•å¯å˜ç»„ä»¶çš„äº’æ–¥è®¿é—® ç¬¬åå…­æ¡ å¤åˆä¼˜å…ˆäºç»§æ‰¿ ç»§æ‰¿è™½ç„¶æ˜¯å®ç°ä»£ç é‡ç”¨çš„æœ‰åŠ›æ‰‹æ®µï¼Œä½†å®ƒä¼šæ‰“ç ´å°è£…æ€§ã€‚è€Œå¤åˆå¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œåªæœ‰å½“å­ç±»æ˜¯è¶…ç±»çš„å­ç±»å‹æ—¶ï¼Œæ‰é€‚ç”¨ç»§æ‰¿ï¼ˆis-aå…³ç³»ï¼‰ã€‚Java å¹³å°ç±»åº“ä¸­ Stackå’ŒVectorï¼ŒPropertieså’ŒHashtable è¿åäº†è¿™ä¸ªåŸåˆ™ ç¬¬åä¸ƒæ¡ è¦ä¹ˆä¸ºç»§æ‰¿è€Œè®¾è®¡ï¼Œå¹¶æä¾›æ–‡æ¡£è¯´æ˜ï¼Œè¦ä¹ˆå°±ç¦æ­¢ç»§æ‰¿ å¯¹äºä¸“é—¨ä¸ºäº†ç»§æ‰¿è€Œè®¾è®¡çš„ç±»éœ€è¦å…·æœ‰è‰¯å¥½æ–‡æ¡£è¯´æ˜ï¼Œè¯¥æ–‡æ¡£å¿…é¡»ç²¾ç¡®çš„æè¿°è¦†ç›–æ¯ä¸ªæ–¹æ³•æ‰€å¸¦æ¥çš„å½±å“ æ„é€ å™¨ç»ä¸èƒ½è°ƒç”¨å¯è¢«è¦†ç›–çš„æ–¹æ³• ç¬¬åå…«æ¡ æ¥å£ä¼˜äºæŠ½è±¡ç±» Java ç¨‹åºè®¾è®¡è¯­è¨€æä¾›äº†ä¸¤ç§æœºåˆ¶ï¼Œå¯ä»¥ç”¨æ¥å®šä¹‰å…è®¸å¤šä¸ªå®ç°çš„ç±»å‹ï¼šæ¥å£å’ŒæŠ½è±¡ ç°æœ‰çš„ç±»å¾ˆå®¹æ˜“è¢«æ›´æ–°ï¼Œä»¥å®ç°æ–°çš„å€Ÿå£ æ¥å£æ˜¯å®šä¹‰mixinï¼ˆæ··åˆç±»å‹ï¼‰çš„ç†æƒ³é€‰æ‹© æ¥å£å…è®¸æˆ‘ä»¬æ„é€ éå±‚æ¬¡ç»“æ„çš„ç±»å‹æ¡†æ¶ ç¬¬åä¹æ¡ æ¥å£åªç”¨äºå®šä¹‰ç±»å‹ æ¥å£åº”è¯¥åªè¢«ç”¨æ¥å®šä¹‰ç±»å‹ï¼Œä¸åº”è¯¥è¢«ç”¨æ¥å¯¼å‡ºå¸¸é‡ å¯¼å‡ºå¸¸é‡çš„åšæ³•ï¼š 12345public class PhysicalConstants &#123; // ç§æœ‰ private PhysicalConstants() &#123;&#125; public static final double AVOGADROS_NUMBER = 6.02214199e23;&#125; ç¬¬äºŒåæ¡ ç±»å±‚æ¬¡ä¼˜å…ˆäºæ ‡ç­¾ç±» æ ‡ç­¾ç±»ä½¿å¾—ç±»å˜å¾—å¤æ‚éš¾æ‡‚ï¼Œè€ƒè™‘ä½¿ç”¨ç±»å±‚æ¬¡æ›¿æ¢ åŸŸæ˜¯ä¸èƒ½åšæˆ final çš„ ç¬¬äºŒåä¸€æ¡ ç”¨å‡½æ•°å¯¹è±¡è¡¨ç¤ºç­–ç•¥ ç®€è€Œè¨€ä¹‹ï¼Œå‡½æ•°æŒ‡é’ˆçš„ä¸»è¦ç”¨é€”å°±æ˜¯å®ç°ç­–ç•¥æ¨¡å¼ã€‚ä¸ºäº†åœ¨ Java ä¸­å®ç°è¿™ç§æ¨¡å¼ï¼Œè¦å£°æ˜ä¸€ä¸ªæ¥å£æ¥è¡¨ç¤ºè¯¥ç­–ç•¥ï¼Œå¹¶ä¸”ä¸ºæ¯ä¸ªå…·ä½“çš„ç­–ç•¥å£°æ˜å®ç°ä¸€ä¸ªè¯¥æ¥å£çš„ç±»ã€‚å½“ä¸€ä¸ªå…·ä½“ç­–ç•¥åªè¢«ä½¿ç”¨ä¸€æ¬¡çš„æ—¶å€™ï¼Œé€šå¸¸ä½¿ç”¨åŒ¿åç±»çš„æ–¹å¼å’Œå®ä¾‹åŒ–è¿™ä¸ªå…·ä½“ç­–ç•¥ç±»ã€‚å½“ä¸€ä¸ªå…·ä½“ç­–ç•¥æ˜¯è®¾è®¡ç”¨æ¥é‡å¤ä½¿ç”¨çš„æ—¶å€™ï¼Œä»–çš„ç±»é€šå¸¸å°±è¦å®ç°ä¸ºç§æœ‰çš„é™æ€æˆå‘˜ç±»ï¼Œå¹¶é€šè¿‡å…±æœ‰çš„é™æ€finalåŸŸè¢«å¯¼å‡ºï¼Œå…¶ç±»å‹ä¸ºè¯¥ç­–ç•¥æ¥å£ã€‚ ç¬¬äºŒåäºŒæ¡ ä¼˜å…ˆè€ƒè™‘é™æ€æˆå‘˜ç±» åµŒå¥—ç±»è¢«å®šä¹‰ä¸ºåœ¨å¦å¤–ä¸€ä¸ªç±»çš„å†…éƒ¨çš„ç±»ï¼Œæœ‰å››ç§ï¼šé™æ€æˆå‘˜ç±»ï¼Œéé™æ€æˆå‘˜ç±»ï¼ŒåŒ¿åç±»ï¼Œå±€éƒ¨ç±»ï¼Œåä¸‰è€…ä¸ºå†…éƒ¨ç±»ï¼› ç¬¬äºŒåä¸‰æ¡ è¯·ä¸è¦åœ¨æ–°ä»£ç ä¸­ä½¿ç”¨åŸç”Ÿæ€ç±»å‹ ä¾‹å¦‚ï¼ŒList åŸç”Ÿæ€ç±»å‹ä¸èƒ½å†ç¼–è¯‘å™¨å‘ç°ç±»å‹è½¬åŒ–é”™è¯¯ï¼Œè€Œä½¿ç”¨èŒƒå‹åˆ™å¯ä»¥ï¼Œæ›´åŠ å®‰å…¨ ç¬¬äºŒåå››æ¡ æ¶ˆé™¤éå—æ£€è­¦å‘Š ç¬¬äºŒåäº”æ¡ åˆ—è¡¨ä¼˜å…ˆäºæ•°ç»„ ç¬¬äºŒåå…­æ¡ ä¼˜å…ˆè€ƒè™‘èŒƒå‹ ä¸èƒ½åˆ›å»ºèŒƒå‹æ•°ç»„ ç¬¬äºŒåä¸ƒæ¡ ä¼˜å…ˆè€ƒè™‘èŒƒå‹æ–¹æ³• 12345678910public static &lt;T entends Comparable&lt;T&gt;&gt; T max(List&lt;T&gt; list) &#123; Iterator&lt;T&gt; i = list.iterator(); T result = i.next(); while (i.hasNext()) &#123; T t = i.next(); if (t.compareTo(result) &gt; 0) &#123; result = t&apos; &#125; &#125;&#125; ç¬¬äºŒåå…«æ¡ åˆ©ç”¨æœ‰é™é€šé…ç¬¦æ¥æå‡APIçš„çµæ´»æ€§ ç¬¬äºŒåä¹æ¡ ä¼˜å…ˆè€ƒè™‘ç±»å‹å®‰å…¨çš„å¼‚æ„å®¹å™¨ ç¬¬ä¸‰åæ¡ ç”¨ enum ä»£æ›¿ int ç¬¬ä¸‰åä¸€æ¡ ç”¨å®ä¾‹åŸŸä»£æ›¿åºæ•° ç¬¬ä¸‰åäºŒæ¡ ç”¨ EnumSet ä»£æ›¿ä½åŸŸ ç¬¬ä¸‰åä¸‰æ¡ ç”¨EnumMap ä»£æ›¿åºæ•°ç´¢å¼• ç¬¬ä¸‰åå››æ¡ ç”¨æ¥å£æ¨¡æ‹Ÿå¯ä¼¸ç¼©çš„æšä¸¾ è™½ç„¶æ— æ³•ç¼–å†™å¯æ‰©å±•çš„æšä¸¾ç±»å‹ï¼Œå´å¯ä»¥é€šè¿‡ç¼–å†™æ¥å£ä»¥åŠå®ç°è¯¥æ¥å£çš„åŸºç¡€æšä¸¾ç±»å‹ï¼Œå¯¹å®ƒè¿›è¡Œæ¨¡æ‹Ÿã€‚ 123456789101112public interface Operation &#123; double apply(double x, double y);&#125;public enum BasicOperation implements Operation &#123; PLUS(&quot;+&quot;) &#123; public double apply(double x, double y) &#123; return x + y; &#125; &#125; private final String symbol; BasicOperation(String symbol) &#123; this.symbol = symbol; &#125;&#125; ç¬¬ä¸‰åäº”æ¡ æ³¨è§£ä¼˜å…ˆäºå‘½åæ¨¡å¼ å‘½åæ¨¡å¼æŒ‡çš„æ˜¯ï¼šç»™ä¸€äº›ç±»æˆ–è€…æ–¹æ³•ä½¿ç”¨æœ‰ç‰¹å®šçº¦æŸçš„åå­— ç¬¬ä¸‰åå…­æ¡ åšæŒä½¿ç”¨ Override æ³¨è§£ åšæŒä½¿ç”¨ Override æ³¨è§£èƒ½å¤Ÿé¿å…ä¸€äº›é”™è¯¯ ç¬¬ä¸‰åä¸ƒæ¡ ç”¨æ ‡è®°æ¥å£å®šä¹‰ç±»å‹ æ ‡è®°æ¥å£æ˜¯æ²¡æœ‰åŒ…å«ä»»ä½•æ–¹æ³•çš„æ¥å£ï¼Œä¾‹å¦‚ Serializable æ¥å£ï¼Œä¸åŒ…å«ä»»ä½•æ–¹æ³• ç¬¬ä¸‰åå…«æ¡ æ£€æŸ¥å‚æ•°çš„æœ‰æ•ˆæ€§ å¯¹äºå…±æœ‰çš„å¯ä»¥ä½¿ç”¨ throws è¯´æ˜æ–¹æ³•ä¼šäº§ç”Ÿä»€ä¹ˆå¼‚å¸¸ å¯¹äºç§æœ‰çš„æ–¹æ³•å¯ä»¥ä½¿ç”¨ assert æ–­è¨€ ç®€è€Œè¨€ä¹‹ï¼Œæ¯å½“ç¼–å†™æ–¹æ³•æˆ–è€…æ„é€ å™¨çš„æ—¶å€™ï¼Œåº”è¯¥è€ƒè™‘å®ƒçš„å‚æ•°æœ‰å“ªäº›é™åˆ¶ã€‚åº”è¯¥æŠŠè¿™äº›é™åˆ¶å†™åˆ°æ–‡æ¡£ä¸­ï¼Œå¹¶ä¸”åœ¨è¿™ä¸ªæ–¹æ³•æå¼€å¤´å¤„ï¼Œé€šè¿‡æ˜¾å¼çš„æ£€æŸ¥æ¥å®æ–½è¿™äº›é™åˆ¶ã€‚ ç¬¬ä¸‰åä¹æ¡ å¿…è¦æ—¶è¿›è¡Œä¿æŠ¤æ€§æ‹·è´ ç®€è€Œè¨€ä¹‹ï¼Œå¦‚æœç±»å…·æœ‰ä»å®¢æˆ·ç«¯å¾—åˆ°æˆ–è€…è¿”å›å®¢æˆ·ç«¯çš„å¯å˜ç»„ä»¶ï¼Œç±»å°±å¿…é¡»ä¿æŠ¤æ€§åœ°æ‹·è´è¿™äº›ç»„ä»¶ã€‚å¦‚æœæ‹·è´çš„æˆæœ¬å—åˆ°é™åˆ¶ï¼Œå¹¶ä¸”ç±»ä¿¡ä»»å®ƒçš„å®¢æˆ·ç«¯ä¸ä¼šä¸æ°å½“çš„ä¿®æ”¹ç»„ä»¶ï¼Œå°±å¯ä»¥åœ¨æ–‡æ¡£ä¸­æŒ‡æ˜å®¢æˆ·ç«¯çš„èŒè´£æ˜¯ä¸å¾—ä¿®æ”¹å—åˆ°å½±å“çš„ç»„ä»¶ï¼Œä»¥æ­¤æ¥ä»£æ›¿ä¿æŠ¤æ€§æ‹·è´ ç¬¬å››åæ¡ è°¨æ…è®¾è®¡æ–¹æ³•ç­¾å è°¨æ…çš„é€‰æ‹©æ–¹æ³•çš„åç§° ä¸è¦è¿‡äºè¿½æ±‚æä¾›ä¾¿åˆ©çš„æ–¹æ³• é¿å…è¿‡é•¿çš„å‚æ•°åˆ—è¡¨ ç¬¬å››åä¸€æ¡ æ…ç”¨é‡è½½ å®‰å…¨è€Œä¿å®ˆçš„ç­–ç•¥æ˜¯ï¼Œæ°¸è¿œä¸è¦å¯¼å‡ºä¸¤ä¸ªå…·æœ‰ç›¸åŒå‚æ•°æ ‘æœ¨çš„é‡è½½æ–¹æ³• ç¬¬å››åäºŒæ¡ æ…ç”¨å¯å˜å‚æ•° ç¬¬å››åä¸‰æ¡ è¿”å›é›¶é•¿åº¦çš„æ•°ç»„æˆ–è€…é›†åˆï¼Œè€Œä¸æ˜¯null è¿”å›ç±»å‹ä¸º List æˆ–æ•°ç»„ï¼Œé•¿åº¦ä¸ºé›¶æ˜¯è¿”å› Collections.empty(); ç¬¬å››åå››æ¡ ä¸ºæ‰€æœ‰å¯¼å‡ºçš„APIå…ƒç´ ç¼–å†™æ–‡æ¡£æ³¨é‡Š ç¬¬å››åäº”æ¡ å°†å±€éƒ¨å˜é‡çš„ä½œç”¨åŸŸæœ€å°åŒ– ç¬¬å››åå…­æ¡ for-each å¾ªç¯ä¼˜å…ˆäºä¼ ç»Ÿçš„forå¾ªç¯ ç¬¬å››åä¸ƒæ¡ äº†è§£å’Œä½¿ç”¨ç±»åº“ ç¬¬å››åå…«æ¡ å¦‚æœéœ€è¦ç²¾ç¡®çš„ç­”æ¡ˆï¼Œè¯·é¿å…ä½¿ç”¨ float å’Œ double ç¬¬å››åä¹æ¡ åŸºæœ¬ç±»å‹ä¼˜å…ˆäºè£…ç®±åŸºæœ¬ç±»å‹ ç¬¬äº”åæ¡ å¦‚æœå…¶ä»–ç±»å‹æ›´åˆé€‚ï¼Œåˆ™å°½é‡é¿å…ä½¿ç”¨å­—ç¬¦ä¸² ç¬¬äº”åä¸€æ¡ å½“å¿ƒå­—ç¬¦ä¸²è¿æ¥çš„æ€§èƒ½ ç¬¬äº”åäºŒæ¡ é€šè¿‡æ¥å£å¼•ç”¨å¯¹è±¡ åº”è¯¥ä¼˜å…ˆä½¿ç”¨æ¥å£è€Œä¸æ˜¯ç±»æ¥å¼•ç”¨å¯¹è±¡ ç¬¬äº”åä¸‰æ¡ æ¥å£ä¼˜å…ˆäºåå°„æœºåˆ¶ ç¬¬äº”åå››æ¡ è°¨æ…çš„ä½¿ç”¨æœ¬åœ°æ–¹æ³• ç¬¬äº”åäº”æ¡ è°¨æ…çš„ä½¿ç”¨ä¼˜åŒ– ç¬¬äº”åå…­æ¡ éµå®ˆæ™®éæ¥å—çš„å‘½åä¹ æƒ¯ ç¬¬äº”åä¸ƒæ¡ åªæœ‰é’ˆå¯¹å¼‚å¸¸çš„æƒ…å†µæ‰ä½¿ç”¨å¼‚å¸¸ ç¬¬äº”åå…«æ¡ å¯¹å¯æ¢å¤çš„æƒ…å†µä½¿ç”¨å—æ£€å¼‚å¸¸ï¼Œå¯¹ç¼–ç¨‹é”™è¯¯ä½¿ç”¨è¿è¡Œæ—¶å¼‚å¸¸ ç¬¬äº”åä¹æ¡ é¿å…ä¸å¿…è¦åœ°ä½¿ç”¨å—æ£€çš„å¼‚å¸¸ ç¬¬å…­åæ¡ ä¼˜å…ˆä½¿ç”¨æ ‡å‡†çš„å¼‚å¸¸ ç¬¬å…­åä¸€æ¡ æŠ›å‡ºä¸æŠ½è±¡ç›¸å¯¹åº”çš„å¼‚å¸¸ ç¬¬å…­åäºŒæ¡ æ¯ä¸ªæ–¹æ³•æŠ›å‡ºçš„å¼‚å¸¸éƒ½è¦æœ‰æ–‡æ¡£ ç¬¬å…­åä¸‰æ¡ åœ¨ç»†èŠ‚æ¶ˆæ¯ä¸­åŒ…å«èƒ½æ•è·å¤±è´¥çš„æ¶ˆæ¯ ç¬¬å…­åå››æ¡ åŠªåŠ›æ˜¯å¤±è´¥ä¿æŒåŸå­æ€§ ç¬¬å…­åäº”æ¡ ä¸è¦å¿½ç•¥å¼‚å¸¸ ç¬¬å…­åå…­æ¡ åŒæ­¥è®¿é—®å…±äº«çš„å¯å˜æ•°æ® ç¬¬å…­åä¸ƒæ¡ é¿å…è¿‡åº¦åŒæ­¥ ç¬¬å…­åå…«æ¡ executor å’Œ task ä¼˜å…ˆäºçº¿ç¨‹ ç¬¬å…­åä¹æ¡ å¹¶å‘å·¥å…·ä¼˜å…ˆäº wait å’Œ notify ç¬¬ä¸ƒåæ¡ çº¿ç¨‹å®‰å…¨æ€§çš„æ–‡æ¡£åŒ– ç¬¬ä¸ƒåä¸€æ¡ æ…ç”¨å»¶è¿Ÿåˆå§‹åŒ– ç¬¬ä¸ƒåäºŒæ¡ ä¸è¦ä¾èµ–äºçº¿ç¨‹è°ƒåº¦å™¨ ç¬¬ä¸ƒåä¸‰æ¡ é¿å…ä½¿ç”¨çº¿ç¨‹ç»„ ç¬¬ä¸ƒåå››æ¡ è°¨æ…åœ°å®ç° Serializble æ¥å£ å®ç° Serializable æ¥å£è€Œä»˜å‡ºç¬¬æœ€å¤§ä»£ä»·æ˜¯ï¼Œä¸€æ—¦ä¸€ä¸ªç±»è¢«å‘å¸ƒï¼Œå°±å¤§å¤§é™ä½äº†â€œæ”¹å˜è¿™ä¸ªç±»çš„å®ç°â€ çš„çµæ´»æ€§ ç¬¬ä¸ƒåäº”æ¡ è€ƒè™‘ä½¿ç”¨è‡ªå®šä¹‰çš„åºåˆ—åŒ–å½¢å¼ ç¬¬ä¸ƒåå…­æ¡ ä¿æŠ¤æ€§çš„ç¼–å†™ readObject æ–¹æ³• ç¬¬ä¸ƒåä¸ƒæ¡ å¯¹äºå®ä¾‹æ§åˆ¶ï¼Œæšä¸¾ç±»å‹ä¼˜å…ˆäº readResolve ç¬¬ä¸ƒåå…«æ¡ è€ƒè™‘ä½¿ç”¨åºåˆ—åŒ–ä»£ç†ä»£æ›¿åºåˆ—åŒ–å®ä¾‹","categories":[{"name":"Java","slug":"Java","permalink":"https://wzes.github.io/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://wzes.github.io/tags/Java/"}]},{"title":"Java8 HashMap æºç è§£æ","slug":"Java/Java8 HashMap æºç è§£æ","date":"2018-08-27T07:30:00.000Z","updated":"2019-09-02T12:20:53.730Z","comments":true,"path":"2018/08/27/Java/Java8 HashMap æºç è§£æ/","link":"","permalink":"https://wzes.github.io/2018/08/27/Java/Java8 HashMap æºç è§£æ/","excerpt":"","text":"å‰è¨€ å³ä½¿è‡ªå·±å†™äº†ä¸¤å¹´ Javaï¼Œç„¶è€Œå¯¹ HashMap å´æœ›è€Œç”Ÿç•ï¼Œè™½ç„¶æ¯æ¬¡é¢è¯•å‡ ä¹éƒ½ä¼šé—®ï¼Œå³ä½¿æˆ‘èƒ½å°†å¤§éƒ¨åˆ†çŸ¥è¯†ç‚¹ä¸€ä¸€é“æ¥ï¼Œä»¤é¢è¯•å®˜ç ç›®ç»“èˆŒï¼Œç„¶è€Œä¹Ÿåªæœ‰æˆ‘è‡ªå·±çŸ¥é“ï¼Œè¦æ˜¯è®©è‡ªå·±é‡å†™ï¼Œæˆ‘è‚¯å®šå†™ä¸å‡ºæ¥çš„ï¼Œæˆ‘å¹¶æ²¡æœ‰ç†è§£æ¯ä¸€ä¸ªåœ°æ–¹ï¼Œæ‰€ä»¥ä¾¿æƒ³å†™å‡ºè¿™ç¯‡æ–‡ç« ï¼Œè®°å½•è‡ªå·±çš„å­¦ä¹ ï¼Œå¸Œæœ›èƒ½ç†è§£æ¯ä¸€ä¸ªåœ°æ–¹ å‰ä¸–ä»Šç”Ÿ 12public class HashMap&lt;K,V&gt; extends AbstractMap&lt;K,V&gt; implements Map&lt;K,V&gt;, Cloneable, Serializable æˆ‘ä»¬æœ‰å¿…è¦çœ‹ä¸€ä¸ª Map çš„æ¥å£ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142public interface Map&lt;K,V&gt; &#123; int size(); boolean isEmpty(); boolean containsKey(Object key); boolean containsValue(Object value); V get(Object key); V put(K key, V value); V remove(Object key); void putAll(Map&lt;? extends K, ? extends V&gt; m); void clear(); Set&lt;K&gt; keySet(); Collection&lt;V&gt; values(); Set&lt;Map.Entry&lt;K, V&gt;&gt; entrySet(); boolean equals(Object o); int hashCode(); default V getOrDefault(Object key, V defaultValue) &#123; V v; return (((v = get(key)) != null) || containsKey(key)) ? v : defaultValue; &#125; default void forEach(BiConsumer&lt;? super K, ? super V&gt; action) &#123; Objects.requireNonNull(action); for (Map.Entry&lt;K, V&gt; entry : entrySet()) &#123; K k; V v; try &#123; k = entry.getKey(); v = entry.getValue(); &#125; catch(IllegalStateException ise) &#123; // this usually means the entry is no longer in the map. throw new ConcurrentModificationException(ise); &#125; action.accept(k, v); &#125; &#125; default V putIfAbsent(K key, V value) &#123; V v = get(key); if (v == null) &#123; v = put(key, value); &#125; return v; &#125; default boolean remove(Object key, Object value) &#123; Object curValue = get(key); if (!Objects.equals(curValue, value) || (curValue == null &amp;&amp; !containsKey(key))) &#123; return false; &#125; remove(key); return true; &#125; default boolean replace(K key, V oldValue, V newValue) &#123; Object curValue = get(key); if (!Objects.equals(curValue, oldValue) || (curValue == null &amp;&amp; !containsKey(key))) &#123; return false; &#125; put(key, newValue); return true; &#125; default V replace(K key, V value) &#123; V curValue; if (((curValue = get(key)) != null) || containsKey(key)) &#123; curValue = put(key, value); &#125; return curValue; &#125; default V computeIfAbsent(K key, Function&lt;? super K, ? extends V&gt; mappingFunction) &#123; Objects.requireNonNull(mappingFunction); V v; if ((v = get(key)) == null) &#123; V newValue; if ((newValue = mappingFunction.apply(key)) != null) &#123; put(key, newValue); return newValue; &#125; &#125; return v; &#125; default V compute(K key, BiFunction&lt;? super K, ? super V, ? extends V&gt; remappingFunction) &#123; Objects.requireNonNull(remappingFunction); V oldValue = get(key); V newValue = remappingFunction.apply(key, oldValue); if (newValue == null) &#123; // delete mapping if (oldValue != null || containsKey(key)) &#123; // something to remove remove(key); return null; &#125; else &#123; // nothing to do. Leave things as they were. return null; &#125; &#125; else &#123; // add or replace old mapping put(key, newValue); return newValue; &#125; &#125; default V merge(K key, V value, BiFunction&lt;? super V, ? super V, ? extends V&gt; remappingFunction) &#123; Objects.requireNonNull(remappingFunction); Objects.requireNonNull(value); V oldValue = get(key); V newValue = (oldValue == null) ? value : remappingFunction.apply(oldValue, value); if(newValue == null) &#123; remove(key); &#125; else &#123; put(key, newValue); &#125; return newValue; &#125;&#125;","categories":[{"name":"Java","slug":"Java","permalink":"https://wzes.github.io/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://wzes.github.io/tags/Java/"}]},{"title":"Java8 InvocationHandler åŠ¨æ€ä»£ç† æºç è§£æ","slug":"Java/Java8 InvocationHandleråŠ¨æ€ä»£ç†æºç è§£æ","date":"2018-08-26T07:30:00.000Z","updated":"2019-09-02T12:20:58.315Z","comments":true,"path":"2018/08/26/Java/Java8 InvocationHandleråŠ¨æ€ä»£ç†æºç è§£æ/","link":"","permalink":"https://wzes.github.io/2018/08/26/Java/Java8 InvocationHandleråŠ¨æ€ä»£ç†æºç è§£æ/","excerpt":"","text":"å‰è¨€ ä¹‹å‰å¯¹åŠ¨æ€ä»£ç†äº†è§£ä»…ä»…åœ¨äºè¡¨å±‚ï¼Œä¸€ç›´è§‰å¾—é«˜ä¸å¯æ”€ï¼Œä»Šå¤©ç‚¹å¼€äº† Proxy ç±»ï¼Œæ¬²çŸ¥æ•…äº‹å¦‚ä½•ï¼Œéœ€ Read The Source Codeï¼Œå†åŠ ä¸Šçœ‹ä¸€äº›åˆ«äººçš„æ–‡ç« ï¼Œå¯¹ç…§ç€è‡ªå·±å¯¹æºç çš„ç†è§£ï¼Œå½¢æˆæ­¤æ–‡ï¼Œé€šä¿—æ˜“æ‡‚ï¼Œä¿ä½ çœ‹åå¯¹åŠ¨æ€ä»£ç†åˆæœ‰äº†æ›´åŠ æ·±å…¥çš„ç†è§£ å…ˆçœ‹ä¸€ä¸ªä¾‹å­ç†Ÿæ‚‰ä¸€ä¸‹å§ å…ˆå®šä¹‰æ¥å£ï¼Œä¹‹åæˆ‘ä»¬å†çœ‹ï¼Œä¸ºä»€ä¹ˆJDKä¸èƒ½ä»£ç†ç±»ï¼Œåªèƒ½ä»£ç†æ¥å£ 12345678910public interface AddService &#123; /** * &lt;p&gt;Test method&lt;/p&gt; * * @param a number a * @param b number b * @return sum of a and b */ int add(int a, int b);&#125; å®ç°ç±» 1234567public class AddServiceImpl implements AddService &#123; @Override public int add(int a, int b) &#123; return a + b; &#125;&#125; Handlerï¼Œç»§æ‰¿è‡ªInvocationHandlerï¼Œè¯¥æ¥å£åªæœ‰ä¸€ä¸ªæ–¹æ³• invokeï¼Œä½ åªéœ€è¦å®ç°å®ƒï¼Œç„¶ååˆ©ç”¨åå°„ Object invoke = method.invoke(addService, args); è¿”å›æ¥å£return invoke; å…¶ä»–çš„ä½ æƒ³å¹²ä»€ä¹ˆéƒ½è¡Œï¼Œå½“ç„¶ä½ ä¹Ÿå®Œå…¨æ”¹å˜è¿™ä¸ªè¿™ä¸ªå®ç°ï¼Œè¿”å›ä¸€äº›åˆ«çš„å•¥ï¼Œåäº‹ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚getProxyæ–¹æ³•é‡Œé¢è°ƒç”¨Proxy.newProxyInstance è·å–ä¸€ä¸ªä»£ç†å¯¹è±¡ 1234567891011121314151617181920public class AddServiceHandler implements InvocationHandler &#123; private AddService addService; public AddServiceHandler(AddService addService) &#123; this.addService = addService; &#125; public AddService getProxy() &#123; return (AddService) Proxy.newProxyInstance(addService.getClass().getClassLoader(), addService.getClass().getInterfaces(), this); &#125; @Override public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123; System.out.println(&quot;before&quot;); Object invoke = method.invoke(addService, args); System.out.println(&quot;after&quot;); return invoke; &#125;&#125; ä½¿ç”¨ï¼Œé¦–å…ˆè·å–åˆ›å»ºå®ä¾‹å¯¹è±¡ï¼Œç„¶åæ„é€ ä¸€ä¸ªHandlerï¼Œå†é€šè¿‡Handlerè·å–Proxy å¯¹è±¡ï¼Œå†è°ƒç”¨æ¥å£çš„æ–¹æ³•ã€‚æˆ‘ä»¬ä¸€åˆ‡çš„ç–‘é—®ï¼Œå¯èƒ½å°±åœ¨ getProxyï¼Œä»–åˆ°åº•è¿”å›äº†ä»€ä¹ˆä¸œè¥¿ï¼Œèƒ½å¤Ÿè®©æˆ‘ä»¬å†è°ƒç”¨æ¥å£æ–¹æ³•çš„æ—¶å€™ï¼Œæ‰§è¡Œçš„å´æ˜¯ å®ç°çš„Service çš„æ–¹æ³•ï¼Œå¹¶ä¸”åŠ äº†ä¸€äº›å…¶å®ƒå®ç°ï¼Œèªæ˜çš„ä½ å¯èƒ½ä¼šè¯´ï¼Œè¿™ç”¨é™æ€ä»£ç†ä¾ç„¶èƒ½å¤Ÿå®ç°ï¼Œå¹¶ä¸”è¦æ¯”åŠ¨æ€ä»£ç†æ¥å¾—ç®€å•ï¼Œä¸ºä»€ä¹ˆè¿˜è¦è¿™æ ·å¤æ‚çš„å®ç°ã€‚æˆ‘ç°åœ¨èƒ½æƒ³åˆ°çš„æ˜¯ï¼Œé™æ€ä»£ç†çš„è¯ï¼Œä½ å¯èƒ½éœ€è¦ä¸ºæ¯ä¸€ä¸ªä»£ç†æ¥å£å®ç°ä¸€ä¸ªä»£ç† Handlerï¼Œç„¶è€Œ InvocationHandler çš„è¯ï¼Œä½ åªéœ€è¦ä¸ºç±»ä¼¼çš„è¯·æ±‚å®ç°ä¸€ä¸ªHandlerï¼Œä¸ºç¨‹åºçš„æ‰©å±•æä¾›äº†å¤§å¤§çš„ç©ºé—´ã€‚ 1234567@Test public void dynamicProxyTest() &#123; AddService service = new AddServiceImpl(); AddServiceHandler addServiceHandler = new AddServiceHandler(service); AddService proxy = addServiceHandler.getProxy(); Assert.assertEquals(3, proxy.add(1, 2)); &#125; çœ‹åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬æœ‰å¾ˆå¤šç–‘é—® Proxy.newProxyInstance() è¿”å›çš„æ˜¯ä»€ä¹ˆä¸œè¥¿ invoke æ–¹æ³•åˆ°åº•åœ¨å“ªè°ƒç”¨ æˆ‘ä»¬åœ¨ target é‡Œé¢æ²¡æœ‰çœ‹åˆ°å…¶å®ƒä»»ä½•é™„å¸¦ç”Ÿæˆçš„ classï¼Œç³»ç»Ÿåˆ°åº•æ˜¯æ€ä¹ˆåšçš„å‘¢ é‚£æˆ‘ä»¬å°±è¦å¥½å¥½çœ‹çœ‹è¿™äº›æ–¹æ³•çš„å®ç°åŸç† Proxy.newProxyInstance 1public class Proxy implements java.io.Serializable&#123;&#125; private çš„æ„é€ æ–¹æ³•ï¼Œé‡Œé¢æœ‰ä¸€ä¸ª InvocationHandlerï¼Œè¿™ä¸ªå°±æ˜¯æˆ‘ä»¬ä¼ å…¥çš„ Handlerï¼Œå¦å¤–è¿˜æœ‰ä¸€ä¸ª proxyClassCacheï¼Œä¸€ä¸ªä»£ç†ç±»çš„ç¼“å­˜å¯¹è±¡ï¼Œæˆ‘æš‚æ—¶ä¸æ‰“ç®—å±•å¼€è®²è¿™ä¸ªä¸œè¥¿ï¼Œè¿˜æ²¡ææ˜ç™½ï¼Œç°åœ¨éœ€è¦è®°ä½ï¼Œè¿™ä¸ªå­˜æ”¾è¿™ç³»ç»Ÿå¸®æˆ‘ä»¬ç”Ÿæˆçš„ä»£ç†ç±»ï¼Œç”¨äº†WeakReference å®ç°ï¼Œ GC çš„æ—¶å€™ä¼šè¢«å›æ”¶ã€‚ é‡Œé¢æœ‰ä¸¤ä¸ªå‚æ•°ä¼ è¿‡å»ï¼ŒKeyFactory() å…ˆä¸ç®¡ï¼ŒProxyClassFactory() è¿™ä¸ªå¾ˆé‡è¦ï¼Œæˆ‘ä»¬ä¹‹åé‡åˆ°äº†å†è¯´ 123456789101112131415161718192021/** parameter types of a proxy class constructor */private static final Class&lt;?&gt;[] constructorParams = &#123; InvocationHandler.class &#125;;/** * a cache of proxy classes */private static final WeakCache&lt;ClassLoader, Class&lt;?&gt;[], Class&lt;?&gt;&gt; proxyClassCache = new WeakCache&lt;&gt;(new KeyFactory(), new ProxyClassFactory());/** * the invocation handler for this proxy instance. * @serial */protected InvocationHandler h;/** * Prohibits instantiation. */private Proxy() &#123;&#125; ä¸ºäº†ç†è§£æ–¹ä¾¿ï¼Œæˆ‘å°†ä¸€äº›æ— å…³ç²¾è¦çš„ä»£ç å‰”é™¤ï¼Œç•™ä¸‹æœ€é‡è¦çš„ä¸¤ä¸ªæ–¹æ³•ï¼ŒgetProxyClass0(loader, intfs) æ ¹æ®loaderå’Œintfs è·å–ä»£ç†ç±»ï¼Œé€šè¿‡è¿™ä¸ªæ–¹æ³•æˆ‘ä»¬è·å¾—ä¸€ä¸ªæ–°çš„ç±»å­—èŠ‚ç ï¼Œè¿™ä¸ªç±»æ˜¯è¿è¡Œæ—¶ç”Ÿæˆçš„ï¼Œé€šè¿‡è¿™ä¸ªä»£ç†ç±»ï¼ŒgetConstructor è·å–æ„é€ å¯¹è±¡ï¼Œè°ƒç”¨newInstanceåˆ›å»ºä¸€ä¸ªå®ä¾‹å¯¹è±¡ï¼ŒnewInstanceæ˜¯å¯ä»¥ä¼ å‚çš„ï¼Œåªéœ€è¦è°ƒç”¨ constructor çš„æ„é€ æ–¹æ³•å‚æ•°å¿…é¡»æ˜¯ InvocationHandler.classï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼ çš„æ˜¯ this å¯¹è±¡ã€‚ 123456789101112public static Object newProxyInstance(ClassLoader loader, Class&lt;?&gt;[] interfaces, InvocationHandler h) throws IllegalArgumentException&#123; /* * Look up or generate the designated proxy class. */ Class&lt;?&gt; cl = getProxyClass0(loader, intfs); final Constructor&lt;?&gt; cons = cl.getConstructor(constructorParams); return cons.newInstance(new Object[]&#123;h&#125;);&#125; 65535 é™åˆ¶ï¼Œè¿™ä¸ªget æ¯”è¾ƒé«˜çº§ï¼Œç›´æ¥ä»ç¼“å­˜æ‹¿ï¼Œåˆšå¼€å§‹çœ‹åˆ°å¯èƒ½è§‰å¾—æœ‰ç‚¹çº³é—·ï¼Œè¿™ä¸ª proxyClassCache ä¹‹å‰é‡åˆ°è¿‡äº† 1234567891011private static Class&lt;?&gt; getProxyClass0(ClassLoader loader, Class&lt;?&gt;... interfaces) &#123; if (interfaces.length &gt; 65535) &#123; throw new IllegalArgumentException(&quot;interface limit exceeded&quot;); &#125; // If the proxy class defined by the given loader implementing // the given interfaces exists, this will simply return the cached copy; // otherwise, it will create the proxy class via the ProxyClassFactory return proxyClassCache.get(loader, interfaces);&#125; getæ–¹æ³•é¦–å…ˆåˆ›å»ºä¸€ä¸ª valuesMapï¼Œè·å–subKeyï¼Œé‡Œé¢æ¯”è¾ƒé‡è¦çš„å°±æ˜¯subKeyFactory.apply(key, parameter)ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šå¸®æˆ‘ä»¬ç”Ÿæˆä»£ç†ç±»çš„subKeyï¼Œå¦å¤–ä¹‹åä¼šå»ºç«‹ä¸€ä¸ªFactoryï¼Œå½“ä½¿ç”¨get çš„æ—¶å€™ï¼Œä¾¿æ˜¯çœŸæ­£ç”Ÿæˆ ä»£ç†ç±»çš„æ—¶å€™ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061public V get(K key, P parameter) &#123; Objects.requireNonNull(parameter); expungeStaleEntries(); Object cacheKey = CacheKey.valueOf(key, refQueue); // lazily install the 2nd level valuesMap for the particular cacheKey ConcurrentMap&lt;Object, Supplier&lt;V&gt;&gt; valuesMap = map.get(cacheKey); if (valuesMap == null) &#123; ConcurrentMap&lt;Object, Supplier&lt;V&gt;&gt; oldValuesMap = map.putIfAbsent(cacheKey, valuesMap = new ConcurrentHashMap&lt;&gt;()); if (oldValuesMap != null) &#123; valuesMap = oldValuesMap; &#125; &#125; // create subKey and retrieve the possible Supplier&lt;V&gt; stored by that // subKey from valuesMap Object subKey = Objects.requireNonNull(subKeyFactory.apply(key, parameter)); Supplier&lt;V&gt; supplier = valuesMap.get(subKey); Factory factory = null; while (true) &#123; if (supplier != null) &#123; // supplier might be a Factory or a CacheValue&lt;V&gt; instance V value = supplier.get(); if (value != null) &#123; return value; &#125; &#125; // else no supplier in cache // or a supplier that returned null (could be a cleared CacheValue // or a Factory that wasn&apos;t successful in installing the CacheValue) // lazily construct a Factory if (factory == null) &#123; factory = new Factory(key, parameter, subKey, valuesMap); &#125; if (supplier == null) &#123; supplier = valuesMap.putIfAbsent(subKey, factory); if (supplier == null) &#123; // successfully installed Factory supplier = factory; &#125; // else retry with winning supplier &#125; else &#123; if (valuesMap.replace(subKey, supplier, factory)) &#123; // successfully replaced // cleared CacheEntry / unsuccessful Factory // with our Factory supplier = factory; &#125; else &#123; // retry with current supplier supplier = valuesMap.get(subKey); &#125; &#125; &#125;&#125; ProxyClassFactory apply ä¸å¯ä¸çœ‹ï¼Œé¦–å…ˆåŠ è½½æ¥å£ï¼Œç„¶åä½¿ç”¨ProxyGenerator.generateProxyClass ç”ŸæˆClass å­—èŠ‚ç æ–‡ä»¶ï¼Œæœ€åå†è°ƒç”¨ defineClass0 å¯¹å…¶åŠ è½½åè¿”å›å…³é”®å­—ï¼Œä½œä¸ºkeyï¼Œä¹‹åå†æ ¹æ®è¿™ä¸ªkeyè·å–åˆ°çœŸæ­£çš„class å¯¹è±¡ï¼Œåˆ°è¿™é‡Œï¼ŒProxyç±»å·²ç»ç”Ÿæˆå¥½ï¼Œå¹¶ä¸”åŠ è½½å¥½äº†ï¼Œç›´æ¥è¿”å›ï¼Œè¿™ä¸ªç±»æ˜¯åŠ¨æ€ç”Ÿæˆçš„ï¼Œç•™åœ¨å†…å­˜çš„æ•°æ® 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899private static final class ProxyClassFactory implements BiFunction&lt;ClassLoader, Class&lt;?&gt;[], Class&lt;?&gt;&gt;&#123; // prefix for all proxy class names private static final String proxyClassNamePrefix = &quot;$Proxy&quot;; // next number to use for generation of unique proxy class names private static final AtomicLong nextUniqueNumber = new AtomicLong(); @Override public Class&lt;?&gt; apply(ClassLoader loader, Class&lt;?&gt;[] interfaces) &#123; Map&lt;Class&lt;?&gt;, Boolean&gt; interfaceSet = new IdentityHashMap&lt;&gt;(interfaces.length); for (Class&lt;?&gt; intf : interfaces) &#123; /* * Verify that the class loader resolves the name of this * interface to the same Class object. */ Class&lt;?&gt; interfaceClass = null; try &#123; interfaceClass = Class.forName(intf.getName(), false, loader); &#125; catch (ClassNotFoundException e) &#123; &#125; if (interfaceClass != intf) &#123; throw new IllegalArgumentException( intf + &quot; is not visible from class loader&quot;); &#125; /* * Verify that the Class object actually represents an * interface. */ if (!interfaceClass.isInterface()) &#123; throw new IllegalArgumentException( interfaceClass.getName() + &quot; is not an interface&quot;); &#125; /* * Verify that this interface is not a duplicate. */ if (interfaceSet.put(interfaceClass, Boolean.TRUE) != null) &#123; throw new IllegalArgumentException( &quot;repeated interface: &quot; + interfaceClass.getName()); &#125; &#125; String proxyPkg = null; // package to define proxy class in int accessFlags = Modifier.PUBLIC | Modifier.FINAL; /* * Record the package of a non-public proxy interface so that the * proxy class will be defined in the same package. Verify that * all non-public proxy interfaces are in the same package. */ for (Class&lt;?&gt; intf : interfaces) &#123; int flags = intf.getModifiers(); if (!Modifier.isPublic(flags)) &#123; accessFlags = Modifier.FINAL; String name = intf.getName(); int n = name.lastIndexOf(&apos;.&apos;); String pkg = ((n == -1) ? &quot;&quot; : name.substring(0, n + 1)); if (proxyPkg == null) &#123; proxyPkg = pkg; &#125; else if (!pkg.equals(proxyPkg)) &#123; throw new IllegalArgumentException( &quot;non-public interfaces from different packages&quot;); &#125; &#125; &#125; if (proxyPkg == null) &#123; // if no non-public proxy interfaces, use com.sun.proxy package proxyPkg = ReflectUtil.PROXY_PACKAGE + &quot;.&quot;; &#125; /* * Choose a name for the proxy class to generate. */ long num = nextUniqueNumber.getAndIncrement(); String proxyName = proxyPkg + proxyClassNamePrefix + num; /* * Generate the specified proxy class. */ byte[] proxyClassFile = ProxyGenerator.generateProxyClass( proxyName, interfaces, accessFlags); try &#123; return defineClass0(loader, proxyName, proxyClassFile, 0, proxyClassFile.length); &#125; catch (ClassFormatError e) &#123; /* * A ClassFormatError here means that (barring bugs in the * proxy class generation code) there was some other * invalid aspect of the arguments supplied to the proxy * class creation (such as virtual machine limitations * exceeded). */ throw new IllegalArgumentException(e.toString()); &#125; &#125;&#125; é‚£æˆ‘ä»¬å¯ä»¥è°ƒç”¨ProxyGenerator.generateProxyClassæ¥çœ‹ä¸€æ¬¡ä¸‹è¿™ä¸ªç”Ÿæˆçš„ç±»ï¼ŒæŠŠå®ƒå†™åˆ°æ–‡ä»¶é‡Œï¼Œè¿™ä¸ªç±»å¤§æ¦‚å°±æ˜¯è¿™ä¸ªæ ·å­ï¼Œå°±æ˜¯æˆ‘ä»¬é€šè¿‡getProxyè·å–åˆ°çš„å®é™…ç±»ï¼Œä¹‹åå°±ç®€å•äº†ï¼Œå¯ä»¥æ¸…æ¥šçš„çœ‹åˆ°é‡Œé¢ç†Ÿæ‚‰çš„addæ–¹æ³•ï¼Œæ˜¯é€šè¿‡è°ƒç”¨äº† invoke æ¥å®ç°çš„ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263public final class $Proxy11 extends Proxy implements Service &#123; private static Method m1; private static Method m2; private static Method m3; private static Method m0; public $Proxy11(InvocationHandler var1) throws &#123; super(var1); &#125; public final boolean equals(Object var1) throws &#123; try &#123; return (Boolean)super.h.invoke(this, m1, new Object[]&#123;var1&#125;); &#125; catch (RuntimeException | Error var3) &#123; throw var3; &#125; catch (Throwable var4) &#123; throw new UndeclaredThrowableException(var4); &#125; &#125; public final String toString() throws &#123; try &#123; return (String)super.h.invoke(this, m2, (Object[])null); &#125; catch (RuntimeException | Error var2) &#123; throw var2; &#125; catch (Throwable var3) &#123; throw new UndeclaredThrowableException(var3); &#125; &#125; public final int add(int var1, int var2) throws &#123; try &#123; return (Integer)super.h.invoke(this, m3, new Object[]&#123;var1, var2&#125;); &#125; catch (RuntimeException | Error var4) &#123; throw var4; &#125; catch (Throwable var5) &#123; throw new UndeclaredThrowableException(var5); &#125; &#125; public final int hashCode() throws &#123; try &#123; return (Integer)super.h.invoke(this, m0, (Object[])null); &#125; catch (RuntimeException | Error var2) &#123; throw var2; &#125; catch (Throwable var3) &#123; throw new UndeclaredThrowableException(var3); &#125; &#125; static &#123; try &#123; m1 = Class.forName(&quot;java.lang.Object&quot;).getMethod(&quot;equals&quot;, Class.forName(&quot;java.lang.Object&quot;)); m2 = Class.forName(&quot;java.lang.Object&quot;).getMethod(&quot;toString&quot;); m3 = Class.forName(&quot;proxy.Service&quot;).getMethod(&quot;add&quot;, Integer.TYPE, Integer.TYPE); m0 = Class.forName(&quot;java.lang.Object&quot;).getMethod(&quot;hashCode&quot;); &#125; catch (NoSuchMethodException var2) &#123; throw new NoSuchMethodError(var2.getMessage()); &#125; catch (ClassNotFoundException var3) &#123; throw new NoClassDefFoundError(var3.getMessage()); &#125; &#125;&#125; è‡³æ­¤ï¼Œå¤§éƒ¨åˆ†é€»è¾‘å·²ç»ææ¸…æ¥šäº†ï¼Œé‚£æˆ‘ä»¬å¤§æ¦‚çŸ¥é“äº†ä¸ºä»€ä¹ˆè¿™ä¸ªè¿‡ç¨‹è¦æ¯”ç›´æ¥åˆ›å»ºå¯¹è±¡è¦æ…¢ï¼Œé‚£æ˜¯å› ä¸ºä»–ç¬¬ä¸€æ¬¡çš„æ—¶å€™éœ€è¦åŠ¨æ€çš„å»åˆ›å»ºå­—èŠ‚ç ï¼Œç„¶åè¿›è¡ŒåŠ è½½ï¼Œåˆå§‹åŒ–â€¦è™½ç„¶æœ‰ç¼“å­˜ï¼Œä½†æ˜¯ç”±äºä½¿ç”¨äº† WeakReferenceï¼ŒGCåæœ‰å¯èƒ½ä¼šè¢«å›æ”¶ï¼Œé‚£ä¹ˆå°±å¾—é‡æ–°åŠ è½½ï¼Œä¸€å®šç¨‹åº¦ä¸Šä¼šé™ä½æ•ˆç‡ï¼Œæ‰€ä»¥ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°½é‡é¿å…è¿™ç§åŠ¨æ€ç”Ÿæˆç±»çš„æ–¹å¼ï¼Œè€Œæ˜¯ç”¨åœ¨ç¼–è¯‘æ—¶ç”Ÿæˆç±»çš„æ–¹å¼å–ä»£ï¼Œè¿™ä¾¿æ˜¯ APT æŠ€æœ¯çš„ç²¾é«“ã€‚ å°ç»“ ä¸Šé¢ä¸‰ä¸ªå°é—®é¢˜éƒ½å·²ç»å¼„æ¸…æ¥šäº†å§ï¼Œç°åœ¨å¯¹åŠ¨æ€ä»£ç†æ›´åŠ äº†è§£äº†äº›ï¼Œå¦å¤–ä¸€ç±» CGLIBï¼Œæ›´æ”¹å­—èŠ‚ç çš„æŠ€æœ¯ä¹‹åæœ‰æ—¶é—´ä¼šå†å»çœ‹ æ¬¢è¿è®¨è®ºï½ï½ï½","categories":[{"name":"Java","slug":"Java","permalink":"https://wzes.github.io/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://wzes.github.io/tags/Java/"}]},{"title":"Android DiskLruCache æºç è§£æ","slug":"Android/DiskLruCache","date":"2018-08-24T15:03:00.000Z","updated":"2019-09-02T12:18:17.487Z","comments":true,"path":"2018/08/24/Android/DiskLruCache/","link":"","permalink":"https://wzes.github.io/2018/08/24/Android/DiskLruCache/","excerpt":"","text":"å‰è¨€ ä¹‹å‰åœ¨çœ‹ LruCache çš„æ—¶å€™ï¼Œå°±åƒçœ‹çœ‹åŸºäº Disk ç‰ˆçš„ LruCacheï¼Œå½“æˆ‘çœ‹å®Œ LruCache åï¼Œå¦‚æœæ˜¯æˆ‘è‡ªå·±å»å†™ï¼Œå¤§æ¦‚è¿˜æ˜¯ä¼šåŸºäº LruCache å»ä¿ç•™ keyï¼Œæ ¹æ®è¿™ä¸ª key å»åš LRUï¼Œåªä¸è¿‡æŠŠå€¼ä¿å­˜åœ¨ç¡¬ç›˜é‡Œï¼Œè¿™å‡ é¢åˆæœ‰ä¸€ä¸ªå¯¹åº”å…³ç³»ï¼ŒKey å’Œ Valueï¼Œå¦‚æœè¯´ï¼Œä¸€ä¸ªKey å¯¹åº”ä¸€ä¸ªæ–‡ä»¶ï¼Œé‚£ä¹ˆå°±ä¼šå¥½åŠå¾—å¾ˆå¤šï¼Œç›´æ¥æ ¹æ® Keyçš„å€¼è·å–æ–‡ä»¶åï¼Œç„¶åè¯»å–æ•°æ®ï¼Œæˆ–è€…å†™å…¥æ•°æ®ï¼Œç„¶è€Œè¿™æ ·å°±ä¼šé€ æˆæ–‡ä»¶æ•°å’Œ Key çš„ä¸ªæ•°çº¿æ€§å¢é•¿ï¼Œæ•ˆæœä¸è§å¾—ä¼šå¥½ï¼Œå¦‚æœå¤šä¸ª Key å¯¹åº”ä¸€ä¸ªæ–‡ä»¶ï¼Œé‚£ä¹ˆå°±è¦è€ƒè™‘ï¼Œè¿™ä¸ª Key çš„å€¼åœ¨é‚£ä¸ªæ–‡ä»¶ï¼Œå“ªä¸€ä½ç½®ï¼Œæƒ³æƒ³è¿™äº›ï¼Œæ­£å¼ key-value æ•°æ®åº“éœ€è¦è§£å†³çš„é—®é¢˜ï¼Œåªä¸è¿‡äººå®¶çš„æ•°æ®åº“æ˜¯ä¸ä¼šå­˜åœ¨è¿‡æœŸçš„ï¼Œå½“ç„¶ï¼ŒRedis æ˜¯æœ‰è¿‡æœŸçš„è¯´æ³•ã€‚ çªç„¶æœ‰ä¸€ç§æƒ³å»äº†è§£ä¸€ä¸‹å†…å­˜æ•°æ®åº“çš„å®ç°çš„å†²åŠ¨ï¼Œç±»ä¼¼ Redisï¼Œæˆ‘è®°å¾—é‡Œé¢çš„æ•°æ®ç»“æ„æœ‰ä½¿ç”¨ SkipList æ¥åšï¼Œæ’å…¥ï¼Œåˆ é™¤éƒ½èƒ½åœ¨ä¸€å®šçš„æ—¶é—´èŒƒå›´å†…ï¼Œå½“ç„¶çº¢é»‘æ ‘ä¹Ÿæ˜¯æ¯”è¾ƒåˆé€‚ï¼Œå°±æ˜¯å¦‚ä½•å¿«é€Ÿæ‰¾åˆ°è¿™ä¸ª Key ç›¸å…³ä¿¡æ¯ï¼Œç„¶åæ‰¾å‡ºæ•°æ®çš„å­˜åœ¨ä½ç½®ã€‚è¿™æœŸé—´å¯èƒ½ä½ æƒ³åšåˆ°æ•°æ®ä¸€éƒ¨åˆ†åŠ è½½å…¥å†…å­˜ï¼Œä¸€éƒ¨åˆ†åœ¨ç¡¬ç›˜ï¼Œè¿™æ ·ç†è®ºä¸Šæ•°æ®åº“çš„å­˜å‚¨ç©ºé—´ä¾¿æ˜¯ç£ç›˜çš„å­˜å‚¨ç©ºé—´ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®æŸä¸ªç­–ç•¥ï¼Œå½“çƒ­ç‚¹æ•°æ®å­˜æ”¾åœ¨å†…å­˜ï¼Œå†·æ•°æ®å­˜æ”¾ç¡¬ç›˜ï¼Œ82åŸåˆ™ï¼Œè¿™æœ‰ç‚¹ç±»ä¼¼æ“ä½œç³»ç»Ÿçš„å†…å­˜ç®¡ç†ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ Lru å¯¹æˆ‘ä»¬çš„å†…å­˜è¿›è¡Œç®¡ç†ï¼Œå½“ç„¶è¿™å¯èƒ½æ¯”å…¨éƒ¨åŠ è½½è¿›å†…å­˜è¦æ…¢å¾—å¤šï¼Œä½†å¤§éƒ¨åˆ†æ•°æ®åœ¨å†…å­˜ï¼Œé€Ÿåº¦è¦æ¯”æ¯æ¬¡ä»ç£ç›˜è¦å¿«å¾—å¤šã€‚å¸¦ç€è¿™æ ·çš„ç–‘è™‘ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ Jakeå¤§ç¥çš„ DiskLruCache DiskLruCache æ˜¯ä»€ä¹ˆï¼Ÿ è¿™æ˜¯ä¸€ä¸ªéå¸¸çŸ­å°ç²¾æ‚çš„Key-Valueï¼ŒåŸºäºLruçš„åŸåˆ™å®ç°çš„Cacheï¼Œvalueåªèƒ½ä¸ºå­—ç¬¦ä¸²ï¼Œæ‰€ä»¥ä½ å¾—å°†ä½ æƒ³è¦å­˜çš„æ•°æ®è½¬åŒ–æˆå­—ç¬¦ä¸²æ ¼å¼ï¼Œç„¶åå†å­˜ï¼Œè¿™ä½¿å¾—è¿™ä¸ªåº“å±€é™äºå­—ç¬¦ä¸²ï¼Œä½†ä¸ºäº†çŸ­å°ï¼Œä¹Ÿæ²¡åŠæ³• å¦‚ä½•ä½¿ç”¨ï¼Ÿ 12345678910111213// åˆ›å»ºä¸€ä¸ªå®ä¾‹ï¼ŒcacheDir æ˜¯cacheçš„æ–‡ä»¶ç›®å½•DiskLruCache cache = DiskLruCache.open(cacheDir, appVersion, 2, Integer.MAX_VALUE);// å­˜æˆ–è€…æ›´æ”¹æ•°æ®DiskLruCache.Editor creator = cache.edit(&quot;k1&quot;);creator.set(0, &quot;A&quot;);creator.set(1, &quot;B&quot;);// è¦è°ƒç”¨è¿™ä¸ªcreator.commit();cache.close();// è¯»å–æ•°æ®DiskLruCache.Snapshot snapshot = cache.get(&quot;k1&quot;);String data = snapshot.getString(0);snapshot.close(); æºç åˆ†æ å±æ€§ åœ¨DiskLruCache ä¸­æœ‰ä¸‰ç§æ–‡ä»¶ï¼Œä¸€ä¸ªæ˜¯æ—¥å¿—æ–‡ä»¶ï¼Œé‡Œé¢æ˜¯æˆ‘ä»¬æ“ä½œçš„è®°å½•ï¼Œè¿˜æœ‰ä¸´æ—¶æ–‡ä»¶ï¼Œå­˜åœ¨çš„æ˜¯æˆ‘ä»¬çš„Valueæ•°æ®ï¼Œåœ¨æœªæäº¤å‰ï¼Œä¸€ä¸ªæ˜¯å¤‡ä»½æ–‡ä»¶ï¼Œå¯ä»è¿™ä¸ªé‡Œé¢æ¢å¤æ•°æ®ã€‚lruEntries æ˜¯keyçš„é›†åˆï¼Œä½¿ç”¨äº† LinkedHashMapï¼ŒäºLruCacheä¸€æ ·ï¼ŒredundantOpCount æ˜¯é‡Œé¢å†—ä½™æ“ä½œçš„æ¬¡æ•°ï¼Œå½“è¿™ä¸ªå€¼å¤§äº2000ï¼Œä¼štrimToSizeï¼Œé‡æ–°æ„å»ºæ—¥å¿—æ–‡ä»¶ 123456789101112private final File directory;private final File journalFile;private final File journalFileTmp;private final File journalFileBackup;private final int appVersion;private long maxSize;private final int valueCount;private long size = 0;private Writer journalWriter;private final LinkedHashMap&lt;String, Entry&gt; lruEntries = new LinkedHashMap&lt;String, Entry&gt;(0, 0.75f, true);private int redundantOpCount; æ—¥å¿—æ–‡ä»¶çš„æ ¼å¼ï¼Œå‰å‡ è¡Œæ˜¯æ–‡ä»¶å¤´ï¼Œåé¢æ˜¯æ“ä½œè®°å½• 123456789101112131415* This cache uses a journal file named &quot;journal&quot;. A typical journal file* looks like this:* libcore.io.DiskLruCache* 1* 100* 2** CLEAN 3400330d1dfc7f3f7f4b8d4d803dfcf6 832 21054* DIRTY 335c4c6028171cfddfbaae1a9c313c52* CLEAN 335c4c6028171cfddfbaae1a9c313c52 3934 2342* REMOVE 335c4c6028171cfddfbaae1a9c313c52* DIRTY 1ab96a171faeeee38496d8b330771a7a* CLEAN 1ab96a171faeeee38496d8b330771a7a 1600 234* READ 335c4c6028171cfddfbaae1a9c313c52* READ 3400330d1dfc7f3f7f4b8d4d803dfcf6 çœ‹ä¸€ä¸‹å¦‚ä½•å»ºç«‹ä¸€ä¸ªå®ä¾‹ï¼Œé¦–å…ˆæŸ¥çœ‹æ˜¯å¦æœ‰å¤‡ä»½æ–‡ä»¶ï¼Œå¦‚æœæœ‰çš„è¯ï¼Œåœ¨æ£€æŸ¥æ˜¯å¦æœ‰æ—¥å¿—æ–‡ä»¶ï¼Œé¦–æ¬¡åˆ›å»ºæ—¶æ²¡æœ‰ä»»ä½•æ–‡ä»¶ï¼Œå› æ­¤ä¼šæ‰§è¡Œåˆ° directory.mkdirs() ç„¶årebuildJournalï¼Œ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354/** * Opens the cache in &#123;@code directory&#125;, creating a cache if none exists * there. * * @param directory a writable directory * @param valueCount the number of values per cache entry. Must be positive. * @param maxSize the maximum number of bytes this cache should use to store * @throws IOException if reading or writing the cache directory fails */public static DiskLruCache open(File directory, int appVersion, int valueCount, long maxSize) throws IOException &#123; if (maxSize &lt;= 0) &#123; throw new IllegalArgumentException(&quot;maxSize &lt;= 0&quot;); &#125; if (valueCount &lt;= 0) &#123; throw new IllegalArgumentException(&quot;valueCount &lt;= 0&quot;); &#125; // If a bkp file exists, use it instead. File backupFile = new File(directory, JOURNAL_FILE_BACKUP); if (backupFile.exists()) &#123; File journalFile = new File(directory, JOURNAL_FILE); // If journal file also exists just delete backup file. if (journalFile.exists()) &#123; backupFile.delete(); &#125; else &#123; renameTo(backupFile, journalFile, false); &#125; &#125; // Prefer to pick up where we left off. DiskLruCache cache = new DiskLruCache(directory, appVersion, valueCount, maxSize); if (cache.journalFile.exists()) &#123; try &#123; cache.readJournal(); cache.processJournal(); return cache; &#125; catch (IOException journalIsCorrupt) &#123; System.out .println(&quot;DiskLruCache &quot; + directory + &quot; is corrupt: &quot; + journalIsCorrupt.getMessage() + &quot;, removing&quot;); cache.delete(); &#125; &#125; // Create a new empty cache. directory.mkdirs(); cache = new DiskLruCache(directory, appVersion, valueCount, maxSize); cache.rebuildJournal(); return cache;&#125; çº¿ç¨‹å®‰å…¨çš„ï¼Œé¦–å…ˆä½¿ç”¨å°†æ–‡ä»¶å¤´å†™å…¥ï¼Œå†å°†entryå†™å…¥ï¼Œæœ€ååˆ¤æ–­ journal æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨ï¼Œé‚£ä¹ˆç°å°†å…¶æ”¹ä¸ºå¤‡ä»½æ–‡ä»¶ï¼Œä¹‹åæŠŠä¸´æ—¶æ–‡ä»¶æ”¹æˆæ—¥å¿—æ–‡ä»¶ï¼Œåˆ é™¤å¤‡ä»½æ–‡ä»¶ï¼Œæ€»ä¹‹å°±æ˜¯è¦ç•™ä¸‹ä¸€ä¸ªæ—¥å¿—æ–‡ä»¶ï¼Œæœ€ååˆ›å»ºä¸€ä¸ª JournalWriterï¼Œè¿½åŠ æ¨¡å¼ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152/** * Creates a new journal that omits redundant information. This replaces the * current journal if it exists. */private synchronized void rebuildJournal() throws IOException &#123; if (journalWriter != null) &#123; journalWriter.close(); &#125; Writer writer = new BufferedWriter( new OutputStreamWriter(new FileOutputStream(journalFileTmp), Util.US_ASCII)); try &#123; writer.write(MAGIC); writer.write(&quot;\\n&quot;); writer.write(VERSION_1); writer.write(&quot;\\n&quot;); writer.write(Integer.toString(appVersion)); writer.write(&quot;\\n&quot;); writer.write(Integer.toString(valueCount)); writer.write(&quot;\\n&quot;); writer.write(&quot;\\n&quot;); // æ¯ä¸€ä¸ª entry ä¼šæœ‰ä¸€ä¸ªEditor for (Entry entry : lruEntries.values()) &#123; if (entry.currentEditor != null) &#123; writer.write(DIRTY + &apos; &apos; + entry.key + &apos;\\n&apos;); &#125; else &#123; writer.write(CLEAN + &apos; &apos; + entry.key + entry.getLengths() + &apos;\\n&apos;); &#125; &#125; &#125; finally &#123; writer.close(); &#125; if (journalFile.exists()) &#123; renameTo(journalFile, journalFileBackup, true); &#125; renameTo(journalFileTmp, journalFile, false); journalFileBackup.delete(); journalWriter = new BufferedWriter( new OutputStreamWriter(new FileOutputStream(journalFile, true), Util.US_ASCII));&#125;// é€šè¿‡æ”¹åæ¥å¤åˆ¶æ–‡ä»¶å†…å®¹private static void renameTo(File from, File to, boolean deleteDestination) throws IOException &#123; if (deleteDestination) &#123; deleteIfExists(to); &#125; if (!from.renameTo(to)) &#123; throw new IOException(); &#125;&#125; çœ‹ä¸€ä¸‹ Entryï¼Œä¸»è¦æ˜¯Keyå’ŒvalueCountï¼Œè¿˜æœ‰ä¸€ä¸ª currentEditor 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455private final class Entry &#123; private final String key; /** Lengths of this entry&apos;s files. */ private final long[] lengths; /** True if this entry has ever been published. */ private boolean readable; /** The ongoing edit or null if this entry is not being edited. */ private Editor currentEditor; /** The sequence number of the most recently committed edit to this entry. */ private long sequenceNumber; private Entry(String key) &#123; this.key = key; this.lengths = new long[valueCount]; &#125; public String getLengths() throws IOException &#123; StringBuilder result = new StringBuilder(); for (long size : lengths) &#123; result.append(&apos; &apos;).append(size); &#125; return result.toString(); &#125; /** Set lengths using decimal numbers like &quot;10123&quot;. */ private void setLengths(String[] strings) throws IOException &#123; if (strings.length != valueCount) &#123; throw invalidLengths(strings); &#125; try &#123; for (int i = 0; i &lt; strings.length; i++) &#123; lengths[i] = Long.parseLong(strings[i]); &#125; &#125; catch (NumberFormatException e) &#123; throw invalidLengths(strings); &#125; &#125; private IOException invalidLengths(String[] strings) throws IOException &#123; throw new IOException(&quot;unexpected journal line: &quot; + java.util.Arrays.toString(strings)); &#125; public File getCleanFile(int i) &#123; return new File(directory, key + &quot;.&quot; + i); &#125; public File getDirtyFile(int i) &#123; return new File(directory, key + &quot;.&quot; + i + &quot;.tmp&quot;); &#125; &#125; çœ‹ä¸€ä¸‹åˆå§‹åŒ–ï¼Œé¦–å…ˆçœ‹ä¸€ä¸‹ï¼Œé€šå¸¸ä¼šæ–°å»ºä¸€ä¸ªentryï¼Œæˆ–è€…è¯»å–ï¼Œç„¶åç»‘å®šä¸€ä¸ªEditorï¼Œå†™æ—¥å¿— 123456789101112131415161718192021222324252627public Editor edit(String key) throws IOException &#123; return edit(key, ANY_SEQUENCE_NUMBER);&#125;private synchronized Editor edit(String key, long expectedSequenceNumber) throws IOException &#123; checkNotClosed(); validateKey(key); Entry entry = lruEntries.get(key); if (expectedSequenceNumber != ANY_SEQUENCE_NUMBER &amp;&amp; (entry == null || entry.sequenceNumber != expectedSequenceNumber)) &#123; return null; // Snapshot is stale. &#125; if (entry == null) &#123; entry = new Entry(key); lruEntries.put(key, entry); &#125; else if (entry.currentEditor != null) &#123; return null; // Another edit is in progress. &#125; Editor editor = new Editor(entry); entry.currentEditor = editor; // Flush the journal before creating files to prevent file leaks. journalWriter.write(DIRTY + &apos; &apos; + key + &apos;\\n&apos;); journalWriter.flush(); return editor;&#125; Editor çš„å®ç°ï¼Œä¸€ä¸ªEntryå¯¹åº”ä¸€ä¸ªEditorï¼Œé€šå¸¸æˆ‘ä»¬ä¼šé€šè¿‡Editor set getæ•°æ®ï¼Œ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121/** Edits the values for an entry. */public final class Editor &#123; private final Entry entry; private final boolean[] written; private boolean hasErrors; private boolean committed; private Editor(Entry entry) &#123; this.entry = entry; this.written = (entry.readable) ? null : new boolean[valueCount]; &#125; /** * Returns an unbuffered input stream to read the last committed value, * or null if no value has been committed. */ public InputStream newInputStream(int index) throws IOException &#123; synchronized (DiskLruCache.this) &#123; if (entry.currentEditor != this) &#123; throw new IllegalStateException(); &#125; if (!entry.readable) &#123; return null; &#125; try &#123; return new FileInputStream(entry.getCleanFile(index)); &#125; catch (FileNotFoundException e) &#123; return null; &#125; &#125; &#125; /** * Returns the last committed value as a string, or null if no value * has been committed. */ public String getString(int index) throws IOException &#123; InputStream in = newInputStream(index); return in != null ? inputStreamToString(in) : null; &#125; /** Sets the value at &#123;@code index&#125; to &#123;@code value&#125;. */ public void set(int index, String value) throws IOException &#123; Writer writer = null; try &#123; writer = new OutputStreamWriter(newOutputStream(index), Util.UTF_8); writer.write(value); &#125; finally &#123; Util.closeQuietly(writer); &#125; &#125; /** * Commits this edit so it is visible to readers. This releases the * edit lock so another edit may be started on the same key. */ public void commit() throws IOException &#123; if (hasErrors) &#123; completeEdit(this, false); remove(entry.key); // The previous entry is stale. &#125; else &#123; completeEdit(this, true); &#125; committed = true; &#125; /** * Aborts this edit. This releases the edit lock so another edit may be * started on the same key. */ public void abort() throws IOException &#123; completeEdit(this, false); &#125; public void abortUnlessCommitted() &#123; if (!committed) &#123; try &#123; abort(); &#125; catch (IOException ignored) &#123; &#125; &#125; &#125; private class FaultHidingOutputStream extends FilterOutputStream &#123; private FaultHidingOutputStream(OutputStream out) &#123; super(out); &#125; @Override public void write(int oneByte) &#123; try &#123; out.write(oneByte); &#125; catch (IOException e) &#123; hasErrors = true; &#125; &#125; @Override public void write(byte[] buffer, int offset, int length) &#123; try &#123; out.write(buffer, offset, length); &#125; catch (IOException e) &#123; hasErrors = true; &#125; &#125; @Override public void close() &#123; try &#123; out.close(); &#125; catch (IOException e) &#123; hasErrors = true; &#125; &#125; @Override public void flush() &#123; try &#123; out.flush(); &#125; catch (IOException e) &#123; hasErrors = true; &#125; &#125; &#125;&#125; è·å–ä¸€ä¸ªOuputStreamï¼Œæ³¨æ„ï¼Œæ¯ä¸ªindexæ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œè€Œä¸”ä¸èƒ½è¶…è¿‡valueCountï¼Œç”¨äº†å…¨å±€é”ï¼Œå†™çš„æ—¶å€™ä½¿ç”¨äº† dirtyFileï¼Œè¿™æ˜¯ä¸€ä¸ªä¸´æ—¶æ–‡ä»¶ï¼Œç­‰commitäº†ä¼šæŠŠè¿™ä¸ªæ–‡ä»¶å˜ä¸ºæ­£å¼æ–‡ä»¶ 12345678910111213141516171819202122232425262728293031323334353637/** * Returns a new unbuffered output stream to write the value at * &#123;@code index&#125;. If the underlying output stream encounters errors * when writing to the filesystem, this edit will be aborted when * &#123;@link #commit&#125; is called. The returned output stream does not throw * IOExceptions. */ public OutputStream newOutputStream(int index) throws IOException &#123; if (index &lt; 0 || index &gt;= valueCount) &#123; throw new IllegalArgumentException(&quot;Expected index &quot; + index + &quot; to &quot; + &quot;be greater than 0 and less than the maximum value count &quot; + &quot;of &quot; + valueCount); &#125; synchronized (DiskLruCache.this) &#123; if (entry.currentEditor != this) &#123; throw new IllegalStateException(); &#125; if (!entry.readable) &#123; written[index] = true; &#125; File dirtyFile = entry.getDirtyFile(index); FileOutputStream outputStream; try &#123; outputStream = new FileOutputStream(dirtyFile); &#125; catch (FileNotFoundException e) &#123; // Attempt to recreate the cache directory. directory.mkdirs(); try &#123; outputStream = new FileOutputStream(dirtyFile); &#125; catch (FileNotFoundException e2) &#123; // We are unable to recover. Silently eat the writes. return NULL_OUTPUT_STREAM; &#125; &#125; return new FaultHidingOutputStream(outputStream); &#125; &#125; æäº¤çš„æ—¶å€™ï¼Œä¼šé”ä½æ•´ä¸ªå®ä¾‹ï¼Œ 123456789101112131415161718192021222324252627282930313233343536373839private synchronized void completeEdit(Editor editor, boolean success) throws IOException &#123; Entry entry = editor.entry; // çœç•¥ .... // æŠŠdirtyæ–‡ä»¶å˜ä¸ºæ­£å¼æ–‡ä»¶ for (int i = 0; i &lt; valueCount; i++) &#123; File dirty = entry.getDirtyFile(i); if (success) &#123; if (dirty.exists()) &#123; File clean = entry.getCleanFile(i); dirty.renameTo(clean); long oldLength = entry.lengths[i]; long newLength = clean.length(); entry.lengths[i] = newLength; size = size - oldLength + newLength; &#125; &#125; else &#123; deleteIfExists(dirty); &#125; &#125; // å¢åŠ ä¸€æ¬¡æ“ä½œ redundantOpCount++; entry.currentEditor = null; if (entry.readable | success) &#123; entry.readable = true; journalWriter.write(CLEAN + &apos; &apos; + entry.key + entry.getLengths() + &apos;\\n&apos;); if (success) &#123; entry.sequenceNumber = nextSequenceNumber++; &#125; &#125; else &#123; lruEntries.remove(entry.key); journalWriter.write(REMOVE + &apos; &apos; + entry.key + &apos;\\n&apos;); &#125; journalWriter.flush(); // æ˜¯å¦éœ€è¦æ¸…é™¤æ•°æ® if (size &gt; maxSize || journalRebuildRequired()) &#123; executorService.submit(cleanupCallable); &#125;&#125; æ‰§è¡Œæ¸…é™¤æ•°æ®çš„è¿‡ç¨‹ 1234567891011121314151617181920212223242526/** This cache uses a single background thread to evict entries. */final ThreadPoolExecutor executorService = new ThreadPoolExecutor(0, 1, 60L, TimeUnit.SECONDS, new LinkedBlockingQueue&lt;Runnable&gt;());private final Callable&lt;Void&gt; cleanupCallable = new Callable&lt;Void&gt;() &#123; public Void call() throws Exception &#123; synchronized (DiskLruCache.this) &#123; if (journalWriter == null) &#123; return null; // Closed. &#125; trimToSize(); if (journalRebuildRequired()) &#123; rebuildJournal(); redundantOpCount = 0; &#125; &#125; return null; &#125;&#125;;// è®¿é—®è¿‡å¾—èŠ‚ç‚¹ä¼šè¢«ç§»åŠ¨åˆ°æœ«å°¾ï¼Œé“¾é¦–çš„æ•°æ®éƒ½æ˜¯è€æ•°æ®ï¼Œ// æ–°æ•°æ®éƒ½æ˜¯æ·»åŠ åˆ°é“¾å°¾ï¼Œæ¯æ¬¡è¢«è®¿é—®çš„æ•°æ®ä¹Ÿä¼šè¢«æ”¾å…¥é“¾å°¾private void trimToSize() throws IOException &#123; while (size &gt; maxSize) &#123; Map.Entry&lt;String, Entry&gt; toEvict = lruEntries.entrySet().iterator().next(); remove(toEvict.getKey()); &#125;&#125; æˆ‘ä»¬å†å›è¿‡å¤´çœ‹ä¸€ä¸‹ï¼Œå¦‚æœç¼“å­˜æ–‡ä»¶å­˜åœ¨ï¼Œé‚£ä¹ˆåˆ™è¯»å–æ—¥å¿—æ–‡ä»¶ï¼Œé¦–å…ˆæ£€æŸ¥æ–‡ä»¶å¤´ï¼Œå†è¯»å–æ“ä½œè®°å½•ï¼ŒredundantOpCount = lineCount - lruEntries.size() è¿™é‡Œè®°å½•äº†å†—ä½™æ“ä½œçš„æ¬¡æ•°ï¼Œå½“è¿™ä¸ªæ•°å¤§äº2000 æ—¶ï¼Œåˆ™é‡æ–°æ„å»ºæ—¥å¿—æ–‡ä»¶ï¼Œé‡æ–°æ„å»ºä¼šåˆ é™¤ä¹‹å‰çš„æ“ä½œè®°å½•ï¼Œè¿™æ ·æœ‰åˆ©äºæ—¥å¿—æ–‡ä»¶å¤§å°çš„æ§åˆ¶ 123456789101112131415161718192021222324252627282930313233343536373839private void readJournal() throws IOException &#123; StrictLineReader reader = new StrictLineReader(new FileInputStream(journalFile), Util.US_ASCII); try &#123; String magic = reader.readLine(); String version = reader.readLine(); String appVersionString = reader.readLine(); String valueCountString = reader.readLine(); String blank = reader.readLine(); if (!MAGIC.equals(magic) || !VERSION_1.equals(version) || !Integer.toString(appVersion).equals(appVersionString) || !Integer.toString(valueCount).equals(valueCountString) || !&quot;&quot;.equals(blank)) &#123; throw new IOException(&quot;unexpected journal header: [&quot; + magic + &quot;, &quot; + version + &quot;, &quot; + valueCountString + &quot;, &quot; + blank + &quot;]&quot;); &#125; int lineCount = 0; while (true) &#123; try &#123; readJournalLine(reader.readLine()); lineCount++; &#125; catch (EOFException endOfJournal) &#123; break; &#125; &#125; redundantOpCount = lineCount - lruEntries.size(); // If we ended on a truncated line, rebuild the journal before appending to it. if (reader.hasUnterminatedLine()) &#123; rebuildJournal(); &#125; else &#123; journalWriter = new BufferedWriter(new OutputStreamWriter( new FileOutputStream(journalFile, true), Util.US_ASCII)); &#125; &#125; finally &#123; Util.closeQuietly(reader); &#125;&#125; å°ç»“ æ ¸å¿ƒæ€æƒ³ï¼šLruCacheï¼Œåˆ©ç”¨LinkedHashMapå­˜å‚¨Keyï¼Œå°†Valueå­˜äºæ–‡ä»¶ï¼Œä¸€ä¸ªKeyï¼Œä¸€ä¸ªvalueå¯¹åº”ä¸€ä¸ªæ–‡ä»¶å„ä¸å½±å“ã€‚","categories":[{"name":"Android","slug":"Android","permalink":"https://wzes.github.io/categories/Android/"}],"tags":[{"name":"Android","slug":"Android","permalink":"https://wzes.github.io/tags/Android/"}]},{"title":"Android OkHttp3 æºç è§£æ","slug":"Android/OkHttp3","date":"2018-08-23T11:30:00.000Z","updated":"2019-09-02T12:19:12.575Z","comments":true,"path":"2018/08/23/Android/OkHttp3/","link":"","permalink":"https://wzes.github.io/2018/08/23/Android/OkHttp3/","excerpt":"","text":"å‰è¨€ æ€»è§‰å¾—ç½‘ç»œè¿™ä¸€å—ä¸æ˜¯é‚£ä¹ˆçš„ç†Ÿæ‚‰ï¼Œä¹Ÿæ‰¾ä¸åˆ°çªé—¨ï¼Œç´¢æ€§çœ‹ä¸€ä¸ªç½‘ç»œè¯·æ±‚æ¡†æ¶ï¼Œæ¥åŠ æ·±è‡ªå·±å¯¹ç½‘ç»œè¯·æ±‚çš„è®¤è¯†ã€‚è¿™ä¸ªç³»åˆ—åº”è¯¥ä¼šå¾ˆé•¿ï¼Œæ¯•ç«Ÿè¿™ä¸ªåº“ä¹Ÿä¸ç®€å•ï¼Œé‡Œé¢åŒ…å«äº†å¾ˆå¤šçŸ¥è¯†ï¼Œæˆ‘ä¼šå…ˆä»ä½¿ç”¨ï¼Œå†åˆ°ç®€å• APIæºç  çš„åˆ†æï¼Œå†åˆ°æ¡†æ¶å†…éƒ¨å„ä¸ªæ¨¡å—çš„ä»”ç»†ç ”è¯»è¿™æ ·ä¸€ä¸ªé¡ºåºå»åˆ†æã€‚ OkHttp3 è¿™ä¸ªåº“å¯ä»¥è¯´æ˜¯å¾ˆä¼˜ç§€ï¼Œä½¿ç”¨èµ·æ¥ä¹Ÿå¾ˆç®€å•ï¼Œå…³é”®æ˜¯ï¼Œä½ å¯ä»¥å¯¹å®ƒè¿›è¡Œå„ç§å®šåˆ¶ï¼Œæ¥åšåˆ°å„ç§å„æ ·çš„åŠŸèƒ½ï¼Œåœ¨Android ä¸­ï¼ŒRetrofit åº•å±‚å°±æ˜¯ç”¨ OkHttpClient å»å®ç°çš„ã€‚OkHttp è™½ç„¶æ²¡æœ‰æµè§ˆå™¨é‚£ä¹ˆå¼ºå¤§ï¼Œä½†ä»–å†…éƒ¨å®ç°äº†å¾ˆå¤šè¯·æ±‚æœåŠ¡å™¨æ•°æ®çš„åœºæ™¯ï¼Œèƒ½å¤„ç†å¾ˆå¤šä¸åŒçš„ç»“æœï¼Œæ¯”å¦‚å¸¸è§çš„ 100 101 Continue 301 302 é‡å®šå‘ç­‰ç­‰ï¼Œé‡åˆ°301ï¼Œåˆ™ä¼šè§¦å‘é‡å®šå‘ï¼Œä»Response é‡Œè¾¹å–å‡º Location ï¼Œç„¶åå†å°è£… Requestï¼Œé‡æ–°è®¿é—®ã€‚è¿™äº›å®ƒåœ¨å†…éƒ¨å¸®æˆ‘ä»¬ç›´æ¥å»å®ç°ï¼Œé‡Œé¢è¿˜æœ‰è¯·æ±‚çš„ç¼“å­˜ï¼Œåº”è¯¥æ˜¯æ ¹æ®æœåŠ¡ç«¯çš„Cache-Control æ¥åšçš„ï¼Œè¿˜æœ‰ HTTP çš„è¿æ¥å¤ç”¨ï¼Œå®ƒæ”¯æŒ HTTP1.1 HTTP2 ä¹Ÿæ”¯æŒ HTTPSï¼Œåº•å±‚åˆ†åˆ«ä½¿ç”¨ Socket å’Œ sslSocket å†™çš„ã€‚å¦å¤–ï¼Œå®ƒæä¾›äº†åŒæ­¥ï¼Œå¼‚æ­¥çš„è¯·æ±‚æ–¹å¼ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿ä½¿ç”¨è€…è¿›è¡Œè°ƒç”¨ã€‚è¯´äº†å¾ˆå¤šç‰¹æ€§ï¼Œä½†æˆ‘ç›®å‰ä»…ä»…æ˜¯ä¸€ä¸ªæŠ½è±¡ï¼Œå¾ˆéš¾è¯´æ¸…æ¥šé‡Œé¢çš„å®ç°ï¼Œæ‰€ä»¥å°±æƒ³å¥½å¥½å»çœ‹ä¸€ä¸‹é‡Œé¢çš„å®ç°åŸç†ï¼Œæå‡ä¸€ä¸‹å†…åŠŸ ä½¿ç”¨ç¯‡ å®˜æ–¹çš„ GET Sample 123456789101112131415161718192021222324252627import java.io.IOException;import okhttp3.OkHttpClient;import okhttp3.Request;import okhttp3.Response;public class GetExample &#123; // é¦–å…ˆæ„å»ºä¸€ä¸ª OkHttpClient ï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ Builder å»æ„å»º OkHttpClient client = new OkHttpClient(); String run(String url) throws IOException &#123; // æ„å»ºä¸€ä¸ª Request é»˜è®¤æ˜¯ GET è¯·æ±‚ Request request = new Request.Builder() .url(url) .build(); // åŒæ­¥çš„æ–¹å¼å»æ‰§è¡Œ // è¿”å›ä¸€ä¸ª Response å¯¹è±¡ try (Response response = client.newCall(request).execute()) &#123; return response.body().string(); &#125; &#125; public static void main(String[] args) throws IOException &#123; GetExample example = new GetExample(); String response = example.run(&quot;https://raw.github.com/square/okhttp/master/README.md&quot;); System.out.println(response); &#125;&#125; POST Sample 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152import java.io.IOException;import okhttp3.MediaType;import okhttp3.OkHttpClient;import okhttp3.Request;import okhttp3.RequestBody;import okhttp3.Response;public class PostExample &#123; public static final MediaType JSON = MediaType.get(&quot;application/json; charset=utf-8&quot;); OkHttpClient client = new OkHttpClient(); // åœ¨æ„å»ºä¸€ä¸ª Request çš„æ—¶å€™ï¼Œæäº¤ä¸€ä¸ª body // é€šè¿‡ RequestBody.create() æ¥åˆ›å»ºä¸€ä¸ª Json æ ¼å¼çš„ body String post(String url, String json) throws IOException &#123; RequestBody body = RequestBody.create(JSON, json); Request request = new Request.Builder() .url(url) .post(body) .build(); // ä¸€ä¸ªå°å°çš„APIï¼Œä¼šåœ¨è¯·æ±‚ç»“æŸåè°ƒç”¨ client.dispatcher().setIdleCallback(new Runnable() &#123; @Override public void run() &#123; System.out.println(&quot;Request is Over&quot;); &#125; &#125;); try (Response response = client.newCall(request).execute()) &#123; return response.body().string(); &#125; &#125; String bowlingJson(String player1, String player2) &#123; return &quot;&#123;&apos;winCondition&apos;:&apos;HIGH_SCORE&apos;,&quot; + &quot;&apos;name&apos;:&apos;Bowling&apos;,&quot; + &quot;&apos;round&apos;:4,&quot; + &quot;&apos;lastSaved&apos;:1367702411696,&quot; + &quot;&apos;dateStarted&apos;:1367702378785,&quot; + &quot;&apos;players&apos;:[&quot; + &quot;&#123;&apos;name&apos;:&apos;&quot; + player1 + &quot;&apos;,&apos;history&apos;:[10,8,6,7,8],&apos;color&apos;:-13388315,&apos;total&apos;:39&#125;,&quot; + &quot;&#123;&apos;name&apos;:&apos;&quot; + player2 + &quot;&apos;,&apos;history&apos;:[6,10,5,10,10],&apos;color&apos;:-48060,&apos;total&apos;:41&#125;&quot; + &quot;]&#125;&quot;; &#125; public static void main(String[] args) throws IOException &#123; PostExample example = new PostExample(); String json = example.bowlingJson(&quot;Jesse&quot;, &quot;Jake&quot;); String response = example.post(&quot;http://www.roundsapp.com/post&quot;, json); System.out.println(response); &#125;&#125; å¯ä»¥çœ‹åˆ°ï¼ŒGETï¼ŒPOST è¿˜æ˜¯æŒºç®€å•çš„ï¼Œä¸ºäº†æ»¡è¶³å¥½å¥‡å¿ƒï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸ªæ–¹æ³•çš„æºç ï¼ŒOkHttpClient çš„ newCall æ–¹æ³•ï¼Œç±»ä¼¼å·¥å‚çš„æ–¹æ³•ï¼Œæ„å»ºä¸€ä¸ª RealCall çš„ï¼Œç„¶åè°ƒç”¨ RealCall çš„ execute æ–¹æ³•æ‰§è¡Œ 1234567891011121314151617181920212223242526272829303132333435363738394041424344@Override public Call newCall(Request request) &#123; return RealCall.newRealCall(this, request, false /* for web socket */);&#125;@Override public Response execute() throws IOException &#123; synchronized (this) &#123; if (executed) throw new IllegalStateException(&quot;Already Executed&quot;); executed = true; &#125; captureCallStackTrace(); eventListener.callStart(this); try &#123; // åªæ˜¯æ”¾å…¥åŒæ­¥é˜Ÿåˆ— client.dispatcher().executed(this); // çœŸæ­£çš„ç½‘ç»œè°ƒç”¨åœ¨è¿™ä¸ªåœ°æ–¹ Response result = getResponseWithInterceptorChain(); if (result == null) throw new IOException(&quot;Canceled&quot;); return result; &#125; catch (IOException e) &#123; eventListener.callFailed(this, e); throw e; &#125; finally &#123; // ç»“æŸé‚£ä¸ªä»»åŠ¡ client.dispatcher().finished(this); &#125;&#125;// ä»é˜Ÿåˆ—é‡Œé¢ç§»é™¤ä¸€ä¸ª callprivate &lt;T&gt; void finished(Deque&lt;T&gt; calls, T call, boolean promoteCalls) &#123; int runningCallsCount; Runnable idleCallback; synchronized (this) &#123; // ç§»é™¤ if (!calls.remove(call)) throw new AssertionError(&quot;Call wasn&apos;t in-flight!&quot;); // è§¦å‘ä»»åŠ¡ if (promoteCalls) promoteCalls(); runningCallsCount = runningCallsCount(); idleCallback = this.idleCallback; &#125; // dispatcher çš„apiï¼Œé€šè¿‡ client è·å–ç„¶åè®¾ç½® if (runningCallsCount == 0 &amp;&amp; idleCallback != null) &#123; idleCallback.run(); &#125;&#125; ä¸‹é›†é¢„å‘Šï¼ŒOkHttp çš„æ ¸å¿ƒï¼Œè¯·æ±‚é“¾éƒ½æ˜¯åœ¨è¿™ä¸ªè¿™ä¸ªæ–¹æ³•é‡Œï¼Œè°ƒç”¨æ˜¯ä»ä¸Šå¾€ä¸‹ï¼Œåˆä»ä¸‹ä¼ åˆ°æœ€ä¸Šï¼Œå¦‚æœåˆ°äº† CallServerInterceptorï¼Œå®ƒæŠŠæ•°æ®å‘åˆ°æœåŠ¡ç«¯ï¼Œç„¶åè·å–ç»“æœï¼Œå†è¿”å›ç»™ä¸Šå±‚å¤„ç† RetryAndFollowUpInterceptor BridgeInterceptor CacheInterceptor ConnectInterceptor CallServerInterceptor 12345678910111213141516171819Response getResponseWithInterceptorChain() throws IOException &#123; // Build a full stack of interceptors. List&lt;Interceptor&gt; interceptors = new ArrayList&lt;&gt;(); interceptors.addAll(client.interceptors()); interceptors.add(retryAndFollowUpInterceptor); interceptors.add(new BridgeInterceptor(client.cookieJar())); interceptors.add(new CacheInterceptor(client.internalCache())); interceptors.add(new ConnectInterceptor(client)); if (!forWebSocket) &#123; interceptors.addAll(client.networkInterceptors()); &#125; interceptors.add(new CallServerInterceptor(forWebSocket)); Interceptor.Chain chain = new RealInterceptorChain(interceptors, null, null, null, 0, originalRequest, this, eventListener, client.connectTimeoutMillis(), client.readTimeoutMillis(), client.writeTimeoutMillis()); return chain.proceed(originalRequest);&#125; å°ç»“ æˆ‘ä»¬å¤§è‡´çŸ¥é“äº†æµç¨‹ï¼Œå°±æ˜¯å…ˆåˆ›å»ºä¸€ä¸ª OkHttpClientï¼Œç„¶åå†åˆ›å»ºä¸€ä¸ª Requestï¼Œç„¶åå†è°ƒç”¨ newCall æ‰§è¡Œï¼Œæš‚æ—¶æˆ‘ä»¬çœ‹äº†åŒæ­¥çš„æ–¹å¼ å‰è¨€ ä¹‹å‰æˆ‘ä»¬æŒæ¡äº† OkHttpClient çš„åŸºæœ¬ä½¿ç”¨ï¼Œåœ¨æœ€åé¢æˆ‘ä»¬æŠ›å‡ºäº†å¾ˆå¤š Interceptorï¼Œç°åœ¨æˆ‘ä»¬çœ‹ä¸€ä¸‹ Interceptor åˆ°åº•æ˜¯ä»€ä¹ˆä¸œè¥¿ï¼Œè‹±æ–‡æ˜¯æ‹¦æˆªå™¨çš„æ„æ€ï¼Œå½“æˆ‘çœ‹äº†æºç åï¼Œæˆ‘è§‰å¾—æˆ‘æ›´å®¹æ˜“ç†è§£çš„æ˜¯ï¼Œå¤„ç†å™¨ å®šä¹‰ å¦‚æœå®šä¹‰è‡ªå·±çš„ interceptorï¼Œè¦å®ç° interceptï¼Œé‡Œé¢æœ‰ä¸€ä¸ªå†…éƒ¨ç±» Chain ï¼Œé“¾ 1234567891011121314151617181920212223242526272829public interface Interceptor &#123; Response intercept(Chain chain) throws IOException; interface Chain &#123; Request request(); Response proceed(Request request) throws IOException; /** * Returns the connection the request will be executed on. This is only available in the chains * of network interceptors; for application interceptors this is always null. */ @Nullable Connection connection(); Call call(); int connectTimeoutMillis(); Chain withConnectTimeout(int timeout, TimeUnit unit); int readTimeoutMillis(); Chain withReadTimeout(int timeout, TimeUnit unit); int writeTimeoutMillis(); Chain withWriteTimeout(int timeout, TimeUnit unit); &#125;&#125; å†çœ‹ä¸€ä¸‹è¿™ä¸ªå‡½æ•°ï¼Œå¦‚æœæˆ‘ä»¬æ²¡æœ‰è‡ªå®šä¹‰çš„ interceptorï¼Œæœ€å…ˆçš„æ˜¯RetryAndFollowUpInterceptorï¼Œä»–æ˜¯ä¸€ä¸ª é‡è¯•å’Œé‡å®šå‘çš„æ‹¦æˆªå™¨ 12345678910111213141516171819Response getResponseWithInterceptorChain() throws IOException &#123; // Build a full stack of interceptors. List&lt;Interceptor&gt; interceptors = new ArrayList&lt;&gt;(); interceptors.addAll(client.interceptors()); interceptors.add(retryAndFollowUpInterceptor); interceptors.add(new BridgeInterceptor(client.cookieJar())); interceptors.add(new CacheInterceptor(client.internalCache())); interceptors.add(new ConnectInterceptor(client)); if (!forWebSocket) &#123; interceptors.addAll(client.networkInterceptors()); &#125; interceptors.add(new CallServerInterceptor(forWebSocket)); Interceptor.Chain chain = new RealInterceptorChain(interceptors, null, null, null, 0, originalRequest, this, eventListener, client.connectTimeoutMillis(), client.readTimeoutMillis(), client.writeTimeoutMillis()); return chain.proceed(originalRequest);&#125; æˆ‘ä»¬çœ‹ä¸€ä¸‹ RealInterceptorChainï¼Œ ä»–å®ç°äº† Interceptor.Chain 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132public final class RealInterceptorChain implements Interceptor.Chain &#123; private final List&lt;Interceptor&gt; interceptors; private final StreamAllocation streamAllocation; private final HttpCodec httpCodec; private final RealConnection connection; private final int index; private final Request request; private final Call call; private final EventListener eventListener; private final int connectTimeout; private final int readTimeout; private final int writeTimeout; private int calls; public RealInterceptorChain(List&lt;Interceptor&gt; interceptors, StreamAllocation streamAllocation, HttpCodec httpCodec, RealConnection connection, int index, Request request, Call call, EventListener eventListener, int connectTimeout, int readTimeout, int writeTimeout) &#123; this.interceptors = interceptors; this.connection = connection; this.streamAllocation = streamAllocation; this.httpCodec = httpCodec; this.index = index; this.request = request; this.call = call; this.eventListener = eventListener; this.connectTimeout = connectTimeout; this.readTimeout = readTimeout; this.writeTimeout = writeTimeout; &#125; @Override public Connection connection() &#123; return connection; &#125; @Override public int connectTimeoutMillis() &#123; return connectTimeout; &#125; @Override public Interceptor.Chain withConnectTimeout(int timeout, TimeUnit unit) &#123; int millis = checkDuration(&quot;timeout&quot;, timeout, unit); return new RealInterceptorChain(interceptors, streamAllocation, httpCodec, connection, index, request, call, eventListener, millis, readTimeout, writeTimeout); &#125; @Override public int readTimeoutMillis() &#123; return readTimeout; &#125; @Override public Interceptor.Chain withReadTimeout(int timeout, TimeUnit unit) &#123; int millis = checkDuration(&quot;timeout&quot;, timeout, unit); return new RealInterceptorChain(interceptors, streamAllocation, httpCodec, connection, index, request, call, eventListener, connectTimeout, millis, writeTimeout); &#125; @Override public int writeTimeoutMillis() &#123; return writeTimeout; &#125; @Override public Interceptor.Chain withWriteTimeout(int timeout, TimeUnit unit) &#123; int millis = checkDuration(&quot;timeout&quot;, timeout, unit); return new RealInterceptorChain(interceptors, streamAllocation, httpCodec, connection, index, request, call, eventListener, connectTimeout, readTimeout, millis); &#125; public StreamAllocation streamAllocation() &#123; return streamAllocation; &#125; public HttpCodec httpStream() &#123; return httpCodec; &#125; @Override public Call call() &#123; return call; &#125; public EventListener eventListener() &#123; return eventListener; &#125; @Override public Request request() &#123; return request; &#125; @Override public Response proceed(Request request) throws IOException &#123; return proceed(request, streamAllocation, httpCodec, connection); &#125; public Response proceed(Request request, StreamAllocation streamAllocation, HttpCodec httpCodec, RealConnection connection) throws IOException &#123; if (index &gt;= interceptors.size()) throw new AssertionError(); calls++; // If we already have a stream, confirm that the incoming request will use it. if (this.httpCodec != null &amp;&amp; !this.connection.supportsUrl(request.url())) &#123; throw new IllegalStateException(&quot;network interceptor &quot; + interceptors.get(index - 1) + &quot; must retain the same host and port&quot;); &#125; // If we already have a stream, confirm that this is the only call to chain.proceed(). if (this.httpCodec != null &amp;&amp; calls &gt; 1) &#123; throw new IllegalStateException(&quot;network interceptor &quot; + interceptors.get(index - 1) + &quot; must call proceed() exactly once&quot;); &#125; // Call the next interceptor in the chain. RealInterceptorChain next = new RealInterceptorChain(interceptors, streamAllocation, httpCodec, connection, index + 1, request, call, eventListener, connectTimeout, readTimeout, writeTimeout); Interceptor interceptor = interceptors.get(index); Response response = interceptor.intercept(next); // Confirm that the next interceptor made its required call to chain.proceed(). if (httpCodec != null &amp;&amp; index + 1 &lt; interceptors.size() &amp;&amp; next.calls != 1) &#123; throw new IllegalStateException(&quot;network interceptor &quot; + interceptor + &quot; must call proceed() exactly once&quot;); &#125; // Confirm that the intercepted response isn&apos;t null. if (response == null) &#123; throw new NullPointerException(&quot;interceptor &quot; + interceptor + &quot; returned null&quot;); &#125; if (response.body() == null) &#123; throw new IllegalStateException( &quot;interceptor &quot; + interceptor + &quot; returned a response with no body&quot;); &#125; return response; &#125;&#125; æˆ‘æŠŠæœ€å…³é”®çš„ä»£ç è´´å‡ºæ¥ï¼ŒInterceptors è·å–å®ä¾‹Interceptorï¼Œæ¯”å¦‚ç¬¬ä¸€ä¸ªçš„è¯ï¼Œæ˜¯RetryAndFollowUpInterceptorï¼Œç„¶åæ‰§è¡Œ interceptæ–¹æ³•ï¼Œå°†ä¸‹ä¸€ä¸ªRealInterceptorChain ä¼ è¿›å»ï¼Œæ‰€ä»¥å…¶å®è¿™é‡Œæ˜¯ä¸€ä¸ªé€’å½’ï¼Œä¼šä¸æ–­è°ƒç”¨ï¼ŒçŸ¥é“æœ€åä¸€å±‚è¿”å› Response 1234567// Call the next interceptor in the chain.RealInterceptorChain next = new RealInterceptorChain(interceptors, streamAllocation, httpCodec, connection, index + 1, request, call, eventListener, connectTimeout, readTimeout, writeTimeout);Interceptor interceptor = interceptors.get(index);// Response response = interceptor.intercept(next); RetryAndFollowUpInterceptor å®ç°æœºåˆ¶ï¼Œé‡Œé¢æœ‰ä¸ªé‡è¦çš„ä¸œè¥¿ï¼Œé‡å®šå‘æ¬¡æ•°ï¼Œæœ€å¤§ä¸º20ï¼Œè¿˜æœ‰ OkHttpClient çš„å®ä¾‹ï¼Œè¿˜æœ‰ä¸€ä¸ªvolatile çš„ canceled ï¼Œæ ‡è®°æ˜¯å¦å–æ¶ˆï¼Œè¿˜æœ‰ forWebSocketï¼Œè¿™ä¸ªç­‰åˆ°ç”¨åˆ°äº†å†è§£é‡Šï¼ŒStreamAllocationä¹Ÿæ˜¯ 1public final class RetryAndFollowUpInterceptor implements Interceptor &#123;&#125; 1234567891011/** * How many redirects and auth challenges should we attempt? Chrome follows 21 redirects; Firefox, * curl, and wget follow 20; Safari follows 16; and HTTP/1.0 recommends 5. */private static final int MAX_FOLLOW_UPS = 20;private final OkHttpClient client;private final boolean forWebSocket;private volatile StreamAllocation streamAllocation;private Object callStackTrace;private volatile boolean canceled; æˆ‘ä»¬çœ‹ä¸€ä¸‹ä»–çš„ intercept æ–¹æ³•ï¼Œç¬¬ä¸€ä¸ª interceptor æ˜¯RetryAndFollowUpInterceptorï¼ŒChain åŒ…å«äº†å½“å‰æ˜¯ç¬¬å‡ ä¸ªæ‹¦æˆªå™¨çš„ä¿¡æ¯ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100@Override public Response intercept(Chain chain) throws IOException &#123; Request request = chain.request(); RealInterceptorChain realChain = (RealInterceptorChain) chain; Call call = realChain.call(); EventListener eventListener = realChain.eventListener(); // æ„å»ºä¸€ä¸ª StreamAllocationå¯¹è±¡ // clientè¿æ¥æ± ï¼ŒAddress åœ°å€ï¼Œcallå¯¹è±¡ï¼Œç›‘å¬å¯¹è±¡ StreamAllocation streamAllocation = new StreamAllocation(client.connectionPool(), createAddress(request.url()), call, eventListener, callStackTrace); this.streamAllocation = streamAllocation; // åˆå§‹åŒ–è·Ÿè¸ªæ¬¡æ•° int followUpCount = 0; Response priorResponse = null; // å¾ªç¯ï¼Œä¸ºäº†å¤„ç†é‡å®šå‘ï¼Œå¤±è´¥é‡è¯•çš„é—®é¢˜ while (true) &#123; // æ¯ä¸€æ¬¡é¦–å…ˆåˆ¤æ–­æ˜¯å¦å–æ¶ˆ if (canceled) &#123; streamAllocation.release(); throw new IOException(&quot;Canceled&quot;); &#125; // Response response; boolean releaseConnection = true; try &#123; // è°ƒç”¨ Chain å¯¹è±¡çš„ proceedï¼Œè¿™é‡Œæœ€åä¹Ÿ // ä¼šè¿›åˆ°ä¸‹ä¸€ä¸ª Interceptor çš„ intercept response = realChain.proceed(request, streamAllocation, null, null); releaseConnection = false; &#125; catch (RouteException e) &#123; // The attempt to connect via a route failed. The request will not have been sent. if (!recover(e.getLastConnectException(), streamAllocation, false, request)) &#123; throw e.getFirstConnectException(); &#125; releaseConnection = false; continue; &#125; catch (IOException e) &#123; // An attempt to communicate with a server failed. The request may have been sent. boolean requestSendStarted = !(e instanceof ConnectionShutdownException); if (!recover(e, streamAllocation, requestSendStarted, request)) throw e; releaseConnection = false; continue; &#125; finally &#123; // We&apos;re throwing an unchecked exception. Release any resources. if (releaseConnection) &#123; streamAllocation.streamFailed(null); streamAllocation.release(); &#125; &#125; // Attach the prior response if it exists. Such responses never have a body. if (priorResponse != null) &#123; response = response.newBuilder() .priorResponse(priorResponse.newBuilder() .body(null) .build()) .build(); &#125; // æ£€æŸ¥æ˜¯å¦å‡ºç°éœ€è¦é‡è¯•ï¼Œæ¯”å¦‚é‡å®šå‘ï¼ŒæœåŠ¡å™¨é—®é¢˜ Request followUp; try &#123; followUp = followUpRequest(response, streamAllocation.route()); &#125; catch (IOException e) &#123; streamAllocation.release(); throw e; &#125; // æ— é‡è¯•ï¼Œç›´æ¥è¿”å›ç»“æœ if (followUp == null) &#123; if (!forWebSocket) &#123; streamAllocation.release(); &#125; return response; &#125; closeQuietly(response.body()); // æ£€æŸ¥é‡è¯•æ¬¡æ•°ï¼Œè¶…å‡ºçš„è¯æŠ›å‡ºå¼‚å¸¸ if (++followUpCount &gt; MAX_FOLLOW_UPS) &#123; streamAllocation.release(); throw new ProtocolException(&quot;Too many follow-up requests: &quot; + followUpCount); &#125; if (followUp.body() instanceof UnrepeatableRequestBody) &#123; streamAllocation.release(); throw new HttpRetryException(&quot;Cannot retry streamed HTTP body&quot;, response.code()); &#125; // ä¸æ˜¯åŒä¸€ä¸ªè¿æ¥ if (!sameConnection(response, followUp.url())) &#123; streamAllocation.release(); streamAllocation = new StreamAllocation(client.connectionPool(), createAddress(followUp.url()), call, eventListener, callStackTrace); this.streamAllocation = streamAllocation; &#125; else if (streamAllocation.codec() != null) &#123; throw new IllegalStateException(&quot;Closing the body of &quot; + response + &quot; didn&apos;t close its backing stream. Bad interceptor?&quot;); &#125; request = followUp; priorResponse = response; &#125; &#125; åˆ¤æ–­æ˜¯å¦éœ€è¦è·Ÿè¸ªçš„ä»£ç ï¼Œå¯ä»¥å¥½å¥½è¡¥ä¸€è¡¥çŠ¶æ€ç äº† 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121private Request followUpRequest(Response userResponse, Route route) throws IOException &#123; if (userResponse == null) throw new IllegalStateException(); int responseCode = userResponse.code(); final String method = userResponse.request().method(); switch (responseCode) &#123; // 407 ä»£ç†æœåŠ¡å™¨éœ€è¦è®¤è¯ case HTTP_PROXY_AUTH: Proxy selectedProxy = route != null ? route.proxy() : client.proxy(); if (selectedProxy.type() != Proxy.Type.HTTP) &#123; throw new ProtocolException(&quot;Received HTTP_PROXY_AUTH (407) code while not using proxy&quot;); &#125; return client.proxyAuthenticator().authenticate(route, userResponse); // 401 æœªæˆæƒï¼Œæ ¹æ®Header Authenticate è¿›è¡Œæˆæƒ case HTTP_UNAUTHORIZED: return client.authenticator().authenticate(route, userResponse); // å¦‚æœæ˜¯éGETï¼ŒHEADï¼Œåˆ™ä¸ç®¡ï¼Œæ³¨æ„ 307,308 å’Œ 301 302 çš„åŒºåˆ« // 308 case HTTP_PERM_REDIRECT: // 307 case HTTP_TEMP_REDIRECT: // &quot;If the 307 or 308 status code is received in response to a request other than GET // or HEAD, the user agent MUST NOT automatically redirect the request&quot; if (!method.equals(&quot;GET&quot;) &amp;&amp; !method.equals(&quot;HEAD&quot;)) &#123; return null; &#125; // fall-through // æ ¹æ®Location é‡å®šå‘ï¼Œæ„å»ºä¸€æ¡æ–°çš„ Request // 300 case HTTP_MULT_CHOICE: // 301 case HTTP_MOVED_PERM: // 302 case HTTP_MOVED_TEMP: // 303 case HTTP_SEE_OTHER: // Does the client allow redirects? if (!client.followRedirects()) return null; String location = userResponse.header(&quot;Location&quot;); if (location == null) return null; HttpUrl url = userResponse.request().url().resolve(location); // Don&apos;t follow redirects to unsupported protocols. if (url == null) return null; // If configured, don&apos;t follow redirects between SSL and non-SSL. boolean sameScheme = url.scheme().equals(userResponse.request().url().scheme()); if (!sameScheme &amp;&amp; !client.followSslRedirects()) return null; // Most redirects don&apos;t include a request body. Request.Builder requestBuilder = userResponse.request().newBuilder(); if (HttpMethod.permitsRequestBody(method)) &#123; final boolean maintainBody = HttpMethod.redirectsWithBody(method); if (HttpMethod.redirectsToGet(method)) &#123; requestBuilder.method(&quot;GET&quot;, null); &#125; else &#123; RequestBody requestBody = maintainBody ? userResponse.request().body() : null; requestBuilder.method(method, requestBody); &#125; if (!maintainBody) &#123; requestBuilder.removeHeader(&quot;Transfer-Encoding&quot;); requestBuilder.removeHeader(&quot;Content-Length&quot;); requestBuilder.removeHeader(&quot;Content-Type&quot;); &#125; &#125; // When redirecting across hosts, drop all authentication headers. This // is potentially annoying to the application layer since they have no // way to retain them. if (!sameConnection(userResponse, url)) &#123; requestBuilder.removeHeader(&quot;Authorization&quot;); &#125; return requestBuilder.url(url).build(); // 408 å®¢æˆ·ç«¯è¿æ¥è¶…æ—¶ case HTTP_CLIENT_TIMEOUT: // 408&apos;s are rare in practice, but some servers like HAProxy use this response code. The // spec says that we may repeat the request without modifications. Modern browsers also // repeat the request (even non-idempotent ones.) if (!client.retryOnConnectionFailure()) &#123; // The application layer has directed us not to retry the request. return null; &#125; if (userResponse.request().body() instanceof UnrepeatableRequestBody) &#123; return null; &#125; if (userResponse.priorResponse() != null &amp;&amp; userResponse.priorResponse().code() == HTTP_CLIENT_TIMEOUT) &#123; // We attempted to retry and got another timeout. Give up. return null; &#125; // å°è¯•é‡è¯• if (retryAfter(userResponse, 0) &gt; 0) &#123; return null; &#125; return userResponse.request(); // 503 case HTTP_UNAVAILABLE: if (userResponse.priorResponse() != null &amp;&amp; userResponse.priorResponse().code() == HTTP_UNAVAILABLE) &#123; // We attempted to retry and got another timeout. Give up. return null; &#125; if (retryAfter(userResponse, Integer.MAX_VALUE) == 0) &#123; // specifically received an instruction to retry without delay return userResponse.request(); &#125; return null; default: return null; &#125;&#125; è§£æé‡è¯•çš„æ—¶é—´ï¼Œåœ¨å®¢æˆ·ç«¯è¯·æ±‚è¶…æ—¶ï¼ŒæœåŠ¡å™¨è´Ÿè½½è¿‡é«˜é€ æˆçš„éƒ½æœ‰å¯èƒ½è¿›è¡Œé‡è¯•ï¼Œè¿™æ—¶å€™ä¼šæ ¹æ®æœåŠ¡å™¨ç»™çš„ retry-after å±æ€§è¿›è¡Œé‡è¯•ï¼Œé»˜è®¤çš„é‡è¯•æ—¶é—´ä¸º0ï¼Œç«‹åˆ»é‡è¯• 123456789101112131415private int retryAfter(Response userResponse, int defaultDelay) &#123; String header = userResponse.header(&quot;Retry-After&quot;); if (header == null) &#123; return defaultDelay; &#125; // https://tools.ietf.org/html/rfc7231#section-7.1.3 // currently ignores a HTTP-date, and assumes any non int 0 is a delay if (header.matches(&quot;\\\\d+&quot;)) &#123; return Integer.valueOf(header); &#125; return Integer.MAX_VALUE;&#125; åˆ¤æ–­æ˜¯å¦æ˜¯åŒä¸€ä¸ªè¿æ¥çš„æ–¹æ³•ï¼Œæ¯”è¾ƒhost å’Œ portï¼Œä»¥åŠschemeï¼ˆhttp æˆ– httpsï¼‰ï¼Œè‡³äºä¸ºä»€ä¹ˆè¦è¿™æ ·å†™ï¼Œæˆ‘ä»¬åœ¨ä¹‹åä¼šçœ‹åˆ°åŸç†ã€‚ 12345678910/** * Returns true if an HTTP request for &#123;@code followUp&#125; can reuse the connection used by this * engine. */private boolean sameConnection(Response response, HttpUrl followUp) &#123; HttpUrl url = response.request().url(); return url.host().equals(followUp.host()) &amp;&amp; url.port() == followUp.port() &amp;&amp; url.scheme().equals(followUp.scheme());&#125; ä»£ç†ç±»å‹ï¼Œä¸‰ç§ 1234567891011121314public enum Type &#123; /** * Represents a direct connection, or the absence of a proxy. */ DIRECT, /** * Represents proxy for high level protocols such as HTTP or FTP. */ HTTP, /** * Represents a SOCKS (V4 or V5) proxy. */ SOCKS&#125;; å°ç»“ æˆ‘ä»¬è¯¦ç»†çš„çœ‹äº†è¿™ä¸ª RetryAndFollowUpInterceptorï¼Œå¯èƒ½ä½ ç°åœ¨è¿˜ä¸æ˜¯å¾ˆæ¸…æ™°ï¼Œä½†ç›¸ä¿¡ä¹‹åçœ‹äº†å…¶ä»–çš„ä¸€äº›Interceptorï¼Œä½ å°±ä¼šååˆ†äº†è§£è¿™ä¸ªä¸œè¥¿ å‰è¨€ ä¹‹å‰æˆ‘ä»¬å­¦ä¹ äº† OkHttp3 çš„ä½¿ç”¨ä»¥åŠ RetryAndFollowUpInterceptor çš„æºç ï¼Œè‡³ä»Šè¿˜è®°å¿†å°¤æ–°ï¼Œä»Šå¤©æˆ‘ç»™å¤§å®¶å¸¦æ¥ä¸€ä¸ª BridgeInterceptorï¼Œè¿™ä¸ªä¸œè¥¿ä¹Ÿå¾ˆé‡è¦ï¼Œé‚£å®ƒåˆ°åº•æ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿å‘¢ï¼Ÿ æ˜¯ä»€ä¹ˆä¸œè¥¿ Bridgeï¼Œæ¡¥æ¥ï¼Œæ˜¯ä¸æ˜¯è¯´èµ·ç€æ‰¿ä¸Šå¯ä¸‹çš„ä½œç”¨ï¼Œçš„ç¡®å¦‚æ­¤ï¼ŒåŸæ–‡æ˜¯è¿™ä¹ˆè¯´çš„ Bridges from application code to network code. First it builds a network request from a user request. Then it proceeds to call the network. Finally it builds a user response from the network response ç¿»è¯‘è¿‡æ¥ï¼Œå°±æ˜¯è¯´å°†è¯·æ±‚æˆ–è€…å“åº”åœ¨åº”ç”¨å±‚å’Œç½‘ç»œå±‚ç›¸äº’è½¬åŒ– æºç  é‡Œé¢çš„ Intercept æ–¹æ³•ï¼Œé¦–å…ˆï¼Œè·å–åˆ°ç”¨è¿‡åˆšå¼€å§‹æ„å»ºçš„ request å¯¹è±¡ï¼Œå› ä¸ºç”¨æˆ·ä»…ä»…é…ç½®äº†å‡ ä¸ªç®€å•çš„å±æ€§ï¼Œæ¯”å¦‚ urlï¼Œmethodç­‰ï¼Œä½†è¿™è¿œè¿œä¸å¤Ÿï¼Œæˆ‘ä»¬ä¼ ç»™æœåŠ¡å™¨çš„æ•°æ®ä¸ä»…ä»…å¦‚æ­¤ï¼Œå¦‚æœçœ‹è¿‡ http åè®®ï¼Œæˆ‘ä»¬åº”è¯¥æ¯”è¾ƒäº†è§£æ˜æ–‡æ¨¡å¼ä¸‹çš„æ•°æ®æ ¼å¼ 12345678910111213141516171819202122@Override public Response intercept(Chain chain) throws IOException &#123; Request userRequest = chain.request(); Request.Builder requestBuilder = userRequest.newBuilder(); RequestBody body = userRequest.body(); if (body != null) &#123; MediaType contentType = body.contentType(); if (contentType != null) &#123; requestBuilder.header(&quot;Content-Type&quot;, contentType.toString()); &#125; // å¦‚æœbody çš„é•¿åº¦ä¸º -1 é‚£ä¹ˆå°†ä½¿ç”¨ // Transfer-Encoding è®¾ç½®ä¸º chunked // æ„æ€æ˜¯åˆ†å—ä¼ è¾“ long contentLength = body.contentLength(); if (contentLength != -1) &#123; requestBuilder.header(&quot;Content-Length&quot;, Long.toString(contentLength)); requestBuilder.removeHeader(&quot;Transfer-Encoding&quot;); &#125; else &#123; requestBuilder.header(&quot;Transfer-Encoding&quot;, &quot;chunked&quot;); requestBuilder.removeHeader(&quot;Content-Length&quot;); &#125; &#125; ç»™ request æ·»åŠ  Hostï¼Œä»¥åŠConnection ä¸º Keep-Aliveï¼Œä»¥åŠä½¿ç”¨ Accept-Encoding ä¸º gzip 1234567891011121314if (userRequest.header(&quot;Host&quot;) == null) &#123; requestBuilder.header(&quot;Host&quot;, hostHeader(userRequest.url(), false)); &#125; if (userRequest.header(&quot;Connection&quot;) == null) &#123; requestBuilder.header(&quot;Connection&quot;, &quot;Keep-Alive&quot;); &#125; // If we add an &quot;Accept-Encoding: gzip&quot; header field we&apos;re responsible for also decompressing // the transfer stream. boolean transparentGzip = false; if (userRequest.header(&quot;Accept-Encoding&quot;) == null &amp;&amp; userRequest.header(&quot;Range&quot;) == null) &#123; transparentGzip = true; requestBuilder.header(&quot;Accept-Encoding&quot;, &quot;gzip&quot;); &#125; å°è£…Cookieï¼Œä»¥åŠUser-Agent ä¸º okhttp å…³äº Cookie çš„æ ¼å¼å¦‚ä¸‹ï¼Œå…¶ä¸­ Name = Value å¿…é¡»è¦æœ‰ 1Set-Cookie: Name = Value; Comment = value; Domain = value; Max-Age = value; Path = Value;Secure; Version = 1 * DIGIT; 1234567891011121314151617List&lt;Cookie&gt; cookies = cookieJar.loadForRequest(userRequest.url()); if (!cookies.isEmpty()) &#123; requestBuilder.header(&quot;Cookie&quot;, cookieHeader(cookies)); &#125; if (userRequest.header(&quot;User-Agent&quot;) == null) &#123; requestBuilder.header(&quot;User-Agent&quot;, Version.userAgent()); &#125; public final class Version &#123; public static String userAgent() &#123; return &quot;okhttp/3.11.0&quot;; &#125; private Version() &#123; &#125; &#125; ä¹‹åå°±æ˜¯è½¬å‘ç»™ä¸‹ä¸€ä¸ª Interceptor äº†ï¼Œåœ¨æ‹¿åˆ°æ•°æ®ä»¥åï¼Œå¤„ç†ä¸€ä¸‹ cookie çš„æ•°æ®ï¼Œå…·ä½“å°±æ˜¯æ›´æ–°Cookieï¼Œä¹‹åå°±æ˜¯å¤„ç†æ•°æ®äº†ï¼Œå¦‚æœæœåŠ¡ç«¯ä½¿ç”¨äº†gzipï¼Œæˆ‘ä»¬å°±éœ€è¦è§£å‹ï¼Œåœ¨æ„å»º responseï¼Œä¹‹åå†è¿”å› 12345678910111213141516171819Response networkResponse = chain.proceed(requestBuilder.build());HttpHeaders.receiveHeaders(cookieJar, userRequest.url(), networkResponse.headers());Response.Builder responseBuilder = networkResponse.newBuilder() .request(userRequest);if (transparentGzip &amp;&amp; &quot;gzip&quot;.equalsIgnoreCase(networkResponse.header(&quot;Content-Encoding&quot;)) &amp;&amp; HttpHeaders.hasBody(networkResponse)) &#123; GzipSource responseBody = new GzipSource(networkResponse.body().source()); Headers strippedHeaders = networkResponse.headers().newBuilder() .removeAll(&quot;Content-Encoding&quot;) .removeAll(&quot;Content-Length&quot;) .build(); responseBuilder.headers(strippedHeaders); String contentType = networkResponse.header(&quot;Content-Type&quot;); responseBuilder.body(new RealResponseBody(contentType, -1L, Okio.buffer(responseBody)));&#125; å·®ä¸å¤šåˆ°è¿™å°±å®Œäº† å°ç»“ ä»Šå¤©çš„bridgeInterceptorä¸»è¦åšçš„å·¥ä½œä¾¿æ˜¯å°è£… request å’Œ å¤„ç† response è¿™ä¸ªä¸œè¥¿ï¼Œä¸­é—´æˆ‘ä»¬å­¦ä¹ äº† content-encoding accept-encoding ç­‰å±æ€§ï¼Œå¦å¤–è¯¦ç»†çš„äº†è§£äº†cookieï¼Œç»ˆäºææ˜ç™½äº†è¿™ä¸œè¥¿çš„æ ¼å¼ï¼Œæ”¶è·ä¸å° æ¬¢è¿è®¨è®º å‰è¨€ æ¡¥æ¥ Interceptor ä¹‹åå°±æ˜¯ç¼“å­˜ Interceptor äº†ï¼Œç¼“å­˜åœ¨æµè§ˆå™¨ä¸­è¿ç”¨ååˆ†å¹¿æ³›ï¼Œå¦‚æœåœ¨åŠ è½½ç½‘é¡µæ—¶ä½¿ç”¨äº†ç¼“å­˜ï¼Œä¸»è¦æ˜¯äºŒæ¬¡åŠ è½½ï¼Œé‚£ä¹ˆä¸€äº›ä¸å˜çš„å†…å®¹å°±å¯ä»¥ä¸ç”¨å»é‡æ–°è¯·æ±‚ï¼Œè¿™æ ·æ•°æ®å°±ä¸ç”¨æ¥å›ä¼ é€ï¼Œæ€§èƒ½ä¾¿æœ‰æ‰€æé«˜ï¼Œé€šå¸¸æˆ‘ä»¬é‡åˆ°çš„ 304 å“åº”ç ä¾¿æ˜¯ç¼“å­˜çš„è±¡å¾ï¼Œå…³äºç¼“å­˜è¿˜éœ€è¦æŒæ¡å¾ˆå¤šè¯·æ±‚å¤´çš„çŸ¥è¯†ï¼Œæ¯”å¦‚ETagï¼ŒIf-None-Matchï¼ŒIf-Modified-Sinceï¼ŒLast-Modified-Time ç­‰ç­‰ï¼Œè¿™äº›å±æ€§æ˜¯å®¢æˆ·ç«¯ï¼ŒæœåŠ¡ç«¯ç¼“å­˜æ¶ˆæ¯äº¤äº’çš„å…³é”®ã€‚å› æ­¤æˆ‘ä»¬è¦å­¦ä¹ ç¼“å­˜çš„è¯ï¼Œè¿™äº›çŸ¥è¯†å¿…ä¸å¯å°‘ã€‚ æ˜¯ä»€ä¹ˆä¸œè¥¿ï¼Ÿ ç”¨äºå¤„ç†å®¢æˆ·ç«¯çš„ç¼“å­˜ï¼Œç¼“å­˜çš„å†…å®¹å®åœ¨å®¢æˆ·ç«¯çš„ï¼Œä½†é€šå¸¸ä¸æœåŠ¡å™¨æ˜¯è„±ä¸äº†å…³ç³»çš„ï¼Œè¿™é‡Œæˆ‘ä»¬éœ€è¦æ˜ç™½çš„æ˜¯ï¼Œå…³äºç½‘ç»œç¼“å­˜æœ‰å¾ˆå¤šå¾ˆå¤šä¸­ï¼Œå¯ä»¥åœ¨å¾ˆå¤šåœ°æ–¹åšç¼“å­˜ï¼Œè€Œè¿™é‡Œæ˜¯åœ¨å®¢æˆ·ç«¯åšç¼“å­˜ã€‚ æºç å­¦ä¹  ç¼“å­˜çš„å†…æ ¸ï¼Œæ‰€æœ‰çš„æ•°æ®å­˜å–éƒ½ä¸è¿™å®¶ä¼™æœ‰å…³ï¼Œå†…éƒ¨æ˜¯ä½¿ç”¨ Cacheï¼Œå¦‚æœæˆ‘ä»¬éœ€è¦ä½¿ç”¨ç¼“å­˜ï¼Œé‚£éœ€è¦æˆ‘ä»¬è‡ªå·±é…ç½®ï¼Œé»˜è®¤æ˜¯æ²¡æœ‰æœ¬åœ°ç¼“å­˜çš„ 123final InternalCache cache;public final class Cache implements Closeable, Flushable &#123;&#125; æ„é€ å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå†…éƒ¨ä½¿ç”¨äº† DiskLruCacheï¼Œå¦‚æœä¸äº†è§£ DiskLruCacheçš„åŒå­¦ï¼Œå¯ä»¥å‚è€ƒæˆ‘çš„å¦å¤–ä¸€ç¯‡æ–‡ç«  DiskLruCache æºç è§£æ ï¼Œ 12345678910111213141516final DiskLruCache cache;/* read and write statistics, all guarded by &apos;this&apos; */int writeSuccessCount;int writeAbortCount;private int networkCount;private int hitCount;private int requestCount;public Cache(File directory, long maxSize) &#123; this(directory, maxSize, FileSystem.SYSTEM);&#125;Cache(File directory, long maxSize, FileSystem fileSystem) &#123; this.cache = DiskLruCache.create(fileSystem, directory, VERSION, ENTRY_COUNT, maxSize);&#125; å…ˆæ¥çœ‹çœ‹å¦‚ä½•ç¼“å­˜æ”¾è¿›å»ï¼Œå½“ç„¶ï¼Œèƒ½ç¼“å­˜çš„è¯·æ±‚ç±»å‹åªæœ‰ GETï¼ŒHEADï¼Œå³é¦–å…ˆåˆ¤æ–­ Response ç±»å‹ï¼Œçœ¼çœ‹è¿™é‡Œä»£ç å†™å¾—å¥½çƒ‚ï¼Œä¼°è®¡ä½œè€…å¯èƒ½ç¡ç€äº†ï¼Œæœ‰ç©ºå» PRï¼Œ 123456789101112131415161718192021222324252627282930313233343536@Nullable CacheRequest put(Response response) &#123; String requestMethod = response.request().method(); if (HttpMethod.invalidatesCache(response.request().method())) &#123; try &#123; remove(response.request()); &#125; catch (IOException ignored) &#123; // The cache cannot be written. &#125; return null; &#125; if (!requestMethod.equals(&quot;GET&quot;)) &#123; // Don&apos;t cache non-GET responses. We&apos;re technically allowed to cache // HEAD requests and some POST requests, but the complexity of doing // so is high and the benefit is low. return null; &#125; if (HttpHeaders.hasVaryAll(response)) &#123; return null; &#125; Entry entry = new Entry(response); DiskLruCache.Editor editor = null; try &#123; editor = cache.edit(key(response.request().url())); if (editor == null) &#123; return null; &#125; entry.writeTo(editor); return new CacheRequestImpl(editor); &#125; catch (IOException e) &#123; abortQuietly(editor); return null; &#125;&#125; æ ¹æ® url çš„ md5 å€¼çš„16è¿›åˆ¶æ¥è·å–keyï¼Œä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšå‘¢ï¼Ÿåˆ«æƒ³äº†ï¼Œå°±è¿™æ ·å§ 123public static String key(HttpUrl url) &#123; return ByteString.encodeUtf8(url.toString()).md5().hex(); &#125; éªŒè¯è¯·æ±‚èƒ½å¦ç¼“å­˜ 1234567public static boolean invalidatesCache(String method) &#123; return method.equals(&quot;POST&quot;) || method.equals(&quot;PATCH&quot;) || method.equals(&quot;PUT&quot;) || method.equals(&quot;DELETE&quot;) || method.equals(&quot;MOVE&quot;); // WebDAV&#125; ä¸‹é¢çš„ä»£ç æ˜¯è·å–ç¼“å­˜çš„ä»£ç ï¼ŒåŒæ ·å…ˆè·å– keyï¼Œç„¶åè·å–ç¼“å­˜ 12345678910111213141516171819202122232425262728293031@Nullable Response get(Request request) &#123; String key = key(request.url()); DiskLruCache.Snapshot snapshot; Entry entry; try &#123; snapshot = cache.get(key); if (snapshot == null) &#123; return null; &#125; &#125; catch (IOException e) &#123; // Give up because the cache cannot be read. return null; &#125; try &#123; entry = new Entry(snapshot.getSource(ENTRY_METADATA)); &#125; catch (IOException e) &#123; Util.closeQuietly(snapshot); return null; &#125; Response response = entry.response(snapshot); if (!entry.matches(request, response)) &#123; Util.closeQuietly(response.body()); return null; &#125; return response;&#125; æˆ‘ä»¬åœ¨å›è¿‡å¤´æ¥çœ‹ï¼Œè¿™é‡Œå°†è·å–ä¸€ä¸ª CacheStrategyï¼Œé€šå¸¸ï¼ŒcacheResponse ä¸ºç©ºï¼Œæ‰€ä»¥è¿™ä¸€æ­¥å‡ ä¹æ²¡æœ‰ä»»ä½•ç¼“å­˜ï¼Œåªæ˜¯å°è£…äº†ä¸€ä¸‹ request 123456789101112131415161718192021public CacheStrategy get() &#123; CacheStrategy candidate = getCandidate(); if (candidate.networkRequest != null &amp;&amp; request.cacheControl().onlyIfCached()) &#123; // We&apos;re forbidden from using the network and the cache is insufficient. return new CacheStrategy(null, null); &#125; return candidate;&#125;private CacheStrategy getCandidate() &#123; // No cached response. if (cacheResponse == null) &#123; return new CacheStrategy(request, null); &#125; // Drop the cached response if it&apos;s missing a required handshake. if (request.isHttps() &amp;&amp; cacheResponse.handshake() == null) &#123; return new CacheStrategy(request, null); &#125; æ¯”è¾ƒé‡è¦çš„é€»è¾‘ï¼Œå¤§è‡´çš„æ€è·¯ä¸ºï¼šé¦–å…ˆæ£€æŸ¥ç¼“å­˜ï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ™æ ¹æ®ç¼“å­˜å°è£…ä¸€ä¸ªRequestï¼Œå¸¦ä¸Š ETagï¼ŒIf-Modify-Since æ ‡ç­¾ï¼Œè®¿é—®æœåŠ¡å™¨ï¼Œå¦åˆ™ç›´æ¥è®¿é—®æœåŠ¡å™¨ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748@Override public Response intercept(Chain chain) throws IOException &#123; Response cacheCandidate = cache != null ? cache.get(chain.request()) : null; long now = System.currentTimeMillis(); CacheStrategy strategy = new CacheStrategy.Factory(now, chain.request(), cacheCandidate).get(); Request networkRequest = strategy.networkRequest; Response cacheResponse = strategy.cacheResponse; if (cache != null) &#123; cache.trackResponse(strategy); &#125; if (cacheCandidate != null &amp;&amp; cacheResponse == null) &#123; closeQuietly(cacheCandidate.body()); // The cache candidate wasn&apos;t applicable. Close it. &#125; // If we&apos;re forbidden from using the network and the cache is insufficient, fail. if (networkRequest == null &amp;&amp; cacheResponse == null) &#123; return new Response.Builder() .request(chain.request()) .protocol(Protocol.HTTP_1_1) .code(504) .message(&quot;Unsatisfiable Request (only-if-cached)&quot;) .body(Util.EMPTY_RESPONSE) .sentRequestAtMillis(-1L) .receivedResponseAtMillis(System.currentTimeMillis()) .build(); &#125; // If we don&apos;t need the network, we&apos;re done. if (networkRequest == null) &#123; return cacheResponse.newBuilder() .cacheResponse(stripBody(cacheResponse)) .build(); &#125; Response networkResponse = null; try &#123; networkResponse = chain.proceed(networkRequest); &#125; finally &#123; // If we&apos;re crashing on I/O or otherwise, don&apos;t leak the cache body. if (networkResponse == null &amp;&amp; cacheCandidate != null) &#123; closeQuietly(cacheCandidate.body()); &#125; &#125; è®¿é—®å®Œä»¥åï¼Œå¦‚æœæ˜¯304è¿”å›ç ï¼Œè¯´æ˜å¯ä»¥ä»ç¼“å­˜ä¸­æ‹¿æ•°æ®ï¼Œé‚£æˆ‘ä»¬å°±å¯ä»¥ä»ç¼“å­˜ä¸­æ‹¿æ•°æ®ï¼Œæ„å»ºä¸€ä¸ªæ–°çš„ Response å°±è¡Œäº† å¦ä¸€ä¸ªæ“ä½œå°±æ˜¯ï¼Œå­˜å‚¨æ•°æ®ï¼Œå³æ ¹æ®æœåŠ¡ç«¯çš„è¿”å›ç æŠŠå¯ä»¥ç¼“å­˜çš„æ•°æ®ä¿å­˜åœ¨ Cache é‡Œï¼Œä¸»è¦æ˜¯æ ¹æ® Cache-control Pragma ï¼Œåªè¦èƒ½ç¼“å­˜ï¼Œå°½é‡ç¼“å­˜ 123456789101112131415161718192021222324252627282930313233343536373839404142434445 // If we have a cache response too, then we&apos;re doing a conditional get. if (cacheResponse != null) &#123; if (networkResponse.code() == HTTP_NOT_MODIFIED) &#123; Response response = cacheResponse.newBuilder() .headers(combine(cacheResponse.headers(), networkResponse.headers())) .sentRequestAtMillis(networkResponse.sentRequestAtMillis()) .receivedResponseAtMillis(networkResponse.receivedResponseAtMillis()) .cacheResponse(stripBody(cacheResponse)) .networkResponse(stripBody(networkResponse)) .build(); networkResponse.body().close(); // Update the cache after combining headers but before stripping the // Content-Encoding header (as performed by initContentStream()). cache.trackConditionalCacheHit(); cache.update(cacheResponse, response); return response; &#125; else &#123; closeQuietly(cacheResponse.body()); &#125; &#125; Response response = networkResponse.newBuilder() .cacheResponse(stripBody(cacheResponse)) .networkResponse(stripBody(networkResponse)) .build(); if (cache != null) &#123; if (HttpHeaders.hasBody(response) &amp;&amp; CacheStrategy.isCacheable(response, networkRequest)) &#123; // Offer this request to the cache. CacheRequest cacheRequest = cache.put(response); return cacheWritingResponse(cacheRequest, response); &#125; if (HttpMethod.invalidatesCache(networkRequest.method())) &#123; try &#123; cache.remove(networkRequest); &#125; catch (IOException ignored) &#123; // The cache cannot be written. &#125; &#125; &#125; return response;&#125; å¯ä»¥æ¬£èµä¸€ä¸‹è¿™ä¸ªæ–¹æ³•ï¼Œå¯ä»¥åŠ æ·±æˆ‘ä»¬å¯¹ç¼“å­˜çš„è®¤è¯† 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100public static CacheControl parse(Headers headers) &#123; boolean noCache = false; boolean noStore = false; int maxAgeSeconds = -1; int sMaxAgeSeconds = -1; boolean isPrivate = false; boolean isPublic = false; boolean mustRevalidate = false; int maxStaleSeconds = -1; int minFreshSeconds = -1; boolean onlyIfCached = false; boolean noTransform = false; boolean immutable = false; boolean canUseHeaderValue = true; String headerValue = null; for (int i = 0, size = headers.size(); i &lt; size; i++) &#123; String name = headers.name(i); String value = headers.value(i); if (name.equalsIgnoreCase(&quot;Cache-Control&quot;)) &#123; if (headerValue != null) &#123; // Multiple cache-control headers means we can&apos;t use the raw value. canUseHeaderValue = false; &#125; else &#123; headerValue = value; &#125; &#125; else if (name.equalsIgnoreCase(&quot;Pragma&quot;)) &#123; // Might specify additional cache-control params. We invalidate just in case. canUseHeaderValue = false; &#125; else &#123; continue; &#125; int pos = 0; while (pos &lt; value.length()) &#123; int tokenStart = pos; pos = HttpHeaders.skipUntil(value, pos, &quot;=,;&quot;); String directive = value.substring(tokenStart, pos).trim(); String parameter; if (pos == value.length() || value.charAt(pos) == &apos;,&apos; || value.charAt(pos) == &apos;;&apos;) &#123; pos++; // consume &apos;,&apos; or &apos;;&apos; (if necessary) parameter = null; &#125; else &#123; pos++; // consume &apos;=&apos; pos = HttpHeaders.skipWhitespace(value, pos); // quoted string if (pos &lt; value.length() &amp;&amp; value.charAt(pos) == &apos;\\&quot;&apos;) &#123; pos++; // consume &apos;&quot;&apos; open quote int parameterStart = pos; pos = HttpHeaders.skipUntil(value, pos, &quot;\\&quot;&quot;); parameter = value.substring(parameterStart, pos); pos++; // consume &apos;&quot;&apos; close quote (if necessary) // unquoted string &#125; else &#123; int parameterStart = pos; pos = HttpHeaders.skipUntil(value, pos, &quot;,;&quot;); parameter = value.substring(parameterStart, pos).trim(); &#125; &#125; if (&quot;no-cache&quot;.equalsIgnoreCase(directive)) &#123; noCache = true; &#125; else if (&quot;no-store&quot;.equalsIgnoreCase(directive)) &#123; noStore = true; &#125; else if (&quot;max-age&quot;.equalsIgnoreCase(directive)) &#123; maxAgeSeconds = HttpHeaders.parseSeconds(parameter, -1); &#125; else if (&quot;s-maxage&quot;.equalsIgnoreCase(directive)) &#123; sMaxAgeSeconds = HttpHeaders.parseSeconds(parameter, -1); &#125; else if (&quot;private&quot;.equalsIgnoreCase(directive)) &#123; isPrivate = true; &#125; else if (&quot;public&quot;.equalsIgnoreCase(directive)) &#123; isPublic = true; &#125; else if (&quot;must-revalidate&quot;.equalsIgnoreCase(directive)) &#123; mustRevalidate = true; &#125; else if (&quot;max-stale&quot;.equalsIgnoreCase(directive)) &#123; maxStaleSeconds = HttpHeaders.parseSeconds(parameter, Integer.MAX_VALUE); &#125; else if (&quot;min-fresh&quot;.equalsIgnoreCase(directive)) &#123; minFreshSeconds = HttpHeaders.parseSeconds(parameter, -1); &#125; else if (&quot;only-if-cached&quot;.equalsIgnoreCase(directive)) &#123; onlyIfCached = true; &#125; else if (&quot;no-transform&quot;.equalsIgnoreCase(directive)) &#123; noTransform = true; &#125; else if (&quot;immutable&quot;.equalsIgnoreCase(directive)) &#123; immutable = true; &#125; &#125; &#125; if (!canUseHeaderValue) &#123; headerValue = null; &#125; return new CacheControl(noCache, noStore, maxAgeSeconds, sMaxAgeSeconds, isPrivate, isPublic, mustRevalidate, maxStaleSeconds, minFreshSeconds, onlyIfCached, noTransform, immutable, headerValue); &#125; å¤§è‡´çš„ç¼“å­˜å°±å·®ä¸å¤šäº† å°ç»“ æˆ‘ä»¬ä»Šå¤©ç ”ç©¶äº†ä¸€ä¸‹ç¼“å­˜ç­–ç•¥ï¼Œåˆ°åº•ä»€ä¹ˆæ—¶å€™å¯ä»¥ç¼“å­˜ï¼Œä»€ä¹ˆæ—¶å€™ä¸èƒ½ç¼“å­˜ï¼Œç¼“å­˜åˆ°åº•æ˜¯ä»€ä¹ˆæ“ä½œï¼Œæˆ‘ä»¬ä»Šå¤©éƒ½å¼„æ¸…æ¥šäº†ï¼Œæ€»çš„æ¥è¯´ï¼Œç¼“å­˜å¹¶ä¸æ˜¯è¯´ä¸è®¿é—®æœåŠ¡å™¨äº†ï¼Œè€Œæ˜¯è¯´è®¿é—®æœåŠ¡å™¨çœ‹æ˜¯å¦æœ‰æ²¡æœ‰æ•°æ®çš„å˜åŒ–ï¼Œå¦å¤–ç¼“å­˜é’ˆå¯¹äº GET HEAD è¯·æ±‚ï¼Œå¦å¤– DiskLruCache çš„ä½¿ç”¨ æ¬¢è¿è®¨è®ºï½ å‰è¨€ å‡ å¤©è¿‡å»äº†ï¼Œä¹‹å‰æˆ‘ä»¬ä¾æ¬¡å­¦ä¹ äº† RetryAndFollowUpInterceptorã€BridgeInterceptorã€CacheInterceptor çœ‹åˆ°äº†æˆ‘ä»¬çš„ Request æ€ä¹ˆä¸€æ­¥ä¸€æ­¥è½¬åŒ–æˆ NetworkRequestï¼Œäº¦æˆ–æ˜¯ Response æ€ä¹ˆå¤„ç† Responseï¼Œé‡è¯•è·Ÿè¸ªï¼Œè½¬åŒ–ï¼Œç¼“å­˜ï¼Œä½†æˆ‘ä»¬è‡³ä»Šè¿˜æœªçœ‹åˆ°æ•°æ®æ˜¯æ€ä¹ˆä¼ é€å‡ºå»ï¼Œä»Šå¤©ï¼Œæˆ‘ä»¬å°†è¦äº†è§£çš„ ConnectInterceptor ä»ç„¶æ²¡æœ‰ä¼ æ•°æ®è¿‡å»ï¼Œä½†æ˜¯ä»–åœ¨å»ºç«‹è¿æ¥ï¼Œå¤ç”¨è¿æ¥èµ·ç€é‡è¦çš„ä½œç”¨ï¼Œå†…éƒ¨ç»´æŠ¤ç€ä¸€ä¸ªè¿æ¥æ± ï¼Œè¿æ¥ä½¿ç”¨çš„æ˜¯ socketï¼Œsslsocketï¼Œåˆ†åˆ«å¯¹åº”HTTP1 HTTP2 çš„ socket å’Œ HTTPS çš„ sslSocket è¿æ¥ï¼Œå…³äº sslSocketï¼Œåˆæ¶‰åŠåˆ°å®‰å…¨é—®é¢˜ï¼Œæ¯”å¦‚è¯´ï¼Œssl çš„å»ºç«‹ï¼Œè¯ä¹¦çš„è®¤è¯ï¼Œæ•°æ®çš„åŠ å¯†ä¼ è¾“ï¼Œè§£å¯†ç­‰ç­‰ã€‚ æ˜¯ä»€ä¹ˆä¸œè¥¿ï¼Ÿ å…³äºè¿æ¥çš„æ‹¦æˆªå™¨ï¼Œé‡Œé¢ç®¡ç†ç€ socket çš„è¿æ¥ï¼Œè¿™æ ·æ–¹ä¾¿æˆ‘ä»¬ä¹‹åçš„è¯·æ±‚åšè¿æ¥å¤ç”¨ï¼Œæé«˜æ•ˆç‡ æºç è§£æ é¦–å…ˆè·å– streamAllocationï¼Œç„¶åæ–°å»ºä¸€ä¸ª streamï¼Œ 1234567891011121314151617181920public final class ConnectInterceptor implements Interceptor &#123; public final OkHttpClient client; public ConnectInterceptor(OkHttpClient client) &#123; this.client = client; &#125; @Override public Response intercept(Chain chain) throws IOException &#123; RealInterceptorChain realChain = (RealInterceptorChain) chain; Request request = realChain.request(); StreamAllocation streamAllocation = realChain.streamAllocation(); // We need the network to satisfy this request. Possibly for validating a conditional GET. boolean doExtensiveHealthChecks = !request.method().equals(&quot;GET&quot;); HttpCodec httpCodec = streamAllocation.newStream(client, chain, doExtensiveHealthChecks); RealConnection connection = streamAllocation.connection(); return realChain.proceed(request, streamAllocation, httpCodec, connection); &#125;&#125; é€šè¿‡ findHealthyConnection è·å–ä¸€ä¸ªè¿æ¥ï¼Œåœ¨æ ¹æ® RealConnection å»ºç«‹ HttpCodec 123456789101112131415161718192021public HttpCodec newStream( OkHttpClient client, Interceptor.Chain chain, boolean doExtensiveHealthChecks) &#123; int connectTimeout = chain.connectTimeoutMillis(); int readTimeout = chain.readTimeoutMillis(); int writeTimeout = chain.writeTimeoutMillis(); int pingIntervalMillis = client.pingIntervalMillis(); boolean connectionRetryEnabled = client.retryOnConnectionFailure(); try &#123; RealConnection resultConnection = findHealthyConnection(connectTimeout, readTimeout, writeTimeout, pingIntervalMillis, connectionRetryEnabled, doExtensiveHealthChecks); HttpCodec resultCodec = resultConnection.newCodec(client, chain, this); synchronized (connectionPool) &#123; codec = resultCodec; return resultCodec; &#125; &#125; catch (IOException e) &#123; throw new RouteException(e); &#125;&#125; æ–¹æ³•æœ‰ç‚¹é•¿ï¼Œä¸»è¦çš„æ€è·¯æ˜¯å…ˆä»è¿æ¥æ± é‡ŒæŸ¥æ‰¾ï¼Œè‹¥æ‰¾ä¸åˆ°å°±åˆ›å»ºä¸€ä¸ª socket è¿æ¥ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120private RealConnection findConnection(int connectTimeout, int readTimeout, int writeTimeout, int pingIntervalMillis, boolean connectionRetryEnabled) throws IOException &#123; boolean foundPooledConnection = false; RealConnection result = null; Route selectedRoute = null; Connection releasedConnection; Socket toClose; synchronized (connectionPool) &#123; if (released) throw new IllegalStateException(&quot;released&quot;); if (codec != null) throw new IllegalStateException(&quot;codec != null&quot;); if (canceled) throw new IOException(&quot;Canceled&quot;); // Attempt to use an already-allocated connection. We need to be careful here because our // already-allocated connection may have been restricted from creating new streams. releasedConnection = this.connection; toClose = releaseIfNoNewStreams(); if (this.connection != null) &#123; // We had an already-allocated connection and it&apos;s good. result = this.connection; releasedConnection = null; &#125; if (!reportedAcquired) &#123; // If the connection was never reported acquired, don&apos;t report it as released! releasedConnection = null; &#125; if (result == null) &#123; // Attempt to get a connection from the pool. Internal.instance.get(connectionPool, address, this, null); if (connection != null) &#123; foundPooledConnection = true; result = connection; &#125; else &#123; selectedRoute = route; &#125; &#125; &#125; closeQuietly(toClose); if (releasedConnection != null) &#123; eventListener.connectionReleased(call, releasedConnection); &#125; if (foundPooledConnection) &#123; eventListener.connectionAcquired(call, result); &#125; if (result != null) &#123; // If we found an already-allocated or pooled connection, we&apos;re done. return result; &#125; // If we need a route selection, make one. This is a blocking operation. boolean newRouteSelection = false; if (selectedRoute == null &amp;&amp; (routeSelection == null || !routeSelection.hasNext())) &#123; newRouteSelection = true; routeSelection = routeSelector.next(); &#125; synchronized (connectionPool) &#123; if (canceled) throw new IOException(&quot;Canceled&quot;); if (newRouteSelection) &#123; // Now that we have a set of IP addresses, make another attempt at getting a connection from // the pool. This could match due to connection coalescing. List&lt;Route&gt; routes = routeSelection.getAll(); for (int i = 0, size = routes.size(); i &lt; size; i++) &#123; Route route = routes.get(i); Internal.instance.get(connectionPool, address, this, route); if (connection != null) &#123; foundPooledConnection = true; result = connection; this.route = route; break; &#125; &#125; &#125; if (!foundPooledConnection) &#123; if (selectedRoute == null) &#123; selectedRoute = routeSelection.next(); &#125; // Create a connection and assign it to this allocation immediately. This makes it possible // for an asynchronous cancel() to interrupt the handshake we&apos;re about to do. route = selectedRoute; refusedStreamCount = 0; result = new RealConnection(connectionPool, selectedRoute); acquire(result, false); &#125; &#125; // If we found a pooled connection on the 2nd time around, we&apos;re done. if (foundPooledConnection) &#123; eventListener.connectionAcquired(call, result); return result; &#125; // Do TCP + TLS handshakes. This is a blocking operation. result.connect(connectTimeout, readTimeout, writeTimeout, pingIntervalMillis, connectionRetryEnabled, call, eventListener); routeDatabase().connected(result.route()); Socket socket = null; synchronized (connectionPool) &#123; reportedAcquired = true; // Pool the connection. Internal.instance.put(connectionPool, result); // If another multiplexed connection to the same address was created concurrently, then // release this connection and acquire that one. if (result.isMultiplexed()) &#123; socket = Internal.instance.deduplicate(connectionPool, address, this); result = connection; &#125; &#125; closeQuietly(socket); eventListener.connectionAcquired(call, result); return result; &#125; å»ºç«‹protocolè¿æ¥ï¼Œæ­¤å¤„å¦‚æœæ˜¯ TLS ï¼Œåˆ™å»ºç«‹ sslsocket è¿æ¥ 1234567891011121314151617181920212223private void establishProtocol(ConnectionSpecSelector connectionSpecSelector, int pingIntervalMillis, Call call, EventListener eventListener) throws IOException &#123; if (route.address().sslSocketFactory() == null) &#123; if (route.address().protocols().contains(Protocol.H2_PRIOR_KNOWLEDGE)) &#123; socket = rawSocket; protocol = Protocol.H2_PRIOR_KNOWLEDGE; startHttp2(pingIntervalMillis); return; &#125; socket = rawSocket; protocol = Protocol.HTTP_1_1; return; &#125; eventListener.secureConnectStart(call); connectTls(connectionSpecSelector); eventListener.secureConnectEnd(call, handshake); if (protocol == Protocol.HTTP_2) &#123; startHttp2(pingIntervalMillis); &#125;&#125; å»ºç«‹ TSLï¼Œåœ¨ rawSocket çš„åŸºç¡€ä¸Šå»ºç«‹ sslSocket è¿æ¥ï¼Œç„¶åæ¡æ‰‹ï¼Œæ£€æµ‹è¯ä¹¦ï¼Œè¿”å›è¿æ¥ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960private void connectTls(ConnectionSpecSelector connectionSpecSelector) throws IOException &#123; Address address = route.address(); SSLSocketFactory sslSocketFactory = address.sslSocketFactory(); boolean success = false; SSLSocket sslSocket = null; try &#123; // Create the wrapper over the connected socket. sslSocket = (SSLSocket) sslSocketFactory.createSocket( rawSocket, address.url().host(), address.url().port(), true /* autoClose */); // Configure the socket&apos;s ciphers, TLS versions, and extensions. ConnectionSpec connectionSpec = connectionSpecSelector.configureSecureSocket(sslSocket); if (connectionSpec.supportsTlsExtensions()) &#123; Platform.get().configureTlsExtensions( sslSocket, address.url().host(), address.protocols()); &#125; // Force handshake. This can throw! sslSocket.startHandshake(); // block for session establishment SSLSession sslSocketSession = sslSocket.getSession(); Handshake unverifiedHandshake = Handshake.get(sslSocketSession); // Verify that the socket&apos;s certificates are acceptable for the target host. if (!address.hostnameVerifier().verify(address.url().host(), sslSocketSession)) &#123; X509Certificate cert = (X509Certificate) unverifiedHandshake.peerCertificates().get(0); throw new SSLPeerUnverifiedException(&quot;Hostname &quot; + address.url().host() + &quot; not verified:&quot; + &quot;\\n certificate: &quot; + CertificatePinner.pin(cert) + &quot;\\n DN: &quot; + cert.getSubjectDN().getName() + &quot;\\n subjectAltNames: &quot; + OkHostnameVerifier.allSubjectAltNames(cert)); &#125; // Check that the certificate pinner is satisfied by the certificates presented. address.certificatePinner().check(address.url().host(), unverifiedHandshake.peerCertificates()); // Success! Save the handshake and the ALPN protocol. String maybeProtocol = connectionSpec.supportsTlsExtensions() ? Platform.get().getSelectedProtocol(sslSocket) : null; socket = sslSocket; source = Okio.buffer(Okio.source(socket)); sink = Okio.buffer(Okio.sink(socket)); handshake = unverifiedHandshake; protocol = maybeProtocol != null ? Protocol.get(maybeProtocol) : Protocol.HTTP_1_1; success = true; &#125; catch (AssertionError e) &#123; if (Util.isAndroidGetsocknameError(e)) throw new IOException(e); throw e; &#125; finally &#123; if (sslSocket != null) &#123; Platform.get().afterHandshake(sslSocket); &#125; if (!success) &#123; closeQuietly(sslSocket); &#125; &#125;&#125; å…³äº SSL æ›´å¤šçš„å†…å®¹ï¼Œå¯è‡ªè¡Œ google å°ç»“ ConnectInterceptor çš„ä½œç”¨æˆ‘ä»¬ç°åœ¨å¤§è‡´æœ‰ä¸ªè½®å»“äº†ï¼Œä½†æ€»æ„Ÿè§‰è¿˜ä¸å¤Ÿæ¸…æ™°ï¼Œéœ€è¦å¤šåŠ å·©å›ºï¼Œå…¶ä¸­æœ‰å…³äº X509TrustManagerï¼Œè‡ªå®šä¹‰è¯ä¹¦çš„ä¿¡ä»»ï¼Œå…¶ä»–çš„ç”± sslContext å¸®æˆ‘ä»¬åšäº†å¤„ç† å‰è¨€ æ¿€åŠ¨äººå¿ƒçš„æ—¶åˆ»å°†è¦æ¥äº†ï¼Œæˆ‘ä»¬å°†ä¼šçœ‹åˆ°æ•°æ®æ˜¯æ€ä¹ˆåœ¨å®¢æˆ·ç«¯æœåŠ¡ç«¯ä¹‹é—´è¿›è¡Œäº¤äº’çš„ï¼Œä½†æ˜¯å†æ­¤ä¹‹å‰ï¼Œæˆ‘ä»¬æœ‰å¿…è¦äº†è§£ä¸€ä¸‹ socket çº ç»“æ˜¯ä»€ä¹ˆä¸œè¥¿ï¼Œä¸ HTTP åè®®ï¼ŒTCP/IP åè®®ä¹‹é—´çš„å…³ç³»åˆæ˜¯å¦‚ä½•ï¼Œè¿™äº›ç†è®ºæš‚ä¸”è‡ªè¡ŒæŸ¥æ‰¾ï¼Œæˆ‘åœ¨è¿™æš‚ä¸”ç®€å•è¯´ä¸€è¯´ï¼Œsocket å¹¶ä¸æ˜¯åè®®ï¼Œå®ƒå®ç°äº† TCP/UDP çš„è¯­ä¹‰ï¼Œè€ŒHTTP æ˜¯å±äºåº”ç”¨å±‚çš„åè®®ï¼Œæˆ‘ä»¬å¹¶ä¸èƒ½ç›´æ¥ä½¿ç”¨ TCPã€UDP æ¥ä¼ è¾“æ•°æ®ï¼Œè€Œè¿™æ—¶å€™æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ socket æ¥å®ç°ã€‚å½“æˆ‘ä»¬ä½¿ç”¨ socket å»ºç«‹ TCP è¿æ¥ï¼Œä¹‹åä¾¿å¯ä»¥ä½¿ç”¨è¿™ä¸ªè¿æ¥ç”¨æ¥æ”¶å‘æ•°æ®ã€‚å½“ä½ å¯¹ HTTP åè®®äº†è§£æ·±å…¥äº†ï¼Œå°±ä¼šä½“ä¼šåˆ°è¿™ä¸­é—´çš„å¦™å¤„ï¼Œå»ºè®®æ˜¯çœ‹ä¸€ä¸‹ HTTP åè®®ï¼Œå¯ä»¥çœ‹ RFC å®˜æ–¹æ–‡æ¡£ï¼Œä¸‹æ¬¡åœ¨ç®€å†ä¸Šå¯ä»¥è¯´ç²¾é€š TCP/IPã€HTTP åè®®ï¼Œè¿™å¯æ¯”é¡¹ç›®å¸å¼•çœ¼çƒå¤šäº†ã€‚åˆæƒ³å»æ”¹ç®€å†äº† 12 | SOCKET |IP -&gt; TCP -&gt; HTTP HTTP åè®® è‹¥è¦ç†è§£ HTTP åè®®ï¼Œè«è¿‡äºä½¿ç”¨å®ƒï¼Œå®‰åˆ©ä¸€ä¸‹ wireshark è¿™ä¸ªå·¥å…·ï¼Œè¿˜æ˜¯è¶…çº§å¥½ç”¨çš„ï¼Œå¯ä»¥æ¸…æ¥šåœ°çœ‹åˆ°åŒ…çš„å†…å®¹ï¼Œå„å±‚åè®®å°è£…çš„å†…å®¹ï¼Œçœ‹å¤šäº†å°±ä¼šå¾ˆæ¸…æ¥šåŒ…é‡Œé¢çš„æ•°æ®æ ¼å¼ï¼Œä¹‹æ‰€ä»¥ç„¶è€ŒçŸ¥å…¶æ‰€ä»¥ç„¶ã€‚ æˆ‘ä»¬åœ¨ä½¿ç”¨ socket çš„æ—¶å€™ï¼Œé€šå¸¸å°±æ˜¯å¾€ socket é‡Œå†™å…¥ HTTP æ¶ˆæ¯ï¼Œä¸‹é¢ç»™å‡ºä¸¤ä¸ªç®€å•çš„ä¾‹å­ï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠè¿™äº›æ–‡æœ¬å†™å…¥æµä¸­ä¾¿å¯ï¼Œå³å¯å®Œæˆä¸€æ¬¡ç®€å•çš„ HTTP é€šä¿¡ï¼Œå½“ç„¶ï¼Œå®é™…çš„åè®®è¦æ¯”è¿™å¤æ‚å¾—å¤šï¼Œå¾ˆå¤šåè®®éœ€è¦æµè§ˆå™¨ä¸æœåŠ¡å™¨è‡ªè¡Œå®ç°ã€‚ Request 12345GET URL HTTP/1.1\\r\\n // è¯·æ±‚è¡ŒHost: www.cnblogs.com\\r\\n // è¯·æ±‚å¤´Connection: keep-alive\\r\\nAccept: application/json, text/javascript, */*; q=0.01\\r\\n\\r\\n Response 12345HTTP/1.1 200 OK\\r\\n // å“åº”è¡ŒDate: Wed, 22 Aug 2018 02:10:58 GMT\\r\\n // å“åº”å¤´...\\r\\n // ç©ºè¡ŒFile Data: 5 bytes // è¯·æ±‚æ•°æ® æºç è§£æ 1public final class CallServerInterceptor implements Interceptor &#123;&#125; é€šå¸¸ï¼Œæ˜¯ç”± httpCodec.writeRequestHeaders(request) å†™å…¥ socket æµä¸­ï¼Œç„¶åé€šè¿‡ flushRequest åˆ·æ–°ç¼“å­˜ï¼Œè¯·æ±‚ä¾¿å‘ç»™æœåŠ¡ç«¯äº†ï¼Œä¸­é—´å¯èƒ½é‡åˆ°å¾ˆå¤šæƒ…å†µ 100 å¦‚æœå®¢æˆ·ç«¯ä½¿ç”¨äº† Expectï¼š100-continueï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯ä¼šå…ˆå‘é€ headersï¼Œè·å–å“åº”ï¼Œå¦‚æœæœåŠ¡å™¨èƒ½å¤Ÿæ¥æ”¶å¹¶ä¸”å‘é€äº† 100 è¿”å›ç ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯ä¼šç»§ç»­å‘é€æ•°æ®æ„å»º Response 101 åè®®å‡çº§ï¼Œé‡æ–°æ„å»º Response 204 205 æ£€æŸ¥æ˜¯å¦æœ‰å¼‚å¸¸ 123456789101112131415161718192021222324252627282930313233343536373839404142434445@Override public Response intercept(Chain chain) throws IOException &#123; RealInterceptorChain realChain = (RealInterceptorChain) chain; HttpCodec httpCodec = realChain.httpStream(); StreamAllocation streamAllocation = realChain.streamAllocation(); RealConnection connection = (RealConnection) realChain.connection(); Request request = realChain.request(); long sentRequestMillis = System.currentTimeMillis(); realChain.eventListener().requestHeadersStart(realChain.call()); httpCodec.writeRequestHeaders(request); realChain.eventListener().requestHeadersEnd(realChain.call(), request); Response.Builder responseBuilder = null; if (HttpMethod.permitsRequestBody(request.method()) &amp;&amp; request.body() != null) &#123; // If there&apos;s a &quot;Expect: 100-continue&quot; header on the request, wait for a &quot;HTTP/1.1 100 // Continue&quot; response before transmitting the request body. If we don&apos;t get that, return // what we did get (such as a 4xx response) without ever transmitting the request body. if (&quot;100-continue&quot;.equalsIgnoreCase(request.header(&quot;Expect&quot;))) &#123; httpCodec.flushRequest(); realChain.eventListener().responseHeadersStart(realChain.call()); responseBuilder = httpCodec.readResponseHeaders(true); &#125; if (responseBuilder == null) &#123; // Write the request body if the &quot;Expect: 100-continue&quot; expectation was met. realChain.eventListener().requestBodyStart(realChain.call()); long contentLength = request.body().contentLength(); CountingSink requestBodyOut = new CountingSink(httpCodec.createRequestBody(request, contentLength)); BufferedSink bufferedRequestBody = Okio.buffer(requestBodyOut); request.body().writeTo(bufferedRequestBody); bufferedRequestBody.close(); realChain.eventListener() .requestBodyEnd(realChain.call(), requestBodyOut.successfulCount); &#125; else if (!connection.isMultiplexed()) &#123; // If the &quot;Expect: 100-continue&quot; expectation wasn&apos;t met, prevent the HTTP/1 connection // from being reused. Otherwise we&apos;re still obligated to transmit the request body to // leave the connection in a consistent state. streamAllocation.noNewStreams(); &#125; &#125; httpCodec.finishRequest(); å½“ç„¶ï¼Œå…¶ä¸­ä¹ŸåŒ…æ‹¬ httpsçš„ä¼ è¾“ï¼Œè€Œä½¿ç”¨ sslSocket æƒŠå–œåŠ å¯†é€šä¿¡ã€‚ å°ç»“ åŸºæœ¬ä¸Šæˆ‘ä»¬çœ‹åˆ°äº† OkHttp å¿…å¤‡çš„ Interceptorï¼Œå¤§è‡´çš„æµç¨‹æˆ‘ä»¬å·²ç»æ¸…æ¥šäº†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯ç»†èŠ‚æ¨å¯¼ï¼Œæˆ‘ä»¬æ—¶å¸¸æ›´æ–°ç»†èŠ‚","categories":[{"name":"Android","slug":"Android","permalink":"https://wzes.github.io/categories/Android/"},{"name":"Java","slug":"Android/Java","permalink":"https://wzes.github.io/categories/Android/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://wzes.github.io/tags/Java/"},{"name":"Android","slug":"Android","permalink":"https://wzes.github.io/tags/Android/"}]},{"title":"HTTP-Code-æ€»ç»“","slug":"Network/HTTP Code æ€»ç»“","date":"2018-08-23T06:29:00.000Z","updated":"2019-09-02T12:22:27.115Z","comments":true,"path":"2018/08/23/Network/HTTP Code æ€»ç»“/","link":"","permalink":"https://wzes.github.io/2018/08/23/Network/HTTP Code æ€»ç»“/","excerpt":"","text":"æ¯å¤©èƒŒä¸€ä¸ªçŠ¶æ€ç ç³»åˆ— 1xx Informational response 100 Continue é€šä¿—ç‚¹è¯´çš„è¯ï¼Œå¦‚æœæ˜¯POST è¯·æ±‚ï¼Œæˆ‘ä»¬çš„æäº¤çš„æ•°æ®è¶…è¿‡1024 ä¸ªå­—èŠ‚ï¼Œé‚£ä¹ˆæœåŠ¡å™¨å¯èƒ½ä¸æ¥å—ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å…ˆå‘ä¸€ä¸ªè¯·æ±‚ï¼Œåœ¨è¯·æ±‚å¤´é‡ŒåŠ å…¥ â€œExpectâ€:â€100-continueâ€ï¼Œè¯¢é—®æœåŠ¡å™¨æ˜¯å¦æ¥å—ï¼Œè¿™æ—¶å€™å¦‚æœæœåŠ¡å™¨èƒ½å¤Ÿæ¥æ”¶ï¼Œé‚£ä¹ˆæˆ‘ä»¬åœ¨æäº¤è¯·æ±‚ï¼Œè€Œä¸æ˜¯æˆ‘ä»¬ä¸€æ¬¡æ€§ç›´æ¥æäº¤æ•°æ®ï¼Œè¿™æ ·åšåœ¨ä¸€å®šç¨‹åº¦ä¸Šå‡ç¼“äº†æœåŠ¡å™¨ç«¯çš„å‹åŠ›ã€‚ ç»´åŸºç™¾ç§‘ä¸Šè¯´çš„ The server has received the request headers and the client should proceed to send the request body (in the case of a request for which a body needs to be sent; for example, a POST request). Sending a large request body to a server after a request has been rejected for inappropriate headers would be inefficient. To have a server check the requestâ€™s headers, a client must send Expect: 100-continueas a header in its initial request and receive a 100 Continue status code in response before sending the body. If the client receives an error code such as 403 (Forbidden) or 405 (Method Not Allowed) then it shouldnâ€™t send the requestâ€™s body. The response 417 Expectation Failed indicates that the request should be repeated without the Expect header as it indicates that the server doesnâ€™t support expectations (this is the case, for example, of HTTP/1.0 servers).[5] 101 Switching Protocols å°±æ˜¯è¯´ï¼Œå¦‚æœæœåŠ¡å™¨å‘ç°å¯¹æ–¹åœ¨ Upgrade ä¸­çš„åè®®ï¼Œå¦‚æœè‡ªå·±æœ‰æ”¯æŒæ›´åˆé€‚çš„ï¼Œä¼šå‘é€ 101 å“åº”ç ï¼Œå®¢æˆ·ç«¯æ”¶åˆ°åï¼Œæ›´æ¢åè®®é‡æ–°è®¿é—® The requester has asked the server to switch protocols and the server has agreed to do so 2xx Successful 200 OK é€šä¿—ç‚¹è¯´ï¼Œ200 è¡¨ç¤ºè¯·æ±‚æˆåŠŸï¼Œå¦‚æœæ˜¯ GET è¯·æ±‚ï¼Œé‚£å°±è¿”å›å®Œæˆçš„æ•°æ®ï¼Œå¦‚æœæ˜¯ POST è¯·æ±‚ï¼Œé‚£ä¹ˆè¿”å›æ“ä½œçš„æ‰§è¡Œç»“æœ Standard response for successful HTTP requests. The actual response will depend on the request method used. In a GET request, the response will contain an entity corresponding to the requested resource. In a POST request, the response will contain an entity describing or containing the result of the action 201 Created é€šå¸¸æ¥è¯´ï¼Œè¿™ä¸ªçŠ¶æ€å—ç”¨äº PUT è¯·æ±‚çš„è¿”å›ç ï¼Œè¯´çš„æ˜¯èµ„æºå·²ç»åˆ›å»ºï¼Œç„¶åæœåŠ¡å™¨å¯ä»¥å°†èµ„æºçš„åœ°å€å†™åˆ°å“åº”å¤´ä¸­çš„Locationå­—æ®µé‡Œï¼Œæˆ–è€…æ˜¯æ•°æ®é‡Œ The request has been fulfilled and resulted in a new resource being created. The newly created resource can be referenced by the URI(s) returned in the entity of the response, with the most specific URI for the resource given by a Location header field. The response SHOULD include an entity containing a list of resource characteristics and location(s) from which the user or user agent can choose the one most appropriate. The entity format is specified by the media type given in the Content-Type header field. The origin server MUST create the resource before returning the 201 status code. If the action cannot be carried out immediately, the server SHOULD respond with 202 (Accepted) response instead. A 201 response MAY contain an ETag response header field indicating the current value of the entity tag for the requested variant just created, see section 202 Accepted ä¸ 201 ä¸åŒï¼Œ202è¿”å›çš„è¯æ˜¯è¯·æ±‚æ²¡æœ‰å¤„ç†å®Œæˆï¼Œè¯¥è¯·æ±‚å¯ç”¨äºå¼‚æ­¥å¤„ç†çš„è¿”å›ç  The HyperText Transfer Protocol (HTTP) 202 Accepted response status code indicates that the request has been received but not yet acted upon. It is non-committal, meaning that there is no way for the HTTP to later send an asynchronous response indicating the outcome of processing the request. It is intended for cases where another process or server handles the request, or for batch processing. 204 No Content æœåŠ¡å™¨æˆåŠŸå“åº”ï¼Œä½†æ˜¯æ²¡æœ‰è¿”å›æ•°æ®ï¼Œå®¢æˆ·ç«¯ä¸åº”è¯¥å¯¹æ­¤åšå‡ºååº”ï¼Œä¹Ÿå°±æ˜¯è¯´æ²¡è¦è·³è½¬ If the client is a user agent, it SHOULD NOT change its document view from that which caused the request to be sent. This response is primarily intended to allow input for actions to take place without causing a change to the user agentâ€™s active document view, although any new or updated metainformation SHOULD be applied to the document currently in the user agentâ€™s active view. 205 Reset Content åŒæ ·ä¹Ÿæ˜¯æ²¡æœ‰æ•°æ®è¿”å›ï¼Œä½†æ˜¯å®¢æˆ·ç«¯åº”è¯¥é‡ç½®è¡¨å• The server successfully processed the request, but is not returning any content. Unlike a 204 response, this response requires that the requester reset the document view 206 Partial Content è¿”å›éƒ¨åˆ†æ•°æ®ï¼Œå¤šç”¨äºä¸‹è½½æ•°æ®ï¼Œå¦‚æœæ•°æ®é‡è¿‡å¤§ï¼Œå¯èƒ½éœ€è¦åˆ†æ®µä¸‹è½½ï¼Œåœ¨ Header æ˜¯ä»¥ Range è¡¨ç¤ºçš„ The HTTP 206 Partial Content success status response code indicates that the request has succeeded and has the body contains the requested ranges of data, as described in the Range header of the request. 3xx Redirect 300 Multiple Choices å¤šç§é€‰æ‹©ï¼Œå®¢æˆ·ç«¯æ”¶åˆ°ååº”è¯¥æ ¹æ® Location é€‰æ‹©å…¶ä¸­ä¸€ä¸ªè¯·æ±‚è¿›è¡Œè®¿é—® The HTTP 300 Multiple Choices redirect status response code indicates that the request has more than one possible responses. The user-agent or the user should choose one of them. As there is no standardized way of choosing one of the responses, this response code is very rarely used. 301 Moved Permanently æ°¸ä¹…ç§»åŠ¨åœ°å€ï¼Œä¼šåœ¨ Location ä¸­é™„ä¸Šæ–°åœ°å€ï¼Œå®¢æˆ·ç«¯å¯ä»¥æ ¹æ®è¿™ä¸ªåœ°å€è¿›è¡Œæ–°çš„è¯·æ±‚ï¼Œé€šå¸¸ç”¨äº HEAD å’Œ POST è¯·æ±‚ The HyperText Transfer Protocol (HTTP) **301 Moved Permanently** redirect status response code indicates that the resource requested has been definitively moved to the URL given by the Location headers. A browser redirects to this page and search engines update their links to the resource (in â€˜SEO-speakâ€™, it is said that the â€˜link-juiceâ€™ is sent to the new URL). Even if the specification requires the method (and the body) not to be altered when the redirection is performed, not all user-agents align with it - you can still find this type of bugged software out there. It is therefore recommended to use the 301 code only as a response for GET or HEAD methods and to use the 308 Permanent Redirect for POST methods instead, as the method change is explicitly prohibited with this status. 12HTTP/1.1 301 Moved PermanentlyLocation: http://www.example.org/index.asp 304 Not Modified æ¯”å¦‚è¯´ä¸€ä¸ª css æ–‡ä»¶ï¼Œå®¢æˆ·ç«¯ç¬¬äºŒæ¬¡åŠ è½½æ—¶åœ¨è¯·æ±‚å¤´é‡Œå¸¦ä¸Š cache-controlï¼šmax-age=0ï¼Œä»¥åŠ If-Modified-Sinceï¼Œå¦‚æœæœåŠ¡å™¨æ”¶åˆ°åï¼Œå‘ç°è¯·æ±‚çš„èµ„æºæ²¡æœ‰æ”¹å˜ï¼Œä¼šè¿”å›ä¸€ä¸ª 304ï¼Œè¿™æ ·å®¢æˆ·ç«¯å°±å¯ä»¥çŸ¥é“ä½¿ç”¨æœ¬åœ°çš„ç¼“å­˜èµ„æº Indicates that the resource has not been modified since the version specified by the request headers If-Modified-Since or If-None-Match. In such case, there is no need to retransmit the resource since the client still has a previously-downloaded copy.","categories":[{"name":"HTTP","slug":"HTTP","permalink":"https://wzes.github.io/categories/HTTP/"}],"tags":[{"name":"HTTP","slug":"HTTP","permalink":"https://wzes.github.io/tags/HTTP/"}]},{"title":"HTTP Request Response æ€»ç»“","slug":"Network/HTTP Request&Response æ€»ç»“","date":"2018-08-23T06:28:00.000Z","updated":"2019-09-02T12:22:34.491Z","comments":true,"path":"2018/08/23/Network/HTTP Request&Response æ€»ç»“/","link":"","permalink":"https://wzes.github.io/2018/08/23/Network/HTTP Request&Response æ€»ç»“/","excerpt":"","text":"Request æˆ‘ç”¨ wireshark å·¥å…·åˆ†æäº†ä¸€ä¸ª HTTP è¯·æ±‚ï¼Œå¯ä»¥çœ‹åˆ°å¤§è‡´çš„æ ¼å¼ å…¶ä¸­HTTPçš„æ˜æ–‡æ•°æ®æ ¼å¼å¦‚ä¸‹ 1234567GET URL HTTP/1.1\\r\\n // è¯·æ±‚è¡ŒHost: www.cnblogs.com\\r\\n // è¯·æ±‚å¤´Connection: keep-alive\\r\\nAccept: application/json, text/javascript, */*; q=0.01\\r\\n....\\r\\n // ç©ºè¡Œdata // å¦‚æœæ˜¯ POSTï¼Œå¯èƒ½æœ‰è¯·æ±‚æ•°æ® Accept-Encoding å¯æ¥å—çš„æ•°æ®å†…å®¹æ ¼å¼ï¼Œæ¯”å¦‚æ˜¯ gzipï¼ŒæœåŠ¡å™¨æ”¶åˆ°åæ ¹æ®è¿™ä¸ªä½¿ç”¨ gzip å‹ç¼©æ•°æ®ï¼Œå¹¶åœ¨ Content-Encoding ä¸­è¡¨æ˜æ•°æ®æ ¼å¼ï¼Œè¿™æ ·å®¢æˆ·ç«¯å°±å¯ä»¥æ¥æ”¶åˆ°è¿™ä¸ªä¿¡æ¯ Content-Encoding å‘é€çš„æ•°æ®å†…å®¹æ ¼å¼ï¼Œæ¯”å¦‚æ˜¯ gzipï¼ŒæœåŠ¡å™¨æ”¶åˆ°åæ ¹æ®è¿™ä¸ªä½¿ç”¨ gzip è§£å‹æ•°æ® Cookie æ ¼å¼ 12Set-Cookie: Name = Value; Comment = value; Domain = value; Max-Age = value; Path = Value;Secure; Version = 1 * DIGIT; Response æˆ‘ç”¨ wireshark å·¥å…·åˆ†æäº†ä¸€ä¸ª HTTP å“åº”è¯·æ±‚ï¼Œå¯ä»¥çœ‹åˆ°å¤§è‡´çš„æ ¼å¼ å…¶ä¸­HTTPçš„æ˜æ–‡æ•°æ®æ ¼å¼å¦‚ä¸‹ 12345HTTP/1.1 200 OK\\r\\n // å“åº”è¡ŒDate: Wed, 22 Aug 2018 02:10:58 GMT\\r\\n // å“åº”å¤´...\\r\\n // ç©ºè¡ŒFile Data: 5 bytes // è¯·æ±‚æ•°æ® Date Exampleï¼š Date: Tue, 15 Nov 1994 08:12:31 GMT è¿™ä¸ªæ˜¯å±äºæœåŠ¡å™¨çš„æ—¶é—´ï¼Œåœ¨RFCæ ‡å‡†é‡Œé¢ï¼ŒæœåŠ¡å™¨è¿”å›çš„æ•°æ®ä¸­å¿…é¡»åŒ…å«è¿™ä¸ªåŸŸï¼Œæœ‰ä¸‰ç§æƒ…å†µé™¤å¤– If the response status code is 100 (Continue) or 101 (Switching Protocols), the response MAY include a Date header field, at the serverâ€™s option 100 å’Œ 101 è¯·æ±‚å¯é€‰ If the response status code conveys a server error, e.g. 500 (Internal Server Error) or 503 (Service Unavailable), and it is inconvenient or impossible to generate a valid Date. æœåŠ¡å™¨å‡ºç°äº†é—®é¢˜ï¼Œè¿™æ—¶å€™ä¹Ÿå¯ä»¥ä¸èƒ½è¿”å› If the server does not have a clock that can provide a reasonable approximation of the current time, its responses MUST NOT include a Date header field. In this case, the rules is æœåŠ¡å™¨ä¸èƒ½æä¾›å¯é çš„æ—¶é—´æœåŠ¡ Some origin server implementations might not have a clock available.An origin server without a clock MUST NOT assign Expires or Last-Modified values to a response, unless these values were associated with the resource by a system or user with a reliable clock. It MAY assign an Expires value that is known, at or before server configuration time, to be in the past (this allows â€œpre-expirationâ€ of responses without storing separate Expires values for each resource).","categories":[{"name":"HTTP","slug":"HTTP","permalink":"https://wzes.github.io/categories/HTTP/"}],"tags":[{"name":"HTTP","slug":"HTTP","permalink":"https://wzes.github.io/tags/HTTP/"}]},{"title":"Java8 CopyOnWriteArrayList æºç è§£æ","slug":"Java/Java8 CopyOnWriteArrayList æºç è§£æ","date":"2018-08-21T09:11:00.000Z","updated":"2019-09-02T12:20:48.952Z","comments":true,"path":"2018/08/21/Java/Java8 CopyOnWriteArrayList æºç è§£æ/","link":"","permalink":"https://wzes.github.io/2018/08/21/Java/Java8 CopyOnWriteArrayList æºç è§£æ/","excerpt":"","text":"å‰è¨€ ä¸€çœ‹è¿™ä¸ªï¼Œå’‹è¿™ä¹ˆé•¿çš„åå­—ï¼Œè®°èµ·æ¥æœ‰ç‚¹éº»çƒ¦å‘€ï¼è¿™ä¸ªç±»ä½¿ç”¨çš„æƒ…å†µä¸å¤šï¼Œæœ€è¿‘åœ¨çœ‹EventBusçš„æ—¶å€™çœ‹åˆ°è¿‡ï¼Œæ‰€ä»¥è¿˜æ˜¯è·³å‡ºæ¥å­¦ä¹ ä¸€ä¸‹ï¼Œçœ‹ä¸€ä¸‹è¿™ä¸ªç±»çš„åºå±±çœŸé¢ç›® æ˜¯ä»€ä¹ˆä¸œè¥¿ï¼Ÿ CopyOnWriteï¼Œå¤§æ¦‚èƒ½çŒœåˆ°è·Ÿå†™æ—¶å¤åˆ¶æœ‰å…³ï¼Œä¸ºä»€ä¹ˆè¦æœ‰è¿™ä¸ªä¸œè¥¿ï¼Ÿä¸éš¾æƒ³å‡ºè¿™æ˜¯ä¸ºäº†çº¿ç¨‹å®‰å…¨è€Œè®¾è®¡çš„ï¼Œå¦åˆ™ç›´æ¥ç”¨ ArrayList å°±è¡Œäº†ï¼Œé‚£å¥½äº†ï¼Œè¯´çš„è¿™ä¸ªä¸œè¥¿å°±æ˜¯ä¸€ä¸ªArrayList ï¼Œåœ¨æ­¤åŸºç¡€ä¸Šï¼Œä»–æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œé‡‡ç”¨äº†å†™æ—¶å¤åˆ¶çš„æ–¹æ³•ï¼Œé‚£æˆ‘ä»¬å¯ä»¥æ€è€ƒä¸€ä¸‹ï¼Œä»–æ˜¯æ€ä¹ˆåšçš„ï¼Œå¦‚æœç»™æˆ‘ä»¬è®¾è®¡ï¼Œæˆ‘ä»¬è¦æ€ä¹ˆåšå‘¢ï¼Ÿ å‰ä¸–ä»Šç”Ÿ å®ƒæ²¡æœ‰æ‰©å±• ArrayListï¼Œå³ä½¿æ˜¯ä»¥æ­¤ç»“å°¾ï¼Œç›´æ¥å®ç°äº† Listï¼Œä¹Ÿå®ç°äº†RandomAccessï¼ŒCloneableï¼Œ Serializable æ¥å£ï¼ŒDoug Lea å†™çš„ï¼Œå°±æ˜¯å‰å®³ 12public class CopyOnWriteArrayList&lt;E&gt; implements List&lt;E&gt;, RandomAccess, Cloneable, java.io.Serializable æºç è§£æ å±æ€§ æˆ‘ä»¬çœ‹åˆ°äº†ä¸€ä¸ªé”ï¼Œèªæ˜çš„ä½ å¯èƒ½æƒ³åˆ°äº†ï¼Œæ˜¯ä¸æ˜¯å¯ä»¥åŠ é”æ¥å®ç°çº¿ç¨‹çš„å®‰å…¨ï¼Ÿåœ¨å†™çš„æ—¶å€™åŠ é”ï¼Œè¯»çš„æ—¶å€™å¯ä»¥ä¸ç”¨é” åŒæ ·ä½¿ç”¨äº† Volatile çš„ Object æ•°ç»„å­˜å‚¨å…ƒç´  ä¸¤ä¸ªfinal æ–¹æ³•è®¾ç½® elements 123456789101112131415161718192021222324/** * The lock protecting all mutators. (We have a mild preference * for builtin monitors over ReentrantLock when either will do.) */final transient Object lock = new Object();/** The array, accessed only via getArray/setArray. */// Android-changed: renamed array -&gt; elements for backwards compatibility b/33916927private transient volatile Object[] elements;/** * Gets the array. Non-private so as to also be accessible * from CopyOnWriteArraySet class. */final Object[] getArray() &#123; return elements;&#125;/** * Sets the array. */final void setArray(Object[] a) &#123; elements = a;&#125; æ„é€ å‡½æ•°ï¼Œé»˜è®¤å¤§å°ä¸º0ï¼Œä¹Ÿå¯ä»¥ä¼ å…¥é›†åˆç±»å¯¹è±¡è¿›è¡Œå¤åˆ¶ï¼Œæˆ–è€…ç›´æ¥ä¼ å…¥æ•°ç»„ï¼Œè¿™é‡Œç”¨åˆ°äº† Arrays.copyOfï¼Œè¿™æ˜¯ä¸€ä¸ªæ•°ç»„å¤åˆ¶çš„é™æ€å‡½æ•°ï¼Œåº•å±‚ä½¿ç”¨äº†System.arraycopyï¼Œæ•ˆç‡å¾ˆé«˜ï¼Œåæ‚”äº†ä¸€ä¸ªæ–°çš„æ•°ç»„ 123456789101112131415161718192021222324252627282930313233343536373839/** * Creates an empty list. */public CopyOnWriteArrayList() &#123; setArray(new Object[0]);&#125;/** * Creates a list containing the elements of the specified * collection, in the order they are returned by the collection&apos;s * iterator. * * @param c the collection of initially held elements * @throws NullPointerException if the specified collection is null */public CopyOnWriteArrayList(Collection&lt;? extends E&gt; c) &#123; Object[] elements; if (c.getClass() == CopyOnWriteArrayList.class) elements = ((CopyOnWriteArrayList&lt;?&gt;)c).getArray(); else &#123; elements = c.toArray(); // defend against c.toArray (incorrectly) not returning Object[] // (see e.g. https://bugs.openjdk.java.net/browse/JDK-6260652) if (elements.getClass() != Object[].class) elements = Arrays.copyOf(elements, elements.length, Object[].class); &#125; setArray(elements);&#125;/** * Creates a list holding a copy of the given array. * * @param toCopyIn the array (a copy of this array is used as the * internal array) * @throws NullPointerException if the specified array is null */public CopyOnWriteArrayList(E[] toCopyIn) &#123; setArray(Arrays.copyOf(toCopyIn, toCopyIn.length, Object[].class));&#125; å‡½æ•° get æ²¡æœ‰åŠ é”ï¼Œç›´æ¥è¿”å›ï¼Œç”±äºvolatileï¼Œèƒ½ä¿è¯è¯»åˆ°æœ€æ–°çš„å€¼ 123private E get(Object[] a, int index) &#123; return (E) a[index];&#125; setï¼Œæœä¸å…¶ç„¶ï¼Œå¯¹æ·»åŠ æ•°æ®ä½¿ç”¨äº†åŠ é”ï¼Œé¦–å…ˆæ£€æŸ¥è¿™ä¸ªä½ç½®æ˜¯å¦å­˜åœ¨å¯¹è±¡ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œé‚£ä¹ˆéœ€è¦æ‹·è´ä¸€ä¸ªæ–°çš„æ•°ç»„ï¼Œå¹¶ä¸”æ·»åŠ ä¸€ä¸ªå…ƒç´ ï¼Œåœ¨è°ƒç”¨elementsæ›´æ–°å±æ€§ï¼›å¦‚æœå­˜åœ¨äº†ï¼Œä¹Ÿéœ€è¦è®¾ç½®æ•°ç»„ï¼Œä¿è¯volatileçš„è¯­ä¹‰ï¼Œè¿™é‡Œä¸æ˜¯å¾ˆæ˜ç™½ï¼Œæ—¢ç„¶éƒ½åŠ äº†é”ï¼Œä¸éœ€è¦æ›´æ–°æ•°æ®æ—¶è¿˜è¦æ›´æ–°æ•°æ®ã€‚æœ€åè¿”å› oldValueã€‚ è‡³äºä¸ºä»€ä¹ˆï¼Œåœ¨è¿™é‡Œçœ‹åˆ°æœ‰äººè®¨è®º concurrency-interestï¼Œä½†æ„Ÿè§‰ä¹Ÿæ²¡æœ‰æ•°æ¸…æ¥šï¼Œä¸è¿‡æˆ‘çœ‹åˆ°äº†ï¼Œä¹‹å‰çš„jdkç‰ˆæœ¬ä½¿ç”¨äº† Lockè€Œä¸æ˜¯ synchronized ï¼Œå¯è§synchronized çš„æ€§èƒ½ä»¥åŠå¤§å¤§æé«˜ 1234567891011121314151617public E set(int index, E element) &#123; synchronized (lock) &#123; Object[] elements = getArray(); E oldValue = get(elements, index); if (oldValue != element) &#123; int len = elements.length; Object[] newElements = Arrays.copyOf(elements, len); newElements[index] = element; setArray(newElements); &#125; else &#123; // Not quite a no-op; ensures volatile write semantics setArray(elements); &#125; return oldValue; &#125;&#125; addï¼Œä¾ç„¶ä½¿ç”¨é”ï¼ŒåŒæ ·å…ˆè¯»æ•°ç»„ï¼Œåœ¨å¤åˆ¶å‡ºä¸€ä¸ªæ–°çš„æ•°ç»„ï¼Œæ³¨æ„ï¼Œæ•°ç»„é•¿åº¦ä¸º len + 1ï¼Œé¢„ç•™äº†ä¸€ä¸ªä½ç½®ï¼Œå› æ­¤è¿™ä¸ªæ•°æ®ç»“æ„å¹¶æ²¡æœ‰ç±»ä¼¼ *2 çš„æ‰©å®¹æœºåˆ¶ï¼Œè€Œæ˜¯ä¸€ä¸ªä¸€ä¸ªæ·»åŠ ï¼Œä¸ªäººè§‰å¾—è¿™æ ·æ•ˆç‡ä¼šå¤§æ‰“æŠ˜æ‰£ï¼Œå½“ç„¶ï¼Œä¸ºäº† tradeoffã€‚åœ¨æ·»åŠ å…ƒç´ ï¼Œæœ€åè¿”å›true 12345678910public boolean add(E e) &#123; synchronized (lock) &#123; Object[] elements = getArray(); int len = elements.length; Object[] newElements = Arrays.copyOf(elements, len + 1); newElements[len] = e; setArray(newElements); return true; &#125;&#125; addï¼Œåœ¨æŸä¸ªä½ç½®æ’å…¥ä¸€ä¸ªå…ƒç´ ï¼Œé¦–å…ˆå…ˆæ£€æŸ¥indexï¼Œçœ‹æ˜¯å¦è¶Šç•Œï¼Œè¿™é‡Œä½¿ç”¨äº†ä¸€ä¸ªå°æŠ€å·§ï¼Œè®¡ç®—äº†ç§»åŠ¨è·ç¦»ï¼Œå¦‚æœä¸º0ï¼Œå³æ·»åŠ åˆ°æœ€åï¼Œåˆ™ç›´æ¥å¤åˆ¶ï¼Œå¦åˆ™å°±éœ€è¦è°ƒç”¨ä¸¤æ¬¡ copy å‡½æ•°è¿›è¡Œå¤åˆ¶ 1234567891011121314151617181920public void add(int index, E element) &#123; synchronized (lock) &#123; Object[] elements = getArray(); int len = elements.length; if (index &gt; len || index &lt; 0) throw new IndexOutOfBoundsException(outOfBounds(index, len)); Object[] newElements; int numMoved = len - index; if (numMoved == 0) newElements = Arrays.copyOf(elements, len + 1); else &#123; newElements = new Object[len + 1]; System.arraycopy(elements, 0, newElements, 0, index); System.arraycopy(elements, index, newElements, index + 1, numMoved); &#125; newElements[index] = element; setArray(newElements); &#125;&#125; remove å¯ä»¥åˆ é™¤æŸä¸ªç´¢å¼•çš„å…ƒç´  123456789101112131415161718public E remove(int index) &#123; synchronized (lock) &#123; Object[] elements = getArray(); int len = elements.length; E oldValue = get(elements, index); int numMoved = len - index - 1; if (numMoved == 0) setArray(Arrays.copyOf(elements, len - 1)); else &#123; Object[] newElements = new Object[len - 1]; System.arraycopy(elements, 0, newElements, 0, index); System.arraycopy(elements, index + 1, newElements, index, numMoved); setArray(newElements); &#125; return oldValue; &#125;&#125; removeä¹Ÿå¯ä»¥åˆ é™¤æŸä¸ªå¯¹è±¡ï¼Œä¸è¿‡éœ€è¦éå†æ•°ç»„ 12345678910111213141516171819public boolean remove(Object o) &#123; Object[] snapshot = getArray(); int index = indexOf(o, snapshot, 0, snapshot.length); return (index &lt; 0) ? false : remove(o, snapshot, index);&#125;private static int indexOf(Object o, Object[] elements, int index, int fence) &#123; if (o == null) &#123; for (int i = index; i &lt; fence; i++) if (elements[i] == null) return i; &#125; else &#123; for (int i = index; i &lt; fence; i++) if (o.equals(elements[i])) return i; &#125; return -1;&#125; æœ€åè¿˜æ˜¯è°ƒç”¨è¿™ä¸ªï¼Œä¹Ÿæ˜¯çº¿ç¨‹å®‰å…¨çš„å‡½æ•°ï¼Œé€»è¾‘ä¹Ÿå¾ˆç®€å• 123456789101112131415161718192021222324252627282930private boolean remove(Object o, Object[] snapshot, int index) &#123; synchronized (lock) &#123; Object[] current = getArray(); int len = current.length; if (snapshot != current) findIndex: &#123; int prefix = Math.min(index, len); for (int i = 0; i &lt; prefix; i++) &#123; if (current[i] != snapshot[i] &amp;&amp; Objects.equals(o, current[i])) &#123; index = i; break findIndex; &#125; &#125; if (index &gt;= len) return false; if (current[index] == o) break findIndex; index = indexOf(o, current, index, len); if (index &lt; 0) return false; &#125; Object[] newElements = new Object[len - 1]; System.arraycopy(current, 0, newElements, 0, index); System.arraycopy(current, index + 1, newElements, index, len - index - 1); setArray(newElements); return true; &#125;&#125; removeRange åˆ é™¤ä¸€å®šèŒƒå›´ï¼Œä¸ç”¨è¯´äº†ï¼Œç›¸ä¿¡ä»–çš„ä»£ç ä½ æ—©å°±çŸ¥é“è¯¥æ€ä¹ˆå†™äº† 12345void removeRange(int fromIndex, int toIndex) &#123; synchronized (lock) &#123; ..... &#125;&#125; addIfAbsent å¦‚æœä¸å­˜åœ¨æ‰æ·»åŠ  123456789101112131415161718192021222324252627282930public boolean addIfAbsent(E e) &#123; Object[] snapshot = getArray(); return indexOf(e, snapshot, 0, snapshot.length) &gt;= 0 ? false : addIfAbsent(e, snapshot);&#125;/** * A version of addIfAbsent using the strong hint that given * recent snapshot does not contain e. */private boolean addIfAbsent(E e, Object[] snapshot) &#123; synchronized (lock) &#123; Object[] current = getArray(); int len = current.length; if (snapshot != current) &#123; // Optimize for lost race to another addXXX operation int common = Math.min(snapshot.length, len); for (int i = 0; i &lt; common; i++) if (current[i] != snapshot[i] &amp;&amp; Objects.equals(e, current[i])) return false; if (indexOf(e, current, common, len) &gt;= 0) return false; &#125; Object[] newElements = Arrays.copyOf(current, len + 1); newElements[len] = e; setArray(newElements); return true; &#125;&#125; ç±»ä¼¼è¿˜æœ‰ addAllIfAbsentï¼Œå†™å¾—è¿˜æ˜¯å¾ˆä¸é”™çš„ï¼Œæ¯•ç«Ÿæ˜¯ Doug Lea 1234567891011121314151617181920212223public int addAllAbsent(Collection&lt;? extends E&gt; c) &#123; Object[] cs = c.toArray(); if (cs.length == 0) return 0; synchronized (lock) &#123; Object[] elements = getArray(); int len = elements.length; int added = 0; // uniquify and compact elements in cs for (int i = 0; i &lt; cs.length; ++i) &#123; Object e = cs[i]; if (indexOf(e, elements, 0, len) &lt; 0 &amp;&amp; indexOf(e, cs, 0, added) &lt; 0) cs[added++] = e; &#125; if (added &gt; 0) &#123; Object[] newElements = Arrays.copyOf(elements, len + added); System.arraycopy(cs, 0, newElements, len, added); setArray(newElements); &#125; return added; &#125;&#125; å°ç»“ åˆ†æåˆ«äººçš„æºç çš„è¿‡ç¨‹æœ¬èº«å°±æ˜¯ä¸€ä¸ªå­¦ä¹ çš„è¿‡ç¨‹ï¼Œèƒ½ä»ä¸­å­¦åˆ°å¾ˆå¤šæ–°çš„ä¸œè¥¿ï¼Œå¹¶ä¸”èƒ½å¤Ÿå·©å›ºä»¥å‰çš„çŸ¥è¯†ã€‚ æ¬¢è¿è®¨è®ºï½","categories":[{"name":"Java","slug":"Java","permalink":"https://wzes.github.io/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://wzes.github.io/tags/Java/"}]},{"title":"Java8 ThreadLocal æºç è§£æ","slug":"Java/Java8 ThreadLocal æºç è§£æ","date":"2018-08-20T15:16:00.000Z","updated":"2019-09-02T12:21:15.926Z","comments":true,"path":"2018/08/20/Java/Java8 ThreadLocal æºç è§£æ/","link":"","permalink":"https://wzes.github.io/2018/08/20/Java/Java8 ThreadLocal æºç è§£æ/","excerpt":"","text":"å‰è¨€ ThreadLocal ï¼Œåƒæ˜¯ä¸€ä¸ªç¥ç§˜çš„é»‘è¡£äººï¼Œä»¤äººæœ›è€Œç”Ÿç•ã€‚å”¯æœ‰ä¸‹å®šå†³å¿ƒï¼Œä¸€æ¢ç©¶ç«Ÿï¼Œæ–¹èƒ½è§£å¼€ä»–ç¥ç§˜çš„é¢çº±ã€åœ¨Androidä¸­ï¼ŒHandlerï¼ŒEventBusï¼ŒConnectionPool ç­‰ç­‰ï¼Œéƒ½æ›¾å‡ºç°å®ƒçš„èº«å½± æ˜¯ä»€ä¹ˆä¸œè¥¿ï¼Ÿ çœ‹åˆ°Threadï¼Œå°±æƒ³åˆ°åº”è¯¥æ˜¯ä¸çº¿ç¨‹æœ‰å…³å§ï¼Œå…¶æ¬¡ï¼ŒLocalæ˜¯è¯´æœ¬åœ°ï¼Œé‚£ç»„åˆèµ·æ¥å°±æ˜¯çº¿ç¨‹ç§æœ‰ï¼Œå°±æ˜¯è¯´æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰å¤‡ä»½ï¼Œå„å¤‡ä»½ä¸æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œä»–çš„ç”¨é€”å°±æ˜¯è®©å„ä¸ªçº¿ç¨‹æ‹¥æœ‰ä¸ç”¨çš„å¯¹è±¡ï¼Œå®ƒçš„å¯¹è±¡éƒ½æ˜¯ new å‡ºæ¥çš„ï¼Œå“ªæœ‰äººå¯èƒ½ä¼šé—®ï¼Œæ—¢ç„¶æ˜¯ new å‡ºæ¥çš„ï¼Œé‚£ä¸ºä»€ä¹ˆè¿˜è¦ç”¨ ThreadLocalï¼Œç›´æ¥ new ä¸€ä¸ªå¯¹è±¡ä¸å°±è¡Œäº†ï¼Œä½ å¦‚æœä¸ä»”ç»†äº†è§£ ThreadLocalï¼Œå°±å¾ˆéš¾è§£ç­”è¿™æ ·çš„é—®é¢˜ å‰ä¸–ä»Šç”Ÿ æ˜¯ä¸€ä¸ªæ³›å‹ç±» 1public class ThreadLocal&lt;T&gt; &#123;&#125; æºç è§£æ å±æ€§ nextHashCode æ˜¯è·å– hashcode å€¼ï¼ŒHASH_INCREMENT åˆå§‹å€¼ä¸º0x61c88647ï¼ŒnextHashCode()å‡½æ•°æ¯æ¬¡è°ƒç”¨å¢åŠ å¢é‡è·å–ä¸‹ä¸€ä¸ªå€¼ï¼Œå¤§å®¶å¯ä»¥å¥½å¥½çœ‹çœ‹Atomicçš„å®ç°ï¼Œä»¥åŠåº•å±‚Unsafeçš„è¯­ä¹‰ 12345678910111213141516171819202122private final int threadLocalHashCode = nextHashCode();/** * The next hash code to be given out. Updated atomically. Starts at * zero. */private static AtomicInteger nextHashCode = new AtomicInteger();/** * The difference between successively generated hash codes - turns * implicit sequential thread-local IDs into near-optimally spread * multiplicative hash values for power-of-two-sized tables. */private static final int HASH_INCREMENT = 0x61c88647;/** * Returns the next hash code. */private static int nextHashCode() &#123; return nextHashCode.getAndAdd(HASH_INCREMENT);&#125; å‡½æ•° åˆå§‹å€¼å‡½æ•° 123protected T initialValue() &#123; return null;&#125; set ï¼Œå°†å€¼æ‹·è´åˆ°å½“å‰çº¿ç¨‹ï¼Œä½¿ç”¨ThreadLocalMapï¼Œè¿™æ˜¯ä¸€ä¸ªå†…éƒ¨ç±»ï¼Œè¦äº†è§£ThreadLocalï¼Œè¿™ä¸ªç±»æ˜¯ä¸å¾—ä¸äº†è§£çš„ 123456789101112public void set(T value) &#123; Thread t = Thread.currentThread(); ThreadLocalMap map = getMap(t); if (map != null) map.set(this, value); else createMap(t, value);&#125;ThreadLocalMap getMap(Thread t) &#123; return t.threadLocals;&#125; ä¸€æ¢ThreadLocalMapï¼Œå‰æ–¹é«˜èƒ½ï¼Œä»–æ˜¯ä¸€ä¸ªé™æ€å†…éƒ¨ç±»ï¼Œç±»ä¼¼äºWeakHashMapï¼Œåªä¸è¿‡ä»–æ²¡æœ‰WeakHashMapé‚£ä¹ˆå¼ºå¤§ï¼Œæ²¡æœ‰Mapé‚£ä¹ˆå¤šçš„æ¥å£ï¼Œä¸è¿‡ä½œä¸ºä¸€ä¸ªå†…éƒ¨ç±»ï¼Œåªéœ€è¦ä¸ºThreadLocalæœåŠ¡å°±å¯ä»¥äº†ï¼Œè¿™ä¸€æ¡å¯ä»¥åœ¨EffectiveJavaé‡Œæ‰¾åˆ°ï¼ŒåºŸè¯ä¸å¤šè¯´ï¼Œçœ‹ä¸€ä¸‹ä»–çš„Entryï¼Œç»§æ‰¿è‡ªWeakReferenceï¼Œå…³äºWeakReferenceï¼Œåˆå¯ä»¥èŠ±å¤§ç¯‡å¹…æ¥ä»‹ç»äº†ï¼Œä¸è¿‡ç°åœ¨æš‚æ—¶ä¸è¯´äº†ï¼Œä½ åªè¦è®°ä½å½“å‘ç”ŸGCçš„æ—¶å€™ï¼ŒWeakReferenceçš„å¯¹è±¡éƒ½ä¼šè¢«å›æ”¶ã€‚åŒæ ·å†…éƒ¨ä¹Ÿæ˜¯ç”¨Entryæ•°ç»„ï¼Œé»˜è®¤å¤§å°ä¸º16ï¼Œset å‡½æ•°éœ€è¦æ³¨æ„çš„æ˜¯å¦‚ä½•å¤„ç†å“ˆå¸Œç¢°æ’çš„é—®é¢˜ï¼Œè¿™é‡Œæ‰¯ä¸€ä¸‹ï¼Œå¤„ç†å“ˆå¸Œç¢°æ’çš„å¦‚HashMapä½¿ç”¨äº†æ‹‰é“¾æ³•ï¼Œè€Œè¿™é‡Œä½¿ç”¨äº†ç®€å•çš„å¼€å‘åœ°å€æ³•ï¼Œå…·ä½“æ¥è¯´å°±æ˜¯å¦‚æœå‘ç”Ÿäº†ç¢°æ’ï¼Œå°±ä½ç½®å°±+1ï¼Œä¸€ç›´åˆ°æœ‰ä½ç½®ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273static class ThreadLocalMap &#123; /** * The entries in this hash map extend WeakReference, using * its main ref field as the key (which is always a * ThreadLocal object). Note that null keys (i.e. entry.get() * == null) mean that the key is no longer referenced, so the * entry can be expunged from table. Such entries are referred to * as &quot;stale entries&quot; in the code that follows. */ static class Entry extends WeakReference&lt;ThreadLocal&lt;?&gt;&gt; &#123; /** The value associated with this ThreadLocal. */ Object value; Entry(ThreadLocal&lt;?&gt; k, Object v) &#123; super(k); value = v; &#125; /** * The initial capacity -- MUST be a power of two. */ private static final int INITIAL_CAPACITY = 16; /** * The table, resized as necessary. * table.length MUST always be a power of two. */ private Entry[] table; /** * The number of entries in the table. */ private int size = 0; /** * The next size value at which to resize. */ private int threshold; // Default to 0 &#125; // set å‡½æ•°ï¼ŒåŒæ ·ä¹Ÿæ˜¯ä½¿ç”¨keyçš„hashcode ä¸ len-1çš„ // ä¸å€¼ private void set(ThreadLocal&lt;?&gt; key, Object value) &#123; // We don&apos;t use a fast path as with get() because it is at // least as common to use set() to create new entries as // it is to replace existing ones, in which case, a fast // path would fail more often than not. Entry[] tab = table; int len = tab.length; int i = key.threadLocalHashCode &amp; (len-1); for (Entry e = tab[i]; e != null; e = tab[i = nextIndex(i, len)]) &#123; ThreadLocal&lt;?&gt; k = e.get(); if (k == key) &#123; e.value = value; return; &#125; if (k == null) &#123; replaceStaleEntry(key, value, i); return; &#125; &#125; tab[i] = new Entry(key, value); int sz = ++size; if (!cleanSomeSlots(i, sz) &amp;&amp; sz &gt;= threshold) rehash(); &#125; æœ€é‡è¦çš„ get å‡½æ•°ï¼Œæˆ‘ä»¬éœ€è¦è®°ä½çš„æ˜¯ï¼Œæ¯ä¸ªçº¿ç¨‹æœ‰ä¸€ä¸ªThreadLocalMapï¼Œæ¯ä¸ªMapå¯ä»¥æ”¾å¾ˆå¤šä¸ªå€¼ï¼Œä¹Ÿå°±æ˜¯ä¸ç”¨çš„ThreadLocalå¯¹è±¡ã€‚å¦‚æœGet ä¸åˆ°æ•°æ®çš„è¯ï¼Œå°±ä¼šè°ƒç”¨InitialValueå‡½æ•°è¿›è¡Œèµ‹å€¼ï¼Œæ‰€ä»¥æœ‰æ—¶å€™æˆ‘ä»¬ä¼šé‡å†™è¿™ä¸ªå‡½æ•°ï¼Œä»¥ä¿è¯getå‡½æ•°éƒ½èƒ½è·å–åˆ°æ­£ç¡®çš„å€¼ 123456789101112131415161718192021/** * Returns the value in the current thread&apos;s copy of this * thread-local variable. If the variable has no value for the * current thread, it is first initialized to the value returned * by an invocation of the &#123;@link #initialValue&#125; method. * * @return the current thread&apos;s value of this thread-local */public T get() &#123; Thread t = Thread.currentThread(); ThreadLocalMap map = getMap(t); if (map != null) &#123; ThreadLocalMap.Entry e = map.getEntry(this); if (e != null) &#123; @SuppressWarnings(&quot;unchecked&quot;) T result = (T)e.value; return result; &#125; &#125; return setInitialValue();&#125; ç”±äºä½¿ç”¨äº†WeakReferenceï¼Œå¯èƒ½ä¼šå­˜åœ¨å€¼ä¸¢å¤±ï¼Œé‚£ThreadLocalMapåˆæ˜¯æ€ä¹ˆå¤„ç†è¿™ç§æƒ…å†µå‘¢ï¼Ÿé¦–å…ˆè‡ªç„¶æ˜¯å¤„ç†hashç¢°æ’çš„é—®é¢˜ï¼Œé€šè¿‡nextIndexæ¥éå†ï¼Œå…¶ä¸­å¦‚æœå‡ºç°æŸä¸ªkeyè·å–ä¸åˆ°çš„è¯ï¼Œå°±ä¼šæ‰§è¡Œ expungeStaleEntry(i) åˆ é™¤æ—§çš„entryï¼Œå…·ä½“çš„åšæ³•å°±æ˜¯åˆ é™¤è¿™ä¸ªentryï¼Œä»¥åŠä¹‹åå‡ºç°ä¸ºç©ºçš„æ‰€æœ‰entry 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152private Entry getEntryAfterMiss(ThreadLocal&lt;?&gt; key, int i, Entry e) &#123; Entry[] tab = table; int len = tab.length; while (e != null) &#123; ThreadLocal&lt;?&gt; k = e.get(); if (k == key) return e; if (k == null) expungeStaleEntry(i); else i = nextIndex(i, len); e = tab[i]; &#125; return null; &#125; private int expungeStaleEntry(int staleSlot) &#123; Entry[] tab = table; int len = tab.length; // expunge entry at staleSlot tab[staleSlot].value = null; tab[staleSlot] = null; size--; // Rehash until we encounter null Entry e; int i; for (i = nextIndex(staleSlot, len); (e = tab[i]) != null; i = nextIndex(i, len)) &#123; ThreadLocal&lt;?&gt; k = e.get(); if (k == null) &#123; e.value = null; tab[i] = null; size--; &#125; else &#123; int h = k.threadLocalHashCode &amp; (len - 1); if (h != i) &#123; tab[i] = null; // Unlike Knuth 6.4 Algorithm R, we must scan until // null because multiple entries could have been stale. while (tab[h] != null) h = nextIndex(h, len); tab[h] = e; &#125; &#125; &#125; return i; &#125; å°ç»“ ä¸€ä¸ª ThreadLocal ç«ŸåŒ…å«äº†å¦‚æ­¤å¤šçš„çŸ¥è¯†ï¼Œå½“ä½ ç†Ÿè¯»å„ç§æºç çš„æ—¶å€™ï¼Œå„ç§è®¾è®¡æ¨¡å¼ï¼Œå„ç§ç»†èŠ‚ï¼Œä½œè€…å®ç°çš„éå¸¸æœ‰å€Ÿé‰´æ„ä¹‰ï¼Œç†è§£äº†è¿™æ ·çš„æºç ï¼Œåœ¨ä»Šåçš„é¡¹ç›®ä¸­ä½¿ç”¨ç±»ä¼¼çš„ï¼Œä¾¿å¯ä»¥çŸ¥å…¶ç„¶çŸ¥å…¶æ‰€ä»¥ç„¶ï¼Œåšåˆ°å„ç§æ¡†æ¶çš„æ·±åº¦å®šåˆ¶ï¼Œç”šè‡³å®ç°è‡ªå·±çš„æ¡†æ¶ï¼ æ¬¢è¿è®¨è®ºï½","categories":[{"name":"Java","slug":"Java","permalink":"https://wzes.github.io/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://wzes.github.io/tags/Java/"}]},{"title":"Java8-ThreadLocal-æºç è§£æ","slug":"Java/Java8 å…³äºæœ€ä½³çº¿ç¨‹æ•°","date":"2018-08-20T15:16:00.000Z","updated":"2019-09-02T12:21:30.398Z","comments":true,"path":"2018/08/20/Java/Java8 å…³äºæœ€ä½³çº¿ç¨‹æ•°/","link":"","permalink":"https://wzes.github.io/2018/08/20/Java/Java8 å…³äºæœ€ä½³çº¿ç¨‹æ•°/","excerpt":"","text":"å‰è¨€ å…³äºæœ€ä½³çº¿ç¨‹æ•°çš„è®¾ç½®ï¼Œæ€»æ˜¯é‚£ä¹ˆæ¨¡ç³Šï¼Œä¸çŸ¥é“è¯¥å¦‚ä½•è®¾ç½®ï¼Œå¶ç„¶é—´åœ¨ Java å¹¶å‘ç¼–ç¨‹å®è·µ é‡Œçœ‹åˆ°äº†å¯¹ä»–çš„å®šä¹‰ï¼š è¦ä½¿å¤„ç†å™¨è¾¾åˆ°æœŸæœ›çš„ä½¿ç”¨ç‡ï¼Œçº¿ç¨‹æ± çš„æœ€ä½³å¤§å°ç­‰äºï¼š éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬éœ€è¦åˆ¶å®šä¸€ä¸ª CPU çš„åˆ©ç”¨ç‡ï¼Œå¦‚æœæ˜¯ 100%ï¼Œé‚£ä¹ˆçº¿ç¨‹æ•°å°±å–å†³äºWait Time / Compute Time å¦‚æœæˆ‘ä»¬çš„ä»»åŠ¡æ˜¯è®¡ç®—å‹ä»»åŠ¡ï¼Œé‚£ä¹ˆç­‰å¾…æ—¶é—´ä¸ºé›¶ï¼Œé‚£ä¹ˆçº¿ç¨‹æ•°è®¾ç½®ä¸º CPU + 1 å¦‚æœæˆ‘ä»¬çš„ä»»åŠ¡æ˜¯ IO å¯†é›†å‹ï¼Œé‚£ä¹ˆç­‰å¾…æ—¶é—´ä¸ä¸ºé›¶ï¼Œéœ€è¦åŠ å¤§çº¿ç¨‹æ•° Java ä¸­è·å–å¯ç”¨çš„ CPU æ•° 1Int NUM_CPU = Runtime.getRuntime().availableProcessors(); æˆ‘ä»¬å¯ä»¥åœ¨å¾ˆå¤šç±»åº“é‡Œè¾¹çœ‹åˆ°å®ƒçš„èº«å½±ï¼Œå¾ˆå¤šéœ€è¦çº¿ç¨‹æ± çš„ç±»åº“ï¼Œå‡¡æ˜¯ä¸é‚£ä¹ˆæŠ¢ç³»ç»Ÿèµ„æºçš„éƒ½ä¼šé€šè¿‡è¿™ä¸ªå€¼è®¾ç½®çº¿ç¨‹æ± çš„å¤§å°","categories":[{"name":"Java","slug":"Java","permalink":"https://wzes.github.io/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://wzes.github.io/tags/Java/"}]},{"title":"Android EventBus æºç è§£æ","slug":"Android/EventBus","date":"2018-08-19T13:09:00.000Z","updated":"2019-09-02T12:18:23.891Z","comments":true,"path":"2018/08/19/Android/EventBus/","link":"","permalink":"https://wzes.github.io/2018/08/19/Android/EventBus/","excerpt":"","text":"åŸºäºæœ€æ–°çš„ 3.1.1 åˆ†æ å‰è¨€ ä¹‹å‰åˆ†æçš„éƒ½æ˜¯å®˜æ–¹åº“çš„ä¸€äº›æºç ï¼Œç°åœ¨æ‰“ç®—å°è¯•åˆ†æä¸€äº›æ¯”è¾ƒä¼˜ç§€çš„ç¬¬ä¸‰æ–¹å¼€æºåº“ï¼Œé€‰æ‹©åˆ†æEventBusï¼Œä¸€æ–¹é¢æ˜¯å› ä¸ºä»–çš„åº“ä¸å¤§ï¼Œå®¹æ˜“ç†è§£ï¼Œè¿™æ ·æˆ‘ä»¬ä¹Ÿå®¹æ˜“æ¥å—ï¼Œå¦‚æœä¸€å¼€å§‹å°±é¡¹åˆ†æå¾ˆå¤§çš„åº“ï¼Œä¼šæ¯”è¾ƒéš¾å§ã€‚ æ˜¯ä»€ä¹ˆä¸œè¥¿ï¼Ÿ EventBus æ˜¯ä¸€ä¸ªåŸºäºAndroid æˆ–è€…Java çš„å‘å¸ƒè®¢é˜…çš„æ¶ˆæ¯æ€»çº¿ï¼Œä»ä½¿ç”¨ä¸Šæ¥è¯´ï¼Œå®ƒå…è®¸æˆ‘ä»¬é€šè¿‡æ³¨è§£ï¼Œå°±èƒ½åœ¨Android ä¸­è‡ªç”±çš„åˆ‡æ¢çº¿ç¨‹ï¼Œå‘å¸ƒï¼Œæ¥å—æ¶ˆæ¯ï¼Œæå¤§çš„å‡è½»äº†æˆ‘ä»¬ä½¿ç”¨Handlerçš„è´Ÿæ‹…ï¼Œåšäº†å¾ˆå¥½çš„è§£è€¦ã€‚ å®˜æ–¹æ¶æ„å›¾ å…ˆæ‰‹å†™ä¸€ä¸ªå°ä¾‹å­å§ åœ¨onCreateé‡Œè¾¹æ³¨å†Œ 1234@Overridepublic void onCreate(Bundle savedInstanceState) &#123; EventBus.getDefault().register(this);&#125; åœ¨onDestroyé‡Œè¾¹å–æ¶ˆ 1234@Overridepublic void onDestroy() &#123; EventBus.getDefault().unregister(this);&#125; åœ¨Activity è®¢é˜…æ¶ˆæ¯ 1234@Subscribe(threadMode = ThreadMode.MAIN)public void subscribe(Object object) &#123; Log.i(TAG, &quot;Recevied: &quot; + object);&#125; åœ¨å…¶ä»–åœ°æ–¹å‘å¸ƒæ¶ˆæ¯ 1new Thread(() -&gt; EventBus.getDefault().post(new Object())).start(); è¿™æ ·å°±å®Œæˆäº†ä¸€æ¬¡å®Œæ•´çš„äº‹ä»¶å‘å¸ƒè®¢é˜…æµç¨‹ï¼Œæ˜¯ä¸æ˜¯è¦æ¯”Handleræ›´ç®€å•ï¼Œå¾ˆæ–¹ä¾¿å‘¢ï¼Œæ›´æ¸…æ™°ï¼Ÿ å‰ä¸–ä»Šç”Ÿ 1public class EventBus &#123;&#125; æºç åˆ†æ å±æ€§ defaultInstance æ˜¯é»˜è®¤çš„å®ä¾‹ï¼Œä½¿ç”¨Singletonå®ç°ï¼Œé¥¿æ±‰å¼ï¼Œæ³¨æ„volatileçš„ä½¿ç”¨ï¼Œå¾ˆå¤šåŒå­¦åœ¨å†™æ¶æ±‰å®¹æ˜“é—æ¼ã€‚DEFAULT_BUILDER æ˜¯é»˜è®¤çš„ï¼Œå”¯ä¸€ã€‚eventTypesCacheæ˜¯äº‹ä»¶ç±»å‹é›†åˆï¼ŒsubscriptionsByEventTypeæ˜¯æ ¹æ®äº‹ä»¶ç±»å‹åˆ†ç»„çš„è®¢é˜…é›†åˆï¼ŒtypesBySubscriber æ˜¯æ ¹æ®è®¢é˜…è€…åˆ†ç»„çš„äº‹ä»¶ç±»å‹é›†åˆ 12345678static volatile EventBus defaultInstance;private static final EventBusBuilder DEFAULT_BUILDER = new EventBusBuilder();private static final Map&lt;Class&lt;?&gt;, List&lt;Class&lt;?&gt;&gt;&gt; eventTypesCache = new HashMap&lt;&gt;();private final Map&lt;Class&lt;?&gt;, CopyOnWriteArrayList&lt;Subscription&gt;&gt; subscriptionsByEventType;private final Map&lt;Object, List&lt;Class&lt;?&gt;&gt;&gt; typesBySubscriber;private final Map&lt;Class&lt;?&gt;, Object&gt; stickyEvents; æ²¡çœ‹æ‡‚ 12345678910111213141516private final ThreadLocal&lt;PostingThreadState&gt; currentPostingThreadState = new ThreadLocal&lt;PostingThreadState&gt;() &#123; @Override protected PostingThreadState initialValue() &#123; return new PostingThreadState(); &#125;&#125;;/** For ThreadLocal, much faster to set (and get multiple values). */final static class PostingThreadState &#123; final List&lt;Object&gt; eventQueue = new ArrayList&lt;&gt;(); boolean isPosting; boolean isMainThread; Subscription subscription; Object event; boolean canceled;&#125; äº”ç§çº¿ç¨‹æ¨¡å‹ï¼Œä¸»çº¿ç¨‹ï¼Œåå°çº¿ç¨‹ï¼Œå¼‚æ­¥çº¿ç¨‹ï¼Œå’Œå½“å‰çº¿ç¨‹ä¸€æ ·ï¼Œæœ‰é¡ºåºçš„ 123456// @Nullableprivate final MainThreadSupport mainThreadSupport;// @Nullableprivate final Poster mainThreadPoster;private final BackgroundPoster backgroundPoster;private final AsyncPoster asyncPoster; ä¸€ä¸ªæ˜¯è®¢é˜…å‘ç°è€…ï¼Œä¸»è¦æ˜¯ä¸ºäº†è·å–è®¢é˜…çš„æ•°æ®ï¼Œå¦å¤–å°±æ˜¯çº¿ç¨‹æ±  12private final SubscriberMethodFinder subscriberMethodFinder;private final ExecutorService executorService; ä¸€äº›finalå˜é‡ 123456789private final boolean throwSubscriberException;private final boolean logSubscriberExceptions;private final boolean logNoSubscriberMessages;private final boolean sendSubscriberExceptionEvent;private final boolean sendNoSubscriberEvent;private final boolean eventInheritance;private final int indexCount;private final Logger logger; æ„é€ å‡½æ•° ä½¿ç”¨é»˜è®¤çš„å»ºé€ è€…å»åˆå§‹åŒ–EventBusï¼Œä¸»è¦æ˜¯å¯¹ä¹‹å‰å±æ€§çš„åˆå§‹åŒ– 12345678910111213141516171819202122232425262728/** * Creates a new EventBus instance; each instance is a separate scope in which events are delivered. To use a * central bus, consider &#123;@link #getDefault()&#125;. */public EventBus() &#123; this(DEFAULT_BUILDER);&#125;EventBus(EventBusBuilder builder) &#123; logger = builder.getLogger(); subscriptionsByEventType = new HashMap&lt;&gt;(); typesBySubscriber = new HashMap&lt;&gt;(); stickyEvents = new ConcurrentHashMap&lt;&gt;(); mainThreadSupport = builder.getMainThreadSupport(); mainThreadPoster = mainThreadSupport != null ? mainThreadSupport.createPoster(this) : null; backgroundPoster = new BackgroundPoster(this); asyncPoster = new AsyncPoster(this); indexCount = builder.subscriberInfoIndexes != null ? builder.subscriberInfoIndexes.size() : 0; subscriberMethodFinder = new SubscriberMethodFinder(builder.subscriberInfoIndexes, builder.strictMethodVerification, builder.ignoreGeneratedIndex); logSubscriberExceptions = builder.logSubscriberExceptions; logNoSubscriberMessages = builder.logNoSubscriberMessages; sendSubscriberExceptionEvent = builder.sendSubscriberExceptionEvent; sendNoSubscriberEvent = builder.sendNoSubscriberEvent; throwSubscriberException = builder.throwSubscriberException; eventInheritance = builder.eventInheritance; executorService = builder.executorService;&#125; getDefault() ä½¿ç”¨å•ä¾‹æ¨¡å¼ï¼ŒDoubleCheck 1234567891011/** Convenience singleton for apps using a process-wide EventBus instance. */public static EventBus getDefault() &#123; if (defaultInstance == null) &#123; synchronized (EventBus.class) &#123; if (defaultInstance == null) &#123; defaultInstance = new EventBus(); &#125; &#125; &#125; return defaultInstance;&#125; é¡ºä¾¿çœ‹ä¸€ä¸‹EventBusBuilder çº¿ç¨‹æ± ä½¿ç”¨çš„æ˜¯é»˜è®¤çš„CachedThreadPoolï¼Œæ ¸å¿ƒçº¿ç¨‹æ•°ä¸º0ï¼Œå…¶ä½™å˜é‡éƒ½ä¸ºtureï¼Œä¹‹åå†åˆ†æç”¨é€” 123456789101112131415161718private final static ExecutorService DEFAULT_EXECUTOR_SERVICE = Executors.newCachedThreadPool();boolean logSubscriberExceptions = true;boolean logNoSubscriberMessages = true;boolean sendSubscriberExceptionEvent = true;boolean sendNoSubscriberEvent = true;boolean throwSubscriberException;boolean eventInheritance = true;boolean ignoreGeneratedIndex;boolean strictMethodVerification;ExecutorService executorService = DEFAULT_EXECUTOR_SERVICE;List&lt;Class&lt;?&gt;&gt; skipMethodVerificationForClasses;List&lt;SubscriberInfoIndex&gt; subscriberInfoIndexes;Logger logger;MainThreadSupport mainThreadSupport;EventBusBuilder() &#123;&#125; åœ¨é‡ç‚¹çœ‹ä¸€ä¸‹è¿™å‡ ä¸ªå‚æ•°çš„èµ‹å€¼ï¼Œé¦–å…ˆå¯¹mainThreadSupportèµ‹å€¼ï¼Œè°ƒç”¨EventBusBuilderçš„getMainThreadSupportæ–¹æ³•ï¼Œè¯¥æ–¹æ³•ç¬¬ä¸€æ¬¡æ˜¯é€šè¿‡getAndroidMainLooperOrNull() è·å–ä¸€ä¸ªMainLooperï¼Œä¹Ÿå°±æ˜¯ActivityThreadçš„mainä¸­åˆå§‹åŒ–çš„MainLooperå¯¹è±¡ 1234567891011121314151617181920212223mainThreadSupport = builder.getMainThreadSupport(); // class evnetbusbuilderMainThreadSupport getMainThreadSupport() &#123; if (mainThreadSupport != null) &#123; return mainThreadSupport; &#125; else if (Logger.AndroidLogger.isAndroidLogAvailable()) &#123; Object looperOrNull = getAndroidMainLooperOrNull(); return looperOrNull == null ? null : new MainThreadSupport.AndroidHandlerMainThreadSupport((Looper) looperOrNull); &#125; else &#123; return null; &#125;&#125;Object getAndroidMainLooperOrNull() &#123; try &#123; return Looper.getMainLooper(); &#125; catch (RuntimeException e) &#123; // Not really a functional Android (e.g. &quot;Stub!&quot; maven dependencies) return null; &#125;&#125; ä¸Šä¸€æ­¥è·å–åˆ°äº†ä¸€ä¸ªMainThreadSupportï¼Œå…¶ä¸­çš„Looperä¸ºMainLooper 1234567891011121314151617181920212223242526public interface MainThreadSupport &#123; boolean isMainThread(); Poster createPoster(EventBus eventBus); class AndroidHandlerMainThreadSupport implements MainThreadSupport &#123; private final Looper looper; public AndroidHandlerMainThreadSupport(Looper looper) &#123; this.looper = looper; &#125; @Override public boolean isMainThread() &#123; return looper == Looper.myLooper(); &#125; @Override public Poster createPoster(EventBus eventBus) &#123; return new HandlerPoster(eventBus, looper, 10); &#125; &#125;&#125; ç»™mainThreadPoster èµ‹å€¼ï¼Œåˆ›å»ºäº†ä¸€ä¸ªHandlerPosterï¼Œå‚æ•°ä¸ºthisï¼ŒMainLooperï¼Œ 10ï¼Œ10æŒ‡çš„æ˜¯æœ€å¤§æ¶ˆæ¯å¤„ç†å»¶æ—¶ 1mainThreadPoster = mainThreadSupport != null ? mainThreadSupport.createPoster(this) : null; çœ‹ä¸€ä¸‹HandlerPosterçš„å®ç°ï¼Œç»§æ‰¿è‡ªHandlerï¼Œå®ç°äº† Posterçš„enqueueæ–¹æ³• 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970public class HandlerPoster extends Handler implements Poster &#123; private final PendingPostQueue queue; private final int maxMillisInsideHandleMessage; private final EventBus eventBus; private boolean handlerActive; protected HandlerPoster(EventBus eventBus, Looper looper, int maxMillisInsideHandleMessage) &#123; super(looper); this.eventBus = eventBus; this.maxMillisInsideHandleMessage = maxMillisInsideHandleMessage; queue = new PendingPostQueue(); &#125; public void enqueue(Subscription subscription, Object event) &#123; PendingPost pendingPost = PendingPost.obtainPendingPost(subscription, event); synchronized (this) &#123; queue.enqueue(pendingPost); if (!handlerActive) &#123; handlerActive = true; if (!sendMessage(obtainMessage())) &#123; throw new EventBusException(&quot;Could not send handler message&quot;); &#125; &#125; &#125; &#125; @Override public void handleMessage(Message msg) &#123; boolean rescheduled = false; try &#123; long started = SystemClock.uptimeMillis(); while (true) &#123; PendingPost pendingPost = queue.poll(); if (pendingPost == null) &#123; synchronized (this) &#123; // Check again, this time in synchronized pendingPost = queue.poll(); if (pendingPost == null) &#123; handlerActive = false; return; &#125; &#125; &#125; eventBus.invokeSubscriber(pendingPost); long timeInMethod = SystemClock.uptimeMillis() - started; if (timeInMethod &gt;= maxMillisInsideHandleMessage) &#123; if (!sendMessage(obtainMessage())) &#123; throw new EventBusException(&quot;Could not send handler message&quot;); &#125; rescheduled = true; return; &#125; &#125; &#125; finally &#123; handlerActive = rescheduled; &#125; &#125;&#125;interface Poster &#123; /** * Enqueue an event to be posted for a particular subscription. * * @param subscription Subscription which will receive the event. * @param event Event that will be posted to subscribers. */ void enqueue(Subscription subscription, Object event);&#125; å†æ¥çœ‹ä¸€ä¸‹ä»–è‡ªå·±å®ç°çš„é˜Ÿåˆ—ï¼Œä¸¤ä¸ªæ–¹æ³•ï¼Œå…¥é˜Ÿå’Œå‡ºé˜Ÿï¼Œçº¿ç¨‹å®‰å…¨ 1234567891011121314151617181920212223242526272829303132333435363738final class PendingPostQueue &#123; private PendingPost head; private PendingPost tail; synchronized void enqueue(PendingPost pendingPost) &#123; if (pendingPost == null) &#123; throw new NullPointerException(&quot;null cannot be enqueued&quot;); &#125; if (tail != null) &#123; tail.next = pendingPost; tail = pendingPost; &#125; else if (head == null) &#123; head = tail = pendingPost; &#125; else &#123; throw new IllegalStateException(&quot;Head present, but no tail&quot;); &#125; notifyAll(); &#125; synchronized PendingPost poll() &#123; PendingPost pendingPost = head; if (head != null) &#123; head = head.next; if (head == null) &#123; tail = null; &#125; &#125; return pendingPost; &#125; synchronized PendingPost poll(int maxMillisToWait) throws InterruptedException &#123; if (head == null) &#123; wait(maxMillisToWait); &#125; return poll(); &#125;&#125; é˜Ÿåˆ—çš„å…ƒç´ ï¼Œè®¾è®¡çš„è¿˜ä¸é”™ï¼Œä½¿ç”¨æ± çš„æ–¹å¼è·å–æ¶ˆPendingPostï¼Œè·å–PendingPostçš„æ—¶å€™ï¼Œå…ˆæ£€æŸ¥PendingPostæ± å¤§å°ï¼Œå¦‚æœå¤§äºé›¶ï¼Œåˆ™ä»PendingPostæ± é‡Œé¢å–æœ€åä¸€ä¸ªPendingPostï¼Œå¹¶ä¸”åˆ é™¤ï¼Œå¦åˆ™ï¼Œæ–°å»ºä¸€ä¸ªï¼Œå½“é‡Šæ”¾PendingPostçš„æ—¶å€™ï¼Œå°†PendingPostçš„å€¼åˆå§‹åŒ–ï¼Œå¹¶ä¸”ä¼šå—åˆ°PendingPostæ± é‡Œé¢ï¼Œå½“ç„¶ï¼Œè¿™ä¸ªå€¼ä¸èƒ½æ— é™å¤§ï¼Œä½œè€…è®¾è®¡çš„è¿˜æ˜¯æŒºä¸é”™çš„ï¼Œè¿™ä¸æˆ‘ä»¬å¸¸ç”¨çš„Handlerä¸­çš„Messageè®¾è®¡æ€è·¯å·®ä¸å¤šï¼Œå¤§å®¶ä¹Ÿå¯ä»¥å­¦ä¸€å­¦ 123456789101112131415161718192021222324252627282930313233343536373839final class PendingPost &#123; private final static List&lt;PendingPost&gt; pendingPostPool = new ArrayList&lt;PendingPost&gt;(); Object event;s Subscription subscription; PendingPost next; private PendingPost(Object event, Subscription subscription) &#123; this.event = event; this.subscription = subscription; &#125; static PendingPost obtainPendingPost(Subscription subscription, Object event) &#123; synchronized (pendingPostPool) &#123; int size = pendingPostPool.size(); if (size &gt; 0) &#123; PendingPost pendingPost = pendingPostPool.remove(size - 1); pendingPost.event = event; pendingPost.subscription = subscription; pendingPost.next = null; return pendingPost; &#125; &#125; return new PendingPost(event, subscription); &#125; static void releasePendingPost(PendingPost pendingPost) &#123; pendingPost.event = null; pendingPost.subscription = null; pendingPost.next = null; synchronized (pendingPostPool) &#123; // Don&apos;t let the pool grow indefinitely if (pendingPostPool.size() &lt; 10000) &#123; pendingPostPool.add(pendingPost); &#125; &#125; &#125;&#125; ç„¶åæ˜¯backgroundPosterï¼Œæ¯ä¸€ä¸ªæ¨¡å‹éƒ½æœ‰ä¸€ä¸ªqueueï¼Œå„è‡ªå¤„ç†å„è‡ªçš„äº‹æƒ…ã€‚ç¬¬ä¸€æ¬¡å…¥é˜Ÿæ˜¯ï¼Œä½¿ç”¨çº¿ç¨‹æ± å¯åŠ¨ï¼Œä¹‹åå°±å¼€å¯æ— çº¿å¾ªç¯ä¸æ–­çš„è¯»å–ä»»åŠ¡ï¼Œå½“1så†…è·å–ä¸åˆ°ä»»åŠ¡ï¼Œå†æ²¡æœ‰ä»»åŠ¡æ—¶åˆ™å…³é—­çº¿ç¨‹ï¼Œä¸ªäººè§‰å¾—è¿™ä¸ªå®ç°ä¸å¤ªå¥½ï¼Œå¦‚æœè¿™1så†…æœ‰ä»»åŠ¡è¿›æ¥ï¼Œä¹Ÿä¸èƒ½ç«‹åˆ»è¿è¡Œï¼Œæ‹œæ‹œæµªè´¹äº†æ—¶é—´ï¼Œå¦‚æœä½¿ç”¨notifyçš„æœºåˆ¶å®ç°ä¼šå¥½ä¸€äº›ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950final class BackgroundPoster implements Runnable, Poster &#123; private final PendingPostQueue queue; private final EventBus eventBus; private volatile boolean executorRunning; BackgroundPoster(EventBus eventBus) &#123; this.eventBus = eventBus; queue = new PendingPostQueue(); &#125; public void enqueue(Subscription subscription, Object event) &#123; PendingPost pendingPost = PendingPost.obtainPendingPost(subscription, event); synchronized (this) &#123; queue.enqueue(pendingPost); if (!executorRunning) &#123; executorRunning = true; eventBus.getExecutorService().execute(this); &#125; &#125; &#125; @Override public void run() &#123; try &#123; try &#123; while (true) &#123; PendingPost pendingPost = queue.poll(1000); if (pendingPost == null) &#123; synchronized (this) &#123; // Check again, this time in synchronized pendingPost = queue.poll(); if (pendingPost == null) &#123; executorRunning = false; return; &#125; &#125; &#125; eventBus.invokeSubscriber(pendingPost); &#125; &#125; catch (InterruptedException e) &#123; eventBus.getLogger().log(Level.WARNING, Thread.currentThread().getName() + &quot; was interruppted&quot;, e); &#125; &#125; finally &#123; executorRunning = false; &#125; &#125;&#125; AsyncPoster è¿™ä¸ªä¸»è¦æ˜¯å¼‚æ­¥çš„ï¼Œæ¥ä¸€ä¸ªæ‰§è¡Œä¸€ä¸ª 1234567891011121314151617181920212223242526class AsyncPoster implements Runnable, Poster &#123; private final PendingPostQueue queue; private final EventBus eventBus; AsyncPoster(EventBus eventBus) &#123; this.eventBus = eventBus; queue = new PendingPostQueue(); &#125;s public void enqueue(Subscription subscription, Object event) &#123; PendingPost pendingPost = PendingPost.obtainPendingPost(subscription, event); queue.enqueue(pendingPost); eventBus.getExecutorService().execute(this); &#125; @Override public void run() &#123; PendingPost pendingPost = queue.poll(); if(pendingPost == null) &#123; throw new IllegalStateException(&quot;No pending post available&quot;); &#125; eventBus.invokeSubscriber(pendingPost); &#125;&#125; æ¥ä¸‹æ¥å°±æ˜¯é‡è¦çš„ SubscriberMethodFinder å‡½æ•°ï¼Œ 12345678 class SubscriberMethodFinder &#123;&#125; SubscriberMethodFinder(List&lt;SubscriberInfoIndex&gt; subscriberInfoIndexes, boolean strictMethodVerification, boolean ignoreGeneratedIndex) &#123; this.subscriberInfoIndexes = subscriberInfoIndexes; this.strictMethodVerification = strictMethodVerification; this.ignoreGeneratedIndex = ignoreGeneratedIndex;&#125; ç†Ÿæ‚‰çš„registerå‡½æ•°ï¼Œé¦–å…ˆè·å–åˆ°subscriberå¯¹è±¡ï¼Œä¸€èˆ¬æˆ‘ä»¬åœ¨Activityé‡Œé¢ï¼Œæ‰€ä»¥æ˜¯Activityå¯¹è±¡ï¼Œç„¶åè°ƒç”¨subscriberMethodFinder.findSubscriberMethods(subscriberClass)ï¼Œæ‰¾åˆ°æ‰€æœ‰è®¢é˜…çš„Methodsï¼Œç„¶åç»‘å®šè®¢é˜… 1234567891011121314151617/** * Registers the given subscriber to receive events. Subscribers must call &#123;@link #unregister(Object)&#125; once they * are no longer interested in receiving events. * &lt;p/&gt; * Subscribers have event handling methods that must be annotated by &#123;@link Subscribe&#125;. * The &#123;@link Subscribe&#125; annotation also allows configuration like &#123;@link * ThreadMode&#125; and priority. */public void register(Object subscriber) &#123; Class&lt;?&gt; subscriberClass = subscriber.getClass(); List&lt;SubscriberMethod&gt; subscriberMethods = subscriberMethodFinder.findSubscriberMethods(subscriberClass); synchronized (this) &#123; for (SubscriberMethod subscriberMethod : subscriberMethods) &#123; subscribe(subscriber, subscriberMethod); &#125; &#125;&#125; æ‰¾åˆ°æŸä¸ªç±»ä¸­ï¼Œä¹Ÿå°±æ˜¯æ³¨å†Œçš„ç±»ä¸­çš„æ‰€æœ‰çš„è®¢é˜…æ–¹æ³•ï¼Œé¦–å…ˆæŸ¥çœ‹æ–¹æ³•ç¼“å­˜ä¸­æ˜¯å¦ä»¥åŠå­˜åœ¨ï¼Œå­˜åœ¨åˆ™ç›´æ¥è¿”å›ï¼Œä¸å­˜åœ¨åˆ™ä½¿ç”¨åå°„æˆ–è€…Infoå»æ‰¾ï¼Œè·å–åˆ°æ‰€æœ‰æ–¹æ³•åæŠŠå®ƒå­˜å…¥ç¼“å­˜ï¼Œè¿”å›æ‰€æœ‰çš„æ–¹æ³•åˆ—è¡¨ã€‚æ³¨æ„getMethodså’ŒgetDeclaredMethodsçš„åŒºåˆ«ï¼Œä¸€ä¸ªæ˜¯èƒ½å¤Ÿè·å–åŒ…æ‹¬çˆ¶ç±»å¤šæœ‰çš„publicæ–¹æ³•ï¼Œä¸€ä¸ªæ˜¯è·å–æœ¬ç±»æ‰€æœ‰çš„åŒ…æ‹¬ç§æœ‰çš„æ–¹æ³•ï¼Œ 12345678910111213141516171819List&lt;SubscriberMethod&gt; findSubscriberMethods(Class&lt;?&gt; subscriberClass) &#123; List&lt;SubscriberMethod&gt; subscriberMethods = METHOD_CACHE.get(subscriberClass); if (subscriberMethods != null) &#123; return subscriberMethods; &#125; if (ignoreGeneratedIndex) &#123; subscriberMethods = findUsingReflection(subscriberClass); &#125; else &#123; subscriberMethods = findUsingInfo(subscriberClass); &#125; if (subscriberMethods.isEmpty()) &#123; throw new EventBusException(&quot;Subscriber &quot; + subscriberClass + &quot; and its super classes have no public methods with the @Subscribe annotation&quot;); &#125; else &#123; METHOD_CACHE.put(subscriberClass, subscriberMethods); return subscriberMethods; &#125;&#125; æŸ¥æ‰¾å‡½æ•°ï¼Œé¦–å…ˆprepareFindStateï¼Œåˆå§‹åŒ– FindStateï¼Œç”¨äºå­˜æ”¾å„ç§è®¢é˜…ç›¸å…³çš„æ•°æ® 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146private List&lt;SubscriberMethod&gt; findUsingReflection(Class&lt;?&gt; subscriberClass) &#123; FindState findState = prepareFindState(); findState.initForSubscriber(subscriberClass); while (findState.clazz != null) &#123; findUsingReflectionInSingleClass(findState); findState.moveToSuperclass(); &#125; return getMethodsAndRelease(findState);&#125;// private void findUsingReflectionInSingleClass(FindState findState) &#123; Method[] methods; try &#123; // This is faster than getMethods, especially when subscribers are fat classes like Activities methods = findState.clazz.getDeclaredMethods(); &#125; catch (Throwable th) &#123; // Workaround for java.lang.NoClassDefFoundError, see https://github.com/greenrobot/EventBus/issues/149 methods = findState.clazz.getMethods(); findState.skipSuperClasses = true; &#125; // å¯¹äºæ¯ä¸€ä¸ªæ–¹æ³•ï¼Œè·å–ä¿¡æ¯ï¼Œé¦–å…ˆ // æ ¡éªŒä¿®é¥°ç¬¦ï¼Œè¿‡æ»¤æ‰é Public çš„æ–¹æ³• // ä»¥åŠ abstractï¼Œstaticï¼Œbridge or synthetic methodsï¼Œ for (Method method : methods) &#123; int modifiers = method.getModifiers(); if ((modifiers &amp; Modifier.PUBLIC) != 0 &amp;&amp; (modifiers &amp; MODIFIERS_IGNORE) == 0) &#123; // å‚æ•°ç±»å‹åªèƒ½ä¸ºä¸€ä¸ª Class&lt;?&gt;[] parameterTypes = method.getParameterTypes(); if (parameterTypes.length == 1) &#123; // è·å–æ³¨è§£ Subscribe subscribeAnnotation = method.getAnnotation(Subscribe.class); if (subscribeAnnotation != null) &#123; // å‚æ•°ç±»å‹ Class&lt;?&gt; eventType = parameterTypes[0]; if (findState.checkAdd(method, eventType)) &#123; // æ³¨è§£çš„å€¼ ThreadMode threadMode = subscribeAnnotation.threadMode(); // æ·»åŠ åˆ°findState findState.subscriberMethods.add(new SubscriberMethod(method, eventType, threadMode, subscribeAnnotation.priority(), subscribeAnnotation.sticky())); &#125; &#125; &#125; else if (strictMethodVerification &amp;&amp; method.isAnnotationPresent(Subscribe.class)) &#123; String methodName = method.getDeclaringClass().getName() + &quot;.&quot; + method.getName(); throw new EventBusException(&quot;@Subscribe method &quot; + methodName + &quot;must have exactly 1 parameter but has &quot; + parameterTypes.length); &#125; &#125; else if (strictMethodVerification &amp;&amp; method.isAnnotationPresent(Subscribe.class)) &#123; String methodName = method.getDeclaringClass().getName() + &quot;.&quot; + method.getName(); throw new EventBusException(methodName + &quot; is a illegal @Subscribe method: must be public, non-static, and non-abstract&quot;); &#125; &#125;&#125;// åˆå§‹åŒ– FindStateprivate FindState prepareFindState() &#123; synchronized (FIND_STATE_POOL) &#123; for (int i = 0; i &lt; POOL_SIZE; i++) &#123; FindState state = FIND_STATE_POOL[i]; if (state != null) &#123; FIND_STATE_POOL[i] = null; return state; &#125; &#125; &#125; return new FindState();&#125;static class FindState &#123; final List&lt;SubscriberMethod&gt; subscriberMethods = new ArrayList&lt;&gt;(); final Map&lt;Class, Object&gt; anyMethodByEventType = new HashMap&lt;&gt;(); final Map&lt;String, Class&gt; subscriberClassByMethodKey = new HashMap&lt;&gt;(); final StringBuilder methodKeyBuilder = new StringBuilder(128); Class&lt;?&gt; subscriberClass; Class&lt;?&gt; clazz; boolean skipSuperClasses; SubscriberInfo subscriberInfo; void initForSubscriber(Class&lt;?&gt; subscriberClass) &#123; this.subscriberClass = clazz = subscriberClass; skipSuperClasses = false; subscriberInfo = null; &#125; void recycle() &#123; subscriberMethods.clear(); anyMethodByEventType.clear(); subscriberClassByMethodKey.clear(); methodKeyBuilder.setLength(0); subscriberClass = null; clazz = null; skipSuperClasses = false; subscriberInfo = null; &#125; boolean checkAdd(Method method, Class&lt;?&gt; eventType) &#123; // 2 level check: 1st level with event type only (fast), 2nd level with complete signature when required. // Usually a subscriber doesn&apos;t have methods listening to the same event type. Object existing = anyMethodByEventType.put(eventType, method); if (existing == null) &#123; return true; &#125; else &#123; if (existing instanceof Method) &#123; if (!checkAddWithMethodSignature((Method) existing, eventType)) &#123; // Paranoia check throw new IllegalStateException(); &#125; // Put any non-Method object to &quot;consume&quot; the existing Method anyMethodByEventType.put(eventType, this); &#125; return checkAddWithMethodSignature(method, eventType); &#125; &#125; private boolean checkAddWithMethodSignature(Method method, Class&lt;?&gt; eventType) &#123; methodKeyBuilder.setLength(0); methodKeyBuilder.append(method.getName()); methodKeyBuilder.append(&apos;&gt;&apos;).append(eventType.getName()); String methodKey = methodKeyBuilder.toString(); Class&lt;?&gt; methodClass = method.getDeclaringClass(); Class&lt;?&gt; methodClassOld = subscriberClassByMethodKey.put(methodKey, methodClass); if (methodClassOld == null || methodClassOld.isAssignableFrom(methodClass)) &#123; // Only add if not already found in a sub class return true; &#125; else &#123; // Revert the put, old class is further down the class hierarchy subscriberClassByMethodKey.put(methodKey, methodClassOld); return false; &#125; &#125; void moveToSuperclass() &#123; if (skipSuperClasses) &#123; clazz = null; &#125; else &#123; clazz = clazz.getSuperclass(); String clazzName = clazz.getName(); /** Skip system classes, this just degrades performance. */ if (clazzName.startsWith(&quot;java.&quot;) || clazzName.startsWith(&quot;javax.&quot;) || clazzName.startsWith(&quot;android.&quot;)) &#123; clazz = null; &#125; &#125; &#125;&#125; æœ‰å¿…è¦çœ‹ä¸€ä¸‹ï¼Œæ³¨è§£çš„å®šä¹‰ 123456789101112131415161718@Documented@Retention(RetentionPolicy.RUNTIME)@Target(&#123;ElementType.METHOD&#125;)public @interface Subscribe &#123; ThreadMode threadMode() default ThreadMode.POSTING; /** * If true, delivers the most recent sticky event (posted with * &#123;@link EventBus#postSticky(Object)&#125;) to this subscriber (if event available). */ boolean sticky() default false; /** Subscriber priority to influence the order of event delivery. * Within the same delivery thread (&#123;@link ThreadMode&#125;), higher priority subscribers will receive events before * others with a lower priority. The default priority is 0. Note: the priority does *NOT* affect the order of * delivery among subscribers with different &#123;@link ThreadMode&#125;s! */ int priority() default 0;&#125; ç„¶åå°±æ˜¯ subscribeï¼Œå¯¹äºæ¯ä¸€ä¸ªæ–¹æ³•ï¼Œæ‰§è¡Œ subscribe å‡½æ•°ï¼Œå°†è¿™äº›æ–¹æ³•æ·»åŠ åˆ°subscriptionsByEventTypeæ¶ˆæ¯ç±»å‹åˆ†ç»„çš„è®¢é˜…æ¸…å•ï¼ŒtypesBySubscriberæ¶ˆæ¯ç±»å‹åˆ—è¡¨ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152// Must be called in synchronized blockprivate void subscribe(Object subscriber, SubscriberMethod subscriberMethod) &#123; Class&lt;?&gt; eventType = subscriberMethod.eventType; Subscription newSubscription = new Subscription(subscriber, subscriberMethod); CopyOnWriteArrayList&lt;Subscription&gt; subscriptions = subscriptionsByEventType.get(eventType); // é¦–æ¬¡ä¸ºç©º if (subscriptions == null) &#123; subscriptions = new CopyOnWriteArrayList&lt;&gt;(); subscriptionsByEventType.put(eventType, subscriptions); &#125; else &#123; if (subscriptions.contains(newSubscription)) &#123; throw new EventBusException(&quot;Subscriber &quot; + subscriber.getClass() + &quot; already registered to event &quot; + eventType); &#125; &#125; // ä¼šæ ¹æ®ä¼˜å…ˆçº§åŠ å…¥åˆ°è®¢é˜…çš„åˆ—è¡¨ä¸­ int size = subscriptions.size(); for (int i = 0; i &lt;= size; i++) &#123; if (i == size || subscriberMethod.priority &gt; subscriptions.get(i).subscriberMethod.priority) &#123; subscriptions.add(i, newSubscription); break; &#125; &#125; List&lt;Class&lt;?&gt;&gt; subscribedEvents = typesBySubscriber.get(subscriber); if (subscribedEvents == null) &#123; subscribedEvents = new ArrayList&lt;&gt;(); typesBySubscriber.put(subscriber, subscribedEvents); &#125; // eventType å°±æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„MeesageEventï¼Œç”¨äºä¼ é€’æ¶ˆæ¯çš„ subscribedEvents.add(eventType); if (subscriberMethod.sticky) &#123; if (eventInheritance) &#123; // Existing sticky events of all subclasses of eventType have to be considered. // Note: Iterating over all events may be inefficient with lots of sticky events, // thus data structure should be changed to allow a more efficient lookup // (e.g. an additional map storing sub classes of super classes: Class -&gt; List&lt;Class&gt;). Set&lt;Map.Entry&lt;Class&lt;?&gt;, Object&gt;&gt; entries = stickyEvents.entrySet(); for (Map.Entry&lt;Class&lt;?&gt;, Object&gt; entry : entries) &#123; Class&lt;?&gt; candidateEventType = entry.getKey(); if (eventType.isAssignableFrom(candidateEventType)) &#123; Object stickyEvent = entry.getValue(); checkPostStickyEventToSubscription(newSubscription, stickyEvent); &#125; &#125; &#125; else &#123; Object stickyEvent = stickyEvents.get(eventType); checkPostStickyEventToSubscription(newSubscription, stickyEvent); &#125; &#125;&#125; Post å‘é€æ¶ˆæ¯ï¼Œé¦–å…ˆä»å½“å‰çº¿ç¨‹è·å–PostingThreadStateï¼Œç„¶åå…¥é˜Ÿï¼Œå†å‡ºé˜Ÿæ‰§è¡Œ 12345678910111213141516171819202122/** Posts the given event to the event bus. */public void post(Object event) &#123; PostingThreadState postingState = currentPostingThreadState.get(); List&lt;Object&gt; eventQueue = postingState.eventQueue; eventQueue.add(event); if (!postingState.isPosting) &#123; postingState.isMainThread = isMainThread(); postingState.isPosting = true; if (postingState.canceled) &#123; throw new EventBusException(&quot;Internal error. Abort state was not reset&quot;); &#125; try &#123; while (!eventQueue.isEmpty()) &#123; postSingleEvent(eventQueue.remove(0), postingState); &#125; &#125; finally &#123; postingState.isPosting = false; postingState.isMainThread = false; &#125; &#125;&#125; eventInheritance é»˜è®¤ä¸ºtrueï¼Œå…è®¸äº‹ä»¶ç»§æ‰¿ï¼Œé¦–å…ˆè·å–EventClassæ‰€æœ‰çš„çˆ¶ç±»å’Œæ¥å£ï¼Œå¹¶è°ƒç”¨postSingleEventForEventTypeæ‰§è¡Œ 1234567891011121314151617181920212223private void postSingleEvent(Object event, PostingThreadState postingState) throws Error &#123; Class&lt;?&gt; eventClass = event.getClass(); boolean subscriptionFound = false; if (eventInheritance) &#123; List&lt;Class&lt;?&gt;&gt; eventTypes = lookupAllEventTypes(eventClass); int countTypes = eventTypes.size(); for (int h = 0; h &lt; countTypes; h++) &#123; Class&lt;?&gt; clazz = eventTypes.get(h); subscriptionFound |= postSingleEventForEventType(event, postingState, clazz); &#125; &#125; else &#123; subscriptionFound = postSingleEventForEventType(event, postingState, eventClass); &#125; if (!subscriptionFound) &#123; if (logNoSubscriberMessages) &#123; logger.log(Level.FINE, &quot;No subscribers registered for event &quot; + eventClass); &#125; if (sendNoSubscriberEvent &amp;&amp; eventClass != NoSubscriberEvent.class &amp;&amp; eventClass != SubscriberExceptionEvent.class) &#123; post(new NoSubscriberEvent(this, event)); &#125; &#125;&#125; è·å–æ‰€æœ‰çš„æ–¹æ³•ï¼ŒåŒ…æ‹¬çˆ¶ç±»å’Œæ¥å£ï¼ŒåŠ å…¥åˆ°éœ€è¦é€šçŸ¥çš„äº‹ä»¶ç±»å‹ 123456789101112131415161718192021222324252627/** Looks up all Class objects including super classes and interfaces. Should also work for interfaces. */private static List&lt;Class&lt;?&gt;&gt; lookupAllEventTypes(Class&lt;?&gt; eventClass) &#123; synchronized (eventTypesCache) &#123; List&lt;Class&lt;?&gt;&gt; eventTypes = eventTypesCache.get(eventClass); if (eventTypes == null) &#123; eventTypes = new ArrayList&lt;&gt;(); Class&lt;?&gt; clazz = eventClass; while (clazz != null) &#123; eventTypes.add(clazz); addInterfaces(eventTypes, clazz.getInterfaces()); clazz = clazz.getSuperclass(); &#125; eventTypesCache.put(eventClass, eventTypes); &#125; return eventTypes; &#125;&#125;/** Recurses through super interfaces. */static void addInterfaces(List&lt;Class&lt;?&gt;&gt; eventTypes, Class&lt;?&gt;[] interfaces) &#123; for (Class&lt;?&gt; interfaceClass : interfaces) &#123; if (!eventTypes.contains(interfaceClass)) &#123; eventTypes.add(interfaceClass); addInterfaces(eventTypes, interfaceClass.getInterfaces()); &#125; &#125;&#125; é¦–å…ˆé€šè¿‡subscriptionsByEventType.get(eventClass)è·å–èƒ½å¤Ÿæ¥å—è¿™ä¸ªæ•°æ®ç±»å‹çš„æ‰€æœ‰æ–¹æ³•ï¼Œç„¶åæ ¹æ®æ¯ä¸ªæ–¹æ³•çš„å‚æ•°ç±»å‹è¿›è¡Œè°ƒç”¨ 1234567891011121314151617181920212223242526private boolean postSingleEventForEventType(Object event, PostingThreadState postingState, Class&lt;?&gt; eventClass) &#123; CopyOnWriteArrayList&lt;Subscription&gt; subscriptions; synchronized (this) &#123; subscriptions = subscriptionsByEventType.get(eventClass); &#125; if (subscriptions != null &amp;&amp; !subscriptions.isEmpty()) &#123; for (Subscription subscription : subscriptions) &#123; postingState.event = event; postingState.subscription = subscription; boolean aborted = false; try &#123; postToSubscription(subscription, event, postingState.isMainThread); aborted = postingState.canceled; &#125; finally &#123; postingState.event = null; postingState.subscription = null; postingState.canceled = false; &#125; if (aborted) &#123; break; &#125; &#125; return true; &#125; return false;&#125; POSTINGæ¨¡å¼ç›´æ¥è°ƒç”¨ï¼Œä¸å½“å‰çº¿ç¨‹ä¸€è‡´ MAINæ¨¡å¼ï¼Œåœ¨ä¸»çº¿ç¨‹è°ƒç”¨ï¼Œåˆ™éœ€è¦è·å–å½“å‰çº¿ç¨‹æ˜¯å¦æ˜¯ä¸»çº¿ç¨‹ï¼Œè‹¥ä¸æ˜¯åˆ™å…¥ä¸»çº¿ç¨‹é˜Ÿåˆ— MAIN_ORDEREDæ¨¡å¼ï¼Œå¦‚æœmainThreadPosterä¸ä¸ºç©ºï¼Œåˆ™å…¥é˜Ÿï¼Œå¦åˆ™ç›´æ¥è°ƒç”¨ BACKGROUNDæ¨¡å¼ï¼Œè‹¥åœ¨å­çº¿ç¨‹ï¼Œåˆ™ç›´æ¥è°ƒç”¨ï¼Œå¦åˆ™å¦‚åå°çº¿ç¨‹é˜Ÿåˆ— ASYNCæ¨¡å¼ï¼Œç›´æ¥å¦‚å¼‚æ­¥é˜Ÿåˆ— 12345678910111213141516171819202122232425262728293031323334private void postToSubscription(Subscription subscription, Object event, boolean isMainThread) &#123; switch (subscription.subscriberMethod.threadMode) &#123; case POSTING: invokeSubscriber(subscription, event); break; case MAIN: if (isMainThread) &#123; invokeSubscriber(subscription, event); &#125; else &#123; mainThreadPoster.enqueue(subscription, event); &#125; break; case MAIN_ORDERED: if (mainThreadPoster != null) &#123; mainThreadPoster.enqueue(subscription, event); &#125; else &#123; // temporary: technically not correct as poster not decoupled from subscriber invokeSubscriber(subscription, event); &#125; break; case BACKGROUND: if (isMainThread) &#123; backgroundPoster.enqueue(subscription, event); &#125; else &#123; invokeSubscriber(subscription, event); &#125; break; case ASYNC: asyncPoster.enqueue(subscription, event); break; default: throw new IllegalStateException(&quot;Unknown thread mode: &quot; + subscription.subscriberMethod.threadMode); &#125;&#125; ç›´æ¥è°ƒç”¨ï¼Œåœ¨postçš„æ‰§è¡Œçš„é‚£ä¸ªçº¿ç¨‹ï¼Œæ¯”å¦‚è¯´ä½ åœ¨å­çº¿ç¨‹è°ƒç”¨postï¼Œé‚£ä¹ˆisMainThreadå°±æ˜¯falseï¼Œåˆ™ä¼šåˆ°mainThreadPoster.enqueue()é‡Œé¢ï¼Œè®©ä¸»çº¿ç¨‹å»è°ƒç”¨ï¼Œå¦åˆ™ç›´æ¥è°ƒç”¨ 123456789void invokeSubscriber(Subscription subscription, Object event) &#123; try &#123; subscription.subscriberMethod.method.invoke(subscription.subscriber, event); &#125; catch (InvocationTargetException e) &#123; handleSubscriberException(subscription, event, e.getCause()); &#125; catch (IllegalAccessException e) &#123; throw new IllegalStateException(&quot;Unexpected exception&quot;, e); &#125;&#125; æ³¨é”€ï¼Œé¦–å…ˆè·å–éœ€è¦æ³¨é”€çš„äº‹ä»¶ç±»å‹ï¼Œç„¶åé’ˆå¯¹æ¯ä¸€ä¸ªç±»å‹ï¼Œå–æ¶ˆè®¢é˜…è€…ï¼Œæœ€åç§»é™¤ 12345678910111213141516171819202122232425262728/** Unregisters the given subscriber from all event classes. */public synchronized void unregister(Object subscriber) &#123; List&lt;Class&lt;?&gt;&gt; subscribedTypes = typesBySubscriber.get(subscriber); if (subscribedTypes != null) &#123; for (Class&lt;?&gt; eventType : subscribedTypes) &#123; unsubscribeByEventType(subscriber, eventType); &#125; typesBySubscriber.remove(subscriber); &#125; else &#123; logger.log(Level.WARNING, &quot;Subscriber to unregister was not registered before: &quot; + subscriber.getClass()); &#125;&#125;/** Only updates subscriptionsByEventType, not typesBySubscriber! Caller must update typesBySubscriber. */private void unsubscribeByEventType(Object subscriber, Class&lt;?&gt; eventType) &#123; List&lt;Subscription&gt; subscriptions = subscriptionsByEventType.get(eventType); if (subscriptions != null) &#123; int size = subscriptions.size(); for (int i = 0; i &lt; size; i++) &#123; Subscription subscription = subscriptions.get(i); if (subscription.subscriber == subscriber) &#123; subscription.active = false; subscriptions.remove(i); i--; size--; &#125; &#125; &#125;&#125; åœ¨åå°„æ‰¾æ–¹æ³•çš„æ—¶å€™ï¼Œå¦‚æœä½¿ç”¨ç´¢å¼•åŠ é€Ÿçš„è¯ï¼Œè°ƒç”¨äº†è¿™ä¸ªæ–¹æ³• 12345678910111213141516171819202122232425262728293031323334353637private List&lt;SubscriberMethod&gt; findUsingInfo(Class&lt;?&gt; subscriberClass) &#123; FindState findState = prepareFindState(); findState.initForSubscriber(subscriberClass); while (findState.clazz != null) &#123; findState.subscriberInfo = getSubscriberInfo(findState); if (findState.subscriberInfo != null) &#123; SubscriberMethod[] array = findState.subscriberInfo.getSubscriberMethods(); for (SubscriberMethod subscriberMethod : array) &#123; if (findState.checkAdd(subscriberMethod.method, subscriberMethod.eventType)) &#123; findState.subscriberMethods.add(subscriberMethod); &#125; &#125; &#125; else &#123; findUsingReflectionInSingleClass(findState); &#125; findState.moveToSuperclass(); &#125; return getMethodsAndRelease(findState);&#125;// è·å– Subscriberçš„ä¿¡æ¯private SubscriberInfo getSubscriberInfo(FindState findState) &#123; if (findState.subscriberInfo != null &amp;&amp; findState.subscriberInfo.getSuperSubscriberInfo() != null) &#123; SubscriberInfo superclassInfo = findState.subscriberInfo.getSuperSubscriberInfo(); if (findState.clazz == superclassInfo.getSubscriberClass()) &#123; return superclassInfo; &#125; &#125; if (subscriberInfoIndexes != null) &#123; for (SubscriberInfoIndex index : subscriberInfoIndexes) &#123; SubscriberInfo info = index.getSubscriberInfo(findState.clazz); if (info != null) &#123; return info; &#125; &#125; &#125; return null;&#125; å¤§æ¦‚åˆ†æçš„å·®ä¸å¤šï¼Œä½†æ„Ÿè§‰è¿˜æ˜¯ä¸€å¤´é›¾æ°´ï¼Œå¯¹ä¸€äº›ç»†èŠ‚è¿˜äº‘é‡Œé›¾é‡Œï¼Œå…ˆå†™ä¸€ä¸ªå°ç»“å§ å°ç»“ ä½¿ç”¨äº†æ³¨è§£ï¼Œåå°„ï¼ŒHandlerï¼Œçº¿ç¨‹æ± ï¼Œäº‹ä»¶æ± ï¼Œè€Œä¸”é‡Œé¢æœ‰å¾ˆå¤šä¼˜ç§€çš„è®¾è®¡ï¼Œå•ä¾‹ï¼Œå»ºé€ è€…ï¼Œå·¥å‚ï¼Œè¦å¤šè¯»å¤šç»ƒæ‰èƒ½ä½“å‘³é‡Œé¢çš„ç²¾å¦™ æ¬¢è¿è®¨è®º","categories":[{"name":"Android","slug":"Android","permalink":"https://wzes.github.io/categories/Android/"}],"tags":[{"name":"Android","slug":"Android","permalink":"https://wzes.github.io/tags/Android/"}]},{"title":"Android HandlerThread æºç è§£æ","slug":"Android/HandlerThread","date":"2018-08-17T15:51:00.000Z","updated":"2019-09-02T12:18:44.107Z","comments":true,"path":"2018/08/17/Android/HandlerThread/","link":"","permalink":"https://wzes.github.io/2018/08/17/Android/HandlerThread/","excerpt":"","text":"å‰è¨€ è¿™ä¸ªä¸œè¥¿çœ‹ç€å¾ˆé«˜ç«¯çš„æ„Ÿè§‰ï¼Œåˆšå¼€å§‹æ²¡æ˜ç™½è¿™æ˜¯ç”¨æ¥å¹²å•¥ç”¨çš„ï¼Œä»–çš„æºç ä¹Ÿå¾ˆç®€å•ï¼Œç®€å•åˆ°éƒ½æƒ³ä¸å‡ºæ¥ä»–çš„åœºæ™¯ï¼Œåé¢çœ‹åˆ°ä»¥åšå®¢æ¯›ç‘Ÿé¡¿å¼€ï¼ŒHandlerThreadçš„ç‰¹ç‚¹ï¼Œå¤§æ¦‚å°±æ˜¯è¯´ï¼Œå®ƒç”¨å­çº¿ç¨‹çš„Looperï¼Œä½¿æˆ‘ä»¬çš„æ¶ˆæ¯åœ¨å­çº¿ç¨‹ä¸­å¤„ç†ï¼Œé€šå¸¸æˆ‘ä»¬éƒ½æ˜¯ç»‘å®šäº†ä¸»çº¿ç¨‹çš„ MessageQueueï¼Œä¸€å®šç¨‹åº¦ä¸ŠåŠ å¤§äº†ä¸»çº¿ç¨‹æ¶ˆæ¯å¤„ç†çš„è´Ÿæ‹…ã€‚åœ¨å­çº¿ç¨‹ä¸­å¤„ç†æ¶ˆæ¯ï¼Œè‡ªç„¶ä¹Ÿä¸èƒ½å¤„ç†æ¶ˆæ¯ï¼Œå¯ä»¥å¤„ç†ä¸€äº›åå°çš„ä»»åŠ¡ï¼Œä½†æ˜¯ä»–æ˜¯ä¸²è¡Œå¤„ç†ï¼Œæ‰€ä»¥ä½¿ç”¨æ—¶è¦æ³¨æ„äº†ã€‚ HandlerThread æ˜¯ä»€ä¹ˆä¸œè¥¿ï¼Ÿ å…ˆçœ‹åå­—ï¼Œæœ‰ Handlerï¼Œåˆæœ‰ Threadï¼Œèªæ˜çš„ä½ ä¸€æƒ³å°±çŸ¥é“äº†ï¼Œä»–æ˜¯ä¸€ä¸ª Threadï¼Œæ—¢ç„¶æ˜¯Threadï¼Œé‚£å°±æœ‰ Thread çš„ç‰¹æ€§ï¼Œæ¯”å¦‚ä½ å¯ä»¥ start å¯åŠ¨çº¿ç¨‹ã€‚å›åˆ°æ­£é¢˜ï¼Œå…¶å®ä»–å°±æ˜¯ä¸€ä¸ªå¸®ä½ åˆå§‹åŒ–äº†ä¸€ä¸ªå­çº¿ç¨‹ Looper çš„ Threadï¼Œé‚£ä»–çš„ä½¿ç”¨å°±æ˜¯è·å–è¿™ä¸ªLooperï¼Œç»‘å®šåˆ°Handlerï¼Œå°±å¯ä»¥ä½¿å¤„ç†æ¶ˆæ¯çš„ä»£ç æ‰§è¡Œåœ¨å­çº¿ç¨‹ã€‚ å‰ä¸–ä»Šç”Ÿ ç»§æ‰¿è‡ªThreadï¼Œä½¿ç”¨æ—¶å¯ä»¥è°ƒç”¨ .start()ï¼Œæ³¨æ„ run å’Œ start çš„åŒºåˆ« 1public class HandlerThread extends Thread &#123;&#125; æºç åˆ†æ å±æ€§ mPriority æ˜¯çº¿ç¨‹çš„ä¼˜å…ˆçº§ï¼Œé»˜è®¤ä¸ºProcess.THREAD_PRIORITY_DEFAULTï¼Œæ³¨æ„ï¼Œå®‰å“çš„çº¿ç¨‹ä¼˜å…ˆçº§æ¯” Java çš„å½±å“è¦å¤§ï¼Œè™½ç„¶ JVM æ˜¯æŠ¢å å¼åœ°ä¼˜å…ˆçº§è°ƒåº¦ï¼Œä½†å…¶å®å¹¶ä¸èƒ½ä¿è¯è¿™ä¸ªè¯­ä¹‰ï¼Œå¼€å‘è€…ä¸åº”è¯¥å®Œå…¨ä¾èµ–è¿™ä¸ªã€‚ mTid æ˜¯çº¿ç¨‹ id mLooper Looperå¯¹è±¡ Handler å¯¹è±¡ 123456789int mPriority;int mTid = -1;Looper mLooper;private @Nullable Handler mHandler;public HandlerThread(String name) &#123; super(name); mPriority = Process.THREAD_PRIORITY_DEFAULT;&#125; å‡½æ•° run å‡½æ•°å¾ˆç®€å•ï¼Œå…ˆ Looper.prepare()ï¼Œç»™å½“å‰çº¿ç¨‹çš„åˆå§‹åŒ–ä¸€ä¸ª Looper å¯¹è±¡ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªæ–¹æ³•ä¸èƒ½åœ¨å½“å‰çº¿ç¨‹å¤šæ¬¡è°ƒç”¨ï¼Œä¼šæŠ›å‡º new RuntimeException(&quot;Only one Looper may be created per thread&quot;); å¼‚å¸¸ï¼Œä¸æ˜ç™½çš„å¯ä»¥å»çœ‹è¿™ä¸€ç¯‡Handler æºç å¤§ç™½è¯ã€‚æœ‰ä¸€ä¸ª onLooperPrepared() æ–¹æ³•ä½ å¯ä»¥å»é‡å†™ï¼Œä¸»è¦æ˜¯ Looper.loop() è°ƒç”¨å‰çš„ä¸€äº›å‡†å¤‡æ“ä½œ 1234567891011121314151617181920/** * Call back method that can be explicitly overridden if needed to execute some * setup before Looper loops. */protected void onLooperPrepared() &#123;&#125;@Overridepublic void run() &#123; mTid = Process.myTid(); Looper.prepare(); synchronized (this) &#123; mLooper = Looper.myLooper(); notifyAll(); &#125; Process.setThreadPriority(mPriority); onLooperPrepared(); Looper.loop(); mTid = -1;&#125; è·å–Looperï¼Œä»£ç ç®€å•æ˜“æ‡‚ï¼Œéœ€è¦æ³¨æ„ï¼Œå¦‚æœçº¿ç¨‹è¿˜æ´»ç€ï¼Œå¦‚æœ looper ä¸ºç©ºï¼Œé‚£ä¹ˆåˆ™é˜»å¡ç­‰å¾…åˆå§‹åŒ–ï¼Œè¿™é‡Œä½¿ç”¨äº† synchronized ä»¥åŠ wait notify æœºåˆ¶ï¼Œæœ‰æ—¶é—´å¾—å¥½å¥½ç ”ç©¶ä¸€ä¸‹è¿™ä¸ªæœºåˆ¶ï¼Œæ€»æ„Ÿè§‰æŒæ¡çš„è¿˜ä¸å¤Ÿ 12345678910111213141516171819202122/** * This method returns the Looper associated with this thread. If this thread not been started * or for any reason isAlive() returns false, this method will return null. If this thread * has been started, this method will block until the looper has been initialized. * @return The looper. */public Looper getLooper() &#123; if (!isAlive()) &#123; return null; &#125; // If the thread has been started, wait until the looper has been created. synchronized (this) &#123; while (isAlive() &amp;&amp; mLooper == null) &#123; try &#123; wait(); &#125; catch (InterruptedException e) &#123; &#125; &#125; &#125; return mLooper;&#125; å…³é—­Looperï¼Œæˆ–è€…ä½¿ç”¨quitSafely() è¿™æ˜¯ä¸€ä¸ªå®‰å…¨çš„æ–¹æ³• 1234567891011121314151617public boolean quit() &#123; Looper looper = getLooper(); if (looper != null) &#123; looper.quit(); return true; &#125; return false;&#125;public boolean quitSafely() &#123; Looper looper = getLooper(); if (looper != null) &#123; looper.quitSafely(); return true; &#125; return false;&#125; ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼ˆçº¯æ‰‹å†™,ä¸ä¿è¯å¯¹ï¼‰ 123456789101112131415161718192021@MainThreadprivate HandlerThread mHT = new HandlerThread(&quot;WorkerHandler&quot;);private Handler mH;@Overridepublic void onCreate(Bundle savedInstanceState) &#123; mHT.start(); mH = new Handler(mHT.getLooper()) &#123; @Override public void handleMessage(Message msg) &#123; Log.v(&quot;mhT&quot;, &quot;I received the msg: &quot; + msg + &quot; from&quot; + Thread.currentThread()); &#125; &#125;;&#125;@Overridepublic void onDestroy() &#123; mHT.quitSafely();&#125; å°ç»“ å¦‚æœæˆ‘ä»¬çš„æ¶ˆæ¯ä¸éœ€è¦æ›´æ–°UIï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨è¿™ç§å­çº¿ç¨‹æ¶ˆæ¯å¤„ç†æ¨¡å¼ã€‚å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥ä¼ å…¥ä¸»çº¿ç¨‹çš„ Looperï¼Œä½†è¿™è¿èƒŒäº† HandlerThread åˆè¡·ï¼Œå³åœ¨ä¸€ä¸ªç‹¬ç«‹çš„çº¿ç¨‹ä¸­å¤„ç†æ¶ˆæ¯ï½ æ¬¢è¿è®¨è®ºï¼Œå¦‚æœæœ‰äº†æ–°çš„ç†è§£ï¼Œä¼šä¸æ–­æ›´æ–°ï½","categories":[{"name":"Android","slug":"Android","permalink":"https://wzes.github.io/categories/Android/"}],"tags":[{"name":"Android","slug":"Android","permalink":"https://wzes.github.io/tags/Android/"}]},{"title":"Android Handler æºç è§£æ","slug":"Android/Handler","date":"2018-08-15T12:11:00.000Z","updated":"2019-09-02T12:18:28.019Z","comments":true,"path":"2018/08/15/Android/Handler/","link":"","permalink":"https://wzes.github.io/2018/08/15/Android/Handler/","excerpt":"","text":"å‰è¨€ æˆ‘ç›¸ä¿¡ï¼Œç”¨è¿‡Androidçš„äººåŸºæœ¬éƒ½ä¼šä½¿ç”¨Handlerï¼Œæˆ–è€…å¤šå¤šå°‘å°‘ä¼šå¬åˆ°è¿™ä¸ªä¸œè¥¿ï¼Œåœ¨å®‰å“é‡Œé¢ï¼Œè¿™ä¸œè¥¿å¤ªé‡è¦äº†ï¼Œå¦‚æœä½ è¿˜ä¸ä¼šåŸºæœ¬ç”¨æ³•ï¼Œé‚£åº”è¯¥æ˜¯éœ€è¦åçœä¸€ä¸‹ã€‚å½“ç„¶ï¼Œç”¨è¿‡å®ƒçš„äººä¹Ÿä¸å¿…æ²¾æ²¾è‡ªå–œï¼Œæˆ‘ä»¬çœŸçš„å¾ˆäº†è§£Handlerå—ï¼Œè¿˜æ˜¯è¯´åªä¼šä½¿ç”¨ï¼Ÿä½ æœ‰çœ‹è¿‡ä»–çš„æ¯ä¸€è¡Œä»£ç ï¼Ÿä»”ç»†æ€è€ƒè¿‡å—ï¼Ÿå¯¹äºæˆ‘æ¥è¯´ï¼Œç¡®å®æ²¡æœ‰ï¼Œæ‰€ä»¥æˆ‘å¸¦ç€é—®é¢˜ï¼Œæƒ³å…¨é¢äº†è§£ Handlerã€‚ æ˜¯ä»€ä¹ˆä¸œè¥¿ï¼Ÿ handlerï¼Œè‹±æ–‡æœ‰ï¼ˆä¿¡æ¯ï¼‰å¤„ç†æœºçš„æ„æ€ï¼Œè¿™é‡Œæˆ‘ä»¬æš‚ä¸”å¯ä»¥è®¤ä¸ºä»–æœ‰å¤„ç†æ¶ˆæ¯çš„åŠŸèƒ½ï¼Œå½“ç„¶ï¼Œè¿™ä¹Ÿæ˜¯ä»–æœ€ä¸»è¦çš„åŠŸèƒ½ï¼Œä»–è¿˜æœ‰å…¶ä»–çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®æºç ä¸€è°ˆç©¶ç«Ÿã€‚ç”¨æœ€é€šä¿—çš„æ€»ç»“ä¸€ä¸‹ï¼Œä»–æ˜¯ç”¨æ¥æ¥æ”¶ä»å„ä¸ªçº¿ç¨‹å‘è¿‡æ¥çš„æ¶ˆæ¯ï¼Œç„¶åé›†ä¸­å¤„ç†çš„ä¸œè¥¿ã€‚ä½ å¯ä»¥åœ¨ä¸»çº¿ç¨‹ï¼ˆMainThreadï¼‰å¤„ç†æ¶ˆæ¯ï¼Œåœ¨å­çº¿ç¨‹ï¼ˆWorkerThreadï¼‰å‘é€æ¶ˆæ¯ï¼Œå½“ç„¶ï¼Œè¿™ä¸ªå…³ç³»ä¹Ÿå¯ä»¥è½¬æ¢ï¼Œä¸‹é¢æˆ‘æ‰‹å†™ä¸€å°æ®µä»£ç å±•ç¤ºä¸€ä¸‹ï¼ˆåªä¸ºäº†æ¼”ç¤ºï¼Œå®é™…ä¸­ä¸ä¼šè¿™ä¹ˆå†™ï¼‰ 123456789// å†™åœ¨Activityä¸­ä½œä¸ºå®ä¾‹å˜é‡private Handler mHandler = new Handler() &#123; @Override public void handleMesssage(Message msg) &#123; ui.setText(&quot;msg received&quot;); &#125; &#125;// å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹å‘ä¸€ä¸ªæ¶ˆæ¯new Thread(() -&gt; mHandler.sendEmptyMessage()); ä¸Šé¢ç®€å•çš„ä»£ç æ¼”ç¤ºäº†å¦‚ä½•ä»ä¸€ä¸ªå­çº¿ç¨‹å‘é€æ¶ˆæ¯åˆ°ä¸»çº¿ç¨‹ï¼Œç„¶åæ›´æ–°UIï¼Œè‡³äºAndroidä¸èƒ½å†ä¸»çº¿ç¨‹æ›´æ–°UIï¼Œæˆ‘æƒ³è¿™ä¸ªé“ç†å¤§å®¶å¤šå°‘éƒ½çŸ¥é“åŸå› ï¼Œä»¥åæœ‰æœºä¼šå†å¥½å¥½åˆ†æã€‚ å‰ä¸–ä»Šç”Ÿ å¾ˆå¹²å‡€ï¼Œåªæœ‰è‡ªå·± 1public class Handler &#123;&#125; æºç åˆ†æ å±æ€§ è¿™é‡Œä¸ªéƒ½æ˜¯ç±»å˜é‡ï¼ŒMAIN_THREAD_HANDLER é¡¾åæ€ä¹‰ï¼Œä¸»çº¿ç¨‹çš„ Handler 12345678/* * Set this flag to true to detect anonymous, local or member classes * that extend this Handler class and that are not static. These kind * of classes can potentially create leaks. */private static final boolean FIND_POTENTIAL_LEAKS = false;private static final String TAG = &quot;Handler&quot;;private static Handler MAIN_THREAD_HANDLER = null; æ¥ä¸‹æ¥è¿™å‡ ä¸ªå¾ˆé‡è¦ï¼Œä¸€ä¸ªæ˜¯Looperå¯¹è±¡ï¼ŒMessageQueueï¼ŒCallbackï¼ŒmAsynchronousï¼Œè¿˜æœ‰IMessagerï¼Œé›†ä½“æœ‰ä»€ä¹ˆç”¨ï¼Œåé¢ç”¨åˆ°äº†å†æ…¢æ…¢è¯´ 12345final Looper mLooper;final MessageQueue mQueue;final Callback mCallback;final boolean mAsynchronous;IMessenger mMessenger; è¿™ä¸ªä¸œè¥¿å¤§å®¶ç”¨çš„å¯èƒ½ä¸å¤šï¼Œæ˜¯ä¸€ä¸ªå†…éƒ¨æ¥å£ï¼Œä¸»è¦æ˜¯è¯´ä½ å¯ä»¥ä¸ç”¨å†™ä¸€ä¸ªHandlerå­ç±»å°±å¯ä»¥åšåˆ°æ¶ˆæ¯å¤„ç†çš„åŠŸèƒ½ã€‚æ¯”å¦‚è¯´ä¸Šé¢çš„ä»£ç ï¼Œæˆ‘å°±æ˜¯å®ç°äº†è‡ªå·±çš„å­ç±»æ‰èƒ½åšåˆ°æ¶ˆæ¯å¤„ç†ï¼Œä½ ä¹Ÿå¯ä»¥å®ç°è¿™ä¸ªCallbackï¼Œç„¶å new Handlerï¼ˆCallbackï¼‰å°±å¯ä»¥äº†ã€‚ 1234567891011/** * Callback interface you can use when instantiating a Handler to avoid * having to implement your own subclass of Handler. */public interface Callback &#123; /** * @param msg A &#123;@link android.os.Message Message&#125; object * @return True if no further handling is desired */ public boolean handleMessage(Message msg);&#125; å‡½æ•° æ„é€ å‡½æ•° 4ä¸ªå‚æ•°ï¼Œéƒ½æœ‰é»˜è®¤å€¼ï¼Œåˆ†åˆ«æ˜¯ Looper.myLooper() è·å–åˆ°çš„ï¼Œå¦‚æœä½ åœ¨ä¸»çº¿ç¨‹åˆå§‹åŒ–ï¼Œé‚£é»˜è®¤å°±æ˜¯MainLooperï¼Œå¦åˆ™å°±æ˜¯å…¶ä»–çº¿ç¨‹è‡ªå·±çš„Looperï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªè¦æ³¨æ„çš„åœ°æ–¹ï¼Œå°±æ˜¯è¯´ï¼Œå½“å‰çº¿ç¨‹å¿…é¡»æ‰§è¡Œè¿‡ Looper.prepare()ï¼Œä¸€èˆ¬ä½ åœ¨å­çº¿ç¨‹éƒ½éœ€è¦å…ˆæ‰§è¡Œè¿™ä¸ªæ–¹æ³•ï¼Œä½†åœ¨ä¸»çº¿ç¨‹æ˜¯ä¸éœ€è¦çš„ï¼Œå› ä¸ºæ—©åœ¨åº”ç”¨å¯åŠ¨çš„æ—¶å€™ï¼ŒActivityThread çš„ main æ–¹æ³•ä»¥åŠå¸®ä½ æ‰§è¡Œäº†ï¼Œè¿™æ˜¯æˆ‘ä»¬ç¨‹åºæ¯”è¾ƒæ—©çš„ä¸€ä¸ªå…¥å£ã€‚ç„¶åç»‘å®šMessageQueueï¼Œé»˜è®¤æ˜¯Looperçš„Queueï¼Œè¿˜æœ‰Callbackï¼Œé»˜è®¤ä¸ºç©ºï¼Œè¿˜æœ‰å¼‚æ­¥mAsynchronous ï¼Œé»˜è®¤ä¸ºfalseã€‚ 12345678910111213141516171819202122232425public Handler(Looper looper, Callback callback, boolean async) &#123; mLooper = looper; mQueue = looper.mQueue; mCallback = callback; mAsynchronous = async;&#125;/** * Return the Looper object associated with the current thread. Returns * null if the calling thread is not associated with a Looper. */// é™æ€æ–¹æ³•è·å–Looperï¼Œä½¿ç”¨åˆ°äº†ThreadLocal// è¿™ä¸ªå¼ºå¤§çš„å˜é‡ï¼Œä»å½“å‰çº¿ç¨‹å–å€¼ï¼Œ// å‰ææ˜¯ä½ ä¹‹å‰æœ‰æ”¾å…¥è¿‡ä¸œè¥¿ï¼Œä¸ç„¶æ€ä¹ˆå–public static @Nullable Looper myLooper() &#123; return sThreadLocal.get();&#125;// é™æ€æ–¹æ³•ï¼Œå¾€ThreadLocalå­˜åœ¨Looperå®ä¾‹private static void prepare(boolean quitAllowed) &#123; if (sThreadLocal.get() != null) &#123; throw new RuntimeException(&quot;Only one Looper may be created per thread&quot;); &#125; sThreadLocal.set(new Looper(quitAllowed));&#125; ç„¶åæ˜¯æˆ‘ä»¬é€šå¸¸éœ€è¦é‡å†™çš„å‡½æ•°ï¼Œé‡Œé¢æ˜¯æ¶ˆæ¯å¤„ç†çš„é€»è¾‘ 12345/** * Subclasses must implement this to receive messages. */public void handleMessage(Message msg) &#123;&#125; è¿™ä¸ªå‡½æ•°åŸåˆ™ä¸Šä½ ä¹Ÿå¯ä»¥é‡å†™ï¼Œä½†æ˜¯ä¸æ¨èï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå®ƒé¦–å…ˆåˆ¤æ–­msgæ˜¯å¦å¸¦æœ‰callbackï¼Œå¦‚æœä¸ä¸ºç©ºï¼Œåˆ™æ‰§è¡Œå¤„ç†é€»è¾‘ï¼Œå¦åˆ™åˆ¤æ–­mCallbackæ˜¯å¦ä¸ºç©ºï¼Œè¿™ä¸¤ä¸ªCallbackå®¤å‹åŒºåˆ«çš„ï¼Œåé¢è¿™ä¸ªå°±æ˜¯ä¸Šé¢é‚£ä¸ªæ¥å£çš„å®ç°ç±»ï¼Œè€Œmsgçš„callbackæ˜¯èƒŒåè‡ªå·±å°è£…çš„ï¼Œç¨åæˆ‘ä»¬åœ¨çœ‹è¿™ä¸ªç»†èŠ‚ã€‚å¦‚æœæ²¡æœ‰ä¼ è¿›å»callbackï¼Œé‚£ä¹ˆåˆ™è°ƒç”¨handleMessageï¼ˆï¼‰ï¼Œå°±åˆ°äº†æˆ‘ä»¬é‡å†™çš„é‚£ä¸ªåœ°æ–¹äº†ï¼Œè¿™äº›æ˜¯åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œçš„ã€‚ 123456789101112131415/** * Handle system messages here. */public void dispatchMessage(Message msg) &#123; if (msg.callback != null) &#123; handleCallback(msg); &#125; else &#123; if (mCallback != null) &#123; if (mCallback.handleMessage(msg)) &#123; return; &#125; &#125; handleMessage(msg); &#125;&#125; å‘é€æ¶ˆæ¯çš„å‡½æ•°ï¼Œé»˜è®¤æ˜¯ç›´æ¥å‘é€ï¼Œæ³¨æ„ï¼Œè™½ç„¶æ˜¯ EmptyMessageï¼Œä½†è¿˜æ˜¯åœ¨å†…éƒ¨å°è£…äº†ä¸€ä¸ª Messageï¼Œä»¥åè·å–Messageï¼Œä¸è¦å†å‚»å‚»çš„new Messageäº†ï¼Œé€šè¿‡Message.obtain æˆ–è€… Handler.obtainã€‚è¿™ä¸€æ­¥å¯ä»¥åœ¨å­çº¿ç¨‹è°ƒç”¨ 12345678910111213141516171819202122232425/** * Sends a Message containing only the what value. * * @return Returns true if the message was successfully placed in to the * message queue. Returns false on failure, usually because the * looper processing the message queue is exiting. */public final boolean sendEmptyMessage(int what) &#123; return sendEmptyMessageDelayed(what, 0);&#125;public final boolean sendEmptyMessageDelayed(int what, long delayMillis) &#123; Message msg = Message.obtain(); msg.what = what; return sendMessageDelayed(msg, delayMillis);&#125;// æœ€åè¿˜æ˜¯è°ƒç”¨äº†atTimepublic final boolean sendMessageDelayed(Message msg, long delayMillis)&#123; if (delayMillis &lt; 0) &#123; delayMillis = 0; &#125; return sendMessageAtTime(msg, SystemClock.uptimeMillis() + delayMillis);&#125; è·å–MessageQueueï¼Œå°†Messageå…¥é˜Ÿï¼Œæ³¨æ„ï¼Œè¿™é‡Œmsg.target = thisï¼Œå°†handlerç»‘å®šåˆ°messageä¸Šï¼Œåˆ°æ—¶å€™å°±èƒ½æ‰¾åˆ°æ¶ˆæ¯å¯¹åº”çš„handlerå®ä¾‹äº†ï¼Œå¼ºè°ƒä¸€ä¸‹ï¼Œä¸€ä¸ªçº¿ç¨‹å¯¹åº”ä¸€ä¸ªqueueï¼Œä¸€ä¸ªqueueå¯ä»¥æœ‰å¤šä¸ªhandlerï¼Œæ‰€ä»¥æœ‰éœ€è¦åŒºåˆ†å¤šä¸ªhandlerï¼Œå°±æ˜¯è¿™é‡Œè®¾ç½®targetï¼Œç»‘å®šå®ä¾‹ï¼Œç„¶åå…¥é˜Ÿï¼Œæ³¨æ„ï¼Œå¼‚æ­¥ä¹Ÿæ˜¯åœ¨è¿™é‡Œé…ç½® 1234567891011121314151617public boolean sendMessageAtTime(Message msg, long uptimeMillis) &#123; MessageQueue queue = mQueue; if (queue == null) &#123; RuntimeException e = new RuntimeException( this + &quot; sendMessageAtTime() called with no mQueue&quot;); Log.w(&quot;Looper&quot;, e.getMessage(), e); return false; &#125; return enqueueMessage(queue, msg, uptimeMillis);&#125;private boolean enqueueMessage(MessageQueue queue, Message msg, long uptimeMillis) &#123; msg.target = this; if (mAsynchronous) &#123; msg.setAsynchronous(true); &#125; return queue.enqueueMessage(msg, uptimeMillis);&#125; MessageQueue çš„æºç ï¼Œä½¿ç”¨synchronisedä¿è¯é¡ºåºæ€§ï¼Œè‡³äºMessageQueueçš„ç§ç§ç»†èŠ‚ï¼Œä¸‹æ¬¡åœ¨åˆ†æ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253boolean enqueueMessage(Message msg, long when) &#123; if (msg.target == null) &#123; throw new IllegalArgumentException(&quot;Message must have a target.&quot;); &#125; if (msg.isInUse()) &#123; throw new IllegalStateException(msg + &quot; This message is already in use.&quot;); &#125; synchronized (this) &#123; if (mQuitting) &#123; IllegalStateException e = new IllegalStateException( msg.target + &quot; sending message to a Handler on a dead thread&quot;); Log.w(TAG, e.getMessage(), e); msg.recycle(); return false; &#125; msg.markInUse(); msg.when = when; Message p = mMessages; boolean needWake; if (p == null || when == 0 || when &lt; p.when) &#123; // New head, wake up the event queue if blocked. msg.next = p; mMessages = msg; needWake = mBlocked; &#125; else &#123; // Inserted within the middle of the queue. Usually we don&apos;t have to wake // up the event queue unless there is a barrier at the head of the queue // and the message is the earliest asynchronous message in the queue. needWake = mBlocked &amp;&amp; p.target == null &amp;&amp; msg.isAsynchronous(); Message prev; for (;;) &#123; prev = p; p = p.next; if (p == null || when &lt; p.when) &#123; break; &#125; if (needWake &amp;&amp; p.isAsynchronous()) &#123; needWake = false; &#125; &#125; msg.next = p; // invariant: p == prev.next prev.next = msg; &#125; // We can assume mPtr != 0 because mQuitting is false. if (needWake) &#123; nativeWake(mPtr); &#125; &#125; return true;&#125; 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105Message next() &#123; // Return here if the message loop has already quit and been disposed. // This can happen if the application tries to restart a looper after quit // which is not supported. final long ptr = mPtr; if (ptr == 0) &#123; return null; &#125; int pendingIdleHandlerCount = -1; // -1 only during first iteration int nextPollTimeoutMillis = 0; for (;;) &#123; if (nextPollTimeoutMillis != 0) &#123; Binder.flushPendingCommands(); &#125; // poll æ¶ˆæ¯ nativePollOnce(ptr, nextPollTimeoutMillis); synchronized (this) &#123; // Try to retrieve the next message. Return if found. final long now = SystemClock.uptimeMillis(); Message prevMsg = null; Message msg = mMessages; if (msg != null &amp;&amp; msg.target == null) &#123; // Stalled by a barrier. Find the next asynchronous message in the queue. do &#123; prevMsg = msg; msg = msg.next; &#125; while (msg != null &amp;&amp; !msg.isAsynchronous()); &#125; if (msg != null) &#123; if (now &lt; msg.when) &#123; // Next message is not ready. Set a timeout to wake up when it is ready. nextPollTimeoutMillis = (int) Math.min(msg.when - now, Integer.MAX_VALUE); &#125; else &#123; // Got a message. mBlocked = false; if (prevMsg != null) &#123; prevMsg.next = msg.next; &#125; else &#123; mMessages = msg.next; &#125; msg.next = null; if (DEBUG) Log.v(TAG, &quot;Returning message: &quot; + msg); msg.markInUse(); return msg; &#125; &#125; else &#123; // No more messages. nextPollTimeoutMillis = -1; &#125; // Process the quit message now that all pending messages have been handled. if (mQuitting) &#123; dispose(); return null; &#125; // If first time idle, then get the number of idlers to run. // Idle handles only run if the queue is empty or if the first message // in the queue (possibly a barrier) is due to be handled in the future. if (pendingIdleHandlerCount &lt; 0 &amp;&amp; (mMessages == null || now &lt; mMessages.when)) &#123; pendingIdleHandlerCount = mIdleHandlers.size(); &#125; if (pendingIdleHandlerCount &lt;= 0) &#123; // No idle handlers to run. Loop and wait some more. mBlocked = true; continue; &#125; if (mPendingIdleHandlers == null) &#123; mPendingIdleHandlers = new IdleHandler[Math.max(pendingIdleHandlerCount, 4)]; &#125; mPendingIdleHandlers = mIdleHandlers.toArray(mPendingIdleHandlers); &#125; // Run the idle handlers. // We only ever reach this code block during the first iteration. for (int i = 0; i &lt; pendingIdleHandlerCount; i++) &#123; final IdleHandler idler = mPendingIdleHandlers[i]; mPendingIdleHandlers[i] = null; // release the reference to the handler boolean keep = false; try &#123; keep = idler.queueIdle(); &#125; catch (Throwable t) &#123; Log.wtf(TAG, &quot;IdleHandler threw exception&quot;, t); &#125; if (!keep) &#123; synchronized (this) &#123; mIdleHandlers.remove(idler); &#125; &#125; &#125; // Reset the idle handler count to 0 so we do not run them again. pendingIdleHandlerCount = 0; // While calling an idle handler, a new message could have been delivered // so go back and look again for a pending message without waiting. nextPollTimeoutMillis = 0; &#125;&#125; è·å–æ¶ˆæ¯ï¼Œè°ƒç”¨MessageQueueçš„nextï¼Œç„¶åçœ‹åˆ°äº†msg.target.dispatchMessage(msg)è¿™ä¸ªæ˜¯åœ¨ä¸»çº¿ç¨‹çš„ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475/** * Run the message queue in this thread. Be sure to call * &#123;@link #quit()&#125; to end the loop. */public static void loop() &#123; final Looper me = myLooper(); if (me == null) &#123; throw new RuntimeException(&quot;No Looper; Looper.prepare() wasn&apos;t called on this thread.&quot;); &#125; // è·å– Queue é€šè¿‡ MessageQueue final MessageQueue queue = me.mQueue; // Make sure the identity of this thread is that of the local process, // and keep track of what that identity token actually is. Binder.clearCallingIdentity(); final long ident = Binder.clearCallingIdentity(); for (;;) &#123; // è·å–æ¶ˆæ¯ï¼Œè°ƒç”¨MessageQueueçš„next Message msg = queue.next(); // might block if (msg == null) &#123; // No message indicates that the message queue is quitting. return; &#125; // This must be in a local variable, in case a UI event sets the logger final Printer logging = me.mLogging; if (logging != null) &#123; logging.println(&quot;&gt;&gt;&gt;&gt;&gt; Dispatching to &quot; + msg.target + &quot; &quot; + msg.callback + &quot;: &quot; + msg.what); &#125; final long slowDispatchThresholdMs = me.mSlowDispatchThresholdMs; final long traceTag = me.mTraceTag; if (traceTag != 0 &amp;&amp; Trace.isTagEnabled(traceTag)) &#123; Trace.traceBegin(traceTag, msg.target.getTraceName(msg)); &#125; final long start = (slowDispatchThresholdMs == 0) ? 0 : SystemClock.uptimeMillis(); final long end; try &#123; msg.target.dispatchMessage(msg); end = (slowDispatchThresholdMs == 0) ? 0 : SystemClock.uptimeMillis(); &#125; finally &#123; if (traceTag != 0) &#123; Trace.traceEnd(traceTag); &#125; &#125; if (slowDispatchThresholdMs &gt; 0) &#123; final long time = end - start; if (time &gt; slowDispatchThresholdMs) &#123; Slog.w(TAG, &quot;Dispatch took &quot; + time + &quot;ms on &quot; + Thread.currentThread().getName() + &quot;, h=&quot; + msg.target + &quot; cb=&quot; + msg.callback + &quot; msg=&quot; + msg.what); &#125; &#125; if (logging != null) &#123; logging.println(&quot;&lt;&lt;&lt;&lt;&lt; Finished to &quot; + msg.target + &quot; &quot; + msg.callback); &#125; // Make sure that during the course of dispatching the // identity of the thread wasn&apos;t corrupted. final long newIdent = Binder.clearCallingIdentity(); if (ident != newIdent) &#123; Log.wtf(TAG, &quot;Thread identity changed from 0x&quot; + Long.toHexString(ident) + &quot; to 0x&quot; + Long.toHexString(newIdent) + &quot; while dispatching to &quot; + msg.target.getClass().getName() + &quot; &quot; + msg.callback + &quot; what=&quot; + msg.what); &#125; msg.recycleUnchecked(); &#125;&#125; å½“ç„¶ï¼Œhandlerè¿˜æœ‰å…¶ä»–ç”¨æ³•ï¼Œæ¯”å¦‚postï¼Œä½†éœ€è¦æ³¨æ„ï¼Œè¿™ä¸ªè™½ç„¶æäº¤äº†ä¸€ä¸ªRunnableï¼Œä½†è·Ÿéšè€…æ¶ˆæ¯é“¾ï¼Œä½ ä¼šå‘ç°ï¼Œå®ƒçš„æ‰§è¡Œæ˜¯ç›´æ¥åœ¨ä¸»çº¿ç¨‹è°ƒç”¨runæ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´è¿è¡Œåœ¨ä¸»çº¿ç¨‹çš„ï¼Œæ‰€ä»¥ä½¿ç”¨æ—¶å€™éœ€è¦æ³¨æ„äº†ï¼Œåˆ«ç”¨é”™äº† 1234567891011121314151617public final boolean post(Runnable r)&#123; return sendMessageDelayed(getPostMessage(r), 0);&#125;// callback message çš„callbackï¼Œä¸ä¹‹å‰Callbackæœ‰å¾ˆå¤§çš„åŒºåˆ«private static Message getPostMessage(Runnable r) &#123; Message m = Message.obtain(); m.callback = r; return m;&#125;public final boolean sendMessageDelayed(Message msg, long delayMillis)&#123; if (delayMillis &lt; 0) &#123; delayMillis = 0; &#125; return sendMessageAtTime(msg, SystemClock.uptimeMillis() + delayMillis);&#125; å°ç»“ ä½¿ç”¨æ–¹æ³•ï¼Œç»§æ‰¿Handlerï¼Œæˆ–è€…å®ç°Callbackï¼Œåˆæˆ–è€…post å„éƒ¨åˆ†è¿è¡Œåœ¨ä»€ä¹ˆåœ°æ–¹ï¼Œä¸»çº¿ç¨‹å’Œå­çº¿ç¨‹è¦åŒºåˆ† MessageQueueï¼ŒLooperï¼ŒHandler ä¹‹é—´çš„å…³ç³»ï¼Œåœ¨ä»€ä¹ˆåœ°æ–¹åˆå§‹åŒ– æ¬¢è¿è®¨è®º","categories":[{"name":"Android","slug":"Android","permalink":"https://wzes.github.io/categories/Android/"}],"tags":[{"name":"Android","slug":"Android","permalink":"https://wzes.github.io/tags/Android/"}]},{"title":"JVM-Class-å­—èŠ‚ç å­¦ä¹ ç¬”è®°","slug":"JVM/JVM Class å­—èŠ‚ç å­¦ä¹ ç¬”è®°","date":"2018-08-15T06:47:00.000Z","updated":"2019-09-02T12:22:58.160Z","comments":true,"path":"2018/08/15/JVM/JVM Class å­—èŠ‚ç å­¦ä¹ ç¬”è®°/","link":"","permalink":"https://wzes.github.io/2018/08/15/JVM/JVM Class å­—èŠ‚ç å­¦ä¹ ç¬”è®°/","excerpt":"","text":"ç›®æ ‡ä½¿ç”¨javapç›´æ¥é˜…è¯»å­—èŠ‚ç  é­”æ•° å¼€å¤´å‰4ä¸ªå­—èŠ‚ä¸º CAFE BABEï¼Œï¼ˆä¸¤ä¸ªåå…­è¿›åˆ¶å­—ç¬¦ä¸ºä¸€ä¸ªå­—èŠ‚ï¼‰ï¼Œåå››ä¸ªå­—èŠ‚ä¸ºClass æ–‡ä»¶çš„ç‰ˆæœ¬å·ï¼Œå…ˆæ¬¡ç‰ˆæœ¬å·ï¼Œåä¸»ç‰ˆæœ¬å·ï¼Œèƒ½å‘ä¸‹å…¼å®¹ï¼Œä¸èƒ½å‘åå…¼å®¹ï¼Œ ä¹‹åçš„ä¸¤ä¸ªå­—èŠ‚ä¸ºå¸¸é‡æ± å¸¸é‡çš„ä¸ªæ•°ï¼Œä»1å¼€å§‹è®¡æ•°ï¼Œåœ¨ä¹‹åå°±æ˜¯æ¯ä¸€ä¸ªå¸¸é‡çš„ä¿¡æ¯ï¼Œæœ€å¤š64 kä¸ª å¸¸è§çš„æœ‰ 14 ä¸ª Classï¼štagï¼ˆu1ï¼‰+ name_indexï¼ˆu2ï¼‰ Utf8ï¼štagï¼ˆu1ï¼‰+ lengthï¼ˆu2ï¼‰+ bytesï¼ˆlengthï¼‰æ–¹æ³•åï¼Œå­—æ®µåï¼ŒåŠ ä¸ŠåŒ…åä¸èƒ½è¶…è¿‡64k åŸºç¡€æ•°æ®ç±»å‹ï¼Œtagï¼ˆu1ï¼‰+ bytesï¼ˆï¼Ÿï¼‰å€¼ è®¿é—®æ ‡å¿—ï¼Œä¸¤ä¸ªå­—èŠ‚ï¼Œä¸ºæ ‡å¿—ä½ï¼Œç”¨äºè¡¨ç¤ºç±»çš„ä¿¡æ¯ï¼Œæ¯”å¦‚æ˜¯å¦æ˜¯publicï¼Œfinalï¼Œsuperï¼Œinterfaceï¼Œabstractï¼Œenumï¼Œannotation ç±»ç´¢å¼•ï¼Œçˆ¶ç±»ç´¢å¼•ï¼Œæ¥å£ç´¢å¼• å­—æ®µè¡¨ï¼Œè®¿é—®æ ‡å¿—ï¼Œpublic protected private ä¸‰é€‰ä¸€ï¼Œfinal volatile ä¸èƒ½åŒæ—¶é€‰æ‹©ï¼Œæ¥å£ä¸­public static final æ˜¯å¿…é¡»çš„ã€‚access_flags, name_indexï¼ˆç®€å•åç§°ï¼‰,descriptor_indexï¼ˆå…¨é™å®šåï¼‰,attributes_count,attributes æ–¹æ³•è¡¨é›†åˆaccess_flags ï¼ˆstrictfpï¼Œnativeï¼Œsynchronized å±æ€§è¡¨é›†åˆ InnerClass LineNumberTable æºç ä¸å­—èŠ‚ç å¯¹åº” LocalVariableTable StackMapTable Signature SourceFile Synthetic æ¯ä¸ªå±æ€§éƒ½å¼•ç”¨å¸¸é‡æ± é‡Œæ¥è¡¨ç¤º Code å±æ€§ï¼Œæ–¹æ³•ä½“çš„ä¿¡æ¯å­˜å‚¨åœ¨è¿™ï¼Œcode_length é•¿åº¦å›ºå®š","categories":[{"name":"Java","slug":"Java","permalink":"https://wzes.github.io/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://wzes.github.io/tags/Java/"}]},{"title":"Java8 LinkedBlockingQueue æºç è§£æ","slug":"Java/Java8 LinkedBlockingQueue æºç è§£æ","date":"2018-08-14T14:48:00.000Z","updated":"2019-09-02T12:21:04.071Z","comments":true,"path":"2018/08/14/Java/Java8 LinkedBlockingQueue æºç è§£æ/","link":"","permalink":"https://wzes.github.io/2018/08/14/Java/Java8 LinkedBlockingQueue æºç è§£æ/","excerpt":"","text":"LinkedBlockingQueue é“¾è¡¨é˜»å¡é˜Ÿåˆ— é“¾è¡¨é˜»å¡é˜Ÿåˆ—ï¼Œé¡¾åæ€ä¹‰ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªåŸºäºé˜Ÿåˆ—çš„é˜»å¡å¼çš„é“¾è¡¨å®ç°ï¼Œé‡Œé¢çš„ä»£ç å†™çš„å¾ˆæ¼‚äº®ï¼Œç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼åœ¨è¿™ä¸ªç±»ä¸­ç”¨çš„é…£ç•…æ·‹æ¼“ï¼Œå…¶ä½œè€…æ˜¯å¤§åé¼é¼çš„ Doug Leaï¼ŒæŒæ¡è¿™ä¸ªç±»æ˜¯æ¯”è¾ƒé‡è¦çš„ã€‚é‡Œé¢å¾ˆå¤šå®ç°åŸºäºé”ï¼Œå¯ä»¥å¥½å¥½å­¦ä¹ ä¸€ä¸‹ã€‚ å‰ä¸–ä»Šç”Ÿ ç»§æ‰¿è‡ªAbstractQueue å®ç°äº† BlockingQueueï¼Œé‚£æˆ‘ä»¬å°±æ¥çœ‹ä¸€ä¸‹æœ‰å“ªäº›æ¥å£ï¼Œè¿™äº›æ˜¯åŸºç¡€ï¼Œè¦ç‰¢è®° ä¸»è¦å°±æ˜¯takeï¼ˆæ‹¿ï¼‰å’Œputï¼ˆæ”¾ï¼‰ï¼Œå…¶ä½™çš„offerï¼Œpollï¼Œadd æœ‰æ›´é«˜çº§çš„ç”¨æ³•ï¼Œç¨åå†è¯´ ä½¿ç”¨åœºæ™¯ æˆ‘æŸ¥äº†ä¸€äº›èµ„æ–™ï¼Œæ„Ÿè§‰å’Œ MQ æœ‰ç‚¹è”ç³»ï¼Œå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™ä¸ªä¸œè¥¿è¿›è¡Œè§£è€¦ï¼Œæˆ–è€…è´Ÿè½½å‡è¡¡ï¼Œæ¯”å¦‚è¯´ï¼Œæœ‰å¾ˆå¤šä»»åŠ¡éœ€è¦æäº¤ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠä»»åŠ¡æäº¤ç»™ Queueï¼Œæ¶ˆè´¹è€…è´Ÿè´£å¤„ç†æ¶ˆæ¯ï¼Œè¿™ä¸ªå¯ä»¥æ ¹æ®æ¶ˆè´¹è€…çš„èƒ½åŠ›å†³å®šä»»åŠ¡çš„æ‰§è¡Œæ•ˆç‡ï¼Œä¸ä¼šä¸€ä¸‹å­—ä»»åŠ¡è¿‡æ¥è€Œå¯¼è‡´å´©æºƒï¼Œè®²é“ç†ï¼Œå¯ä»¥é€‚åˆå¤šç”Ÿäº§è€…ï¼Œå¤šæ¶ˆè´¹è€…æ¨¡å¼ï¼Œå¦‚æœæœ‰è¿™ä¸ªï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå¥½çš„è¿›è¡Œè§£è€¦ï¼Œè´Ÿè½½å‡è¡¡ å®ç°åŸç†å¤§ç™½è¯ å±æ€§ ç»å¯¹çš„é‡å¤´æˆï¼Œä¸Šæ¥å°±ä¸€å †å¹²æ´»ï¼Œå¯ä»¥å»è¡¥è¡¥ ReentrantLock å’Œ Condition çš„çŸ¥è¯†ï¼Œçœ‹ä¸€ä¸‹ï¼Œæ‹¿å’Œå–éƒ½ç”¨äº†ä¸€æŠŠé”ï¼ŒtakeLock å¯¹åº”çš„æ˜¯ notEmpty Conditionï¼ŒputLock å¯¹åº”çš„æ˜¯ notFull Conditionï¼Œ å¤§è‡´çš„æ„æ€å°±æ˜¯ï¼Œå½“ä½ æ‹¿çš„æ—¶å€™ï¼Œå¦‚æœå‘ç°é˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™éœ€è¦ç­‰å¾…ï¼Œå½“ä½ æ”¾çš„æ—¶å€™ï¼Œå¦‚æœå‘ç°é˜Ÿåˆ—æ»¡äº†ï¼Œä¹Ÿéœ€è¦ç­‰å¾…ï¼Œè¿™é‡Œçš„ç­‰å¾…é çš„å°±æ˜¯notEmpty å’Œ notFull çš„ await æ–¹æ³•ï¼Œå½“ä½ å¾€é˜Ÿåˆ—æ·»åŠ å…ƒç´ æˆåŠŸåï¼Œåˆ™notEmpty.signalï¼ˆï¼‰ æé†’æ¶ˆè´¹è€…å¯ä»¥æ‹¿ä¸œè¥¿äº†ï¼Œåä¹‹ï¼Œå½“ä½ å–å®Œä¸€ä¸ªä¸œè¥¿ä¹‹åï¼Œåˆ™ notFull.singalï¼ˆï¼‰æé†’ç”Ÿäº§è€…å¯ä»¥æ”¾ä¸œè¥¿äº†ã€‚ 1234567891011/** Lock held by take, poll, etc */private final ReentrantLock takeLock = new ReentrantLock();/** Wait queue for waiting takes */private final Condition notEmpty = takeLock.newCondition();/** Lock held by put, offer, etc */private final ReentrantLock putLock = new ReentrantLock();/** Wait queue for waiting puts */private final Condition notFull = putLock.newCondition(); è¿˜æœ‰ä¸€äº›å…¶ä»–çš„å‚æ•°ï¼Œå®¹é‡ä»¥åŠå¯¹å¤´é˜Ÿå°¾ï¼Œé»˜è®¤å®¹é‡ä¸º Interger.MAX__VALUEï¼Œè¿˜æœ‰åŸå­ç±»çš„AtomicInterger ç”¨äºè®¡æ•°ï¼Œä¿è¯åŸå­æ€§ 1234567891011121314151617/** The capacity bound, or Integer.MAX_VALUE if none */private final int capacity;/** Current number of elements */private final AtomicInteger count = new AtomicInteger();/** * Head of linked list. * Invariant: head.item == null */transient Node&lt;E&gt; head;/** * Tail of linked list. * Invariant: last.next == null */private transient Node&lt;E&gt; last; å‡½æ•° æ„é€ å‡½æ•°ï¼Œhead å’Œ tail è®¾ç½®ä¸ºç©ºçš„èŠ‚ç‚¹å¯¹è±¡ï¼Œç¨ååœ¨åˆ†æä½œç”¨ 12345public LinkedBlockingQueue(int capacity) &#123; if (capacity &lt;= 0) throw new IllegalArgumentException(); this.capacity = capacity; last = head = new Node&lt;E&gt;(null);&#125; put å‡½æ•°ï¼Œ// é¦–å…ˆè·å– putLock çš„é”ï¼Œä¿è¯putLockçš„çº¿ç¨‹å®‰å…¨æ€§ 12345678910111213141516171819202122232425262728293031323334353637383940public void put(E e) throws InterruptedException &#123; if (e == null) throw new NullPointerException(); // Note: convention in all put/take/etc is to preset local var // holding count negative to indicate failure unless set. int c = -1; // æ„é€ ä¸€ä¸ªæ–°çš„èŠ‚ç‚¹ Node&lt;E&gt; node = new Node&lt;E&gt;(e); final ReentrantLock putLock = this.putLock; final AtomicInteger count = this.count; // é¦–å…ˆè·å– putLock çš„é”ï¼Œä¿è¯putLockçš„çº¿ç¨‹å®‰å…¨æ€§ putLock.lockInterruptibly(); try &#123; /* * Note that count is used in wait guard even though it is * not protected by lock. This works because count can * only decrease at this point (all other puts are shut * out by lock), and we (or some other waiting put) are * signalled if it ever changes from capacity. Similarly * for all other uses of count in other wait guards. */ // å¦‚æœé˜Ÿåˆ—å·²æ»¡ï¼Œåˆ™ç­‰å¾…æ¶ˆè´¹è€…è°ƒç”¨ notFull.signalï¼ˆï¼‰ while (count.get() == capacity) &#123; notFull.await(); &#125; // å…¥é˜Ÿ enqueue(node); // åŸå­åŠ 1 c = count.getAndIncrement(); // å¦‚æœæ­¤æ—¶é˜Ÿåˆ—æ²¡æœ‰æ»¡ï¼Œè°ƒç”¨ signal æ›´æ–° count if (c + 1 &lt; capacity) notFull.signal(); &#125; finally &#123; // é‡Šæ”¾é” putLock.unlock(); &#125; // å¦‚æœ c ä¸º 0ï¼›è¿™é‡Œçš„ c ä¸ºä¹‹å‰çš„å€¼ // ä¹Ÿå°±æ˜¯è¯´ï¼Œç°åœ¨å·²ç»åŠ 1äº†ï¼Œå¯ä»¥æç¤ºç”Ÿäº§è€… if (c == 0) signalNotEmpty();&#125; å…¥é˜Ÿï¼Œå¾ˆç®€å•ï¼Œå†™çš„å¾ˆå·§å¦™ï¼Œå­¦ä¹ ä¸€ä¸‹ 12345private void enqueue(Node&lt;E&gt; node) &#123; // assert putLock.isHeldByCurrentThread(); // assert last.next == null; last = last.next = node;&#125; å‡ºé˜Ÿï¼Œæ‰‹åŠ¨GC 1234567891011private E dequeue() &#123; // assert takeLock.isHeldByCurrentThread(); // assert head.item == null; Node&lt;E&gt; h = head; Node&lt;E&gt; first = h.next; h.next = h; // help GC head = first; E x = first.item; first.item = null; return x; &#125; è·å– takeLockï¼Œé€šçŸ¥æ¶ˆè´¹è€…å¯ä»¥æ¶ˆè´¹äº† 123456789private void signalNotEmpty() &#123; final ReentrantLock takeLock = this.takeLock; takeLock.lock(); try &#123; notEmpty.signal(); &#125; finally &#123; takeLock.unlock(); &#125;&#125; é¡ºä¾¿çœ‹ä¸€ä¸‹ï¼Œé€šçŸ¥ç”Ÿäº§è€…å¯ä»¥æ”¾å…¥é˜Ÿåˆ—äº† 123456789private void signalNotFull() &#123; final ReentrantLock putLock = this.putLock; putLock.lock(); try &#123; notFull.signal(); &#125; finally &#123; putLock.unlock(); &#125;&#125; æ‹¿æ•°æ®ï¼Œé¦–å…ˆè¿˜æ˜¯è¦è·å–æ‹¿çš„é”ï¼Œå¦‚æœcount == 0 ï¼Œé‚£ä¹ˆåˆ™è¯´æ˜æ²¡æœ‰æ•°æ®ï¼Œéœ€è¦é˜»å¡ç­‰å¾…ï¼Œæƒ³è±¡ä¸€ä¸‹ï¼Œè¿™æ—¶å€™åˆæƒ³æ”¾å…¥æ•°æ®ï¼Œé‚£ä¹ˆå°†é˜»å¡åœ¨takeLocké‡Œé¢ï¼ŒçŸ¥é“ç”Ÿäº§è€…è°ƒç”¨äº†signalï¼Œæ‰§è¡Œå‡ºé˜Ÿã€‚ æ³¨æ„ä¸€ä¸ªé—®é¢˜ï¼Œç”±äºå¤šçº¿ç¨‹çš„ä¸å®šæ€§ï¼Œæ¯æ¬¡c &gt; 1æ—¶ï¼Œéƒ½éœ€è¦å†æ¬¡signalï¼Œç”±äºï¼Œå¤šä¸ªæ¶ˆè´¹è€…åˆ°ä¼šé˜»å¡åˆ°awaitï¼Œè€Œä¸æ˜¯å¤–é¢çš„ lockInterruptiblyï¼Œæ‰€ä»¥æ¯æ¬¡éƒ½éœ€è¦ signalï¼Œæ›´æ–° count çš„çŠ¶æ€ 123456789101112131415161718192021222324public E take() throws InterruptedException &#123; E x; int c = -1; final AtomicInteger count = this.count; final ReentrantLock takeLock = this.takeLock; takeLock.lockInterruptibly(); try &#123; // é˜»å¡ï¼Œè¯·æ³¨æ„ï¼Œå¤šä¸ªæ¶ˆè´¹è€…éƒ½ä¼šé˜»å¡åœ¨è¿™é‡Œ while (count.get() == 0) &#123; notEmpty.await(); &#125; x = dequeue(); // æ³¨æ„ï¼Œè·å–åˆ°æ›´æ–°å‰çš„å€¼ c = count.getAndDecrement()ï¼› if (c &gt; 1) notEmpty.signal(); &#125; finally &#123; takeLock.unlock(); &#125; // å¦‚æœä¹‹å‰é˜Ÿåˆ—æ»¡äº†ï¼Œé‚£ä¹ˆç°åœ¨ä¸ä¼šæ»¡äº†ï¼Œæç¤ºç”Ÿäº§è€…å¯ä»¥ç”Ÿäº§äº† if (c == capacity) signalNotFull(); return x;&#125; è¿™ä¸ªæ–¹æ³•å¦‚æœæ²¡æœ‰æ•°æ®ç›´æ¥è¿”å›ç©º 12345678910111213141516171819202122public E poll() &#123; final AtomicInteger count = this.count; if (count.get() == 0) return null; E x = null; int c = -1; final ReentrantLock takeLock = this.takeLock; takeLock.lock(); try &#123; if (count.get() &gt; 0) &#123; x = dequeue(); c = count.getAndDecrement(); if (c &gt; 1) notEmpty.signal(); &#125; &#125; finally &#123; takeLock.unlock(); &#125; if (c == capacity) signalNotFull(); return x; &#125; åŒæ ·çš„ï¼Œè¿™ä¸ªæ–¹æ³•åˆ©ç”¨äº†condition çš„å»¶è¿Ÿæ€§ï¼Œå¯ç­‰å¾…ä¸€å®šæ—¶é—´ï¼Œå¦‚æœè¶…è¿‡è¿™ä¸ªæ—¶é—´è¿˜æ²¡æœ‰ç»“æœåˆ™è¿”å›null 123456789101112131415161718192021222324public E poll(long timeout, TimeUnit unit) throws InterruptedException &#123; E x = null; int c = -1; long nanos = unit.toNanos(timeout); final AtomicInteger count = this.count; final ReentrantLock takeLock = this.takeLock; takeLock.lockInterruptibly(); try &#123; while (count.get() == 0) &#123; if (nanos &lt;= 0) return null; nanos = notEmpty.awaitNanos(nanos); &#125; x = dequeue(); c = count.getAndDecrement(); if (c &gt; 1) notEmpty.signal(); &#125; finally &#123; takeLock.unlock(); &#125; if (c == capacity) signalNotFull(); return x; &#125; æ”¾å…¥æ•°æ®ï¼ŒåŒæ ·ï¼Œå¦‚æœç­‰å¾…ä¸€å®šæ—¶é—´è¿˜ä¸èƒ½æ”¾å…¥ï¼Œé‚£ä¹ˆå°†æŠ›å¼ƒ 1234567891011121314151617181920212223242526 public boolean offer(E e, long timeout, TimeUnit unit) throws InterruptedException &#123; if (e == null) throw new NullPointerException(); long nanos = unit.toNanos(timeout); int c = -1; final ReentrantLock putLock = this.putLock; final AtomicInteger count = this.count; putLock.lockInterruptibly(); try &#123; while (count.get() == capacity) &#123; if (nanos &lt;= 0) return false; nanos = notFull.awaitNanos(nanos); &#125; enqueue(new Node&lt;E&gt;(e)); c = count.getAndIncrement(); if (c + 1 &lt; capacity) notFull.signal(); &#125; finally &#123; putLock.unlock(); &#125; if (c == 0) signalNotEmpty(); return true;&#125; ä¸ºäº†è®©å¤§å®¶æ›´åŠ æ˜ç™½ ReentrantLockï¼Œæˆ‘è¿™é‡Œç»™å‡ºä¸€ä¸ªä¾‹å­ä¾›å¤§å®¶å­¦ä¹  123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263import java.util.concurrent.locks.Condition;import java.util.concurrent.locks.ReentrantLock;/** * @author Create by xuantang * @date on 8/22/18 */public class ReentrantLockDemo &#123; private static ReentrantLock mLock = new ReentrantLock(); private static Condition mCondition = mLock.newCondition(); public static void main(String[] args) &#123; new WaitThread(&quot;waiter one&quot;).start(); new WaitThread(&quot;waiter two&quot;).start(); new WaitThread(&quot;waiter three&quot;).start(); new NotifyThread(&quot;notify one&quot;).start(); &#125; static class WaitThread extends Thread &#123; WaitThread(String name) &#123; super(name); &#125; @Override public void run() &#123; try &#123; mLock.lockInterruptibly(); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; try &#123; System.out.println(this.getName() + &quot; Waiting......&quot;); mCondition.await(); System.out.println(this.getName() + &quot; Finished.....&quot;); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; finally &#123; mLock.unlock(); &#125; &#125; &#125; static class NotifyThread extends Thread &#123; NotifyThread(String name) &#123; super(name); &#125; @Override public void run() &#123; try &#123; mLock.lockInterruptibly(); mCondition.signal(); System.out.println(this.getName() + &quot; Notify.....&quot;); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; finally &#123; mLock.unlock(); &#125; &#125; &#125;&#125; è¾“å…¥ç»“æœï¼Œåªèƒ½å”¤é†’ä¸€ä¸ªï¼Œå½“ç„¶ä½ å¯ä»¥ä½¿ç”¨ signalAll() å”¤é†’æ‰€æœ‰çš„ 12345waiter one Waiting......waiter two Waiting......waiter three Waiting......notify one Notify.....waiter one Finished..... å°ç»“ æˆ‘ä»¬çœ‹åˆ°äº†å¯é‡å…¥é”ï¼ŒConditionçš„é«˜çº§ç”¨æ³•åˆ©ç”¨ï¼Œä»¥åŠç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹ï¼Œé€šè¿‡äº†è§£æºç ï¼Œæˆ‘ä»¬æ›´åŠ æ·±å…¥çš„å­¦ä¹ åˆ°äº†è¿™ä¸ªæ¨¡å‹çš„ç”¨æ³•ä»¥åŠå®ç°ã€‚","categories":[{"name":"Java","slug":"Java","permalink":"https://wzes.github.io/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://wzes.github.io/tags/Java/"}]},{"title":"Sqlite é”å­¦ä¹ ","slug":"SQLite/Sqlite é”å­¦ä¹ ","date":"2018-08-13T06:28:00.000Z","updated":"2019-09-02T12:23:14.556Z","comments":true,"path":"2018/08/13/SQLite/Sqlite é”å­¦ä¹ /","link":"","permalink":"https://wzes.github.io/2018/08/13/SQLite/Sqlite é”å­¦ä¹ /","excerpt":"","text":"é”ç±»å‹ UNLOCK æ— é” æ–‡ä»¶æ²¡æœ‰æŒæœ‰ä»»ä½•é”ï¼Œå³å½“å‰æ•°æ®åº“ä¸å­˜åœ¨ä»»ä½•è¯»æˆ–å†™çš„æ“ä½œã€‚å…¶å®ƒçš„è¿›ç¨‹å¯ä»¥åœ¨è¯¥æ•°æ®åº“ä¸Šæ‰§è¡Œä»»æ„çš„è¯»å†™æ“ä½œã€‚æ­¤çŠ¶æ€ä¸ºç¼ºçœçŠ¶æ€ SHARED å…±äº«é” åœ¨æ­¤çŠ¶æ€ä¸‹ï¼Œè¯¥æ•°æ®åº“å¯ä»¥è¢«è¯»å–ä½†æ˜¯ä¸èƒ½è¢«å†™å…¥ã€‚åœ¨åŒä¸€æ—¶åˆ»å¯ä»¥æœ‰ä»»æ„æ•°é‡çš„è¿›ç¨‹åœ¨åŒä¸€ä¸ªæ•°æ®åº“ä¸ŠæŒæœ‰å…±äº«é”ï¼Œå› æ­¤è¯»æ“ä½œæ˜¯å¹¶å‘çš„ã€‚æ¢å¥è¯è¯´ï¼Œåªè¦æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªå…±äº«é”å¤„äºæ´»åŠ¨çŠ¶æ€ï¼Œå°±ä¸å†å…è®¸æœ‰æ•°æ®åº“æ–‡ä»¶å†™å…¥çš„æ“ä½œå­˜åœ¨ã€‚ RESERVED ä¿ç•™é” å‡å¦‚æŸä¸ªè¿›ç¨‹åœ¨å°†æ¥çš„æŸä¸€æ—¶åˆ»æ‰“ç®—åœ¨å½“å‰çš„æ•°æ®åº“ä¸­æ‰§è¡Œå†™æ“ä½œï¼Œç„¶è€Œæ­¤æ—¶åªæ˜¯ä»æ•°æ®åº“ä¸­è¯»å–æ•°æ®ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥ç®€å•çš„ç†è§£ä¸ºæ•°æ®åº“æ–‡ä»¶æ­¤æ—¶å·²ç»æ‹¥æœ‰äº†ä¿ç•™é”ã€‚å½“ä¿ç•™é”å¤„äºæ´»åŠ¨çŠ¶æ€æ—¶ï¼Œè¯¥æ•°æ®åº“åªèƒ½æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªå…±äº«é”å­˜åœ¨ï¼Œå³åŒä¸€æ•°æ®åº“çš„åŒä¸€æ—¶åˆ»åªèƒ½å­˜åœ¨ä¸€ä¸ªä¿ç•™é”å’Œå¤šä¸ªå…±äº«é”. éœ€è¦è¯´æ˜çš„æ˜¯updateæ“ä½œ å®é™…ä¸Šæ˜¯ä¸€ä¸ªè¯»æ“ä½œåŠ ä¸€ä¸ªå†™æ“ä½œ PENDING æœªå†³é” PENDINGé”çš„æ„æ€æ˜¯è¯´ï¼ŒæŸä¸ªè¿›ç¨‹æ­£æ‰“ç®—åœ¨è¯¥æ•°æ®åº“ä¸Šæ‰§è¡Œå†™æ“ä½œï¼Œç„¶è€Œæ­¤æ—¶è¯¥æ•°æ®åº“ä¸­å´å­˜åœ¨å¾ˆå¤šå…±äº«é”(è¯»æ“ä½œ)ï¼Œé‚£ä¹ˆè¯¥å†™æ“ä½œå°±å¿…é¡»å¤„äºç­‰å¾…çŠ¶æ€ï¼Œå³ç­‰å¾…æ‰€æœ‰å…±äº«é”æ¶ˆå¤±ä¸ºæ­¢ï¼Œä¸æ­¤åŒæ—¶ï¼Œæ–°çš„è¯»æ“ä½œå°†ä¸å†è¢«å…è®¸ï¼Œä»¥é˜²æ­¢å†™é”é¥¥é¥¿çš„ç°è±¡å‘ç”Ÿã€‚åœ¨æ­¤ç­‰å¾…æœŸé—´ï¼Œè¯¥æ•°æ®åº“æ–‡ä»¶çš„é”çŠ¶æ€ä¸ºPENDINGï¼Œåœ¨ç­‰åˆ°æ‰€æœ‰å…±äº«é”æ¶ˆå¤±ä»¥åï¼ŒPENDINGé”çŠ¶æ€çš„æ•°æ®åº“æ–‡ä»¶å°†åœ¨è·å–æ’ä»–é”ä¹‹åè¿›å…¥EXCLUSIVEçŠ¶æ€ã€‚ EXCLUSIVE æ’å®ƒé” åœ¨æ‰§è¡Œå†™æ“ä½œä¹‹å‰ï¼Œè¯¥è¿›ç¨‹å¿…é¡»å…ˆè·å–è¯¥æ•°æ®åº“çš„æ’ä»–é”ã€‚ç„¶è€Œä¸€æ—¦æ‹¥æœ‰äº†æ’ä»–é”ï¼Œä»»ä½•å…¶å®ƒé”ç±»å‹éƒ½ä¸èƒ½ä¸ä¹‹å…±å­˜ã€‚å› æ­¤ï¼Œä¸ºäº†æœ€å¤§åŒ–å¹¶å‘æ•ˆç‡ï¼ŒSQLite å°†ä¼šæœ€å°åŒ–æ’ä»–é”è¢«æŒæœ‰çš„æ—¶é—´æ€»é‡ã€‚","categories":[{"name":"SQLite","slug":"SQLite","permalink":"https://wzes.github.io/categories/SQLite/"}],"tags":[{"name":"SQLite","slug":"SQLite","permalink":"https://wzes.github.io/tags/SQLite/"}]},{"title":"Android AsyncTask æºç è§£æ","slug":"Android/AsyncTask","date":"2018-08-12T09:12:00.000Z","updated":"2019-09-02T12:17:30.118Z","comments":true,"path":"2018/08/12/Android/AsyncTask/","link":"","permalink":"https://wzes.github.io/2018/08/12/Android/AsyncTask/","excerpt":"","text":"æ˜¯ä»€ä¹ˆä¸œè¥¿ï¼Ÿ é¡¾åæ€ä¹‰ï¼Œå¼‚æ­¥ä»»åŠ¡ï¼Œå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥è®©æˆ‘ä»¬å¼‚æ­¥æ‰§è¡Œä»»åŠ¡ï¼Œä¸è¿‡é€šå¸¸ä½¿ç”¨å®ƒæ˜¯ä¸ºäº†å¼‚æ­¥æ‰§è¡Œï¼Œä¸»çº¿ç¨‹æ›´æ–°UIï¼Œæˆ‘ä»¬éƒ½çŸ¥é“ï¼ŒAndroid çš„UIæ›´æ–°æ“ä½œï¼Œéƒ½ä¼šæ£€æŸ¥æ˜¯å¦æ˜¯ä¸»çº¿ç¨‹ï¼Œå¦‚æœä¸æ˜¯çš„è¯å°±ä¼šæŠ¥å‡ºå¼‚å¸¸ï¼Œè¿™ä¸€æ­¥æ˜¯åœ¨ViewRootImplé‡Œé¢åšçš„ï¼Œè¿™é‡Œå°±ä¸å¤šè¯´äº†ã€‚åœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œæˆ‘ä»¬åªéœ€è¦å°†åå°å¤„ç†çš„ä»£ç å†™åœ¨doInBackgroundï¼Œæ›´æ–°UIçš„å·¥ä½œå†™åœ¨onPostExecuteå°±è¡Œäº†ï¼Œå°±å¯ä»¥è½»æ¾å®ç°ä¸€ä¸ªçº¿ç¨‹åˆ‡æ¢ï¼Œæ›´æ–°UIçš„æ•ˆæœã€‚é‚£è¿™é‡Œä½ å¯èƒ½ä¼šé—®ã€‚ä¸ºä»€ä¹ˆä¸ç”¨Handlerï¼Œæˆ‘ä¹Ÿè®¸ä¼šå‘Šè¯‰ä½ ï¼Œä½¿ç”¨ AsyncTask æœ‰å¾ˆå¤šå¥½å¤„ï¼Œå¾…ä¼šä¼šæ…¢æ…¢å‘Šè¯‰ä½ ï¼Œä½ ä¹Ÿå¯ä»¥æ ¹æ®æºç ï¼Œä¸€æ¢ç©¶ç«Ÿã€‚ å‰ä¸–ä»Šç”Ÿ æ²¡æœ‰ç»§æ‰¿è‡ªä»»ä½•ä¸œè¥¿ï¼ŒObject é™¤å¤–ï¼Œä½¿ç”¨äº†æ¨¡æ¿å®šä¹‰ï¼ŒParams ä»£è¡¨ä½ è¦ä¼ çš„å‚æ•°ç±»å‹ï¼ŒProgress ä»£è¡¨æ›´æ–°æ•°æ®ç±»å‹ï¼ŒResult æ˜¯ä»»åŠ¡æ‰§è¡Œç©è¿”å›æ•°æ®ç±»å‹ã€‚ 1public abstract class AsyncTask&lt;Params, Progress, Result&gt; &#123;&#125; ä½¿ç”¨åœºæ™¯ åªè¦éœ€è¦å¼€å¯å­çº¿ç¨‹çš„éƒ½å¯ä»¥ä½¿ç”¨å®ƒã€‚åœ¨é¡¹ç›®ä¸­ï¼Œéšä¾¿ new Thread å¹¶ä¸æ˜¯ä¸€ä¸ªå¥½ä¹ æƒ¯ï¼Œæ»¥ç”¨ä¸è¯´ï¼Œå¾ˆæœ‰å¯èƒ½é€ æˆå†…å­˜æ³„éœ² å®ç°åŸç†å¤§ç™½è¯ æœ‰ä¸¤ä¸ªä¸œè¥¿å¾ˆå…³é”®ï¼Œä¸€ä¸ªæ˜¯çº¿ç¨‹æ± ï¼Œä¸€ä¸ªæ˜¯ Handlerï¼Œçº¿ç¨‹æ± è´Ÿè´£æ‰§è¡Œä»»åŠ¡ï¼Œ Handler è´Ÿè´£é€šçŸ¥ï¼Œè¯´é“è¿™ï¼Œèªæ˜çš„ä½ å¤§æ¦‚çŒœåˆ°äº†å®ç°æ–¹å¼ï¼Œä½†è¿™å¹¶ä¸å¤Ÿï¼Œæˆ‘ä»¬éœ€è¦ç»†ç»†çš„å“å‘³è¿™ä¸ªç±»æ˜¯å¦‚ä½•å†™æˆçš„ã€‚ æºç è§£æ å±æ€§ é€šè¿‡ä½¿ç”¨ Runtime å¯¹è±¡è·å–å¯ç”¨çš„cpu ä¸ªæ•°ï¼Œåœ¨åˆ›å»ºçº¿ç¨‹æ± æ—¶åˆ›å»ºåˆé€‚çš„çº¿ç¨‹æ•°é‡ï¼Œçº¿ç¨‹æ± çš„å‚æ•°ä¸»è¦æ˜¯æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œè¿™é‡Œæœ€å°å€¼2ï¼Œ æœ€å¤§å€¼4ï¼Œå½“å¤„ç†å™¨ä¸ªæ•°ä¸º4æ—¶ï¼Œåˆ›å»º3ä¸ªæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œæœ€å¤§çº¿ç¨‹æ•°ä¸º cpuä¸ªæ•°çš„ä¸¤å€ + 1ï¼Œå…³äºæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œæœ€å¤§çº¿ç¨‹æ•°ï¼Œå¤§å®¶å¯è‡ªè¡Œå»äº†è§£ä½œç”¨ï¼Œä»¥ååˆ›å»ºçº¿ç¨‹æ± ï¼Œå¤§å®¶å¯è¦è®°ä½äº†ï¼Œä»¥è¿™æ ·åˆ›å»ºçº¿ç¨‹æ± æ•°æ˜¯æ¯”è¾ƒåˆç†çš„ã€‚KeepAliveTime æ˜¯çº¿ç¨‹å­˜æ´»æ—¶é—´ï¼Œè¶…è¿‡è¿™ä¸ªæ—¶é—´çš„çº¿ç¨‹è¦è¢«å›æ”¶ï¼Œè‡³äºå“ªä¸€äº›çº¿ç¨‹ï¼Œå¾…ä¼šå†è¯´ 1234567private static final int CPU_COUNT = Runtime.getRuntime().availableProcessors();// We want at least 2 threads and at most 4 threads in the core pool,// preferring to have 1 less than the CPU count to avoid saturating// the CPU with background workprivate static final int CORE_POOL_SIZE = Math.max(2, Math.min(CPU_COUNT - 1, 4));private static final int MAXIMUM_POOL_SIZE = CPU_COUNT * 2 + 1;private static final int KEEP_ALIVE_SECONDS = 30; é™æ€çº¿ç¨‹å·¥å‚ï¼Œåœ¨ç±»åŠ è½½æ˜¯å°±ä¼šè¢«åˆ›å»ºï¼Œé‡Œé¢ä½¿ç”¨äº†AtomicInteger ç”¨æ¥è®¡æ•°ã€‚ä½¿ç”¨äº†LinkedBlockingQueueä½œä¸ºä»»åŠ¡é˜Ÿåˆ— 123456789101112131415private static final ThreadFactory sThreadFactory = new ThreadFactory() &#123; private final AtomicInteger mCount = new AtomicInteger(1); public Thread newThread(Runnable r) &#123; return new Thread(r, &quot;AsyncTask #&quot; + mCount.getAndIncrement()); &#125;&#125;;private static final BlockingQueue&lt;Runnable&gt; sPoolWorkQueue = new LinkedBlockingQueue&lt;Runnable&gt;(128);/** * An &#123;@link Executor&#125; that can be used to execute tasks in parallel. */public static final Executor THREAD_POOL_EXECUTOR; ä½¿ç”¨é™æ€ä»£ç å—åˆå§‹åŒ–çº¿ç¨‹æ± ï¼Œå‚æ•°ä¸ºä»¥ä¸Šåˆ†æçš„æ•°æ®ï¼Œæ³¨æ„ï¼ŒallowCoreThreadTimeOut è®¾ç½®ä¸ºtrueï¼Œæ„æ€æ˜¯å…è®¸æ ¸å¿ƒçº¿ç¨‹æ•°è¢«å›æ”¶ï¼Œé»˜è®¤æ˜¯ä¸ä¼šè¢«å›æ”¶çš„ 1234567static &#123; ThreadPoolExecutor threadPoolExecutor = new ThreadPoolExecutor( CORE_POOL_SIZE, MAXIMUM_POOL_SIZE, KEEP_ALIVE_SECONDS, TimeUnit.SECONDS, sPoolWorkQueue, sThreadFactory); threadPoolExecutor.allowCoreThreadTimeOut(true); THREAD_POOL_EXECUTOR = threadPoolExecutor;&#125; è¿˜æœ‰ä¸€ä¸ªé‡å¤´æˆï¼Œå•ä»»åŠ¡æ‰§è¡Œå™¨ï¼Œé»˜è®¤ä¸æ˜¯ç”¨ä¸Šé¢çš„çº¿ç¨‹æ± æ‰§è¡Œä»»åŠ¡ï¼Œè€Œæ˜¯ä½¿ç”¨åºåˆ—æ‰§è¡Œå™¨æ‰§è¡Œä»»åŠ¡ï¼Œæ„è¯†å°±æ˜¯ï¼ŒåŒä¸€æ—¶åˆ»åªèƒ½æ‰§è¡Œä¸€ä¸ªä»»åŠ¡ï¼Œæ³¨æ„è¿™äº›éƒ½æ˜¯é™æ€çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€ä¸ªè¿›ç¨‹ï¼Œä¸ç®¡ä½ æ–°å»ºäº†å¤šå°‘ä¸ª Taskå¯¹è±¡ï¼Œä»–ä¹Ÿåªèƒ½å•ä¸ªä»»åŠ¡æ‰§è¡Œï¼Œè¿™æ ·å°±å¾ˆå¥½çš„ç®¡ç†äº†èµ„æºï¼Œé‚£ä»–æ˜¯å¦‚ä½•åšåˆ°å•ä»»åŠ¡æ‰§è¡Œçš„å‘¢ï¼Œå®ç°æ–¹å¼å¯ä»¥è¯´æ˜¯æ—¢å·§å¦™åˆæ— è¯­ï¼Œä¸”çœ‹æ³¨é‡Š 1234567891011121314151617181920212223242526272829303132public static final Executor SERIAL_EXECUTOR = new SerialExecutor();private static class SerialExecutor implements Executor &#123; // ä¿å­˜ä»»åŠ¡ final ArrayDeque&lt;Runnable&gt; mTasks = new ArrayDeque&lt;Runnable&gt;(); Runnable mActive; public synchronized void execute(final Runnable r) &#123; // æ–°ä»»åŠ¡è¿›æ¥ï¼Œä¸æ‰§è¡Œï¼Œè€Œæ˜¯ä½¿ç”¨åŒ¿åå†…éƒ¨ç±»åˆ›å»ºä¸€ä¸ªTaskåŠ åˆ°ä»»åŠ¡é˜Ÿåˆ—é‡Œï¼Œ // å½“è¿™ä¸ªæ‰§è¡Œå®Œçš„æ—¶å€™ï¼Œæ‰ä¼šå»è°ƒç”¨ä¸‹ä¸€ä¸ªä»»åŠ¡ï¼Œå°±åšåˆ°äº†å•ä»»åŠ¡æ‰§è¡Œã€‚ mTasks.offer(new Runnable() &#123; public void run() &#123; try &#123; r.run(); &#125; finally &#123; scheduleNext(); &#125; &#125; &#125;); // é»˜è®¤å…ˆ if (mActive == null) &#123; scheduleNext(); &#125; &#125; // è¿™é‡Œæ˜¯çœŸæ­£å»æ‰§è¡Œçš„ // æ³¨æ„ï¼Œä½¿ç”¨åˆ°äº† synchronized çš„å¯é‡å…¥ç‰¹æ€§ï¼ protected synchronized void scheduleNext() &#123; if ((mActive = mTasks.poll()) != null) &#123; THREAD_POOL_EXECUTOR.execute(mActive); &#125; &#125;&#125; ä¸€äº›é™æ€çš„å˜é‡åŸºæœ¬çœ‹å®Œäº†ï¼Œä¸‹é¢æ¥çœ‹ä¸€ä¸‹æ„é€ å‡½æ•°ï¼Œæœ‰ç‚¹é•¿ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455/** * Creates a new asynchronous task. This constructor must be invoked on the UI thread. * * @hide */public AsyncTask(@Nullable Looper callbackLooper) &#123; // é¦–å…ˆè·å– Handler å¯¹è±¡ï¼Œè¿™é‡Œæœ‰ä¸»çº¿ç¨‹ Handler å’Œå­çº¿ç¨‹Handler ä¹‹åˆ† mHandler = callbackLooper == null || callbackLooper == Looper.getMainLooper() ? getMainHandler() : new Handler(callbackLooper); // å¼‚æ­¥æ‰§è¡Œçš„ï¼Œå®ç°äº†callableæ¥å£ mWorker = new WorkerRunnable&lt;Params, Result&gt;() &#123; public Result call() throws Exception &#123; // ä¸ºäº†é˜²æ­¢å¤šæ¬¡å¤šæ¬¡è°ƒç”¨å®ä¾‹ mTaskInvoked.set(true); Result result = null; try &#123; // è®¾ç½®è¿›ç¨‹çš„ä¼˜å…ˆçº§ Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND); // noinspection unchecked // åœ¨è¿™é‡Œæ‰§è¡ŒdoInBackgroundå‡½æ•°ï¼Œ // è¿™æ˜¯æˆ‘ä»¬éœ€è¦é‡å†™çš„ result = doInBackground(mParams); Binder.flushPendingCommands(); &#125; catch (Throwable tr) &#123; mCancelled.set(true); throw tr; &#125; finally &#123; // æ‰§è¡Œå®Œï¼Œè¿™é‡Œè¿˜æ˜¯åœ¨å­çº¿ç¨‹ postResult(result); &#125; return result; &#125; &#125;; // FutureTask å¯¹è±¡ï¼Œå°è£…Callable å¯¹è±¡ mFuture = new FutureTask&lt;Result&gt;(mWorker) &#123; // ç»“æŸæ—¶è°ƒç”¨ @Override protected void done() &#123; try &#123; // å¦‚æœæ²¡æœ‰è¢«è°ƒç”¨çš„è¯ï¼Œé€šè¿‡getè·å–ç»“æœ postResultIfNotInvoked(get()); &#125; catch (InterruptedException e) &#123; android.util.Log.w(LOG_TAG, e); &#125; catch (ExecutionException e) &#123; throw new RuntimeException(&quot;An error occurred while executing doInBackground()&quot;, e.getCause()); &#125; catch (CancellationException e) &#123; postResultIfNotInvoked(null); &#125; &#125; &#125;;&#125; æ‰§è¡Œå®Œä»¥åï¼Œä½¿ç”¨Handler è¿›è¡Œé€šçŸ¥ï¼Œæ³¨æ„ï¼Œè¿™é‡Œå°†ç»“æœè£…å…¥Messageå¯¹è±¡ä¸­ï¼Œç›´æ¥å‘é€ã€‚ä¸€ä¸ªå°æŠ€å·§ï¼Œæˆ‘ä»¬åœ¨å‘é€æ¶ˆæ¯æ˜¯å°½å¯èƒ½ä½¿ç”¨ obtainMessage è·å–Messageå¯¹è±¡è¦æ¯”newä¸€ä¸ªå¥½å¾—å¤šã€‚ 12345678// è¿”å›ç»“æœï¼Œä½¿ç”¨handlerprivate Result postResult(Result result) &#123; @SuppressWarnings(&quot;unchecked&quot;) Message message = getHandler().obtainMessage(MESSAGE_POST_RESULT, new AsyncTaskResult&lt;Result&gt;(this, result)); message.sendToTarget(); return result;&#125; é‚£æ‰§è¡Œå…¥å£å‘¢? MainThread ä»£è¡¨ä¸»çº¿ç¨‹æ‰§è¡Œ 123456789101112131415161718192021222324252627282930@MainThreadpublic final AsyncTask&lt;Params, Progress, Result&gt; execute(Params... params) &#123; return executeOnExecutor(sDefaultExecutor, params);&#125;@MainThreadpublic final AsyncTask&lt;Params, Progress, Result&gt; executeOnExecutor(Executor exec, Params... params) &#123; // å…ˆæ£€æŸ¥æ˜¯å¦åˆæ³• if (mStatus != Status.PENDING) &#123; switch (mStatus) &#123; case RUNNING: throw new IllegalStateException(&quot;Cannot execute task:&quot; + &quot; the task is already running.&quot;); case FINISHED: throw new IllegalStateException(&quot;Cannot execute task:&quot; + &quot; the task has already been executed &quot; + &quot;(a task can be executed only once)&quot;); &#125; &#125; mStatus = Status.RUNNING; onPreExecute(); mWorker.mParams = params; // æ‰§è¡Œ exec.execute(mFuture); return this;&#125; ä¸€äº›æˆ‘ä»¬å¯èƒ½éœ€è¦å®ç°çš„å‡½æ•° 12345678910111213141516171819// æˆ‘ä»¬å°†åå°é€»è¾‘å†™åœ¨è¿™é‡Œ@WorkerThreadprotected abstract Result doInBackground(Params... params);@MainThreadprotected void onPreExecute() &#123;&#125;// æ‰§è¡Œå®Œå›è°ƒ@MainThreadprotected void onPostExecute(Result result) &#123;&#125;// å¦‚æœæœ‰è¿›åº¦æ¡æ›´æ–°@MainThreadprotected void onProgressUpdate(Progress... values) &#123;&#125;@MainThreadprotected void onCancelled() &#123;&#125; å¦‚ä½•æ›´æ–°è¿›åº¦æ¡ï¼Ÿåªéœ€è¦åœ¨ doInBackground ä¸­è°ƒç”¨å³å¯ï¼Œå°†å‚æ•°ä¼ å…¥ï¼Œä½¿ç”¨handleræœºåˆ¶ 1234567@WorkerThreadprotected final void publishProgress(Progress... values) &#123; if (!isCancelled()) &#123; getHandler().obtainMessage(MESSAGE_POST_PROGRESS, new AsyncTaskResult&lt;Progress&gt;(this, values)).sendToTarget(); &#125;&#125; Handler å¤„ç†æ¶ˆæ¯çš„åœ°æ–¹ï¼Œé™æ€ç±» 1234567891011121314151617181920private static class InternalHandler extends Handler &#123; public InternalHandler(Looper looper) &#123; super(looper); &#125; @SuppressWarnings(&#123;&quot;unchecked&quot;, &quot;RawUseOfParameterizedType&quot;&#125;) @Override public void handleMessage(Message msg) &#123; AsyncTaskResult&lt;?&gt; result = (AsyncTaskResult&lt;?&gt;) msg.obj; switch (msg.what) &#123; case MESSAGE_POST_RESULT: // There is only one result result.mTask.finish(result.mData[0]); break; case MESSAGE_POST_PROGRESS: result.mTask.onProgressUpdate(result.mData); break; &#125; &#125;&#125; å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥å–æ¶ˆä»»åŠ¡ï¼Œä¸è¿‡åªèƒ½å–æ¶ˆè¿˜æ²¡æ‰§è¡Œçš„ä»»åŠ¡ï¼Œåº•å±‚æ˜¯è°ƒç”¨ thread.interrupt æ–¹æ³•ï¼Œç®€å•ç²—æš´ï¼Œå…³äºä»–çš„ä½¿ç”¨ï¼Œå¯ä»¥å†™ä¸€å †ä¸œè¥¿æ¥è¯´ï¼Œè¿™é‡Œæš‚ä¸”ä¸å±•å¼€è¯´ 1234public final boolean cancel(boolean mayInterruptIfRunning) &#123; mCancelled.set(true); return mFuture.cancel(mayInterruptIfRunning);&#125; å½“ç„¶ï¼Œå¦‚æœä¸è¦äºUIäº¤äº’ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨è¿™ä¸ªæ‰§è¡Œåå°é€»è¾‘ï¼Œç›´æ¥è°ƒç”¨executeOnExecutorï¼Œä½¿ç”¨é™æ€çš„executeæäº¤ï¼Œè¿™é‡Œæ˜¯å•ä»»åŠ¡çš„ 123public static void execute(Runnable runnable) &#123; sDefaultExecutor.execute(runnable); &#125; å½“ç„¶ï¼Œä¹Ÿå¯ä»¥å¤šä»»åŠ¡ä¸€èµ·æ‰§è¡Œï¼Œè°ƒç”¨executeOnExecutoræ—¶æŒ‡å®šå†…éƒ¨çš„çº¿ç¨‹æ± å³å¯AsyncTask.THREAD_POOL_EXECUTOR æ€»ç»“ æˆ‘ä»¬äº†è§£è¿™AsyncTaskè¿™ä¸ªç±»ï¼Œå¤§è‡´çŸ¥é“äº†ä»–æ˜¯æ€ä¹ˆå®ç°äº†ï¼Œå¦‚æœè¦è¿›ä¸€æ­¥äº†è§£çš„è¯ï¼Œçº¿ç¨‹æ± ï¼Œé”è¿™äº›ä¸œè¥¿å¿…ä¸å¯å°‘çš„ï½ å¦‚æœ‰é”™è¯¯ï¼Œæ¬¢è¿è®¨è®º","categories":[{"name":"Android","slug":"Android","permalink":"https://wzes.github.io/categories/Android/"}],"tags":[{"name":"Android","slug":"Android","permalink":"https://wzes.github.io/tags/Android/"}]},{"title":"Java8 PriorityQueue æºç è§£æ","slug":"Java/Java8 PriorityQueue æºç è§£æ","date":"2018-08-10T13:23:00.000Z","updated":"2019-09-02T12:21:11.225Z","comments":true,"path":"2018/08/10/Java/Java8 PriorityQueue æºç è§£æ/","link":"","permalink":"https://wzes.github.io/2018/08/10/Java/Java8 PriorityQueue æºç è§£æ/","excerpt":"","text":"PriorityQueue ä¼˜å…ˆçº§é˜Ÿåˆ— å‰ä¸–ä»Šç”Ÿ extends AbstractQueue AbstractQueue extends AbstractCollection implements Queue å®ç°åŸç†å¤§ç™½è¯ å†…éƒ¨ä½¿ç”¨ä½ æ‰€ç†Ÿæ‚‰çš„æ•°æ®ç»“æ„æœ€å †æ¥å®ç°ï¼Œæ¯æ¬¡éƒ½æ˜¯å–å †é¡¶çš„å…ƒç´ ã€‚è‡³äºå †æ€ä¹ˆå®ç°ï¼Œå…¶å®å¾ˆç®€å•ï¼Œå°±ä¸€ä¸ªæ•°ç»„è€Œå·²ï¼Œè¿™é‡Œå°±ä¸è®¨è®ºæ€ä¹ˆå®ç°å †äº†ã€‚é»˜è®¤æ˜¯æ ¹æ®ä¼ å…¥çš„å¯¹è±¡è¿›è¡Œæ¯”è¾ƒå»ºç«‹åˆå§‹å †çš„ã€‚æ¯”å¦‚è¯´ String å®ç°äº† Comparable æ¥å£ï¼Œé‡Œé¢å°±æ˜¯æ ¹æ®è¿™ä¸ªè¿›è¡Œæ’åºå»ºç«‹åˆå§‹å †çš„ã€‚ ä¸»è¦çš„æ„é€ å‡½æ•° 123// å¯ä»¥ä½¿ç”¨å¤–æ’åº Comparator æ¥æ„å»ºä½ è‡ªå·±çš„å †ï¼Œé»˜è®¤ä¸ºç©º// initialCapacity ä¸ºåˆå§‹å †å¤§å°ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œä¸ºäº†é¿å…æ‰©å®¹ï¼Œæˆ–è€…ç©ºé—´æµªè´¹ï¼Œæˆ‘ä»¬è¦é€‰æ‹©åˆé€‚çš„å€¼ï¼Œé»˜è®¤å€¼ä¸º DEFAULT_INITIAL_CAPACITY = 11public PriorityQueue(int initialCapacity, Comparator&lt;? super E&gt; comparator) å¸¸ç”¨çš„æ–¹æ³• æ·»åŠ å…ƒç´  123456789101112131415161718192021public boolean add(E e) &#123; return offer(e); &#125;// è°ƒç”¨çš„æ˜¯offerpublic boolean offer(E e) &#123; if (e == null) throw new NullPointerException(); // å‡ ä¹æ‰€æœ‰çš„é›†åˆç±»éƒ½æœ‰è¿™ä¸ªï¼Œé¡¾åæ€ä¹‰ï¼Œä¸»è¦æ˜¯è®°å½•ä¿®æ”¹æ¬¡æ•°ï¼Œå®é™…ä¸Šæ˜¯ä¸ºäº†é˜²æ­¢ä½ åœ¨éå†çš„æ—¶å€™æ›´æ”¹äº†æ•°æ®ï¼Œé€ æˆä¸ä¸€è‡´ï¼Œä¼šæŠ›å‡ºConcurrentModificationException å¼‚å¸¸ï¼Œæ³¨æ„ï¼Œè¿™ä¸å¹¶å‘æ²¡æœ‰å¤šå¤§è”ç³» modCount++; int i = size; // æ£€æŸ¥æ˜¯å¦éœ€è¦æ‰©å®¹ï¼Œqueueå°±æ˜¯çœŸå®æ•°æ® if (i &gt;= queue.length) grow(i + 1); size = i + 1; if (i == 0) queue[0] = e; else // ä½¿ç”¨ç»å…¸çš„ siftUp ä¸Šç§»æœ€åæ·»åŠ çš„å…ƒç´ ï¼Œ ä¿è¯æˆ‘ä»¬çš„å †è¿˜æ˜¯æœ‰åºçš„ siftUp(i, e); return true; &#125; åˆ é™¤å…ƒç´  12345678910111213// åŒæ ·ä½¿ç”¨ siftDownï¼Œé¦–å…ˆå°†æœ€åä¸€ä¸ªå…ƒç´ ç§»åˆ°å †é¡¶ï¼Œå†è°ƒæ•´å †å³å¯public E poll() &#123; if (size == 0) return null; int s = --size; modCount++; E result = (E) queue[0]; E x = (E) queue[s]; queue[s] = null; if (s != 0) siftDown(0, x); return result; &#125; è·å–å †é¡¶å…ƒç´  12345// ç›´æ¥æ•°ç»„è¿”å›// ä¹Ÿå¯ä»¥ä½¿ç”¨ element()ï¼Œæ˜¯ abstractQueue çš„æ–¹æ³•ï¼Œè°ƒç”¨çš„ä¹Ÿæ˜¯ peek() å†ä¸€æ¬¡æ„Ÿå—åˆ°å¤šæ€å¯¹è±¡çš„å¼ºå¤§public E peek() &#123; return (size == 0) ? null : (E) queue[0]; &#125; è·å–åä¸€ä½ç½®çš„å…ƒç´  123456789// å› ä¸ºä½¿ç”¨çš„æ˜¯æœ€å †çš„æ•°æ®ç»“æ„ï¼Œæ‰€ä»¥åªèƒ½éå†ï¼Œæ•ˆç‡è¾ƒä½private int indexOf(Object o) &#123; if (o != null) &#123; for (int i = 0; i &lt; size; i++) if (o.equals(queue[i])) return i; &#125; return -1; &#125; å…³äºsiftUp 1234567// å¦‚æœæ²¡æœ‰å¤–æ’åºï¼Œåˆ™ä½¿ç”¨å†…æ’åºprivate void siftUp(int k, E x) &#123; if (comparator != null) siftUpUsingComparator(k, x); else siftUpComparable(k, x); &#125; ç®€å•çœ‹ä¸€ä¸ªå‡½æ•°ï¼Œå¤ä¹ ä¸€ä¸‹å † 123456789101112131415private void siftUpComparable(int k, E x) &#123; Comparable&lt;? super E&gt; key = (Comparable&lt;? super E&gt;) x; while (k &gt; 0) &#123; // ä¸€å¦‚æ—¢å¾€ä½¿ç”¨ä½è¿ç®—æé«˜æ•ˆç‡ int parent = (k - 1) &gt;&gt;&gt; 1; Object e = queue[parent]; // å¦‚æœçˆ¶å…ƒç´ å°çš„è¯ï¼Œè¯´æ˜æœ€å°å †å·²ç»éƒ½å»ºå¥½äº†ï¼Œ // å¦åˆ™äº¤æ¢ç»§ç»­è°ƒæ•´ if (key.compareTo((E) e) &gt;= 0) break; queue[k] = e; k = parent; &#125; queue[k] = key; &#125; ä½ å¯èƒ½é‡åˆ°çš„å‘ å¦‚æœä½ ä¸­é€”æ”¹å˜äº†æ•°æ®ï¼Œæœ‰å…³æ’åºçš„å­—æ®µï¼Œæœ€å°å †æ˜¯ä¸ä¼šè‡ªåŠ¨é‡æ–°æ„å»ºï¼Œé‚£ä¹ˆï¼Œè¿™ä¸ªä¼˜å…ˆçº§é˜Ÿåˆ—å°±ä¼šå¤±æ•ˆï¼ï¼ï¼ï¼ï¼ï¼ä¸¾ä¸ªä¾‹å­ï¼Œä½ æŠŠä¸€å †å­¦ç”ŸæŒ‰èº«é«˜æ”¾å…¥ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼Œçªç„¶ï¼Œæœ‰å‡ ä¸ªå­¦ç”Ÿçš„èº«é«˜æ”¹å˜äº†ï¼Œè¿™ä¸ªæœ€å°å †æ˜¯ä¸ä¼šé‡æ„çš„ï¼Œè¿™æ—¶å€™å¾—ä¸åˆ°ä½ æƒ³è¦çš„å€¼ï¼Œé‚£æœ‰æ²¡æœ‰é‡æ„çš„å‡½æ•°ï¼ŒæŠ±æ­‰ï¼Œæ²¡æœ‰ï¼heapify æ˜¯ç§æœ‰çš„å‡½æ•°ï¼Œä½†æ˜¯ä½ å¯ä»¥é€šè¿‡ new PriorityQueue(queue)ï¼Œé‡æ–°æ„å»ºä¸€ä¸ª","categories":[{"name":"Java","slug":"Java","permalink":"https://wzes.github.io/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://wzes.github.io/tags/Java/"}]},{"title":"SparseArray æºç è§£æ","slug":"Android/LruCache","date":"2018-07-26T02:19:16.000Z","updated":"2019-09-02T12:19:07.920Z","comments":true,"path":"2018/07/26/Android/LruCache/","link":"","permalink":"https://wzes.github.io/2018/07/26/Android/LruCache/","excerpt":"","text":"LruCache æ˜¯ä»€ä¹ˆä¸œè¥¿ï¼Ÿ LRU å’‹ä¸€çœ‹è¿™ä¹ˆç†Ÿæ‚‰ï¼Œæ“ä½œç³»ç»Ÿé‡Œé¢å†…å­˜ç®¡ç†ï¼Œé¡µé¢ç½®æ¢æ—¶æ›¿æ¢ç®—æ³•ä¹‹ä¸€ï¼Œè‹±æ–‡å…¨æ‹¼ä¸ºLeast Recently Used ä»¥ä¸ºæœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼Œç®€å•æ¥è¯´ï¼Œå°±æ˜¯æ›¿æ¢æ‰æœ€è€çš„æ•°æ®ã€‚å…¶æ ¸å¿ƒæ€æƒ³ä¸ºå¦‚æœæ•°æ®æœ€è¿‘è¢«è®¿é—®è¿‡ï¼Œé‚£ä¹ˆå°†æ¥è¢«è®¿é—®çš„å‡ ç‡ä¹Ÿæ›´é«˜ã€‚å¦å¤–ä¸€ä¸ªæ¯”è¾ƒç®€å•çš„ç®—æ³•æ˜¯ FIFOï¼ŒFirst In First Out å…ˆè¿›å…ˆå‡ºï¼Œå°±æ˜¯æ·˜æ±°æœ€å…ˆä½¿ç”¨çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ç•™ä¸‹æœ€è¿‘ä½¿ç”¨çš„ï¼Œçœ‹ä¼¼è¿™ä¸¤ä¸ªå¾ˆåƒï¼Œå®é™…ä¸ŠåŒºåˆ«è¿˜æ˜¯å¾ˆå¤§çš„ï¼Œå½“ç¼“å­˜å‘½ä¸­æ—¶ï¼ŒLRUä¼šå°†å…ƒç´ ç§»åˆ°é˜Ÿé¦–ï¼Œè€ŒFIFOä¸ä¼šå˜ æˆ‘è§‰å¾—è¿™æ˜¯å¯¹äº LRU å’Œ FIFO æ¯”è¾ƒæ­£ç¡®çš„å®šä¹‰ï¼Œå°±å®ç°æ–¹å¼æ¥è¯´ï¼ŒFIFO ç›¸å¯¹ç®€å•äº› å‰ä¸–ä»Šç”Ÿ 12// å¾ˆå¹²å‡€ï¼Œæ²¡æœ‰çˆ¶ç±»ï¼ˆObject é™¤å¤–ï¼‰public class LruCache&lt;K, V&gt; &#123;&#125; ä½¿ç”¨åœºæ™¯ ä¸»è¦æ˜¯ç”¨äºç¼“å­˜æ•°æ®çš„åœºæ™¯ï¼ŒèŠ‚çº¦å†…å­˜ï¼Œæ¯”å¦‚å›¾ç‰‡çš„ç¼“å­˜ å®ç°åŸç†å¤§ç™½è¯ ä»–çš„å®ç°è¿˜æ˜¯å¾ˆç®€å•ï¼Œå¾ˆæ¸…æ™°çš„ï¼Œä½¿ç”¨ä¸€ä¸ª LinkedHashMap ä½œä¸ºæ•°æ®å­˜å‚¨ç»“æ„ï¼Œä½ ä½¿ç”¨è¿™ä¸ªä¸œè¥¿çš„æ—¶å€™å¯ä»¥å½“ä¸€ä¸ª Key-Value å†…å­˜æ•°æ®åº“ä½¿ç”¨ã€‚åªä¸è¿‡ï¼Œå®ƒä¸»è¦æ˜¯ä¸ºäº†ç¼“å­˜ï¼Œå½“æ•°æ®é‡è¾¾åˆ°é˜ˆå€¼å€¼ï¼Œä¼šæ ¹æ®LRUåˆ é™¤æ•°æ®ï¼Œé‚£æœ‰çš„åŒå­¦å¯èƒ½ä¼šé—®ï¼Œä¸ºä»€ä¹ˆè¦åˆ å•Šï¼Ÿå…¶å®è¿™å°±æ˜¯ä½¿ç”¨å®ƒåŸå› ï¼Œåˆ æ‰ä¸€éƒ¨åˆ†å¯èƒ½ä¸ä½¿ç”¨çš„æ•°æ®ï¼ŒèŠ‚çº¦å‡ºå®è´µçš„å†…å­˜ï¼Œè¦æ˜¯ä½ ä¸ç®¡å†…å­˜çš„è¯ï¼Œé‚£å°±å¦å½“åˆ«è®ºäº† å­˜å‚¨æ•°æ®æ ¼å¼ 12head -&gt; node -&gt; node -&gt; node -&gt; node -&gt; node -&gt; tailnode = &lt;Key, Value&gt; æºç åˆ†æ å±æ€§ 1234567891011121314151617181920// æ•°æ®å­˜å‚¨private final LinkedHashMap&lt;K, V&gt; map;/** Size of this cache in units. Not necessarily the number of elements. */private int size;// é˜ˆå€¼è®¾ç½®ï¼Œè¶…è¿‡é˜ˆå€¼å°±ä¼šæŠ›å¼ƒprivate int maxSize;/** * ä¸‹é¢çš„ç»Ÿè®¡æ•°æ®ä¸»è¦æ˜¯ç”¨æ¥è¯„ä¼°çš„ */// è°ƒç”¨ put çš„æ¬¡æ•°private int putCount;// åˆ›å»º key çš„æ¬¡æ•°private int createCount;// æ·˜æ±°æ•°æ® çš„æ¬¡æ•°private int evictionCount;// å‘½ä¸­çš„æ¬¡æ•°private int hitCount;// æœªå‘½ä¸­çš„æ¬¡æ•°private int missCount; æ–¹æ³• æ„é€ å‡½æ•° 1234567891011public LruCache(int maxSize) &#123; if (maxSize &lt;= 0) &#123; throw new IllegalArgumentException(&quot;maxSize &lt;= 0&quot;); &#125; this.maxSize = maxSize; // åœ¨è¿™é‡Œåˆå§‹åŒ– cache ï¼Œé»˜è®¤å¤§å°ä¸º 0 // true è¿™ä¸ªå¾ˆå…³é”®ï¼Œä»£è¡¨ access-orderï¼Œ // true åˆ™é“¾è¡¨çš„é¡ºåºæ˜¯ä¸ºè®¿é—®é¡ºåºï¼Œåˆšå¥½ç¬¦åˆLRUçš„ç‰¹æ€§ // false åˆ™ æ’å…¥é¡ºåº this.map = new LinkedHashMap&lt;K, V&gt;(0, 0.75f, true);&#125; put å­˜æ•°æ® 12345678910111213141516171819202122232425262728293031323334/** * Caches &#123;@code value&#125; for &#123;@code key&#125;. The value is moved to the head of * the queue. * * @return the previous value mapped by &#123;@code key&#125;. */ public final V put(K key, V value) &#123; // æ³¨æ„ä¸å…è®¸ä¸ºç©ºï¼ŒHashMap æ˜¯å¯ä»¥å…è®¸ä½  Key Value ä¸ºç©ºçš„ if (key == null || value == null) &#123; throw new NullPointerException(&quot;key == null || value == null&quot;); &#125; V previous; // é”ä½è‡ªèº«çš„å¯¹è±¡ï¼Œçº¿ç¨‹å®‰å…¨ synchronized (this) &#123; putCount++; // è®¡ç®—å­˜å…¥æ•°æ®çš„å¤§å° size += safeSizeOf(key, value); // å­˜å…¥æ•°æ®ï¼Œå¦‚æœ key é‡å¤ï¼Œåˆ™è¿”å›æ—§æ•°æ® // å…·ä½“å®ç°å¯æŸ¥çœ‹ HashMap çš„putValå‡½æ•° previous = map.put(key, value); // å¦‚æœæœ‰æ—§æ•°æ®ï¼Œè‡ªç„¶è¦æ›´æ–°å¤§å° if (previous != null) &#123; size -= safeSizeOf(key, previous); &#125; &#125; // entryRemoved ç©ºæ–¹æ³•ï¼Œå¯é‡å†™ if (previous != null) &#123; entryRemoved(false, key, previous, value); &#125; // è°ƒæ•´å¤§å° trimToSize(maxSize); return previous;&#125; è°ƒæ•´å¤§å°å‡½æ•° 123456789101112131415161718192021222324252627282930313233343536public void trimToSize(int maxSize) &#123; while (true) &#123; K key; V value; // å¯¹è±¡é” synchronized (this) &#123; if (size &lt; 0 || (map.isEmpty() &amp;&amp; size != 0)) &#123; throw new IllegalStateException(getClass().getName() + &quot;.sizeOf() is reporting inconsistent results!&quot;); &#125; // å¦‚æœå†…å­˜å¤§å°å°äºé˜ˆå€¼ï¼Œåˆ™ç»“æŸå¾ªç¯ï¼Œå¦åˆ™åˆ é™¤é˜Ÿé¦–æ•°æ® if (size &lt;= maxSize) &#123; break; &#125; // remove the head // head -&gt; next -&gt; next -&gt; tail // è·å–é˜Ÿé¦–æ•°æ® Map.Entry&lt;K, V&gt; toEvict = map.eldest(); if (toEvict == null) &#123; break; &#125; key = toEvict.getKey(); value = toEvict.getValue(); // åˆ é™¤ map.remove(key); // å‡å° size -= safeSizeOf(key, value); // æ“¦é™¤åŠ 1 evictionCount++; &#125; // å¯é‡å†™ï¼Œç›‘å¬æ¸…é™¤ entryRemoved(true, key, value, null); &#125; &#125; get åˆšå¼€å§‹çš„æ—¶å€™ä½ å¯èƒ½ä¼šå›°æƒ‘ï¼Œè¯´å¥½çš„ lru æ€ä¹ˆæ²¡çœ‹åˆ° 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950public final V get(K key) &#123; if (key == null) &#123; throw new NullPointerException(&quot;key == null&quot;); &#125; V mapValue; synchronized (this) &#123; // æ‹¿åˆ°æ•°æ®ç›´æ¥è¿”å›äº† // æ›´æ¢èŠ‚ç‚¹çš„å·¥ä½œï¼ŒLinkedHashMap å¸®æˆ‘ä»¬åšäº† mapValue = map.get(key); if (mapValue != null) &#123; hitCount++; return mapValue; &#125; missCount++; &#125; /* * Attempt to create a value. This may take a long time, and the map * may be different when create() returns. If a conflicting value was * added to the map while create() was working, we leave that value in * the map and release the created value. */ // ç¼“å­˜å¤±æ•ˆ // æˆ–è€…ä¸å­˜åœ¨keyï¼ŒåŒæ · create ä¹Ÿæ˜¯ç©ºæ–¹æ³•ï¼Œä½¿ç”¨è€…æ ¹æ®è‡ªå·±éœ€æ±‚å»å®ç° V createdValue = create(key); if (createdValue == null) &#123; return null; &#125; // å°±æ˜¯ä¸€ä¸ª put æ“ä½œ synchronized (this) &#123; createCount++; mapValue = map.put(key, createdValue); if (mapValue != null) &#123; // There was a conflict so undo that last put map.put(key, mapValue); &#125; else &#123; size += safeSizeOf(key, createdValue); &#125; &#125; if (mapValue != null) &#123; entryRemoved(false, key, createdValue, mapValue); return mapValue; &#125; else &#123; trimToSize(maxSize); return createdValue; &#125; &#125; çœ‹å®Œè¿™å‡ ä¸ªå‡½æ•°ï¼Œå¤§æ¦‚çŸ¥é“äº†åŸç† å†æ¥çœ‹ä¸€ä¸ªéå¸¸é‡è¦çš„å‡½æ•°ï¼Œå†…å­˜å¤§å°çš„è®¡ç®—ï¼Œé€šå¸¸ä¹Ÿæ˜¯éœ€è¦ä½¿ç”¨è€…è‡ªå·±é‡å†™ 1234567891011121314151617181920private int safeSizeOf(K key, V value) &#123; int result = sizeOf(key, value); if (result &lt; 0) &#123; throw new IllegalStateException(&quot;Negative size: &quot; + key + &quot;=&quot; + value); &#125; return result;&#125;/** * Returns the size of the entry for &#123;@code key&#125; and &#123;@code value&#125; in * user-defined units. The default implementation returns 1 so that size * is the number of entries and max size is the maximum number of entries. * * &lt;p&gt;An entry&apos;s size must not change while it is in the cache. */// å­ç±»å¯é‡å†™ï¼Œé»˜è®¤è¿”å›1ï¼Œæ ¹æ®ä½¿ç”¨æƒ…å†µè‡ªå·±è®¡ç®—// æ‰¯ä¸€å¥ï¼Œå…³äº Java å¯¹è±¡åœ¨å†…å­˜çš„å¤§å°å¦‚ä½•è®¡ç®—ï¼Œè¯·è‡ªè¡Œå»æŸ¥æ‰¾protected int sizeOf(K key, V value) &#123; return 1;&#125; æ€»ç»“ HashMap æ˜¯ä¸ªå¾ˆé‡è¦çš„ä¸œè¥¿ï¼Œä¸‹ä¸€æ¬¡æˆ‘ä»¬åœ¨æ…¢æ…¢åˆ†æ ä»Šå¤©è·Ÿå¤§å®¶åˆ†äº«äº†ä¸€ä¸ªå¾ˆç®€å•çš„æ•°æ®ç»“æ„ï¼Œä¹Ÿæ˜¯ä½ å¯ä»¥æ•ˆä»¿çš„å¯¹è±¡ï¼Œè¿˜æ˜¯é‚£å¥ï¼ŒRead the fucking source code çº¯å±ä¸ªäººè§‚ç‚¹ï¼Œå¦‚æœæœ‰é”™ï¼Œæ¬¢è¿æŒ‡æ­£ã€‚","categories":[{"name":"Android","slug":"Android","permalink":"https://wzes.github.io/categories/Android/"},{"name":"Java","slug":"Android/Java","permalink":"https://wzes.github.io/categories/Android/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://wzes.github.io/tags/Java/"},{"name":"Android","slug":"Android","permalink":"https://wzes.github.io/tags/Android/"}]},{"title":"SparseArray æºç è§£æ","slug":"Android/SparseArray","date":"2018-07-26T02:19:16.000Z","updated":"2019-09-02T12:19:23.678Z","comments":true,"path":"2018/07/26/Android/SparseArray/","link":"","permalink":"https://wzes.github.io/2018/07/26/Android/SparseArray/","excerpt":"","text":"æ˜¯ä»€ä¹ˆä¸œè¥¿ï¼Ÿ sparse æ˜¯ç¨€ç–çš„æ„æ€ï¼Œé¡¾åæ€ä¹‰ï¼Œæ˜¯ä¸€ä¸ªç¨€ç–æ•°ç»„ï¼Œä½†å®é™…ä¸Šï¼Œä»–æ˜¯ä¸€ä¸ªkey åªèƒ½ä¸º int çš„key-value çš„æ•°æ®ç»“æ„ï¼Œç±»ä¼¼äºHashMap Android Developer ä¸­å¯¹å®ƒçš„è§£é‡Š SparseArrays map integers to Objects. Unlike a normal array of Objects, there can be gaps in the indices. It is intended to be more memory efficient than using a HashMap to map Integers to Objects, both because it avoids auto-boxing keys and its data structure doesnâ€™t rely on an extra entry object for each mapping. Note that this container keeps its mappings in an array data structure, using a binary search to find keys. The implementation is not intended to be appropriate for data structures that may contain large numbers of items. It is generally slower than a traditional HashMap, since lookups require a binary search and adds and removes require inserting and deleting entries in the array. For containers holding up to hundreds of items, the performance difference is not significant, less than 50%. To help with performance, the container includes an optimization when removing keys: instead of compacting its array immediately, it leaves the removed entry marked as deleted. The entry can then be re-used for the same key, or compacted later in a single garbage collection step of all removed entries. This garbage collection will need to be performed at any time the array needs to be grown or the the map size or entry values are retrieved. It is possible to iterate over the items in this container using keyAt(int) and valueAt(int). Iterating over the keys using keyAt(int) with ascending values of the index will return the keys in ascending order, or the values corresponding to the keys in ascending order in the case of valueAt(int). ä¸ºä»€ä¹ˆè¦ä½¿ç”¨å®ƒï¼Ÿ ä¸€å¥è¯ï¼šå†…å­˜æ•ˆç‡æ›´é«˜ã€‚ä»–é¿å…äº†Integer çš„è‡ªåŠ¨æ‹†è£…ç®±ï¼Œä¼šè‡ªåŠ¨å‹ç¼©æ•°ç»„æˆ–è€…æ‰©å®¹ï¼Œæ²¡æœ‰ä½¿ç”¨ entry çš„æ•°æ®ç»“æ„ æ€§èƒ½å‘¢ï¼Ÿ é€šå¸¸æ¥è¯´ï¼Œè¦æ¯” HashMap æ…¢ï¼Œä½†æ•°æ®é‡å°äº100æ—¶ï¼Œæ€§èƒ½ä¸‹é™å°‘äº50%ï¼Œä¸ºä»€ä¹ˆæ…¢è¿™ä¹ˆå¤šï¼Ÿå› ä¸ºäºŒåˆ†æœç´¢ï¼Œå…¶æ¬¡ï¼Œæ’å…¥åˆ é™¤ï¼Œæ•°ç»„éœ€è¦å‹ç¼©æˆ–è€…æ‰©å®¹ï¼Œå¯¼è‡´æ¯”è¾ƒæ…¢ã€‚å¯¹æ­¤ï¼Œæœ‰ä¸€ä¸ªåˆ é™¤æ—¶çš„ä¼˜åŒ–ï¼Œåˆ é™¤æ—¶ä¸ç«‹å³å‹ç¼©æ•°ç»„ï¼Œè€Œæ˜¯éœ€è¦åœ¨éœ€è¦å¢é•¿æ•°ç»„æˆ–æ£€ç´¢æ˜ å°„å¤§å°æˆ–æ¡ç›®å€¼çš„ä»»ä½•æ—¶å€™æ‰§è¡Œæ­¤åƒåœ¾æ”¶é›† æ€ä¹ˆè®¾è®¡çš„ï¼Ÿ å…¶å®ï¼Œé¦–é¡µè¯´çš„åŸºæœ¬åŸç†å¾ˆæ¸…æ¥šï¼Œå®ƒå°†æ˜ å°„å…³ç³»ä¿ç•™åœ¨æ•°ç»„æ•°æ®ç»“æ„ä¸­ï¼Œä½¿ç”¨äºŒåˆ†æœç´¢æ¥æŸ¥æ‰¾é”®ï¼Œ é€‚åˆä»€ä¹ˆåœºæ™¯ï¼Ÿ key ä¸º int çš„HashMapåœºæ™¯ æºç åˆ†æ å±æ€§ 12345678910// åˆ é™¤åå°†value[index] = DELETEDï¼›ç­‰å¾… gcprivate static final Object DELETED = new Object();// æ ‡è®°æ˜¯å¦éœ€è¦ gc (ä¸æ˜¯jvmçš„gcï¼Œè€Œæ˜¯æ•°ç»„å†…éƒ¨è‡ªå®šä¹‰çš„gcï¼Œå‹ç¼©æ•°ç»„)private boolean mGarbage = false;// å­˜æ”¾ key é›†åˆprivate int[] mKeys;// å­˜æ”¾value é›†åˆprivate Object[] mValues;// é›†åˆä¸­å­˜åœ¨çš„æœªè¢«åˆ é™¤å…ƒç´ çš„ä¸ªæ•°private int mSize; æ–¹æ³• è·å–å€¼get ä½¿ç”¨äºŒåˆ†æœç´¢æ‰¾åˆ°mValues ä¸­çš„ä½ç½®ï¼Œ å¦‚æœæœç´¢ä¸åˆ°åˆ™è¿”å›ç©º 123456789101112131415/** * Gets the Object mapped from the specified key, or the specified Object * if no such mapping has been made. */@SuppressWarnings(&quot;unchecked&quot;)public E get(int key, E valueIfKeyNotFound) &#123; // ä½¿ç”¨äºŒåˆ†æœç´¢æ‰¾åˆ°mValues ä¸­çš„ä½ç½® int i = ContainerHelpers.binarySearch(mKeys, mSize, key); if (i &lt; 0 || mValues[i] == DELETED) &#123; return valueIfKeyNotFound; &#125; else &#123; return (E) mValues[i]; &#125;&#125; äºŒåˆ†æœç´¢çš„å®ç°ï¼Œä½¿ç”¨ä½è¿ç®—æé«˜æ•ˆç‡ï¼Œæ— ç¬¦å·å³ç§»ï¼ˆæ³¨æ„&gt;&gt; å’Œ &gt;&gt;&gt; çš„åŒºåˆ«ï¼‰ 123456789101112131415161718192021// This is Arrays.binarySearch(), but doesn&apos;t do any argument validation.static int binarySearch(int[] array, int size, int value) &#123; int lo = 0; int hi = size - 1; while (lo &lt;= hi) &#123; // ä½¿ç”¨ä½è¿ç®—æé«˜æ•ˆç‡ï¼Œæ— ç¬¦å·å³ç§»ï¼ˆæ³¨æ„&gt;&gt; å’Œ &gt;&gt;&gt; çš„åŒºåˆ«ï¼‰ final int mid = (lo + hi) &gt;&gt;&gt; 1; final int midVal = array[mid]; if (midVal &lt; value) &#123; lo = mid + 1; &#125; else if (midVal &gt; value) &#123; hi = mid - 1; &#125; else &#123; return mid; // value found &#125; &#125; // å·§å¦™çš„è¿”å›æ‰¾ä¸åˆ°çš„ä½ç½®ï¼Œå»åä¸€èˆ¬å°äº0, return ~lo; // value not present&#125; ä»€ä¹ˆåœ°æ–¹è¿›è¡Œ gcï¼Ÿ get remove æ“ä½œä¸è¿›è¡Œgc put size() keyAt valueAt ä¼šæ£€æŸ¥ mGarbage çš„æ ‡å¿—è¿›è¡Œ gc gc ä¼ è¯´ä¸­çš„gcå‡½æ•° 123456789101112131415161718192021222324252627private void gc() &#123; // Log.e(&quot;SparseArray&quot;, &quot;gc start with &quot; + mSize); int n = mSize; int o = 0; int[] keys = mKeys; Object[] values = mValues; // éå†å°†å€¼ä¸ºDELETEDçš„ä½ç½®åˆ é™¤ for (int i = 0; i &lt; n; i++) &#123; Object val = values[i]; if (val != DELETED) &#123; if (i != o) &#123; keys[o] = keys[i]; values[o] = val; values[i] = null; &#125; o++; &#125; &#125; // æ›´æ”¹ size çš„å¤§å°ï¼Œä½†keys çš„å¤§å°æ²¡æœ‰å˜ mGarbage = false; mSize = o; // Log.e(&quot;SparseArray&quot;, &quot;gc end with &quot; + mSize);&#125; put å‡½æ•°ï¼Œä¼˜å…ˆåœ¨ DELETE ä½ç½®æ’å…¥ï¼Œæ’å…¥ååœ¨æ£€æŸ¥æ˜¯å¦éœ€è¦ GC 12345678910111213141516171819202122232425262728293031/** * Adds a mapping from the specified key to the specified value, * replacing the previous mapping from the specified key if there * was one. */ public void put(int key, E value) &#123; int i = ContainerHelpers.binarySearch(mKeys, mSize, key); if (i &gt;= 0) &#123; mValues[i] = value; &#125; else &#123; i = ~i; if (i &lt; mSize &amp;&amp; mValues[i] == DELETED) &#123; mKeys[i] = key; mValues[i] = value; return; &#125; // æ˜¯å¦éœ€è¦ gc if (mGarbage &amp;&amp; mSize &gt;= mKeys.length) &#123; gc(); // Search again because indices may have changed. i = ~ContainerHelpers.binarySearch(mKeys, mSize, key); &#125; // æ’å…¥ï¼Œæ‰©å®¹ mKeys = GrowingArrayUtils.insert(mKeys, mSize, i, key); mValues = GrowingArrayUtils.insert(mValues, mSize, i, value); mSize++; &#125; &#125; GrowingArrayUtils.insert æ’å…¥ä»¥åŠæ‰©å®¹ 1234567891011121314151617181920/** * Primitive boolean version of &#123;@link #insert(Object[], int, int, Object)&#125;. */public static boolean[] insert(boolean[] array, int currentSize, int index, boolean element) &#123; assert currentSize &lt;= array.length; // æ™®é€šæƒ…å†µ if (currentSize + 1 &lt;= array.length) &#123; System.arraycopy(array, index, array, index + 1, currentSize - index); array[index] = element; return array; &#125; // currentSize = array.length çš„æƒ…å†µï¼Œè¿›è¡Œæ‰©å®¹ boolean[] newArray = ArrayUtils.newUnpaddedBooleanArray(growSize(currentSize)); // æ•°ç»„çš„å¤åˆ¶éƒ½ä½¿ç”¨ System.arraycopyï¼Œæ•ˆç‡é«˜ System.arraycopy(array, 0, newArray, 0, index); newArray[index] = element; System.arraycopy(array, index, newArray, index + 1, array.length - index); return newArray;&#125; growSizeå¢é•¿å‡½æ•°ï¼Œå°äº 4 æ—¶ç›´æ¥å¢åˆ° 8ï¼Œ ä¹‹åä»¥2çš„ä½æ•°å¢é•¿ï¼Œè¿™ä¸å¾ˆå¤šå¢é•¿å‡½æ•°å·®ä¸å¤šï¼Œåªä¸è¿‡åœ¨è¿™æ²¡æœ‰ç”¨ä½è¿ç®—æœ‰ç‚¹é—æ†¾ 123456789/** * Given the current size of an array, returns an ideal size to which the array should grow. * This is typically double the given size, but should not be relied upon to do so in the * future. */public static int growSize(int currentSize) &#123; // å¢é•¿å‡½æ•° return currentSize &lt;= 4 ? 8 : currentSize * 2;&#125; ä»¥ä¸Šè¿™å‡ ä¸ªéƒ½æ˜¯å¾ˆç»å…¸çš„å‡½æ•°ä»¥åŠå®ç°ï¼Œéœ€è¦æŒæ¡ï¼ æ€»ç»“ Android æºç ä¸­å¯¹ SparseArray åº”ç”¨è¿˜æ˜¯æ¯”è¾ƒå¤šçš„ï¼Œå¯èƒ½æ˜¯æƒ³è§£å†³ç”±äºæ—©æœŸ Android å†…å­˜å°çš„é—®é¢˜ï¼Œä½†åœ¨æ—¥ç›Šä½å»‰çš„å†…å­˜é¢å‰ï¼Œæ˜¯å¦è¿˜æœ‰å¿…è¦ä½¿ç”¨ï¼Œæé«˜å†…å­˜æ•ˆç‡è¿˜æ˜¯å¾—æ‰“ä¸€ä¸ªé—®å·ã€‚ æ¬¢è¿è®¨è®ºï½","categories":[{"name":"Android","slug":"Android","permalink":"https://wzes.github.io/categories/Android/"},{"name":"Java","slug":"Android/Java","permalink":"https://wzes.github.io/categories/Android/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://wzes.github.io/tags/Java/"},{"name":"Android","slug":"Android","permalink":"https://wzes.github.io/tags/Android/"}]},{"title":"Android Repositories","slug":"Android/Android-repositories","date":"2018-07-05T12:35:00.000Z","updated":"2019-09-02T12:18:04.105Z","comments":true,"path":"2018/07/05/Android/Android-repositories/","link":"","permalink":"https://wzes.github.io/2018/07/05/Android/Android-repositories/","excerpt":"","text":"Android Repositories ä¼—æ‰€å‘¨çŸ¥å•Šï¼ŒAndroid çš„ä»“åº“æº google jcenter å›½å†…æ˜¯è¶…çº§æ…¢çš„ï¼Œæ¢ä¸ª aliyun èµ·é£äº† 123456789101112131415mavenCentral()maven &#123; url &quot;[https://jitpack.io](https://jitpack.io)&quot; &#125;maven &#123; url &quot;[http://maven.aliyun.com/nexus/content/groups/public/](http://maven.aliyun.com/nexus/content/groups/public/)&quot; &#125;maven &#123; url &apos;[http://maven.oschina.net/content/groups/public/&apos;](http://maven.oschina.net/content/groups/public/&apos;) &#125;maven &#123; url &apos;[https://oss.sonatype.org/content/repositories/snapshots/&apos;](https://oss.sonatype.org/content/repositories/snapshots/&apos;) &#125;maven &#123; url &quot;[http://maven.springframework.org/release](http://maven.springframework.org/release)&quot; &#125;maven &#123; url &quot;[http://maven.restlet.org](http://maven.restlet.org)&quot; &#125;maven &#123; url &quot;[http://mirrors.ibiblio.org/maven2](http://mirrors.ibiblio.org/maven2)&quot; &#125;maven &#123;url &quot;[http://repo.baichuan-android.taobao.com/content/groups/BaichuanRepositories/](http://repo.baichuan-android.taobao.com/content/groups/BaichuanRepositories/)&quot;&#125;maven &#123; url &apos;[https://maven.fabric.io/public&apos;](https://maven.fabric.io/public&apos;) &#125;jcenter()google()jcenter &#123; url &quot;[http://jcenter.bintray.com/](http://jcenter.bintray.com/)&quot; &#125;","categories":[{"name":"Android","slug":"Android","permalink":"https://wzes.github.io/categories/Android/"}],"tags":[{"name":"Android","slug":"Android","permalink":"https://wzes.github.io/tags/Android/"}]},{"title":"MySQL å¯¼å…¥å¤§æ–‡æœ¬æ•°æ®å†é™©è®°","slug":"MySQL/MySQL å¯¼å…¥å¤§æ–‡æœ¬æ•°æ®å†é™©è®°","date":"2018-06-10T12:57:00.000Z","updated":"2019-09-01T15:25:33.204Z","comments":true,"path":"2018/06/10/MySQL/MySQL å¯¼å…¥å¤§æ–‡æœ¬æ•°æ®å†é™©è®°/","link":"","permalink":"https://wzes.github.io/2018/06/10/MySQL/MySQL å¯¼å…¥å¤§æ–‡æœ¬æ•°æ®å†é™©è®°/","excerpt":"èƒŒæ™¯ ä»Šå¤©æ¥åˆ°ä¸€ä¸ªä»»åŠ¡ï¼Œå¾€ä¸€å¼  mysql æ•°æ®åº“è¡¨é‡Œå¯¼å…¥ä¸€ç‚¹æ–‡æœ¬æ•°æ®ï¼Œå‹ç¼©æ–‡ä»¶åœ¨ç™¾åº¦äº‘ä¸Šï¼Œä¸€çœ‹ 2 G å¤§å°ï¼Œç™¾åº¦äº‘è¿˜å„ç§é™é€Ÿï¼Œç›´æ¥ä¸æƒ³ä¸‹è½½äº†ï¼Œé¡¹ç›®å°å§å§é—®é‡åˆ°å•¥é—®é¢˜ï¼Ÿæˆ‘æ›´å¥¹è¯´ï¼Œä¸‹è½½å›°éš¾ï¼Œä¼°è®¡å½“æ—¶å¥¹å“­ç¬‘ä¸å¾—ï¼Œæ²¡åŠï¼Œæœ€ç»ˆè¿˜æ˜¯å¾—å¼€å·¥ï¼Œç›´æ¥æ‹¿ uç›˜ copy çš„ã€‚","text":"èƒŒæ™¯ ä»Šå¤©æ¥åˆ°ä¸€ä¸ªä»»åŠ¡ï¼Œå¾€ä¸€å¼  mysql æ•°æ®åº“è¡¨é‡Œå¯¼å…¥ä¸€ç‚¹æ–‡æœ¬æ•°æ®ï¼Œå‹ç¼©æ–‡ä»¶åœ¨ç™¾åº¦äº‘ä¸Šï¼Œä¸€çœ‹ 2 G å¤§å°ï¼Œç™¾åº¦äº‘è¿˜å„ç§é™é€Ÿï¼Œç›´æ¥ä¸æƒ³ä¸‹è½½äº†ï¼Œé¡¹ç›®å°å§å§é—®é‡åˆ°å•¥é—®é¢˜ï¼Ÿæˆ‘æ›´å¥¹è¯´ï¼Œä¸‹è½½å›°éš¾ï¼Œä¼°è®¡å½“æ—¶å¥¹å“­ç¬‘ä¸å¾—ï¼Œæ²¡åŠï¼Œæœ€ç»ˆè¿˜æ˜¯å¾—å¼€å·¥ï¼Œç›´æ¥æ‹¿ uç›˜ copy çš„ã€‚ é—®é¢˜ åºŸäº†å‡ åˆ†é’Ÿæ‰ copy å®Œï¼Œè§£å‹å 13.9Gï¼ŒæŒ‚ä¸å¾—å¥¹ä»¬éƒ½ä¸çŸ¥é“é‡Œé¢è£…çš„æ˜¯å•¥ï¼Œç„¶è€Œéš¾ä¸å€’æˆ‘ï¼Œlinux ç³»ç»Ÿå¯è°“æ˜¯ç¼–ç¨‹åˆ©å™¨ã€‚ æ£€æŸ¥ csv æ–‡ä»¶è¡Œæ•° 1wc -l filename åŠå¤©æ²¡è·‘å‡ºæ¥ï¼Œç­‰ä¸åŠï¼Œç›´æ¥åˆä¸Šäº†å¦å¤–ä¸€ä¸ªå‘½ä»¤ 12head -n filenametail -n filename çœ‹äº†ä¸€ä¸‹æ—¶é—´è·¨åº¦ï¼Œæœ€ç»ˆé€‰å®šæœ€åä¸€å¤©çš„æ•°æ®è¿›è¡Œå¯¼å…¥ï¼Œé‚£å°±å¾—é”å®šæœ€åä¸€å¤©æ˜¯ä»ç¬¬å‡ è¡Œå¼€å§‹çš„ï¼Œä¸€è·¯tail -n filename è¯•å‡ºæ¥äº†çš„ï¼Œæ¥ä¸‹æ¥å°±æ˜¯æŠŠè¿™éƒ¨åˆ†æ•°æ®æˆªå–åˆ°æ–°æ–‡ä»¶ 1tail -n filename &gt; new_file.csv æ–°æ–‡ä»¶åªå‰© 1 ä¸ª G äº†ï¼Œçªç„¶æƒ³èµ·è¿˜æœ‰å­—ç¬¦ç¼–ç çš„é—®é¢˜ï¼Œæˆ‘æ•°æ®åº“ç”¨çš„æ˜¯ utf-8ï¼Œè€Œ windows å¹³å°çš„æ•°æ®ä¸€èˆ¬æ˜¯ GBK æ ¼å¼ï¼Œä¸€æ³¢ç™¾åº¦åæ‰¾åˆ°äº† iconv å‘½ä»¤ï¼Œä¸€è¡Œå‘½ä»¤å°±è§£å†³äº†ï¼Œé€Ÿåº¦è´¼å¿«ï¼Œä»¥åå¦ˆå¦ˆå†ä¹Ÿä¸ç”¨æ‹…å¿ƒæˆ‘çš„å­—ç¬¦ç¼–ç é—®é¢˜äº† 1iconv -f GBK -t UTF-8 input_file -o output_file ç„¶è€Œå¼€å§‹è¦ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼Œé˜¿é‡Œäº‘çš„æœåŠ¡å™¨ä¸Šä¼ æ•°æ®ä¹Ÿæ˜¯éœ€è¦ä¸€ç‚¹æ—¶é—´ã€‚çªç„¶æƒ³ï¼ŒæŠŠæ–‡ä»¶åˆ‡åˆ†ä¸€ä¸‹å§ï¼Œåˆ†æ‰¹ï¼Œæˆ–è€…å¼€å‡ ä¸ªçº¿ç¨‹ä¸€èµ·ä¸Šä¼ ï¼Œåˆä¸€æ³¢ç™¾åº¦ï¼Œå‘ç°äº† splitï¼Œ æŒ‰è¡Œåˆ‡åˆ†æˆ–è€…æŒ‰å¤§å°åˆ‡åˆ† 12split -l 1000000 filenamesplit -C 100M filename ç„¶åæ„‰å¿«çš„å…ˆä¸Šä¼ äº†ä¸€ä¸ªå°å—åˆ°äº†æœåŠ¡å™¨ï¼Œæ‰“å¼€ mysqlï¼Œæ‰¾åˆ° load data çš„å‘½ä»¤ï¼Œå½“ç„¶ä¸€å¼€å§‹ä¸ä¼šé‚£ä¹ˆæˆåŠŸï¼Œå„ç§é—®é¢˜éƒ½ä¼šå‡ºç° åŒå¼•å·é—®é¢˜ï¼Œé»˜è®¤ä¼šæŠŠåŒå¼•å·å½“åšå­—æ®µå†…å®¹å¡«å……ï¼Œå°±å¯¼è‡´é å­—ç¬¦ç±»å‹çš„æ•°æ®ä¸èƒ½å¯¼å…¥ å­—ç¬¦é—®é¢˜ï¼Œutf-8 è¿˜è¦å†é‡æ–°æŒ‡å®šï¼Œå³ä½¿æˆ‘çš„æ•°æ®æœ¬æ¥å°±æ˜¯ utf-8 å­—æ®µå¯¹åº”é—®é¢˜ï¼Œæ’å…¥çš„è¡¨å¾ˆå¤šå­—æ®µéƒ½åªèƒ½ä¸ºç©º æ›´å¥‡æ€ªçš„æ˜¯æ¯æ¬¡åªæˆåŠŸäº†ä¸€åŠï¼Œè¿˜å‘ç°äº† show warnings å¯ä»¥æŸ¥çœ‹è­¦å‘Šä¿¡æ¯ï¼Œæœ€åå‘ç°æ—¶ access å¯¼å‡ºæ•°æ®æ—¶æ˜¯ä½¿ç”¨ \\t åˆ†å‰²è¡Œçš„ï¼Œorz 1show warnings æœ€åé™„ä¸ŠæˆåŠŸå¯¼å…¥çš„è„šæœ¬ 123456LOAD DATA LOCAL INFILE &quot;filename&quot; INTO TABLE tablename CHARACTER SET utf8 FIELDS TERMINATED BY &apos;,&apos; ENCLOSED BY &quot;&quot;&quot;&quot; LINES TERMINATED BY &apos;\\r&apos; (COLUMN1, COLUMN2, ......); æµ‹è¯•æˆåŠŸåï¼Œå°†åˆ‡å‰²çš„æ•°æ®åˆå¹¶ 1cat x* &gt; file å†æ‰§è¡Œå‘½ä»¤ï¼Œå¤§åŠŸå‘Šæˆï¼ï¼ æ€»ç»“ æ•²å‘½ä»¤è¿˜æ˜¯å¾ˆæœ‰æˆå°±æ„Ÿçš„ï¼Œæœ‰æ—¶å€™è¦æ¯”ä½¿ç”¨æŸäº›è½¯ä»¶æ•ˆç‡è¦é«˜ï¼Œè‡³å°‘å¤§å¤šæ•°è½¯ä»¶å¯¹å¤§æ–‡ä»¶è¯»å–éƒ½æ²¡æœ‰åšä¼˜åŒ–ï¼Œè¿™å¯¹äºç»å¸¸æ¥è§¦å¤§æ–‡ä»¶çš„äººç®€ç›´æ˜¯å™©æ¢¦ï¼ï¼atom æ‰“å¼€å‡ Mçš„æ•°æ®éƒ½å¡ï¼Œæ›¿æ¢æ›´å¡ï¼æœç„¶ä½¿ç”¨ vim æ›¿æ¢åŠŸèƒ½ï¼Œä½†æ˜¯ vim ä¹Ÿä¸å‘æ“æ§å¤§æ–‡ä»¶ï¼ˆå‡ ä¸ªGä»¥ä¸Šï¼‰ï¼Œå½“ç„¶æˆ‘ä»¬å¯ä»¥å†™ä¸ªè„šæœ¬ï¼Œå¯ä»¥å°†æ–‡ä»¶åˆ‡å‰²ï¼Œé€ä¸€å¯¹æ–‡ä»¶è¿›è¡Œæ“ä½œï¼ä¹Ÿä¸æ˜¯ä¸è¡Œï¼","categories":[{"name":"MySQL","slug":"MySQL","permalink":"https://wzes.github.io/categories/MySQL/"}],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"https://wzes.github.io/tags/MySQL/"}]}]}